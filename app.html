<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<script>
const FortizedSocial = (() => {
  const KEY_USERS='ftz_users',KEY_STATUSES='ftz_statuses',KEY_DMS='ftz_dms',KEY_BAST_MSGS='ftz_bmsgs';
  const dmKey=(a,b)=>`ftz_dm_${[a,b].sort().join('__')}`;
  let bc=null; try{bc=new BroadcastChannel('fortized');}catch(e){}
  function broadcast(type,data){try{bc?.postMessage({type,data,ts:Date.now()});}catch(e){}}
  function get(key,fallback=null){try{const v=localStorage.getItem(key);return v?JSON.parse(v):fallback;}catch(e){return fallback;}}
  function set(key,val){try{localStorage.setItem(key,JSON.stringify(val));}catch(e){}}
  function getUsers(){return get(KEY_USERS,[]);}
  function saveUsers(u){set(KEY_USERS,u);}
  function getUserByName(username){return getUsers().find(u=>u.username===username)||null;}
  function saveUserObject(user){const users=getUsers();const idx=users.findIndex(u=>u.username===user.username);if(idx!==-1)users[idx]={...users[idx],...user};else users.push(user);saveUsers(users);}
  function register(username,password,email=''){
    username=username.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');
    if(!username||username.length<3)return{ok:false,msg:'Username must be 3+ chars.'};
    if(!password||password.length<6)return{ok:false,msg:'Password must be 6+ chars.'};
    const users=getUsers();
    if(users.find(u=>u.username===username))return{ok:false,msg:'Username taken.'};
    const user={username,password,email,displayName:username,pfp:null,banner:null,onyx:25,status:'online',
      friends:[],friendRequestsSent:[],friendRequestsReceived:[],bastions:[],notifications:[],
      radianceUntil:null,lastDaily:null,createdAt:new Date().toISOString()};
    users.push(user);saveUsers(users);return{ok:true,user};
  }
  function login(username,password){
    username=username.trim().toLowerCase();
    const user=getUserByName(username);
    if(!user)return{ok:false,msg:'User not found.'};
    if(user.password!==password)return{ok:false,msg:'Wrong password.'};
    localStorage.setItem('ftz_current',username);localStorage.setItem('fortized_current_user',username);
    setStatus(username,'online');return{ok:true,user};
  }
  function getCurrentUsername(){return localStorage.getItem('ftz_current')||localStorage.getItem('fortized_current_user')||null;}
  function getStatus(username){const s=get(KEY_STATUSES,{});return s[username]||'offline';}
  function setStatus(username,status){const s=get(KEY_STATUSES,{});s[username]=status;set(KEY_STATUSES,s);broadcast('status',{username,status});}
  function getNotifications(username){const user=getUserByName(username);return(user?.notifications||[]).slice().reverse();}
  function addNotification(toUsername,notif){
    const users=getUsers();const idx=users.findIndex(u=>u.username===toUsername);if(idx===-1)return;
    if(!Array.isArray(users[idx].notifications))users[idx].notifications=[];
    notif.id=Date.now().toString(36)+Math.random().toString(36).slice(2);notif.time=new Date().toISOString();notif.read=false;
    users[idx].notifications.unshift(notif);if(users[idx].notifications.length>50)users[idx].notifications=users[idx].notifications.slice(0,50);
    saveUsers(users);broadcast('notification',{to:toUsername,notif});
  }
  function markNotificationsRead(username){const users=getUsers();const idx=users.findIndex(u=>u.username===username);if(idx===-1)return;(users[idx].notifications||[]).forEach(n=>n.read=true);saveUsers(users);}
  function getUnreadCount(username){return getNotifications(username).filter(n=>!n.read).length;}
  function sendFriendRequest(fromUsername,toUsername){
    if(fromUsername===toUsername)return{ok:false,msg:"Can't add yourself."};
    const users=getUsers();const fi=users.findIndex(u=>u.username===fromUsername);const ti=users.findIndex(u=>u.username===toUsername);
    if(fi===-1)return{ok:false,msg:'Your account not found.'};if(ti===-1)return{ok:false,msg:'User not found.'};
    const fu=users[fi],tu=users[ti];
    ['friends','friendRequestsSent','friendRequestsReceived'].forEach(k=>{if(!Array.isArray(fu[k]))fu[k]=[];if(!Array.isArray(tu[k]))tu[k]=[];});
    if(fu.friends.includes(toUsername))return{ok:false,msg:'Already friends.'};
    if(fu.friendRequestsSent.includes(toUsername))return{ok:false,msg:'Request already sent.'};
    if((tu.friendRequestsSent||[]).includes(fromUsername)){saveUsers(users);return acceptFriendRequest(fromUsername,toUsername);}
    fu.friendRequestsSent.push(toUsername);if(!tu.friendRequestsReceived.includes(fromUsername))tu.friendRequestsReceived.push(fromUsername);
    saveUsers(users);addNotification(toUsername,{type:'friend_request',from:fromUsername});broadcast('friend_request',{from:fromUsername,to:toUsername});
    return{ok:true,msg:`Friend request sent to ${toUsername}!`};
  }
  function acceptFriendRequest(myUsername,fromUsername){
    const users=getUsers();const mi=users.findIndex(u=>u.username===myUsername);const fi=users.findIndex(u=>u.username===fromUsername);
    if(mi===-1||fi===-1)return{ok:false,msg:'User not found.'};
    const mu=users[mi],fu=users[fi];
    ['friends','friendRequestsSent','friendRequestsReceived'].forEach(k=>{if(!Array.isArray(mu[k]))mu[k]=[];if(!Array.isArray(fu[k]))fu[k]=[];});
    if(!mu.friends.includes(fromUsername))mu.friends.push(fromUsername);if(!fu.friends.includes(myUsername))fu.friends.push(myUsername);
    mu.friendRequestsReceived=mu.friendRequestsReceived.filter(u=>u!==fromUsername);mu.friendRequestsSent=mu.friendRequestsSent.filter(u=>u!==fromUsername);
    fu.friendRequestsSent=fu.friendRequestsSent.filter(u=>u!==myUsername);fu.friendRequestsReceived=fu.friendRequestsReceived.filter(u=>u!==myUsername);
    (mu.notifications||[]).forEach(n=>{if(n.type==='friend_request'&&n.from===fromUsername)n.read=true;});
    saveUsers(users);addNotification(fromUsername,{type:'friend_accept',from:myUsername});broadcast('friend_accept',{from:myUsername,to:fromUsername});
    return{ok:true,msg:`You are now friends with ${fromUsername}!`};
  }
  function declineFriendRequest(myUsername,fromUsername){
    const users=getUsers();const mi=users.findIndex(u=>u.username===myUsername);const fi=users.findIndex(u=>u.username===fromUsername);
    if(mi!==-1){if(!Array.isArray(users[mi].friendRequestsReceived))users[mi].friendRequestsReceived=[];users[mi].friendRequestsReceived=users[mi].friendRequestsReceived.filter(u=>u!==fromUsername);}
    if(fi!==-1){if(!Array.isArray(users[fi].friendRequestsSent))users[fi].friendRequestsSent=[];users[fi].friendRequestsSent=users[fi].friendRequestsSent.filter(u=>u!==myUsername);}
    saveUsers(users);return{ok:true};
  }
  function removeFriend(myUsername,friendUsername){
    const users=getUsers();const mi=users.findIndex(u=>u.username===myUsername);const fi=users.findIndex(u=>u.username===friendUsername);
    if(mi!==-1){if(!Array.isArray(users[mi].friends))users[mi].friends=[];users[mi].friends=users[mi].friends.filter(u=>u!==friendUsername);}
    if(fi!==-1){if(!Array.isArray(users[fi].friends))users[fi].friends=[];users[fi].friends=users[fi].friends.filter(u=>u!==myUsername);}
    saveUsers(users);return{ok:true};
  }
  function getDMMessages(user1,user2){return get(dmKey(user1,user2),[]);}
  function sendDMMessage(fromUsername,toUsername,text){
    const key=dmKey(fromUsername,toUsername);const msgs=get(key,[]);
    const now=new Date();
    const msg={id:Date.now().toString(36)+Math.random().toString(36).slice(2),from:fromUsername,text,time:now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),timestamp:now.toISOString()};
    msgs.push(msg);set(key,msgs);
    const idx=get(KEY_DMS,{});if(!idx[fromUsername])idx[fromUsername]=[];if(!idx[toUsername])idx[toUsername]=[];
    if(!idx[fromUsername].includes(toUsername))idx[fromUsername].unshift(toUsername);if(!idx[toUsername].includes(fromUsername))idx[toUsername].unshift(fromUsername);
    idx[fromUsername]=idx[fromUsername].slice(0,30);idx[toUsername]=idx[toUsername].slice(0,30);set(KEY_DMS,idx);
    addNotification(toUsername,{type:'dm',from:fromUsername,data:{preview:text.slice(0,60)}});broadcast('dm',{from:fromUsername,to:toUsername,msgId:msg.id});
    return msg;
  }
  function getRecentDMPartners(username){return(get(KEY_DMS,{})[username])||[];}
  // Bastion messages: use a global key (not per-user) so all users share messages
  function getBastionChannelMessages(bastionId,channelId){const all=get(KEY_BAST_MSGS,{});return all[`${bastionId}__${channelId}`]||[];}
  function sendBastionChannelMessage(bastionId,channelId,fromUsername,text){
    const all=get(KEY_BAST_MSGS,{});const k=`${bastionId}__${channelId}`;
    if(!all[k])all[k]=[];
    const now=new Date();
    const msg={id:Date.now().toString(36)+Math.random().toString(36).slice(2),from:fromUsername,text,time:now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),timestamp:now.toISOString()};
    all[k].push(msg);if(all[k].length>500)all[k]=all[k].slice(-500);set(KEY_BAST_MSGS,all);
    broadcast('bastion_msg',{bastionId,channelId,msg});return msg;
  }
  function addReaction(bastionId,channelId,msgId,emoji,username){
    const all=get(KEY_BAST_MSGS,{});const k=`${bastionId}__${channelId}`;const msgs=all[k]||[];
    const msg=msgs.find(m=>m.id===msgId);if(!msg)return;
    if(!msg.reactions)msg.reactions={};if(!msg.reactions[emoji])msg.reactions[emoji]=[];
    const idx=msg.reactions[emoji].indexOf(username);
    if(idx!==-1)msg.reactions[emoji].splice(idx,1);else msg.reactions[emoji].push(username);
    if(msg.reactions[emoji].length===0)delete msg.reactions[emoji];set(KEY_BAST_MSGS,all);
  }
  // Global bastions registry (for public bastions & cross-user shared bastions)
  function getGlobalBastions(){return get('ftz_global_bastions',{});}
  function saveGlobalBastion(id,data){const all=getGlobalBastions();all[id]=data;set('ftz_global_bastions',all);}
  function getGlobalBastion(id){return getGlobalBastions()[id]||null;}
  // Members registry
  function getBastionMembers(bastionId){return get(`ftz_bm_${bastionId}`,[]);}
  function addBastionMember(bastionId,username){const m=getBastionMembers(bastionId);if(!m.includes(username))m.push(username);set(`ftz_bm_${bastionId}`,m);}
  function removeBastionMember(bastionId,username){const m=getBastionMembers(bastionId).filter(u=>u!==username);set(`ftz_bm_${bastionId}`,m);}

  let _pollInterval=null,_lastNotifCount=0,_pollCallbacks={};
  function startPolling(username,callbacks={}){
    _pollCallbacks=callbacks;stopPolling();
    if(bc){bc.onmessage=(e)=>{const{type,data}=e.data;if(!data)return;
      if(type==='notification'&&data.to===username)_pollCallbacks.onNewNotification?.(data.notif);
      if(type==='dm'&&data.to===username)_pollCallbacks.onNewDM?.(data);
      if(type==='friend_request'&&data.to===username)_pollCallbacks.onFriendRequest?.(data);
      if(type==='friend_accept'&&data.to===username)_pollCallbacks.onFriendAccept?.(data);
      if(type==='status')_pollCallbacks.onStatusChange?.(data);
      if(type==='bastion_msg')_pollCallbacks.onBastionMsg?.(data);
    };}
    _pollInterval=setInterval(()=>{const count=getUnreadCount(username);if(count!==_lastNotifCount){const notifs=getNotifications(username);const newest=notifs.find(n=>!n.read);if(newest)_pollCallbacks.onNewNotification?.(newest);_lastNotifCount=count;}},2000);
    _lastNotifCount=getUnreadCount(username);
  }
  function stopPolling(){clearInterval(_pollInterval);_pollInterval=null;if(bc)bc.onmessage=null;}
  function playNotificationSound(){try{const ctx=new(window.AudioContext||window.webkitAudioContext)();const osc=ctx.createOscillator();const gain=ctx.createGain();osc.connect(gain);gain.connect(ctx.destination);osc.type='sine';osc.frequency.setValueAtTime(880,ctx.currentTime);osc.frequency.exponentialRampToValueAtTime(1100,ctx.currentTime+0.08);gain.gain.setValueAtTime(0.08,ctx.currentTime);gain.gain.exponentialRampToValueAtTime(0.001,ctx.currentTime+0.3);osc.start(ctx.currentTime);osc.stop(ctx.currentTime+0.3);}catch(e){}}
  return{register,login,getCurrentUsername,getUsers,getUserByName,saveUserObject,getStatus,setStatus,
    getNotifications,addNotification,markNotificationsRead,getUnreadCount,
    sendFriendRequest,acceptFriendRequest,acceptFriend:acceptFriendRequest,declineFriendRequest,removeFriend,
    getDMMessages,sendDMMessage,getRecentDMPartners,
    getBastionChannelMessages,sendBastionChannelMessage,addReaction,
    getGlobalBastions,saveGlobalBastion,getGlobalBastion,getBastionMembers,addBastionMember,removeBastionMember,
    startPolling,stopPolling,playNotificationSound};
})();
</script>
<style>
:root{
  --accent:#fff93e;--accent-dim:rgba(255,249,62,.1);--accent-mid:rgba(255,249,62,.22);
  --bg:#07090e;--rail:#04060a;--sidebar:#0b0e15;--channel:#0d1018;--panel:#101420;--panel2:#131822;--panel3:#161c28;
  --border:#1c2335;--radius:16px;--muted:#4e5a6f;--muted-light:#7d8a9e;--text:#dde3ed;
  --green:#3ecf6e;--red:#f87171;--yellow:#f59e0b;--blue:#60a5fa;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;}
::selection{background:rgba(255,249,62,.2);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}

/* ═══ RAIL ═══ */
.rail{width:68px;min-width:68px;background:var(--rail);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:10;box-shadow:2px 0 24px rgba(0,0,0,.5);}
.rail-logo{width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-bottom:6px;}
.rail-logo img{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,249,62,.3));}
.rail-sep{width:30px;height:1px;background:var(--border);margin:5px 0;opacity:.4;}
.rail-btn{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;flex-shrink:0;font-size:18px;}
.rail-btn:hover{background:rgba(255,255,255,.07);border-radius:12px;}
.rail-btn.active{background:var(--accent-dim);border-radius:12px;}
.rail-btn.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#0c1020;border:1px solid var(--border);color:var(--text);font-size:12px;font-weight:600;padding:5px 10px;border-radius:9px;white-space:nowrap;z-index:999;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.5);}
.rail-bastion{width:42px;height:42px;border-radius:14px;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .15s;position:relative;overflow:hidden;flex-shrink:0;}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:12px;background:var(--accent-dim);}
.rail-bastion.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-bastion img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.rail-notif-badge{position:absolute;top:2px;right:2px;min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--rail);padding:0 2px;}

/* ═══ SIDEBAR ═══ */
.sidebar{width:240px;min-width:240px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{height:52px;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;gap:7px;background:rgba(0,0,0,.15);}
.sidebar-header .hdr-actions{margin-left:auto;display:flex;gap:2px;}
.sidebar-header .hdr-actions button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.sidebar-header .hdr-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 0;}
.sec-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 5px;display:flex;align-items:center;justify-content:space-between;}
.sec-label button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:18px;height:18px;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.sec-label button:hover{background:rgba(255,255,255,.07);color:#fff;}
.s-item{display:flex;align-items:center;gap:9px;padding:7px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:13px;color:var(--muted-light);transition:all .1s;}
.s-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.s-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.s-item .s-icon{width:26px;height:26px;border-radius:50%;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.s-item .s-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ch-item{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:12.5px;color:var(--muted);transition:all .1s;}
.ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.ch-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.cat-row{display:flex;align-items:center;gap:5px;padding:10px 8px 4px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);cursor:pointer;transition:color .1s;}
.cat-row:hover{color:var(--text);}
.cat-row button{margin-left:auto;background:none;border:none;color:inherit;cursor:pointer;font-size:14px;opacity:0;width:16px;height:16px;display:flex;align-items:center;justify-content:center;transition:opacity .1s;}
.cat-row:hover button{opacity:1;}
.friend-item{display:flex;align-items:center;gap:9px;padding:6px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;transition:background .1s;}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.fa{position:relative;flex-shrink:0;border-radius:50%;overflow:hidden;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;}
.fa img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.fa .fs{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--sidebar);}
.fs.online{background:var(--green);}
.fs.away{background:var(--yellow);}
.fs.dnd{background:var(--red);}
.fs.offline,.fs.invisible{background:#374151;}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* Bastion tag in sidebar friend/member items */
.bastion-tag{display:inline-flex;align-items:center;font-size:9px;font-weight:800;letter-spacing:.04em;padding:1px 5px;border-radius:4px;border:1px solid;margin-left:3px;vertical-align:middle;text-transform:uppercase;}
.userbar{height:56px;background:rgba(4,6,10,.8);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 8px;gap:7px;flex-shrink:0;}
.ua{width:34px;height:34px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;}
.ua img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ua .ua-ring{position:absolute;bottom:-1px;right:-1px;width:11px;height:11px;border-radius:50%;background:var(--green);border:2px solid var(--sidebar);}
.ua-info{flex:1;min-width:0;}
.ua-name{font-size:13px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ua-tag{font-size:10.5px;color:var(--muted);}
.ua-btns{display:flex;gap:2px;}
.ua-btns button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.ua-btns button:hover{background:rgba(255,255,255,.07);color:#fff;}

/* ═══ MAIN ═══ */
.main{flex:1;min-width:0;display:flex;flex-direction:column;}
.topbar{height:52px;background:rgba(8,11,18,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:10px;flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,.3);}
.topbar-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap;}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 2px;}
.tb-desc{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.tb-actions{margin-left:auto;display:flex;align-items:center;gap:6px;}
.tb-actions button{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.tb-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{display:flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:100px;padding:5px 12px;font-size:12px;font-weight:700;color:var(--accent);cursor:pointer;transition:background .12s;}
.onyx-pill:hover{background:rgba(255,249,62,.16);}
.onyx-pill img{width:14px;height:14px;object-fit:contain;}
.tb-search{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:5px 10px;width:170px;transition:all .2s;}
.tb-search:focus-within{border-color:rgba(255,249,62,.2);width:210px;}
.tb-search input{background:transparent;border:none;outline:none;color:#fff;font-family:'DM Sans',sans-serif;font-size:12.5px;flex:1;}
.tb-search input::placeholder{color:var(--muted);}
.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;}
.view.active{display:flex;}

/* ═══ HOME ═══ */
.home-wrap{flex:1;display:flex;overflow:hidden;}
.home-feed{flex:1;overflow-y:auto;background:var(--bg);}
.home-right{width:290px;min-width:290px;border-left:1px solid var(--border);overflow-y:auto;background:var(--channel);}
.home-hero{width:100%;min-height:280px;background:linear-gradient(105deg,rgba(7,9,14,.98) 35%,rgba(7,9,14,.65) 100%),url("Fortized banner.png") center/cover no-repeat;position:relative;overflow:hidden;flex-shrink:0;display:grid;grid-template-columns:1fr auto;align-items:center;padding:0 48px;}
.home-hero::before{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(255,249,62,.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,249,62,.012) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;}
.home-hero::after{content:"";position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to bottom,transparent,var(--bg));pointer-events:none;}
.hero-left-content{position:relative;z-index:1;animation:revealUp .5s cubic-bezier(.22,1,.36,1) both;}
@keyframes revealUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}
.hero-tag-app{display:inline-flex;align-items:center;gap:8px;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:100px;padding:5px 14px;margin-bottom:20px;}
.hero-tag-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 2s ease infinite;}
@keyframes blink{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.3;transform:scale(.6);}}
.home-hero h1{font-family:'Syne',sans-serif;font-size:48px;font-weight:800;letter-spacing:-2px;line-height:.96;margin-bottom:14px;}
.home-hero h1 em{font-style:normal;color:var(--accent);position:relative;display:inline-block;}
.home-hero h1 em::after{content:"";position:absolute;bottom:-3px;left:0;right:0;height:2.5px;background:var(--accent);border-radius:2px;transform:scaleX(0);transform-origin:left;animation:underlineReveal .45s cubic-bezier(.22,1,.36,1) .6s both;}
@keyframes underlineReveal{from{transform:scaleX(0);}to{transform:scaleX(1);}}
.home-hero p.hero-sub-app{font-size:14.5px;color:rgba(255,255,255,.6);line-height:1.65;max-width:360px;margin-bottom:26px;}
.home-hero-actions{display:flex;gap:10px;flex-wrap:wrap;}
.home-hero-actions .btn-a{font-size:13px;padding:10px 22px;}
.home-hero-actions .btn-g{font-size:13px;padding:9px 20px;}
.home-hero-knight{position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:center;height:280px;width:200px;}
.home-hero-knight::before{content:"";position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:160px;height:80px;border-radius:50%;background:radial-gradient(ellipse,rgba(255,249,62,.2),transparent 70%);filter:blur(18px);animation:glowPulse 3s ease-in-out infinite;}
@keyframes glowPulse{0%,100%{opacity:.8;}50%{opacity:1;}}
.home-hero-knight img{height:250px;object-fit:contain;position:relative;z-index:1;filter:drop-shadow(0 20px 40px rgba(255,249,62,.15));animation:float 5.5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-14px);}}
.home-marquee{background:rgba(11,14,21,.7);border-top:1px solid var(--border);border-bottom:1px solid var(--border);overflow:hidden;position:relative;flex-shrink:0;}
.home-marquee::before,.home-marquee::after{content:"";position:absolute;top:0;bottom:0;width:80px;z-index:2;pointer-events:none;}
.home-marquee::before{left:0;background:linear-gradient(to right,var(--bg),transparent);}
.home-marquee::after{right:0;background:linear-gradient(to left,var(--bg),transparent);}
.marquee-track{display:flex;animation:marquee 20s linear infinite;width:max-content;}
@keyframes marquee{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.marquee-item{display:flex;align-items:center;gap:10px;padding:14px 36px;border-right:1px solid var(--border);white-space:nowrap;}
.mi-icon{font-size:15px;opacity:.7;}
.mi-label{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;color:var(--muted-light);letter-spacing:.04em;}
.mi-accent{color:var(--accent);}
.home-main-scroll{padding:28px 32px 48px;max-width:900px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-hdr h3{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.section-hdr h3::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.section-hdr a{font-size:12.5px;color:var(--muted-light);cursor:pointer;text-decoration:none;}
.section-hdr a:hover{color:var(--accent);}
.quick-nav{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px;}
.qn-tile{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 18px;cursor:pointer;transition:all .22s;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;}
.qn-tile::before{content:"";position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .25s;}
.qn-tile::after{content:"";position:absolute;top:-50px;right:-50px;width:120px;height:120px;border-radius:50%;background:radial-gradient(circle,rgba(255,249,62,.06),transparent 70%);opacity:0;transition:opacity .25s;}
.qn-tile:hover{border-color:rgba(255,249,62,.2);transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,.4);}
.qn-tile:hover::before,.qn-tile:hover::after{opacity:1;}
.qn-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.qn-text h4{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:2px;}
.qn-text p{font-size:12px;color:var(--muted);}
.qn-badge{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:100px;}
.activity-feed{display:flex;flex-direction:column;gap:8px;margin-bottom:32px;}
.activity-item{display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.activity-item::before{content:"";position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .2s;}
.activity-item:hover{border-color:rgba(255,249,62,.16);transform:translateY(-2px);box-shadow:0 10px 32px rgba(0,0,0,.3);}
.activity-item:hover::before{opacity:1;}
.act-icon{width:40px;height:40px;border-radius:14px;background:var(--panel2);border:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.act-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.act-text{flex:1;}
.act-text p{font-size:14px;color:var(--text);line-height:1.5;}
.act-text p strong{font-weight:700;}
.act-time{font-size:11.5px;color:var(--muted);margin-top:2px;}
.mini-bastion-row{display:flex;flex-direction:column;gap:10px;margin-bottom:28px;}
.mini-bastion{display:flex;align-items:center;gap:12px;padding:16px 18px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;}
.mini-bastion::before{content:"";position:absolute;top:0;left:0;right:0;height:1.5px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .2s;}
.mini-bastion:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);box-shadow:0 10px 32px rgba(0,0,0,.3);}
.mini-bastion:hover::before{opacity:1;}
.mb-icon{width:44px;height:44px;border-radius:14px;background:var(--panel2);border:1px solid var(--border);font-size:20px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.mb-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.mb-info{flex:1;}
.mb-name{font-size:14px;font-weight:700;}
.mb-meta{font-size:12px;color:var(--muted);margin-top:2px;}
.mb-join{background:var(--accent-dim);border:1px solid var(--accent-mid);color:var(--accent);font-size:12px;font-weight:700;padding:6px 14px;border-radius:10px;cursor:pointer;transition:background .12s;flex-shrink:0;}
.mb-join:hover{background:rgba(255,249,62,.18);}
.rp-section{padding:16px 14px 8px;border-bottom:1px solid var(--border);}
.rp-section:last-child{border-bottom:none;}
.rp-title{font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.rp-notif{display:flex;gap:9px;padding:8px 10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.rp-notif:hover{background:rgba(255,255,255,.04);}
.rp-notif.unread{background:rgba(255,249,62,.04);}
.rp-notif .rn-icon{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rp-notif .rn-text{flex:1;}
.rp-notif .rn-text p{font-size:12.5px;color:var(--text);line-height:1.4;}
.rp-notif .rn-text p strong{font-weight:700;}
.rp-notif .rn-time{font-size:10.5px;color:var(--muted);}
.rp-notif .rn-actions{display:flex;gap:5px;margin-top:5px;}
.rn-accept{background:rgba(62,207,110,.15);border:1px solid rgba(62,207,110,.3);color:var(--green);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.rn-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.blog-post{padding:10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.blog-post:hover{background:rgba(255,255,255,.04);}
.blog-post .bp-tag{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--accent);margin-bottom:3px;}
.blog-post .bp-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.4;}
.blog-post .bp-date{font-size:11px;color:var(--muted);}

/* ═══ DISCORD-STYLE CHAT ═══ */
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;}
.chat-welcome{padding:20px 20px 18px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.chat-welcome .w-av{width:60px;height:60px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:22px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:hidden;}
.chat-welcome .w-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.chat-welcome p{font-size:13.5px;color:var(--muted-light);}
.date-div{display:flex;align-items:center;gap:10px;padding:8px 20px;margin:4px 0;font-size:10.5px;font-weight:700;color:var(--muted);letter-spacing:.04em;}
.date-div::before,.date-div::after{content:"";flex:1;height:1px;background:var(--border);}

/* Discord-style message rows */
.msg-row{display:flex;padding:2px 20px;position:relative;border-radius:0;}
.msg-row:hover{background:rgba(255,255,255,.018);}
.msg-row.msg-first{padding-top:16px;}
.msg-row.msg-first .msg-av-wrap{visibility:visible;}
.msg-row.msg-cont .msg-av-wrap{visibility:hidden;}
.msg-av-wrap{width:40px;min-width:40px;display:flex;justify-content:center;padding-top:2px;flex-shrink:0;}
.msg-av-inner{width:36px;height:36px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0;}
.msg-av-inner img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.msg-av-inner:hover{opacity:.8;}
.msg-time-small{font-size:10px;color:var(--muted);white-space:nowrap;padding-top:4px;min-width:44px;text-align:left;visibility:hidden;}
.msg-row.msg-cont:hover .msg-time-small{visibility:visible;}
.msg-content-col{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
.msg-author{font-size:14px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-timestamp{font-size:11px;color:var(--muted);}
.msg-text{font-size:14px;color:var(--text);line-height:1.55;word-break:break-word;max-width:680px;}
.msg-text code{background:rgba(255,255,255,.07);padding:1px 6px;border-radius:5px;font-size:12.5px;font-family:monospace;}
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.r-pill{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:100px;padding:2px 9px;font-size:12.5px;cursor:pointer;transition:background .1s;}
.r-pill:hover{background:rgba(255,255,255,.09);}
.r-pill.mine{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
/* Message actions bar (like discord) */
.msg-acts{display:none;gap:2px;position:absolute;right:14px;top:-14px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:3px;z-index:10;}
.msg-row:hover .msg-acts{display:flex;}
.msg-acts button{background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.msg-acts button:hover{background:rgba(255,255,255,.07);color:#fff;}
/* Own messages */
.msg-row.own .msg-text{color:rgba(255,249,62,.92);}
/* Bastion tag on messages */
.msg-bastion-tag{display:inline-flex;align-items:center;font-size:9px;font-weight:800;padding:1px 5px;border-radius:4px;border:1px solid;margin-left:4px;vertical-align:middle;text-transform:uppercase;letter-spacing:.04em;}

/* Input */
.chat-input-wrap{padding:0 16px 14px;flex-shrink:0;}
.chat-input-box{background:var(--panel2);border:1px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;gap:5px;padding:8px 11px;transition:border-color .15s;}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.24);box-shadow:0 0 0 2px rgba(255,249,62,.05);}
.chat-input-box textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13.5px;resize:none;max-height:120px;line-height:1.5;padding:2px 0;}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{width:32px;height:32px;border-radius:10px;background:var(--accent);border:none;color:#060810;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:filter .1s;}
.chat-send:hover{filter:brightness(1.08);}
.chat-input-actions button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.chat-input-actions{display:flex;gap:2px;align-items:center;}
/* Custom emoji bar in input */
.custom-emoji-bar{display:flex;gap:4px;flex-wrap:wrap;padding:6px 10px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:6px;}
.cem-btn{width:28px;height:28px;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:17px;transition:background .1s;border:none;background:transparent;}
.cem-btn:hover{background:rgba(255,255,255,.07);}
.cem-btn img{width:22px;height:22px;object-fit:contain;border-radius:4px;}

/* Member list */
.member-list{width:220px;min-width:220px;background:var(--channel);border-left:1px solid var(--border);overflow-y:auto;padding:12px 0;}
.ml-header{padding:0 12px 8px;font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
.ml-entry{display:flex;align-items:center;gap:8px;padding:5px 9px;margin:1px 4px;border-radius:10px;cursor:pointer;transition:background .1s;position:relative;}
.ml-entry:hover{background:rgba(255,255,255,.05);}
.ml-av{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;position:relative;}
.ml-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ml-status{position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border-radius:50%;border:2px solid var(--channel);}
.ml-info{flex:1;min-width:0;}
.ml-name{font-size:12.5px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ml-role-badge{font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;border:1px solid;display:inline-block;margin-top:1px;}

/* ═══ DISCOVER ═══ */
.discover-scroll{flex:1;overflow-y:auto;padding:28px;}
.disc-hero{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:38px 36px;margin-bottom:28px;position:relative;overflow:hidden;}
.disc-hero::before{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(255,249,62,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(255,249,62,.015) 1px,transparent 1px);background-size:48px 48px;}
.disc-hero::after{content:"";position:absolute;top:-80px;right:-80px;width:300px;height:300px;border-radius:50%;background:radial-gradient(circle,rgba(255,249,62,.06) 0%,transparent 70%);}
.disc-hero h2{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px;position:relative;}
.disc-hero p{font-size:14px;color:var(--muted-light);margin-bottom:20px;position:relative;max-width:440px;}
.disc-search{display:flex;align-items:center;gap:10px;max-width:400px;position:relative;}
.disc-search input{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;padding:10px 14px 10px 38px;outline:none;transition:border-color .12s;}
.disc-search input:focus{border-color:rgba(255,249,62,.25);}
.disc-search input::placeholder{color:var(--muted);}
.disc-search .si{position:absolute;left:12px;font-size:13px;color:var(--muted);pointer-events:none;}
.disc-tabs{display:flex;gap:5px;margin-bottom:22px;}
.disc-tab{padding:7px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--muted-light);transition:all .12s;}
.disc-tab:hover{background:rgba(255,255,255,.05);color:#fff;}
.disc-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.bc{background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;transition:all .15s;}
.bc:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.bc-banner{height:76px;background:linear-gradient(135deg,#1a2040,#0d1425);display:flex;align-items:center;justify-content:center;font-size:30px;position:relative;overflow:hidden;}
.bc-banner img{width:100%;height:100%;object-fit:cover;}
.bc-banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,transparent 40%,rgba(0,0,0,.5));}
.bc-body{padding:14px;}
.bc-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bc-icon{width:42px;height:42px;border-radius:12px;background:var(--panel2);border:2px solid var(--sidebar);font-size:18px;display:flex;align-items:center;justify-content:center;margin-top:-26px;position:relative;z-index:1;flex-shrink:0;overflow:hidden;}
.bc-icon img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.bc-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.bc-desc{font-size:12px;color:var(--muted-light);line-height:1.55;margin-bottom:8px;}
.bc-stats{display:flex;gap:10px;font-size:11.5px;color:var(--muted);}
.bc-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px;}
.bc-tag{font-size:10px;font-weight:600;padding:2px 8px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted-light);}

/* ═══ ATELIER ═══ */
.atelier-scroll{flex:1;overflow-y:auto;padding:28px;}
.atelier-top{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:26px 30px;margin-bottom:26px;position:relative;overflow:hidden;}
.atelier-top::before{content:"";position:absolute;top:-50px;right:-50px;width:180px;height:180px;border-radius:50%;background:radial-gradient(circle,rgba(255,249,62,.07) 0%,transparent 70%);}
.atelier-bal{display:flex;align-items:center;gap:13px;}
.atelier-bal img{width:36px;height:36px;object-fit:contain;}
.atelier-bal h3{font-size:13px;font-weight:600;color:var(--muted-light);margin-bottom:2px;}
.atelier-bal .amt{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:var(--accent);letter-spacing:-.3px;}
.daily-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:16px;padding:14px 24px;cursor:pointer;transition:background .12s;}
.daily-btn:hover{background:rgba(255,249,62,.13);}
.daily-btn span{font-size:11px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:14px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.atelier-section-title::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:28px;}
.rad-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px 18px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.rad-card::before{content:"";position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:0;transition:opacity .2s;}
.rad-card:hover{border-color:rgba(255,249,62,.22);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.rad-card:hover::before{opacity:1;}
.rad-card.bv{border-color:rgba(255,249,62,.18);}
.best-badge{position:absolute;top:10px;right:10px;background:var(--accent);color:#060810;font-size:9px;font-weight:800;letter-spacing:.05em;padding:2px 7px;border-radius:100px;text-transform:uppercase;}
.rad-icon{font-size:30px;}
.rad-dur{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.rad-price{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--accent);}
.rad-price span{font-size:12px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-feats{font-size:12px;color:var(--muted-light);line-height:1.6;}

/* ═══ PROFILE ═══ */
.profile-wrap{flex:1;display:flex;overflow:hidden;}
.profile-nav{width:210px;min-width:210px;border-right:1px solid var(--border);background:var(--channel);display:flex;flex-direction:column;padding:12px 0;overflow-y:auto;}
.profile-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13.5px;color:var(--muted-light);transition:all .1s;}
.profile-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.profile-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.profile-main{flex:1;overflow-y:auto;}
.profile-banner-area{width:100%;height:150px;background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);position:relative;overflow:hidden;}
.profile-banner-area img{width:100%;height:100%;object-fit:cover;}
.profile-av-row{display:flex;align-items:flex-end;gap:14px;padding:0 24px;margin-top:-28px;margin-bottom:14px;}
.profile-av-big{width:56px;height:56px;border-radius:50%;background:var(--panel);border:3px solid var(--bg);font-size:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-display-name{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:2px;}
.profile-username{font-size:13.5px;color:var(--muted-light);}
.profile-content{padding:0 24px 36px;}
.profile-stats-row{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;margin-bottom:22px;}
.ps-stat{flex:1;padding:16px;text-align:center;border-right:1px solid var(--border);}
.ps-stat:last-child{border-right:none;}
.ps-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.ps-key{font-size:11.5px;color:var(--muted);margin-top:2px;}
.settings-section{margin-bottom:24px;}
.settings-title{font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.s-row{display:flex;align-items:center;gap:12px;padding:13px 15px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;cursor:pointer;transition:all .12s;}
.s-row:hover{border-color:rgba(255,249,62,.12);background:rgba(255,249,62,.02);}
.s-row .si{font-size:17px;width:30px;text-align:center;}
.s-row .st{flex:1;}
.s-row .sl{font-size:13.5px;font-weight:600;}
.s-row .ss{font-size:12px;color:var(--muted-light);margin-top:1px;}
.field-group{margin-bottom:15px;}
.field-label{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.field-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;transition:border-color .12s;}
.field-input:focus{border-color:rgba(255,249,62,.3);}
.field-input::placeholder{color:#252c3d;}
.field-hint{font-size:11.5px;color:var(--muted);margin-top:4px;}
.toggle{width:38px;height:20px;border-radius:10px;background:var(--border);position:relative;cursor:pointer;transition:background .15s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .15s;}
.toggle.on::after{transform:translateX(18px);}
.radiance-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));border:1px solid rgba(255,220,62,.25);border-radius:100px;padding:3px 10px;font-size:11px;font-weight:700;color:#ffd93e;margin-top:5px;}
.boost-bar{background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12.5px;color:var(--muted-light);cursor:pointer;margin:8px 8px 4px;transition:background .12s;}
.boost-bar:hover{background:rgba(255,249,62,.1);}
.boost-bar .bl{font-weight:700;color:var(--accent);}

/* ═══ BASTION SETTINGS PANEL ═══ */
.bsettings-wrap{flex:1;display:flex;overflow:hidden;}
.bsettings-nav{width:220px;min-width:220px;border-right:1px solid var(--border);background:var(--channel);overflow-y:auto;padding:12px 0;}
.bsettings-main{flex:1;overflow-y:auto;padding:28px;}
.bsettings-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13px;color:var(--muted-light);transition:all .1s;}
.bsettings-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.bsettings-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.bsettings-nav-section{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 4px;}
.role-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;cursor:pointer;transition:all .12s;}
.role-item:hover{border-color:rgba(255,249,62,.15);}
.role-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.role-name{flex:1;font-size:13.5px;font-weight:600;}
.role-count{font-size:12px;color:var(--muted);}
.perm-row{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.perm-row:last-child{border-bottom:none;}
.perm-info{flex:1;}
.perm-label{font-size:13.5px;font-weight:600;}
.perm-desc{font-size:12px;color:var(--muted-light);margin-top:2px;line-height:1.4;}
.emoji-upload-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px;}
.emoji-slot{width:52px;height:52px;border-radius:10px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;position:relative;overflow:hidden;font-size:22px;}
.emoji-slot:hover{border-color:var(--accent);background:var(--accent-dim);}
.emoji-slot.filled{border-style:solid;border-color:var(--border);}
.emoji-slot img{width:40px;height:40px;object-fit:contain;border-radius:6px;}
.emoji-slot .es-del{position:absolute;top:2px;right:2px;width:14px;height:14px;border-radius:50%;background:var(--red);color:#fff;font-size:8px;display:none;align-items:center;justify-content:center;cursor:pointer;}
.emoji-slot:hover .es-del{display:flex;}

/* ═══ MODALS ═══ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:20px;width:100%;max-width:420px;overflow:hidden;animation:mIn .2s cubic-bezier(.22,1,.36,1) both;box-shadow:0 32px 80px rgba(0,0,0,.7);}
.modal.wide{max-width:580px;}
.modal.tall{max-height:80vh;display:flex;flex-direction:column;}
.modal.tall .modal-body{overflow-y:auto;flex:1;}
@keyframes mIn{from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);flex-shrink:0;}
.modal-body{padding:26px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px;}
.modal-sub{font-size:13px;color:var(--muted-light);margin-bottom:22px;}
.modal-error{font-size:12px;color:var(--red);margin-bottom:8px;min-height:16px;display:flex;align-items:center;gap:5px;}
.modal-error:not(:empty)::before{content:"⚠";}
.modal-success{font-size:12px;color:var(--green);margin-bottom:8px;}
.modal-actions{display:flex;gap:9px;margin-top:6px;}
.modal-actions .btn-a,.modal-actions .btn-g{flex:1;justify-content:center;}
.modal-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;margin-bottom:12px;transition:border-color .12s;}
.modal-input:focus{border-color:rgba(255,249,62,.32);}
.modal-input::placeholder{color:#252c3d;}
.btn-a{display:inline-flex;align-items:center;gap:7px;background:var(--accent);color:#060810;padding:10px 20px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:none;cursor:pointer;transition:all .1s;}
.btn-a:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-g{display:inline-flex;align-items:center;gap:7px;background:transparent;color:var(--muted-light);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid var(--border);cursor:pointer;transition:all .1s;}
.btn-g:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-d{display:inline-flex;align-items:center;gap:7px;background:rgba(248,113,113,.1);color:var(--red);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid rgba(248,113,113,.2);cursor:pointer;transition:all .1s;}
.btn-d:hover{background:rgba(248,113,113,.18);}
.toast{position:fixed;bottom:22px;right:22px;z-index:2000;background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:11px 18px;font-size:13px;font-weight:500;box-shadow:0 20px 50px rgba(0,0,0,.6);transform:translateY(20px);opacity:0;transition:transform .25s cubic-bezier(.22,1,.36,1),opacity .25s;max-width:280px;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}
.ctx-menu{position:fixed;z-index:9999;background:rgba(13,16,24,.98);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:6px;min-width:200px;max-width:260px;box-shadow:0 20px 50px rgba(0,0,0,.7),0 0 0 1px rgba(0,0,0,.4),inset 0 1px 0 rgba(255,255,255,.04);backdrop-filter:blur(22px);animation:ctxIn .14s cubic-bezier(.22,1,.36,1);user-select:none;}
@keyframes ctxIn{from{opacity:0;transform:scale(.96) translateY(-4px);}to{opacity:1;transform:none;}}
.ctx-header{padding:7px 12px 5px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:rgba(255,255,255,.25);}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;font-size:13px;color:rgba(220,228,240,.9);cursor:pointer;transition:all .07s;line-height:1;}
.ctx-item .ctx-icon{width:18px;height:18px;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;opacity:.7;}
.ctx-item .ctx-label{flex:1;}
.ctx-item .ctx-shortcut{font-size:10.5px;color:rgba(255,255,255,.25);flex-shrink:0;}
.ctx-item:hover{background:rgba(255,255,255,.07);color:#fff;}
.ctx-item:hover .ctx-icon{opacity:1;}
.ctx-item.danger{color:rgba(248,113,113,.85);}
.ctx-item.danger:hover{background:rgba(248,113,113,.12);color:var(--red);}
.ctx-item.disabled{opacity:.35;cursor:not-allowed;pointer-events:none;}
.ctx-sep{height:1px;background:rgba(255,255,255,.07);margin:5px 0;}
.ctx-section-label{padding:9px 12px 4px;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:rgba(255,255,255,.22);}
.notif-panel{position:fixed;top:52px;right:0;width:330px;max-height:calc(100vh - 60px);background:var(--sidebar);border:1px solid var(--border);border-radius:18px 0 0 18px;box-shadow:-8px 0 40px rgba(0,0,0,.5);z-index:100;transform:translateX(100%);transition:transform .22s cubic-bezier(.22,1,.36,1);display:flex;flex-direction:column;}
.notif-panel.open{transform:translateX(0);}
.np-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.np-header h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.np-header button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.np-header button:hover{background:rgba(255,255,255,.07);color:#fff;}
.np-list{flex:1;overflow-y:auto;padding:8px;}
.np-item{display:flex;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:background .08s;margin-bottom:3px;position:relative;}
.np-item:hover{background:rgba(255,255,255,.04);}
.np-item.unread{background:rgba(255,249,62,.04);}
.np-item.unread::before{content:"";position:absolute;left:4px;top:50%;transform:translateY(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent);}
.np-icon{width:32px;height:32px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.np-text{flex:1;}
.np-text p{font-size:12.5px;color:var(--text);line-height:1.45;}
.np-text p strong{font-weight:700;}
.np-time{font-size:10.5px;color:var(--muted);margin-top:2px;}
.np-actions{display:flex;gap:5px;margin-top:6px;}
.np-accept{background:rgba(62,207,110,.12);border:1px solid rgba(62,207,110,.25);color:var(--green);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.np-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.np-empty{padding:40px;text-align:center;color:var(--muted);font-size:13px;}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--muted);text-align:center;padding:40px;}
.empty-state .ei{font-size:48px;opacity:.3;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13.5px;max-width:290px;line-height:1.6;}
.emoji-picker-wrap{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.emoji-opt{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:19px;cursor:pointer;border:1.5px solid transparent;transition:all .1s;}
.emoji-opt:hover{background:rgba(255,255,255,.06);}
.emoji-opt.sel{border-color:var(--accent);background:var(--accent-dim);}
/* Color picker for roles */
.color-swatches{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .1s;}
.color-swatch:hover,.color-swatch.sel{border-color:#fff;transform:scale(1.15);}
/* Boost level indicator */
.boost-level-bar{display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(90deg,rgba(255,249,62,.07),rgba(255,249,62,.03));border:1px solid rgba(255,249,62,.15);border-radius:14px;margin-bottom:18px;}
.bl-icon{font-size:22px;}
.bl-info{flex:1;}
.bl-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--accent);}
.bl-sub{font-size:12px;color:var(--muted-light);}
.bl-prog{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.bl-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .4s;}
</style>
</head>
<body>

<!-- RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Home">
    <img src="Fortized icon.png" alt="" onerror="this.outerHTML='<span style=font-size:24px>🏰</span>'">
  </div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" id="rail-add" onclick="openCreateBastion()" data-tip="Create Bastion" style="border:1.5px dashed #1c2335;border-radius:14px;font-size:20px;color:var(--muted);">+</div>
  <div style="margin-top:auto;"></div>
  <div class="rail-btn" id="rail-notif" onclick="toggleNotifPanel()" data-tip="Notifications" style="position:relative;">
    🔔<div class="rail-notif-badge" id="notif-badge" style="display:none;">0</div>
  </div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Settings">⚙️</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header">
    <div style="display:flex;align-items:center;gap:8px;cursor:pointer;" onclick="navigate('home')">
      <img src="Fortized icon.png" style="width:20px;height:20px;object-fit:contain;filter:drop-shadow(0 0 6px rgba(255,249,62,.3));" onerror="this.style.display='none'">
      <span id="sidebar-title" style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;">Fortized</span>
    </div>
    <div class="hdr-actions" id="sidebar-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <div id="boost-bar-wrap" style="display:none;">
    <div class="boost-bar" onclick="openBastionBoost()">
      <span>⚡</span>
      <div><div class="bl" id="boost-label">Boost Bastion</div><div style="font-size:11px;" id="boost-sublabel">Level 0</div></div>
    </div>
  </div>
  <div class="userbar">
    <div class="ua" id="ua" onclick="navigate('profile')"><div class="ua-ring"></div></div>
    <div class="ua-info">
      <div class="ua-name" id="ua-name">—</div>
      <div class="ua-tag" id="ua-tag">● Online</div>
    </div>
    <div class="ua-btns">
      <button title="Mute" onclick="toast('Muted','info')">🎤</button>
      <button title="Deafen" onclick="toast('Deafened','info')">🎧</button>
      <button title="Log Out" onclick="logout()">🚪</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title"><span>🏠</span><span>Home</span></div>
    <div class="tb-sep"></div>
    <div class="tb-desc" id="topbar-desc">Welcome to Fortized</div>
    <div class="tb-actions">
      <div class="onyx-pill" onclick="navigate('atelier')">
        <img src="Onyx.png" onerror="this.outerHTML='💎'"><span id="topbar-onyx">0</span>
      </div>
      <div class="tb-search">
        <span style="font-size:12px;color:var(--muted);">🔍</span>
        <input type="text" placeholder="Search…">
      </div>
      <button id="member-list-btn" style="display:none;" onclick="toggleMemberList()" title="Members">👥</button>
      <button id="bastion-settings-btn" style="display:none;" onclick="openBastionSettings()" title="Bastion Settings">⚙️</button>
    </div>
  </div>

  <div class="content">
    <div id="view-home" class="view active">
      <div class="home-wrap">
        <div class="home-feed"><div id="home-content"></div></div>
        <div class="home-right" id="home-right"></div>
      </div>
    </div>
    <div id="view-bastion" class="view" style="flex-direction:row;">
      <div id="bastion-main" style="flex:1;display:flex;flex-direction:column;min-width:0;"></div>
      <div class="member-list" id="member-list" style="display:none;"></div>
    </div>
    <div id="view-discover" class="view">
      <div class="discover-scroll">
        <div class="disc-hero">
          <h2>Discover Bastions</h2>
          <p>Find public communities, join the fight, and make your mark.</p>
          <div class="disc-search"><span class="si">🔍</span><input type="text" placeholder="Search bastions…" id="disc-input" oninput="filterBastions()"></div>
        </div>
        <div class="disc-tabs">
          <div class="disc-tab active" onclick="setDiscTab('all',this)">All</div>
          <div class="disc-tab" onclick="setDiscTab('gaming',this)">🎮 Gaming</div>
          <div class="disc-tab" onclick="setDiscTab('competitive',this)">⚔️ Competitive</div>
          <div class="disc-tab" onclick="setDiscTab('casual',this)">🎪 Casual</div>
          <div class="disc-tab" onclick="setDiscTab('roleplay',this)">🐉 Roleplay</div>
        </div>
        <div class="bastion-grid" id="bastion-grid"></div>
      </div>
    </div>
    <div id="view-atelier" class="view">
      <div class="atelier-scroll">
        <div class="atelier-top">
          <div class="atelier-bal">
            <img src="Onyx.png" onerror="this.outerHTML='💎'">
            <div><h3>Onyx Balance</h3><div class="amt" id="atelier-balance">0</div></div>
          </div>
          <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
            <span>Daily Reward</span><strong>+5 Onyx</strong><span id="daily-status">Claim now →</span>
          </div>
        </div>
        <div class="atelier-section-title">Radiance — Premium Status</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(110,'1 Day')"><div class="rad-icon">✨</div><div class="rad-dur">1 Day</div><div class="rad-price">110 <span>Onyx</span></div><div class="rad-feats">Full perks for 24 hours</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div>
          <div class="rad-card bv" onclick="buyRadiance(770,'7 Days')"><div class="best-badge">Best Value</div><div class="rad-icon">⚡</div><div class="rad-dur">7 Days</div><div class="rad-price">770 <span>Onyx</span></div><div class="rad-feats">Full perks for one week</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div>
          <div class="rad-card" onclick="buyRadiance(3300,'30 Days')"><div class="rad-icon">👑</div><div class="rad-dur">30 Days</div><div class="rad-price">3,300 <span>Onyx</span></div><div class="rad-feats">Full perks for a month</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div>
        </div>
        <div class="atelier-section-title">Radiance Perks</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:30px;">
          <div class="s-row" style="cursor:default;"><span class="si">🎨</span><div class="st"><div class="sl">Custom Profile Badge</div><div class="ss">Exclusive Radiance crown</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">🌟</span><div class="st"><div class="sl">Animated Border</div><div class="ss">Glowing avatar frame</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">💬</span><div class="st"><div class="sl">Extended Messages</div><div class="ss">Up to 4000 chars</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">📁</span><div class="st"><div class="sl">100MB Uploads</div><div class="ss">Standard is 8MB</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">🎭</span><div class="st"><div class="sl">Custom Emoji</div><div class="ss">Use anywhere</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">🖼</span><div class="st"><div class="sl">Custom Banner</div><div class="ss">Personalize your profile</div></div></div>
        </div>
      </div>
    </div>
    <div id="view-profile" class="view">
      <div class="profile-wrap">
        <div class="profile-nav" id="profile-nav"></div>
        <div class="profile-main" id="profile-main"></div>
      </div>
    </div>
    <!-- BASTION SETTINGS VIEW -->
    <div id="view-bsettings" class="view">
      <div class="bsettings-wrap">
        <div class="bsettings-nav" id="bsettings-nav"></div>
        <div class="bsettings-main" id="bsettings-main"></div>
      </div>
    </div>
  </div>
</div>

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="np-header">
    <h3>Notifications</h3>
    <div style="display:flex;gap:3px;">
      <button onclick="markAllRead()" style="font-size:11px;width:auto;padding:0 7px;">✓ All</button>
      <button onclick="toggleNotifPanel()">✕</button>
    </div>
  </div>
  <div class="np-list" id="np-list"></div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create a Bastion</div>
      <div class="modal-sub">Build your own community fortress.</div>
      <div class="modal-error" id="create-error"></div>
      <input class="modal-input" id="bastion-name-input" placeholder="Bastion name" maxlength="32">
      <input class="modal-input" id="bastion-desc-input" placeholder="Short description (optional)" maxlength="80">
      <div style="margin-bottom:12px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Bastion Tag (optional) <span style="color:var(--muted-light);font-weight:400;text-transform:none;letter-spacing:0;">— shown next to usernames</span></div>
        <input class="modal-input" id="bastion-tag-input" placeholder="e.g. WAR, FPS (max 5 chars)" maxlength="5" style="margin-bottom:6px;text-transform:uppercase;">
      </div>
      <div style="margin-bottom:12px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Tag Color</div>
        <div class="color-swatches" id="bastion-color-picker"></div>
      </div>
      <div style="margin-bottom:14px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Icon Emoji</div>
        <div class="emoji-picker-wrap" id="bastion-emoji-picker"></div>
      </div>
      <div style="margin-bottom:14px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Custom Emblem (optional)</div>
        <label style="cursor:pointer;display:flex;align-items:center;gap:10px;">
          <div id="emblem-preview" style="width:48px;height:48px;border-radius:12px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden;" id="create-emblem-prev">📷</div>
          <span class="btn-g" style="font-size:12px;padding:7px 12px;">Upload Image</span>
          <input type="file" accept="image/*" id="bastion-emblem-input" style="display:none;" onchange="handleEmblemUpload(event,'create-emblem-prev')">
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-a" onclick="createBastion()">⚔️ Create</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">New Direct Message</div>
      <div class="modal-sub">Message any Fortized user by their exact username.</div>
      <div class="modal-error" id="dm-error"></div>
      <input class="modal-input" id="dm-username-input" placeholder="Enter username…" onkeydown="if(event.key==='Enter')startDM()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-a" onclick="startDM()">Open DM</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Add a Friend</div>
      <div class="modal-sub">Send a friend request by their exact username.</div>
      <div class="modal-error" id="af-error"></div>
      <div class="modal-success" id="af-success"></div>
      <input class="modal-input" id="af-input" placeholder="Exact username…" onkeydown="if(event.key==='Enter')sendFriendReq()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-add-friend')">Close</button>
        <button class="btn-a" onclick="sendFriendReq()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-join-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="join-bastion-body"></div>
  </div>
</div>

<div class="modal-overlay" id="modal-buy">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="buy-title">Activate Radiance?</div>
      <div class="modal-sub" id="buy-sub">This will deduct Onyx from your balance.</div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-buy')">Cancel</button>
        <button class="btn-a" onclick="confirmBuy()">✨ Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-user">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="user-modal-body"></div>
  </div>
</div>

<!-- Leave/Delete Bastion Modal -->
<div class="modal-overlay" id="modal-leave-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="leave-bastion-body"></div>
  </div>
</div>

<!-- Role Editor Modal -->
<div class="modal-overlay" id="modal-role-editor">
  <div class="modal wide tall">
    <div class="modal-bar"></div>
    <div class="modal-body" id="role-editor-body"></div>
  </div>
</div>

<!-- Member Manage Modal -->
<div class="modal-overlay" id="modal-member-manage">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="member-manage-body"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="ctx-menu" style="display:none;"></div>

<script>
// ═══════════════ STATE ═══════════════
let CU=null,curView='home',curDM=null,curBastion=null,curChannel=null;
let memberListOpen=false,notifPanelOpen=false,pendingBuy=null,discTab='all',profileTab='myprofile';
let curBSettingsTab='overview';
let _pendingEmblemData=null;

const EMOJIS=['🏰','⚔️','🛡','🏹','🗡️','🔥','⚡','🌌','🎮','🎯','💀','🐉','🌙','🌟','🎪','🔮','🌊','🦅'];
const TAG_COLORS=['#f59e0b','#3ecf6e','#60a5fa','#f87171','#a78bfa','#fb923c','#34d399','#f472b6','#fff93e','#94a3b8'];
const QUICK_REACT=['👍','❤️','😂','😮','🔥','✅'];
const ROLE_COLORS=['#f87171','#fb923c','#f59e0b','#a3e635','#3ecf6e','#22d3ee','#60a5fa','#a78bfa','#f472b6','#fff93e','#94a3b8','#e2e8f0'];

// All owner permissions
const OWNER_PERMS=['create_channels','delete_channels','create_categories','manage_roles','assign_roles','delete_roles',
  'transfer_ownership','delete_bastion','change_bastion_name','change_bastion_icon','set_bastion_banner',
  'manage_emojis','manage_stickers','manage_soundboard','create_webhooks','manage_webhooks','view_audit_logs',
  'ban_members','kick_members','timeout_members','mute_members','deafen_members','move_members','create_invites',
  'manage_invites','create_events','manage_events','enable_community','setup_onboarding','view_insights',
  'set_region','configure_automod','set_notifications','create_templates','bypass_permissions'];

// Member permissions
const MEMBER_PERMS=['view_channels','send_messages','send_thread_messages','create_public_threads','create_private_threads',
  'embed_links','attach_files','add_reactions','use_external_emojis','use_external_stickers','mention_everyone',
  'mention_here','mention_roles','read_history','send_tts','use_slash_commands','use_activities',
  'connect_voice','speak_voice','stream_video','share_screen','voice_activity','push_to_talk',
  'use_soundboard','use_external_sounds','set_voice_status','change_nickname','create_invites_member',
  'join_events','vote_polls','customize_profile','set_custom_status'];

const PERM_LABELS={
  create_channels:'Create Channels',delete_channels:'Delete Channels',create_categories:'Create Categories',
  manage_roles:'Manage Roles',assign_roles:'Assign Roles',delete_roles:'Delete Roles',
  transfer_ownership:'Transfer Ownership',delete_bastion:'Delete Bastion',change_bastion_name:'Change Bastion Name',
  change_bastion_icon:'Change Bastion Icon',set_bastion_banner:'Set Bastion Banner',manage_emojis:'Manage Emojis',
  manage_stickers:'Manage Stickers',manage_soundboard:'Manage Soundboard',create_webhooks:'Create Webhooks',
  manage_webhooks:'Manage Webhooks',view_audit_logs:'View Audit Logs',ban_members:'Ban Members',
  kick_members:'Kick Members',timeout_members:'Timeout Members',mute_members:'Mute Members',
  deafen_members:'Deafen Members',move_members:'Move Members',create_invites:'Create Invites',
  manage_invites:'Manage Invites',create_events:'Create Events',manage_events:'Manage Events',
  enable_community:'Enable Community Features',setup_onboarding:'Set Up Onboarding',view_insights:'View Server Insights',
  set_region:'Set Server Region',configure_automod:'Configure AutoMod',set_notifications:'Set Message Notifications',
  create_templates:'Create Server Templates',bypass_permissions:'Bypass All Permissions',
  view_channels:'View Channels',send_messages:'Send Messages',send_thread_messages:'Send Messages in Threads',
  create_public_threads:'Create Public Threads',create_private_threads:'Create Private Threads',
  embed_links:'Embed Links',attach_files:'Attach Files',add_reactions:'Add Reactions',
  use_external_emojis:'Use External Emojis',use_external_stickers:'Use External Stickers',
  mention_everyone:'Mention @everyone',mention_here:'Mention @here',mention_roles:'Mention Roles',
  read_history:'Read Message History',send_tts:'Send Text-to-Speech Messages',use_slash_commands:'Use Slash Commands',
  use_activities:'Use Activities',connect_voice:'Connect to Voice',speak_voice:'Speak in Voice',
  stream_video:'Stream Video',share_screen:'Share Screen',voice_activity:'Use Voice Activity',
  push_to_talk:'Use Push to Talk',use_soundboard:'Use Soundboard',use_external_sounds:'Use External Sounds',
  set_voice_status:'Set Voice Status',change_nickname:'Change Own Nickname',create_invites_member:'Create Invites',
  join_events:'Join Events',vote_polls:'Vote in Polls',customize_profile:'Customize Per-Server Profile',
  set_custom_status:'Set Custom Status'
};

const PUBLIC_BASTIONS=[
  {id:'warfront',icon:'⚔️',name:'Warfront Elite',desc:'Competitive FPS & strategy. Weekly tournaments.',members:1842,online:234,category:'competitive',tags:['FPS','Ranked'],tag:'WAR',tagColor:'#f87171'},
  {id:'dragonrealm',icon:'🐉',name:'Dragon Realm',desc:'Fantasy RPG & tabletop. D&D, Pathfinder and more.',members:932,online:87,category:'roleplay',tags:['RPG','D&D'],tag:'DRG',tagColor:'#a78bfa'},
  {id:'casualcrew',icon:'🎮',name:'Casual Crew',desc:'Laid-back gamers who just want to chill.',members:3201,online:418,category:'casual',tags:['Chill','Multi-game'],tag:'CCW',tagColor:'#3ecf6e'},
  {id:'voidrunners',icon:'🌌',name:'Void Runners',desc:'Sci-fi, space sims, Star Citizen, Elite Dangerous.',members:671,online:55,category:'gaming',tags:['Sci-Fi','Space'],tag:'VDR',tagColor:'#60a5fa'},
  {id:'sniperguild',icon:'🎯',name:'Sniper Guild',desc:'Precision shooters. Weekly coaching sessions.',members:2156,online:310,category:'competitive',tags:['Shooter','Coaching'],tag:'SNG',tagColor:'#f59e0b'},
  {id:'blazebastions',icon:'🔥',name:'Blaze Bastions',desc:'The hottest new community on the platform.',members:489,online:102,category:'gaming',tags:['Hot','New'],tag:'BLZ',tagColor:'#fb923c'},
  {id:'memelords',icon:'🎪',name:'Meme Lords',desc:'Gaming memes, clips, and dumb moments.',members:5480,online:623,category:'casual',tags:['Memes','Clips'],tag:'MML',tagColor:'#f472b6'},
  {id:'arcanecouncil',icon:'🔮',name:'Arcane Council',desc:'Strategy, deckbuilders, and puzzle games.',members:811,online:77,category:'gaming',tags:['Strategy','Puzzle'],tag:'ARC',tagColor:'#22d3ee'},
];

const BLOG_POSTS=[
  {tag:'Update',title:'Bastions 2.0 — Channels, Roles & More',date:'Feb 14, 2025'},
  {tag:'Feature',title:'Atelier Store is Now Live',date:'Jan 28, 2025'},
  {tag:'Community',title:'February Onyx Giveaway Results',date:'Jan 20, 2025'},
  {tag:'Notice',title:'Terms of Service Update',date:'Jan 5, 2025'},
];

// ═══════════════ INIT ═══════════════
window.addEventListener('DOMContentLoaded',()=>{
  // Migrate old storage
  const oldUsers=localStorage.getItem('fortized_users');
  if(oldUsers&&!localStorage.getItem('ftz_users')){
    try{const p=JSON.parse(oldUsers);if(Array.isArray(p)&&p.length){localStorage.setItem('ftz_users',oldUsers);const oc=localStorage.getItem('fortized_current_user');if(oc)localStorage.setItem('ftz_current',oc);}}catch(e){}
  }
  const username=localStorage.getItem('ftz_current')||localStorage.getItem('fortized_current_user');
  if(!username){window.location.href='login.html';return;}
  const users=FortizedSocial.getUsers();
  CU=users.find(u=>u.username===username);
  if(!CU){window.location.href='login.html';return;}
  ['bastions','friends','friendRequestsSent','friendRequestsReceived','notifications'].forEach(k=>{if(!Array.isArray(CU[k]))CU[k]=[];});
  if(typeof CU.onyx!=='number')CU.onyx=25;
  if(!CU.status)CU.status='online';
  if(!CU.displayName)CU.displayName=CU.username;
  saveUser();FortizedSocial.setStatus(CU.username,CU.status);
  buildUI();navigate('home');
  FortizedSocial.startPolling(CU.username,{
    onNewNotification:(n)=>{refreshCU();updateNotifBadge();if(n.type==='friend_request')toast(`👥 Friend request from ${n.from}!`,'info');else if(n.type==='friend_accept'){toast(`🤝 ${n.from} accepted your request!`,'success');refreshCU();}else if(n.type==='dm')toast(`💬 ${n.from}: ${(n.data?.preview||'').slice(0,30)}`,'info');if(notifPanelOpen)buildNotifList();if(curView==='home')refreshHomeRight();FortizedSocial.playNotificationSound();},
    onBastionMsg:(data)=>{if(curView==='bastion'&&curBastion!==null)renderChannelMessages(curBastion,curChannel);}
  });
  setInterval(()=>{refreshCU();updateNotifBadge();if(curView==='home')refreshHomeRight();},3000);
  document.addEventListener('click',()=>document.getElementById('ctx-menu').style.display='none');
  document.addEventListener('click',e=>{const panel=document.getElementById('notif-panel');const bell=document.getElementById('rail-notif');if(!panel.contains(e.target)&&!bell.contains(e.target)){panel.classList.remove('open');notifPanelOpen=false;}});
});

function saveUser(){FortizedSocial.saveUserObject(CU);}
function refreshCU(){const fresh=FortizedSocial.getUserByName(CU.username);if(!fresh)return;Object.assign(CU,fresh);updateOnyxDisplay();}

// ═══════════════ UI BUILDERS ═══════════════
function buildUI(){
  updateAvatarEl(document.getElementById('ua'),CU);
  document.getElementById('ua-name').textContent=CU.displayName||CU.username;
  updateOnyxDisplay();updateNotifBadge();buildRailBastions();buildDiscoverGrid();buildEmojiPicker();buildColorPicker();updateDailyBtn();
}

function buildAvatar(user,size=30){
  const div=document.createElement('div');div.className='fa';div.style.width=size+'px';div.style.height=size+'px';div.style.fontSize=Math.floor(size*.4)+'px';
  if(user.pfp){const img=document.createElement('img');img.src=user.pfp;img.onerror=()=>{img.remove();div.textContent=(user.displayName||user.username||'?')[0].toUpperCase();};div.appendChild(img);}
  else div.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  const status=FortizedSocial.getStatus(user.username);const dot=document.createElement('div');dot.className=`fs ${status}`;div.appendChild(dot);
  return div;
}

function updateAvatarEl(el,user){
  if(!el)return;const ring=el.querySelector('.ua-ring');el.innerHTML='';
  if(user.pfp){const img=document.createElement('img');img.src=user.pfp;img.onerror=()=>{img.remove();el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();if(ring)el.appendChild(ring);};el.appendChild(img);}
  else el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  if(ring)el.appendChild(ring);
}

function updateOnyxDisplay(){
  document.getElementById('topbar-onyx').textContent=CU.onyx;
  const ab=document.getElementById('atelier-balance');if(ab)ab.textContent=CU.onyx;
}
function updateNotifBadge(){const count=FortizedSocial.getUnreadCount(CU.username);const b=document.getElementById('notif-badge');b.style.display=count>0?'flex':'none';b.textContent=count>9?'9+':count;}

function buildRailBastions(){
  const c=document.getElementById('rail-bastions');c.innerHTML='';
  CU.bastions.forEach((b,i)=>{
    const el=document.createElement('div');
    el.className='rail-bastion'+(curBastion===i?' active':'');
    el.id='rb-'+i;el.setAttribute('data-tip',b.name);
    if(b.emblem){const img=document.createElement('img');img.src=b.emblem;img.onerror=()=>{img.remove();el.textContent=b.icon||'🏰';};el.appendChild(img);}
    else el.textContent=b.icon||'🏰';
    el.onclick=()=>openBastion(i);
    c.appendChild(el);
  });
}

// ═══════════════ NAVIGATE ═══════════════
function navigate(view){
  ['home','bastion','discover','atelier','profile','bsettings'].forEach(v=>{
    const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}
  });
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b=>b.classList.remove('active'));
  document.getElementById('member-list-btn').style.display='none';
  document.getElementById('bastion-settings-btn').style.display='none';
  document.getElementById('boost-bar-wrap').style.display='none';
  const rb=document.getElementById('rail-'+view);if(rb)rb.classList.add('active');
  curView=view;
  const el=document.getElementById('view-'+view);if(el){el.style.display='flex';el.classList.add('active');}
  if(view==='home'){setTopbar('🏰','Home','Your fortress hub');setSidebar('home');renderHomeLanding();refreshHomeRight();}
  else if(view==='discover'){setTopbar('🧭','Discover','Find and join public Bastions');setSidebar('discover');}
  else if(view==='atelier'){setTopbar('💎','Atelier','Spend Onyx on Radiance and cosmetics');setSidebar('atelier');updateOnyxDisplay();updateDailyBtn();}
  else if(view==='profile'){setTopbar('⚙️','Settings','Manage your account');setSidebar('profile');buildProfileView('myprofile');}
}

function setTopbar(icon,title,desc){
  document.getElementById('topbar-title').innerHTML=`<span>${icon}</span><span>${title}</span>`;
  document.getElementById('topbar-desc').textContent=desc;
}

// ═══════════════ SIDEBAR ═══════════════
function setSidebar(ctx){
  const scroll=document.getElementById('sidebar-scroll');const title=document.getElementById('sidebar-title');const actions=document.getElementById('sidebar-actions');
  scroll.innerHTML='';actions.innerHTML='';
  if(ctx==='home'){
    title.textContent='Fortized';
    scroll.appendChild(makeSLabel('Direct Messages',`<button onclick="openNewDM()" title="New DM">+</button>`));
    buildDMItems(scroll);
  }else if(ctx==='discover'){title.textContent='Discover';}
  else if(ctx==='atelier'){title.textContent='Atelier';}
  else if(ctx==='profile'){title.textContent='Settings';}
  else if(ctx==='bastion'&&curBastion!==null){
    const b=CU.bastions[curBastion];title.textContent=b.name;
    const isOwner=b.owner===CU.username;
    if(isOwner)actions.innerHTML=`<button onclick="openBastionSettings()" title="Settings">⚙️</button>`;
    document.getElementById('boost-bar-wrap').style.display='block';
    // Update boost label
    const bl=document.getElementById('boost-label');const bsl=document.getElementById('boost-sublabel');
    const level=b.boostLevel||0;
    if(bl)bl.textContent='Boost Bastion';
    if(bsl)bsl.textContent=`Level ${level}`;
    buildChannelList(scroll,b,curBastion);
  }
}

function buildChannelList(container,b,bIdx){
  const catEl=document.createElement('div');catEl.className='cat-row';
  const isOwner=b.owner===CU.username;
  catEl.innerHTML=`<span style="font-size:9px;margin-right:2px;">▾</span><span>Text Channels</span>${isOwner?`<button onclick="event.stopPropagation();addChannel(${bIdx})">+</button>`:''}`;
  container.appendChild(catEl);
  (b.channels||[]).forEach((ch,ci)=>{
    const el=document.createElement('div');el.className='ch-item'+(curChannel===ci?' active':'');
    el.innerHTML=`<span style="font-size:12px;color:var(--muted);">#</span><span style="flex:1;">${ch.name}</span>`;
    el.onclick=()=>openChannel(bIdx,ci);
    if(isOwner)el.oncontextmenu=e=>{e.preventDefault();showCtxMenu(e.clientX,e.clientY,[{label:`# ${ch.name}`,section:true},{sep:true},{icon:'🗑️',label:'Delete Channel',action:()=>deleteChannel(bIdx,ci),danger:true}]);};
    container.appendChild(el);
  });
  const vCat=document.createElement('div');vCat.className='cat-row';vCat.innerHTML=`<span style="font-size:9px;">▾</span><span>Voice Channels</span>`;
  container.appendChild(vCat);
  const vc=document.createElement('div');vc.className='ch-item';vc.innerHTML=`<span>🔊</span><span style="flex:1;">General</span>`;
  vc.onclick=()=>toast('Voice channels coming soon','info');container.appendChild(vc);
}

function makeSItem(icon,label,badge=''){const el=document.createElement('div');el.className='s-item';el.innerHTML=`<div class="s-icon"><span>${icon}</span></div><span class="s-name">${label}</span>${badge?`<span style="background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:1px 6px;border-radius:100px;">${badge}</span>`:''}`;return el;}
function makeSLabel(text,extraHTML=''){const el=document.createElement('div');el.className='sec-label';el.innerHTML=`<span>${text}</span>${extraHTML}`;return el;}

function buildDMItems(container){
  const partners=FortizedSocial.getRecentDMPartners(CU.username);
  if(!partners.length){const e=document.createElement('div');e.style.cssText='padding:10px 14px;font-size:12.5px;color:var(--muted);';e.textContent='No DMs yet.';container.appendChild(e);return;}
  partners.forEach(partner=>{
    const msgs=FortizedSocial.getDMMessages(CU.username,partner);const last=msgs[msgs.length-1];
    const pUser=FortizedSocial.getUserByName(partner)||{username:partner};
    const el=document.createElement('div');el.className='friend-item'+(curDM===partner?' active':'');
    const av=buildAvatar(pUser,30);el.appendChild(av);
    const info=document.createElement('div');info.className='fi-info';
    info.innerHTML=`<div class="fi-name">${escapeHTML(pUser.displayName||partner)}</div><div class="fi-sub">${last?escapeHTML(last.text.slice(0,26))+'…':'No messages yet'}</div>`;
    el.appendChild(info);el.onclick=()=>openDMChat(partner);container.appendChild(el);
  });
}

// ═══════════════ HOME ═══════════════
function renderHomeLanding(){
  const area=document.getElementById('home-content');if(!area)return;
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
  const pending=(CU.friendRequestsReceived||[]).length;
  const displayName=escapeHTML(CU.displayName||CU.username);
  area.innerHTML=`
    <div class="home-hero">
      <div class="hero-left-content">
        <div class="hero-tag-app"><span class="hero-tag-dot"></span>Welcome Back${hasRadiance?' · ✨ Radiance Active':''}</div>
        <h1>Welcome,<br><em>${displayName}.</em></h1>
        <p class="hero-sub-app">Ready to storm the fortress? Jump into your Bastions, rally your allies, and conquer together.</p>
        <div class="home-hero-actions">
          ${CU.bastions.length>0?`<button class="btn-a" onclick="openBastion(0)">⚔️ Open Bastion</button>`:`<button class="btn-a" onclick="openCreateBastion()">🏰 Create Bastion</button>`}
          <button class="btn-g" onclick="navigate('discover')">🧭 Discover</button>
          <button class="btn-g" onclick="renderFriends()">👥 Friends${pending>0?` <span style="background:var(--red);color:#fff;font-size:9px;padding:1px 5px;border-radius:100px;margin-left:2px;">${pending}</span>`:''}</button>
        </div>
      </div>
      <div class="home-hero-knight"><img src="Fortized Knight.png" onerror="this.style.display='none'" alt=""></div>
    </div>
    <div class="home-marquee">
      <div class="marquee-track">
        ${['🎮 PLAY — Amplify your sessions','🏰 HANGOUT — Enter the Fortress','⚒️ CREATE — Forge your Bastions','📡 SHARE — Broadcast your moment','⚔️ CONQUER — Rally your allies','🗺️ EXPLORE — Discover new Bastions'].map(t=>{const[icon,...rest]=t.split(' ');const[word,...desc]=rest;return`<div class="marquee-item"><span class="mi-icon">${icon}</span><span class="mi-label"><span class="mi-accent">${word}</span> ${desc.join(' ')}</span></div>`;}).join('')}
        ${['🎮 PLAY — Amplify your sessions','🏰 HANGOUT — Enter the Fortress','⚒️ CREATE — Forge your Bastions','📡 SHARE — Broadcast your moment','⚔️ CONQUER — Rally your allies','🗺️ EXPLORE — Discover new Bastions'].map(t=>{const[icon,...rest]=t.split(' ');const[word,...desc]=rest;return`<div class="marquee-item"><span class="mi-icon">${icon}</span><span class="mi-label"><span class="mi-accent">${word}</span> ${desc.join(' ')}</span></div>`;}).join('')}
      </div>
    </div>
    <div class="home-main-scroll">
      <div class="section-hdr"><h3>Quick Access</h3></div>
      <div class="quick-nav">
        <div class="qn-tile" onclick="navigate('discover')"><div class="qn-icon" style="background:rgba(255,249,62,.08);border:1px solid rgba(255,249,62,.14);">🧭</div><div class="qn-text"><h4>Discover</h4><p>Find new Bastions</p></div></div>
        <div class="qn-tile" onclick="renderFriends()"><div class="qn-icon" style="background:rgba(62,207,110,.1);border:1px solid rgba(62,207,110,.18);">👥</div><div class="qn-text"><h4>Friends</h4><p>${(CU.friends||[]).length} connected</p></div>${pending>0?`<div class="qn-badge">${pending}</div>`:''}</div>
        <div class="qn-tile" onclick="navigate('atelier')"><div class="qn-icon" style="background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);">💎</div><div class="qn-text"><h4>Atelier</h4><p>${CU.onyx} Onyx</p></div></div>
        <div class="qn-tile" onclick="openNewDM()"><div class="qn-icon" style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.18);">💬</div><div class="qn-text"><h4>New DM</h4><p>Message someone</p></div></div>
      </div>
      <div class="section-hdr" style="margin-top:4px;"><h3>Your Bastions</h3></div>
      <div class="activity-feed">
        ${CU.bastions.length===0
          ?`<div class="activity-item"><div class="act-icon">🏰</div><div class="act-text"><p>No Bastions yet. <strong onclick="navigate('discover')" style="color:var(--accent);cursor:pointer;">Discover communities</strong> or create your own.</p><div class="act-time">Get started</div></div></div>`
          :CU.bastions.slice(0,5).map((b,i)=>{
            const iconHtml=b.emblem?`<img src="${b.emblem}" onerror="this.outerHTML='${b.icon||'🏰'}'">`:b.icon||'🏰';
            return`<div class="activity-item" onclick="openBastion(${i})">
              <div class="act-icon">${typeof iconHtml==='string'&&iconHtml.startsWith('<img')?iconHtml:iconHtml}</div>
              <div class="act-text"><p><strong>${escapeHTML(b.name)}</strong>${b.bastionTag?` <span class="bastion-tag" style="color:${b.tagColor||'var(--accent)'};border-color:${b.tagColor||'var(--accent)'}44;">${escapeHTML(b.bastionTag)}</span>`:''}</p>
              <div class="act-time">#${b.channels?.[0]?.name||'general'}</div></div>
              <span style="font-size:12px;color:var(--muted);">→</span>
            </div>`;}).join('')}
      </div>
      <div class="section-hdr" style="margin-top:4px;"><h3>Trending Bastions</h3><a onclick="navigate('discover')">See all →</a></div>
      <div class="mini-bastion-row">
        ${PUBLIC_BASTIONS.slice(0,4).map(b=>{
          const alreadyJoined=CU.bastions.find(x=>x.publicId===b.id||x.name===b.name);
          return`<div class="mini-bastion">
            <div class="mb-icon">${b.icon}</div>
            <div class="mb-info"><div class="mb-name">${b.name}${b.tag?` <span class="bastion-tag" style="color:${b.tagColor};border-color:${b.tagColor}44;">${b.tag}</span>`:''}</div>
            <div class="mb-meta">👥 ${b.members.toLocaleString()} · <span style="color:var(--green);">● ${b.online} online</span></div></div>
            ${alreadyJoined
              ?`<div class="mb-join" style="background:var(--panel2);border-color:var(--border);color:var(--muted-light);" onclick="openBastion(${CU.bastions.indexOf(alreadyJoined)})">✓ Open</div>`
              :`<div class="mb-join" onclick="promptJoinPublicBastion('${b.id}')">Join →</div>`}
          </div>`;}).join('')}
      </div>
    </div>`;
}

function refreshHomeRight(){
  const panel=document.getElementById('home-right');if(!panel)return;
  const notifs=FortizedSocial.getNotifications(CU.username).slice(0,6);
  let html=`<div class="rp-section"><div class="rp-title">Notifications</div>`;
  if(!notifs.length)html+=`<div style="font-size:12.5px;color:var(--muted);padding:4px 0;">All caught up ✓</div>`;
  else notifs.forEach(n=>{
    let icon='🔔',text='';
    if(n.type==='friend_request'){icon='👥';text=`<strong>${escapeHTML(n.from)}</strong> sent a friend request`;}
    else if(n.type==='friend_accept'){icon='🤝';text=`<strong>${escapeHTML(n.from)}</strong> accepted your request`;}
    else if(n.type==='dm'){icon='💬';text=`<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview||'').slice(0,40))}`;}
    const actions=n.type==='friend_request'?`<div class="rn-actions"><button class="rn-accept" onclick="acceptFriend('${n.from}')">Accept</button><button class="rn-decline" onclick="declineFriend('${n.from}')">Decline</button></div>`:'';
    html+=`<div class="rp-notif ${n.read?'':'unread'}"><div class="rn-icon">${icon}</div><div class="rn-text"><p>${text}</p><div class="rn-time">${formatTimeAgo(n.time)}</div>${actions}</div></div>`;
  });
  html+=`</div><div class="rp-section"><div class="rp-title">📰 Fortized Blog</div>`;
  BLOG_POSTS.forEach(p=>{html+=`<div class="blog-post" onclick="toast('Blog coming soon','info')"><div class="bp-tag">${p.tag}</div><div class="bp-title">${p.title}</div><div class="bp-date">${p.date}</div></div>`;});
  html+=`</div>`;panel.innerHTML=html;
}

// ═══════════════ FRIENDS ═══════════════
function renderFriends(){
  showHomeContent(`<div class="home-main-scroll">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Friends — ${(CU.friends||[]).length}</div>
      <button class="btn-a" onclick="openAddFriend()" style="font-size:13px;padding:9px 18px;">+ Add Friend</button>
    </div>
    ${!(CU.friends||[]).length?`<div class="empty-state"><div class="ei">👥</div><h3>No friends yet</h3><p>Add friends by username.</p><button class="btn-a" style="margin-top:8px;" onclick="openAddFriend()">Add a Friend</button></div>`
    :(CU.friends||[]).map(f=>{
      const fUser=FortizedSocial.getUserByName(f)||{username:f};
      const status=FortizedSocial.getStatus(f);
      const sColor={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)',offline:'var(--muted)',invisible:'var(--muted)'}[status]||'var(--muted)';
      return`<div style="display:flex;align-items:center;gap:13px;padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;">
        <div id="fav-${f}"></div>
        <div style="flex:1;"><div style="font-size:14px;font-weight:700;">${escapeHTML(fUser.displayName||f)}</div><div style="font-size:12px;color:${sColor};margin-top:1px;">● ${status}</div></div>
        <div style="display:flex;gap:7px;">
          <button class="btn-g" onclick="openDMChat('${f}')" style="font-size:12.5px;padding:7px 14px;">💬 Message</button>
          <button class="btn-d" onclick="removeFriend('${f}')" style="font-size:12.5px;padding:7px 10px;">✕</button>
        </div>
      </div>`;}).join('')}
  </div>`);
  setTimeout(()=>{(CU.friends||[]).forEach(f=>{const c=document.getElementById('fav-'+f);if(!c)return;const fUser=FortizedSocial.getUserByName(f)||{username:f};c.appendChild(buildAvatar(fUser,40));});},0);
}

function showHomeContent(html){const c=document.getElementById('home-content');if(c)c.innerHTML=html;}
function openAddFriend(){document.getElementById('af-input').value='';document.getElementById('af-error').textContent='';document.getElementById('af-success').textContent='';openModal('modal-add-friend');}
function sendFriendReq(){
  const name=document.getElementById('af-input').value.trim();document.getElementById('af-error').textContent='';document.getElementById('af-success').textContent='';
  if(!name){document.getElementById('af-error').textContent='Enter a username.';return;}
  const result=FortizedSocial.sendFriendRequest(CU.username,name);
  if(result.ok){document.getElementById('af-success').textContent=result.msg;document.getElementById('af-input').value='';refreshCU();FortizedSocial.playNotificationSound();}
  else document.getElementById('af-error').textContent=result.msg;
}
function acceptFriend(from){const r=FortizedSocial.acceptFriendRequest(CU.username,from);if(r.ok){refreshCU();toast(r.msg,'success');FortizedSocial.playNotificationSound();if(curView==='home')refreshHomeRight();}else toast(r.msg,'error');}
function declineFriend(from){FortizedSocial.declineFriendRequest(CU.username,from);refreshCU();toast('Request declined','info');if(curView==='home')refreshHomeRight();}
function removeFriend(f){if(!confirm(`Remove ${f}?`))return;FortizedSocial.removeFriend(CU.username,f);refreshCU();toast('Friend removed','info');renderFriends();}
function quickAddFriend(username){const r=FortizedSocial.sendFriendRequest(CU.username,username);toast(r.msg,r.ok?'success':'error');if(r.ok){refreshCU();FortizedSocial.playNotificationSound();}viewUserProfile(username);}

// ═══════════════ DM ═══════════════
function openNewDM(){document.getElementById('dm-username-input').value='';document.getElementById('dm-error').textContent='';openModal('modal-new-dm');}
function startDM(){
  const name=document.getElementById('dm-username-input').value.trim();
  if(!name){document.getElementById('dm-error').textContent='Enter a username.';return;}
  if(name===CU.username){document.getElementById('dm-error').textContent="Can't DM yourself!";return;}
  if(!FortizedSocial.getUserByName(name)){document.getElementById('dm-error').textContent='User not found.';return;}
  closeModal('modal-new-dm');if(curView!=='home'){navigate('home');setTimeout(()=>openDMChat(name),100);}else openDMChat(name);
}

function openDMChat(partner){
  curDM=partner;
  const pUser=FortizedSocial.getUserByName(partner)||{username:partner};
  const status=FortizedSocial.getStatus(partner);
  setTopbar('💬',escapeHTML(pUser.displayName||partner),`● ${status}`);
  if(curView==='home'){const scroll=document.getElementById('sidebar-scroll');if(scroll){scroll.innerHTML='';scroll.appendChild(makeSLabel('Direct Messages',`<button onclick="openNewDM()" title="New DM">+</button>`));buildDMItems(scroll);}}
  const msgs=FortizedSocial.getDMMessages(CU.username,partner);
  const area=document.getElementById('home-content');if(!area)return;
  area.innerHTML=`<div class="chat-wrap">
    <div class="chat-msgs" id="chat-msgs">
      <div class="chat-welcome">
        <div class="w-av" id="dm-welcome-av"></div>
        <h3>${escapeHTML(pUser.displayName||partner)}</h3>
        <p>Beginning of your DM history with <strong>${escapeHTML(partner)}</strong>.</p>
      </div>
      ${renderMsgsDiscord(msgs,'dm',null,partner)}
    </div>
    <div class="chat-input-wrap">
      <div class="chat-input-box">
        <div class="chat-input-actions">
          <button onclick="toast('File upload soon','info')">📎</button>
          <button onclick="toast('Emoji soon','info')">😊</button>
        </div>
        <textarea id="dm-input" placeholder="Message ${escapeHTML(pUser.displayName||partner)}" rows="1" onkeydown="dmKey(event,'${partner}')" oninput="autoResize(this)"></textarea>
        <button class="chat-send" onclick="sendDM('${partner}')">➤</button>
      </div>
    </div>
  </div>`;
  setTimeout(()=>{const wav=document.getElementById('dm-welcome-av');if(wav){const av=buildAvatar(pUser,60);av.style.borderRadius='50%';wav.replaceWith(av);}},0);
  scrollBottom('chat-msgs');
}

function sendDM(partner){
  const input=document.getElementById('dm-input');const text=input?.value.trim();if(!text)return;
  FortizedSocial.sendDMMessage(CU.username,partner,text);
  input.value='';input.style.height='';
  // APPEND new message instead of re-rendering all
  const msgs=FortizedSocial.getDMMessages(CU.username,partner);
  const msgsEl=document.getElementById('chat-msgs');
  if(msgsEl){
    // Remove previous empty state if any; just re-render messages after welcome
    const welcome=msgsEl.querySelector('.chat-welcome');
    const oldMsgs=msgsEl.querySelectorAll('.msg-row,.date-div');
    oldMsgs.forEach(e=>e.remove());
    msgsEl.insertAdjacentHTML('beforeend',renderMsgsDiscord(msgs,'dm',null,partner));
    scrollBottom('chat-msgs');
  }
}

function dmKey(e,partner){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendDM(partner);}}

// ═══════════════ DISCORD-STYLE MESSAGES ═══════════════
function renderMsgsDiscord(msgs,mode,bastionIdx,channelOrPartner){
  if(!msgs||!msgs.length)return'';
  let html='';let lastDate='';let lastAuthor='';let lastTime=0;
  msgs.forEach((m,i)=>{
    const isOwn=m.from===CU.username;
    const mDate=m.timestamp?new Date(m.timestamp).toLocaleDateString():'';
    const mTs=m.timestamp?new Date(m.timestamp).getTime():0;
    if(mDate&&mDate!==lastDate){html+=`<div class="date-div">${mDate}</div>`;lastDate=mDate;}
    const isFirst=m.from!==lastAuthor||(mTs-lastTime)>300000; // 5 min gap = new group
    lastAuthor=m.from;lastTime=mTs;
    const senderUser=isOwn?CU:(FortizedSocial.getUserByName(m.from)||{username:m.from});
    const reactions=m.reactions||{};
    const rHTML=Object.entries(reactions).map(([emoji,users])=>{const mine=users.includes(CU.username);return`<div class="r-pill ${mine?'mine':''}" onclick="handleReaction('${m.id||''}','${emoji}','${bastionIdx||''}','${channelOrPartner||''}')" title="${users.slice(0,5).join(', ')}">${emoji} ${users.length}</div>`;}).join('');
    const reactBtns=QUICK_REACT.slice(0,4).map(e=>`<button title="${e}" onclick="handleReaction('${m.id||''}','${e}','${bastionIdx||''}','${channelOrPartner||''}')">${e}</button>`).join('');
    const timeStr=m.time||'';
    const timestampFull=m.timestamp?new Date(m.timestamp).toLocaleString():'';
    // Get bastion tag for this user
    let tagHTML='';
    if(mode==='bastion'&&bastionIdx!==null&&bastionIdx!==undefined){
      const b=CU.bastions[bastionIdx];
      if(b&&b.bastionTag){tagHTML=`<span class="msg-bastion-tag" style="color:${b.tagColor||'var(--accent)'};border-color:${b.tagColor||'var(--accent)'}44;">${escapeHTML(b.bastionTag)}</span>`;}
    }
    // Avatar html
    const avHtml=senderUser.pfp
      ?`<img src="${senderUser.pfp}" onerror="this.outerHTML='<span>${(senderUser.displayName||m.from)[0].toUpperCase()}</span>'">`
      :((senderUser.displayName||m.from||'?')[0].toUpperCase());
    html+=`<div class="msg-row ${isFirst?'msg-first':'msg-cont'} ${isOwn?'own':''}" data-id="${m.id||''}">
      <div class="msg-av-wrap">
        ${isFirst
          ?`<div class="msg-av-inner" onclick="viewUserProfile('${escapeHTML(m.from)}')">${avHtml}</div>`
          :`<span class="msg-time-small" title="${timestampFull}">${timeStr}</span>`}
      </div>
      <div class="msg-content-col">
        ${isFirst?`<div class="msg-header"><span class="msg-author" onclick="viewUserProfile('${escapeHTML(m.from)}')">${escapeHTML(senderUser.displayName||m.from)}</span>${tagHTML}<span class="msg-timestamp" title="${timestampFull}">Today at ${timeStr}</span></div>`:''}
        <div class="msg-text">${parseMD(escapeHTML(m.text))}</div>
        ${rHTML?`<div class="msg-reactions">${rHTML}</div>`:''}
      </div>
      <div class="msg-acts">${reactBtns}</div>
    </div>`;
  });
  return html;
}

function handleReaction(msgId,emoji,bastionIdx,channelOrPartner){
  if(bastionIdx&&bastionIdx!=='null'&&bastionIdx!==''){
    const b=CU.bastions[parseInt(bastionIdx)];
    const ch=b.channels[curChannel];const chId=ch.id||ch.name;
    const bastionId=getBastionId(parseInt(bastionIdx));
    FortizedSocial.addReaction(bastionId,chId,msgId,emoji,CU.username);
    renderChannelMessages(parseInt(bastionIdx),curChannel);
  }else{toast(emoji+' reaction!','info');}
}

// ═══════════════ BASTIONS ═══════════════
function getBastionId(bIdx){
  // Generate a stable ID for this bastion
  const b=CU.bastions[bIdx];
  if(b.publicId)return'pub_'+b.publicId;
  return`usr_${CU.username}_${bIdx}_${b.name}`.replace(/\s/g,'_');
}

function openBastion(idx){
  curBastion=idx;curChannel=null;memberListOpen=false;
  const b=CU.bastions[idx];
  if(!b.channels||!b.channels.length){b.channels=[{name:'general',id:'general'},{name:'announcements',id:'announcements'}];saveUser();}
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((el,i)=>el.classList.toggle('active',i===idx));
  ['home','discover','atelier','profile','bsettings'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  const bv=document.getElementById('view-bastion');bv.style.display='flex';bv.classList.add('active');
  curView='bastion';
  setSidebar('bastion');
  setTopbar('🏰',b.name,b.desc||`Welcome to ${b.name}`);
  document.getElementById('member-list-btn').style.display='flex';
  document.getElementById('bastion-settings-btn').style.display=b.owner===CU.username?'flex':'none';
  document.getElementById('member-list').style.display='none';
  memberListOpen=false;
  // Add self as member
  const bastionId=getBastionId(idx);
  FortizedSocial.addBastionMember(bastionId,CU.username);
  openChannel(idx,0);
}

function openChannel(bIdx,cIdx){
  curBastion=bIdx;curChannel=cIdx;
  const b=CU.bastions[bIdx];const ch=b.channels[cIdx];
  const chId=ch.id||ch.name;
  setTopbar('#',ch.name,`${b.name} › #${ch.name}`);
  document.querySelectorAll('.ch-item').forEach((el,i)=>el.classList.toggle('active',i===cIdx));
  const main=document.getElementById('bastion-main');
  const bastionId=getBastionId(bIdx);
  const msgs=FortizedSocial.getBastionChannelMessages(bastionId,chId);
  // Custom emojis bar
  const customEmojis=(b.customEmojis||[]);
  const emojiBarHTML=customEmojis.length?`<div class="custom-emoji-bar">${customEmojis.map((em,ei)=>`<button class="cem-btn" title=":${em.name}:" onclick="insertCustomEmoji('${em.name}')">${em.type==='img'?`<img src="${em.data}" title=":${em.name}:">`:em.char}</button>`).join('')}</div>`:'';
  main.innerHTML=`<div class="chat-wrap">
    <div class="chat-msgs" id="b-msgs">
      <div class="chat-welcome">
        <div class="w-av" style="border-radius:14px;font-size:18px;">#</div>
        <h3>#${ch.name}</h3>
        <p>Beginning of <strong>#${ch.name}</strong>. Say hello!</p>
      </div>
      ${renderMsgsDiscord(msgs,'bastion',bIdx,chId)}
    </div>
    <div class="chat-input-wrap">
      ${emojiBarHTML}
      <div class="chat-input-box">
        <div class="chat-input-actions">
          <button onclick="toast('File upload soon','info')">📎</button>
          <button onclick="toast('Emoji soon','info')">😊</button>
        </div>
        <textarea id="b-input" placeholder="Message #${ch.name}" rows="1" onkeydown="bKey(event,${bIdx},'${chId}')" oninput="autoResize(this)"></textarea>
        <button class="chat-send" onclick="sendBMsg(${bIdx},'${chId}')">➤</button>
      </div>
    </div>
  </div>`;
  scrollBottom('b-msgs');
  if(memberListOpen)buildMemberList(bIdx);
}

function renderChannelMessages(bIdx,cIdx){
  if(bIdx!==curBastion||cIdx!==curChannel)return;
  const b=CU.bastions[bIdx];const ch=b.channels[cIdx];const chId=ch.id||ch.name;
  const bastionId=getBastionId(bIdx);
  const msgs=FortizedSocial.getBastionChannelMessages(bastionId,chId);
  const msgsEl=document.getElementById('b-msgs');if(!msgsEl)return;
  const welcome=msgsEl.querySelector('.chat-welcome');
  const oldMsgs=msgsEl.querySelectorAll('.msg-row,.date-div');oldMsgs.forEach(e=>e.remove());
  msgsEl.insertAdjacentHTML('beforeend',renderMsgsDiscord(msgs,'bastion',bIdx,chId));
  scrollBottom('b-msgs');
}

function sendBMsg(bIdx,chId){
  const input=document.getElementById('b-input');const text=input?.value.trim();if(!text)return;
  const bastionId=getBastionId(bIdx);
  FortizedSocial.sendBastionChannelMessage(bastionId,chId,CU.username,text);
  input.value='';input.style.height='';
  // APPEND without full re-render
  const bastionMsgs=FortizedSocial.getBastionChannelMessages(bastionId,chId);
  const msgsEl=document.getElementById('b-msgs');
  if(msgsEl){
    const oldMsgs=msgsEl.querySelectorAll('.msg-row,.date-div');oldMsgs.forEach(e=>e.remove());
    msgsEl.insertAdjacentHTML('beforeend',renderMsgsDiscord(bastionMsgs,'bastion',bIdx,chId));
    scrollBottom('b-msgs');
  }
}
function bKey(e,bIdx,chId){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBMsg(bIdx,chId);}}

function insertCustomEmoji(name){
  const input=document.getElementById('b-input')||document.getElementById('dm-input');
  if(input){input.value+=`:${name}:`;input.focus();}
}

function addChannel(bIdx){
  const name=prompt('Channel name:');if(!name?.trim())return;
  const clean=name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  if(!clean){toast('Invalid name','error');return;}
  if(CU.bastions[bIdx].channels.find(c=>c.name===clean)){toast('Channel already exists','error');return;}
  CU.bastions[bIdx].channels.push({name:clean,id:clean});saveUser();setSidebar('bastion');toast('#'+clean+' created!','success');
}

function deleteChannel(bIdx,cIdx){
  if(CU.bastions[bIdx].channels.length<=1){toast("Can't delete the last channel",'error');return;}
  CU.bastions[bIdx].channels.splice(cIdx,1);saveUser();setSidebar('bastion');openChannel(bIdx,0);toast('Channel deleted','info');
}

function buildMemberList(bIdx){
  const el=document.getElementById('member-list');if(!el)return;
  const b=CU.bastions[bIdx];
  const bastionId=getBastionId(bIdx);
  const members=FortizedSocial.getBastionMembers(bastionId);
  if(!members.includes(CU.username))members.push(CU.username);
  const roles=b.roles||[];
  // Group by role
  let html=`<div class="ml-header">Members — ${members.length}</div>`;
  const roleMap={};
  members.forEach(m=>{
    const assigned=b.memberRoles?.[m];
    if(assigned&&roles.find(r=>r.id===assigned))roleMap[assigned]=roleMap[assigned]||[];
    if(assigned)roleMap[assigned].push(m);else{roleMap['__none__']=roleMap['__none__']||[];roleMap['__none__'].push(m);}
  });
  // Render by role
  roles.forEach(role=>{
    if(roleMap[role.id]&&roleMap[role.id].length){
      html+=`<div class="ml-header" style="margin-top:10px;color:${role.color||'var(--muted)'};">${escapeHTML(role.name)} — ${roleMap[role.id].length}</div>`;
      roleMap[role.id].forEach(m=>{html+=buildMlEntry(m,bIdx,role.color);});
    }
  });
  if(roleMap['__none__']&&roleMap['__none__'].length){
    html+=`<div class="ml-header" style="margin-top:10px;">Members — ${roleMap['__none__'].length}</div>`;
    roleMap['__none__'].forEach(m=>{html+=buildMlEntry(m,bIdx,null);});
  }
  el.innerHTML=html;
}

function buildMlEntry(m,bIdx,roleColor){
  const mUser=FortizedSocial.getUserByName(m)||{username:m};
  const status=FortizedSocial.getStatus(m);
  const b=CU.bastions[bIdx];
  const tag=b.bastionTag?`<div class="ml-role-badge" style="color:${b.tagColor||'var(--accent)'};border-color:${(b.tagColor||'var(--accent)')+'44'};">${escapeHTML(b.bastionTag)}</div>`:'';
  return`<div class="ml-entry" onclick="viewUserProfile('${m}')">
    <div class="ml-av">
      ${mUser.pfp?`<img src="${mUser.pfp}" onerror="this.textContent='${m[0].toUpperCase()}'">`:`<span>${m[0].toUpperCase()}</span>`}
      <div class="ml-status ${status}" style="background:${status==='online'?'var(--green)':status==='away'?'var(--yellow)':status==='dnd'?'var(--red)':'#374151'};"></div>
    </div>
    <div class="ml-info">
      <div class="ml-name" style="${roleColor?`color:${roleColor};`:''}">${escapeHTML(mUser.displayName||m)}${m===CU.username?' (you)':''}</div>
      ${tag}
    </div>
  </div>`;
}

function toggleMemberList(){
  memberListOpen=!memberListOpen;
  const el=document.getElementById('member-list');
  if(el){el.style.display=memberListOpen?'flex':'none';if(memberListOpen&&curBastion!==null)buildMemberList(curBastion);}
}

// ═══════════════ LEAVE / DELETE BASTION ═══════════════
function promptLeaveBastion(bIdx){
  const b=CU.bastions[bIdx];const isOwner=b.owner===CU.username;
  const body=document.getElementById('leave-bastion-body');
  body.innerHTML=`<div class="modal-title">${isOwner?'Delete':'Leave'} Bastion</div>
    <div class="modal-sub">${isOwner?`You are the owner of <strong>${escapeHTML(b.name)}</strong>. Deleting it will remove it permanently.`:`Leave <strong>${escapeHTML(b.name)}</strong>? You can rejoin later.`}</div>
    <div class="modal-actions">
      <button class="btn-g" onclick="closeModal('modal-leave-bastion')">Cancel</button>
      <button class="btn-d" onclick="${isOwner?`deleteBastion(${bIdx})`:`leaveBastion(${bIdx})`}">${isOwner?'🗑️ Delete':'🚪 Leave'}</button>
    </div>`;
  openModal('modal-leave-bastion');
}

function leaveBastion(bIdx){
  const b=CU.bastions[bIdx];
  const bastionId=getBastionId(bIdx);
  FortizedSocial.removeBastionMember(bastionId,CU.username);
  CU.bastions.splice(bIdx,1);saveUser();closeModal('modal-leave-bastion');
  buildRailBastions();navigate('home');toast(`Left ${b.name}`,'info');
}

function deleteBastion(bIdx){
  const b=CU.bastions[bIdx];
  CU.bastions.splice(bIdx,1);saveUser();closeModal('modal-leave-bastion');
  buildRailBastions();navigate('home');toast(`Deleted ${b.name}`,'info');
}

// ═══════════════ BASTION SETTINGS ═══════════════
function openBastionSettings(){
  if(curBastion===null)return;
  const b=CU.bastions[curBastion];
  if(b.owner!==CU.username){toast("Only the owner can access settings",'error');return;}
  ['home','bastion','discover','atelier','profile'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  const bsv=document.getElementById('view-bsettings');bsv.style.display='flex';bsv.classList.add('active');
  curView='bsettings';
  setTopbar('⚙️',b.name+' Settings','Manage your Bastion');
  buildBSettingsNav();loadBSettingsTab('overview');
}

function buildBSettingsNav(){
  const nav=document.getElementById('bsettings-nav');nav.innerHTML='';
  const sections=[
    {label:'Bastion',items:[
      {t:'overview',i:'🏰',l:'Overview'},
      {t:'roles',i:'🎭',l:'Roles'},
      {t:'emojis',i:'😄',l:'Custom Emojis'},
      {t:'channels_manage',i:'#',l:'Channels'},
      {t:'members',i:'👥',l:'Members'},
      {t:'audit',i:'📋',l:'Audit Log'},
    ]},
    {label:'Moderation',items:[
      {t:'bans',i:'🚫',l:'Bans'},
      {t:'automod',i:'🤖',l:'AutoMod'},
    ]},
    {label:'Community',items:[
      {t:'invites',i:'🔗',l:'Invites'},
      {t:'events',i:'📅',l:'Events'},
      {t:'insights',i:'📊',l:'Insights'},
    ]},
  ];
  sections.forEach(sec=>{
    const lbl=document.createElement('div');lbl.className='bsettings-nav-section';lbl.textContent=sec.label;nav.appendChild(lbl);
    sec.items.forEach(({t,i,l})=>{
      const el=document.createElement('div');el.className='bsettings-nav-item'+(curBSettingsTab===t?' active':'');
      el.innerHTML=`<span>${i}</span><span>${l}</span>`;el.onclick=()=>loadBSettingsTab(t);nav.appendChild(el);
    });
  });
  const spacer=document.createElement('div');spacer.style.flex='1';nav.appendChild(spacer);
  const back=document.createElement('div');back.className='bsettings-nav-item';
  back.innerHTML=`<span>←</span><span>Back to Bastion</span>`;back.onclick=()=>{openBastion(curBastion);};nav.appendChild(back);
  const del=document.createElement('div');del.className='bsettings-nav-item';del.style.color='var(--red)';
  del.innerHTML=`<span>🗑️</span><span>Delete Bastion</span>`;del.onclick=()=>promptLeaveBastion(curBastion);nav.appendChild(del);
}

function loadBSettingsTab(tab){
  curBSettingsTab=tab;
  document.querySelectorAll('.bsettings-nav-item').forEach(el=>{el.classList.toggle('active',el.textContent.trim().includes(getTabLabel(tab)));});
  buildBSettingsNav();
  const main=document.getElementById('bsettings-main');const b=CU.bastions[curBastion];
  if(tab==='overview'){
    const tagColor=b.tagColor||TAG_COLORS[0];
    main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Overview</div>
      <div class="boost-level-bar"><span class="bl-icon">⚡</span><div class="bl-info"><div class="bl-name">Boost Level ${b.boostLevel||0}</div><div class="bl-sub">${b.boostLevel>=3?'Max level reached!':`${(b.boostLevel||0)*2}/${(b.boostLevel||0)+1<3?((b.boostLevel||0)+1)*2:6} boosts to Level ${(b.boostLevel||0)+1}`}</div></div><div style="width:120px;"><div class="bl-prog"><div class="bl-fill" style="width:${Math.min(100,(b.boostLevel||0)*33.33)}%;"></div></div></div></div>
      <div class="settings-section">
        <div class="settings-title">Bastion Name</div>
        <input class="field-input" id="bs-name" value="${escapeHTML(b.name)}" maxlength="32" style="margin-bottom:8px;">
      </div>
      <div class="settings-section">
        <div class="settings-title">Description</div>
        <input class="field-input" id="bs-desc" value="${escapeHTML(b.desc||'')}" maxlength="100" style="margin-bottom:8px;" placeholder="Describe your Bastion…">
      </div>
      <div class="settings-section">
        <div class="settings-title">Bastion Tag <span style="color:var(--muted-light);font-weight:400;letter-spacing:0;text-transform:none;font-size:11px;">— shown next to usernames (max 5 chars)</span></div>
        <input class="field-input" id="bs-tag" value="${escapeHTML(b.bastionTag||'')}" maxlength="5" style="text-transform:uppercase;margin-bottom:8px;" placeholder="e.g. WAR">
        <div style="font-size:11px;color:var(--muted);margin-bottom:12px;">Preview: <span id="tag-preview" class="bastion-tag" style="color:${tagColor};border-color:${tagColor}44;">${escapeHTML(b.bastionTag||'TAG')}</span></div>
        <div class="settings-title" style="margin-top:4px;">Tag Color</div>
        <div class="color-swatches">${TAG_COLORS.map(c=>`<div class="color-swatch${c===tagColor?' sel':''}" style="background:${c};" onclick="selectTagColor('${c}')"></div>`).join('')}</div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Bastion Emblem</div>
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:8px;">
          <div id="bs-emblem-prev" style="width:64px;height:64px;border-radius:14px;background:var(--panel2);border:1.5px solid var(--border);font-size:28px;display:flex;align-items:center;justify-content:center;overflow:hidden;">${b.emblem?`<img src="${b.emblem}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`:(b.icon||'🏰')}</div>
          <div><label style="cursor:pointer;" class="btn-g">📷 Upload Emblem<input type="file" accept="image/*" style="display:none;" onchange="handleBastionEmblem(event)"></label>${b.emblem?`<button class="btn-d" onclick="removeBastionEmblem()" style="margin-left:8px;font-size:12px;padding:7px 12px;">Remove</button>`:''}</div>
        </div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Icon Emoji (fallback)</div>
        <div class="emoji-picker-wrap" id="bs-emoji-picker"></div>
      </div>
      <div style="display:flex;gap:9px;margin-top:4px;">
        <button class="btn-a" onclick="saveBastionOverview()">Save Changes</button>
        <button class="btn-g" onclick="openBastion(curBastion)">Cancel</button>
      </div>
      <div id="bs-msg" style="margin-top:10px;font-size:13px;min-height:18px;"></div>`;
    buildEmojiPickerIn('bs-emoji-picker',b.icon||'🏰');
    document.getElementById('bs-tag').addEventListener('input',e=>{const prev=document.getElementById('tag-preview');if(prev){prev.textContent=e.target.value.toUpperCase()||'TAG';}});
  }else if(tab==='roles'){buildRolesTab(main,b);}
  else if(tab==='emojis'){buildEmojisTab(main,b);}
  else if(tab==='channels_manage'){buildChannelsManageTab(main,b);}
  else if(tab==='members'){buildMembersManageTab(main,b);}
  else if(tab==='bans'){main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Bans</div><div class="empty-state"><div class="ei">🚫</div><h3>No bans</h3><p>Banned members will appear here.</p></div>`;}
  else if(tab==='audit'){buildAuditTab(main,b);}
  else{main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">${getTabLabel(tab)}</div><div class="empty-state"><div class="ei">🚧</div><h3>Coming Soon</h3><p>This section is under construction.</p></div>`;}
}

function getTabLabel(t){return{overview:'Overview',roles:'Roles',emojis:'Custom Emojis',channels_manage:'Channels',members:'Members',audit:'Audit Log',bans:'Bans',automod:'AutoMod',invites:'Invites',events:'Events',insights:'Insights'}[t]||t;}

function selectTagColor(color){
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('sel'));event.target.classList.add('sel');
  const prev=document.getElementById('tag-preview');if(prev){prev.style.color=color;prev.style.borderColor=color+'44';}
  CU.bastions[curBastion].tagColor=color;// preview only, save on "Save Changes"
}

function saveBastionOverview(){
  const b=CU.bastions[curBastion];
  b.name=document.getElementById('bs-name').value.trim()||b.name;
  b.desc=document.getElementById('bs-desc').value.trim();
  b.bastionTag=document.getElementById('bs-tag').value.trim().toUpperCase().slice(0,5)||'';
  const sel=document.querySelector('#bs-emoji-picker .emoji-opt.sel');if(sel)b.icon=sel.textContent;
  saveUser();buildRailBastions();setSidebar('bastion');setTopbar('⚙️',b.name+' Settings','Manage your Bastion');
  const msg=document.getElementById('bs-msg');if(msg)msg.innerHTML='<span style="color:var(--green);">✓ Saved!</span>';
  toast('Bastion updated!','success');
}

function handleBastionEmblem(e){
  const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}
  const reader=new FileReader();reader.onload=ev=>{
    const b=CU.bastions[curBastion];b.emblem=ev.target.result;saveUser();buildRailBastions();
    const prev=document.getElementById('bs-emblem-prev');if(prev)prev.innerHTML=`<img src="${b.emblem}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;
    toast('Emblem updated!','success');};reader.readAsDataURL(file);
}
function removeBastionEmblem(){const b=CU.bastions[curBastion];b.emblem=null;saveUser();buildRailBastions();loadBSettingsTab('overview');}

function buildRolesTab(main,b){
  if(!b.roles)b.roles=[];
  main.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
    <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">Roles</div>
    <button class="btn-a" onclick="createRole()" style="font-size:13px;padding:8px 16px;">+ Create Role</button>
  </div>
  <div id="roles-list"></div>`;
  renderRolesList();
}

function renderRolesList(){
  const b=CU.bastions[curBastion];const list=document.getElementById('roles-list');if(!list)return;
  if(!b.roles||!b.roles.length){list.innerHTML=`<div class="empty-state"><div class="ei">🎭</div><h3>No roles yet</h3><p>Create roles to organize your members and control permissions.</p></div>`;return;}
  list.innerHTML=b.roles.map((role,ri)=>`
    <div class="role-item" onclick="editRole(${ri})">
      <div class="role-dot" style="background:${role.color||'#fff'};"></div>
      <div class="role-name">${escapeHTML(role.name)}</div>
      <div class="role-count">${getMembersWithRole(b,role.id).length} members</div>
      <button class="btn-g" style="padding:5px 10px;font-size:12px;" onclick="event.stopPropagation();editRole(${ri})">Edit</button>
      <button class="btn-d" style="padding:5px 8px;font-size:12px;" onclick="event.stopPropagation();deleteRole(${ri})">✕</button>
    </div>`).join('');
}

function getMembersWithRole(b,roleId){
  const bastionId=getBastionId(curBastion);
  const members=FortizedSocial.getBastionMembers(bastionId);
  return members.filter(m=>(b.memberRoles||{})[m]===roleId);
}

function createRole(){
  const b=CU.bastions[curBastion];if(!b.roles)b.roles=[];
  const name=prompt('Role name:');if(!name?.trim())return;
  const id='role_'+Date.now().toString(36);
  b.roles.push({id,name:name.trim(),color:ROLE_COLORS[b.roles.length%ROLE_COLORS.length],permissions:[...MEMBER_PERMS]});
  saveUser();renderRolesList();toast(`Role "${name}" created!`,'success');
}

function deleteRole(ri){
  const b=CU.bastions[curBastion];const role=b.roles[ri];
  if(!confirm(`Delete role "${role.name}"?`))return;
  b.roles.splice(ri,1);saveUser();renderRolesList();toast('Role deleted','info');
}

function editRole(ri){
  const b=CU.bastions[curBastion];const role=b.roles[ri];
  const body=document.getElementById('role-editor-body');
  const allPerms=[...OWNER_PERMS,...MEMBER_PERMS];
  const isOwnerRole=ri===0&&role.name==='Owner';
  body.innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;">
    <div class="role-dot" style="width:20px;height:20px;background:${role.color};border-radius:50%;"></div>
    <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Edit: ${escapeHTML(role.name)}</div>
  </div>
  <div class="settings-section">
    <div class="settings-title">Role Name</div>
    <input class="field-input" id="re-name" value="${escapeHTML(role.name)}" maxlength="32" style="margin-bottom:8px;" ${isOwnerRole?'readonly':''}>
  </div>
  <div class="settings-section">
    <div class="settings-title">Color</div>
    <div class="color-swatches">${ROLE_COLORS.map(c=>`<div class="color-swatch${c===role.color?' sel':''}" style="background:${c};" onclick="selectRoleColor('${c}',${ri})"></div>`).join('')}</div>
  </div>
  <div class="settings-section">
    <div class="settings-title">Permissions <span style="color:var(--muted-light);font-weight:400;letter-spacing:0;text-transform:none;font-size:11px;">${isOwnerRole?'(Owner has all permissions)':''}</span></div>
    <div style="max-height:300px;overflow-y:auto;padding-right:8px;">
      ${allPerms.map(perm=>`<div class="perm-row">
        <div class="perm-info"><div class="perm-label">${PERM_LABELS[perm]||perm}</div></div>
        <div class="toggle ${(role.permissions||[]).includes(perm)||isOwnerRole?'on':''}" id="perm-${perm}" onclick="${isOwnerRole?'':''}" ${isOwnerRole?'style="opacity:.5;cursor:not-allowed;"':'onclick="togglePerm(this,\''+perm+'\','+ri+')"'}></div>
      </div>`).join('')}
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn-g" onclick="closeModal('modal-role-editor')">Cancel</button>
    <button class="btn-a" onclick="saveRole(${ri})">Save Role</button>
  </div>`;
  openModal('modal-role-editor');
}

function togglePerm(el,perm,ri){
  el.classList.toggle('on');
  const b=CU.bastions[curBastion];const role=b.roles[ri];
  if(!role.permissions)role.permissions=[];
  const idx=role.permissions.indexOf(perm);
  if(idx!==-1)role.permissions.splice(idx,1);else role.permissions.push(perm);
}

function selectRoleColor(color,ri){
  document.querySelectorAll('#role-editor-body .color-swatch').forEach(s=>s.classList.remove('sel'));event.target.classList.add('sel');
  const b=CU.bastions[curBastion];b.roles[ri].color=color;
  const dot=document.querySelector('#role-editor-body .role-dot');if(dot)dot.style.background=color;
}

function saveRole(ri){
  const b=CU.bastions[curBastion];
  const name=document.getElementById('re-name').value.trim();
  if(name)b.roles[ri].name=name;
  saveUser();closeModal('modal-role-editor');renderRolesList();toast('Role saved!','success');
}

function buildEmojisTab(main,b){
  const boostLevel=b.boostLevel||0;const maxEmojis=boostLevel>=3?35:boostLevel>=1?25:15;
  if(!b.customEmojis)b.customEmojis=[];
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:8px;">Custom Emojis</div>
    <div style="font-size:13px;color:var(--muted-light);margin-bottom:20px;">${b.customEmojis.length}/${maxEmojis} slots used · Boost Level ${boostLevel}${boostLevel<3?` · <span style="color:var(--accent);">Boost to Level ${boostLevel<1?1:3} for more slots</span>`:''}</div>
    <div style="margin-bottom:14px;">
      <button class="btn-a" onclick="uploadCustomEmoji()" ${b.customEmojis.length>=maxEmojis?'disabled style="opacity:.5;cursor:not-allowed;"':''} style="font-size:13px;padding:8px 16px;">+ Upload Emoji</button>
    </div>
    <div class="emoji-upload-grid" id="emoji-grid"></div>`;
  renderEmojiGrid();
}

function renderEmojiGrid(){
  const b=CU.bastions[curBastion];const grid=document.getElementById('emoji-grid');if(!grid)return;
  const boostLevel=b.boostLevel||0;const maxEmojis=boostLevel>=3?35:boostLevel>=1?25:15;
  let html=(b.customEmojis||[]).map((em,i)=>`
    <div class="emoji-slot filled" title=":${em.name}:">
      ${em.type==='img'?`<img src="${em.data}" alt="${em.name}">`:`<span style="font-size:22px;">${em.char}</span>`}
      <div class="es-del" onclick="deleteCustomEmoji(${i})">✕</div>
    </div>`).join('');
  for(let i=(b.customEmojis||[]).length;i<maxEmojis;i++){html+=`<div class="emoji-slot" onclick="uploadCustomEmoji()">+</div>`;}
  grid.innerHTML=html;
}

function uploadCustomEmoji(){
  const b=CU.bastions[curBastion];const boostLevel=b.boostLevel||0;const maxEmojis=boostLevel>=3?35:boostLevel>=1?25:15;
  if((b.customEmojis||[]).length>=maxEmojis){toast(`Max ${maxEmojis} emojis (Boost for more!)`,'error');return;}
  const name=prompt('Emoji name (no spaces):');if(!name?.trim())return;
  const cleanName=name.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');if(!cleanName){toast('Invalid name','error');return;}
  const input=document.createElement('input');input.type='file';input.accept='image/*';
  input.onchange=e=>{
    const file=e.target.files[0];if(!file)return;if(file.size>256*1024){toast('Max 256KB per emoji','error');return;}
    const reader=new FileReader();reader.onload=ev=>{
      if(!b.customEmojis)b.customEmojis=[];
      b.customEmojis.push({name:cleanName,type:'img',data:ev.target.result});
      saveUser();renderEmojiGrid();toast(`:${cleanName}: added!`,'success');
    };reader.readAsDataURL(file);
  };input.click();
}

function deleteCustomEmoji(i){
  const b=CU.bastions[curBastion];if(!confirm('Delete this emoji?'))return;
  b.customEmojis.splice(i,1);saveUser();renderEmojiGrid();toast('Emoji removed','info');
}

function buildChannelsManageTab(main,b){
  main.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;">
    <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">Channels</div>
    <button class="btn-a" onclick="addChannel(curBastion)" style="font-size:13px;padding:8px 16px;">+ Add Channel</button>
  </div>
  ${(b.channels||[]).map((ch,ci)=>`<div class="role-item">
    <span style="color:var(--muted);font-size:14px;">#</span>
    <div class="role-name">${escapeHTML(ch.name)}</div>
    <button class="btn-d" style="padding:5px 8px;font-size:12px;" onclick="deleteChannel(curBastion,${ci})">🗑️ Delete</button>
  </div>`).join('')}`;
}

function buildMembersManageTab(main,b){
  const bastionId=getBastionId(curBastion);
  const members=FortizedSocial.getBastionMembers(bastionId);
  if(!members.includes(CU.username))members.push(CU.username);
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Members — ${members.length}</div>
    ${members.map(m=>{
      const mUser=FortizedSocial.getUserByName(m)||{username:m};
      const status=FortizedSocial.getStatus(m);
      const isOwner=m===b.owner;
      const assignedRoleId=(b.memberRoles||{})[m];
      const assignedRole=b.roles?.find(r=>r.id===assignedRoleId);
      return`<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;">
        <div style="width:36px;height:36px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
          ${mUser.pfp?`<img src="${mUser.pfp}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;" onerror="this.outerHTML='${m[0].toUpperCase()}'">`:`${m[0].toUpperCase()}`}
        </div>
        <div style="flex:1;">
          <div style="font-size:13.5px;font-weight:700;">${escapeHTML(mUser.displayName||m)}${isOwner?' 👑':''}</div>
          <div style="font-size:11.5px;color:var(--muted);">${assignedRole?`<span style="color:${assignedRole.color};">● ${assignedRole.name}</span>`:'No role'}</div>
        </div>
        ${!isOwner?`<div style="display:flex;gap:6px;">
          <button class="btn-g" style="font-size:12px;padding:6px 10px;" onclick="assignRole('${m}')">Assign Role</button>
          <button class="btn-d" style="font-size:12px;padding:6px 8px;" onclick="kickMember('${m}')">Kick</button>
        </div>`:'<span style="font-size:12px;color:var(--accent);">Owner</span>'}
      </div>`;}).join('')}`;
}

function assignRole(username){
  const b=CU.bastions[curBastion];
  if(!b.roles||!b.roles.length){toast('No roles created yet','error');return;}
  const opts=['No role',...b.roles.map(r=>r.name)];
  const choice=prompt(`Assign role to ${username}:\n${opts.map((o,i)=>`${i}. ${o}`).join('\n')}\n\nEnter number:`);
  if(choice===null)return;const idx=parseInt(choice);
  if(isNaN(idx)||idx<0||idx>b.roles.length){toast('Invalid choice','error');return;}
  if(!b.memberRoles)b.memberRoles={};
  if(idx===0)delete b.memberRoles[username];else b.memberRoles[username]=b.roles[idx-1].id;
  saveUser();buildMembersManageTab(document.getElementById('bsettings-main'),b);toast('Role assigned!','success');
}

function kickMember(username){
  if(username===CU.username){toast("Can't kick yourself",'error');return;}
  if(!confirm(`Kick ${username}?`))return;
  const bastionId=getBastionId(curBastion);
  FortizedSocial.removeBastionMember(bastionId,username);
  const b=CU.bastions[curBastion];
  buildMembersManageTab(document.getElementById('bsettings-main'),b);toast(`${username} kicked`,'info');
}

function buildAuditTab(main,b){
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Audit Log</div>
    <div style="background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;">
      <div style="font-size:13px;color:var(--muted-light);">Audit logging tracks member actions in your Bastion. Full audit log coming in a future update.</div>
    </div>`;
}

function openBastionBoost(){
  const b=CU.bastions[curBastion];
  const level=b.boostLevel||0;
  if(level>=3){toast('Already at max boost level!','info');return;}
  const cost=[500,1000,2000][level];
  if(!confirm(`Boost ${b.name} to Level ${level+1}? Costs ${cost} Onyx.\nYou have ${CU.onyx} Onyx.`))return;
  if(CU.onyx<cost){toast('Not enough Onyx!','error');return;}
  CU.onyx-=cost;b.boostLevel=(b.boostLevel||0)+1;saveUser();updateOnyxDisplay();
  buildRailBastions();toast(`⚡ ${b.name} is now Level ${b.boostLevel}!`,'success');FortizedSocial.playNotificationSound();
  setSidebar('bastion');
}

// ═══════════════ CREATE BASTION ═══════════════
function buildEmojiPicker(){
  const p=document.getElementById('bastion-emoji-picker');if(!p)return;
  p.innerHTML='';EMOJIS.forEach(e=>{const btn=document.createElement('div');btn.className='emoji-opt';btn.textContent=e;btn.onclick=()=>{p.querySelectorAll('.emoji-opt').forEach(d=>d.classList.remove('sel'));btn.classList.add('sel');p.dataset.selected=e;};p.appendChild(btn);});
  p.dataset.selected=EMOJIS[0];p.querySelector('.emoji-opt').classList.add('sel');
}

function buildEmojiPickerIn(containerId,selectedEmoji){
  const p=document.getElementById(containerId);if(!p)return;
  p.innerHTML='';EMOJIS.forEach(e=>{const btn=document.createElement('div');btn.className='emoji-opt'+(e===selectedEmoji?' sel':'');btn.textContent=e;btn.onclick=()=>{p.querySelectorAll('.emoji-opt').forEach(d=>d.classList.remove('sel'));btn.classList.add('sel');p.dataset.selected=e;};p.appendChild(btn);});
  p.dataset.selected=selectedEmoji||EMOJIS[0];
}

function buildColorPicker(){
  const p=document.getElementById('bastion-color-picker');if(!p)return;
  p.innerHTML='';
  TAG_COLORS.forEach((c,i)=>{
    const s=document.createElement('div');s.className='color-swatch'+(i===0?' sel':'');s.style.background=c;s.title=c;
    s.onclick=()=>{p.querySelectorAll('.color-swatch').forEach(d=>d.classList.remove('sel'));s.classList.add('sel');p.dataset.selected=c;};
    p.appendChild(s);
  });
  p.dataset.selected=TAG_COLORS[0];
}

function handleEmblemUpload(e,previewId){
  const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}
  const reader=new FileReader();reader.onload=ev=>{
    _pendingEmblemData=ev.target.result;
    const prev=document.getElementById(previewId);if(prev)prev.innerHTML=`<img src="${ev.target.result}" style="width:48px;height:48px;object-fit:cover;border-radius:10px;">`;
  };reader.readAsDataURL(file);
}

function openCreateBastion(){
  document.getElementById('bastion-name-input').value='';document.getElementById('bastion-desc-input').value='';
  document.getElementById('bastion-tag-input').value='';document.getElementById('create-error').textContent='';
  _pendingEmblemData=null;buildEmojiPicker();buildColorPicker();openModal('modal-create-bastion');
}

function createBastion(){
  const name=document.getElementById('bastion-name-input').value.trim();
  const desc=document.getElementById('bastion-desc-input').value.trim();
  const rawTag=document.getElementById('bastion-tag-input').value.trim().toUpperCase().slice(0,5);
  const icon=document.getElementById('bastion-emoji-picker').dataset.selected||'🏰';
  const tagColor=document.getElementById('bastion-color-picker').dataset.selected||TAG_COLORS[0];
  if(!name){document.getElementById('create-error').textContent='Name is required.';return;}
  const newBastion={name,desc,icon,bastionTag:rawTag,tagColor,emblem:_pendingEmblemData||null,
    channels:[{name:'general',id:'general'},{name:'announcements',id:'announcements'},{name:'off-topic',id:'off-topic'}],
    members:[CU.username],owner:CU.username,createdAt:new Date().toISOString(),roles:[],memberRoles:{},customEmojis:[],boostLevel:0};
  CU.bastions.push(newBastion);saveUser();closeModal('modal-create-bastion');buildRailBastions();_pendingEmblemData=null;
  toast(`${icon} ${name} created!`,'success');openBastion(CU.bastions.length-1);
}

// ═══════════════ DISCOVER ═══════════════
function buildDiscoverGrid(){renderDiscGrid(PUBLIC_BASTIONS);}
function setDiscTab(tab,el){discTab=tab;document.querySelectorAll('.disc-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');filterBastions();}
function filterBastions(){const q=document.getElementById('disc-input')?.value.toLowerCase()||'';let f=PUBLIC_BASTIONS;if(discTab!=='all')f=f.filter(b=>b.category===discTab);if(q)f=f.filter(b=>b.name.toLowerCase().includes(q)||b.desc.toLowerCase().includes(q));renderDiscGrid(f);}
function renderDiscGrid(list){
  const grid=document.getElementById('bastion-grid');if(!grid)return;
  if(!list.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No bastions found.</div>';return;}
  grid.innerHTML=list.map(b=>{
    const alreadyJoined=CU.bastions.find(x=>x.publicId===b.id||x.name===b.name);
    return`<div class="bc">
      <div class="bc-banner">${b.icon}</div>
      <div class="bc-body">
        <div class="bc-meta"><div class="bc-icon">${b.icon}</div><div><div class="bc-name">${b.name}</div>${b.tag?`<span class="bastion-tag" style="color:${b.tagColor};border-color:${b.tagColor}44;margin-top:2px;">${b.tag}</span>`:''}</div></div>
        <div class="bc-desc">${b.desc}</div>
        <div class="bc-stats"><span>👥 ${b.members.toLocaleString()}</span><span style="color:var(--green);">● ${b.online} online</span></div>
        <div class="bc-tags">${(b.tags||[]).map(t=>`<span class="bc-tag">${t}</span>`).join('')}</div>
        <button class="btn-a" style="width:100%;justify-content:center;margin-top:10px;font-size:12.5px;padding:9px;${alreadyJoined?'background:var(--panel2);color:var(--muted-light);filter:none;':''}"
          onclick="${alreadyJoined?`openBastion(${CU.bastions.indexOf(alreadyJoined)})`:`promptJoinPublicBastion('${b.id}')`}">
          ${alreadyJoined?'✓ Joined — Open':'Join Bastion'}
        </button>
      </div>
    </div>`;}).join('');
}

function promptJoinPublicBastion(bastionId){
  const b=PUBLIC_BASTIONS.find(x=>x.id===bastionId);if(!b)return;
  const alreadyJoined=CU.bastions.find(x=>x.publicId===b.id||x.name===b.name);
  if(alreadyJoined){toast(`Already in ${b.name}!`,'info');openBastion(CU.bastions.indexOf(alreadyJoined));return;}
  const body=document.getElementById('join-bastion-body');
  body.innerHTML=`<div style="text-align:center;padding:6px 0 10px;">
    <div style="font-size:48px;margin-bottom:10px;">${b.icon}</div>
    <div class="modal-title">${b.name}${b.tag?` <span class="bastion-tag" style="color:${b.tagColor};border-color:${b.tagColor}44;">${b.tag}</span>`:''}</div>
    <div class="modal-sub">${b.desc}</div>
    <div style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;">
      <div style="text-align:center;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">${b.members.toLocaleString()}</div><div style="font-size:11px;color:var(--muted);">Members</div></div>
      <div style="text-align:center;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--green);">${b.online}</div><div style="font-size:11px;color:var(--muted);">Online</div></div>
    </div>
  </div>
  <div class="modal-actions">
    <button class="btn-g" onclick="closeModal('modal-join-bastion')">Cancel</button>
    <button class="btn-a" onclick="joinPublicBastion('${bastionId}')">⚔️ Join Bastion</button>
  </div>`;
  openModal('modal-join-bastion');
}

function joinPublicBastion(bastionId){
  const b=PUBLIC_BASTIONS.find(x=>x.id===bastionId);if(!b)return;
  const alreadyJoined=CU.bastions.find(x=>x.publicId===b.id||x.name===b.name);
  if(alreadyJoined){closeModal('modal-join-bastion');toast('Already joined!','info');return;}
  const newBastion={publicId:bastionId,name:b.name,desc:b.desc,icon:b.icon,bastionTag:b.tag||'',tagColor:b.tagColor||TAG_COLORS[0],
    channels:[{name:'general',id:'general'},{name:'announcements',id:'announcements'}],
    members:[CU.username],owner:null,joinedAt:new Date().toISOString(),roles:[],memberRoles:{},customEmojis:[],boostLevel:0};
  CU.bastions.push(newBastion);saveUser();
  const bastionId2=getBastionId(CU.bastions.length-1);FortizedSocial.addBastionMember(bastionId2,CU.username);
  closeModal('modal-join-bastion');buildRailBastions();toast(`Joined ${b.name}!`,'success');FortizedSocial.playNotificationSound();
  openBastion(CU.bastions.length-1);
}

// ═══════════════ ATELIER ═══════════════
function updateDailyBtn(){const btn=document.getElementById('daily-btn');const st=document.getElementById('daily-status');if(!btn||!st)return;const today=new Date().toDateString();if(CU.lastDaily===today){btn.classList.add('claimed');st.textContent='Claimed ✓';}else{btn.classList.remove('claimed');st.textContent='Claim now →';}}
function claimDaily(){const today=new Date().toDateString();if(CU.lastDaily===today){toast('Already claimed today!','info');return;}CU.onyx+=5;CU.lastDaily=today;saveUser();updateOnyxDisplay();updateDailyBtn();toast('+5 Onyx claimed! 💎','success');FortizedSocial.playNotificationSound();}
function buyRadiance(cost,label){pendingBuy={cost,label};document.getElementById('buy-title').textContent=`Activate Radiance — ${label}?`;document.getElementById('buy-sub').textContent=`This will deduct ${cost} Onyx. You have ${CU.onyx} Onyx.`;openModal('modal-buy');}
function confirmBuy(){if(!pendingBuy)return;if(CU.onyx<pendingBuy.cost){toast('Not enough Onyx!','error');closeModal('modal-buy');return;}CU.onyx-=pendingBuy.cost;const days=pendingBuy.label.includes('30')?30:pendingBuy.label.includes('7')?7:1;const exp=new Date();exp.setDate(exp.getDate()+days);CU.radianceUntil=exp.toISOString();saveUser();updateOnyxDisplay();closeModal('modal-buy');toast(`✨ Radiance for ${pendingBuy.label}!`,'success');FortizedSocial.playNotificationSound();pendingBuy=null;renderHomeLanding();}

// ═══════════════ PROFILE ═══════════════
function buildProfileView(tab){
  profileTab=tab||profileTab;
  const nav=document.getElementById('profile-nav');
  if(nav){
    nav.innerHTML='';
    const tabs=[{i:'👤',l:'My Profile',t:'myprofile'},{i:'✏️',l:'Edit Profile',t:'editprofile'},{i:'🔒',l:'Privacy',t:'privacy'},{i:'🔔',l:'Notifications',t:'notifications'},{i:'🎨',l:'Appearance',t:'appearance'}];
    tabs.forEach(({i,l,t})=>{const el=document.createElement('div');el.className='profile-nav-item'+(profileTab===t?' active':'');el.innerHTML=`<span>${i}</span><span>${l}</span>`;el.onclick=()=>buildProfileView(t);nav.appendChild(el);});
    const spacer=document.createElement('div');spacer.style.flex='1';nav.appendChild(spacer);
    const lo=document.createElement('div');lo.className='profile-nav-item';lo.innerHTML=`<span>🚪</span><span style="color:var(--red);">Log Out</span>`;lo.onclick=logout;nav.appendChild(lo);
  }
  const main=document.getElementById('profile-main');if(!main)return;
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
  if(profileTab==='myprofile'){
    main.innerHTML=`<div class="profile-banner-area">${CU.banner?`<img src="${CU.banner}" onerror="this.style.display='none'">`:`<img src="Profile Banner.png" onerror="this.style.display='none'">`}</div>
      <div class="profile-av-row"><div class="profile-av-big" id="pab" onclick="buildProfileView('editprofile')"></div>
        <div style="flex:1;padding-bottom:5px;"><div class="profile-display-name">${escapeHTML(CU.displayName||CU.username)}</div><div class="profile-username">@${CU.username}</div>${hasRadiance?`<div class="radiance-badge" style="margin-top:6px;">✨ Radiance Active</div>`:''}</div>
        <button class="btn-g" onclick="buildProfileView('editprofile')" style="align-self:flex-end;margin-bottom:5px;font-size:12.5px;padding:8px 14px;">✏️ Edit</button>
      </div>
      <div class="profile-content">
        <div class="profile-stats-row">
          <div class="ps-stat"><div class="ps-val">${CU.onyx}</div><div class="ps-key">Onyx</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.friends||[]).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.bastions.length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val" style="font-size:18px;">${hasRadiance?'✨':'—'}</div><div class="ps-key">Radiance</div></div>
        </div>
        <div class="settings-section"><div class="settings-title">Account Info</div>
          <div class="s-row" style="cursor:default;"><span class="si">👤</span><div class="st"><div class="sl">Username</div><div class="ss">@${CU.username}</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">📧</span><div class="st"><div class="sl">Email</div><div class="ss">${CU.email||'Not set'}</div></div></div>
        </div>
      </div>`;
    setTimeout(()=>{const pab=document.getElementById('pab');if(!pab)return;const av=buildAvatar(CU,56);av.style.cssText='border:3px solid var(--bg);cursor:pointer;flex-shrink:0;';pab.replaceWith(av);},0);
  }else if(profileTab==='editprofile'){
    main.innerHTML=`<div class="profile-content" style="padding-top:28px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Edit Profile</div>
      <div class="settings-section"><div class="settings-title">Profile Picture</div>
        <div style="display:flex;align-items:center;gap:16px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:16px;margin-bottom:8px;">
          <div id="edit-av-prev" style="width:64px;height:64px;border-radius:50%;background:var(--panel2);border:2px solid var(--border);font-size:24px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;"></div>
          <div><label style="cursor:pointer;" class="btn-g">📷 Choose Photo<input type="file" accept="image/*" onchange="handlePfpUpload(event)" style="display:none;"></label>${CU.pfp?`<button class="btn-d" onclick="removePfp()" style="font-size:12.5px;padding:8px 13px;margin-left:8px;">Remove</button>`:''}</div>
        </div>
      </div>
      <div class="settings-section"><div class="settings-title">Display Name</div>
        <input class="field-input" id="edit-displayname" value="${escapeHTML(CU.displayName||CU.username)}" placeholder="Your display name" maxlength="32">
      </div>
      <div class="settings-section"><div class="settings-title">Email Address</div>
        <input class="field-input" id="edit-email" value="${CU.email||''}" placeholder="your@email.com" type="email">
      </div>
      <div class="settings-section" style="margin-top:16px;"><div class="settings-title">Change Password</div>
        <input class="field-input" id="edit-pass-cur" placeholder="Current password" type="password" style="margin-bottom:8px;">
        <input class="field-input" id="edit-pass-new" placeholder="New password" type="password" style="margin-bottom:8px;">
        <input class="field-input" id="edit-pass-conf" placeholder="Confirm new password" type="password">
      </div>
      ${hasRadiance?`<div class="settings-section" style="margin-top:16px;"><div class="settings-title">Profile Banner <span class="radiance-badge" style="margin-left:6px;vertical-align:middle;">✨ Radiance</span></div>
        ${CU.banner?`<img src="${CU.banner}" style="width:100%;height:80px;object-fit:cover;border-radius:12px;margin-bottom:10px;" onerror="this.style.display='none'">`:''}
        <label style="cursor:pointer;" class="btn-g">🖼 Upload Banner<input type="file" accept="image/*" onchange="handleBannerUpload(event)" style="display:none;"></label>
        ${CU.banner?`<button class="btn-d" onclick="removeBanner()" style="font-size:12.5px;padding:8px 13px;margin-left:8px;">Remove</button>`:''}</div>`
      :`<div class="settings-section" style="margin-top:16px;"><div class="s-row" style="cursor:default;background:rgba(255,249,62,.04);border-color:rgba(255,249,62,.1);"><span class="si">🖼</span><div class="st"><div class="sl">Custom Profile Banner</div><div class="ss">Unlock with ✨ Radiance</div></div><button class="btn-a" onclick="navigate('atelier')" style="font-size:11.5px;padding:6px 12px;">Get Radiance</button></div></div>`}
      <div style="display:flex;gap:9px;margin-top:8px;">
        <button class="btn-a" onclick="saveProfileEdits()">Save Changes</button>
        <button class="btn-g" onclick="buildProfileView('myprofile')">Cancel</button>
      </div>
      <div id="edit-msg" style="margin-top:12px;font-size:13px;min-height:18px;"></div>
    </div>`;
    setTimeout(()=>{const prev=document.getElementById('edit-av-prev');if(!prev)return;const av=buildAvatar(CU,64);prev.replaceWith(av);},0);
  }else if(profileTab==='privacy'){
    main.innerHTML=`<div class="profile-content" style="padding-top:28px;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Privacy & Terms</div>
      <div class="settings-section">
        <div style="background:rgba(255,249,62,.04);border:1px solid rgba(255,249,62,.1);border-radius:16px;padding:20px 22px;margin-bottom:10px;"><div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:8px;">🛡️ Your Data is Protected</div><div style="font-size:13.5px;color:var(--muted-light);line-height:1.7;">Your data is stored locally on your device. Fortized does not transmit personal information.</div></div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px 22px;margin-bottom:10px;"><div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:8px;">📜 Terms of Use</div><div style="font-size:13.5px;color:var(--muted-light);line-height:1.7;">Use Fortized respectfully and lawfully. Harassment, impersonation, or harm is not permitted.</div></div>
      </div>
    </div>`;
  }else if(profileTab==='notifications'){
    main.innerHTML=`<div class="profile-content" style="padding-top:28px;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Notifications</div>
      <div class="settings-section"><div class="settings-title">Messages</div>
        <div class="s-row"><span class="si">💬</span><div class="st"><div class="sl">Direct Messages</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">📌</span><div class="st"><div class="sl">Mentions</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section"><div class="settings-title">Social</div>
        <div class="s-row"><span class="si">👥</span><div class="st"><div class="sl">Friend Requests</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">🔔</span><div class="st"><div class="sl">Notification Sound</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
    </div>`;
  }else if(profileTab==='appearance'){
    main.innerHTML=`<div class="profile-content" style="padding-top:28px;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Appearance</div>
      <div class="settings-section"><div class="settings-title">Theme</div>
        <div class="s-row" style="border-color:rgba(255,249,62,.2);"><span class="si">🌑</span><div class="st"><div class="sl">Dark</div><div class="ss">Default</div></div><span style="color:var(--accent);">✓ Active</span></div>
      </div>
      <div class="settings-section"><div class="settings-title">Status</div>
        <div class="s-row" onclick="setStatus('online')"><span class="si" style="color:var(--green);">●</span><div class="st"><div class="sl">Online</div></div></div>
        <div class="s-row" onclick="setStatus('away')"><span class="si" style="color:var(--yellow);">●</span><div class="st"><div class="sl">Away</div></div></div>
        <div class="s-row" onclick="setStatus('dnd')"><span class="si" style="color:var(--red);">●</span><div class="st"><div class="sl">Do Not Disturb</div></div></div>
        <div class="s-row" onclick="setStatus('invisible')"><span class="si" style="color:var(--muted);">●</span><div class="st"><div class="sl">Invisible</div></div></div>
      </div>
    </div>`;
  }
}

function handlePfpUpload(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){toast('Max 5MB','error');return;}const reader=new FileReader();reader.onload=ev=>{CU.pfp=ev.target.result;saveUser();updateAvatarEl(document.getElementById('ua'),CU);buildProfileView('editprofile');toast('Picture updated!','success');};reader.readAsDataURL(file);}
function removePfp(){CU.pfp=null;saveUser();updateAvatarEl(document.getElementById('ua'),CU);buildProfileView('editprofile');toast('Photo removed','info');}
function handleBannerUpload(e){const file=e.target.files[0];if(!file)return;if(file.size>5*1024*1024){toast('Max 5MB','error');return;}const reader=new FileReader();reader.onload=ev=>{CU.banner=ev.target.result;saveUser();buildProfileView('editprofile');toast('Banner updated!','success');};reader.readAsDataURL(file);}
function removeBanner(){CU.banner=null;saveUser();buildProfileView('editprofile');toast('Banner removed','info');}
function saveProfileEdits(){
  const dn=document.getElementById('edit-displayname')?.value.trim();const email=document.getElementById('edit-email')?.value.trim();
  const pc=document.getElementById('edit-pass-cur')?.value;const pn=document.getElementById('edit-pass-new')?.value;const pconf=document.getElementById('edit-pass-conf')?.value;
  const msg=document.getElementById('edit-msg');
  if(dn)CU.displayName=dn;if(email)CU.email=email;
  if(pc||pn||pconf){if(!pc||!pn||!pconf){if(msg)msg.innerHTML='<span style="color:var(--red);">Fill all password fields.</span>';return;}if(CU.password&&pc!==CU.password){if(msg)msg.innerHTML='<span style="color:var(--red);">Wrong password.</span>';return;}if(pn!==pconf){if(msg)msg.innerHTML='<span style="color:var(--red);">Passwords don\'t match.</span>';return;}if(pn.length<6){if(msg)msg.innerHTML='<span style="color:var(--red);">Min 6 chars.</span>';return;}CU.password=pn;}
  saveUser();document.getElementById('ua-name').textContent=CU.displayName||CU.username;if(msg)msg.innerHTML='<span style="color:var(--green);">✓ Saved!</span>';toast('Profile updated!','success');setTimeout(()=>buildProfileView('myprofile'),1000);
}
function setStatus(status){CU.status=status;saveUser();FortizedSocial.setStatus(CU.username,status);const labels={online:'● Online',away:'● Away',dnd:'● Do Not Disturb',invisible:'● Invisible'};document.getElementById('ua-tag').textContent=labels[status]||'● Online';toast(`Status: ${status}`,'info');}

// ═══════════════ NOTIFICATIONS ═══════════════
function toggleNotifPanel(){notifPanelOpen=!notifPanelOpen;document.getElementById('notif-panel').classList.toggle('open',notifPanelOpen);if(notifPanelOpen)buildNotifList();}
function buildNotifList(){refreshCU();const list=document.getElementById('np-list');if(!list)return;const notifs=FortizedSocial.getNotifications(CU.username);if(!notifs.length){list.innerHTML='<div class="np-empty">✓ All caught up!</div>';return;}
  list.innerHTML=notifs.map(n=>{let icon='🔔',text='';if(n.type==='friend_request'){icon='👥';text=`<strong>${escapeHTML(n.from)}</strong> sent you a friend request`;}else if(n.type==='friend_accept'){icon='🤝';text=`<strong>${escapeHTML(n.from)}</strong> accepted your request`;}else if(n.type==='dm'){icon='💬';text=`<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview||'').slice(0,40))}`;}
    const actions=n.type==='friend_request'?`<div class="np-actions"><button class="np-accept" onclick="acceptFriend('${n.from}');buildNotifList()">Accept</button><button class="np-decline" onclick="declineFriend('${n.from}');buildNotifList()">Decline</button></div>`:'';
    return`<div class="np-item ${n.read?'':'unread'}"><div class="np-icon">${icon}</div><div class="np-text"><p>${text}</p><div class="np-time">${formatTimeAgo(n.time)}</div>${actions}</div></div>`;}).join('');}
function markAllRead(){FortizedSocial.markNotificationsRead(CU.username);refreshCU();updateNotifBadge();buildNotifList();refreshHomeRight();}

// ═══════════════ VIEW USER PROFILE ═══════════════
function viewUserProfile(username){
  const user=FortizedSocial.getUserByName(username);
  if(!user){toast('User not found','error');return;}
  const isFriend=(CU.friends||[]).includes(username);const isOwn=username===CU.username;const hasSentReq=(CU.friendRequestsSent||[]).includes(username);
  const status=FortizedSocial.getStatus(username);
  // Find bastion tag for this user (from shared bastions)
  let tagHTML='';
  if(curBastion!==null&&curBastion!==undefined){const b=CU.bastions[curBastion];if(b&&b.bastionTag)tagHTML=`<span class="bastion-tag" style="color:${b.tagColor||'var(--accent)'};border-color:${(b.tagColor||'var(--accent)')+'44'};">${escapeHTML(b.bastionTag)}</span>`;}
  const body=document.getElementById('user-modal-body');
  body.innerHTML=`<div style="text-align:center;padding:6px 0 16px;">
    <div id="umod-av" style="margin:0 auto 12px;"></div>
    <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">${escapeHTML(user.displayName||user.username)} ${tagHTML}</div>
    <div style="font-size:13px;color:var(--muted-light);">@${user.username}</div>
    <div style="font-size:13px;margin-top:4px;color:${status==='online'?'var(--green)':status==='away'?'var(--yellow)':status==='dnd'?'var(--red)':'var(--muted)'};">● ${status}</div>
  </div>
  ${!isOwn?`<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
    <button class="btn-g" onclick="openDMChat('${username}');closeModal('modal-user')" style="font-size:13px;padding:8px 14px;">💬 Message</button>
    ${isFriend?`<button class="btn-d" onclick="removeFriend('${username}');closeModal('modal-user')" style="font-size:13px;padding:8px 14px;">Remove Friend</button>`
    :hasSentReq?`<button class="btn-g" style="font-size:13px;padding:8px 14px;opacity:.6;cursor:not-allowed;">Request Sent</button>`
    :`<button class="btn-a" onclick="quickAddFriend('${username}')" style="font-size:13px;padding:8px 14px;">+ Add Friend</button>`}
  </div>`:''}
  <button class="btn-g" onclick="closeModal('modal-user')" style="width:100%;justify-content:center;font-size:13px;">Close</button>`;
  setTimeout(()=>{const el=document.getElementById('umod-av');if(!el)return;const av=buildAvatar(user,64);av.style.borderRadius='50%';el.replaceWith(av);},0);
  openModal('modal-user');
}

// ═══════════════ CONTEXT MENU ═══════════════
document.addEventListener('contextmenu',e=>{e.preventDefault();buildSmartCtxMenu(e);});
function buildSmartCtxMenu(e){
  const target=e.target;const x=e.clientX,y=e.clientY;const selection=window.getSelection()?.toString().trim();
  const isMsgText=target.closest('.msg-text,.msg-row');const isFriendItem=target.closest('.friend-item,.ml-entry');
  const isChannelItem=target.closest('.ch-item');const isRailBastion=target.closest('.rail-bastion');
  const isInput=target.matches('input,textarea');const items=[];
  if(isMsgText){
    const row=target.closest('.msg-row');const isOwn=row?.classList.contains('own');const authorEl=row?.querySelector('.msg-author');const author=authorEl?.textContent||'';const text=row?.querySelector('.msg-text')?.textContent||'';
    items.push({label:'Message',section:true});
    items.push({icon:'📋',label:'Copy',action:()=>navigator.clipboard?.writeText(text).then(()=>toast('Copied!','info'))});
    if(selection)items.push({icon:'✂️',label:`Copy selection`,action:()=>navigator.clipboard?.writeText(selection).then(()=>toast('Copied!','info'))});
    items.push({sep:true});
    if(!isOwn&&author){items.push({icon:'👤',label:`View ${author}'s Profile`,action:()=>viewUserProfile(author)});items.push({icon:'💬',label:`Message ${author}`,action:()=>openDMChat(author)});items.push({sep:true});}
    if(isOwn)items.push({icon:'🗑️',label:'Delete',action:()=>toast('Delete coming soon','info'),danger:true});
    showCtxMenu(x,y,items);return;
  }
  if(isFriendItem){const nameEl=isFriendItem.querySelector('.fi-name,.ml-name');const username=nameEl?.textContent?.replace(' (you)','').trim();
    if(username&&username!==CU?.username){items.push({label:username,section:true});items.push({icon:'💬',label:'Send Message',action:()=>openDMChat(username)});items.push({icon:'👤',label:'View Profile',action:()=>viewUserProfile(username)});items.push({sep:true});items.push({icon:'🗑️',label:'Remove Friend',action:()=>removeFriend(username),danger:true});showCtxMenu(x,y,items);return;}}
  if(isChannelItem){const chName=isChannelItem.querySelector('span:last-child')?.textContent||'channel';const chIdx=[...(isChannelItem.parentElement?.querySelectorAll('.ch-item')||[])].indexOf(isChannelItem);items.push({label:`# ${chName}`,section:true});items.push({icon:'📋',label:'Copy Name',action:()=>navigator.clipboard?.writeText(chName).then(()=>toast('Copied!','info'))});if(curBastion!==null&&CU.bastions[curBastion]?.owner===CU.username)items.push({icon:'🗑️',label:'Delete Channel',action:()=>deleteChannel(curBastion,chIdx),danger:true});showCtxMenu(x,y,items);return;}
  if(isRailBastion){const idx=[...document.querySelectorAll('.rail-bastion')].indexOf(isRailBastion);const b=CU?.bastions?.[idx];if(b){items.push({label:b.name,section:true});items.push({icon:'🏰',label:'Open',action:()=>openBastion(idx)});if(b.owner===CU.username)items.push({icon:'⚙️',label:'Settings',action:()=>{openBastion(idx);setTimeout(openBastionSettings,100);}});items.push({sep:true});items.push({icon:'🚪',label:b.owner===CU.username?'Delete Bastion':'Leave Bastion',action:()=>{openBastion(idx);setTimeout(()=>promptLeaveBastion(idx),100);},danger:true});showCtxMenu(x,y,items);return;}}
  if(isInput){items.push({label:'Text',section:true});if(selection)items.push({icon:'📋',label:'Copy',action:()=>navigator.clipboard?.writeText(selection).then(()=>toast('Copied!','info'))});items.push({icon:'📄',label:'Paste',action:()=>navigator.clipboard?.readText().then(t=>document.execCommand('insertText',false,t)).catch(()=>toast('Use Ctrl+V','info'))});showCtxMenu(x,y,items);return;}
  items.push({label:'Fortized',section:true});items.push({icon:'🏠',label:'Home',action:()=>navigate('home')});items.push({icon:'🧭',label:'Discover',action:()=>navigate('discover')});items.push({icon:'💎',label:'Atelier',action:()=>navigate('atelier')});items.push({sep:true});items.push({icon:'🔔',label:'Notifications',action:()=>toggleNotifPanel()});items.push({icon:'⚙️',label:'Settings',action:()=>navigate('profile')});items.push({sep:true});items.push({icon:'🚪',label:'Log Out',action:()=>logout(),danger:true});
  showCtxMenu(x,y,items);
}

function showCtxMenu(x,y,items){
  const menu=document.getElementById('ctx-menu');menu.innerHTML='';menu.className='ctx-menu';menu.style.display='block';menu.style.left='-9999px';menu.style.top='-9999px';
  items.forEach(item=>{
    if(item.sep){const s=document.createElement('div');s.className='ctx-sep';menu.appendChild(s);return;}
    if(item.section){const s=document.createElement('div');s.className='ctx-section-label';s.textContent=item.label;menu.appendChild(s);return;}
    const el=document.createElement('div');el.className='ctx-item'+(item.danger?' danger':'')+(item.disabled?' disabled':'');
    el.innerHTML=`<span class="ctx-icon">${item.icon||''}</span><span class="ctx-label">${item.label}</span>${item.shortcut?`<span class="ctx-shortcut">${item.shortcut}</span>`:''}`;
    if(!item.disabled)el.onclick=e=>{e.stopPropagation();item.action();menu.style.display='none';};menu.appendChild(el);
  });
  const mw=menu.offsetWidth,mh=menu.offsetHeight,vw=window.innerWidth,vh=window.innerHeight;
  let left=x+2,top=y+2;if(left+mw>vw-8)left=x-mw-2;if(top+mh>vh-8)top=y-mh-2;if(left<8)left=8;if(top<8)top=8;
  menu.style.left=left+'px';menu.style.top=top+'px';
}

// ═══════════════ UTILS ═══════════════
function scrollBottom(id){setTimeout(()=>{const el=document.getElementById(id);if(el)el.scrollTop=el.scrollHeight;},60);}
function autoResize(el){el.style.height='';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function parseMD(text){return text.replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>').replace(/\*(.+?)\*/g,'<em>$1</em>').replace(/`(.+?)`/g,'<code>$1</code>').replace(/~~(.+?)~~/g,'<s>$1</s>');}
function formatTimeAgo(iso){if(!iso)return'';const diff=Date.now()-new Date(iso).getTime();const m=Math.floor(diff/60000);if(m<1)return'just now';if(m<60)return`${m}m ago`;const h=Math.floor(m/60);if(h<24)return`${h}h ago`;return`${Math.floor(h/24)}d ago`;}
function escapeHTML(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
let toastTimer;
function toast(msg,type='info'){const el=document.getElementById('toast');el.textContent=msg;el.className='toast show '+type;clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.classList.remove('show'),3000);}
function logout(){FortizedSocial.setStatus(CU.username,'offline');FortizedSocial.stopPolling();localStorage.removeItem('ftz_current');localStorage.removeItem('fortized_current_user');window.location.href='login.html';}

document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
document.addEventListener('click',()=>{document.getElementById('ctx-menu').style.display='none';});
document.addEventListener('scroll',()=>{document.getElementById('ctx-menu').style.display='none';},true);
document.addEventListener('keydown',e=>{if(e.key==='Escape'){document.getElementById('ctx-menu').style.display='none';document.querySelectorAll('.modal-overlay.open').forEach(m=>m.classList.remove('open'));}});
</script>
</body>
</html>
