<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="social.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOKENS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root{
  --accent:#fff93e;
  --accent-dim:rgba(255,249,62,.1);
  --accent-mid:rgba(255,249,62,.2);
  --bg:#07090e;
  --rail:#04060a;
  --sidebar:#0b0e15;
  --channel:#0d1018;
  --panel:#101420;
  --panel2:#131822;
  --panel3:#161c28;
  --border:#1c2335;
  --radius:12px;
  --muted:#4e5a6f;
  --muted-light:#7d8a9e;
  --text:#dde3ed;
  --green:#3ecf6e;
  --red:#f87171;
  --yellow:#f59e0b;
  --blue:#60a5fa;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;}
::selection{background:rgba(255,249,62,.2);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rail{
  width:64px;min-width:64px;
  background:var(--rail);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
  padding:10px 0;gap:3px;z-index:10;
  box-shadow:2px 0 16px rgba(0,0,0,.4);
}
.rail-logo{
  width:36px;height:36px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  margin-bottom:4px;
}
.rail-logo img{width:32px;height:32px;object-fit:contain;filter:drop-shadow(0 0 6px rgba(255,249,62,.25));}
.rail-sep{width:28px;height:1px;background:var(--border);margin:4px 0;opacity:.5;}
.rail-btn{
  width:40px;height:40px;border-radius:13px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .12s,border-radius .12s;
  position:relative;flex-shrink:0;font-size:17px;
}
.rail-btn:hover{background:rgba(255,255,255,.07);border-radius:11px;}
.rail-btn.active{background:var(--accent-dim);border-radius:11px;}
.rail-btn.active::before{
  content:"";position:absolute;left:-10px;top:50%;transform:translateY(-50%);
  width:3px;height:22px;background:var(--accent);border-radius:0 3px 3px 0;
}
.rail-btn[data-tip]:hover::after{
  content:attr(data-tip);position:absolute;left:calc(100%+9px);top:50%;transform:translateY(-50%);
  background:#0c1020;border:1px solid var(--border);
  color:var(--text);font-size:12px;font-weight:600;padding:4px 9px;border-radius:7px;
  white-space:nowrap;z-index:999;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.rail-bastion{
  width:38px;height:38px;border-radius:13px;
  background:var(--panel);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:15px;
  transition:border-color .12s,background .12s,border-radius .12s;
  position:relative;overflow:hidden;flex-shrink:0;
}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:11px;background:var(--accent-dim);}
.rail-bastion.active::before{
  content:"";position:absolute;left:-10px;top:50%;transform:translateY(-50%);
  width:3px;height:22px;background:var(--accent);border-radius:0 3px 3px 0;
}
.rail-notif-badge{
  position:absolute;top:3px;right:3px;
  min-width:15px;height:15px;border-radius:8px;
  background:var(--red);color:#fff;font-size:9px;font-weight:800;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--rail);padding:0 2px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar{
  width:234px;min-width:234px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
}
.sidebar-header{
  height:48px;display:flex;align-items:center;
  padding:0 12px;border-bottom:1px solid var(--border);
  font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;
  flex-shrink:0;gap:7px;background:rgba(0,0,0,.15);
}
.sidebar-header .hdr-actions{margin-left:auto;display:flex;gap:2px;}
.sidebar-header .hdr-actions button{
  width:26px;height:26px;border-radius:7px;
  background:transparent;border:none;color:var(--muted);
  font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.sidebar-header .hdr-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:5px 0;}
.sec-label{
  font-size:10px;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;color:var(--muted);
  padding:11px 12px 4px;
  display:flex;align-items:center;justify-content:space-between;
}
.sec-label button{
  background:none;border:none;color:var(--muted);font-size:16px;
  cursor:pointer;width:16px;height:16px;border-radius:4px;
  display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.sec-label button:hover{background:rgba(255,255,255,.07);color:#fff;}
.s-item{
  display:flex;align-items:center;gap:8px;
  padding:6px 9px;margin:1px 5px;border-radius:7px;
  cursor:pointer;font-size:13px;color:var(--muted-light);
  transition:background .09s,color .09s;
}
.s-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.s-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.s-item .s-icon{
  width:24px;height:24px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0;overflow:hidden;
}
.s-item .s-icon img{width:100%;height:100%;object-fit:cover;}
.s-item .s-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.s-item .s-badge{
  background:var(--red);color:#fff;font-size:9px;font-weight:800;
  padding:1px 5px;border-radius:100px;min-width:16px;text-align:center;flex-shrink:0;
}
.ch-item{
  display:flex;align-items:center;gap:7px;
  padding:5px 7px;margin:1px 5px;border-radius:7px;
  cursor:pointer;font-size:12.5px;color:var(--muted);
  transition:background .09s,color .09s;
}
.ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.ch-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.cat-row{
  display:flex;align-items:center;gap:5px;
  padding:9px 7px 3px 9px;
  font-size:10px;font-weight:700;letter-spacing:.08em;
  text-transform:uppercase;color:var(--muted);cursor:pointer;
  transition:color .1s;
}
.cat-row:hover{color:var(--text);}
.cat-row button{
  margin-left:auto;background:none;border:none;color:inherit;
  cursor:pointer;font-size:13px;opacity:0;
  width:15px;height:15px;display:flex;align-items:center;justify-content:center;
  transition:opacity .1s;
}
.cat-row:hover button{opacity:1;}
.friend-item{
  display:flex;align-items:center;gap:8px;
  padding:6px 9px;margin:1px 5px;border-radius:7px;
  cursor:pointer;transition:background .09s;
}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.fa{
  width:29px;height:29px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;position:relative;overflow:hidden;
}
.fa img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.fa .fs{
  position:absolute;bottom:-1px;right:-1px;
  width:9px;height:9px;border-radius:50%;
  border:2px solid var(--sidebar);
}
.fs.online{background:var(--green);}
.fs.away{background:var(--yellow);}
.fs.dnd{background:var(--red);}
.fs.offline{background:#374151;}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:12.5px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* userbar */
.userbar{
  height:52px;background:rgba(4,6,10,.7);border-top:1px solid var(--border);
  display:flex;align-items:center;padding:0 7px;gap:6px;flex-shrink:0;
}
.ua{
  width:30px;height:30px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;
  overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;
}
.ua img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ua .ua-ring{
  position:absolute;bottom:-1px;right:-1px;
  width:10px;height:10px;border-radius:50%;
  background:var(--green);border:2px solid var(--sidebar);
}
.ua-info{flex:1;min-width:0;}
.ua-name{font-size:12.5px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ua-tag{font-size:10px;color:var(--muted);}
.ua-btns{display:flex;gap:1px;}
.ua-btns button{
  width:27px;height:27px;border-radius:7px;background:transparent;border:none;
  color:var(--muted);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:background .09s,color .09s;
}
.ua-btns button:hover{background:rgba(255,255,255,.07);color:#fff;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{flex:1;min-width:0;display:flex;flex-direction:column;}
.topbar{
  height:48px;background:rgba(8,11,18,.96);backdrop-filter:blur(14px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;padding:0 16px;gap:9px;flex-shrink:0;
  box-shadow:0 2px 16px rgba(0,0,0,.3);
}
.topbar-title{
  font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;
  display:flex;align-items:center;gap:6px;
}
.tb-sep{width:1px;height:17px;background:var(--border);margin:0 2px;}
.tb-desc{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.tb-actions{margin-left:auto;display:flex;align-items:center;gap:5px;}
.tb-actions button{
  background:transparent;border:none;color:var(--muted);
  font-size:16px;cursor:pointer;width:30px;height:30px;
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  transition:background .09s,color .09s;
}
.tb-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{
  display:flex;align-items:center;gap:5px;
  background:var(--accent-dim);border:1px solid var(--accent-mid);
  border-radius:100px;padding:4px 10px;
  font-size:12px;font-weight:700;color:var(--accent);
  cursor:pointer;transition:background .12s;
}
.onyx-pill:hover{background:rgba(255,249,62,.15);}
.onyx-pill img{width:13px;height:13px;object-fit:contain;}
.tb-search{
  display:flex;align-items:center;gap:5px;
  background:rgba(255,255,255,.04);border:1px solid var(--border);
  border-radius:7px;padding:4px 9px;width:160px;
  transition:border-color .15s,width .2s;
}
.tb-search:focus-within{border-color:rgba(255,249,62,.2);width:200px;}
.tb-search input{
  background:transparent;border:none;outline:none;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:12px;flex:1;
}
.tb-search input::placeholder{color:var(--muted);}

.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;}
.view.active{display:flex;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOME VIEW â€” POLYTORIA-STYLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.home-wrap{flex:1;display:flex;overflow:hidden;}
.home-left-panel{
  width:234px;min-width:234px;
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  background:var(--channel);
}
.home-feed{flex:1;overflow-y:auto;}
.home-right-panel{
  width:280px;min-width:280px;
  border-left:1px solid var(--border);
  display:flex;flex-direction:column;
  background:var(--channel);overflow-y:auto;
}

/* Hero banner at top of feed */
.home-banner{
  width:100%;height:160px;
  background:linear-gradient(135deg,#0d1a38,#181040,#0d2838);
  position:relative;overflow:hidden;flex-shrink:0;
}
.home-banner img.banner-img{
  width:100%;height:100%;object-fit:cover;
  object-position:center 30%;opacity:.6;
}
.home-banner .banner-overlay{
  position:absolute;inset:0;
  background:linear-gradient(to right,rgba(7,9,14,.9) 0%,rgba(7,9,14,.4) 60%,transparent);
  display:flex;align-items:center;padding:0 28px;gap:14px;
}
.home-banner .banner-text h2{
  font-family:'Syne',sans-serif;font-size:20px;font-weight:800;
  letter-spacing:-.3px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.5);
}
.home-banner .banner-text p{font-size:13px;color:rgba(255,255,255,.7);margin-top:2px;}
.home-banner .knight-img{
  width:90px;height:90px;object-fit:contain;
  filter:drop-shadow(0 4px 16px rgba(0,0,0,.5));
  position:absolute;right:24px;bottom:0;
}

/* Home main scroll */
.home-main-scroll{padding:20px 22px 28px;}

/* Section headers */
.section-hdr{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;
}
.section-hdr h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;}
.section-hdr h3::before{content:"";width:12px;height:2px;background:var(--accent);}
.section-hdr a{font-size:12px;color:var(--muted-light);cursor:pointer;text-decoration:none;}
.section-hdr a:hover{color:var(--accent);}

/* Quick nav tiles */
.quick-nav{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-bottom:24px;}
.qn-tile{
  background:var(--panel);border:1px solid var(--border);
  border-radius:12px;padding:16px 14px;
  cursor:pointer;transition:border-color .15s,transform .12s;
  display:flex;align-items:center;gap:10px;position:relative;overflow:hidden;
}
.qn-tile::after{
  content:"";position:absolute;bottom:0;left:0;right:0;height:2px;
  background:var(--accent);opacity:0;transition:opacity .15s;
}
.qn-tile:hover{border-color:rgba(255,249,62,.18);transform:translateY(-2px);}
.qn-tile:hover::after{opacity:.6;}
.qn-icon{
  width:36px;height:36px;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:17px;flex-shrink:0;
}
.qn-text h4{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:2px;}
.qn-text p{font-size:11px;color:var(--muted);}
.qn-badge{
  position:absolute;top:8px;right:8px;
  background:var(--red);color:#fff;font-size:9px;font-weight:800;
  padding:1px 5px;border-radius:100px;
}

/* Activity feed */
.activity-feed{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
.activity-item{
  display:flex;align-items:flex-start;gap:10px;
  padding:10px 12px;background:var(--panel);border:1px solid var(--border);
  border-radius:10px;cursor:pointer;transition:border-color .12s;
}
.activity-item:hover{border-color:rgba(255,249,62,.12);}
.act-icon{
  width:34px;height:34px;border-radius:50%;
  background:var(--panel2);border:1px solid var(--border);
  font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.act-text{flex:1;}
.act-text p{font-size:13px;color:var(--text);line-height:1.5;}
.act-text p strong{font-weight:700;}
.act-time{font-size:11px;color:var(--muted);margin-top:2px;}

/* Discover mini grid */
.mini-bastion-row{display:flex;flex-direction:column;gap:8px;margin-bottom:24px;}
.mini-bastion{
  display:flex;align-items:center;gap:10px;
  padding:10px 12px;background:var(--panel);border:1px solid var(--border);
  border-radius:10px;cursor:pointer;transition:border-color .12s;
}
.mini-bastion:hover{border-color:rgba(255,249,62,.15);}
.mb-icon{
  width:36px;height:36px;border-radius:10px;
  background:var(--panel2);border:1px solid var(--border);
  font-size:17px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.mb-info{flex:1;}
.mb-name{font-size:13px;font-weight:700;}
.mb-meta{font-size:11px;color:var(--muted);}
.mb-join{
  background:var(--accent-dim);border:1px solid var(--accent-mid);
  color:var(--accent);font-size:11.5px;font-weight:700;
  padding:4px 10px;border-radius:6px;cursor:pointer;
  transition:background .12s;flex-shrink:0;
}
.mb-join:hover{background:rgba(255,249,62,.18);}

/* Right panel */
.rp-section{padding:14px 14px 6px;border-bottom:1px solid var(--border);}
.rp-section:last-child{border-bottom:none;}
.rp-title{
  font-size:10px;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;color:var(--muted);margin-bottom:8px;
}
.rp-notif{
  display:flex;gap:8px;padding:7px 9px;border-radius:8px;
  cursor:pointer;transition:background .1s;margin-bottom:3px;
}
.rp-notif:hover{background:rgba(255,255,255,.04);}
.rp-notif.unread{background:rgba(255,249,62,.04);}
.rp-notif .rn-icon{
  width:28px;height:28px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.rp-notif .rn-text{flex:1;}
.rp-notif .rn-text p{font-size:12px;color:var(--text);line-height:1.4;}
.rp-notif .rn-text p strong{font-weight:700;}
.rp-notif .rn-time{font-size:10px;color:var(--muted);}
.rp-notif .rn-actions{display:flex;gap:5px;margin-top:4px;}
.rn-accept{background:rgba(62,207,110,.15);border:1px solid rgba(62,207,110,.3);color:var(--green);font-size:11px;font-weight:700;padding:3px 10px;border-radius:5px;cursor:pointer;}
.rn-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 10px;border-radius:5px;cursor:pointer;}

/* Blog post */
.blog-post{
  padding:10px;border-radius:9px;cursor:pointer;
  transition:background .1s;margin-bottom:4px;
}
.blog-post:hover{background:rgba(255,255,255,.04);}
.blog-post .bp-tag{
  font-size:10px;font-weight:700;letter-spacing:.06em;
  text-transform:uppercase;color:var(--accent);margin-bottom:4px;
}
.blog-post .bp-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.4;}
.blog-post .bp-date{font-size:11px;color:var(--muted);}

/* DM list in left panel */
.home-dm-item{
  display:flex;align-items:center;gap:8px;
  padding:6px 9px;margin:1px 5px;border-radius:7px;
  cursor:pointer;transition:background .09s;
}
.home-dm-item:hover{background:rgba(255,255,255,.05);}
.home-dm-item.active{background:rgba(255,249,62,.07);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHAT VIEW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{
  flex:1;overflow-y:auto;padding:14px 18px;
  display:flex;flex-direction:column;gap:0;
}
.chat-welcome{
  padding:18px 0 16px;
  border-bottom:1px solid var(--border);margin-bottom:16px;
}
.chat-welcome .w-av{
  width:54px;height:54px;border-radius:50%;
  background:var(--panel);border:2px solid var(--border);
  font-size:20px;display:flex;align-items:center;justify-content:center;
  margin-bottom:10px;overflow:hidden;
}
.chat-welcome .w-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:2px;}
.chat-welcome p{font-size:13px;color:var(--muted-light);}
.date-div{
  display:flex;align-items:center;gap:10px;
  padding:8px 0;margin:6px 0;
  font-size:10.5px;font-weight:700;color:var(--muted);letter-spacing:.04em;
}
.date-div::before,.date-div::after{content:"";flex:1;height:1px;background:var(--border);}
.msg-group{
  display:flex;gap:9px;padding:2px 0;
  border-radius:6px;transition:background .08s;position:relative;
}
.msg-group:hover{background:rgba(255,255,255,.02);padding:2px 5px;margin:0 -5px;}
.msg-group.own{flex-direction:row-reverse;}
.msg-av{
  width:32px;height:32px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;margin-top:2px;overflow:hidden;cursor:pointer;
}
.msg-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.msg-body{flex:1;min-width:0;}
.msg-meta{display:flex;align-items:baseline;gap:7px;margin-bottom:2px;}
.msg-author{font-size:12.5px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-time{font-size:10px;color:var(--muted);}
.msg-bubble{
  background:var(--panel);border:1px solid var(--border);
  border-radius:4px 11px 11px 11px;
  padding:7px 11px;font-size:13px;color:var(--text);
  line-height:1.55;word-break:break-word;max-width:650px;display:inline-block;
}
.msg-group.own .msg-bubble{
  background:rgba(255,249,62,.09);border-color:rgba(255,249,62,.14);
  border-radius:11px 4px 11px 11px;
}
.msg-group.own .msg-meta{flex-direction:row-reverse;}
.msg-cont .msg-av{opacity:0;pointer-events:none;}
.msg-cont .msg-meta{display:none;}
.msg-cont .msg-bubble{margin-top:1px;}
.msg-reactions{display:flex;flex-wrap:wrap;gap:3px;margin-top:3px;}
.r-pill{
  display:flex;align-items:center;gap:3px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:100px;padding:1px 8px;font-size:12px;cursor:pointer;
  transition:background .1s;
}
.r-pill:hover{background:rgba(255,255,255,.09);}
.r-pill.mine{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.msg-acts{
  display:none;gap:2px;position:absolute;right:7px;top:-12px;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:8px;padding:2px;z-index:10;
}
.msg-group:hover .msg-acts{display:flex;}
.msg-acts button{
  background:none;border:none;color:var(--muted);font-size:13px;
  cursor:pointer;width:24px;height:24px;border-radius:5px;
  display:flex;align-items:center;justify-content:center;transition:background .09s,color .09s;
}
.msg-acts button:hover{background:rgba(255,255,255,.07);color:#fff;}

/* Input */
.chat-input-wrap{padding:9px 14px 13px;flex-shrink:0;}
.chat-input-box{
  background:var(--panel2);border:1px solid var(--border);border-radius:11px;
  display:flex;align-items:flex-end;gap:5px;padding:7px 10px;
  transition:border-color .15s;
}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.22);box-shadow:0 0 0 2px rgba(255,249,62,.04);}
.chat-input-box textarea{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:13px;
  resize:none;max-height:110px;line-height:1.5;padding:2px 0;
}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{
  width:30px;height:30px;border-radius:8px;
  background:var(--accent);border:none;color:#060810;font-size:13px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:filter .1s;
}
.chat-send:hover{filter:brightness(1.08);}
.chat-input-actions button{
  background:none;border:none;color:var(--muted);font-size:16px;
  cursor:pointer;width:28px;height:28px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;transition:background .09s,color .09s;
}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.chat-input-actions{display:flex;gap:2px;align-items:center;}

/* Member list */
.member-list{
  width:210px;min-width:210px;
  background:var(--channel);border-left:1px solid var(--border);
  overflow-y:auto;padding:10px 0;display:flex;flex-direction:column;
}
.ml-header{padding:0 10px 6px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);}
.ml-entry{
  display:flex;align-items:center;gap:7px;
  padding:4px 8px;margin:1px 3px;border-radius:7px;cursor:pointer;
  transition:background .09s;
}
.ml-entry:hover{background:rgba(255,255,255,.05);}
.ml-av{width:26px;height:26px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;position:relative;}
.ml-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ml-status{position:absolute;bottom:-1px;right:-1px;width:8px;height:8px;border-radius:50%;border:2px solid var(--channel);}
.ml-name{font-size:12px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DISCOVER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.discover-scroll{flex:1;overflow-y:auto;padding:24px;}
.disc-hero{
  background:linear-gradient(105deg,rgba(7,9,14,.98) 40%,rgba(7,9,14,.8));
  border:1px solid var(--border);border-radius:16px;
  padding:36px 32px;margin-bottom:24px;position:relative;overflow:hidden;
}
.disc-hero::before{
  content:"";position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,249,62,.01) 1px,transparent 1px),linear-gradient(90deg,rgba(255,249,62,.01) 1px,transparent 1px);
  background-size:50px 50px;
}
.disc-hero::after{
  content:"";position:absolute;top:-60px;right:-60px;
  width:260px;height:260px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,249,62,.05) 0%,transparent 70%);
}
.disc-hero h2{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;letter-spacing:-.5px;margin-bottom:5px;position:relative;}
.disc-hero p{font-size:13.5px;color:var(--muted-light);margin-bottom:18px;position:relative;max-width:420px;}
.disc-search{display:flex;align-items:center;gap:9px;max-width:380px;position:relative;}
.disc-search input{
  flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:9px;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;
  padding:9px 13px 9px 36px;outline:none;transition:border-color .12s;
}
.disc-search input:focus{border-color:rgba(255,249,62,.25);}
.disc-search input::placeholder{color:var(--muted);}
.disc-search .si{position:absolute;left:11px;font-size:13px;color:var(--muted);pointer-events:none;}
.disc-tabs{display:flex;gap:4px;margin-bottom:20px;}
.disc-tab{
  padding:6px 14px;border-radius:7px;font-size:12.5px;font-weight:600;cursor:pointer;
  border:1px solid transparent;color:var(--muted-light);transition:all .12s;
}
.disc-tab:hover{background:rgba(255,255,255,.05);color:#fff;}
.disc-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;}
.bc{
  background:var(--panel);border:1px solid var(--border);
  border-radius:13px;overflow:hidden;
  cursor:pointer;transition:border-color .15s,transform .12s,box-shadow .15s;
}
.bc:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);box-shadow:0 10px 36px rgba(0,0,0,.4);}
.bc-banner{height:70px;background:linear-gradient(135deg,#1a2040,#0d1425);display:flex;align-items:center;justify-content:center;font-size:28px;position:relative;overflow:hidden;}
.bc-banner::after{content:"";position:absolute;inset:0;background:linear-gradient(to bottom,transparent 40%,rgba(0,0,0,.5));}
.bc-body{padding:12px;}
.bc-meta{display:flex;align-items:center;gap:7px;margin-bottom:7px;}
.bc-icon{width:38px;height:38px;border-radius:10px;background:var(--panel2);border:2px solid var(--sidebar);font-size:17px;display:flex;align-items:center;justify-content:center;margin-top:-22px;position:relative;z-index:1;flex-shrink:0;}
.bc-name{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;}
.bc-desc{font-size:11.5px;color:var(--muted-light);line-height:1.5;margin-bottom:7px;}
.bc-stats{display:flex;gap:9px;font-size:11px;color:var(--muted);}
.bc-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:7px;}
.bc-tag{font-size:10px;font-weight:600;padding:1px 7px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted-light);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ATELIER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.atelier-scroll{flex:1;overflow-y:auto;padding:24px;}
.atelier-top{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;padding:22px 26px;margin-bottom:22px;
  position:relative;overflow:hidden;
}
.atelier-top::before{
  content:"";position:absolute;top:-40px;right:-40px;
  width:160px;height:160px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,249,62,.06) 0%,transparent 70%);
}
.atelier-bal{display:flex;align-items:center;gap:11px;}
.atelier-bal img{width:32px;height:32px;object-fit:contain;}
.atelier-bal h3{font-size:12px;font-weight:600;color:var(--muted-light);margin-bottom:1px;}
.atelier-bal .amt{font-family:'Syne',sans-serif;font-size:26px;font-weight:800;color:var(--accent);letter-spacing:-.3px;}
.daily-btn{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);
  border-radius:12px;padding:11px 20px;cursor:pointer;transition:background .12s;
}
.daily-btn:hover{background:rgba(255,249,62,.12);}
.daily-btn span{font-size:10.5px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:13px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{
  font-family:'Syne',sans-serif;font-size:14px;font-weight:700;
  margin-bottom:12px;display:flex;align-items:center;gap:7px;
}
.atelier-section-title::before{content:"";width:12px;height:2px;background:var(--accent);}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:26px;}
.rad-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:13px;padding:20px 16px;
  display:flex;flex-direction:column;align-items:center;text-align:center;
  gap:7px;cursor:pointer;
  transition:border-color .15s,transform .12s,box-shadow .15s;position:relative;overflow:hidden;
}
.rad-card::before{
  content:"";position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  opacity:0;transition:opacity .2s;
}
.rad-card:hover{border-color:rgba(255,249,62,.22);transform:translateY(-2px);box-shadow:0 10px 36px rgba(0,0,0,.4);}
.rad-card:hover::before{opacity:1;}
.rad-card.bv{border-color:rgba(255,249,62,.18);}
.best-badge{position:absolute;top:9px;right:9px;background:var(--accent);color:#060810;font-size:9px;font-weight:800;letter-spacing:.05em;padding:1px 6px;border-radius:100px;text-transform:uppercase;}
.rad-icon{font-size:28px;}
.rad-dur{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.rad-price{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;color:var(--accent);}
.rad-price span{font-size:11px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-feats{font-size:11.5px;color:var(--muted-light);line-height:1.55;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PROFILE VIEW â€” FULL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.profile-wrap{flex:1;display:flex;overflow:hidden;}
.profile-sidebar{
  width:200px;min-width:200px;
  border-right:1px solid var(--border);
  background:var(--channel);
  display:flex;flex-direction:column;
  padding:10px 0;overflow-y:auto;
}
.profile-sidebar-item{
  display:flex;align-items:center;gap:8px;
  padding:8px 12px;margin:1px 5px;border-radius:8px;
  cursor:pointer;font-size:13px;color:var(--muted-light);
  transition:background .09s,color .09s;
}
.profile-sidebar-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.profile-sidebar-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.profile-main{flex:1;overflow-y:auto;}

/* Profile card top */
.profile-card-top{
  position:relative;
}
.profile-banner-img{
  width:100%;height:140px;
  background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);
  position:relative;overflow:hidden;
}
.profile-banner-img img{width:100%;height:100%;object-fit:cover;}
.profile-banner-img .banner-edit-btn{
  position:absolute;bottom:8px;right:8px;
  background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.15);
  color:#fff;font-size:11px;font-weight:600;padding:4px 10px;
  border-radius:6px;cursor:pointer;display:none;
  transition:background .1s;
}
.profile-banner-img:hover .banner-edit-btn{display:block;}
.profile-banner-img .banner-edit-btn:hover{background:rgba(0,0,0,.8);}
.profile-av-row{
  display:flex;align-items:flex-end;gap:14px;
  padding:0 22px;margin-top:-36px;margin-bottom:14px;
}
.profile-av-big{
  width:72px;height:72px;border-radius:50%;
  background:var(--panel);border:4px solid var(--bg);
  font-size:26px;display:flex;align-items:center;justify-content:center;
  overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;
}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-av-big:hover::after{
  content:"ğŸ“·";position:absolute;inset:0;
  background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;
  font-size:20px;border-radius:50%;
}
.profile-info{flex:1;padding-bottom:4px;}
.profile-display-name{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;letter-spacing:-.2px;margin-bottom:2px;}
.profile-username{font-size:13px;color:var(--muted-light);}
.profile-content-area{padding:0 22px 32px;}
.profile-stats-row{
  display:flex;background:var(--panel);border:1px solid var(--border);
  border-radius:12px;overflow:hidden;margin-bottom:20px;
}
.ps-stat{flex:1;padding:14px;text-align:center;border-right:1px solid var(--border);}
.ps-stat:last-child{border-right:none;}
.ps-val{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--accent);}
.ps-key{font-size:11px;color:var(--muted);margin-top:2px;}

/* Settings panels */
.settings-panel{display:none;}
.settings-panel.active{display:block;}
.settings-title{font-family:'Syne',sans-serif;font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:9px;}
.settings-section{margin-bottom:22px;}
.s-row{
  display:flex;align-items:center;gap:10px;
  padding:11px 13px;background:var(--panel);border:1px solid var(--border);
  border-radius:9px;margin-bottom:6px;cursor:pointer;
  transition:border-color .12s,background .12s;
}
.s-row:hover{border-color:rgba(255,249,62,.12);background:rgba(255,249,62,.02);}
.s-row .si{font-size:16px;width:28px;text-align:center;}
.s-row .st{flex:1;}
.s-row .sl{font-size:13px;font-weight:600;}
.s-row .ss{font-size:12px;color:var(--muted-light);}
.s-row .sa{color:var(--muted);font-size:12px;}

/* Input field */
.field-group{margin-bottom:14px;}
.field-label{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:5px;}
.field-input{
  width:100%;padding:9px 12px;
  background:#05070d;border:1px solid var(--border);border-radius:8px;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;
  outline:none;transition:border-color .12s;
}
.field-input:focus{border-color:rgba(255,249,62,.3);}
.field-input::placeholder{color:#252c3d;}
.field-hint{font-size:11px;color:var(--muted);margin-top:4px;}

/* Toggle */
.toggle{
  width:36px;height:19px;border-radius:10px;background:var(--border);
  position:relative;cursor:pointer;transition:background .15s;flex-shrink:0;
}
.toggle.on{background:var(--accent);}
.toggle::after{
  content:"";position:absolute;top:2px;left:2px;
  width:15px;height:15px;border-radius:50%;background:#fff;transition:transform .15s;
}
.toggle.on::after{transform:translateX(17px);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.78);backdrop-filter:blur(10px);
  z-index:1000;align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--panel);border:1px solid var(--border);
  border-radius:16px;width:100%;max-width:400px;overflow:hidden;
  animation:mIn .2s cubic-bezier(.22,1,.36,1) both;
  box-shadow:0 28px 70px rgba(0,0,0,.7);
}
.modal.wide{max-width:520px;}
@keyframes mIn{from{opacity:0;transform:scale(.93) translateY(12px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.modal-body{padding:24px;}
.modal-title{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;margin-bottom:4px;}
.modal-sub{font-size:12.5px;color:var(--muted-light);margin-bottom:20px;}
.modal-error{font-size:11.5px;color:var(--red);margin-bottom:7px;min-height:15px;display:flex;align-items:center;gap:4px;}
.modal-error:not(:empty)::before{content:"âš ";}
.modal-success{font-size:11.5px;color:var(--green);margin-bottom:7px;}
.modal-actions{display:flex;gap:8px;margin-top:4px;}
.modal-actions .btn-a,.modal-actions .btn-g{flex:1;justify-content:center;}
.modal-input{
  width:100%;padding:9px 12px;
  background:#05070d;border:1px solid var(--border);border-radius:8px;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;
  outline:none;margin-bottom:11px;transition:border-color .12s;
}
.modal-input:focus{border-color:rgba(255,249,62,.32);}
.modal-input::placeholder{color:#252c3d;}

/* Buttons */
.btn-a{
  display:inline-flex;align-items:center;gap:6px;
  background:var(--accent);color:#060810;padding:9px 18px;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  border:none;cursor:pointer;transition:filter .1s,transform .09s;
}
.btn-a:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-g{
  display:inline-flex;align-items:center;gap:6px;
  background:transparent;color:var(--muted-light);padding:8px 16px;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  border:1px solid var(--border);cursor:pointer;transition:border-color .1s,background .1s;
}
.btn-g:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-d{
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(248,113,113,.1);color:var(--red);padding:8px 16px;border-radius:9px;
  font-family:'Syne',sans-serif;font-size:13px;font-weight:700;
  border:1px solid rgba(248,113,113,.2);cursor:pointer;transition:all .1s;
}
.btn-d:hover{background:rgba(248,113,113,.18);}

/* Toast */
.toast{
  position:fixed;bottom:20px;right:20px;z-index:2000;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:10px;padding:10px 16px;font-size:12.5px;font-weight:500;
  box-shadow:0 18px 48px rgba(0,0,0,.6);
  transform:translateY(18px);opacity:0;
  transition:transform .25s cubic-bezier(.22,1,.36,1),opacity .25s;
  max-width:260px;pointer-events:none;
}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}

/* Context menu */
.ctx-menu{
  position:fixed;z-index:3000;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:9px;padding:4px;min-width:160px;
  box-shadow:0 10px 36px rgba(0,0,0,.6);
  animation:ctxIn .12s cubic-bezier(.22,1,.36,1);
}
@keyframes ctxIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:none;}}
.ctx-item{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;border-radius:6px;font-size:12.5px;color:var(--text);cursor:pointer;transition:background .08s;
}
.ctx-item:hover{background:rgba(255,255,255,.06);}
.ctx-item.danger{color:var(--red);}
.ctx-item.danger:hover{background:rgba(248,113,113,.1);}
.ctx-sep{height:1px;background:var(--border);margin:3px 0;}
.ctx-disabled{padding:6px 10px;font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.06em;text-transform:uppercase;}

/* Emoji picker */
.emoji-picker-wrap{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:11px;}
.emoji-opt{
  width:34px;height:34px;border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  font-size:18px;cursor:pointer;border:1.5px solid transparent;transition:all .1s;
}
.emoji-opt:hover{background:rgba(255,255,255,.06);}
.emoji-opt.sel{border-color:var(--accent);background:var(--accent-dim);}

/* Notif panel */
.notif-panel{
  position:fixed;top:48px;right:0;width:320px;max-height:calc(100vh - 56px);
  background:var(--sidebar);border:1px solid var(--border);border-radius:14px 0 0 14px;
  box-shadow:-6px 0 36px rgba(0,0,0,.5);z-index:100;
  transform:translateX(100%);transition:transform .22s cubic-bezier(.22,1,.36,1);
  display:flex;flex-direction:column;
}
.notif-panel.open{transform:translateX(0);}
.np-header{
  padding:14px 16px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;flex-shrink:0;
}
.np-header h3{font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;}
.np-header button{
  background:none;border:none;color:var(--muted);cursor:pointer;
  font-size:15px;width:26px;height:26px;border-radius:6px;
  display:flex;align-items:center;justify-content:center;transition:background .09s,color .09s;
}
.np-header button:hover{background:rgba(255,255,255,.07);color:#fff;}
.np-list{flex:1;overflow-y:auto;padding:6px;}
.np-item{
  display:flex;gap:9px;padding:9px 10px;border-radius:8px;
  cursor:pointer;transition:background .08s;margin-bottom:2px;position:relative;
}
.np-item:hover{background:rgba(255,255,255,.04);}
.np-item.unread{background:rgba(255,249,62,.04);}
.np-item.unread::before{content:"";position:absolute;left:3px;top:50%;transform:translateY(-50%);width:3px;height:3px;border-radius:50%;background:var(--accent);}
.np-icon{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.np-text{flex:1;}
.np-text p{font-size:12px;color:var(--text);line-height:1.45;}
.np-text p strong{font-weight:700;}
.np-time{font-size:10px;color:var(--muted);margin-top:2px;}
.np-actions{display:flex;gap:5px;margin-top:5px;}
.np-accept{background:rgba(62,207,110,.12);border:1px solid rgba(62,207,110,.25);color:var(--green);font-size:11px;font-weight:700;padding:3px 9px;border-radius:5px;cursor:pointer;}
.np-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 9px;border-radius:5px;cursor:pointer;}
.np-empty{padding:36px;text-align:center;color:var(--muted);font-size:13px;}

/* Radiance badge */
.radiance-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));
  border:1px solid rgba(255,220,62,.25);
  border-radius:100px;padding:2px 9px;
  font-size:10.5px;font-weight:700;color:#ffd93e;margin-top:5px;
}
.boost-bar{
  background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);border-radius:9px;
  padding:8px 12px;display:flex;align-items:center;gap:9px;
  font-size:12px;color:var(--muted-light);cursor:pointer;margin:7px;transition:background .12s;
}
.boost-bar:hover{background:rgba(255,249,62,.1);}
.boost-bar .bl{font-weight:700;color:var(--accent);}

/* empty state */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;color:var(--muted);text-align:center;padding:36px;}
.empty-state .ei{font-size:44px;opacity:.32;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:16px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13px;max-width:280px;line-height:1.6;}
</style>
</head>
<body>

<!-- RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Fortized Home">
    <img src="Fortized icon.png" alt="" onerror="this.outerHTML='<span style=font-size:22px>ğŸ°</span>'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn active" id="rail-home" onclick="navigate('home')" data-tip="Home">ğŸ </div>
  <div class="rail-btn" id="rail-discover" onclick="navigate('discover')" data-tip="Discover">ğŸ§­</div>
  <div class="rail-btn" id="rail-atelier" onclick="navigate('atelier')" data-tip="Atelier">
    <img src="Onyx.png" style="width:20px;height:20px;object-fit:contain;" onerror="this.outerHTML='ğŸ’'">
  </div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" id="rail-add" onclick="openCreateBastion()" data-tip="Create Bastion" style="border:1.5px dashed #1c2335;border-radius:13px;font-size:18px;color:var(--muted);">+</div>
  <div style="margin-top:auto;"></div>
  <div class="rail-btn" id="rail-notif" onclick="toggleNotifPanel()" data-tip="Notifications" style="position:relative;">
    ğŸ””<div class="rail-notif-badge" id="notif-badge" style="display:none;">0</div>
  </div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Profile">âš™ï¸</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header">
    <span id="sidebar-title">Fortized</span>
    <div class="hdr-actions" id="sidebar-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <div id="boost-bar-wrap" style="display:none;">
    <div class="boost-bar" onclick="toast('Boost coming soon','info')">
      <span>âš¡</span><div><div class="bl">Boost Bastion</div><div style="font-size:10px;">Level 0</div></div>
    </div>
  </div>
  <div class="userbar">
    <div class="ua" id="ua" onclick="navigate('profile')"><div class="ua-ring"></div></div>
    <div class="ua-info">
      <div class="ua-name" id="ua-name">â€”</div>
      <div class="ua-tag" id="ua-tag">â— Online</div>
    </div>
    <div class="ua-btns">
      <button title="Mute" onclick="toast('Muted','info')">ğŸ¤</button>
      <button title="Deafen" onclick="toast('Deafened','info')">ğŸ§</button>
      <button title="Log Out" onclick="logout()">ğŸšª</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbar-title" id="topbar-title"><span>ğŸ </span><span>Home</span></div>
    <div class="tb-sep"></div>
    <div class="tb-desc" id="topbar-desc">Welcome to Fortized</div>
    <div class="tb-actions">
      <div class="onyx-pill" onclick="navigate('atelier')">
        <img src="Onyx.png" onerror="this.outerHTML='ğŸ’'"><span id="topbar-onyx">0</span>
      </div>
      <div class="tb-search">
        <span style="font-size:11px;color:var(--muted);">ğŸ”</span>
        <input type="text" placeholder="Searchâ€¦">
      </div>
      <button id="member-list-btn" style="display:none;" onclick="toggleMemberList()" title="Members">ğŸ‘¥</button>
    </div>
  </div>

  <!-- CONTENT -->
  <div class="content">

    <!-- HOME -->
    <div id="view-home" class="view active">
      <div class="home-wrap">
        <!-- Left: DMs / Friends panel -->
        <div class="home-left-panel">
          <div class="sidebar-header" style="font-size:12.5px;">
            <span>Direct Messages</span>
            <div class="hdr-actions">
              <button onclick="openNewDM()" title="New DM">+</button>
              <button onclick="renderFriends()" title="Friends">ğŸ‘¥</button>
            </div>
          </div>
          <div class="sidebar-scroll" id="dm-list"></div>
        </div>
        <!-- Center: Feed -->
        <div class="home-feed">
          <div id="home-content"></div>
        </div>
        <!-- Right: Notifications + Blog -->
        <div class="home-right-panel" id="home-right-panel"></div>
      </div>
    </div>

    <!-- BASTION -->
    <div id="view-bastion" class="view" style="flex-direction:row;">
      <div id="bastion-main" style="flex:1;display:flex;flex-direction:column;min-width:0;"></div>
      <div class="member-list" id="member-list" style="display:none;"></div>
    </div>

    <!-- DISCOVER -->
    <div id="view-discover" class="view">
      <div class="discover-scroll">
        <div class="disc-hero">
          <h2>Discover Bastions</h2>
          <p>Find public communities, join the fight, and make your mark.</p>
          <div class="disc-search">
            <span class="si">ğŸ”</span>
            <input type="text" placeholder="Search bastionsâ€¦" id="disc-input" oninput="filterBastions()">
          </div>
        </div>
        <div class="disc-tabs">
          <div class="disc-tab active" onclick="setDiscTab('all',this)">All</div>
          <div class="disc-tab" onclick="setDiscTab('gaming',this)">ğŸ® Gaming</div>
          <div class="disc-tab" onclick="setDiscTab('competitive',this)">âš”ï¸ Competitive</div>
          <div class="disc-tab" onclick="setDiscTab('casual',this)">ğŸª Casual</div>
          <div class="disc-tab" onclick="setDiscTab('roleplay',this)">ğŸ‰ Roleplay</div>
        </div>
        <div class="bastion-grid" id="bastion-grid"></div>
      </div>
    </div>

    <!-- ATELIER -->
    <div id="view-atelier" class="view">
      <div class="atelier-scroll">
        <div class="atelier-top">
          <div class="atelier-bal">
            <img src="Onyx.png" onerror="this.outerHTML='ğŸ’'">
            <div><h3>Onyx Balance</h3><div class="amt" id="atelier-balance">0</div></div>
          </div>
          <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
            <span>Daily Reward</span><strong>+5 Onyx</strong><span id="daily-status">Claim</span>
          </div>
        </div>
        <div class="atelier-section-title">Radiance â€” Premium Status</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(110,'1 Day')">
            <div class="rad-icon">âœ¨</div><div class="rad-dur">1 Day</div>
            <div class="rad-price">110 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for 24 hours</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12px;padding:7px;">Activate</button>
          </div>
          <div class="rad-card bv" onclick="buyRadiance(770,'7 Days')">
            <div class="best-badge">Best Value</div>
            <div class="rad-icon">âš¡</div><div class="rad-dur">7 Days</div>
            <div class="rad-price">770 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for one week</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12px;padding:7px;">Activate</button>
          </div>
          <div class="rad-card" onclick="buyRadiance(3300,'30 Days')">
            <div class="rad-icon">ğŸ‘‘</div><div class="rad-dur">30 Days</div>
            <div class="rad-price">3,300 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for a month</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12px;padding:7px;">Activate</button>
          </div>
        </div>
        <div class="atelier-section-title">Radiance Perks</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:28px;">
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ¨</span><div class="st"><div class="sl">Custom Profile Badge</div><div class="ss">Exclusive Radiance crown</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸŒŸ</span><div class="st"><div class="sl">Animated Border</div><div class="ss">Glowing avatar frame</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ’¬</span><div class="st"><div class="sl">Extended Messages</div><div class="ss">Up to 4000 chars</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ“</span><div class="st"><div class="sl">100MB Uploads</div><div class="ss">Standard is 8MB</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ­</span><div class="st"><div class="sl">Custom Emoji</div><div class="ss">Use anywhere</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ¨</span><div class="st"><div class="sl">Custom Banner</div><div class="ss">Personalize your profile</div></div></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="view-profile" class="view">
      <div class="profile-wrap">
        <div class="profile-sidebar" id="profile-sidebar-nav"></div>
        <div class="profile-main" id="profile-main-content"></div>
      </div>
    </div>

  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="np-header">
    <h3>Notifications</h3>
    <div style="display:flex;gap:3px;">
      <button onclick="markAllRead()" title="Mark all read" style="font-size:11px;width:auto;padding:0 6px;">âœ“ All</button>
      <button onclick="toggleNotifPanel()">âœ•</button>
    </div>
  </div>
  <div class="np-list" id="np-list"></div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create a Bastion</div>
      <div class="modal-sub">Build your own community fortress.</div>
      <div class="modal-error" id="create-error"></div>
      <input class="modal-input" id="bastion-name-input" placeholder="Bastion name" maxlength="32">
      <input class="modal-input" id="bastion-desc-input" placeholder="Short description (optional)" maxlength="80">
      <div style="margin-bottom:12px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:7px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Icon</div>
        <div class="emoji-picker-wrap" id="bastion-emoji-picker"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-a" onclick="createBastion()">âš”ï¸ Create</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">New Direct Message</div>
      <div class="modal-sub">Message any Fortized user by username.</div>
      <div class="modal-error" id="dm-error"></div>
      <input class="modal-input" id="dm-username-input" placeholder="Exact username" onkeydown="if(event.key==='Enter')startDM()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-a" onclick="startDM()">Open DM</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Add a Friend</div>
      <div class="modal-sub">Send a friend request by their exact username.</div>
      <div class="modal-error" id="af-error"></div>
      <div class="modal-success" id="af-success"></div>
      <input class="modal-input" id="af-input" placeholder="Exact username" onkeydown="if(event.key==='Enter')sendFriendReq()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-add-friend')">Close</button>
        <button class="btn-a" onclick="sendFriendReq()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-buy">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="buy-title">Activate Radiance?</div>
      <div class="modal-sub" id="buy-sub">This will deduct Onyx from your balance.</div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-buy')">Cancel</button>
        <button class="btn-a" onclick="confirmBuy()">âœ¨ Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-user">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="user-modal-body"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="ctx-menu" style="display:none;"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let CU = null; // current user
let curView = 'home';
let curDM = null;   // partner username
let curBastion = null;
let curChannel = null;
let memberListOpen = false;
let notifPanelOpen = false;
let pendingBuy = null;
let discTab = 'all';
let profileTab = 'myprofile';

const EMOJIS=['ğŸ°','âš”ï¸','ğŸ›¡','ğŸ¹','ğŸ—¡ï¸','ğŸ”¥','âš¡','ğŸŒŒ','ğŸ®','ğŸ¯','ğŸ’€','ğŸ‰','ğŸŒ™','ğŸŒŸ','ğŸª','ğŸ”®','ğŸŒŠ','ğŸ¦…'];
const QUICK_REACT=['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ”¥','âœ…'];
const PUBLIC_BASTIONS=[
  {icon:'âš”ï¸',name:'Warfront Elite',desc:'Competitive FPS & strategy. Weekly tournaments.',members:1842,online:234,category:'competitive',tags:['FPS','Ranked']},
  {icon:'ğŸ‰',name:'Dragon Realm',desc:'Fantasy RPG & tabletop. D&D, Pathfinder and more.',members:932,online:87,category:'roleplay',tags:['RPG','D&D']},
  {icon:'ğŸ®',name:'Casual Crew',desc:'Laid-back gamers who just want to chill.',members:3201,online:418,category:'casual',tags:['Chill','Multi-game']},
  {icon:'ğŸŒŒ',name:'Void Runners',desc:'Sci-fi, space sims, Star Citizen, Elite Dangerous.',members:671,online:55,category:'gaming',tags:['Sci-Fi','Space']},
  {icon:'ğŸ¯',name:'Sniper Guild',desc:'Precision shooters. Weekly coaching sessions.',members:2156,online:310,category:'competitive',tags:['Shooter','Coaching']},
  {icon:'ğŸ”¥',name:'Blaze Bastions',desc:'The hottest new community on the platform.',members:489,online:102,category:'gaming',tags:['Hot','New']},
  {icon:'ğŸª',name:'Meme Lords',desc:'Gaming memes, clips, and dumb moments.',members:5480,online:623,category:'casual',tags:['Memes','Clips']},
  {icon:'ğŸ”®',name:'Arcane Council',desc:'Strategy, deckbuilders, and puzzle games.',members:811,online:77,category:'gaming',tags:['Strategy','Puzzle']},
];
const BLOG_POSTS=[
  {tag:'Update',title:'Bastions 2.0 â€” Channels, Roles & More',date:'Feb 14, 2025'},
  {tag:'Feature',title:'Atelier Store is Now Live',date:'Jan 28, 2025'},
  {tag:'Community',title:'February Onyx Giveaway Results',date:'Jan 20, 2025'},
  {tag:'Notice',title:'Terms of Service Update',date:'Jan 5, 2025'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded',()=>{
  const username=localStorage.getItem('fortized_current_user');
  if(!username){window.location.href='login.html';return;}
  const users=JSON.parse(localStorage.getItem('fortized_users'))||[];
  CU=users.find(u=>u.username===username);
  if(!CU){window.location.href='login.html';return;}
  // Ensure all fields exist
  ['bastions','friends','friendRequestsSent','friendRequestsReceived','notifications'].forEach(k=>{
    if(!Array.isArray(CU[k]))CU[k]=[];
  });
  if(typeof CU.onyx!=='number')CU.onyx=5;
  if(!CU.lastDaily)CU.lastDaily=null;
  if(!CU.status)CU.status='online';
  if(!CU.displayName)CU.displayName=CU.username;
  saveUser();
  FortizedSocial.setStatus(CU.username,CU.status);
  buildUI();
  navigate('home');

  // Start polling
  FortizedSocial.startPolling(CU.username,{
    onNewNotification:(n)=>{
      refreshCU();updateNotifBadge();
      if(n.type==='friend_request')toast(`Friend request from ${n.from}!`,'info');
      else if(n.type==='friend_accept'){toast(`${n.from} accepted your request!`,'success');refreshCU();}
      else if(n.type==='dm'&&curView==='home')refreshDMLeftPanel();
    }
  });
  setInterval(()=>{refreshCU();updateNotifBadge();refreshHomeRight();},3000);

  document.addEventListener('click',()=>document.getElementById('ctx-menu').style.display='none');
  document.addEventListener('click',e=>{
    const panel=document.getElementById('notif-panel');
    const bell=document.getElementById('rail-notif');
    if(!panel.contains(e.target)&&!bell.contains(e.target)){
      panel.classList.remove('open');notifPanelOpen=false;
    }
  });
});

function saveUser(){
  const users=JSON.parse(localStorage.getItem('fortized_users'))||[];
  const i=users.findIndex(u=>u.username===CU.username);
  if(i>-1){users[i]=CU;localStorage.setItem('fortized_users',JSON.stringify(users));}
}
function refreshCU(){
  const users=JSON.parse(localStorage.getItem('fortized_users'))||[];
  const fresh=users.find(u=>u.username===CU.username);
  if(!fresh)return;
  CU.notifications=fresh.notifications||[];
  CU.friends=fresh.friends||[];
  CU.friendRequestsReceived=fresh.friendRequestsReceived||[];
  CU.friendRequestsSent=fresh.friendRequestsSent||[];
  CU.onyx=fresh.onyx;
  CU.radianceUntil=fresh.radianceUntil;
  updateOnyxDisplay();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildUI(){
  updateAvatarEl(document.getElementById('ua'),CU);
  document.getElementById('ua-name').textContent=CU.displayName||CU.username;
  updateOnyxDisplay();updateNotifBadge();
  buildRailBastions();buildDiscoverGrid();buildEmojiPicker();
  renderHomeLanding();updateDailyBtn();refreshDMLeftPanel();
}
function buildAvatar(user,size=30,withStatus=false){
  const div=document.createElement('div');
  div.className='fa';div.style.width=size+'px';div.style.height=size+'px';div.style.fontSize=Math.floor(size*.4)+'px';
  if(user.pfp){
    const img=document.createElement('img');img.src=user.pfp;
    img.onerror=()=>{img.remove();div.textContent=(user.displayName||user.username||'?')[0].toUpperCase();};
    div.appendChild(img);
  } else {
    div.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  }
  if(withStatus){
    const status=FortizedSocial.getStatus(user.username);
    const dot=document.createElement('div');dot.className=`fs ${status}`;div.appendChild(dot);
  }
  return div;
}
function updateAvatarEl(el,user){
  if(!el)return;
  const ring=el.querySelector('.ua-ring');
  el.innerHTML='';
  if(user.pfp){
    const img=document.createElement('img');img.src=user.pfp;
    img.onerror=()=>{img.remove();el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();if(ring)el.appendChild(ring);};
    el.appendChild(img);
  } else {
    el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  }
  if(ring)el.appendChild(ring);
}
function updateOnyxDisplay(){
  document.getElementById('topbar-onyx').textContent=CU.onyx;
  const ab=document.getElementById('atelier-balance');if(ab)ab.textContent=CU.onyx;
}
function updateNotifBadge(){
  const count=FortizedSocial.getUnreadCount(CU.username);
  const b=document.getElementById('notif-badge');
  b.style.display=count>0?'flex':'none';
  b.textContent=count>9?'9+':count;
}
function buildRailBastions(){
  const c=document.getElementById('rail-bastions');c.innerHTML='';
  CU.bastions.forEach((b,i)=>{
    const el=document.createElement('div');
    el.className='rail-bastion'+(curBastion===i?' active':'');
    el.id='rb-'+i;el.setAttribute('data-tip',b.name);el.textContent=b.icon||'ğŸ°';
    el.onclick=()=>openBastion(i);c.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view){
  ['home','bastion','discover','atelier','profile'].forEach(v=>{
    const el=document.getElementById('view-'+v);
    if(el){el.style.display='none';el.classList.remove('active');}
  });
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b=>b.classList.remove('active'));
  document.getElementById('member-list-btn').style.display='none';
  document.getElementById('boost-bar-wrap').style.display='none';
  const rb=document.getElementById('rail-'+view);if(rb)rb.classList.add('active');
  curView=view;
  const el=document.getElementById('view-'+view);
  if(el){el.style.display='flex';el.classList.add('active');}
  if(view==='home'){
    setTopbar('ğŸ ','Home','Your hub â€” messages, friends, discover');
    setSidebar('home');renderHomeLanding();refreshDMLeftPanel();refreshHomeRight();
  } else if(view==='discover'){
    setTopbar('ğŸ§­','Discover','Find and join public Bastions');setSidebar('discover');
  } else if(view==='atelier'){
    setTopbar('ğŸ’','Atelier','Spend Onyx on Radiance and cosmetics');setSidebar('atelier');updateOnyxDisplay();updateDailyBtn();
  } else if(view==='profile'){
    setTopbar('âš™ï¸','Settings','Manage your account and preferences');setSidebar('profile');buildProfileView('myprofile');
  }
}
function setTopbar(icon,title,desc){
  document.getElementById('topbar-title').innerHTML=`<span>${icon}</span><span>${title}</span>`;
  document.getElementById('topbar-desc').textContent=desc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIDEBAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSidebar(ctx){
  const scroll=document.getElementById('sidebar-scroll');
  const title=document.getElementById('sidebar-title');
  const actions=document.getElementById('sidebar-actions');
  scroll.innerHTML='';actions.innerHTML='';
  if(ctx==='home'){
    title.textContent='Fortized';
    actions.innerHTML=`<button onclick="navigate('discover')" title="Discover">ğŸ§­</button>`;
    const navItems=[
      {i:'ğŸ ',l:'Home',a:()=>renderHomeLanding()},
      {i:'ğŸ‘¥',l:'Friends',a:()=>renderFriends()},
      {i:'ğŸ“¥',l:'Pending',a:()=>renderPending(),badge:getPendingCount()||''},
    ];
    navItems.forEach(item=>{
      const el=makeSItem(item.i,item.l,item.badge);el.onclick=item.action||item.a;scroll.appendChild(el);
    });
    const lbl=makeSLabel('Direct Messages',`<button onclick="openNewDM()">+</button>`);
    scroll.appendChild(lbl);
    buildDMItems(scroll);
  } else if(ctx==='discover'){
    title.textContent='Discover';
  } else if(ctx==='atelier'){
    title.textContent='Atelier';
    [['âœ¨','Radiance'],['ğŸ’','Onyx'],['ğŸ¨','Cosmetics']].forEach(([i,l])=>scroll.appendChild(makeSItem(i,l)));
  } else if(ctx==='profile'){
    title.textContent='Settings';
    const tabs=[
      {i:'ğŸ‘¤',l:'My Profile',t:'myprofile'},
      {i:'âœï¸',l:'Edit Profile',t:'editprofile'},
      {i:'ğŸ”’',l:'Privacy',t:'privacy'},
      {i:'ğŸ””',l:'Notifications',t:'notifications'},
      {i:'ğŸ¨',l:'Appearance',t:'appearance'},
    ];
    tabs.forEach(({i,l,t})=>{
      const el=makeSItem(i,l);
      el.id='ptab-'+t;
      el.onclick=()=>buildProfileView(t);
      scroll.appendChild(el);
    });
  } else if(ctx==='bastion'&&curBastion!==null){
    const b=CU.bastions[curBastion];
    title.textContent=b.name;
    actions.innerHTML=`<button onclick="toast('Bastion settings soon','info')" title="Settings">âš™ï¸</button>`;
    document.getElementById('boost-bar-wrap').style.display='block';
    const catEl=document.createElement('div');
    catEl.className='cat-row';
    catEl.innerHTML=`<span style="font-size:9px;margin-right:2px;">â–¾</span><span>Text Channels</span><button onclick="event.stopPropagation();addChannel(${curBastion})">+</button>`;
    scroll.appendChild(catEl);
    (b.channels||[]).forEach((ch,ci)=>{
      const el=document.createElement('div');
      el.className='ch-item'+(curChannel===ci?' active':'');
      el.innerHTML=`<span style="font-size:12px;color:var(--muted);">#</span><span style="flex:1;">${ch.name}</span>`;
      el.onclick=()=>openChannel(curBastion,ci);
      el.oncontextmenu=(e)=>{e.preventDefault();showCtxMenu(e.clientX,e.clientY,[
        {label:`# ${ch.name}`,disabled:true},
        {sep:true},
        {label:'ğŸ—‘ï¸ Delete Channel',action:()=>deleteChannel(curBastion,ci),danger:true},
      ]);};
      scroll.appendChild(el);
    });
    const vCat=document.createElement('div');vCat.className='cat-row';
    vCat.innerHTML=`<span style="font-size:9px;">â–¾</span><span>Voice Channels</span>`;
    scroll.appendChild(vCat);
    const vc=document.createElement('div');vc.className='ch-item';
    vc.innerHTML=`<span>ğŸ”Š</span><span style="flex:1;">General</span>`;
    vc.onclick=()=>toast('Voice channels coming soon','info');
    scroll.appendChild(vc);
  }
}
function getPendingCount(){return(CU.friendRequestsReceived||[]).length;}
function makeSItem(icon,label,badge=''){
  const el=document.createElement('div');el.className='s-item';
  el.innerHTML=`<div class="s-icon"><span>${icon}</span></div><span class="s-name">${label}</span>${badge?`<span class="s-badge">${badge}</span>`:''}`;
  return el;
}
function makeSLabel(text,extraHTML=''){
  const el=document.createElement('div');el.className='sec-label';
  el.innerHTML=`<span>${text}</span>${extraHTML}`;return el;
}
function buildDMItems(container){
  const partners=FortizedSocial.getRecentDMPartners(CU.username);
  if(partners.length===0){
    const e=document.createElement('div');
    e.style.cssText='padding:9px 12px;font-size:12px;color:var(--muted);';
    e.textContent='No DMs yet.';container.appendChild(e);return;
  }
  partners.forEach((partner,i)=>{
    const msgs=FortizedSocial.getDMMessages(CU.username,partner);
    const last=msgs[msgs.length-1];
    const pUser=FortizedSocial.getUserByName(partner);
    const status=FortizedSocial.getStatus(partner);
    const el=document.createElement('div');
    el.className='friend-item'+(curDM===partner?' active':'');
    const avDiv=buildAvatar(pUser||{username:partner},28,true);
    el.appendChild(avDiv);
    const info=document.createElement('div');info.className='fi-info';
    info.innerHTML=`<div class="fi-name">${partner}</div><div class="fi-sub">${last?escapeHTML(last.text.slice(0,24))+'â€¦':'No messages yet'}</div>`;
    el.appendChild(info);
    el.onclick=()=>openDMChat(partner);
    container.appendChild(el);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HOME LANDING â€” POLYTORIA STYLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHomeLanding(){
  const area=document.getElementById('home-content');
  if(!area)return;
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
  const pending=(CU.friendRequestsReceived||[]).length;
  area.innerHTML=`
    <!-- Hero Banner -->
    <div class="home-banner">
      <img class="banner-img" src="Fortized banner.png" onerror="this.style.display='none'" alt="">
      <div class="banner-overlay">
        <div class="banner-text">
          <h2>Welcome back, ${escapeHTML(CU.displayName||CU.username)}!</h2>
          <p>Ready to storm the fortress?${hasRadiance?` <span class="radiance-badge">âœ¨ Radiance Active</span>`:''}</p>
        </div>
      </div>
      <img class="knight-img" src="Fortized Knight.png" onerror="this.style.display='none'" alt="">
    </div>

    <div class="home-main-scroll">
      <!-- Quick Nav -->
      <div class="section-hdr"><h3>Quick Access</h3></div>
      <div class="quick-nav">
        <div class="qn-tile" onclick="openNewDM()">
          <div class="qn-icon" style="background:rgba(96,165,250,.1);">ğŸ’¬</div>
          <div class="qn-text"><h4>Messages</h4><p>${FortizedSocial.getRecentDMPartners(CU.username).length} open DMs</p></div>
        </div>
        <div class="qn-tile" onclick="renderFriends()">
          <div class="qn-icon" style="background:rgba(62,207,110,.1);">ğŸ‘¥</div>
          <div class="qn-text"><h4>Friends</h4><p>${(CU.friends||[]).length} friends</p></div>
          ${pending>0?`<div class="qn-badge">${pending}</div>`:''}
        </div>
        <div class="qn-tile" onclick="navigate('discover')">
          <div class="qn-icon" style="background:rgba(255,249,62,.1);">ğŸ§­</div>
          <div class="qn-text"><h4>Discover</h4><p>Find new Bastions</p></div>
        </div>
        <div class="qn-tile" onclick="navigate('atelier')">
          <div class="qn-icon" style="background:rgba(255,249,62,.08);">ğŸ’</div>
          <div class="qn-text"><h4>Atelier</h4><p>${CU.onyx} Onyx balance</p></div>
        </div>
      </div>

      <!-- Activity -->
      <div class="section-hdr" style="margin-top:6px;"><h3>Recent Activity</h3></div>
      <div class="activity-feed">
        ${CU.bastions.length===0?`<div class="activity-item"><div class="act-icon">ğŸ°</div><div class="act-text"><p>You haven't joined any Bastions yet. <strong>Discover communities!</strong></p><div class="act-time">Now</div></div></div>`
        :CU.bastions.slice(0,3).map(b=>`
          <div class="activity-item" onclick="openBastion(${CU.bastions.indexOf(b)})">
            <div class="act-icon">${b.icon}</div>
            <div class="act-text">
              <p><strong>${b.name}</strong> â€” #${b.channels?.[0]?.name||'general'}</p>
              <div class="act-time">${b.channels?.[0]?.messages?.length||0} messages</div>
            </div>
          </div>`).join('')}
      </div>

      <!-- Discover mini -->
      <div class="section-hdr" style="margin-top:6px;">
        <h3>Popular Bastions</h3>
        <a onclick="navigate('discover')">See all â†’</a>
      </div>
      <div class="mini-bastion-row">
        ${PUBLIC_BASTIONS.slice(0,4).map(b=>`
          <div class="mini-bastion">
            <div class="mb-icon">${b.icon}</div>
            <div class="mb-info">
              <div class="mb-name">${b.name}</div>
              <div class="mb-meta">ğŸ‘¥ ${b.members.toLocaleString()} Â· <span style="color:var(--green);">â— ${b.online} online</span></div>
            </div>
            <div class="mb-join" onclick="toast('Public join coming soon','info')">Join</div>
          </div>`).join('')}
      </div>
    </div>
  `;
}
function refreshHomeRight(){
  const panel=document.getElementById('home-right-panel');
  if(!panel)return;
  const notifs=FortizedSocial.getNotifications(CU.username).slice(0,6);
  let html=`<div class="rp-section"><div class="rp-title">Notifications</div>`;
  if(notifs.length===0){html+=`<div style="font-size:12px;color:var(--muted);padding:4px 0;">All caught up âœ“</div>`;}
  else{
    notifs.forEach(n=>{
      let icon='ğŸ””',text='';
      if(n.type==='friend_request'){icon='ğŸ‘¥';text=`<strong>${n.from}</strong> sent a friend request`;}
      else if(n.type==='friend_accept'){icon='ğŸ¤';text=`<strong>${n.from}</strong> accepted your request`;}
      else if(n.type==='dm'){icon='ğŸ’¬';text=`<strong>${n.from}</strong>: ${escapeHTML(n.data?.preview||'').slice(0,40)}`;}
      const actions=n.type==='friend_request'?`<div class="rn-actions">
        <button class="rn-accept" onclick="acceptFriend('${n.from}')">Accept</button>
        <button class="rn-decline" onclick="declineFriend('${n.from}')">Decline</button></div>`:'';
      html+=`<div class="rp-notif ${n.read?'':'unread'}">
        <div class="rn-icon">${icon}</div>
        <div class="rn-text"><p>${text}</p><div class="rn-time">${formatTimeAgo(n.time)}</div>${actions}</div>
      </div>`;
    });
  }
  html+=`</div>`;
  // Blog
  html+=`<div class="rp-section"><div class="rp-title">ğŸ“° Fortized Blog</div>`;
  BLOG_POSTS.forEach(p=>{
    html+=`<div class="blog-post" onclick="toast('Blog coming soon','info')">
      <div class="bp-tag">${p.tag}</div>
      <div class="bp-title">${p.title}</div>
      <div class="bp-date">${p.date}</div>
    </div>`;
  });
  html+=`</div>`;
  panel.innerHTML=html;
}
function refreshDMLeftPanel(){
  const dmList=document.getElementById('dm-list');if(!dmList)return;
  dmList.innerHTML='';buildDMItems(dmList);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FRIENDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFriends(){
  showHomeContent(`
    <div class="home-main-scroll">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;">Friends â€” ${(CU.friends||[]).length}</div>
        <button class="btn-a" onclick="openAddFriend()" style="font-size:12px;padding:7px 14px;">+ Add Friend</button>
      </div>
      ${(CU.friends||[]).length===0?`<div class="empty-state"><div class="ei">ğŸ‘¥</div><h3>No friends yet</h3><p>Add friends by exact username to start chatting.</p><button class="btn-a" onclick="openAddFriend()">Add a Friend</button></div>`
      :(CU.friends||[]).map(f=>{
        const fUser=FortizedSocial.getUserByName(f);
        const status=FortizedSocial.getStatus(f);
        const sLabel={online:'Online',away:'Away',dnd:'Do Not Disturb',offline:'Offline'}[status]||'Offline';
        const sColor={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)',offline:'var(--muted)'}[status];
        return `<div style="display:flex;align-items:center;gap:11px;padding:10px 13px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;" oncontextmenu="showFriendCtx(event,'${f}')">
          <div id="friend-av-${f}" style="position:relative;"></div>
          <div style="flex:1;">
            <div style="font-size:13px;font-weight:700;">${escapeHTML(fUser?.displayName||f)}</div>
            <div style="font-size:11.5px;color:${sColor};">â— ${sLabel}</div>
          </div>
          <div style="display:flex;gap:6px;">
            <button class="btn-g" onclick="openDMChat('${f}')" style="font-size:12px;padding:5px 12px;">ğŸ’¬ Message</button>
            <button class="btn-g" onclick="removeFriend('${f}')" style="font-size:12px;padding:5px;border-color:rgba(248,113,113,.2);color:var(--red);">âœ•</button>
          </div>
        </div>`;
      }).join('')}
    </div>
  `);
  // Inject avatars
  setTimeout(()=>{
    (CU.friends||[]).forEach(f=>{
      const container=document.getElementById('friend-av-'+f);
      if(!container)return;
      const fUser=FortizedSocial.getUserByName(f)||{username:f};
      const av=buildAvatar(fUser,36,true);
      container.appendChild(av);
    });
  },0);
}
function renderPending(){
  const incoming=CU.friendRequestsReceived||[];
  const outgoing=CU.friendRequestsSent||[];
  showHomeContent(`
    <div class="home-main-scroll">
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:16px;">Pending Requests</div>
      ${incoming.length===0&&outgoing.length===0?`<div class="empty-state"><div class="ei">ğŸ“¥</div><h3>All clear!</h3><p>No pending friend requests.</p></div>`:``}
      ${incoming.length>0?`<div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:7px;">Incoming â€” ${incoming.length}</div>
      ${incoming.map(from=>`
        <div style="display:flex;align-items:center;gap:11px;padding:10px 13px;background:var(--panel);border:1px solid rgba(255,249,62,.1);border-radius:10px;margin-bottom:6px;">
          <div style="width:36px;height:36px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;">${from[0].toUpperCase()}</div>
          <div style="flex:1;"><div style="font-size:13px;font-weight:700;">${from}</div><div style="font-size:11px;color:var(--muted);">Wants to be friends</div></div>
          <div style="display:flex;gap:6px;">
            <button class="btn-a" onclick="acceptFriend('${from}')" style="font-size:12px;padding:6px 13px;">âœ“ Accept</button>
            <button class="btn-g" onclick="declineFriend('${from}')" style="font-size:12px;padding:6px;color:var(--red);border-color:rgba(248,113,113,.2);">âœ•</button>
          </div>
        </div>`).join('')}`:``}
      ${outgoing.length>0?`<div style="font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:14px;margin-bottom:7px;">Sent â€” ${outgoing.length}</div>
      ${outgoing.map(to=>`
        <div style="display:flex;align-items:center;gap:11px;padding:10px 13px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:6px;opacity:.7;">
          <div style="width:36px;height:36px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;">${to[0].toUpperCase()}</div>
          <div style="flex:1;"><div style="font-size:13px;font-weight:700;">${to}</div><div style="font-size:11px;color:var(--muted);">Request pendingâ€¦</div></div>
          <button class="btn-g" onclick="cancelFriendReq('${to}')" style="font-size:12px;padding:6px 12px;">Cancel</button>
        </div>`).join('')}`:``}
    </div>
  `);
}
function showHomeContent(html){
  const c=document.getElementById('home-content');if(c)c.innerHTML=html;
}

// Friend actions
function openAddFriend(){
  document.getElementById('af-input').value='';
  document.getElementById('af-error').textContent='';
  document.getElementById('af-success').textContent='';
  openModal('modal-add-friend');
}
function sendFriendReq(){
  const name=document.getElementById('af-input').value.trim();
  document.getElementById('af-error').textContent='';
  document.getElementById('af-success').textContent='';
  if(!name){document.getElementById('af-error').textContent='Enter a username.';return;}
  const result=FortizedSocial.sendFriendRequest(CU.username,name);
  if(result.ok){
    document.getElementById('af-success').textContent=result.msg;
    document.getElementById('af-input').value='';
    refreshCU();FortizedSocial.playNotificationSound();
    setTimeout(()=>updateNotifBadge(),200);
  } else {
    document.getElementById('af-error').textContent=result.msg;
  }
}
function acceptFriend(from){
  const result=FortizedSocial.acceptFriendRequest(CU.username,from);
  if(result.ok){refreshCU();toast(result.msg,'success');FortizedSocial.playNotificationSound();renderPending();setSidebar('home');}
  else toast(result.msg,'error');
}
function declineFriend(from){
  FortizedSocial.declineFriendRequest(CU.username,from);refreshCU();toast('Request declined','info');renderPending();
}
function cancelFriendReq(to){
  const users=JSON.parse(localStorage.getItem('fortized_users'))||[];
  const mi=users.findIndex(u=>u.username===CU.username);
  const ti=users.findIndex(u=>u.username===to);
  if(mi!==-1)users[mi].friendRequestsSent=(users[mi].friendRequestsSent||[]).filter(u=>u!==to);
  if(ti!==-1)users[ti].friendRequestsReceived=(users[ti].friendRequestsReceived||[]).filter(u=>u!==CU.username);
  localStorage.setItem('fortized_users',JSON.stringify(users));
  refreshCU();toast(`Request to ${to} cancelled`,'info');renderPending();
}
function removeFriend(f){
  if(!confirm(`Remove ${f} as a friend?`))return;
  FortizedSocial.removeFriend(CU.username,f);refreshCU();toast('Friend removed','info');renderFriends();
}
function showFriendCtx(e,username){
  e.preventDefault();
  showCtxMenu(e.clientX,e.clientY,[
    {label:'ğŸ’¬ Message',action:()=>openDMChat(username)},
    {label:'ğŸ‘¤ View Profile',action:()=>viewUserProfile(username)},
    {sep:true},
    {label:'ğŸ—‘ï¸ Remove Friend',action:()=>removeFriend(username),danger:true},
  ]);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openNewDM(){
  document.getElementById('dm-username-input').value='';
  document.getElementById('dm-error').textContent='';
  openModal('modal-new-dm');
}
function startDM(){
  const name=document.getElementById('dm-username-input').value.trim();
  if(!name){document.getElementById('dm-error').textContent='Enter a username.';return;}
  if(name===CU.username){document.getElementById('dm-error').textContent="Can't DM yourself!";return;}
  const users=JSON.parse(localStorage.getItem('fortized_users'))||[];
  if(!users.find(u=>u.username===name)){document.getElementById('dm-error').textContent='User not found.';return;}
  closeModal('modal-new-dm');
  if(curView!=='home'){navigate('home');setTimeout(()=>openDMChat(name),100);}
  else openDMChat(name);
}
function openDMChat(partner){
  curDM=partner;
  refreshDMLeftPanel();
  const pUser=FortizedSocial.getUserByName(partner)||{username:partner};
  const status=FortizedSocial.getStatus(partner);
  const sText={online:'â— Online',away:'â— Away',dnd:'â— Do Not Disturb',offline:'â— Offline'}[status]||'â— Offline';
  setTopbar('ğŸ’¬',escapeHTML(pUser.displayName||partner),sText);
  const msgs=FortizedSocial.getDMMessages(CU.username,partner);
  const area=document.getElementById('home-content');
  if(!area)return;
  area.innerHTML=`
    <div class="chat-wrap">
      <div class="chat-msgs" id="chat-msgs">
        <div class="chat-welcome">
          <div class="w-av" id="dm-welcome-av"></div>
          <h3>${escapeHTML(pUser.displayName||partner)}</h3>
          <p>Beginning of your direct message history with <strong>${escapeHTML(partner)}</strong>.</p>
        </div>
        ${renderMsgs(msgs,null,null)}
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button title="Attach" onclick="toast('File upload soon','info')">ğŸ“</button>
            <button title="Emoji" onclick="toast('Emoji picker soon','info')">ğŸ˜Š</button>
          </div>
          <textarea id="dm-input" placeholder="Message ${escapeHTML(pUser.displayName||partner)}" rows="1"
            onkeydown="dmKey(event,'${partner}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendDM('${partner}')">â¤</button>
        </div>
      </div>
    </div>
  `;
  // Inject welcome avatar
  setTimeout(()=>{
    const wavEl=document.getElementById('dm-welcome-av');
    if(wavEl){const av=buildAvatar(pUser,54);av.style.borderRadius='50%';wavEl.replaceWith(av);}
  },0);
  scrollBottom('chat-msgs');
  // Highlight in DM list
  document.querySelectorAll('#dm-list .friend-item').forEach(el=>{
    el.classList.toggle('active',el.querySelector('.fi-name')?.textContent===partner);
  });
}
function sendDM(partner){
  const input=document.getElementById('dm-input');
  const text=input?.value.trim();if(!text)return;
  FortizedSocial.sendDMMessage(CU.username,partner,text);
  input.value='';input.style.height='';
  openDMChat(partner);
}
function dmKey(e,partner){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendDM(partner);}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderMsgs(msgs,bastionIdx,chId){
  if(!msgs||msgs.length===0)return'';
  let html='';let lastDate='';
  msgs.forEach((m,i)=>{
    const isOwn=m.from===CU.username;
    const prev=msgs[i-1];
    const isCont=prev&&prev.from===m.from&&!prevDateChanged(prev,m);
    const mDate=m.timestamp?new Date(m.timestamp).toLocaleDateString():'';
    if(mDate&&mDate!==lastDate){html+=`<div class="date-div">${mDate}</div>`;lastDate=mDate;}
    const reactions=m.reactions||{};
    const rHTML=Object.entries(reactions).map(([emoji,users])=>{
      const mine=users.includes(CU.username);
      return `<div class="r-pill ${mine?'mine':''}" onclick="handleReaction('${m.id||''}','${emoji}','${bastionIdx}','${chId||''}')" title="${users.join(', ')}">${emoji} <span class="r-count">${users.length}</span></div>`;
    }).join('');
    // Get sender's user object for pfp
    const senderUser=isOwn?CU:(FortizedSocial.getUserByName(m.from)||{username:m.from});
    const avHTML=senderUser.pfp
      ?`<img src="${senderUser.pfp}" onerror="this.outerHTML='${(senderUser.displayName||m.from)[0].toUpperCase()}'">` 
      :(senderUser.displayName||m.from)[0].toUpperCase();
    const actBtns=QUICK_REACT.slice(0,4).map(e=>`<button onclick="handleReaction('${m.id||''}','${e}','${bastionIdx}','${chId||''}')">${e}</button>`).join('');
    html+=`
      <div class="msg-group ${isOwn?'own':''} ${isCont?'msg-cont':''}" data-id="${m.id||''}">
        <div class="msg-av" onclick="viewUserProfile('${m.from}')">${avHTML}</div>
        <div class="msg-body">
          <div class="msg-meta">
            <span class="msg-author" onclick="viewUserProfile('${m.from}')">${escapeHTML(senderUser.displayName||m.from)}</span>
            <span class="msg-time">${m.time||''}</span>
          </div>
          <div class="msg-bubble">${parseMD(escapeHTML(m.text))}</div>
          ${rHTML?`<div class="msg-reactions">${rHTML}</div>`:''}
        </div>
        <div class="msg-acts">${actBtns}</div>
      </div>`;
  });
  return html;
}
function prevDateChanged(a,b){
  if(!a.timestamp||!b.timestamp)return false;
  return new Date(a.timestamp).toLocaleDateString()!==new Date(b.timestamp).toLocaleDateString();
}
function handleReaction(msgId,emoji,bastionIdx,chId){
  if(bastionIdx&&bastionIdx!=='null'){
    const key=bastionIdx+'_'+CU.username;
    FortizedSocial.addReaction(key,chId,msgId,emoji,CU.username);
    openChannel(parseInt(bastionIdx),curChannel);
  } else {
    toast(emoji+' reaction!','info');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BASTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openBastion(idx){
  curBastion=idx;curChannel=null;
  const b=CU.bastions[idx];
  if(!b.channels||b.channels.length===0){
    b.channels=[{name:'general',id:'general',messages:[]},{name:'announcements',id:'announcements',messages:[]}];
    saveUser();
  }
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((el,i)=>el.classList.toggle('active',i===idx));
  ['home','discover','atelier','profile'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  const bv=document.getElementById('view-bastion');bv.style.display='flex';bv.classList.add('active');
  setSidebar('bastion');setTopbar('ğŸ°',b.name,b.desc||`Welcome to ${b.name}`);
  document.getElementById('member-list-btn').style.display='flex';
  openChannel(idx,0);
}
function openChannel(bIdx,cIdx){
  curBastion=bIdx;curChannel=cIdx;
  const b=CU.bastions[bIdx];const ch=b.channels[cIdx];
  const chId=ch.id||ch.name;
  setTopbar('#',ch.name,`${b.name} â€º #${ch.name}`);
  document.querySelectorAll('.ch-item').forEach((el,i)=>el.classList.toggle('active',i===cIdx));
  // Use shared messages or fallback to local
  const sharedMsgs=FortizedSocial.getBastionChannelMessages(bIdx+'_'+CU.username,chId);
  const localMsgs=ch.messages||[];
  const allMsgs=sharedMsgs.length>0?sharedMsgs:localMsgs;
  const main=document.getElementById('bastion-main');
  main.innerHTML=`
    <div class="chat-wrap">
      <div class="chat-msgs" id="b-msgs">
        <div class="chat-welcome">
          <div class="w-av" style="border-radius:12px;font-size:17px;">#</div>
          <h3>#${ch.name}</h3>
          <p>Beginning of <strong>#${ch.name}</strong>. Say hello!</p>
        </div>
        ${renderMsgs(allMsgs,bIdx,chId)}
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button onclick="toast('File upload soon','info')">ğŸ“</button>
            <button onclick="toast('Emoji soon','info')">ğŸ˜Š</button>
          </div>
          <textarea id="b-input" placeholder="Message #${ch.name}" rows="1"
            onkeydown="bKey(event,${bIdx},'${chId}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendBMsg(${bIdx},'${chId}')">â¤</button>
        </div>
      </div>
    </div>
  `;
  scrollBottom('b-msgs');
  if(memberListOpen)buildMemberList(bIdx);
}
function sendBMsg(bIdx,chId){
  const input=document.getElementById('b-input');const text=input?.value.trim();if(!text)return;
  const key=bIdx+'_'+CU.username;
  FortizedSocial.sendBastionChannelMessage(key,chId,CU.username,text);
  const b=CU.bastions[bIdx];const ch=b.channels.find(c=>(c.id||c.name)===chId);
  if(ch){
    if(!ch.messages)ch.messages=[];
    const now=new Date();
    ch.messages.push({id:Date.now().toString(36),from:CU.username,text,time:now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}),timestamp:now.toISOString(),reactions:{}});
    saveUser();
  }
  input.value='';input.style.height='';openChannel(bIdx,curChannel);
}
function bKey(e,bIdx,chId){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBMsg(bIdx,chId);}}
function addChannel(bIdx){
  const name=prompt('Channel name:');if(!name?.trim())return;
  const clean=name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  if(!clean){toast('Invalid name','error');return;}
  if(CU.bastions[bIdx].channels.find(c=>c.name===clean)){toast('Channel exists','error');return;}
  CU.bastions[bIdx].channels.push({name:clean,id:clean,messages:[]});
  saveUser();setSidebar('bastion');toast('#'+clean+' created!','success');
}
function deleteChannel(bIdx,cIdx){
  if(CU.bastions[bIdx].channels.length<=1){toast("Can't delete the last channel",'error');return;}
  CU.bastions[bIdx].channels.splice(cIdx,1);saveUser();setSidebar('bastion');openChannel(bIdx,0);toast('Channel deleted','info');
}
function buildMemberList(bIdx){
  const el=document.getElementById('member-list');if(!el)return;
  const b=CU.bastions[bIdx];const members=b.members||[CU.username];
  let html=`<div class="ml-header">Members â€” ${members.length}</div>`;
  members.forEach(m=>{
    const mUser=FortizedSocial.getUserByName(m)||{username:m};
    const status=FortizedSocial.getStatus(m);
    html+=`<div class="ml-entry" id="ml-av-${m}" onclick="viewUserProfile('${m}')">
      <div class="ml-av" id="ml-av-img-${m}">
        ${mUser.pfp?`<img src="${mUser.pfp}" onerror="this.outerHTML='${m[0].toUpperCase()}'">`:m[0].toUpperCase()}
        <div class="ml-status ${status}"></div>
      </div>
      <div class="ml-name">${escapeHTML(mUser.displayName||m)}${m===CU.username?' (you)':''}</div>
    </div>`;
  });
  el.innerHTML=html;
}
function toggleMemberList(){
  memberListOpen=!memberListOpen;
  const el=document.getElementById('member-list');
  if(el){el.style.display=memberListOpen?'flex':'none';if(memberListOpen&&curBastion!==null)buildMemberList(curBastion);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CREATE BASTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEmojiPicker(){
  const p=document.getElementById('bastion-emoji-picker');if(!p)return;
  p.innerHTML='';
  EMOJIS.forEach(e=>{
    const btn=document.createElement('div');btn.className='emoji-opt';btn.textContent=e;
    btn.onclick=()=>{p.querySelectorAll('.emoji-opt').forEach(d=>d.classList.remove('sel'));btn.classList.add('sel');p.dataset.selected=e;};
    p.appendChild(btn);
  });
  p.dataset.selected=EMOJIS[0];p.querySelector('.emoji-opt').classList.add('sel');
}
function openCreateBastion(){
  document.getElementById('bastion-name-input').value='';
  document.getElementById('bastion-desc-input').value='';
  document.getElementById('create-error').textContent='';
  buildEmojiPicker();openModal('modal-create-bastion');
}
function createBastion(){
  const name=document.getElementById('bastion-name-input').value.trim();
  const desc=document.getElementById('bastion-desc-input').value.trim();
  const icon=document.getElementById('bastion-emoji-picker').dataset.selected||'ğŸ°';
  if(!name){document.getElementById('create-error').textContent='Name is required.';return;}
  CU.bastions.push({
    name,desc,icon,
    channels:[{name:'general',id:'general',messages:[]},{name:'announcements',id:'announcements',messages:[]},{name:'off-topic',id:'off-topic',messages:[]}],
    members:[CU.username],owner:CU.username,createdAt:new Date().toISOString()
  });
  saveUser();closeModal('modal-create-bastion');buildRailBastions();
  toast(`${icon} ${name} created!`,'success');openBastion(CU.bastions.length-1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISCOVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDiscoverGrid(){renderDiscGrid(PUBLIC_BASTIONS);}
function setDiscTab(tab,el){
  discTab=tab;document.querySelectorAll('.disc-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');filterBastions();
}
function filterBastions(){
  const q=document.getElementById('disc-input')?.value.toLowerCase()||'';
  let f=PUBLIC_BASTIONS;
  if(discTab!=='all')f=f.filter(b=>b.category===discTab);
  if(q)f=f.filter(b=>b.name.toLowerCase().includes(q)||b.desc.toLowerCase().includes(q));
  renderDiscGrid(f);
}
function renderDiscGrid(list){
  const grid=document.getElementById('bastion-grid');if(!grid)return;
  if(!list.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:36px;color:var(--muted);">No bastions found.</div>';return;}
  grid.innerHTML=list.map(b=>`
    <div class="bc">
      <div class="bc-banner">${b.icon}</div>
      <div class="bc-body">
        <div class="bc-meta"><div class="bc-icon">${b.icon}</div><div class="bc-name">${b.name}</div></div>
        <div class="bc-desc">${b.desc}</div>
        <div class="bc-stats"><span>ğŸ‘¥ ${b.members.toLocaleString()}</span><span style="color:var(--green);">â— ${b.online} online</span></div>
        <div class="bc-tags">${(b.tags||[]).map(t=>`<span class="bc-tag">${t}</span>`).join('')}</div>
        <button class="btn-a" style="width:100%;justify-content:center;margin-top:9px;font-size:12px;padding:7px;" onclick="toast('Public join coming soon!','info')">Join Bastion</button>
      </div>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATELIER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDailyBtn(){
  const btn=document.getElementById('daily-btn');const st=document.getElementById('daily-status');
  if(!btn||!st)return;
  const today=new Date().toDateString();
  if(CU.lastDaily===today){btn.classList.add('claimed');st.textContent='Claimed âœ“';}
  else{btn.classList.remove('claimed');st.textContent='Claim now â†’';}
}
function claimDaily(){
  const today=new Date().toDateString();
  if(CU.lastDaily===today){toast('Already claimed today!','info');return;}
  CU.onyx+=5;CU.lastDaily=today;saveUser();updateOnyxDisplay();updateDailyBtn();
  toast('+5 Onyx claimed! ğŸ’','success');FortizedSocial.playNotificationSound();
}
function buyRadiance(cost,label){
  pendingBuy={cost,label};
  document.getElementById('buy-title').textContent=`Activate Radiance â€” ${label}?`;
  document.getElementById('buy-sub').textContent=`This will deduct ${cost} Onyx. You have ${CU.onyx} Onyx.`;
  openModal('modal-buy');
}
function confirmBuy(){
  if(!pendingBuy)return;
  if(CU.onyx<pendingBuy.cost){toast('Not enough Onyx!','error');closeModal('modal-buy');return;}
  CU.onyx-=pendingBuy.cost;
  const days=pendingBuy.label.includes('30')?30:pendingBuy.label.includes('7')?7:1;
  const exp=new Date();exp.setDate(exp.getDate()+days);
  CU.radianceUntil=exp.toISOString();saveUser();updateOnyxDisplay();
  closeModal('modal-buy');toast(`âœ¨ Radiance activated for ${pendingBuy.label}!`,'success');
  FortizedSocial.playNotificationSound();pendingBuy=null;renderHomeLanding();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PROFILE â€” FULL IMPLEMENTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildProfileView(tab){
  profileTab=tab||profileTab;
  // Build sidebar nav
  const nav=document.getElementById('profile-sidebar-nav');
  if(nav){
    nav.innerHTML='';
    const tabs=[
      {i:'ğŸ‘¤',l:'My Profile',t:'myprofile'},
      {i:'âœï¸',l:'Edit Profile',t:'editprofile'},
      {i:'ğŸ”’',l:'Privacy',t:'privacy'},
      {i:'ğŸ””',l:'Notifications',t:'notifications'},
      {i:'ğŸ¨',l:'Appearance',t:'appearance'},
    ];
    tabs.forEach(({i,l,t})=>{
      const el=document.createElement('div');
      el.className='profile-sidebar-item'+(profileTab===t?' active':'');
      el.innerHTML=`<span>${i}</span><span>${l}</span>`;
      el.onclick=()=>buildProfileView(t);
      nav.appendChild(el);
    });
    // Danger zone
    const sep=document.createElement('div');sep.style.cssText='flex:1;';nav.appendChild(sep);
    const lo=document.createElement('div');lo.className='profile-sidebar-item';
    lo.innerHTML=`<span>ğŸšª</span><span style="color:var(--red);">Log Out</span>`;
    lo.onclick=logout;nav.appendChild(lo);
  }
  // Render the right content
  const main=document.getElementById('profile-main-content');
  if(!main)return;
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
  if(profileTab==='myprofile'){
    main.innerHTML=`
      <div class="profile-card-top">
        <div class="profile-banner-img">
          ${hasRadiance&&CU.banner
            ?`<img src="${CU.banner}" onerror="this.src='Profile Banner.png'">`
            :`<img src="Profile Banner.png" onerror="this.style.background='linear-gradient(135deg,#0f1830,#1a0f30,#0f2030)'">`}
          <div class="banner-edit-btn" onclick="buildProfileView('editprofile')">Edit Banner</div>
        </div>
        <div class="profile-av-row">
          <div class="profile-av-big" id="pab" onclick="buildProfileView('editprofile')"></div>
          <div class="profile-info">
            <div class="profile-display-name">${escapeHTML(CU.displayName||CU.username)}</div>
            <div class="profile-username">@${CU.username}</div>
            ${hasRadiance?`<div class="radiance-badge">âœ¨ Radiance Active â€” ${new Date(CU.radianceUntil).toLocaleDateString()}</div>`:''}
          </div>
          <div style="display:flex;gap:8px;padding-bottom:4px;">
            <button class="btn-g" onclick="buildProfileView('editprofile')" style="font-size:12px;padding:7px 13px;">âœï¸ Edit</button>
          </div>
        </div>
      </div>
      <div class="profile-content-area">
        <div class="profile-stats-row">
          <div class="ps-stat"><div class="ps-val">${CU.onyx}</div><div class="ps-key">Onyx</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.friends||[]).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.bastions.length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val" style="font-size:16px;">${hasRadiance?'âœ¨':'â€”'}</div><div class="ps-key">Radiance</div></div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Account Info</div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ‘¤</span><div class="st"><div class="sl">Username</div><div class="ss">@${CU.username}</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">ğŸ“§</span><div class="st"><div class="sl">Email</div><div class="ss">${CU.email||'Not set'}</div></div></div>
        </div>
      </div>`;
    // inject avatar
    setTimeout(()=>{const pab=document.getElementById('pab');if(pab){const av=buildAvatar(CU,72);av.style.cssText='border:4px solid var(--bg);cursor:pointer;flex-shrink:0;';pab.replaceWith(av);}},0);
  } else if(profileTab==='editprofile'){
    main.innerHTML=`<div class="profile-content-area" style="padding-top:24px;">
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:20px;">Edit Profile</div>
      <!-- Profile Picture -->
      <div class="settings-section">
        <div class="settings-title">Profile Picture</div>
        <div style="display:flex;align-items:center;gap:14px;padding:14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;">
          <div id="edit-av-preview" style="width:60px;height:60px;border-radius:50%;background:var(--panel2);border:2px solid var(--border);font-size:22px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;"></div>
          <div>
            <div style="font-size:13px;font-weight:600;margin-bottom:4px;">Upload a profile picture</div>
            <div style="font-size:12px;color:var(--muted-light);margin-bottom:8px;">PNG, JPG under 5MB</div>
            <label style="cursor:pointer;" class="btn-g" style="font-size:12px;padding:6px 13px;">
              ğŸ“· Choose File
              <input type="file" accept="image/*" onchange="handlePfpUpload(event)" style="display:none;">
            </label>
            ${CU.pfp?`<button class="btn-d" onclick="removePfp()" style="font-size:12px;padding:6px 12px;margin-left:6px;">Remove</button>`:''}
          </div>
        </div>
      </div>
      <!-- Display Name -->
      <div class="settings-section">
        <div class="settings-title">Display Name</div>
        <div class="field-group">
          <input class="field-input" id="edit-displayname" value="${escapeHTML(CU.displayName||CU.username)}" placeholder="Your display name" maxlength="32">
          <div class="field-hint">This is shown instead of your username in messages.</div>
        </div>
      </div>
      <!-- Email -->
      <div class="settings-section">
        <div class="settings-title">Email Address</div>
        <div class="field-group">
          <input class="field-input" id="edit-email" value="${CU.email||''}" placeholder="your@email.com" type="email">
        </div>
      </div>
      <!-- Password -->
      <div class="settings-section">
        <div class="settings-title">Change Password</div>
        <div class="field-group">
          <input class="field-input" id="edit-pass-cur" placeholder="Current password" type="password">
        </div>
        <div class="field-group">
          <input class="field-input" id="edit-pass-new" placeholder="New password" type="password">
        </div>
        <div class="field-group">
          <input class="field-input" id="edit-pass-conf" placeholder="Confirm new password" type="password">
        </div>
      </div>
      ${hasRadiance?`
      <!-- Custom Banner (Radiance only) -->
      <div class="settings-section">
        <div class="settings-title">Profile Banner <span class="radiance-badge" style="margin-left:6px;">âœ¨ Radiance Only</span></div>
        <div style="padding:14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;">
          ${CU.banner?`<img src="${CU.banner}" style="width:100%;height:80px;object-fit:cover;border-radius:7px;margin-bottom:10px;" onerror="this.style.display='none'">`:``}
          <label style="cursor:pointer;" class="btn-g" style="font-size:12px;padding:6px 13px;">
            ğŸ–¼ Upload Banner
            <input type="file" accept="image/*" onchange="handleBannerUpload(event)" style="display:none;">
          </label>
          ${CU.banner?`<button class="btn-d" onclick="removeBanner()" style="font-size:12px;padding:6px 12px;margin-left:6px;">Remove</button>`:''}
        </div>
      </div>`:`
      <div class="settings-section">
        <div class="s-row" style="cursor:default;background:rgba(255,249,62,.04);border-color:rgba(255,249,62,.1);">
          <span class="si">ğŸ–¼</span>
          <div class="st"><div class="sl">Custom Profile Banner</div><div class="ss">Unlock with âœ¨ Radiance</div></div>
          <button class="btn-a" onclick="navigate('atelier')" style="font-size:11px;padding:5px 11px;">Get Radiance</button>
        </div>
      </div>`}
      <div style="display:flex;gap:8px;margin-top:6px;">
        <button class="btn-a" onclick="saveProfileEdits()" style="font-size:13px;">Save Changes</button>
        <button class="btn-g" onclick="buildProfileView('myprofile')" style="font-size:13px;">Cancel</button>
      </div>
      <div id="edit-msg" style="margin-top:10px;font-size:12px;min-height:16px;"></div>
    </div>`;
    // Inject avatar preview
    setTimeout(()=>{
      const prev=document.getElementById('edit-av-preview');
      if(prev){const av=buildAvatar(CU,60);prev.replaceWith(av);}
    },0);
  } else if(profileTab==='privacy'){
    main.innerHTML=`<div class="profile-content-area" style="padding-top:24px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;">Privacy & Terms</div>
        <a href="privacy.html" target="_blank" class="btn-g" style="font-size:12px;padding:7px 14px;text-decoration:none;">Read Full Policy â†’</a>
      </div>
      <div style="display:flex;flex-direction:column;gap:14px;">
        <div style="background:rgba(255,249,62,.04);border:1px solid rgba(255,249,62,.1);border-radius:12px;padding:18px 20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:6px;display:flex;align-items:center;gap:8px;">
            <img src="FortizedSecurity logo.png" style="width:20px;height:20px;object-fit:contain;" onerror="this.outerHTML='ğŸ›¡ï¸'"> Your Data is Protected
          </div>
          <div style="font-size:13px;color:var(--muted-light);line-height:1.7;">
            Your data is stored locally on your device. Fortized does not transmit personal information to external servers. Profile pictures and account details are saved in your browser's local storage.
          </div>
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px 20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px;">ğŸ“œ Terms of Use</div>
          <div style="font-size:13px;color:var(--muted-light);line-height:1.7;">
            By using Fortized you agree to use the platform respectfully and lawfully. You may not use Fortized to harass, impersonate, or harm other users. Accounts found in violation may be suspended or permanently banned without notice.
          </div>
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px 20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px;">ğŸ° Community Standards</div>
          <div style="font-size:13px;color:var(--muted-light);line-height:1.7;">
            All users are expected to maintain a respectful environment. Hate speech, threats, and spam are strictly prohibited. Fortized reserves the right to remove content that violates these standards.
          </div>
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:18px 20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px;">ğŸ“ Changes to Terms</div>
          <div style="font-size:13px;color:var(--muted-light);line-height:1.7;">
            These terms may be updated at any time. Continued use of the platform constitutes acceptance of any revised terms.
          </div>
        </div>
        <a href="privacy.html" target="_blank" class="btn-a" style="align-self:flex-start;font-size:13px;">Read Full Privacy Policy â†’</a>
      </div>
    </div>`;
  } else if(profileTab==='notifications'){
    main.innerHTML=`<div class="profile-content-area" style="padding-top:24px;">
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:20px;">Notifications</div>
      <div class="settings-section">
        <div class="settings-title">Message Notifications</div>
        <div class="s-row"><span class="si">ğŸ’¬</span><div class="st"><div class="sl">Direct Messages</div><div class="ss">Notify for new DMs</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ğŸ“£</span><div class="st"><div class="sl">Bastion Messages</div><div class="ss">Notify for channel messages</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ğŸ“Œ</span><div class="st"><div class="sl">Mentions</div><div class="ss">Notify when you're mentioned</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Social</div>
        <div class="s-row"><span class="si">ğŸ‘¥</span><div class="st"><div class="sl">Friend Requests</div><div class="ss">Notify for incoming requests</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ğŸ¤</span><div class="st"><div class="sl">Friend Accepted</div><div class="ss">Notify when request is accepted</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Sounds</div>
        <div class="s-row"><span class="si">ğŸ””</span><div class="st"><div class="sl">Notification Sound</div><div class="ss">Play a sound for notifications</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ğŸµ</span><div class="st"><div class="sl">Message Sound</div><div class="ss">Play a sound for new messages</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
    </div>`;
  } else if(profileTab==='appearance'){
    main.innerHTML=`<div class="profile-content-area" style="padding-top:24px;">
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:20px;">Appearance</div>
      <div class="settings-section">
        <div class="settings-title">Theme</div>
        <div class="s-row active" style="border-color:rgba(255,249,62,.2);"><span class="si">ğŸŒ‘</span><div class="st"><div class="sl">Dark (Default)</div><div class="ss">The Fortized fortress aesthetic</div></div><span style="color:var(--accent);font-size:12px;">âœ“ Active</span></div>
        <div class="s-row" style="opacity:.5;cursor:not-allowed;"><span class="si">â˜€ï¸</span><div class="st"><div class="sl">Light</div><div class="ss">Coming soon</div></div><span style="font-size:11px;color:var(--muted);">Soon</span></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Message Display</div>
        <div class="s-row"><span class="si">ğŸ’¬</span><div class="st"><div class="sl">Compact Mode</div><div class="ss">Show more messages at once</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ğŸ–¼</span><div class="st"><div class="sl">Show Avatars</div><div class="ss">Display user avatars in chat</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">â°</span><div class="st"><div class="sl">24-Hour Time</div><div class="ss">Use 24h format for timestamps</div></div><div class="toggle" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Status</div>
        <div class="s-row" onclick="setStatus('online')" id="st-online"><span class="si" style="color:var(--green);">â—</span><div class="st"><div class="sl">Online</div><div class="ss">Show as online</div></div></div>
        <div class="s-row" onclick="setStatus('away')" id="st-away"><span class="si" style="color:var(--yellow);">â—</span><div class="st"><div class="sl">Away</div><div class="ss">Show as away</div></div></div>
        <div class="s-row" onclick="setStatus('dnd')" id="st-dnd"><span class="si" style="color:var(--red);">â—</span><div class="st"><div class="sl">Do Not Disturb</div><div class="ss">Suppress notifications</div></div></div>
        <div class="s-row" onclick="setStatus('invisible')"><span class="si" style="color:var(--muted);">â—</span><div class="st"><div class="sl">Invisible</div><div class="ss">Appear offline</div></div></div>
      </div>
    </div>`;
  }
}

// Profile edit handlers
function handlePfpUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('File too large (max 5MB)','error');return;}
  const reader=new FileReader();
  reader.onload=(ev)=>{
    CU.pfp=ev.target.result;saveUser();
    updateAvatarEl(document.getElementById('ua'),CU);
    buildProfileView('editprofile');toast('Profile picture updated!','success');
  };
  reader.readAsDataURL(file);
}
function removePfp(){CU.pfp=null;saveUser();updateAvatarEl(document.getElementById('ua'),CU);buildProfileView('editprofile');toast('Profile picture removed','info');}
function handleBannerUpload(e){
  const file=e.target.files[0];if(!file)return;
  if(file.size>5*1024*1024){toast('File too large (max 5MB)','error');return;}
  const reader=new FileReader();
  reader.onload=(ev)=>{CU.banner=ev.target.result;saveUser();buildProfileView('editprofile');toast('Banner updated!','success');};
  reader.readAsDataURL(file);
}
function removeBanner(){CU.banner=null;saveUser();buildProfileView('editprofile');toast('Banner removed','info');}
function saveProfileEdits(){
  const displayName=document.getElementById('edit-displayname')?.value.trim();
  const email=document.getElementById('edit-email')?.value.trim();
  const passCur=document.getElementById('edit-pass-cur')?.value;
  const passNew=document.getElementById('edit-pass-new')?.value;
  const passConf=document.getElementById('edit-pass-conf')?.value;
  const msg=document.getElementById('edit-msg');
  if(displayName&&displayName.length>0){CU.displayName=displayName;}
  if(email){CU.email=email;}
  // Password change
  if(passCur||passNew||passConf){
    if(!passCur||!passNew||!passConf){if(msg)msg.innerHTML='<span style="color:var(--red);">Fill all password fields.</span>';return;}
    if(CU.password&&passCur!==CU.password){if(msg)msg.innerHTML='<span style="color:var(--red);">Current password incorrect.</span>';return;}
    if(passNew!==passConf){if(msg)msg.innerHTML='<span style="color:var(--red);">Passwords don\'t match.</span>';return;}
    if(passNew.length<6){if(msg)msg.innerHTML='<span style="color:var(--red);">Password must be at least 6 characters.</span>';return;}
    CU.password=passNew;
  }
  saveUser();
  document.getElementById('ua-name').textContent=CU.displayName||CU.username;
  if(msg)msg.innerHTML='<span style="color:var(--green);">âœ“ Changes saved!</span>';
  toast('Profile updated!','success');
  setTimeout(()=>buildProfileView('myprofile'),1200);
}
function setStatus(status){
  CU.status=status;saveUser();FortizedSocial.setStatus(CU.username,status);
  const labels={online:'â— Online',away:'â— Away',dnd:'â— Do Not Disturb',invisible:'â— Invisible'};
  document.getElementById('ua-tag').textContent=labels[status]||'â— Online';
  toast(`Status: ${status}`,'info');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleNotifPanel(){
  notifPanelOpen=!notifPanelOpen;
  const panel=document.getElementById('notif-panel');
  panel.classList.toggle('open',notifPanelOpen);
  if(notifPanelOpen)buildNotifList();
}
function buildNotifList(){
  refreshCU();
  const list=document.getElementById('np-list');if(!list)return;
  const notifs=FortizedSocial.getNotifications(CU.username);
  if(!notifs.length){list.innerHTML='<div class="np-empty">âœ“ All caught up!</div>';return;}
  list.innerHTML=notifs.map(n=>{
    let icon='ğŸ””',text='';
    if(n.type==='friend_request'){icon='ğŸ‘¥';text=`<strong>${n.from}</strong> sent you a friend request`;}
    else if(n.type==='friend_accept'){icon='ğŸ¤';text=`<strong>${n.from}</strong> accepted your friend request`;}
    else if(n.type==='dm'){icon='ğŸ’¬';text=`<strong>${n.from}</strong>: ${escapeHTML(n.data?.preview||'').slice(0,40)}`;}
    const actions=n.type==='friend_request'?`<div class="np-actions">
      <button class="np-accept" onclick="acceptFriend('${n.from}');buildNotifList()">Accept</button>
      <button class="np-decline" onclick="declineFriend('${n.from}');buildNotifList()">Decline</button></div>`:'';
    return `<div class="np-item ${n.read?'':'unread'}">
      <div class="np-icon">${icon}</div>
      <div class="np-text"><p>${text}</p><div class="np-time">${formatTimeAgo(n.time)}</div>${actions}</div>
    </div>`;
  }).join('');
}
function markAllRead(){
  FortizedSocial.markNotificationsRead(CU.username);refreshCU();updateNotifBadge();buildNotifList();refreshHomeRight();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// VIEW USER PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function viewUserProfile(username){
  const user=FortizedSocial.getUserByName(username);
  if(!user){toast('User not found','error');return;}
  const isFriend=(CU.friends||[]).includes(username);
  const isOwn=username===CU.username;
  const status=FortizedSocial.getStatus(username);
  const body=document.getElementById('user-modal-body');
  body.innerHTML=`<div style="text-align:center;padding:6px 0 14px;">
    <div id="umod-av" style="margin:0 auto 10px;"></div>
    <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;">${escapeHTML(user.displayName||user.username)}</div>
    <div style="font-size:12px;color:var(--muted-light);">@${user.username}</div>
    <div style="font-size:12px;margin-top:3px;color:${status==='online'?'var(--green)':status==='away'?'var(--yellow)':status==='dnd'?'var(--red)':'var(--muted)'};">â— ${status}</div>
  </div>
  ${!isOwn?`<div style="display:flex;gap:7px;justify-content:center;margin-bottom:8px;">
    <button class="btn-g" onclick="openDMChat('${username}');closeModal('modal-user')" style="font-size:12px;padding:6px 12px;">ğŸ’¬ Message</button>
    ${isFriend?`<button class="btn-d" onclick="removeFriend('${username}');closeModal('modal-user')" style="font-size:12px;padding:6px 12px;">Remove</button>`
    :`<button class="btn-a" onclick="quickAddFriend('${username}')" style="font-size:12px;padding:6px 12px;">+ Add Friend</button>`}
  </div>`:''}
  <button class="btn-g" onclick="closeModal('modal-user')" style="width:100%;justify-content:center;font-size:12px;">Close</button>`;
  // inject avatar
  setTimeout(()=>{
    const el=document.getElementById('umod-av');
    if(el){const av=buildAvatar(user,60);av.style.borderRadius='50%';el.replaceWith(av);}
  },0);
  openModal('modal-user');
}
function quickAddFriend(username){
  const result=FortizedSocial.sendFriendRequest(CU.username,username);
  toast(result.msg,result.ok?'success':'error');
  if(result.ok){refreshCU();FortizedSocial.playNotificationSound();}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONTEXT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCtxMenu(x,y,items){
  const menu=document.getElementById('ctx-menu');menu.innerHTML='';menu.className='ctx-menu';
  items.forEach(item=>{
    if(item.sep){const s=document.createElement('div');s.className='ctx-sep';menu.appendChild(s);return;}
    if(item.disabled){const d=document.createElement('div');d.className='ctx-disabled';d.textContent=item.label;menu.appendChild(d);return;}
    const el=document.createElement('div');el.className='ctx-item'+(item.danger?' danger':'');el.textContent=item.label;
    el.onclick=(e)=>{e.stopPropagation();item.action();menu.style.display='none';};
    menu.appendChild(el);
  });
  menu.style.display='block';
  menu.style.left=Math.min(x,window.innerWidth-190)+'px';
  menu.style.top=Math.min(y,window.innerHeight-menu.offsetHeight-8)+'px';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function scrollBottom(id){setTimeout(()=>{const el=document.getElementById(id);if(el)el.scrollTop=el.scrollHeight;},60);}
function autoResize(el){el.style.height='';el.style.height=Math.min(el.scrollHeight,110)+'px';}
function parseMD(text){
  return text
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code style="background:rgba(255,255,255,.07);padding:1px 5px;border-radius:4px;font-size:12px;">$1</code>')
    .replace(/~~(.+?)~~/g,'<s>$1</s>');
}
function formatTimeAgo(iso){
  if(!iso)return'';
  const diff=Date.now()-new Date(iso).getTime();
  const m=Math.floor(diff/60000);
  if(m<1)return'just now';if(m<60)return`${m}m ago`;
  const h=Math.floor(m/60);if(h<24)return`${h}h ago`;
  return`${Math.floor(h/24)}d ago`;
}
function escapeHTML(str){return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
let toastTimer;
function toast(msg,type='info'){
  const el=document.getElementById('toast');el.textContent=msg;el.className='toast show '+type;
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}
function logout(){
  FortizedSocial.setStatus(CU.username,'offline');FortizedSocial.stopPolling();
  localStorage.removeItem('fortized_current_user');window.location.href='login.html';
}
document.querySelectorAll('.modal-overlay').forEach(o=>{o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');});});
</script>
</body>
</html>
