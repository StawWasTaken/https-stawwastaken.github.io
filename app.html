<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">
<script src="social.js"></script>
<style>
/* â”€â”€ TOKENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --accent:#fff93e;
  --accent-dim:rgba(255,249,62,.1);
  --accent-mid:rgba(255,249,62,.2);
  --accent-glow:rgba(255,249,62,.35);
  --bg:#07090e;
  --rail:#04060a;
  --sidebar:#0b0e15;
  --channel:#0d1018;
  --panel:#101420;
  --panel2:#131822;
  --panel3:#161c28;
  --border:#1c2335;
  --border-light:rgba(255,255,255,.05);
  --radius:12px;
  --muted:#4e5a6f;
  --muted-light:#7d8a9e;
  --text:#dde3ed;
  --green:#3ecf6e;
  --red:#f87171;
  --yellow:#f59e0b;
  --blue:#60a5fa;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;}
::selection{background:rgba(255,249,62,.25);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}
::-webkit-scrollbar-thumb:hover{background:#2a3650;}

/* â”€â”€ ICON RAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rail{
  width:66px;min-width:66px;
  background:var(--rail);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
  padding:12px 0;gap:4px;z-index:10;
  box-shadow:4px 0 20px rgba(0,0,0,.3);
}
.rail-logo{
  width:38px;height:38px;
  display:flex;align-items:center;justify-content:center;
  margin-bottom:6px;cursor:pointer;
}
.rail-logo img{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,249,62,.3));}
.rail-sep{width:28px;height:1px;background:var(--border);margin:6px 0;opacity:.6;}
.rail-btn{
  width:42px;height:42px;border-radius:14px;
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:background .15s,border-radius .15s;
  position:relative;flex-shrink:0;
}
.rail-btn .icon{font-size:17px;line-height:1;}
.rail-btn img{width:22px;height:22px;object-fit:contain;}
.rail-btn:hover{background:rgba(255,255,255,.07);border-radius:12px;}
.rail-btn.active{background:var(--accent-dim);border-radius:11px;}
.rail-btn.active::before{
  content:"";position:absolute;left:-13px;top:50%;transform:translateY(-50%);
  width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0;
}
.rail-btn[data-tip]:hover::after{
  content:attr(data-tip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);
  background:#0d1220;border:1px solid var(--border);color:var(--text);
  font-size:12px;font-weight:600;padding:5px 10px;border-radius:8px;
  white-space:nowrap;z-index:999;pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.rail-bastion{
  width:40px;height:40px;border-radius:14px;
  background:var(--panel);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  cursor:pointer;font-size:16px;
  transition:border-color .15s,background .15s,border-radius .15s;
  position:relative;overflow:hidden;flex-shrink:0;
}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:12px;background:var(--accent-dim);}
.rail-bastion.active::before{
  content:"";position:absolute;left:-13px;top:50%;transform:translateY(-50%);
  width:3px;height:24px;background:var(--accent);border-radius:0 3px 3px 0;
}
/* Notification badge on rail btn */
.rail-notif-badge{
  position:absolute;top:4px;right:4px;
  width:16px;height:16px;border-radius:50%;
  background:var(--red);color:#fff;
  font-size:9px;font-weight:800;
  display:flex;align-items:center;justify-content:center;
  border:2px solid var(--rail);
}

/* â”€â”€ LEFT SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar{
  width:238px;min-width:238px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
}
.sidebar-header{
  height:50px;display:flex;align-items:center;
  padding:0 14px;border-bottom:1px solid var(--border);
  font-family:'Syne',sans-serif;font-size:14px;font-weight:700;
  letter-spacing:-.1px;flex-shrink:0;gap:8px;
  background:rgba(0,0,0,.2);
}
.sidebar-header .header-actions{margin-left:auto;display:flex;gap:2px;}
.sidebar-header .header-actions button{
  width:26px;height:26px;border-radius:7px;
  background:transparent;border:none;color:var(--muted);
  font-size:15px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  transition:background .12s,color .12s;
}
.sidebar-header .header-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 0;}
.sidebar-section-label{
  font-size:10.5px;font-weight:700;letter-spacing:.1em;
  text-transform:uppercase;color:var(--muted);
  padding:12px 14px 4px;
  display:flex;align-items:center;justify-content:space-between;
}
.sidebar-section-label button{
  background:none;border:none;color:var(--muted);
  font-size:17px;cursor:pointer;line-height:1;
  width:17px;height:17px;display:flex;align-items:center;justify-content:center;
  border-radius:4px;transition:background .12s,color .12s;
}
.sidebar-section-label button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-item{
  display:flex;align-items:center;gap:9px;
  padding:6px 10px;margin:1px 6px;border-radius:7px;
  cursor:pointer;font-size:13.5px;color:var(--muted-light);
  transition:background .1s,color .1s;position:relative;
}
.sidebar-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.sidebar-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.sidebar-item .item-icon{
  width:26px;height:26px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;flex-shrink:0;overflow:hidden;
}
.sidebar-item .item-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.sidebar-item .item-badge{
  background:var(--red);color:#fff;
  font-size:9.5px;font-weight:800;padding:1px 6px;border-radius:100px;
  min-width:18px;text-align:center;flex-shrink:0;
}
.sidebar-item .item-badge.yellow{background:var(--yellow);color:#000;}

/* Channel items */
.channel-item{
  display:flex;align-items:center;gap:8px;
  padding:5px 8px;margin:1px 6px;border-radius:7px;
  cursor:pointer;font-size:13px;color:var(--muted);
  transition:background .1s,color .1s;
}
.channel-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.channel-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.channel-item .ch-icon{font-size:13px;width:15px;text-align:center;flex-shrink:0;}
.channel-item .ch-name{flex:1;}
.channel-item .ch-actions{
  display:none;gap:2px;
}
.channel-item:hover .ch-actions{display:flex;}
.channel-item .ch-actions button{
  background:none;border:none;color:var(--muted);
  font-size:12px;cursor:pointer;width:20px;height:20px;
  border-radius:4px;display:flex;align-items:center;justify-content:center;
}
.channel-item .ch-actions button:hover{color:#fff;background:rgba(255,255,255,.08);}
.channel-item .ch-unread{
  width:8px;height:8px;border-radius:50%;
  background:var(--text);margin-left:auto;flex-shrink:0;
}

/* Category header */
.category-header{
  display:flex;align-items:center;gap:6px;
  padding:10px 8px 4px 10px;
  font-size:10.5px;font-weight:700;letter-spacing:.08em;
  text-transform:uppercase;color:var(--muted);cursor:pointer;
  transition:color .12s;
}
.category-header:hover{color:var(--text);}
.category-header .cat-arrow{font-size:9px;transition:transform .15s;}
.category-header.collapsed .cat-arrow{transform:rotate(-90deg);}
.category-header button{
  margin-left:auto;background:none;border:none;color:inherit;
  cursor:pointer;font-size:14px;opacity:0;transition:opacity .12s;
  width:16px;height:16px;display:flex;align-items:center;justify-content:center;
}
.category-header:hover button{opacity:1;}

/* Friend items */
.friend-item{
  display:flex;align-items:center;gap:9px;
  padding:7px 10px;margin:1px 6px;border-radius:7px;
  cursor:pointer;transition:background .1s;
}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.friend-avatar{
  width:30px;height:30px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;overflow:hidden;position:relative;
}
.friend-avatar .f-status{
  position:absolute;bottom:-1px;right:-1px;
  width:10px;height:10px;border-radius:50%;
  border:2px solid var(--sidebar);
}
.f-status.online{background:var(--green);}
.f-status.away{background:var(--yellow);}
.f-status.dnd{background:var(--red);}
.f-status.offline{background:#374151;}
.friend-info{flex:1;min-width:0;}
.friend-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.friend-status{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â”€â”€ USER BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.userbar{
  height:54px;
  background:rgba(4,6,10,.7);
  border-top:1px solid var(--border);
  display:flex;align-items:center;
  padding:0 8px;gap:6px;flex-shrink:0;
}
.userbar-avatar{
  width:32px;height:32px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:13px;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;
}
.userbar-avatar img{width:100%;height:100%;object-fit:cover;}
.userbar-avatar .status-ring{
  position:absolute;bottom:-1px;right:-1px;
  width:11px;height:11px;border-radius:50%;
  background:var(--green);border:2px solid var(--sidebar);
}
.userbar-info{flex:1;min-width:0;}
.userbar-name{font-size:13px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.userbar-tag{font-size:10.5px;color:var(--muted);}
.userbar-actions{display:flex;gap:1px;}
.userbar-actions button{
  width:28px;height:28px;border-radius:7px;
  background:transparent;border:none;
  color:var(--muted);font-size:15px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.userbar-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}

/* â”€â”€ MAIN AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main{flex:1;min-width:0;display:flex;flex-direction:column;background:var(--bg);}

/* Top bar */
.topbar{
  height:50px;background:rgba(10,13,22,.95);
  backdrop-filter:blur(12px);
  border-bottom:1px solid var(--border);
  display:flex;align-items:center;
  padding:0 18px;gap:10px;flex-shrink:0;
  box-shadow:0 2px 20px rgba(0,0,0,.3);
  position:sticky;top:0;z-index:5;
}
.topbar-title{
  font-family:'Syne',sans-serif;font-size:14px;font-weight:700;
  display:flex;align-items:center;gap:7px;
}
.topbar-title .ch-icon{font-size:15px;color:var(--muted);}
.topbar-sep{width:1px;height:18px;background:var(--border);margin:0 2px;}
.topbar-desc{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:6px;}
.topbar-actions button{
  background:transparent;border:none;color:var(--muted);
  font-size:17px;cursor:pointer;width:32px;height:32px;
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.topbar-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{
  display:flex;align-items:center;gap:5px;
  background:var(--accent-dim);border:1px solid var(--accent-mid);
  border-radius:100px;padding:4px 11px;
  font-size:12.5px;font-weight:700;color:var(--accent);
  cursor:pointer;transition:background .15s;
}
.onyx-pill:hover{background:rgba(255,249,62,.15);}
.onyx-pill img{width:14px;height:14px;object-fit:contain;}

/* â”€â”€ CONTENT AREA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;flex-direction:column;}
.view.active{display:flex;}

/* â”€â”€ HOME VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.home-view-wrap{display:none;flex:1;}
.home-view-wrap.active{display:flex;}
.home-left{
  width:238px;min-width:238px;
  border-right:1px solid var(--border);
  display:flex;flex-direction:column;
  background:var(--channel);
}
.home-main-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}

/* â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-view{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-messages{
  flex:1;overflow-y:auto;
  padding:16px 20px;
  display:flex;flex-direction:column;gap:0;
}
.chat-welcome{
  padding:20px 0 18px;
  border-bottom:1px solid var(--border);
  margin-bottom:18px;
}
.chat-welcome .welcome-avatar{
  width:58px;height:58px;border-radius:50%;
  background:var(--panel);border:2px solid var(--border);
  font-size:22px;display:flex;align-items:center;justify-content:center;
  margin-bottom:12px;overflow:hidden;
}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:19px;font-weight:800;margin-bottom:3px;}
.chat-welcome p{font-size:13px;color:var(--muted-light);}

/* Date divider */
.date-divider{
  display:flex;align-items:center;gap:12px;
  padding:10px 0;margin:8px 0;
  font-size:11px;font-weight:700;color:var(--muted);letter-spacing:.04em;
}
.date-divider::before,.date-divider::after{
  content:"";flex:1;height:1px;background:var(--border);
}

.msg-group{
  display:flex;gap:10px;
  padding:2px 0;
  border-radius:6px;
  transition:background .1s;
}
.msg-group:hover{background:rgba(255,255,255,.02);padding:2px 6px;margin:0 -6px;}
.msg-group.own{flex-direction:row-reverse;}
.msg-avatar{
  width:34px;height:34px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:13px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;margin-top:2px;overflow:hidden;cursor:pointer;
}
.msg-content{flex:1;min-width:0;}
.msg-meta{display:flex;align-items:baseline;gap:7px;margin-bottom:2px;}
.msg-author{font-size:13px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-time{font-size:10.5px;color:var(--muted);}
.msg-role-badge{
  font-size:9.5px;font-weight:700;padding:1px 7px;border-radius:100px;
  display:inline-flex;align-items:center;
}
.msg-bubble{
  background:var(--panel);border:1px solid var(--border);
  border-radius:4px 12px 12px 12px;
  padding:8px 12px;font-size:13.5px;color:var(--text);
  line-height:1.55;word-break:break-word;
  max-width:680px;
  transition:border-color .1s;
}
.msg-group:hover .msg-bubble{border-color:rgba(255,255,255,.08);}
.msg-group.own .msg-bubble{
  background:rgba(255,249,62,.09);border-color:rgba(255,249,62,.14);
  border-radius:12px 4px 12px 12px;
}
.msg-cont .msg-avatar{opacity:0;pointer-events:none;}
.msg-cont .msg-meta{display:none;}
.msg-cont .msg-bubble{margin-top:1px;}

/* Reactions */
.msg-reactions{
  display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;
}
.reaction-pill{
  display:flex;align-items:center;gap:4px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:100px;padding:2px 9px;
  font-size:12px;cursor:pointer;
  transition:background .12s,border-color .12s;
}
.reaction-pill:hover{background:rgba(255,255,255,.09);border-color:rgba(255,249,62,.2);}
.reaction-pill.mine{background:rgba(255,249,62,.1);border-color:rgba(255,249,62,.3);color:var(--accent);}
.reaction-pill .r-count{font-size:11px;font-weight:700;}

/* Message actions on hover */
.msg-actions{
  display:none;gap:2px;
  position:absolute;right:8px;top:-14px;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:8px;padding:2px;
  z-index:10;
}
.msg-group:hover .msg-actions{display:flex;}
.msg-actions button{
  background:none;border:none;color:var(--muted);
  font-size:14px;cursor:pointer;width:26px;height:26px;
  border-radius:5px;display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.msg-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.msg-group{position:relative;}

/* Chat input */
.chat-input-wrap{padding:10px 16px 14px;flex-shrink:0;}
.chat-input-box{
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:12px;
  display:flex;align-items:flex-end;gap:6px;
  padding:8px 12px;
  transition:border-color .18s;
}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.25);box-shadow:0 0 0 2px rgba(255,249,62,.05);}
.chat-input-box textarea{
  flex:1;background:transparent;border:none;outline:none;
  color:var(--text);font-family:'DM Sans',sans-serif;font-size:13.5px;
  resize:none;max-height:120px;line-height:1.5;padding:2px 0;
}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{
  width:32px;height:32px;border-radius:8px;
  background:var(--accent);border:none;
  color:#060810;font-size:14px;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;transition:filter .12s,transform .1s;
}
.chat-send:hover{filter:brightness(1.08);transform:scale(1.04);}
.chat-input-actions{display:flex;gap:2px;align-items:center;}
.chat-input-actions button{
  background:none;border:none;color:var(--muted);
  font-size:17px;cursor:pointer;width:30px;height:30px;
  border-radius:7px;display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}

/* Typing indicator */
.typing-indicator{
  height:20px;padding:0 16px;
  font-size:12px;color:var(--muted);
  display:flex;align-items:center;gap:6px;
  flex-shrink:0;
}
.typing-dots{display:flex;gap:3px;align-items:center;}
.typing-dots span{
  width:4px;height:4px;border-radius:50%;
  background:var(--muted);
  animation:typingBounce 1.2s infinite;
}
.typing-dots span:nth-child(2){animation-delay:.2s;}
.typing-dots span:nth-child(3){animation-delay:.4s;}
@keyframes typingBounce{0%,60%,100%{transform:translateY(0);}30%{transform:translateY(-4px);}}

/* â”€â”€ RIGHT MEMBER LIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.member-list{
  width:220px;min-width:220px;
  background:var(--channel);
  border-left:1px solid var(--border);
  overflow-y:auto;padding:12px 0;
  display:flex;flex-direction:column;
  flex-shrink:0;
}
.member-list-header{
  padding:0 12px 8px;
  font-size:10.5px;font-weight:700;letter-spacing:.08em;
  text-transform:uppercase;color:var(--muted);
}
.member-entry{
  display:flex;align-items:center;gap:8px;
  padding:5px 10px;margin:1px 4px;border-radius:7px;
  cursor:pointer;transition:background .1s;
}
.member-entry:hover{background:rgba(255,255,255,.05);}
.member-entry .m-avatar{
  width:28px;height:28px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:12px;display:flex;align-items:center;justify-content:center;
  flex-shrink:0;position:relative;
}
.member-entry .m-status{
  position:absolute;bottom:-1px;right:-1px;
  width:9px;height:9px;border-radius:50%;
  border:2px solid var(--channel);
}
.member-entry .m-info{flex:1;min-width:0;}
.member-entry .m-name{font-size:12.5px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.member-entry .m-role{font-size:10.5px;color:var(--muted);}
.role-section{padding:8px 12px 4px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;}

/* â”€â”€ HOME LANDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.home-landing{flex:1;overflow-y:auto;padding:28px;}
.home-hero-card{
  background:linear-gradient(135deg,var(--panel) 0%,rgba(255,249,62,.04) 100%);
  border:1px solid rgba(255,249,62,.12);
  border-radius:18px;padding:28px;margin-bottom:22px;
  display:flex;align-items:center;gap:20px;
  position:relative;overflow:hidden;
}
.home-hero-card::before{
  content:"";position:absolute;top:-60px;right:-60px;
  width:200px;height:200px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,249,62,.05) 0%,transparent 70%);
  pointer-events:none;
}
.home-hero-avatar{
  width:66px;height:66px;border-radius:50%;
  background:var(--panel2);border:2px solid rgba(255,249,62,.2);
  font-size:26px;display:flex;align-items:center;justify-content:center;
  overflow:hidden;flex-shrink:0;
  box-shadow:0 0 20px rgba(255,249,62,.15);
}
.home-hero-text h2{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.3px;margin-bottom:3px;}
.home-hero-text p{font-size:13px;color:var(--muted-light);}
.radiance-badge{
  display:inline-flex;align-items:center;gap:5px;
  background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));
  border:1px solid rgba(255,220,62,.25);
  border-radius:100px;padding:2px 9px;
  font-size:11px;font-weight:700;color:#ffd93e;
  margin-top:6px;
}
.home-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px;}
.home-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:13px;padding:18px;
  cursor:pointer;transition:border-color .2s,transform .15s,box-shadow .18s;
  position:relative;overflow:hidden;
}
.home-card::after{
  content:"";position:absolute;bottom:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  opacity:0;transition:opacity .2s;
}
.home-card:hover{border-color:rgba(255,249,62,.15);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3);}
.home-card:hover::after{opacity:.6;}
.home-card h4{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:3px;}
.home-card p{font-size:12px;color:var(--muted);line-height:1.5;}
.home-card .card-count{font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent);margin-bottom:3px;}

/* â”€â”€ DISCOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.discover-scroll{flex:1;overflow-y:auto;padding:28px;}
.discover-hero{
  background:linear-gradient(105deg,rgba(7,9,14,.97) 40%,rgba(7,9,14,.8));
  border:1px solid var(--border);border-radius:18px;
  padding:40px 36px;margin-bottom:28px;position:relative;overflow:hidden;
}
.discover-hero::before{
  content:"";position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,249,62,.012) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,249,62,.012) 1px,transparent 1px);
  background-size:52px 52px;
}
.discover-hero::after{
  content:"";position:absolute;top:-80px;right:-80px;
  width:300px;height:300px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,249,62,.06) 0%,transparent 70%);
  pointer-events:none;
}
.discover-hero h2{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.6px;margin-bottom:6px;position:relative;}
.discover-hero p{font-size:14px;color:var(--muted-light);margin-bottom:20px;position:relative;max-width:440px;}
.discover-search{display:flex;align-items:center;gap:10px;max-width:420px;position:relative;}
.discover-search input{
  flex:1;background:rgba(255,255,255,.05);
  border:1px solid var(--border);border-radius:9px;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;
  padding:10px 14px 10px 38px;outline:none;transition:border-color .15s;
}
.discover-search input:focus{border-color:rgba(255,249,62,.3);}
.discover-search input::placeholder{color:var(--muted);}
.discover-search .search-icon{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  font-size:14px;color:var(--muted);pointer-events:none;
}
.discover-tabs{display:flex;gap:4px;margin-bottom:22px;}
.discover-tab{
  padding:7px 16px;border-radius:8px;
  font-size:13px;font-weight:600;cursor:pointer;
  border:1px solid transparent;color:var(--muted-light);
  transition:all .15s;
}
.discover-tab:hover{background:rgba(255,255,255,.05);color:#fff;}
.discover-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.bastion-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;overflow:hidden;
  cursor:pointer;transition:border-color .2s,transform .15s,box-shadow .18s;
}
.bastion-card:hover{border-color:rgba(255,249,62,.2);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.bastion-banner{
  height:78px;
  background:linear-gradient(135deg,#1a2040,#0d1425);
  display:flex;align-items:center;justify-content:center;
  font-size:30px;position:relative;overflow:hidden;
}
.bastion-banner::after{
  content:"";position:absolute;inset:0;
  background:linear-gradient(to bottom,transparent 40%,rgba(0,0,0,.5));
}
.bastion-body{padding:14px;}
.bastion-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bastion-icon{
  width:42px;height:42px;border-radius:11px;
  background:var(--panel2);border:2px solid var(--sidebar);
  display:flex;align-items:center;justify-content:center;
  font-size:19px;margin-top:-26px;position:relative;z-index:1;flex-shrink:0;
}
.bastion-name{font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;}
.bastion-desc{font-size:12px;color:var(--muted-light);line-height:1.5;margin-bottom:8px;}
.bastion-stats{display:flex;gap:10px;font-size:11.5px;color:var(--muted);}
.bastion-stats span{display:flex;align-items:center;gap:3px;}
.bastion-tags{display:flex;flex-wrap:wrap;gap:5px;margin-top:8px;}
.bastion-tag{
  font-size:10.5px;font-weight:600;padding:2px 8px;border-radius:100px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted-light);
}

/* â”€â”€ ATELIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.atelier-scroll{flex:1;overflow-y:auto;padding:28px;}
.atelier-hero{
  display:flex;align-items:center;justify-content:space-between;
  background:var(--panel);border:1px solid var(--border);
  border-radius:18px;padding:24px 28px;margin-bottom:24px;
  position:relative;overflow:hidden;
}
.atelier-hero::before{
  content:"";position:absolute;top:-40px;right:-40px;
  width:180px;height:180px;border-radius:50%;
  background:radial-gradient(circle,rgba(255,249,62,.06) 0%,transparent 70%);
  pointer-events:none;
}
.atelier-balance{display:flex;align-items:center;gap:12px;}
.atelier-balance img{width:34px;height:34px;object-fit:contain;}
.atelier-balance-text h3{font-size:12.5px;font-weight:600;color:var(--muted-light);margin-bottom:2px;}
.atelier-balance-text .amount{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;color:var(--accent);letter-spacing:-.4px;}
.daily-btn{
  display:flex;flex-direction:column;align-items:center;gap:3px;
  background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);
  border-radius:13px;padding:12px 22px;cursor:pointer;transition:background .15s;
}
.daily-btn:hover{background:rgba(255,249,62,.12);}
.daily-btn span{font-size:11px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:13.5px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{
  font-family:'Syne',sans-serif;font-size:15px;font-weight:700;
  letter-spacing:-.1px;margin-bottom:14px;
  display:flex;align-items:center;gap:8px;
}
.atelier-section-title::before{content:"";width:14px;height:2px;background:var(--accent);}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:28px;}
.rad-card{
  background:var(--panel);border:1px solid var(--border);
  border-radius:14px;padding:22px 18px;
  display:flex;flex-direction:column;align-items:center;text-align:center;
  gap:8px;cursor:pointer;
  transition:border-color .2s,transform .15s,box-shadow .2s;position:relative;overflow:hidden;
}
.rad-card::before{
  content:"";position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  opacity:0;transition:opacity .25s;
}
.rad-card:hover{border-color:rgba(255,249,62,.25);transform:translateY(-3px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.rad-card:hover::before{opacity:1;}
.rad-card.best-value{border-color:rgba(255,249,62,.2);}
.best-badge{
  position:absolute;top:10px;right:10px;
  background:var(--accent);color:#060810;
  font-size:9px;font-weight:800;letter-spacing:.06em;
  padding:2px 7px;border-radius:100px;text-transform:uppercase;
}
.rad-card .rad-icon{font-size:30px;}
.rad-card .rad-duration{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.rad-card .rad-price{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.rad-card .rad-price span{font-size:11.5px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-card .rad-features{font-size:12px;color:var(--muted-light);line-height:1.6;}

/* â”€â”€ PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-scroll{flex:1;overflow-y:auto;}
.profile-banner{
  height:160px;
  background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);
  position:relative;overflow:hidden;
}
.profile-banner::before{
  content:"";position:absolute;inset:0;
  background-image:linear-gradient(rgba(255,249,62,.013) 1px,transparent 1px),
    linear-gradient(90deg,rgba(255,249,62,.013) 1px,transparent 1px);
  background-size:36px 36px;
}
.profile-content{padding:0 28px 36px;}
.profile-avatar-row{
  display:flex;align-items:flex-end;gap:16px;
  margin-top:-40px;margin-bottom:18px;position:relative;
}
.profile-avatar-big{
  width:82px;height:82px;border-radius:50%;
  background:var(--panel);border:4px solid var(--bg);
  font-size:30px;display:flex;align-items:center;justify-content:center;
  overflow:hidden;flex-shrink:0;
}
.profile-avatar-big img{width:100%;height:100%;object-fit:cover;}
.profile-name-big{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;letter-spacing:-.2px;margin-bottom:2px;}
.profile-handle{font-size:13.5px;color:var(--muted-light);}
.profile-stats{
  display:flex;gap:0;
  background:var(--panel);border:1px solid var(--border);
  border-radius:13px;overflow:hidden;margin-bottom:22px;
}
.profile-stat{flex:1;padding:16px;text-align:center;border-right:1px solid var(--border);}
.profile-stat:last-child{border-right:none;}
.profile-stat-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.profile-stat-key{font-size:11.5px;color:var(--muted);margin-top:2px;}
.settings-section{margin-bottom:24px;}
.settings-title{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.settings-item{
  display:flex;align-items:center;gap:10px;
  padding:12px 14px;background:var(--panel);border:1px solid var(--border);
  border-radius:9px;margin-bottom:7px;cursor:pointer;
  transition:border-color .15s,background .15s;
}
.settings-item:hover{border-color:rgba(255,249,62,.15);background:rgba(255,249,62,.03);}
.si-icon{font-size:17px;width:30px;text-align:center;}
.si-text{flex:1;}
.si-label{font-size:13.5px;font-weight:600;}
.si-sub{font-size:12px;color:var(--muted-light);}
.si-arrow{color:var(--muted);font-size:13px;}
/* Toggle switch */
.toggle-switch{
  width:38px;height:20px;border-radius:10px;
  background:var(--border);position:relative;cursor:pointer;
  transition:background .2s;flex-shrink:0;
}
.toggle-switch.on{background:var(--accent);}
.toggle-switch::after{
  content:"";position:absolute;top:2px;left:2px;
  width:16px;height:16px;border-radius:50%;
  background:#fff;transition:transform .2s;
}
.toggle-switch.on::after{transform:translateX(18px);}

/* â”€â”€ NOTIFICATIONS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.notif-panel{
  position:fixed;top:50px;right:0;
  width:340px;max-height:calc(100vh - 60px);
  background:var(--sidebar);border:1px solid var(--border);
  border-radius:14px 0 0 14px;
  box-shadow:-8px 0 40px rgba(0,0,0,.5);
  z-index:100;overflow:hidden;
  transform:translateX(100%);transition:transform .25s cubic-bezier(.22,1,.36,1);
  display:flex;flex-direction:column;
}
.notif-panel.open{transform:translateX(0);}
.notif-panel-header{
  padding:16px 18px;border-bottom:1px solid var(--border);
  display:flex;align-items:center;justify-content:space-between;
  flex-shrink:0;
}
.notif-panel-header h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.notif-panel-header button{
  background:none;border:none;color:var(--muted);cursor:pointer;
  font-size:16px;width:28px;height:28px;border-radius:7px;
  display:flex;align-items:center;justify-content:center;
  transition:background .1s,color .1s;
}
.notif-panel-header button:hover{background:rgba(255,255,255,.07);color:#fff;}
.notif-list{flex:1;overflow-y:auto;padding:8px;}
.notif-item{
  display:flex;gap:10px;padding:10px 12px;border-radius:9px;
  cursor:pointer;transition:background .1s;margin-bottom:2px;
  position:relative;
}
.notif-item:hover{background:rgba(255,255,255,.05);}
.notif-item.unread{background:rgba(255,249,62,.04);}
.notif-item.unread::before{
  content:"";position:absolute;left:4px;top:50%;transform:translateY(-50%);
  width:4px;height:4px;border-radius:50%;background:var(--accent);
}
.notif-icon{
  width:32px;height:32px;border-radius:50%;
  background:var(--panel);border:1px solid var(--border);
  font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;
}
.notif-text{flex:1;}
.notif-text p{font-size:12.5px;color:var(--text);line-height:1.5;}
.notif-text p strong{font-weight:700;}
.notif-time{font-size:10.5px;color:var(--muted);margin-top:2px;}
.notif-actions{display:flex;gap:6px;margin-top:6px;}
.notif-actions button{
  font-size:11.5px;font-weight:600;padding:4px 12px;border-radius:6px;
  cursor:pointer;border:1px solid var(--border);
  transition:all .12s;
}
.notif-actions .btn-accept{background:var(--accent);color:#060810;border-color:var(--accent);}
.notif-actions .btn-accept:hover{filter:brightness(1.08);}
.notif-actions .btn-decline{background:transparent;color:var(--muted-light);}
.notif-actions .btn-decline:hover{background:rgba(248,113,113,.15);border-color:var(--red);color:var(--red);}
.notif-empty{padding:40px;text-align:center;color:var(--muted);font-size:13px;}

/* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay{
  display:none;position:fixed;inset:0;
  background:rgba(0,0,0,.75);backdrop-filter:blur(10px);
  z-index:1000;align-items:center;justify-content:center;
}
.modal-overlay.open{display:flex;}
.modal{
  background:var(--panel);border:1px solid var(--border);
  border-radius:18px;width:100%;max-width:400px;
  overflow:hidden;
  animation:modalIn .22s cubic-bezier(.22,1,.36,1) both;
  box-shadow:0 30px 80px rgba(0,0,0,.7);
}
@keyframes modalIn{from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.modal-body{padding:28px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px;}
.modal-sub{font-size:13px;color:var(--muted-light);margin-bottom:22px;}
.modal-input{
  width:100%;padding:10px 13px;
  background:#05070d;border:1px solid var(--border);
  border-radius:9px;color:#fff;
  font-family:'DM Sans',sans-serif;font-size:13.5px;
  outline:none;margin-bottom:12px;
  transition:border-color .15s;
}
.modal-input:focus{border-color:rgba(255,249,62,.35);}
.modal-input::placeholder{color:#252c3d;}
.modal-actions{display:flex;gap:8px;margin-top:4px;}
.modal-actions .btn-accent,.modal-actions .btn-ghost{flex:1;justify-content:center;}
.modal-error{font-size:12px;color:var(--red);margin-bottom:8px;min-height:16px;display:flex;align-items:center;gap:5px;}
.modal-error:not(:empty)::before{content:"âš ";}
.modal-success{font-size:12px;color:var(--green);margin-bottom:8px;min-height:16px;}

/* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-accent{
  display:inline-flex;align-items:center;gap:7px;
  background:var(--accent);color:#060810;
  padding:10px 20px;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;
  border:none;cursor:pointer;transition:filter .12s,transform .1s;
}
.btn-accent:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-ghost{
  display:inline-flex;align-items:center;gap:7px;
  background:transparent;color:var(--muted-light);
  padding:9px 18px;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;
  border:1px solid var(--border);cursor:pointer;
  transition:border-color .12s,background .12s;
}
.btn-ghost:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-danger{
  display:inline-flex;align-items:center;gap:7px;
  background:rgba(248,113,113,.1);color:var(--red);
  padding:9px 18px;border-radius:10px;
  font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;
  border:1px solid rgba(248,113,113,.2);cursor:pointer;
  transition:all .12s;
}
.btn-danger:hover{background:rgba(248,113,113,.2);border-color:rgba(248,113,113,.4);}

/* â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state{
  flex:1;display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  gap:14px;color:var(--muted);text-align:center;padding:40px;
}
.empty-state .empty-icon{font-size:48px;opacity:.35;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13.5px;max-width:300px;line-height:1.6;}

/* â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast{
  position:fixed;bottom:22px;right:22px;z-index:2000;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:11px;padding:12px 18px;
  font-size:13px;font-weight:500;
  box-shadow:0 20px 50px rgba(0,0,0,.6);
  transform:translateY(20px);opacity:0;
  transition:transform .28s cubic-bezier(.22,1,.36,1),opacity .28s;
  max-width:280px;pointer-events:none;
}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}

/* â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ctx-menu{
  position:fixed;z-index:3000;
  background:var(--panel2);border:1px solid var(--border);
  border-radius:10px;padding:4px;
  min-width:170px;box-shadow:0 12px 40px rgba(0,0,0,.6);
  animation:ctxIn .15s cubic-bezier(.22,1,.36,1);
}
@keyframes ctxIn{from{opacity:0;transform:scale(.95);}to{opacity:1;transform:none;}}
.ctx-item{
  display:flex;align-items:center;gap:9px;
  padding:8px 12px;border-radius:7px;
  font-size:13px;color:var(--text);cursor:pointer;
  transition:background .1s;
}
.ctx-item:hover{background:rgba(255,255,255,.06);}
.ctx-item.danger{color:var(--red);}
.ctx-item.danger:hover{background:rgba(248,113,113,.1);}
.ctx-sep{height:1px;background:var(--border);margin:3px 0;}

/* â”€â”€ EMOJI PICKER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.emoji-picker-wrap{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;
}
.emoji-option{
  width:36px;height:36px;border-radius:8px;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;
  border:1.5px solid transparent;
  transition:border-color .12s,background .12s;
}
.emoji-option:hover{background:rgba(255,255,255,.06);}
.emoji-option.selected{border-color:var(--accent);background:var(--accent-dim);}

/* â”€â”€ BOOST BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.boost-bar{
  background:linear-gradient(90deg,rgba(255,249,62,.08),rgba(255,249,62,.04));
  border:1px solid rgba(255,249,62,.15);border-radius:10px;
  padding:10px 14px;display:flex;align-items:center;gap:10px;
  font-size:12.5px;color:var(--muted-light);cursor:pointer;
  margin:8px;transition:background .15s;
}
.boost-bar:hover{background:rgba(255,249,62,.12);}
.boost-bar .boost-icon{font-size:16px;}
.boost-bar .boost-label{font-weight:600;color:var(--accent);}

/* â”€â”€ SEARCH BOX (topbar) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.topbar-search{
  display:flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.05);border:1px solid var(--border);
  border-radius:7px;padding:5px 10px;
  width:180px;cursor:text;
  transition:border-color .15s,width .25s;
}
.topbar-search:focus-within{border-color:rgba(255,249,62,.25);width:220px;}
.topbar-search input{
  background:transparent;border:none;outline:none;
  color:#fff;font-family:'DM Sans',sans-serif;font-size:12.5px;
  flex:1;
}
.topbar-search input::placeholder{color:var(--muted);}
.topbar-search .s-icon{font-size:12px;color:var(--muted);}

/* â”€â”€ PINNED MESSAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.pinned-banner{
  display:flex;align-items:center;gap:8px;
  padding:7px 14px;
  background:rgba(255,249,62,.06);
  border-bottom:1px solid rgba(255,249,62,.1);
  font-size:12.5px;color:var(--muted-light);
  cursor:pointer;flex-shrink:0;
  transition:background .12s;
}
.pinned-banner:hover{background:rgba(255,249,62,.1);}
.pinned-banner strong{color:var(--accent);}

/* â”€â”€ STATUS INDICATOR DOTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-online{color:var(--green);}
.status-away{color:var(--yellow);}
.status-dnd{color:var(--red);}
.status-offline{color:var(--muted);}

/* Scrollbar for notifications */
.notif-list::-webkit-scrollbar{width:3px;}
</style>
</head>
<body>

<!-- ICON RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Fortized Home">
    <img src="Fortized icon.png" alt="Fortized" onerror="this.outerHTML='<span style=font-size:22px>ğŸ°</span>'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn active" id="rail-home" onclick="navigate('home')" data-tip="Home">
    <span class="icon">ğŸ </span>
  </div>
  <div class="rail-btn" id="rail-discover" onclick="navigate('discover')" data-tip="Discover Bastions">
    <span class="icon">ğŸ§­</span>
  </div>
  <div class="rail-btn" id="rail-atelier" onclick="navigate('atelier')" data-tip="Atelier â€” Spend Onyx">
    <img src="Onyx.png" onerror="this.parentElement.innerHTML='<span class=icon>ğŸ’</span>'">
  </div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" id="rail-add-bastion" onclick="openCreateBastion()" data-tip="Create Bastion"
    style="border:1.5px dashed #1c2335;border-radius:14px;">
    <span class="icon" style="font-size:20px;color:var(--muted);">+</span>
  </div>
  <div style="margin-top:auto;"></div>
  <div class="rail-btn" id="rail-notif" onclick="toggleNotifPanel()" data-tip="Notifications" style="position:relative;">
    <span class="icon">ğŸ””</span>
    <div class="rail-notif-badge" id="notif-badge" style="display:none;">0</div>
  </div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Profile & Settings">
    <span class="icon">âš™ï¸</span>
  </div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header">
    <span id="sidebar-title">Home</span>
    <div class="header-actions" id="sidebar-header-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <!-- Bastion boost bar (hidden unless in bastion) -->
  <div id="boost-bar-wrap" style="display:none;">
    <div class="boost-bar" onclick="toast('Boost feature coming soon!','info')">
      <span class="boost-icon">âš¡</span>
      <div><div class="boost-label">Boost Bastion</div><div style="font-size:11px;">Level 0 Â· 0 boosts</div></div>
    </div>
  </div>
  <div class="userbar" id="userbar">
    <div class="userbar-avatar" id="userbar-avatar" onclick="navigate('profile')">
      <div class="status-ring"></div>
    </div>
    <div class="userbar-info">
      <div class="userbar-name" id="userbar-name">â€”</div>
      <div class="userbar-tag" id="userbar-tag">â— Online</div>
    </div>
    <div class="userbar-actions">
      <button title="Mute" onclick="toast('Muted','info')">ğŸ¤</button>
      <button title="Deafen" onclick="toast('Deafened','info')">ğŸ§</button>
      <button title="Log Out" onclick="logout()">ğŸšª</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">
      <span class="ch-icon">ğŸ </span><span>Home</span>
    </div>
    <div class="topbar-sep"></div>
    <div class="topbar-desc" id="topbar-desc">Welcome to Fortized</div>
    <div class="topbar-actions">
      <div class="onyx-pill" onclick="navigate('atelier')" id="onyx-pill-top">
        <img src="Onyx.png" onerror="this.outerHTML='ğŸ’'">
        <span id="topbar-onyx">0</span>
      </div>
      <div class="topbar-search">
        <span class="s-icon">ğŸ”</span>
        <input type="text" placeholder="Searchâ€¦" id="topbar-search-input" oninput="handleTopSearch()">
      </div>
      <button id="member-list-toggle" title="Member List" onclick="toggleMemberList()" style="display:none;">ğŸ‘¥</button>
    </div>
  </div>

  <div class="content" id="content-area">
    <!-- HOME VIEW -->
    <div id="view-home" class="home-view-wrap active">
      <div class="home-left" id="home-left">
        <div class="sidebar-header">
          <span style="font-size:13px;">Direct Messages</span>
          <div class="header-actions">
            <button onclick="openNewDM()" title="New DM">âœ‰ï¸</button>
            <button onclick="renderFriends()" title="Friends">ğŸ‘¥</button>
          </div>
        </div>
        <div class="sidebar-scroll" id="dm-list"></div>
      </div>
      <div id="home-main-area" class="home-main-area"></div>
    </div>

    <!-- BASTION VIEW -->
    <div id="view-bastion" style="display:none;flex:1;display:none;flex-direction:row;">
      <div id="bastion-main" style="flex:1;display:flex;flex-direction:column;min-width:0;"></div>
      <div class="member-list" id="member-list" style="display:none;"></div>
    </div>

    <!-- DISCOVER VIEW -->
    <div id="view-discover" class="view" style="display:none;">
      <div class="discover-scroll">
        <div class="discover-hero">
          <h2>Discover Bastions</h2>
          <p>Find public communities, join the fight, and make your mark on the fortress.</p>
          <div class="discover-search">
            <span class="search-icon">ğŸ”</span>
            <input type="text" placeholder="Search bastionsâ€¦" id="discover-search-input" oninput="filterBastions()">
          </div>
        </div>
        <div class="discover-tabs">
          <div class="discover-tab active" onclick="setDiscoverTab('all',this)">All</div>
          <div class="discover-tab" onclick="setDiscoverTab('gaming',this)">ğŸ® Gaming</div>
          <div class="discover-tab" onclick="setDiscoverTab('competitive',this)">âš”ï¸ Competitive</div>
          <div class="discover-tab" onclick="setDiscoverTab('casual',this)">ğŸª Casual</div>
          <div class="discover-tab" onclick="setDiscoverTab('roleplay',this)">ğŸ‰ Roleplay</div>
        </div>
        <div class="bastion-grid" id="bastion-grid"></div>
      </div>
    </div>

    <!-- ATELIER VIEW -->
    <div id="view-atelier" class="view" style="display:none;">
      <div class="atelier-scroll">
        <div class="atelier-hero">
          <div class="atelier-balance">
            <img src="Onyx.png" onerror="this.outerHTML='ğŸ’'">
            <div class="atelier-balance-text">
              <h3>Onyx Balance</h3>
              <div class="amount" id="atelier-balance">0</div>
            </div>
          </div>
          <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
            <span>Daily Reward</span>
            <strong>+5 Onyx</strong>
            <span id="daily-status">Claim</span>
          </div>
        </div>
        <div class="atelier-section-title">Radiance â€” Premium Status</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(110,'1 Day')">
            <div class="rad-icon">âœ¨</div>
            <div class="rad-duration">1 Day</div>
            <div class="rad-price">110 <span>Onyx</span></div>
            <div class="rad-features">Full Radiance perks<br>for 24 hours</div>
            <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
          <div class="rad-card best-value" onclick="buyRadiance(770,'7 Days')">
            <div class="best-badge">Best Value</div>
            <div class="rad-icon">âš¡</div>
            <div class="rad-duration">7 Days</div>
            <div class="rad-price">770 <span>Onyx</span></div>
            <div class="rad-features">Full Radiance perks<br>for one week</div>
            <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
          <div class="rad-card" onclick="buyRadiance(3300,'30 Days')">
            <div class="rad-icon">ğŸ‘‘</div>
            <div class="rad-duration">30 Days</div>
            <div class="rad-price">3,300 <span>Onyx</span></div>
            <div class="rad-features">Full Radiance perks<br>for a full month</div>
            <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
        </div>
        <div class="atelier-section-title">Radiance Perks</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:32px;">
          <div class="settings-item" style="cursor:default;"><span class="si-icon">ğŸ¨</span><div class="si-text"><div class="si-label">Custom Profile Badge</div><div class="si-sub">Exclusive Radiance crown</div></div></div>
          <div class="settings-item" style="cursor:default;"><span class="si-icon">ğŸŒŸ</span><div class="si-text"><div class="si-label">Animated Avatar Border</div><div class="si-sub">Glowing frame effect</div></div></div>
          <div class="settings-item" style="cursor:default;"><span class="si-icon">ğŸ’¬</span><div class="si-text"><div class="si-label">Extended Messages</div><div class="si-sub">Up to 4000 chars</div></div></div>
          <div class="settings-item" style="cursor:default;"><span class="si-icon">ğŸ“</span><div class="si-text"><div class="si-label">100MB File Uploads</div><div class="si-sub">Standard limit is 8MB</div></div></div>
          <div class="settings-item" style="cursor:default;"><span class="si-icon">ğŸ­</span><div class="si-text"><div class="si-label">Custom Emoji</div><div class="si-sub">Use anywhere on Fortized</div></div></div>
          <div class="settings-item" style="cursor:default;"><span class="si-icon">âœï¸</span><div class="si-text"><div class="si-label">Message Formatting</div><div class="si-sub">Markdown plus extras</div></div></div>
        </div>
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div id="view-profile" class="view" style="display:none;">
      <div class="profile-scroll">
        <div class="profile-banner"></div>
        <div class="profile-content">
          <div class="profile-avatar-row">
            <div class="profile-avatar-big" id="profile-avatar-big"></div>
            <div style="flex:1;">
              <div class="profile-name-big" id="profile-name-big">â€”</div>
              <div class="profile-handle" id="profile-handle">@â€”</div>
            </div>
            <div style="display:flex;gap:8px;padding-bottom:4px;">
              <button class="btn-ghost" onclick="toast('Edit profile coming soon','info')" style="font-size:12.5px;padding:7px 14px;">Edit Profile</button>
            </div>
          </div>
          <div class="profile-stats" id="profile-stats"></div>
          <div style="height:22px;"></div>
          <div class="settings-section">
            <div class="settings-title">Account</div>
            <div class="settings-item" onclick="toast('Email settings coming soon','info')">
              <span class="si-icon">ğŸ“§</span>
              <div class="si-text"><div class="si-label">Email</div><div class="si-sub" id="profile-email-display">â€”</div></div>
              <span class="si-arrow">â€º</span>
            </div>
            <div class="settings-item" onclick="toast('Password change coming soon','info')">
              <span class="si-icon">ğŸ”</span>
              <div class="si-text"><div class="si-label">Change Password</div><div class="si-sub">Update your password</div></div>
              <span class="si-arrow">â€º</span>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">Status</div>
            <div class="settings-item" onclick="setUserStatus('online')" id="status-online">
              <span class="si-icon status-online">â—</span>
              <div class="si-text"><div class="si-label">Online</div><div class="si-sub">Show as online</div></div>
            </div>
            <div class="settings-item" onclick="setUserStatus('away')" id="status-away">
              <span class="si-icon status-away">â—</span>
              <div class="si-text"><div class="si-label">Away</div><div class="si-sub">Show as away</div></div>
            </div>
            <div class="settings-item" onclick="setUserStatus('dnd')" id="status-dnd">
              <span class="si-icon status-dnd">â—</span>
              <div class="si-text"><div class="si-label">Do Not Disturb</div><div class="si-sub">Mute notifications</div></div>
            </div>
            <div class="settings-item" onclick="setUserStatus('invisible')">
              <span class="si-icon status-offline">â—</span>
              <div class="si-text"><div class="si-label">Invisible</div><div class="si-sub">Appear offline to others</div></div>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">Preferences</div>
            <div class="settings-item">
              <span class="si-icon">ğŸ””</span>
              <div class="si-text"><div class="si-label">Desktop Notifications</div><div class="si-sub">Show alerts for new messages</div></div>
              <div class="toggle-switch on" id="notif-toggle" onclick="toggleNotifSetting()"></div>
            </div>
            <div class="settings-item" onclick="toast('Appearance settings coming soon','info')">
              <span class="si-icon">ğŸ¨</span>
              <div class="si-text"><div class="si-label">Appearance</div><div class="si-sub">Theme and display options</div></div>
              <span class="si-arrow">â€º</span>
            </div>
          </div>
          <div class="settings-section">
            <div class="settings-title">Danger Zone</div>
            <div class="settings-item" onclick="logout()" style="border-color:rgba(248,113,113,.2);">
              <span class="si-icon">ğŸšª</span>
              <div class="si-text"><div class="si-label" style="color:var(--red);">Log Out</div><div class="si-sub">Sign out of your account</div></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="notif-panel-header">
    <h3>Notifications</h3>
    <div style="display:flex;gap:4px;">
      <button onclick="markAllRead()" title="Mark all read" style="font-size:12px;">âœ“ All</button>
      <button onclick="toggleNotifPanel()" title="Close">âœ•</button>
    </div>
  </div>
  <div class="notif-list" id="notif-list"></div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create a Bastion</div>
      <div class="modal-sub">Build your own community fortress.</div>
      <div class="modal-error" id="create-error"></div>
      <input class="modal-input" id="bastion-name-input" placeholder="Bastion name" maxlength="32">
      <input class="modal-input" id="bastion-desc-input" placeholder="Short description (optional)" maxlength="80">
      <div style="margin-bottom:14px;">
        <div style="font-size:11.5px;color:var(--muted);margin-bottom:8px;">Pick an icon:</div>
        <div class="emoji-picker-wrap" id="bastion-emoji-picker"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-accent" onclick="createBastion()">âš”ï¸ Create</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">New Direct Message</div>
      <div class="modal-sub">Start a conversation with any Fortized user.</div>
      <div class="modal-error" id="dm-error"></div>
      <input class="modal-input" id="dm-username-input" placeholder="Enter exact username">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-accent" onclick="startDM()">Open DM</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Add a Friend</div>
      <div class="modal-sub">Send a friend request by username.</div>
      <div class="modal-error" id="add-friend-error"></div>
      <div class="modal-success" id="add-friend-success"></div>
      <input class="modal-input" id="add-friend-input" placeholder="Enter exact username" onkeydown="if(event.key==='Enter')sendFriendRequest()">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-add-friend')">Close</button>
        <button class="btn-accent" onclick="sendFriendRequest()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-buy-confirm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="buy-confirm-title">Activate Radiance?</div>
      <div class="modal-sub" id="buy-confirm-sub">This will deduct Onyx from your balance.</div>
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-buy-confirm')">Cancel</button>
        <button class="btn-accent" onclick="confirmBuy()">âœ¨ Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-user-profile">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="user-profile-body">
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>
<!-- CONTEXT MENU -->
<div id="ctx-menu" style="display:none;"></div>

<script>
// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let currentUser = null;
let currentView = 'home';
let currentDM = null;
let currentBastion = null;
let currentChannel = null;
let pendingBuy = null;
let memberListVisible = false;
let discoverTab = 'all';
let notifPanelOpen = false;

const EMOJIS = ['ğŸ°','âš”ï¸','ğŸ›¡','ğŸ¹','ğŸ—¡ï¸','ğŸ”¥','âš¡','ğŸŒŒ','ğŸ®','ğŸ¯','ğŸ’€','ğŸ‰','ğŸŒ™','ğŸŒŸ','ğŸª','ğŸ”®','ğŸŒŠ','ğŸ¦…'];
const QUICK_REACTIONS = ['ğŸ‘','â¤ï¸','ğŸ˜‚','ğŸ˜®','ğŸ˜¢','ğŸ”¥','âœ…','ğŸ‰'];

const PUBLIC_BASTIONS = [
  {icon:'âš”ï¸',name:'Warfront Elite',desc:'Competitive FPS players and strategy enthusiasts. Weekly tournaments and ranked discussion.',members:1842,online:234,category:'competitive',tags:['FPS','Strategy','Ranked']},
  {icon:'ğŸ‰',name:'Dragon Realm',desc:'Fantasy RPG and tabletop gaming community. D&D, Pathfinder, and more.',members:932,online:87,category:'roleplay',tags:['RPG','D&D','Fantasy']},
  {icon:'ğŸ®',name:'Casual Crew',desc:'Laid-back gamers who just want to chill and have fun together.',members:3201,online:418,category:'casual',tags:['Chill','Multi-game']},
  {icon:'ğŸŒŒ',name:'Void Runners',desc:'Sci-fi games, space sims, and futurism. Star Citizen, Elite, No Man\'s Sky.',members:671,online:55,category:'gaming',tags:['Sci-Fi','Space']},
  {icon:'ğŸ¯',name:'Sniper Guild',desc:'Precision shooters and competitive ranked players. Weekly coaching sessions.',members:2156,online:310,category:'competitive',tags:['Shooter','Competitive']},
  {icon:'ğŸ”¥',name:'Blaze Bastions',desc:'The hottest new community on the platform. Join the revolution.',members:489,online:102,category:'gaming',tags:['New','Hot']},
  {icon:'ğŸª',name:'Meme Lords',desc:'Gaming memes, clips, and the dumbest moments in gaming history.',members:5480,online:623,category:'casual',tags:['Memes','Clips']},
  {icon:'ğŸ”®',name:'Arcane Council',desc:'Strategy games, deckbuilders, and puzzle lovers unite.',members:811,online:77,category:'gaming',tags:['Strategy','Puzzle']},
  {icon:'ğŸŒŠ',name:'Wave Riders',desc:'Surf, speedrun, and set world records together.',members:1203,online:145,category:'competitive',tags:['Speedrun','Records']},
];

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('fortized_current_user');
  if (!username) { window.location.href = 'login.html'; return; }
  
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  currentUser = users.find(u => u.username === username);
  if (!currentUser) { window.location.href = 'login.html'; return; }

  // Ensure all fields
  if (!Array.isArray(currentUser.bastions)) currentUser.bastions = [];
  if (!Array.isArray(currentUser.friends)) currentUser.friends = [];
  if (!Array.isArray(currentUser.friendRequestsSent)) currentUser.friendRequestsSent = [];
  if (!Array.isArray(currentUser.friendRequestsReceived)) currentUser.friendRequestsReceived = [];
  if (!Array.isArray(currentUser.notifications)) currentUser.notifications = [];
  if (typeof currentUser.onyx !== 'number') currentUser.onyx = 5;
  if (!currentUser.lastDaily) currentUser.lastDaily = null;
  if (!currentUser.status) currentUser.status = 'online';
  saveUser();

  // Set last seen / status
  FortizedSocial.setStatus(currentUser.username, currentUser.status);

  buildUI();
  navigate('home');

  // Start polling for notifications
  FortizedSocial.startPolling(currentUser.username, {
    onNewNotification: (n) => {
      refreshCurrentUser();
      updateNotifBadge();
      // Auto-show friend request notifications
      if (n.type === 'friend_request') {
        toast(`Friend request from ${n.from}!`, 'info');
      } else if (n.type === 'friend_accept') {
        toast(`${n.from} accepted your friend request!`, 'success');
        refreshCurrentUser();
      } else if (n.type === 'dm') {
        toast(`New message from ${n.from}`, 'info');
      }
    }
  });

  // Refresh every 3s to pick up cross-user changes
  setInterval(() => {
    refreshCurrentUser();
    updateNotifBadge();
    if (currentDM !== null) {
      const partner = getDMPartnerList()[currentDM];
      if (partner) refreshDMMessages(partner);
    }
  }, 3000);

  // Close ctx menu on click
  document.addEventListener('click', () => {
    document.getElementById('ctx-menu').style.display = 'none';
  });
});

function refreshCurrentUser() {
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const fresh = users.find(u => u.username === currentUser.username);
  if (fresh) {
    // merge â€“ don't overwrite session-only data
    currentUser.notifications = fresh.notifications || [];
    currentUser.friends = fresh.friends || [];
    currentUser.friendRequestsReceived = fresh.friendRequestsReceived || [];
    currentUser.friendRequestsSent = fresh.friendRequestsSent || [];
    currentUser.onyx = fresh.onyx;
    currentUser.radianceUntil = fresh.radianceUntil;
    updateOnyxDisplay();
    updateNotifBadge();
  }
}

// â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveUser() {
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const idx = users.findIndex(u => u.username === currentUser.username);
  if (idx > -1) { users[idx] = currentUser; localStorage.setItem('fortized_users', JSON.stringify(users)); }
}

// â”€â”€ BUILD UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildUI() {
  const ua = document.getElementById('userbar-avatar');
  ua.innerHTML = currentUser.pfp
    ? `<img src="${currentUser.pfp}"><div class="status-ring"></div>`
    : `<span>${(currentUser.username || '?')[0].toUpperCase()}</span><div class="status-ring"></div>`;
  document.getElementById('userbar-name').textContent = currentUser.username;
  updateOnyxDisplay();
  updateNotifBadge();
  buildRailBastions();
  buildDiscoverGrid();
  buildEmojiPicker();
  renderHomeLanding();
  updateDailyBtn();
  buildProfileView();
  buildNotifList();
}

function updateOnyxDisplay() {
  document.getElementById('topbar-onyx').textContent = currentUser.onyx;
  const atelierBal = document.getElementById('atelier-balance');
  if (atelierBal) atelierBal.textContent = currentUser.onyx;
}

function updateNotifBadge() {
  const count = FortizedSocial.getUnreadCount(currentUser.username);
  const badge = document.getElementById('notif-badge');
  if (count > 0) {
    badge.style.display = 'flex';
    badge.textContent = count > 9 ? '9+' : count;
  } else {
    badge.style.display = 'none';
  }
}

// â”€â”€ BASTION RAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildRailBastions() {
  const container = document.getElementById('rail-bastions');
  container.innerHTML = '';
  currentUser.bastions.forEach((b, i) => {
    const el = document.createElement('div');
    el.className = 'rail-bastion' + (currentBastion === i ? ' active' : '');
    el.id = 'rail-bastion-' + i;
    el.setAttribute('data-tip', b.name);
    el.textContent = b.icon || 'ğŸ°';
    el.onclick = () => openBastion(i);
    container.appendChild(el);
  });
}

// â”€â”€ NAVIGATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function navigate(view) {
  // Hide all
  document.getElementById('view-home').classList.remove('active');
  document.getElementById('view-home').style.display = 'none';
  ['view-bastion','view-discover','view-atelier','view-profile'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.display = 'none'; el.classList.remove('active'); }
  });

  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b => b.classList.remove('active'));
  document.getElementById('member-list-toggle').style.display = 'none';
  document.getElementById('boost-bar-wrap').style.display = 'none';

  const railBtn = document.getElementById('rail-' + view);
  if (railBtn) railBtn.classList.add('active');

  currentView = view;

  if (view === 'home') {
    const el = document.getElementById('view-home');
    el.style.display = 'flex';
    el.classList.add('active');
    setSidebar('home');
    setTopbar('ğŸ ', 'Home', 'Your direct messages and community');
  } else if (view === 'discover') {
    showEl('view-discover');
    setSidebar('discover');
    setTopbar('ğŸ§­', 'Discover', 'Find and join public Bastions');
  } else if (view === 'atelier') {
    showEl('view-atelier');
    setSidebar('atelier');
    setTopbar('ğŸ’', 'Atelier', 'Spend Onyx on Radiance and cosmetics');
    updateOnyxDisplay();
  } else if (view === 'profile') {
    showEl('view-profile');
    setSidebar('profile');
    setTopbar('âš™ï¸', 'Profile & Settings', '');
    buildProfileView();
  }
}

function showEl(id) {
  const el = document.getElementById(id);
  if (el) { el.style.display = 'flex'; el.classList.add('active'); }
}

function setTopbar(icon, title, desc) {
  document.getElementById('topbar-title').innerHTML = `<span class="ch-icon">${icon}</span><span>${title}</span>`;
  document.getElementById('topbar-desc').textContent = desc;
}

// â”€â”€ SIDEBAR CONTEXT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setSidebar(ctx) {
  const scroll = document.getElementById('sidebar-scroll');
  const title = document.getElementById('sidebar-title');
  const actions = document.getElementById('sidebar-header-actions');
  scroll.innerHTML = '';
  actions.innerHTML = '';

  if (ctx === 'home') {
    title.textContent = 'Fortized';
    actions.innerHTML = `<button onclick="navigate('discover')" title="Discover">ğŸ§­</button>`;
    const items = [
      { icon: 'ğŸ ', label: 'Home', action: () => renderHomeLanding() },
      { icon: 'ğŸ‘¥', label: 'Friends', action: () => renderFriends() },
      { icon: 'ğŸ“¥', label: 'Pending', action: () => renderPending(), badge: getPendingCount() },
    ];
    items.forEach(item => {
      const el = createSidebarItem(item.icon, item.label, item.badge);
      el.onclick = item.action;
      scroll.appendChild(el);
    });
    const label = document.createElement('div');
    label.className = 'sidebar-section-label';
    label.innerHTML = `<span>Direct Messages</span><button onclick="openNewDM()" title="New DM">+</button>`;
    scroll.appendChild(label);
    buildDMSidebarItems(scroll);
  } else if (ctx === 'discover') {
    title.textContent = 'Discover';
  } else if (ctx === 'atelier') {
    title.textContent = 'Atelier';
    [{icon:'âœ¨',label:'Radiance'},{icon:'ğŸ’',label:'Onyx'},{icon:'ğŸ¨',label:'Cosmetics'}].forEach(item => {
      scroll.appendChild(createSidebarItem(item.icon, item.label));
    });
  } else if (ctx === 'profile') {
    title.textContent = 'Settings';
    [{icon:'ğŸ‘¤',label:'My Profile'},{icon:'ğŸ”’',label:'Privacy'},{icon:'ğŸ””',label:'Notifications'},{icon:'ğŸ¨',label:'Appearance'}].forEach(item => {
      scroll.appendChild(createSidebarItem(item.icon, item.label));
    });
  } else if (ctx === 'bastion' && currentBastion !== null) {
    const b = currentUser.bastions[currentBastion];
    title.textContent = b.name;
    actions.innerHTML = `<button onclick="openBastionSettings()" title="Settings">âš™ï¸</button>`;
    document.getElementById('boost-bar-wrap').style.display = 'block';

    // Channel categories
    const categories = b.categories || [{name:'Text Channels', type:'text'},{name:'Voice Channels', type:'voice'}];

    const textCat = document.createElement('div');
    textCat.className = 'category-header';
    textCat.innerHTML = `<span class="cat-arrow">â–¾</span><span>${b.name}</span><button onclick="addChannel(${currentBastion})" title="Add Channel">+</button>`;
    scroll.appendChild(textCat);

    (b.channels || []).forEach((ch, ci) => {
      const el = document.createElement('div');
      const isActive = currentChannel === ci;
      el.className = 'channel-item' + (isActive ? ' active' : '');
      el.innerHTML = `
        <span class="ch-icon">#</span>
        <span class="ch-name">${ch.name}</span>
        <div class="ch-actions">
          <button onclick="event.stopPropagation();addChannelAbove(${currentBastion},${ci})" title="Add channel above">+</button>
        </div>
      `;
      el.onclick = () => openChannel(currentBastion, ci);
      el.oncontextmenu = (e) => showChannelCtxMenu(e, currentBastion, ci);
      scroll.appendChild(el);
    });

    const voiceCat = document.createElement('div');
    voiceCat.className = 'category-header';
    voiceCat.innerHTML = `<span class="cat-arrow">â–¾</span><span>Voice Channels</span>`;
    scroll.appendChild(voiceCat);

    const vcEl = document.createElement('div');
    vcEl.className = 'channel-item';
    vcEl.innerHTML = `<span class="ch-icon">ğŸ”Š</span><span class="ch-name">General</span>`;
    vcEl.onclick = () => toast('Voice channels coming soon', 'info');
    scroll.appendChild(vcEl);
  }
}

function getPendingCount() {
  return (currentUser.friendRequestsReceived || []).length;
}

function createSidebarItem(icon, label, badge) {
  const el = document.createElement('div');
  el.className = 'sidebar-item';
  el.innerHTML = `
    <div class="item-icon"><span>${icon}</span></div>
    <span class="item-name">${label}</span>
    ${badge ? `<span class="item-badge">${badge}</span>` : ''}
  `;
  return el;
}

function buildDMSidebarItems(container) {
  const partners = getDMPartnerList();
  if (partners.length === 0) {
    const empty = document.createElement('div');
    empty.style.cssText = 'padding:10px 14px;font-size:12px;color:var(--muted);';
    empty.textContent = 'No DMs yet. Start one!';
    container.appendChild(empty);
    return;
  }
  partners.forEach((partner, i) => {
    const msgs = FortizedSocial.getDMMessages(currentUser.username, partner);
    const lastMsg = msgs[msgs.length - 1];
    const status = FortizedSocial.getStatus(partner);
    const el = document.createElement('div');
    el.className = 'friend-item' + (currentDM === i ? ' active' : '');
    el.innerHTML = `
      <div class="friend-avatar">
        <span>${partner[0].toUpperCase()}</span>
        <div class="f-status ${status}"></div>
      </div>
      <div class="friend-info">
        <div class="friend-name">${partner}</div>
        <div class="friend-status">${lastMsg ? escapeHTML(lastMsg.text.slice(0, 28)) + 'â€¦' : 'No messages yet'}</div>
      </div>
    `;
    el.onclick = () => openDMChat(i);
    container.appendChild(el);
  });
}

function getDMPartnerList() {
  return FortizedSocial.getRecentDMPartners(currentUser.username);
}

// â”€â”€ HOME LANDING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHomeLanding() {
  const area = document.getElementById('home-main-area');
  const hasRadiance = currentUser.radianceUntil && new Date(currentUser.radianceUntil) > new Date();
  const pending = (currentUser.friendRequestsReceived || []).length;
  area.innerHTML = `
    <div class="home-landing">
      <div class="home-hero-card">
        <div class="home-hero-avatar">
          ${currentUser.pfp ? `<img src="${currentUser.pfp}" style="width:100%;height:100%;object-fit:cover;">` : `<span>${currentUser.username[0].toUpperCase()}</span>`}
        </div>
        <div class="home-hero-text">
          <h2>Welcome back, ${currentUser.username}!</h2>
          <p>Ready to storm the fortress?</p>
          ${hasRadiance ? `<div class="radiance-badge">âœ¨ Radiance Active â€” ${new Date(currentUser.radianceUntil).toLocaleDateString()}</div>` : ''}
        </div>
      </div>
      <div class="home-grid">
        <div class="home-card" onclick="renderFriends()">
          <div class="card-count">${currentUser.friends.length}</div>
          <h4>Friends</h4>
          <p>View and chat with your crew</p>
        </div>
        <div class="home-card" onclick="openNewDM()">
          <div class="card-count">${getDMPartnerList().length}</div>
          <h4>Messages</h4>
          <p>Open conversations</p>
        </div>
        <div class="home-card" onclick="navigate('atelier')">
          <div class="card-count" style="color:var(--accent);">${currentUser.onyx}</div>
          <h4>Onyx</h4>
          <p>Your current balance</p>
        </div>
        <div class="home-card" onclick="navigate('discover')">
          <div class="card-count">${currentUser.bastions.length}</div>
          <h4>Bastions</h4>
          <p>Your fortress communities</p>
        </div>
      </div>
      ${pending > 0 ? `
      <div style="background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.15);border-radius:12px;padding:16px 20px;display:flex;align-items:center;gap:12px;cursor:pointer;" onclick="renderPending()">
        <span style="font-size:20px;">ğŸ“¥</span>
        <div style="flex:1;">
          <div style="font-weight:700;font-size:14px;">Pending Friend Requests</div>
          <div style="font-size:12.5px;color:var(--muted-light);">${pending} request${pending>1?'s':''} waiting for you</div>
        </div>
        <span style="background:var(--red);color:#fff;font-size:11px;font-weight:800;padding:2px 8px;border-radius:100px;">${pending}</span>
      </div>` : ''}
    </div>
  `;
  refreshDMLeftPanel();
}

function refreshDMLeftPanel() {
  const dmList = document.getElementById('dm-list');
  if (!dmList) return;
  dmList.innerHTML = '';
  buildDMSidebarItems(dmList);
}

// â”€â”€ FRIENDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFriends() {
  const area = document.getElementById('home-main-area');
  const friends = currentUser.friends || [];
  area.innerHTML = `
    <div class="home-landing">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
        <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">Friends â€” ${friends.length}</div>
        <button class="btn-accent" onclick="openAddFriend()" style="font-size:12.5px;padding:8px 16px;">+ Add Friend</button>
      </div>
      ${friends.length === 0 ? `
        <div class="empty-state">
          <div class="empty-icon">ğŸ‘¥</div>
          <h3>No friends yet</h3>
          <p>Add friends by username to start chatting and gaming together.</p>
          <button class="btn-accent" onclick="openAddFriend()">Add a Friend</button>
        </div>` :
        friends.map(f => {
          const status = FortizedSocial.getStatus(f);
          const statusDot = `<div class="f-status ${status}"></div>`;
          return `
          <div class="friend-item" style="padding:11px 14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;" oncontextmenu="showFriendCtxMenu(event,'${f}')">
            <div class="friend-avatar" style="width:36px;height:36px;font-size:15px;">
              <span>${f[0].toUpperCase()}</span>${statusDot}
            </div>
            <div class="friend-info">
              <div class="friend-name">${f}</div>
              <div class="friend-status ${status === 'online' ? 'status-online' : ''}" style="display:flex;align-items:center;gap:4px;">
                ${status === 'online' ? 'â— Online' : status === 'away' ? 'â— Away' : status === 'dnd' ? 'â— Do Not Disturb' : 'â— Offline'}
              </div>
            </div>
            <div style="display:flex;gap:6px;">
              <button class="btn-ghost" onclick="startDMWith('${f}')" style="font-size:12px;padding:6px 13px;">ğŸ’¬ Message</button>
              <button class="btn-ghost" onclick="removeFriend('${f}')" style="font-size:12px;padding:6px;border-color:rgba(248,113,113,.2);color:var(--red);">âœ•</button>
            </div>
          </div>`;
        }).join('')}
    </div>
  `;
}

function renderPending() {
  const area = document.getElementById('home-main-area');
  const incoming = currentUser.friendRequestsReceived || [];
  const outgoing = currentUser.friendRequestsSent || [];
  area.innerHTML = `
    <div class="home-landing">
      <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;margin-bottom:18px;">Pending Requests</div>
      ${incoming.length === 0 && outgoing.length === 0 ? `
        <div class="empty-state"><div class="empty-icon">ğŸ“¥</div><h3>All clear!</h3><p>No pending friend requests.</p></div>` : ''}
      ${incoming.length > 0 ? `
        <div style="font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Incoming â€” ${incoming.length}</div>
        ${incoming.map(from => `
          <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--panel);border:1px solid rgba(255,249,62,.1);border-radius:10px;margin-bottom:7px;">
            <div class="friend-avatar" style="width:36px;height:36px;font-size:15px;"><span>${from[0].toUpperCase()}</span></div>
            <div class="friend-info"><div class="friend-name">${from}</div><div class="friend-status">Wants to be friends</div></div>
            <div style="display:flex;gap:6px;">
              <button class="btn-accent" onclick="acceptFriend('${from}')" style="font-size:12px;padding:7px 14px;">âœ“ Accept</button>
              <button class="btn-ghost" onclick="declineFriend('${from}')" style="font-size:12px;padding:7px 14px;color:var(--red);border-color:rgba(248,113,113,.2);">âœ•</button>
            </div>
          </div>`).join('')}` : ''}
      ${outgoing.length > 0 ? `
        <div style="font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:16px;margin-bottom:8px;">Sent â€” ${outgoing.length}</div>
        ${outgoing.map(to => `
          <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;opacity:.7;">
            <div class="friend-avatar" style="width:36px;height:36px;font-size:15px;"><span>${to[0].toUpperCase()}</span></div>
            <div class="friend-info"><div class="friend-name">${to}</div><div class="friend-status">Request pendingâ€¦</div></div>
            <button class="btn-ghost" onclick="cancelFriendReq('${to}')" style="font-size:12px;padding:7px 14px;">Cancel</button>
          </div>`).join('')}` : ''}
    </div>
  `;
}

// â”€â”€ FRIEND ACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddFriend() {
  document.getElementById('add-friend-input').value = '';
  document.getElementById('add-friend-error').textContent = '';
  document.getElementById('add-friend-success').textContent = '';
  openModal('modal-add-friend');
}

function sendFriendRequest() {
  const name = document.getElementById('add-friend-input').value.trim();
  document.getElementById('add-friend-error').textContent = '';
  document.getElementById('add-friend-success').textContent = '';
  if (!name) { document.getElementById('add-friend-error').textContent = 'Enter a username.'; return; }
  const result = FortizedSocial.sendFriendRequest(currentUser.username, name);
  if (result.ok) {
    document.getElementById('add-friend-success').textContent = result.msg;
    document.getElementById('add-friend-input').value = '';
    refreshCurrentUser();
    FortizedSocial.playNotificationSound();
  } else {
    document.getElementById('add-friend-error').textContent = result.msg;
  }
}

function acceptFriend(from) {
  const result = FortizedSocial.acceptFriendRequest(currentUser.username, from);
  if (result.ok) {
    refreshCurrentUser();
    toast(result.msg, 'success');
    FortizedSocial.playNotificationSound();
    renderPending();
    // Refresh pending sidebar badge
    setSidebar('home');
  } else {
    toast(result.msg, 'error');
  }
}

function declineFriend(from) {
  const result = FortizedSocial.declineFriendRequest(currentUser.username, from);
  refreshCurrentUser();
  toast(result.msg, 'info');
  renderPending();
}

function cancelFriendReq(to) {
  // manually cancel outgoing
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const meIdx = users.findIndex(u => u.username === currentUser.username);
  const themIdx = users.findIndex(u => u.username === to);
  if (meIdx !== -1) users[meIdx].friendRequestsSent = (users[meIdx].friendRequestsSent || []).filter(u => u !== to);
  if (themIdx !== -1) users[themIdx].friendRequestsReceived = (users[themIdx].friendRequestsReceived || []).filter(u => u !== currentUser.username);
  localStorage.setItem('fortized_users', JSON.stringify(users));
  refreshCurrentUser();
  toast(`Request to ${to} cancelled.`, 'info');
  renderPending();
}

function removeFriend(friendUsername) {
  if (!confirm(`Remove ${friendUsername} as a friend?`)) return;
  const result = FortizedSocial.removeFriend(currentUser.username, friendUsername);
  refreshCurrentUser();
  toast(result.msg, 'info');
  renderFriends();
}

function showFriendCtxMenu(e, username) {
  e.preventDefault();
  showCtxMenu(e.clientX, e.clientY, [
    { label: 'ğŸ’¬ Message', action: () => startDMWith(username) },
    { label: 'ğŸ‘¤ View Profile', action: () => viewUserProfile(username) },
    { sep: true },
    { label: 'ğŸ—‘ï¸ Remove Friend', action: () => removeFriend(username), danger: true },
  ]);
}

// â”€â”€ DM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openNewDM() {
  document.getElementById('dm-username-input').value = '';
  document.getElementById('dm-error').textContent = '';
  openModal('modal-new-dm');
}

function startDM() {
  const name = document.getElementById('dm-username-input').value.trim();
  if (!name) { document.getElementById('dm-error').textContent = 'Enter a username.'; return; }
  if (name === currentUser.username) { document.getElementById('dm-error').textContent = "You can't DM yourself!"; return; }
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  if (!users.find(u => u.username === name)) { document.getElementById('dm-error').textContent = 'User not found.'; return; }
  closeModal('modal-new-dm');
  startDMWith(name);
}

function startDMWith(name) {
  navigate('home');
  const partners = getDMPartnerList();
  let idx = partners.indexOf(name);
  if (idx === -1) {
    // Create a placeholder message to register the DM channel
    // (actual messages stored in shared key)
    idx = 0; // will be resolved after refresh
    // Force the partner to appear by sending a virtual entry
    // We just open the chat directly
  }
  // Find index after potential new entry
  const freshPartners = getDMPartnerList();
  idx = freshPartners.indexOf(name);
  if (idx === -1) {
    // Not in list yet - open chat directly
    openDMChatByName(name);
  } else {
    openDMChat(idx);
  }
  refreshDMLeftPanel();
}

function openDMChatByName(partner) {
  currentDM = -1; // special
  renderDMChatArea(partner);
}

function openDMChat(idx) {
  const partners = getDMPartnerList();
  if (idx >= partners.length) return;
  currentDM = idx;
  renderDMChatArea(partners[idx]);
  // Highlight in sidebar
  document.querySelectorAll('#dm-list .friend-item').forEach((el, i) => el.classList.toggle('active', i === idx));
}

function renderDMChatArea(partner) {
  const area = document.getElementById('home-main-area');
  const msgs = FortizedSocial.getDMMessages(currentUser.username, partner);
  const status = FortizedSocial.getStatus(partner);
  const statusText = status === 'online' ? 'â— Online' : status === 'away' ? 'â— Away' : 'â— Offline';
  
  setTopbar('ğŸ’¬', partner, statusText);

  area.innerHTML = `
    <div class="chat-view">
      <div class="chat-messages" id="chat-msgs">
        <div class="chat-welcome">
          <div class="welcome-avatar"><span style="font-size:22px;">${partner[0].toUpperCase()}</span></div>
          <h3>${partner}</h3>
          <p>Start of your direct message history with <strong>${partner}</strong>.</p>
        </div>
        ${renderMessages(msgs, partner)}
      </div>
      <div class="typing-indicator" id="typing-indicator"></div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button title="Attach" onclick="toast('File upload coming soon','info')">ğŸ“</button>
            <button title="Emoji" onclick="showEmojiQuick('dm','${partner}')">ğŸ˜Š</button>
          </div>
          <textarea id="dm-msg-input" placeholder="Message ${partner}" rows="1"
            onkeydown="dmKeydown(event,'${partner}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendDMMsg('${partner}')">â¤</button>
        </div>
      </div>
    </div>
  `;
  scrollChatToBottom('chat-msgs');
}

function refreshDMMessages(partner) {
  const msgsEl = document.getElementById('chat-msgs');
  if (!msgsEl) return;
  const msgs = FortizedSocial.getDMMessages(currentUser.username, partner);
  // Only re-render if count changed
  const current = msgsEl.querySelectorAll('.msg-group').length;
  if (msgs.length !== current) {
    const bottom = msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight < 100;
    // Re-render messages section only
    const welcome = msgsEl.querySelector('.chat-welcome');
    const msgNodes = msgsEl.querySelectorAll('.msg-group, .date-divider');
    msgNodes.forEach(n => n.remove());
    msgsEl.insertAdjacentHTML('beforeend', renderMessages(msgs, partner));
    if (bottom) scrollChatToBottom('chat-msgs');
  }
}

function renderMessages(msgs, partnerName) {
  if (!msgs || msgs.length === 0) return '';
  let html = '';
  let lastDate = '';
  msgs.forEach((m, i) => {
    const isOwn = m.from === currentUser.username;
    const prev = msgs[i - 1];
    const isCont = prev && prev.from === m.from;
    const msgDate = m.timestamp ? new Date(m.timestamp).toLocaleDateString() : '';
    if (msgDate && msgDate !== lastDate) {
      html += `<div class="date-divider">${msgDate}</div>`;
      lastDate = msgDate;
    }
    const reactions = m.reactions || {};
    const reactionHTML = Object.entries(reactions).map(([emoji, users]) => {
      const mine = users.includes(currentUser.username);
      return `<div class="reaction-pill ${mine ? 'mine' : ''}" onclick="handleReaction('${m.id}','${emoji}')" title="${users.join(', ')}">
        ${emoji} <span class="r-count">${users.length}</span>
      </div>`;
    }).join('');

    html += `
      <div class="msg-group ${isOwn ? 'own' : ''} ${isCont ? 'msg-cont' : ''}" data-msgid="${m.id || ''}">
        <div class="msg-avatar" onclick="viewUserProfile('${m.from}')">${isOwn
          ? (currentUser.pfp ? `<img src="${currentUser.pfp}">` : currentUser.username[0].toUpperCase())
          : m.from[0].toUpperCase()}
        </div>
        <div class="msg-content">
          <div class="msg-meta">
            <span class="msg-author" onclick="viewUserProfile('${m.from}')">${m.from}</span>
            <span class="msg-time">${m.time || ''}</span>
          </div>
          <div class="msg-bubble">${parseMarkdown(escapeHTML(m.text))}</div>
          ${reactionHTML ? `<div class="msg-reactions">${reactionHTML}</div>` : ''}
        </div>
        <div class="msg-actions">
          ${QUICK_REACTIONS.slice(0,4).map(e => `<button onclick="handleReaction('${m.id}','${e}')" title="${e}">${e}</button>`).join('')}
          ${isOwn ? `<button onclick="deleteMsg('${m.id}')" title="Delete">ğŸ—‘ï¸</button>` : ''}
        </div>
      </div>`;
  });
  return html;
}

function sendDMMsg(partner) {
  const input = document.getElementById('dm-msg-input');
  const text = input?.value.trim();
  if (!text) return;
  FortizedSocial.sendDMMessage(currentUser.username, partner, text);
  input.value = '';
  input.style.height = '';
  renderDMChatArea(partner);
  refreshDMLeftPanel();
}

function dmKeydown(e, partner) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDMMsg(partner); }
}

// â”€â”€ BASTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openBastion(idx) {
  currentBastion = idx;
  currentChannel = null;
  const b = currentUser.bastions[idx];
  if (!b.channels || b.channels.length === 0) {
    b.channels = [{name:'general',id:'general'},{name:'announcements',id:'announcements'}];
    saveUser();
  }

  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((el, i) => el.classList.toggle('active', i === idx));

  // Hide all views, show bastion
  document.getElementById('view-home').classList.remove('active');
  document.getElementById('view-home').style.display = 'none';
  ['view-discover','view-atelier','view-profile'].forEach(id => {
    const el = document.getElementById(id);
    if (el) { el.style.display = 'none'; el.classList.remove('active'); }
  });

  const bastionView = document.getElementById('view-bastion');
  bastionView.style.display = 'flex';

  setSidebar('bastion');
  setTopbar('ğŸ°', b.name, b.desc || `Welcome to ${b.name}`);
  document.getElementById('member-list-toggle').style.display = 'flex';

  openChannel(idx, 0);
}

function openChannel(bastionIdx, chIdx) {
  currentBastion = bastionIdx;
  currentChannel = chIdx;
  const b = currentUser.bastions[bastionIdx];
  const ch = b.channels[chIdx];
  const chId = ch.id || ch.name;

  setTopbar('#', ch.name, `${b.name} â€º #${ch.name}`);

  document.querySelectorAll('.channel-item').forEach((el, i) => el.classList.toggle('active', i === chIdx));

  const msgs = FortizedSocial.getBastionChannelMessages(bastionIdx + '_' + currentUser.username, chId);
  // fall back to local if no shared msgs
  const localMsgs = ch.messages || [];
  const allMsgs = msgs.length > 0 ? msgs : localMsgs;

  const main = document.getElementById('bastion-main');
  main.innerHTML = `
    <div class="chat-view">
      ${ch.pinned ? `<div class="pinned-banner" onclick="toast('Pinned messages coming soon','info')">ğŸ“Œ <strong>${ch.pinned}</strong></div>` : ''}
      <div class="chat-messages" id="bastion-msgs">
        <div class="chat-welcome">
          <div class="welcome-avatar" style="border-radius:12px;font-size:18px;">#</div>
          <h3>#${ch.name}</h3>
          <p>Beginning of <strong>#${ch.name}</strong>. Say hello!</p>
        </div>
        ${renderBastionMessages(allMsgs, bastionIdx, chId)}
      </div>
      <div class="typing-indicator"></div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button onclick="toast('File upload coming soon','info')">ğŸ“</button>
            <button onclick="showEmojiQuick('bastion','${bastionIdx}_${chId}')">ğŸ˜Š</button>
          </div>
          <textarea id="bastion-msg-input" placeholder="Message #${ch.name}" rows="1"
            onkeydown="bastionKeydown(event,${bastionIdx},'${chId}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendBastionMsg(${bastionIdx},'${chId}')">â¤</button>
        </div>
      </div>
    </div>
  `;
  scrollChatToBottom('bastion-msgs');

  if (memberListVisible) buildMemberList(bastionIdx);
}

function renderBastionMessages(msgs, bastionIdx, chId) {
  if (!msgs || msgs.length === 0) return '';
  let html = '';
  msgs.forEach((m, i) => {
    const isOwn = m.from === currentUser.username;
    const prev = msgs[i - 1];
    const isCont = prev && prev.from === m.from;
    const reactions = m.reactions || {};
    const reactionHTML = Object.entries(reactions).map(([emoji, users]) => {
      const mine = users.includes(currentUser.username);
      return `<div class="reaction-pill ${mine ? 'mine' : ''}" onclick="handleBastionReaction(${bastionIdx},'${chId}','${m.id}','${emoji}')" title="${users.join(', ')}">
        ${emoji} <span class="r-count">${users.length}</span>
      </div>`;
    }).join('');
    html += `
      <div class="msg-group ${isOwn ? 'own' : ''} ${isCont ? 'msg-cont' : ''}" data-msgid="${m.id || ''}">
        <div class="msg-avatar" onclick="viewUserProfile('${m.from}')">${m.from[0].toUpperCase()}</div>
        <div class="msg-content">
          <div class="msg-meta">
            <span class="msg-author">${m.from}</span>
            <span class="msg-time">${m.time || ''}</span>
          </div>
          <div class="msg-bubble">${parseMarkdown(escapeHTML(m.text))}</div>
          ${reactionHTML ? `<div class="msg-reactions">${reactionHTML}</div>` : ''}
        </div>
        <div class="msg-actions">
          ${QUICK_REACTIONS.slice(0,4).map(e => `<button onclick="handleBastionReaction(${bastionIdx},'${chId}','${m.id}','${e}')" title="${e}">${e}</button>`).join('')}
        </div>
      </div>`;
  });
  return html;
}

function sendBastionMsg(bIdx, chId) {
  const input = document.getElementById('bastion-msg-input');
  const text = input?.value.trim();
  if (!text) return;
  const key = bIdx + '_' + currentUser.username;
  FortizedSocial.sendBastionChannelMessage(key, chId, currentUser.username, text);
  // Also save locally for fallback
  const b = currentUser.bastions[bIdx];
  const ch = b.channels.find(c => (c.id || c.name) === chId);
  if (ch) {
    if (!ch.messages) ch.messages = [];
    const now = new Date();
    ch.messages.push({ id: Date.now().toString(), from: currentUser.username, text, time: now.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}), timestamp: now.toISOString(), reactions: {} });
    saveUser();
  }
  input.value = '';
  input.style.height = '';
  openChannel(bIdx, currentChannel);
}

function bastionKeydown(e, bIdx, chId) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBastionMsg(bIdx, chId); }
}

function addChannel(bIdx) {
  const name = prompt('Channel name (lowercase, no spaces):');
  if (!name?.trim()) return;
  const clean = name.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  if (!clean) { toast('Invalid name', 'error'); return; }
  if (currentUser.bastions[bIdx].channels.find(c => c.name === clean)) { toast('Channel exists', 'error'); return; }
  currentUser.bastions[bIdx].channels.push({ name: clean, id: clean, messages: [] });
  saveUser();
  setSidebar('bastion');
  toast('#' + clean + ' created!', 'success');
}

function addChannelAbove(bIdx, chIdx) { addChannel(bIdx); }

function buildMemberList(bIdx) {
  const el = document.getElementById('member-list');
  if (!el) return;
  const b = currentUser.bastions[bIdx];
  const members = b.members || [currentUser.username];
  el.innerHTML = `
    <div class="member-list-header">Members â€” ${members.length}</div>
    <div class="role-section" style="color:var(--green);">ğŸŸ¢ Online</div>
    ${members.map(m => {
      const status = FortizedSocial.getStatus(m);
      return `
      <div class="member-entry" onclick="viewUserProfile('${m}')">
        <div class="m-avatar">
          <span>${m[0].toUpperCase()}</span>
          <div class="m-status ${status}"></div>
        </div>
        <div class="m-info">
          <div class="m-name">${m}${m === currentUser.username ? ' (you)' : ''}</div>
          <div class="m-role">${m === b.owner || m === currentUser.username ? 'Owner' : 'Member'}</div>
        </div>
      </div>`;
    }).join('')}
  `;
}

function toggleMemberList() {
  memberListVisible = !memberListVisible;
  const el = document.getElementById('member-list');
  if (el) {
    el.style.display = memberListVisible ? 'flex' : 'none';
    if (memberListVisible && currentBastion !== null) buildMemberList(currentBastion);
  }
}

function showChannelCtxMenu(e, bIdx, cIdx) {
  e.preventDefault();
  const ch = currentUser.bastions[bIdx].channels[cIdx];
  showCtxMenu(e.clientX, e.clientY, [
    { label: `# ${ch.name}`, disabled: true },
    { sep: true },
    { label: 'ğŸ“Œ Pin a Message', action: () => toast('Pinning coming soon','info') },
    { label: 'âœï¸ Edit Channel', action: () => toast('Edit coming soon','info') },
    { sep: true },
    { label: 'ğŸ—‘ï¸ Delete Channel', action: () => deleteChannel(bIdx, cIdx), danger: true },
  ]);
}

function deleteChannel(bIdx, cIdx) {
  if (currentUser.bastions[bIdx].channels.length <= 1) { toast("Can't delete the last channel",'error'); return; }
  currentUser.bastions[bIdx].channels.splice(cIdx, 1);
  saveUser();
  setSidebar('bastion');
  openChannel(bIdx, 0);
  toast('Channel deleted','info');
}

function openBastionSettings() {
  toast('Bastion settings coming soon','info');
}

// â”€â”€ CREATE BASTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildEmojiPicker() {
  const picker = document.getElementById('bastion-emoji-picker');
  if (!picker) return;
  picker.innerHTML = '';
  EMOJIS.forEach(e => {
    const btn = document.createElement('div');
    btn.className = 'emoji-option';
    btn.textContent = e;
    btn.onclick = () => {
      picker.querySelectorAll('.emoji-option').forEach(d => d.classList.remove('selected'));
      btn.classList.add('selected');
      picker.dataset.selected = e;
    };
    picker.appendChild(btn);
  });
  picker.dataset.selected = EMOJIS[0];
  picker.querySelector('.emoji-option').classList.add('selected');
}

function openCreateBastion() {
  document.getElementById('bastion-name-input').value = '';
  document.getElementById('bastion-desc-input').value = '';
  document.getElementById('create-error').textContent = '';
  buildEmojiPicker();
  openModal('modal-create-bastion');
}

function createBastion() {
  const name = document.getElementById('bastion-name-input').value.trim();
  const desc = document.getElementById('bastion-desc-input').value.trim();
  const icon = document.getElementById('bastion-emoji-picker').dataset.selected || 'ğŸ°';
  if (!name) { document.getElementById('create-error').textContent = 'Name is required.'; return; }
  const bastion = {
    name, desc, icon,
    channels: [
      { name: 'general', id: 'general', messages: [] },
      { name: 'announcements', id: 'announcements', messages: [] },
      { name: 'off-topic', id: 'off-topic', messages: [] }
    ],
    members: [currentUser.username],
    owner: currentUser.username,
    createdAt: new Date().toISOString()
  };
  currentUser.bastions.push(bastion);
  saveUser();
  closeModal('modal-create-bastion');
  buildRailBastions();
  toast(`${icon} ${name} created!`, 'success');
  openBastion(currentUser.bastions.length - 1);
}

// â”€â”€ DISCOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDiscoverGrid() {
  renderDiscoverGrid(PUBLIC_BASTIONS);
}

function setDiscoverTab(tab, el) {
  discoverTab = tab;
  document.querySelectorAll('.discover-tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  filterBastions();
}

function filterBastions() {
  const q = document.getElementById('discover-search-input')?.value.toLowerCase() || '';
  let filtered = PUBLIC_BASTIONS;
  if (discoverTab !== 'all') filtered = filtered.filter(b => b.category === discoverTab);
  if (q) filtered = filtered.filter(b => b.name.toLowerCase().includes(q) || b.desc.toLowerCase().includes(q) || (b.tags||[]).some(t => t.toLowerCase().includes(q)));
  renderDiscoverGrid(filtered);
}

function renderDiscoverGrid(bastions) {
  const grid = document.getElementById('bastion-grid');
  if (!grid) return;
  if (bastions.length === 0) {
    grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No bastions found.</div>';
    return;
  }
  grid.innerHTML = bastions.map(b => `
    <div class="bastion-card">
      <div class="bastion-banner">${b.icon}</div>
      <div class="bastion-body">
        <div class="bastion-meta">
          <div class="bastion-icon">${b.icon}</div>
          <div class="bastion-name">${b.name}</div>
        </div>
        <div class="bastion-desc">${b.desc}</div>
        <div class="bastion-stats">
          <span>ğŸ‘¥ ${b.members.toLocaleString()}</span>
          <span style="color:var(--green);">â— ${b.online} online</span>
        </div>
        <div class="bastion-tags">${(b.tags||[]).map(t => `<span class="bastion-tag">${t}</span>`).join('')}</div>
        <button class="btn-accent" style="width:100%;justify-content:center;margin-top:10px;font-size:12.5px;padding:8px;" onclick="toast('Public join coming soon!','info')">Join Bastion</button>
      </div>
    </div>
  `).join('');
}

// â”€â”€ ATELIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDailyBtn() {
  const btn = document.getElementById('daily-btn');
  const status = document.getElementById('daily-status');
  if (!btn || !status) return;
  const today = new Date().toDateString();
  if (currentUser.lastDaily === today) {
    btn.classList.add('claimed');
    status.textContent = 'Claimed today âœ“';
  } else {
    btn.classList.remove('claimed');
    status.textContent = 'Claim now â†’';
  }
}

function claimDaily() {
  const today = new Date().toDateString();
  if (currentUser.lastDaily === today) { toast('Already claimed today!', 'info'); return; }
  currentUser.onyx += 5;
  currentUser.lastDaily = today;
  saveUser();
  updateOnyxDisplay();
  updateDailyBtn();
  toast('+5 Onyx claimed! ğŸ’', 'success');
  FortizedSocial.playNotificationSound();
}

function buyRadiance(cost, label) {
  pendingBuy = { cost, label };
  document.getElementById('buy-confirm-title').textContent = `Activate Radiance â€” ${label}?`;
  document.getElementById('buy-confirm-sub').textContent = `This will deduct ${cost} Onyx. You have ${currentUser.onyx} Onyx.`;
  openModal('modal-buy-confirm');
}

function confirmBuy() {
  if (!pendingBuy) return;
  if (currentUser.onyx < pendingBuy.cost) { toast('Not enough Onyx!', 'error'); closeModal('modal-buy-confirm'); return; }
  currentUser.onyx -= pendingBuy.cost;
  const days = pendingBuy.label.includes('30') ? 30 : pendingBuy.label.includes('7') ? 7 : 1;
  const exp = new Date();
  exp.setDate(exp.getDate() + days);
  currentUser.radianceUntil = exp.toISOString();
  saveUser();
  updateOnyxDisplay();
  closeModal('modal-buy-confirm');
  toast(`âœ¨ Radiance activated for ${pendingBuy.label}!`, 'success');
  FortizedSocial.playNotificationSound();
  pendingBuy = null;
  renderHomeLanding();
}

// â”€â”€ PROFILE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildProfileView() {
  const ab = document.getElementById('profile-avatar-big');
  if (ab) ab.innerHTML = currentUser.pfp ? `<img src="${currentUser.pfp}">` : `<span style="font-size:30px;">${currentUser.username[0].toUpperCase()}</span>`;
  const nb = document.getElementById('profile-name-big');
  if (nb) nb.textContent = currentUser.username;
  const ph = document.getElementById('profile-handle');
  if (ph) ph.textContent = '@' + currentUser.username;
  const ed = document.getElementById('profile-email-display');
  if (ed) ed.textContent = currentUser.email || 'â€”';
  const stats = document.getElementById('profile-stats');
  if (stats) {
    const hasRadiance = currentUser.radianceUntil && new Date(currentUser.radianceUntil) > new Date();
    stats.innerHTML = `
      <div class="profile-stat"><div class="profile-stat-val">${currentUser.onyx}</div><div class="profile-stat-key">Onyx</div></div>
      <div class="profile-stat"><div class="profile-stat-val">${currentUser.friends.length}</div><div class="profile-stat-key">Friends</div></div>
      <div class="profile-stat"><div class="profile-stat-val">${currentUser.bastions.length}</div><div class="profile-stat-key">Bastions</div></div>
      <div class="profile-stat"><div class="profile-stat-val" style="font-size:15px;">${hasRadiance ? 'âœ¨' : 'â€”'}</div><div class="profile-stat-key">Radiance</div></div>
    `;
  }
}

function setUserStatus(status) {
  currentUser.status = status;
  saveUser();
  FortizedSocial.setStatus(currentUser.username, status);
  const tag = document.getElementById('userbar-tag');
  const icons = { online: 'â— Online', away: 'â— Away', dnd: 'â— Do Not Disturb', invisible: 'â— Invisible' };
  if (tag) tag.textContent = icons[status] || 'â— Online';
  toast(`Status set to ${status}`, 'info');
}

// â”€â”€ NOTIFICATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleNotifPanel() {
  notifPanelOpen = !notifPanelOpen;
  const panel = document.getElementById('notif-panel');
  panel.classList.toggle('open', notifPanelOpen);
  if (notifPanelOpen) buildNotifList();
}

function buildNotifList() {
  refreshCurrentUser();
  const list = document.getElementById('notif-list');
  if (!list) return;
  const notifs = FortizedSocial.getNotifications(currentUser.username);
  if (notifs.length === 0) {
    list.innerHTML = '<div class="notif-empty">âœ“ You\'re all caught up!</div>';
    return;
  }
  list.innerHTML = notifs.map(n => {
    let icon = 'ğŸ””', text = '';
    if (n.type === 'friend_request') {
      icon = 'ğŸ‘¥';
      text = `<strong>${n.from}</strong> sent you a friend request`;
    } else if (n.type === 'friend_accept') {
      icon = 'ğŸ¤';
      text = `<strong>${n.from}</strong> accepted your friend request`;
    } else if (n.type === 'dm') {
      icon = 'ğŸ’¬';
      text = `<strong>${n.from}</strong>: ${escapeHTML(n.data?.preview || '')}`;
    }
    const actionBtns = n.type === 'friend_request' ? `
      <div class="notif-actions">
        <button class="btn-accept" onclick="acceptFriendFromNotif('${n.from}','${n.id}')">âœ“ Accept</button>
        <button class="btn-decline" onclick="declineFriendFromNotif('${n.from}','${n.id}')">Decline</button>
      </div>` : '';
    const timeAgo = formatTimeAgo(n.time);
    return `
      <div class="notif-item ${n.read ? '' : 'unread'}" id="notif-${n.id}">
        <div class="notif-icon">${icon}</div>
        <div class="notif-text">
          <p>${text}</p>
          <div class="notif-time">${timeAgo}</div>
          ${actionBtns}
        </div>
      </div>`;
  }).join('');
}

function acceptFriendFromNotif(from, notifId) {
  acceptFriend(from);
  markNotifRead(notifId);
  buildNotifList();
}

function declineFriendFromNotif(from, notifId) {
  declineFriend(from);
  markNotifRead(notifId);
  buildNotifList();
}

function markNotifRead(notifId) {
  const n = currentUser.notifications.find(n => n.id === notifId);
  if (n) { n.read = true; saveUser(); }
}

function markAllRead() {
  FortizedSocial.markNotificationsRead(currentUser.username);
  refreshCurrentUser();
  updateNotifBadge();
  buildNotifList();
}

function formatTimeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const mins = Math.floor(diff / 60000);
  if (mins < 1) return 'just now';
  if (mins < 60) return `${mins}m ago`;
  const hours = Math.floor(mins / 60);
  if (hours < 24) return `${hours}h ago`;
  return `${Math.floor(hours / 24)}d ago`;
}

// â”€â”€ REACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleReaction(msgId, emoji) {
  // DM reactions stored locally for now
  toast(`${emoji} reaction!`, 'info');
}

function handleBastionReaction(bIdx, chId, msgId, emoji) {
  const key = bIdx + '_' + currentUser.username;
  FortizedSocial.addReaction(key, chId, msgId, emoji, currentUser.username);
  openChannel(bIdx, currentChannel);
}

// â”€â”€ VIEW USER PROFILE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function viewUserProfile(username) {
  const user = FortizedSocial.getUserByName(username);
  const body = document.getElementById('user-profile-body');
  if (!user) { toast('User not found', 'error'); return; }
  const isFriend = (currentUser.friends || []).includes(username);
  const isOwn = username === currentUser.username;
  const status = FortizedSocial.getStatus(username);
  body.innerHTML = `
    <div style="text-align:center;padding:8px 0 16px;">
      <div style="width:64px;height:64px;border-radius:50%;background:var(--panel2);border:2px solid rgba(255,249,62,.2);
        font-size:24px;display:flex;align-items:center;justify-content:center;margin:0 auto 10px;">
        ${user.pfp ? `<img src="${user.pfp}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">` : user.username[0].toUpperCase()}
      </div>
      <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">${user.username}</div>
      <div style="font-size:12px;color:var(--muted-light);">@${user.username}</div>
      <div style="font-size:12px;margin-top:4px;" class="status-${status}">â— ${status}</div>
    </div>
    ${!isOwn ? `<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
      <button class="btn-ghost" onclick="startDMWith('${username}');closeModal('modal-user-profile')" style="font-size:12.5px;padding:7px 14px;">ğŸ’¬ Message</button>
      ${isFriend ? `<button class="btn-danger" onclick="removeFriend('${username}');closeModal('modal-user-profile')" style="font-size:12.5px;padding:7px 14px;">Remove Friend</button>`
        : `<button class="btn-accent" onclick="openAddFriendTo('${username}')" style="font-size:12.5px;padding:7px 14px;">+ Add Friend</button>`}
    </div>` : ''}
    <button class="btn-ghost" onclick="closeModal('modal-user-profile')" style="width:100%;justify-content:center;font-size:12.5px;">Close</button>
  `;
  openModal('modal-user-profile');
}

function openAddFriendTo(username) {
  closeModal('modal-user-profile');
  const result = FortizedSocial.sendFriendRequest(currentUser.username, username);
  toast(result.msg, result.ok ? 'success' : 'error');
  if (result.ok) refreshCurrentUser();
}

// â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showCtxMenu(x, y, items) {
  const menu = document.getElementById('ctx-menu');
  menu.innerHTML = '';
  menu.className = 'ctx-menu';
  items.forEach(item => {
    if (item.sep) {
      const sep = document.createElement('div');
      sep.className = 'ctx-sep';
      menu.appendChild(sep);
      return;
    }
    if (item.disabled) {
      const el = document.createElement('div');
      el.className = 'ctx-item';
      el.textContent = item.label;
      el.style.cssText = 'opacity:.5;cursor:default;font-weight:700;font-size:12px;letter-spacing:.06em;';
      menu.appendChild(el);
      return;
    }
    const el = document.createElement('div');
    el.className = 'ctx-item' + (item.danger ? ' danger' : '');
    el.textContent = item.label;
    el.onclick = (e) => { e.stopPropagation(); item.action(); menu.style.display = 'none'; };
    menu.appendChild(el);
  });
  // Position
  menu.style.display = 'block';
  menu.style.left = Math.min(x, window.innerWidth - 200) + 'px';
  menu.style.top = Math.min(y, window.innerHeight - menu.offsetHeight - 10) + 'px';
}

// â”€â”€ SEARCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleTopSearch() {
  const q = document.getElementById('topbar-search-input').value.trim();
  if (!q) return;
  // Simple: search messages in current channel
  toast(`Search: "${q}" â€” full search coming soon`, 'info');
}

// â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scrollChatToBottom(id) {
  setTimeout(() => {
    const el = document.getElementById(id);
    if (el) el.scrollTop = el.scrollHeight;
  }, 60);
}

function autoResize(el) {
  el.style.height = '';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function parseMarkdown(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code style="background:rgba(255,255,255,.08);padding:1px 5px;border-radius:4px;font-size:12.5px;">$1</code>')
    .replace(/~~(.+?)~~/g, '<s>$1</s>');
}

function showEmojiQuick(context, target) {
  toast('Emoji picker coming soon', 'info');
}

function deleteMsg(id) {
  toast('Message deleted (local)', 'info');
}

function toggleNotifSetting() {
  const t = document.getElementById('notif-toggle');
  t.classList.toggle('on');
}

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

let toastTimer;
function toast(msg, type = 'info') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast show ' + type;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}

function escapeHTML(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function logout() {
  FortizedSocial.setStatus(currentUser.username, 'offline');
  FortizedSocial.stopPolling();
  localStorage.removeItem('fortized_current_user');
  window.location.href = 'login.html';
}

// Close modals on overlay click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', e => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// Close notif panel on outside click
document.addEventListener('click', e => {
  const panel = document.getElementById('notif-panel');
  const bell = document.getElementById('rail-notif');
  if (!panel.contains(e.target) && !bell.contains(e.target)) {
    panel.classList.remove('open');
    notifPanelOpen = false;
  }
});
</script>
</body>
</html>
