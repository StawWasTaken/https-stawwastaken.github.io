<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<script src="social.js"></script>
<style>
/* ‚ïê‚ïê‚ïê TOKENS ‚ïê‚ïê‚ïê */
:root {
  --accent: #fff93e;
  --accent-dim: rgba(255,249,62,.1);
  --accent-mid: rgba(255,249,62,.22);
  --bg: #07090e;
  --rail: #04060a;
  --sidebar: #0b0e15;
  --channel: #0d1018;
  --panel: #101420;
  --panel2: #131822;
  --panel3: #161c28;
  --border: #1c2335;
  --radius: 16px;
  --muted: #4e5a6f;
  --muted-light: #7d8a9e;
  --text: #dde3ed;
  --green: #3ecf6e;
  --red: #f87171;
  --yellow: #f59e0b;
  --blue: #60a5fa;
}
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg); color: var(--text); font-family: 'DM Sans', sans-serif; display: flex; }
::selection { background: rgba(255,249,62,.2); }
::-webkit-scrollbar { width: 4px; height: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: #1e2840; border-radius: 4px; }

/* ‚ïê‚ïê‚ïê RAIL ‚ïê‚ïê‚ïê */
.rail {
  width: 68px; min-width: 68px;
  background: var(--rail);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; align-items: center;
  padding: 12px 0; gap: 4px; z-index: 10;
  box-shadow: 2px 0 24px rgba(0,0,0,.5);
}
.rail-logo {
  width: 40px; height: 40px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 6px;
}
.rail-logo img { width: 34px; height: 34px; object-fit: contain; filter: drop-shadow(0 0 8px rgba(255,249,62,.3)); }
.rail-sep { width: 30px; height: 1px; background: var(--border); margin: 5px 0; opacity: .4; }
.rail-btn {
  width: 44px; height: 44px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; transition: all .15s; position: relative; flex-shrink: 0; font-size: 18px;
}
.rail-btn:hover { background: rgba(255,255,255,.07); border-radius: 12px; }
.rail-btn.active { background: var(--accent-dim); border-radius: 12px; }
.rail-btn.active::before {
  content: ""; position: absolute; left: -12px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 22px; background: var(--accent); border-radius: 0 4px 4px 0;
}
.rail-btn[data-tip]:hover::after {
  content: attr(data-tip); position: absolute; left: calc(100% + 10px); top: 50%; transform: translateY(-50%);
  background: #0c1020; border: 1px solid var(--border);
  color: var(--text); font-size: 12px; font-weight: 600; padding: 5px 10px; border-radius: 9px;
  white-space: nowrap; z-index: 999; pointer-events: none; box-shadow: 0 4px 20px rgba(0,0,0,.5);
}
.rail-bastion {
  width: 42px; height: 42px; border-radius: 14px;
  background: var(--panel); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 17px;
  transition: all .15s; position: relative; overflow: hidden; flex-shrink: 0;
}
.rail-bastion:hover, .rail-bastion.active { border-color: var(--accent); border-radius: 12px; background: var(--accent-dim); }
.rail-bastion.active::before {
  content: ""; position: absolute; left: -12px; top: 50%; transform: translateY(-50%);
  width: 3px; height: 22px; background: var(--accent); border-radius: 0 4px 4px 0;
}
.rail-notif-badge {
  position: absolute; top: 2px; right: 2px;
  min-width: 16px; height: 16px; border-radius: 8px;
  background: var(--red); color: #fff; font-size: 9px; font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  border: 2px solid var(--rail); padding: 0 2px;
}

/* ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê */
.sidebar {
  width: 240px; min-width: 240px;
  background: var(--sidebar);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
}
.sidebar-header {
  height: 52px; display: flex; align-items: center;
  padding: 0 14px; border-bottom: 1px solid var(--border);
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  flex-shrink: 0; gap: 7px; background: rgba(0,0,0,.15);
}
.sidebar-header .hdr-actions { margin-left: auto; display: flex; gap: 2px; }
.sidebar-header .hdr-actions button {
  width: 28px; height: 28px; border-radius: 9px;
  background: transparent; border: none; color: var(--muted);
  font-size: 15px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .1s;
}
.sidebar-header .hdr-actions button:hover { background: rgba(255,255,255,.07); color: #fff; }
.sidebar-scroll { flex: 1; overflow-y: auto; padding: 6px 0; }
.sec-label {
  font-size: 10px; font-weight: 700; letter-spacing: .1em;
  text-transform: uppercase; color: var(--muted);
  padding: 12px 14px 5px;
  display: flex; align-items: center; justify-content: space-between;
}
.sec-label button {
  background: none; border: none; color: var(--muted); font-size: 17px;
  cursor: pointer; width: 18px; height: 18px; border-radius: 5px;
  display: flex; align-items: center; justify-content: center; transition: all .1s;
}
.sec-label button:hover { background: rgba(255,255,255,.07); color: #fff; }
.s-item {
  display: flex; align-items: center; gap: 9px;
  padding: 7px 10px; margin: 1px 6px; border-radius: 10px;
  cursor: pointer; font-size: 13px; color: var(--muted-light);
  transition: all .1s;
}
.s-item:hover { background: rgba(255,255,255,.05); color: #fff; }
.s-item.active { background: rgba(255,249,62,.08); color: var(--accent); }
.s-item .s-icon {
  width: 26px; height: 26px; border-radius: 50%;
  background: var(--panel); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  font-size: 13px; flex-shrink: 0;
}
.s-item .s-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.s-item .s-badge {
  background: var(--red); color: #fff; font-size: 9px; font-weight: 800;
  padding: 1px 6px; border-radius: 100px; min-width: 18px; text-align: center; flex-shrink: 0;
}
.ch-item {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 8px; margin: 1px 6px; border-radius: 10px;
  cursor: pointer; font-size: 12.5px; color: var(--muted);
  transition: all .1s;
}
.ch-item:hover { background: rgba(255,255,255,.05); color: var(--text); }
.ch-item.active { background: rgba(255,249,62,.08); color: var(--accent); }
.cat-row {
  display: flex; align-items: center; gap: 5px;
  padding: 10px 8px 4px 10px;
  font-size: 10px; font-weight: 700; letter-spacing: .08em;
  text-transform: uppercase; color: var(--muted); cursor: pointer;
  transition: color .1s;
}
.cat-row:hover { color: var(--text); }
.cat-row button {
  margin-left: auto; background: none; border: none; color: inherit;
  cursor: pointer; font-size: 14px; opacity: 0;
  width: 16px; height: 16px; display: flex; align-items: center; justify-content: center;
  transition: opacity .1s;
}
.cat-row:hover button { opacity: 1; }
.friend-item {
  display: flex; align-items: center; gap: 9px;
  padding: 6px 10px; margin: 1px 6px; border-radius: 10px;
  cursor: pointer; transition: background .1s;
}
.friend-item:hover { background: rgba(255,255,255,.05); }
.friend-item.active { background: rgba(255,249,62,.07); }
.fa {
  position: relative; flex-shrink: 0;
  border-radius: 50%; overflow: hidden;
  background: var(--panel); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
}
.fa img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.fa .fs {
  position: absolute; bottom: -1px; right: -1px;
  width: 10px; height: 10px; border-radius: 50%;
  border: 2px solid var(--sidebar);
}
.fs.online { background: var(--green); }
.fs.away { background: var(--yellow); }
.fs.dnd { background: var(--red); }
.fs.offline { background: #374151; }
.fi-info { flex: 1; min-width: 0; }
.fi-name { font-size: 13px; font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.fi-sub { font-size: 11px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* userbar */
.userbar {
  height: 56px; background: rgba(4,6,10,.8); border-top: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 8px; gap: 7px; flex-shrink: 0;
}
.ua {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--panel); border: 2px solid var(--border);
  font-size: 13px; display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0; position: relative; cursor: pointer;
}
.ua img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.ua .ua-ring {
  position: absolute; bottom: -1px; right: -1px;
  width: 11px; height: 11px; border-radius: 50%;
  background: var(--green); border: 2px solid var(--sidebar);
}
.ua-info { flex: 1; min-width: 0; }
.ua-name { font-size: 13px; font-weight: 600; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.ua-tag { font-size: 10.5px; color: var(--muted); }
.ua-btns { display: flex; gap: 2px; }
.ua-btns button {
  width: 28px; height: 28px; border-radius: 9px; background: transparent; border: none;
  color: var(--muted); font-size: 14px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; transition: all .1s;
}
.ua-btns button:hover { background: rgba(255,255,255,.07); color: #fff; }

/* ‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê */
.main { flex: 1; min-width: 0; display: flex; flex-direction: column; }
.topbar {
  height: 52px; background: rgba(8,11,18,.96); backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; padding: 0 18px; gap: 10px; flex-shrink: 0;
  box-shadow: 0 2px 20px rgba(0,0,0,.3);
}
.topbar-title {
  font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700;
  display: flex; align-items: center; gap: 7px; white-space: nowrap;
}
.tb-sep { width: 1px; height: 18px; background: var(--border); margin: 0 2px; }
.tb-desc { font-size: 12.5px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; }
.tb-actions { margin-left: auto; display: flex; align-items: center; gap: 6px; }
.tb-actions button {
  background: transparent; border: none; color: var(--muted);
  font-size: 16px; cursor: pointer; width: 32px; height: 32px;
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  transition: all .1s;
}
.tb-actions button:hover { background: rgba(255,255,255,.07); color: #fff; }
.onyx-pill {
  display: flex; align-items: center; gap: 5px;
  background: var(--accent-dim); border: 1px solid var(--accent-mid);
  border-radius: 100px; padding: 5px 12px;
  font-size: 12px; font-weight: 700; color: var(--accent);
  cursor: pointer; transition: background .12s;
}
.onyx-pill:hover { background: rgba(255,249,62,.16); }
.onyx-pill img { width: 14px; height: 14px; object-fit: contain; }
.tb-search {
  display: flex; align-items: center; gap: 6px;
  background: rgba(255,255,255,.04); border: 1px solid var(--border);
  border-radius: 10px; padding: 5px 10px; width: 170px; transition: all .2s;
}
.tb-search:focus-within { border-color: rgba(255,249,62,.2); width: 210px; }
.tb-search input {
  background: transparent; border: none; outline: none;
  color: #fff; font-family: 'DM Sans', sans-serif; font-size: 12.5px; flex: 1;
}
.tb-search input::placeholder { color: var(--muted); }
.content { flex: 1; overflow: hidden; position: relative; display: flex; }
.view { display: none; flex: 1; }
.view.active { display: flex; }

/* ‚ïê‚ïê‚ïê HOME ‚Äî BIG, PROPER LAYOUT ‚ïê‚ïê‚ïê */
.home-wrap { flex: 1; display: flex; overflow: hidden; }
.home-dm-sidebar {
  width: 250px; min-width: 250px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  background: var(--channel);
}
.home-dm-header {
  height: 52px; display: flex; align-items: center;
  padding: 0 14px; border-bottom: 1px solid var(--border);
  font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
  flex-shrink: 0;
}
.home-dm-header .hdr-actions { margin-left: auto; display: flex; gap: 2px; }
.home-dm-header .hdr-actions button {
  width: 28px; height: 28px; border-radius: 9px;
  background: transparent; border: none; color: var(--muted);
  font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all .1s;
}
.home-dm-header .hdr-actions button:hover { background: rgba(255,255,255,.07); color: #fff; }
.home-feed { flex: 1; overflow-y: auto; }
.home-right { width: 290px; min-width: 290px; border-left: 1px solid var(--border); overflow-y: auto; background: var(--channel); }

/* Banner */
.home-banner {
  width: 100%; height: 200px;
  background: linear-gradient(135deg, #0d1a38, #181040, #0d2838);
  position: relative; overflow: hidden; flex-shrink: 0;
}
.home-banner img.banner-img {
  width: 100%; height: 100%; object-fit: cover;
  object-position: center 30%; opacity: .55;
}
.home-banner .banner-overlay {
  position: absolute; inset: 0;
  background: linear-gradient(to right, rgba(7,9,14,.92) 0%, rgba(7,9,14,.5) 55%, transparent);
  display: flex; align-items: center; padding: 0 36px; gap: 14px;
}
.home-banner .banner-text h2 {
  font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800;
  letter-spacing: -.3px; color: #fff; text-shadow: 0 2px 12px rgba(0,0,0,.5);
  margin-bottom: 4px;
}
.home-banner .banner-text p { font-size: 14px; color: rgba(255,255,255,.7); }
.home-banner .knight-img {
  width: 120px; height: 120px; object-fit: contain;
  filter: drop-shadow(0 4px 20px rgba(0,0,0,.6));
  position: absolute; right: 32px; bottom: 0;
}
.home-main-scroll { padding: 28px 28px 36px; max-width: 820px; }

/* Section headers */
.section-hdr {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.section-hdr h3 {
  font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
  display: flex; align-items: center; gap: 8px;
}
.section-hdr h3::before { content: ""; width: 14px; height: 3px; background: var(--accent); border-radius: 2px; }
.section-hdr a { font-size: 12.5px; color: var(--muted-light); cursor: pointer; text-decoration: none; }
.section-hdr a:hover { color: var(--accent); }

/* Quick nav */
.quick-nav { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 28px; }
.qn-tile {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 18px; padding: 20px 16px;
  cursor: pointer; transition: all .15s;
  display: flex; flex-direction: column; gap: 10px; position: relative; overflow: hidden;
}
.qn-tile:hover { border-color: rgba(255,249,62,.18); transform: translateY(-2px); box-shadow: 0 8px 32px rgba(0,0,0,.3); }
.qn-icon {
  width: 44px; height: 44px; border-radius: 14px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
}
.qn-text h4 { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; margin-bottom: 2px; }
.qn-text p { font-size: 12px; color: var(--muted); }
.qn-badge {
  position: absolute; top: 10px; right: 10px;
  background: var(--red); color: #fff; font-size: 9px; font-weight: 800;
  padding: 2px 6px; border-radius: 100px;
}

/* Activity */
.activity-feed { display: flex; flex-direction: column; gap: 8px; margin-bottom: 28px; }
.activity-item {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 16px; cursor: pointer; transition: border-color .12s;
}
.activity-item:hover { border-color: rgba(255,249,62,.12); }
.act-icon {
  width: 40px; height: 40px; border-radius: 14px;
  background: var(--panel2); border: 1px solid var(--border);
  font-size: 18px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.act-text { flex: 1; }
.act-text p { font-size: 14px; color: var(--text); line-height: 1.5; }
.act-text p strong { font-weight: 700; }
.act-time { font-size: 11.5px; color: var(--muted); margin-top: 2px; }

/* Mini bastion */
.mini-bastion-row { display: flex; flex-direction: column; gap: 10px; margin-bottom: 28px; }
.mini-bastion {
  display: flex; align-items: center; gap: 12px;
  padding: 14px 16px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 16px; cursor: pointer; transition: border-color .12s;
}
.mini-bastion:hover { border-color: rgba(255,249,62,.15); }
.mb-icon {
  width: 44px; height: 44px; border-radius: 14px;
  background: var(--panel2); border: 1px solid var(--border);
  font-size: 20px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.mb-info { flex: 1; }
.mb-name { font-size: 14px; font-weight: 700; }
.mb-meta { font-size: 12px; color: var(--muted); margin-top: 2px; }
.mb-join {
  background: var(--accent-dim); border: 1px solid var(--accent-mid);
  color: var(--accent); font-size: 12px; font-weight: 700;
  padding: 6px 14px; border-radius: 10px; cursor: pointer;
  transition: background .12s; flex-shrink: 0;
}
.mb-join:hover { background: rgba(255,249,62,.18); }

/* Right panel */
.rp-section { padding: 16px 14px 8px; border-bottom: 1px solid var(--border); }
.rp-section:last-child { border-bottom: none; }
.rp-title {
  font-size: 10.5px; font-weight: 700; letter-spacing: .1em;
  text-transform: uppercase; color: var(--muted); margin-bottom: 10px;
}
.rp-notif {
  display: flex; gap: 9px; padding: 8px 10px; border-radius: 12px;
  cursor: pointer; transition: background .1s; margin-bottom: 4px;
}
.rp-notif:hover { background: rgba(255,255,255,.04); }
.rp-notif.unread { background: rgba(255,249,62,.04); }
.rp-notif .rn-icon {
  width: 30px; height: 30px; border-radius: 50%;
  background: var(--panel); border: 1px solid var(--border);
  font-size: 13px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.rp-notif .rn-text { flex: 1; }
.rp-notif .rn-text p { font-size: 12.5px; color: var(--text); line-height: 1.4; }
.rp-notif .rn-text p strong { font-weight: 700; }
.rp-notif .rn-time { font-size: 10.5px; color: var(--muted); }
.rp-notif .rn-actions { display: flex; gap: 5px; margin-top: 5px; }
.rn-accept { background: rgba(62,207,110,.15); border: 1px solid rgba(62,207,110,.3); color: var(--green); font-size: 11px; font-weight: 700; padding: 3px 11px; border-radius: 7px; cursor: pointer; }
.rn-decline { background: transparent; border: 1px solid var(--border); color: var(--muted-light); font-size: 11px; font-weight: 700; padding: 3px 11px; border-radius: 7px; cursor: pointer; }
.blog-post { padding: 10px; border-radius: 12px; cursor: pointer; transition: background .1s; margin-bottom: 4px; }
.blog-post:hover { background: rgba(255,255,255,.04); }
.blog-post .bp-tag { font-size: 10px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--accent); margin-bottom: 3px; }
.blog-post .bp-title { font-size: 13px; font-weight: 700; color: var(--text); margin-bottom: 3px; line-height: 1.4; }
.blog-post .bp-date { font-size: 11px; color: var(--muted); }

/* ‚ïê‚ïê‚ïê CHAT ‚ïê‚ïê‚ïê */
.chat-wrap { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
.chat-msgs {
  flex: 1; overflow-y: auto; padding: 16px 20px;
  display: flex; flex-direction: column; gap: 0;
}
.chat-welcome { padding: 20px 0 18px; border-bottom: 1px solid var(--border); margin-bottom: 18px; }
.chat-welcome .w-av {
  width: 60px; height: 60px; border-radius: 50%;
  background: var(--panel); border: 2px solid var(--border);
  font-size: 22px; display: flex; align-items: center; justify-content: center;
  margin-bottom: 12px; overflow: hidden;
}
.chat-welcome .w-av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.chat-welcome h3 { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 3px; }
.chat-welcome p { font-size: 13.5px; color: var(--muted-light); }
.date-div {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 0; margin: 6px 0;
  font-size: 10.5px; font-weight: 700; color: var(--muted); letter-spacing: .04em;
}
.date-div::before, .date-div::after { content: ""; flex: 1; height: 1px; background: var(--border); }
.msg-group {
  display: flex; gap: 10px; padding: 3px 0;
  border-radius: 10px; transition: background .08s; position: relative;
}
.msg-group:hover { background: rgba(255,255,255,.02); padding: 3px 6px; margin: 0 -6px; }
.msg-group.own { flex-direction: row-reverse; }
.msg-av {
  width: 34px; height: 34px; border-radius: 50%;
  background: var(--panel); border: 1px solid var(--border);
  font-size: 13px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; margin-top: 2px; overflow: hidden; cursor: pointer;
}
.msg-av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.msg-body { flex: 1; min-width: 0; }
.msg-meta { display: flex; align-items: baseline; gap: 8px; margin-bottom: 3px; }
.msg-author { font-size: 13px; font-weight: 700; color: #fff; cursor: pointer; }
.msg-author:hover { text-decoration: underline; }
.msg-time { font-size: 10.5px; color: var(--muted); }
.msg-bubble {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 5px 14px 14px 14px;
  padding: 8px 13px; font-size: 13.5px; color: var(--text);
  line-height: 1.55; word-break: break-word; max-width: 680px; display: inline-block;
}
.msg-group.own .msg-bubble {
  background: rgba(255,249,62,.09); border-color: rgba(255,249,62,.14);
  border-radius: 14px 5px 14px 14px;
}
.msg-group.own .msg-meta { flex-direction: row-reverse; }
.msg-cont .msg-av { opacity: 0; pointer-events: none; }
.msg-cont .msg-meta { display: none; }
.msg-cont .msg-bubble { margin-top: 2px; }
.msg-reactions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 4px; }
.r-pill {
  display: flex; align-items: center; gap: 4px;
  background: rgba(255,255,255,.05); border: 1px solid var(--border);
  border-radius: 100px; padding: 2px 9px; font-size: 12.5px; cursor: pointer; transition: background .1s;
}
.r-pill:hover { background: rgba(255,255,255,.09); }
.r-pill.mine { background: var(--accent-dim); border-color: var(--accent-mid); color: var(--accent); }
.msg-acts {
  display: none; gap: 2px; position: absolute; right: 10px; top: -13px;
  background: var(--panel2); border: 1px solid var(--border);
  border-radius: 10px; padding: 3px; z-index: 10;
}
.msg-group:hover .msg-acts { display: flex; }
.msg-acts button {
  background: none; border: none; color: var(--muted); font-size: 14px;
  cursor: pointer; width: 26px; height: 26px; border-radius: 7px;
  display: flex; align-items: center; justify-content: center; transition: all .1s;
}
.msg-acts button:hover { background: rgba(255,255,255,.07); color: #fff; }

/* Input */
.chat-input-wrap { padding: 10px 16px 14px; flex-shrink: 0; }
.chat-input-box {
  background: var(--panel2); border: 1px solid var(--border); border-radius: 14px;
  display: flex; align-items: flex-end; gap: 5px; padding: 8px 11px;
  transition: border-color .15s;
}
.chat-input-box:focus-within { border-color: rgba(255,249,62,.24); box-shadow: 0 0 0 2px rgba(255,249,62,.05); }
.chat-input-box textarea {
  flex: 1; background: transparent; border: none; outline: none;
  color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 13.5px;
  resize: none; max-height: 120px; line-height: 1.5; padding: 2px 0;
}
.chat-input-box textarea::placeholder { color: var(--muted); }
.chat-send {
  width: 32px; height: 32px; border-radius: 10px;
  background: var(--accent); border: none; color: #060810; font-size: 14px;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: filter .1s;
}
.chat-send:hover { filter: brightness(1.08); }
.chat-input-actions button {
  background: none; border: none; color: var(--muted); font-size: 17px;
  cursor: pointer; width: 30px; height: 30px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; transition: all .1s;
}
.chat-input-actions button:hover { background: rgba(255,255,255,.07); color: #fff; }
.chat-input-actions { display: flex; gap: 2px; align-items: center; }

/* Member list */
.member-list {
  width: 220px; min-width: 220px;
  background: var(--channel); border-left: 1px solid var(--border);
  overflow-y: auto; padding: 12px 0;
}
.ml-header { padding: 0 12px 8px; font-size: 10.5px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: var(--muted); }
.ml-entry {
  display: flex; align-items: center; gap: 8px;
  padding: 5px 9px; margin: 1px 4px; border-radius: 10px; cursor: pointer; transition: background .1s;
}
.ml-entry:hover { background: rgba(255,255,255,.05); }
.ml-av { width: 28px; height: 28px; border-radius: 50%; background: var(--panel); border: 1px solid var(--border); font-size: 11px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; overflow: hidden; position: relative; }
.ml-av img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.ml-status { position: absolute; bottom: -1px; right: -1px; width: 8px; height: 8px; border-radius: 50%; border: 2px solid var(--channel); }
.ml-name { font-size: 12.5px; font-weight: 600; color: var(--muted-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

/* ‚ïê‚ïê‚ïê DISCOVER ‚ïê‚ïê‚ïê */
.discover-scroll { flex: 1; overflow-y: auto; padding: 28px; }
.disc-hero {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 22px; padding: 38px 36px; margin-bottom: 28px;
  position: relative; overflow: hidden;
}
.disc-hero::before {
  content: ""; position: absolute; inset: 0;
  background-image: linear-gradient(rgba(255,249,62,.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,249,62,.015) 1px, transparent 1px);
  background-size: 48px 48px;
}
.disc-hero::after {
  content: ""; position: absolute; top: -80px; right: -80px;
  width: 300px; height: 300px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,249,62,.06) 0%, transparent 70%);
}
.disc-hero h2 { font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800; letter-spacing: -.5px; margin-bottom: 6px; position: relative; }
.disc-hero p { font-size: 14px; color: var(--muted-light); margin-bottom: 20px; position: relative; max-width: 440px; }
.disc-search { display: flex; align-items: center; gap: 10px; max-width: 400px; position: relative; }
.disc-search input {
  flex: 1; background: rgba(255,255,255,.05); border: 1px solid var(--border); border-radius: 12px;
  color: #fff; font-family: 'DM Sans', sans-serif; font-size: 13.5px;
  padding: 10px 14px 10px 38px; outline: none; transition: border-color .12s;
}
.disc-search input:focus { border-color: rgba(255,249,62,.25); }
.disc-search input::placeholder { color: var(--muted); }
.disc-search .si { position: absolute; left: 12px; font-size: 13px; color: var(--muted); pointer-events: none; }
.disc-tabs { display: flex; gap: 5px; margin-bottom: 22px; }
.disc-tab {
  padding: 7px 16px; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer;
  border: 1px solid transparent; color: var(--muted-light); transition: all .12s;
}
.disc-tab:hover { background: rgba(255,255,255,.05); color: #fff; }
.disc-tab.active { background: var(--accent-dim); border-color: var(--accent-mid); color: var(--accent); }
.bastion-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; }
.bc {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 18px; overflow: hidden;
  cursor: pointer; transition: all .15s;
}
.bc:hover { border-color: rgba(255,249,62,.2); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,.4); }
.bc-banner { height: 76px; background: linear-gradient(135deg, #1a2040, #0d1425); display: flex; align-items: center; justify-content: center; font-size: 30px; position: relative; overflow: hidden; }
.bc-banner::after { content: ""; position: absolute; inset: 0; background: linear-gradient(to bottom, transparent 40%, rgba(0,0,0,.5)); }
.bc-body { padding: 14px; }
.bc-meta { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
.bc-icon { width: 42px; height: 42px; border-radius: 12px; background: var(--panel2); border: 2px solid var(--sidebar); font-size: 18px; display: flex; align-items: center; justify-content: center; margin-top: -26px; position: relative; z-index: 1; flex-shrink: 0; }
.bc-name { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
.bc-desc { font-size: 12px; color: var(--muted-light); line-height: 1.55; margin-bottom: 8px; }
.bc-stats { display: flex; gap: 10px; font-size: 11.5px; color: var(--muted); }
.bc-tags { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 8px; }
.bc-tag { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 100px; background: rgba(255,255,255,.05); border: 1px solid var(--border); color: var(--muted-light); }

/* ‚ïê‚ïê‚ïê ATELIER ‚ïê‚ïê‚ïê */
.atelier-scroll { flex: 1; overflow-y: auto; padding: 28px; }
.atelier-top {
  display: flex; align-items: center; justify-content: space-between;
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 22px; padding: 26px 30px; margin-bottom: 26px;
  position: relative; overflow: hidden;
}
.atelier-top::before {
  content: ""; position: absolute; top: -50px; right: -50px;
  width: 180px; height: 180px; border-radius: 50%;
  background: radial-gradient(circle, rgba(255,249,62,.07) 0%, transparent 70%);
}
.atelier-bal { display: flex; align-items: center; gap: 13px; }
.atelier-bal img { width: 36px; height: 36px; object-fit: contain; }
.atelier-bal h3 { font-size: 13px; font-weight: 600; color: var(--muted-light); margin-bottom: 2px; }
.atelier-bal .amt { font-family: 'Syne', sans-serif; font-size: 30px; font-weight: 800; color: var(--accent); letter-spacing: -.3px; }
.daily-btn {
  display: flex; flex-direction: column; align-items: center; gap: 3px;
  background: rgba(255,249,62,.07); border: 1px solid rgba(255,249,62,.18);
  border-radius: 16px; padding: 14px 24px; cursor: pointer; transition: background .12s;
}
.daily-btn:hover { background: rgba(255,249,62,.13); }
.daily-btn span { font-size: 11px; color: var(--muted-light); }
.daily-btn strong { font-family: 'Syne', sans-serif; font-size: 14px; color: var(--accent); }
.daily-btn.claimed { opacity: .5; cursor: not-allowed; }
.atelier-section-title {
  font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700;
  margin-bottom: 14px; display: flex; align-items: center; gap: 8px;
}
.atelier-section-title::before { content: ""; width: 14px; height: 3px; background: var(--accent); border-radius: 2px; }
.radiance-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 13px; margin-bottom: 28px; }
.rad-card {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 18px; padding: 22px 18px;
  display: flex; flex-direction: column; align-items: center; text-align: center;
  gap: 8px; cursor: pointer; transition: all .15s; position: relative; overflow: hidden;
}
.rad-card::before {
  content: ""; position: absolute; top: 0; left: 0; right: 0; height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  opacity: 0; transition: opacity .2s;
}
.rad-card:hover { border-color: rgba(255,249,62,.22); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(0,0,0,.4); }
.rad-card:hover::before { opacity: 1; }
.rad-card.bv { border-color: rgba(255,249,62,.18); }
.best-badge { position: absolute; top: 10px; right: 10px; background: var(--accent); color: #060810; font-size: 9px; font-weight: 800; letter-spacing: .05em; padding: 2px 7px; border-radius: 100px; text-transform: uppercase; }
.rad-icon { font-size: 30px; }
.rad-dur { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 700; }
.rad-price { font-family: 'Syne', sans-serif; font-size: 21px; font-weight: 800; color: var(--accent); }
.rad-price span { font-size: 12px; color: var(--muted-light); font-family: 'DM Sans', sans-serif; font-weight: 400; }
.rad-feats { font-size: 12px; color: var(--muted-light); line-height: 1.6; }

/* ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê */
.profile-wrap { flex: 1; display: flex; overflow: hidden; }
.profile-nav {
  width: 210px; min-width: 210px;
  border-right: 1px solid var(--border);
  background: var(--channel);
  display: flex; flex-direction: column;
  padding: 12px 0; overflow-y: auto;
}
.profile-nav-item {
  display: flex; align-items: center; gap: 9px;
  padding: 9px 14px; margin: 1px 6px; border-radius: 12px;
  cursor: pointer; font-size: 13.5px; color: var(--muted-light);
  transition: all .1s;
}
.profile-nav-item:hover { background: rgba(255,255,255,.05); color: #fff; }
.profile-nav-item.active { background: rgba(255,249,62,.08); color: var(--accent); }
.profile-main { flex: 1; overflow-y: auto; }
.profile-banner-area {
  width: 100%; height: 150px;
  background: linear-gradient(135deg, #0f1830, #1a0f30, #0f2030);
  position: relative; overflow: hidden;
}
.profile-banner-area img { width: 100%; height: 100%; object-fit: cover; }
.profile-av-row {
  display: flex; align-items: flex-end; gap: 16px;
  padding: 0 24px; margin-top: -40px; margin-bottom: 16px;
}
.profile-av-big {
  width: 80px; height: 80px; border-radius: 50%;
  background: var(--panel); border: 4px solid var(--bg);
  font-size: 28px; display: flex; align-items: center; justify-content: center;
  overflow: hidden; flex-shrink: 0; position: relative; cursor: pointer;
}
.profile-av-big img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
.profile-display-name { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; margin-bottom: 2px; }
.profile-username { font-size: 13.5px; color: var(--muted-light); }
.profile-content { padding: 0 24px 36px; }
.profile-stats-row {
  display: flex; background: var(--panel); border: 1px solid var(--border);
  border-radius: 18px; overflow: hidden; margin-bottom: 22px;
}
.ps-stat { flex: 1; padding: 16px; text-align: center; border-right: 1px solid var(--border); }
.ps-stat:last-child { border-right: none; }
.ps-val { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--accent); }
.ps-key { font-size: 11.5px; color: var(--muted); margin-top: 2px; }
.settings-section { margin-bottom: 24px; }
.settings-title { font-family: 'Syne', sans-serif; font-size: 10.5px; font-weight: 700; letter-spacing: .1em; text-transform: uppercase; color: var(--muted); margin-bottom: 10px; }
.s-row {
  display: flex; align-items: center; gap: 12px;
  padding: 13px 15px; background: var(--panel); border: 1px solid var(--border);
  border-radius: 14px; margin-bottom: 7px; cursor: pointer; transition: all .12s;
}
.s-row:hover { border-color: rgba(255,249,62,.12); background: rgba(255,249,62,.02); }
.s-row .si { font-size: 17px; width: 30px; text-align: center; }
.s-row .st { flex: 1; }
.s-row .sl { font-size: 13.5px; font-weight: 600; }
.s-row .ss { font-size: 12px; color: var(--muted-light); margin-top: 1px; }
.field-group { margin-bottom: 15px; }
.field-label { font-size: 11px; font-weight: 700; letter-spacing: .06em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
.field-input {
  width: 100%; padding: 10px 14px;
  background: #05070d; border: 1px solid var(--border); border-radius: 11px;
  color: #fff; font-family: 'DM Sans', sans-serif; font-size: 13.5px;
  outline: none; transition: border-color .12s;
}
.field-input:focus { border-color: rgba(255,249,62,.3); }
.field-input::placeholder { color: #252c3d; }
.field-hint { font-size: 11.5px; color: var(--muted); margin-top: 4px; }
.toggle {
  width: 38px; height: 20px; border-radius: 10px; background: var(--border);
  position: relative; cursor: pointer; transition: background .15s; flex-shrink: 0;
}
.toggle.on { background: var(--accent); }
.toggle::after {
  content: ""; position: absolute; top: 2px; left: 2px;
  width: 16px; height: 16px; border-radius: 50%; background: #fff; transition: transform .15s;
}
.toggle.on::after { transform: translateX(18px); }
.radiance-badge {
  display: inline-flex; align-items: center; gap: 5px;
  background: linear-gradient(90deg, rgba(255,200,62,.12), rgba(255,249,62,.12));
  border: 1px solid rgba(255,220,62,.25);
  border-radius: 100px; padding: 3px 10px;
  font-size: 11px; font-weight: 700; color: #ffd93e; margin-top: 5px;
}
.boost-bar {
  background: rgba(255,249,62,.06); border: 1px solid rgba(255,249,62,.12); border-radius: 12px;
  padding: 10px 14px; display: flex; align-items: center; gap: 10px;
  font-size: 12.5px; color: var(--muted-light); cursor: pointer; margin: 8px 8px 4px; transition: background .12s;
}
.boost-bar:hover { background: rgba(255,249,62,.1); }
.boost-bar .bl { font-weight: 700; color: var(--accent); }

/* ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(0,0,0,.8); backdrop-filter: blur(12px);
  z-index: 1000; align-items: center; justify-content: center;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--panel); border: 1px solid var(--border);
  border-radius: 20px; width: 100%; max-width: 420px; overflow: hidden;
  animation: mIn .2s cubic-bezier(.22,1,.36,1) both;
  box-shadow: 0 32px 80px rgba(0,0,0,.7);
}
.modal.wide { max-width: 540px; }
@keyframes mIn { from { opacity: 0; transform: scale(.93) translateY(14px); } to { opacity: 1; transform: none; } }
.modal-bar { height: 2px; background: linear-gradient(90deg, transparent, var(--accent), transparent); }
.modal-body { padding: 26px; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; margin-bottom: 5px; }
.modal-sub { font-size: 13px; color: var(--muted-light); margin-bottom: 22px; }
.modal-error { font-size: 12px; color: var(--red); margin-bottom: 8px; min-height: 16px; display: flex; align-items: center; gap: 5px; }
.modal-error:not(:empty)::before { content: "‚ö†"; }
.modal-success { font-size: 12px; color: var(--green); margin-bottom: 8px; }
.modal-actions { display: flex; gap: 9px; margin-top: 6px; }
.modal-actions .btn-a, .modal-actions .btn-g { flex: 1; justify-content: center; }
.modal-input {
  width: 100%; padding: 10px 14px;
  background: #05070d; border: 1px solid var(--border); border-radius: 11px;
  color: #fff; font-family: 'DM Sans', sans-serif; font-size: 13.5px;
  outline: none; margin-bottom: 12px; transition: border-color .12s;
}
.modal-input:focus { border-color: rgba(255,249,62,.32); }
.modal-input::placeholder { color: #252c3d; }
.btn-a {
  display: inline-flex; align-items: center; gap: 7px;
  background: var(--accent); color: #060810; padding: 10px 20px; border-radius: 12px;
  font-family: 'Syne', sans-serif; font-size: 13.5px; font-weight: 700;
  border: none; cursor: pointer; transition: all .1s;
}
.btn-a:hover { filter: brightness(1.06); transform: translateY(-1px); }
.btn-g {
  display: inline-flex; align-items: center; gap: 7px;
  background: transparent; color: var(--muted-light); padding: 9px 18px; border-radius: 12px;
  font-family: 'Syne', sans-serif; font-size: 13.5px; font-weight: 700;
  border: 1px solid var(--border); cursor: pointer; transition: all .1s;
}
.btn-g:hover { border-color: #2e3a52; background: rgba(255,255,255,.04); }
.btn-d {
  display: inline-flex; align-items: center; gap: 7px;
  background: rgba(248,113,113,.1); color: var(--red); padding: 9px 18px; border-radius: 12px;
  font-family: 'Syne', sans-serif; font-size: 13.5px; font-weight: 700;
  border: 1px solid rgba(248,113,113,.2); cursor: pointer; transition: all .1s;
}
.btn-d:hover { background: rgba(248,113,113,.18); }
.toast {
  position: fixed; bottom: 22px; right: 22px; z-index: 2000;
  background: var(--panel2); border: 1px solid var(--border);
  border-radius: 14px; padding: 11px 18px; font-size: 13px; font-weight: 500;
  box-shadow: 0 20px 50px rgba(0,0,0,.6);
  transform: translateY(20px); opacity: 0;
  transition: transform .25s cubic-bezier(.22,1,.36,1), opacity .25s;
  max-width: 280px; pointer-events: none;
}
.toast.show { transform: translateY(0); opacity: 1; }
.toast.success { border-left: 3px solid var(--green); color: #a3e8b8; }
.toast.error { border-left: 3px solid var(--red); color: #fca5a5; }
.toast.info { border-left: 3px solid var(--accent); color: var(--accent); }

/* Context menu */
.ctx-menu {
  position: fixed; z-index: 9999;
  background: rgba(13,16,24,.98); border: 1px solid rgba(255,255,255,.08);
  border-radius: 14px; padding: 6px;
  min-width: 200px; max-width: 260px;
  box-shadow: 0 20px 50px rgba(0,0,0,.7), 0 0 0 1px rgba(0,0,0,.4), inset 0 1px 0 rgba(255,255,255,.04);
  backdrop-filter: blur(22px);
  animation: ctxIn .14s cubic-bezier(.22,1,.36,1);
  user-select: none;
}
@keyframes ctxIn { from { opacity: 0; transform: scale(.96) translateY(-4px); } to { opacity: 1; transform: none; } }
.ctx-header { padding: 7px 12px 5px; font-size: 10px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,.25); }
.ctx-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 12px; border-radius: 9px;
  font-size: 13px; color: rgba(220,228,240,.9);
  cursor: pointer; transition: all .07s; line-height: 1;
}
.ctx-item .ctx-icon { width: 18px; height: 18px; font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; opacity: .7; }
.ctx-item .ctx-label { flex: 1; }
.ctx-item .ctx-shortcut { font-size: 10.5px; color: rgba(255,255,255,.25); flex-shrink: 0; }
.ctx-item:hover { background: rgba(255,255,255,.07); color: #fff; }
.ctx-item:hover .ctx-icon { opacity: 1; }
.ctx-item.danger { color: rgba(248,113,113,.85); }
.ctx-item.danger:hover { background: rgba(248,113,113,.12); color: var(--red); }
.ctx-item.disabled { opacity: .35; cursor: not-allowed; pointer-events: none; }
.ctx-sep { height: 1px; background: rgba(255,255,255,.07); margin: 5px 0; }
.ctx-section-label { padding: 9px 12px 4px; font-size: 10px; font-weight: 700; letter-spacing: .07em; text-transform: uppercase; color: rgba(255,255,255,.22); }

/* Notif panel */
.notif-panel {
  position: fixed; top: 52px; right: 0; width: 330px; max-height: calc(100vh - 60px);
  background: var(--sidebar); border: 1px solid var(--border); border-radius: 18px 0 0 18px;
  box-shadow: -8px 0 40px rgba(0,0,0,.5); z-index: 100;
  transform: translateX(100%); transition: transform .22s cubic-bezier(.22,1,.36,1);
  display: flex; flex-direction: column;
}
.notif-panel.open { transform: translateX(0); }
.np-header {
  padding: 16px 18px; border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.np-header h3 { font-family: 'Syne', sans-serif; font-size: 14px; font-weight: 700; }
.np-header button {
  background: none; border: none; color: var(--muted); cursor: pointer;
  font-size: 15px; width: 28px; height: 28px; border-radius: 8px;
  display: flex; align-items: center; justify-content: center; transition: all .1s;
}
.np-header button:hover { background: rgba(255,255,255,.07); color: #fff; }
.np-list { flex: 1; overflow-y: auto; padding: 8px; }
.np-item {
  display: flex; gap: 10px; padding: 10px 12px; border-radius: 12px;
  cursor: pointer; transition: background .08s; margin-bottom: 3px; position: relative;
}
.np-item:hover { background: rgba(255,255,255,.04); }
.np-item.unread { background: rgba(255,249,62,.04); }
.np-item.unread::before { content: ""; position: absolute; left: 4px; top: 50%; transform: translateY(-50%); width: 4px; height: 4px; border-radius: 50%; background: var(--accent); }
.np-icon { width: 32px; height: 32px; border-radius: 50%; background: var(--panel); border: 1px solid var(--border); font-size: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
.np-text { flex: 1; }
.np-text p { font-size: 12.5px; color: var(--text); line-height: 1.45; }
.np-text p strong { font-weight: 700; }
.np-time { font-size: 10.5px; color: var(--muted); margin-top: 2px; }
.np-actions { display: flex; gap: 5px; margin-top: 6px; }
.np-accept { background: rgba(62,207,110,.12); border: 1px solid rgba(62,207,110,.25); color: var(--green); font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 7px; cursor: pointer; }
.np-decline { background: transparent; border: 1px solid var(--border); color: var(--muted-light); font-size: 11px; font-weight: 700; padding: 4px 10px; border-radius: 7px; cursor: pointer; }
.np-empty { padding: 40px; text-align: center; color: var(--muted); font-size: 13px; }
.empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 14px; color: var(--muted); text-align: center; padding: 40px; }
.empty-state .ei { font-size: 48px; opacity: .3; }
.empty-state h3 { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; color: var(--muted-light); }
.empty-state p { font-size: 13.5px; max-width: 290px; line-height: 1.6; }
.emoji-picker-wrap { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 13px; }
.emoji-opt { width: 36px; height: 36px; border-radius: 9px; display: flex; align-items: center; justify-content: center; font-size: 19px; cursor: pointer; border: 1.5px solid transparent; transition: all .1s; }
.emoji-opt:hover { background: rgba(255,255,255,.06); }
.emoji-opt.sel { border-color: var(--accent); background: var(--accent-dim); }
</style>
</head>
<body>

<!-- RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Fortized Home">
    <img src="Fortized icon.png" alt="" onerror="this.outerHTML='<span style=font-size:24px>üè∞</span>'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn active" id="rail-home" onclick="navigate('home')" data-tip="Home">üè†</div>
  <div class="rail-btn" id="rail-discover" onclick="navigate('discover')" data-tip="Discover">üß≠</div>
  <div class="rail-btn" id="rail-atelier" onclick="navigate('atelier')" data-tip="Atelier">
    <img src="Onyx.png" style="width:22px;height:22px;object-fit:contain;" onerror="this.outerHTML='üíé'">
  </div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" id="rail-add" onclick="openCreateBastion()" data-tip="Create Bastion" style="border:1.5px dashed #1c2335;border-radius:14px;font-size:20px;color:var(--muted);">+</div>
  <div style="margin-top:auto;"></div>
  <div class="rail-btn" id="rail-notif" onclick="toggleNotifPanel()" data-tip="Notifications" style="position:relative;">
    üîî<div class="rail-notif-badge" id="notif-badge" style="display:none;">0</div>
  </div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Settings">‚öôÔ∏è</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header">
    <span id="sidebar-title">Fortized</span>
    <div class="hdr-actions" id="sidebar-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <div id="boost-bar-wrap" style="display:none;">
    <div class="boost-bar" onclick="toast('Boost coming soon','info')">
      <span>‚ö°</span><div><div class="bl">Boost Bastion</div><div style="font-size:11px;">Level 0</div></div>
    </div>
  </div>
  <div class="userbar">
    <div class="ua" id="ua" onclick="navigate('profile')"><div class="ua-ring"></div></div>
    <div class="ua-info">
      <div class="ua-name" id="ua-name">‚Äî</div>
      <div class="ua-tag" id="ua-tag">‚óè Online</div>
    </div>
    <div class="ua-btns">
      <button title="Mute" onclick="toast('Muted','info')">üé§</button>
      <button title="Deafen" onclick="toast('Deafened','info')">üéß</button>
      <button title="Log Out" onclick="logout()">üö™</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title"><span>üè†</span><span>Home</span></div>
    <div class="tb-sep"></div>
    <div class="tb-desc" id="topbar-desc">Welcome to Fortized</div>
    <div class="tb-actions">
      <div class="onyx-pill" onclick="navigate('atelier')">
        <img src="Onyx.png" onerror="this.outerHTML='üíé'"><span id="topbar-onyx">0</span>
      </div>
      <div class="tb-search">
        <span style="font-size:12px;color:var(--muted);">üîç</span>
        <input type="text" placeholder="Search‚Ä¶">
      </div>
      <button id="member-list-btn" style="display:none;" onclick="toggleMemberList()" title="Members">üë•</button>
    </div>
  </div>

  <div class="content">
    <!-- HOME -->
    <div id="view-home" class="view active">
      <div class="home-wrap">
        <div class="home-dm-sidebar">
          <div class="home-dm-header">
            <span>Messages</span>
            <div class="hdr-actions">
              <button onclick="openNewDM()" title="New DM">‚úâÔ∏è</button>
              <button onclick="renderFriends()" title="Friends">üë•</button>
            </div>
          </div>
          <div class="sidebar-scroll" id="dm-list"></div>
        </div>
        <div class="home-feed">
          <div id="home-content"></div>
        </div>
        <div class="home-right" id="home-right"></div>
      </div>
    </div>

    <!-- BASTION -->
    <div id="view-bastion" class="view" style="flex-direction:row;">
      <div id="bastion-main" style="flex:1;display:flex;flex-direction:column;min-width:0;"></div>
      <div class="member-list" id="member-list" style="display:none;"></div>
    </div>

    <!-- DISCOVER -->
    <div id="view-discover" class="view">
      <div class="discover-scroll">
        <div class="disc-hero">
          <h2>Discover Bastions</h2>
          <p>Find public communities, join the fight, and make your mark.</p>
          <div class="disc-search">
            <span class="si">üîç</span>
            <input type="text" placeholder="Search bastions‚Ä¶" id="disc-input" oninput="filterBastions()">
          </div>
        </div>
        <div class="disc-tabs">
          <div class="disc-tab active" onclick="setDiscTab('all',this)">All</div>
          <div class="disc-tab" onclick="setDiscTab('gaming',this)">üéÆ Gaming</div>
          <div class="disc-tab" onclick="setDiscTab('competitive',this)">‚öîÔ∏è Competitive</div>
          <div class="disc-tab" onclick="setDiscTab('casual',this)">üé™ Casual</div>
          <div class="disc-tab" onclick="setDiscTab('roleplay',this)">üêâ Roleplay</div>
        </div>
        <div class="bastion-grid" id="bastion-grid"></div>
      </div>
    </div>

    <!-- ATELIER -->
    <div id="view-atelier" class="view">
      <div class="atelier-scroll">
        <div class="atelier-top">
          <div class="atelier-bal">
            <img src="Onyx.png" onerror="this.outerHTML='üíé'">
            <div><h3>Onyx Balance</h3><div class="amt" id="atelier-balance">0</div></div>
          </div>
          <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
            <span>Daily Reward</span><strong>+5 Onyx</strong><span id="daily-status">Claim now ‚Üí</span>
          </div>
        </div>
        <div class="atelier-section-title">Radiance ‚Äî Premium Status</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(110,'1 Day')">
            <div class="rad-icon">‚ú®</div><div class="rad-dur">1 Day</div>
            <div class="rad-price">110 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for 24 hours</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
          <div class="rad-card bv" onclick="buyRadiance(770,'7 Days')">
            <div class="best-badge">Best Value</div>
            <div class="rad-icon">‚ö°</div><div class="rad-dur">7 Days</div>
            <div class="rad-price">770 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for one week</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
          <div class="rad-card" onclick="buyRadiance(3300,'30 Days')">
            <div class="rad-icon">üëë</div><div class="rad-dur">30 Days</div>
            <div class="rad-price">3,300 <span>Onyx</span></div>
            <div class="rad-feats">Full perks for a month</div>
            <button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
          </div>
        </div>
        <div class="atelier-section-title">Radiance Perks</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:30px;">
          <div class="s-row" style="cursor:default;"><span class="si">üé®</span><div class="st"><div class="sl">Custom Profile Badge</div><div class="ss">Exclusive Radiance crown</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üåü</span><div class="st"><div class="sl">Animated Border</div><div class="ss">Glowing avatar frame</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üí¨</span><div class="st"><div class="sl">Extended Messages</div><div class="ss">Up to 4000 chars</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üìÅ</span><div class="st"><div class="sl">100MB Uploads</div><div class="ss">Standard is 8MB</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üé≠</span><div class="st"><div class="sl">Custom Emoji</div><div class="ss">Use anywhere</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üñº</span><div class="st"><div class="sl">Custom Banner</div><div class="ss">Personalize your profile</div></div></div>
        </div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="view-profile" class="view">
      <div class="profile-wrap">
        <div class="profile-nav" id="profile-nav"></div>
        <div class="profile-main" id="profile-main"></div>
      </div>
    </div>
  </div>
</div>

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="np-header">
    <h3>Notifications</h3>
    <div style="display:flex;gap:3px;">
      <button onclick="markAllRead()" style="font-size:11px;width:auto;padding:0 7px;">‚úì All</button>
      <button onclick="toggleNotifPanel()">‚úï</button>
    </div>
  </div>
  <div class="np-list" id="np-list"></div>
</div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create a Bastion</div>
      <div class="modal-sub">Build your own community fortress.</div>
      <div class="modal-error" id="create-error"></div>
      <input class="modal-input" id="bastion-name-input" placeholder="Bastion name" maxlength="32">
      <input class="modal-input" id="bastion-desc-input" placeholder="Short description (optional)" maxlength="80">
      <div style="margin-bottom:14px;">
        <div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Icon</div>
        <div class="emoji-picker-wrap" id="bastion-emoji-picker"></div>
      </div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-a" onclick="createBastion()">‚öîÔ∏è Create</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">New Direct Message</div>
      <div class="modal-sub">Message any Fortized user by their exact username.</div>
      <div class="modal-error" id="dm-error"></div>
      <input class="modal-input" id="dm-username-input" placeholder="Enter username‚Ä¶" onkeydown="if(event.key==='Enter')startDM()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-a" onclick="startDM()">Open DM</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Add a Friend</div>
      <div class="modal-sub">Send a friend request by their exact username.</div>
      <div class="modal-error" id="af-error"></div>
      <div class="modal-success" id="af-success"></div>
      <input class="modal-input" id="af-input" placeholder="Exact username‚Ä¶" onkeydown="if(event.key==='Enter')sendFriendReq()">
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-add-friend')">Close</button>
        <button class="btn-a" onclick="sendFriendReq()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<!-- Join Bastion Modal -->
<div class="modal-overlay" id="modal-join-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="join-bastion-body"></div>
  </div>
</div>

<div class="modal-overlay" id="modal-buy">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="buy-title">Activate Radiance?</div>
      <div class="modal-sub" id="buy-sub">This will deduct Onyx from your balance.</div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-buy')">Cancel</button>
        <button class="btn-a" onclick="confirmBuy()">‚ú® Confirm</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-user">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="user-modal-body"></div>
  </div>
</div>

<div class="toast" id="toast"></div>
<div id="ctx-menu" style="display:none;"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CU = null;
let curView = 'home';
let curDM = null;
let curBastion = null;
let curChannel = null;
let memberListOpen = false;
let notifPanelOpen = false;
let pendingBuy = null;
let discTab = 'all';
let profileTab = 'myprofile';

const EMOJIS = ['üè∞','‚öîÔ∏è','üõ°','üèπ','üó°Ô∏è','üî•','‚ö°','üåå','üéÆ','üéØ','üíÄ','üêâ','üåô','üåü','üé™','üîÆ','üåä','ü¶Ö'];
const QUICK_REACT = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üî•','‚úÖ'];

const PUBLIC_BASTIONS = [
  {id:'warfront',icon:'‚öîÔ∏è',name:'Warfront Elite',desc:'Competitive FPS & strategy. Weekly tournaments.',members:1842,online:234,category:'competitive',tags:['FPS','Ranked']},
  {id:'dragonrealm',icon:'üêâ',name:'Dragon Realm',desc:'Fantasy RPG & tabletop. D&D, Pathfinder and more.',members:932,online:87,category:'roleplay',tags:['RPG','D&D']},
  {id:'casualcrew',icon:'üéÆ',name:'Casual Crew',desc:'Laid-back gamers who just want to chill.',members:3201,online:418,category:'casual',tags:['Chill','Multi-game']},
  {id:'voidrunners',icon:'üåå',name:'Void Runners',desc:'Sci-fi, space sims, Star Citizen, Elite Dangerous.',members:671,online:55,category:'gaming',tags:['Sci-Fi','Space']},
  {id:'sniperguild',icon:'üéØ',name:'Sniper Guild',desc:'Precision shooters. Weekly coaching sessions.',members:2156,online:310,category:'competitive',tags:['Shooter','Coaching']},
  {id:'blazebastions',icon:'üî•',name:'Blaze Bastions',desc:'The hottest new community on the platform.',members:489,online:102,category:'gaming',tags:['Hot','New']},
  {id:'memelords',icon:'üé™',name:'Meme Lords',desc:'Gaming memes, clips, and dumb moments.',members:5480,online:623,category:'casual',tags:['Memes','Clips']},
  {id:'arcanecouncil',icon:'üîÆ',name:'Arcane Council',desc:'Strategy, deckbuilders, and puzzle games.',members:811,online:77,category:'gaming',tags:['Strategy','Puzzle']},
];

const BLOG_POSTS = [
  {tag:'Update',title:'Bastions 2.0 ‚Äî Channels, Roles & More',date:'Feb 14, 2025'},
  {tag:'Feature',title:'Atelier Store is Now Live',date:'Jan 28, 2025'},
  {tag:'Community',title:'February Onyx Giveaway Results',date:'Jan 20, 2025'},
  {tag:'Notice',title:'Terms of Service Update',date:'Jan 5, 2025'},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('fortized_current_user');
  if (!username) { window.location.href = 'login.html'; return; }
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  CU = users.find(u => u.username === username);
  if (!CU) { window.location.href = 'login.html'; return; }

  ['bastions','friends','friendRequestsSent','friendRequestsReceived','notifications'].forEach(k => {
    if (!Array.isArray(CU[k])) CU[k] = [];
  });
  if (typeof CU.onyx !== 'number') CU.onyx = 5;
  if (!CU.status) CU.status = 'online';
  if (!CU.displayName) CU.displayName = CU.username;
  saveUser();
  FortizedSocial.setStatus(CU.username, CU.status);

  buildUI();
  navigate('home');

  FortizedSocial.startPolling(CU.username, {
    onNewNotification: (n) => {
      refreshCU(); updateNotifBadge();
      if (n.type === 'friend_request') toast(`Friend request from ${n.from}!`, 'info');
      else if (n.type === 'friend_accept') { toast(`${n.from} accepted your request!`, 'success'); refreshCU(); }
      else if (n.type === 'dm' && curView === 'home') refreshDMLeft();
    }
  });

  setInterval(() => { refreshCU(); updateNotifBadge(); if (curView === 'home') refreshHomeRight(); }, 3000);

  document.addEventListener('click', () => document.getElementById('ctx-menu').style.display = 'none');
  document.addEventListener('click', e => {
    const panel = document.getElementById('notif-panel');
    const bell = document.getElementById('rail-notif');
    if (!panel.contains(e.target) && !bell.contains(e.target)) {
      panel.classList.remove('open'); notifPanelOpen = false;
    }
  });
});

function saveUser() {
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const i = users.findIndex(u => u.username === CU.username);
  if (i > -1) { users[i] = CU; localStorage.setItem('fortized_users', JSON.stringify(users)); }
}
function refreshCU() {
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const fresh = users.find(u => u.username === CU.username);
  if (!fresh) return;
  Object.assign(CU, fresh);
  updateOnyxDisplay();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BUILD UI
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildUI() {
  updateAvatarEl(document.getElementById('ua'), CU);
  document.getElementById('ua-name').textContent = CU.displayName || CU.username;
  updateOnyxDisplay(); updateNotifBadge();
  buildRailBastions(); buildDiscoverGrid(); buildEmojiPicker();
  updateDailyBtn(); refreshDMLeft();
}

function buildAvatar(user, size = 30) {
  const div = document.createElement('div');
  div.className = 'fa';
  div.style.width = size + 'px'; div.style.height = size + 'px';
  div.style.fontSize = Math.floor(size * .4) + 'px';
  if (user.pfp) {
    const img = document.createElement('img'); img.src = user.pfp;
    img.onerror = () => { img.remove(); div.textContent = (user.displayName || user.username || '?')[0].toUpperCase(); };
    div.appendChild(img);
  } else {
    div.textContent = (user.displayName || user.username || '?')[0].toUpperCase();
  }
  const status = FortizedSocial.getStatus(user.username);
  const dot = document.createElement('div'); dot.className = `fs ${status}`; div.appendChild(dot);
  return div;
}

function updateAvatarEl(el, user) {
  if (!el) return;
  const ring = el.querySelector('.ua-ring');
  el.innerHTML = '';
  if (user.pfp) {
    const img = document.createElement('img'); img.src = user.pfp;
    img.onerror = () => { img.remove(); el.textContent = (user.displayName || user.username || '?')[0].toUpperCase(); if (ring) el.appendChild(ring); };
    el.appendChild(img);
  } else {
    el.textContent = (user.displayName || user.username || '?')[0].toUpperCase();
  }
  if (ring) el.appendChild(ring);
}

function updateOnyxDisplay() {
  document.getElementById('topbar-onyx').textContent = CU.onyx;
  const ab = document.getElementById('atelier-balance'); if (ab) ab.textContent = CU.onyx;
}
function updateNotifBadge() {
  const count = FortizedSocial.getUnreadCount(CU.username);
  const b = document.getElementById('notif-badge');
  b.style.display = count > 0 ? 'flex' : 'none';
  b.textContent = count > 9 ? '9+' : count;
}
function buildRailBastions() {
  const c = document.getElementById('rail-bastions'); c.innerHTML = '';
  CU.bastions.forEach((b, i) => {
    const el = document.createElement('div');
    el.className = 'rail-bastion' + (curBastion === i ? ' active' : '');
    el.id = 'rb-' + i; el.setAttribute('data-tip', b.name); el.textContent = b.icon || 'üè∞';
    el.onclick = () => openBastion(i);
    c.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function navigate(view) {
  ['home','bastion','discover','atelier','profile'].forEach(v => {
    const el = document.getElementById('view-' + v);
    if (el) { el.style.display = 'none'; el.classList.remove('active'); }
  });
  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b => b.classList.remove('active'));
  document.getElementById('member-list-btn').style.display = 'none';
  document.getElementById('boost-bar-wrap').style.display = 'none';
  const rb = document.getElementById('rail-' + view); if (rb) rb.classList.add('active');
  curView = view;
  const el = document.getElementById('view-' + view);
  if (el) { el.style.display = 'flex'; el.classList.add('active'); }

  if (view === 'home') {
    setTopbar('üè†', 'Home', 'Your hub ‚Äî messages, friends, discover');
    setSidebar('home'); renderHomeLanding(); refreshDMLeft(); refreshHomeRight();
  } else if (view === 'discover') {
    setTopbar('üß≠', 'Discover', 'Find and join public Bastions'); setSidebar('discover');
  } else if (view === 'atelier') {
    setTopbar('üíé', 'Atelier', 'Spend Onyx on Radiance and cosmetics'); setSidebar('atelier'); updateOnyxDisplay(); updateDailyBtn();
  } else if (view === 'profile') {
    setTopbar('‚öôÔ∏è', 'Settings', 'Manage your account'); setSidebar('profile'); buildProfileView('myprofile');
  }
}

function setTopbar(icon, title, desc) {
  document.getElementById('topbar-title').innerHTML = `<span>${icon}</span><span>${title}</span>`;
  document.getElementById('topbar-desc').textContent = desc;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setSidebar(ctx) {
  const scroll = document.getElementById('sidebar-scroll');
  const title = document.getElementById('sidebar-title');
  const actions = document.getElementById('sidebar-actions');
  scroll.innerHTML = ''; actions.innerHTML = '';

  if (ctx === 'home') {
    title.textContent = 'Fortized';
    const navItems = [
      { i: 'üè†', l: 'Home', a: () => renderHomeLanding() },
      { i: 'üë•', l: 'Friends', a: () => renderFriends() },
      { i: 'üì•', l: 'Pending', a: () => renderPending(), badge: getPendingCount() || '' },
    ];
    navItems.forEach(item => {
      const el = makeSItem(item.i, item.l, item.badge); el.onclick = item.a; scroll.appendChild(el);
    });
    const lbl = makeSLabel('Direct Messages', `<button onclick="openNewDM()" title="New DM">+</button>`);
    scroll.appendChild(lbl);
    buildDMItems(scroll);
  } else if (ctx === 'discover') {
    title.textContent = 'Discover';
  } else if (ctx === 'atelier') {
    title.textContent = 'Atelier';
    [['‚ú®','Radiance'],['üíé','Onyx'],['üé®','Cosmetics']].forEach(([i,l]) => scroll.appendChild(makeSItem(i, l)));
  } else if (ctx === 'profile') {
    title.textContent = 'Settings';
    const tabs = [
      { i: 'üë§', l: 'My Profile', t: 'myprofile' },
      { i: '‚úèÔ∏è', l: 'Edit Profile', t: 'editprofile' },
      { i: 'üîí', l: 'Privacy', t: 'privacy' },
      { i: 'üîî', l: 'Notifications', t: 'notifications' },
      { i: 'üé®', l: 'Appearance', t: 'appearance' },
    ];
    tabs.forEach(({ i, l, t }) => {
      const el = makeSItem(i, l); el.onclick = () => buildProfileView(t);
      scroll.appendChild(el);
    });
  } else if (ctx === 'bastion' && curBastion !== null) {
    const b = CU.bastions[curBastion];
    title.textContent = b.name;
    actions.innerHTML = `<button onclick="toast('Settings coming soon','info')" title="Settings">‚öôÔ∏è</button>`;
    document.getElementById('boost-bar-wrap').style.display = 'block';
    const catEl = document.createElement('div');
    catEl.className = 'cat-row';
    catEl.innerHTML = `<span style="font-size:9px;margin-right:2px;">‚ñæ</span><span>Text Channels</span><button onclick="event.stopPropagation();addChannel(${curBastion})">+</button>`;
    scroll.appendChild(catEl);
    (b.channels || []).forEach((ch, ci) => {
      const el = document.createElement('div');
      el.className = 'ch-item' + (curChannel === ci ? ' active' : '');
      el.innerHTML = `<span style="font-size:12px;color:var(--muted);">#</span><span style="flex:1;">${ch.name}</span>`;
      el.onclick = () => openChannel(curBastion, ci);
      el.oncontextmenu = e => { e.preventDefault(); showCtxMenu(e.clientX, e.clientY, [
        { label: `# ${ch.name}`, section: true },
        { sep: true },
        { icon: 'üóëÔ∏è', label: 'Delete Channel', action: () => deleteChannel(curBastion, ci), danger: true },
      ]); };
      scroll.appendChild(el);
    });
    const vCat = document.createElement('div'); vCat.className = 'cat-row';
    vCat.innerHTML = `<span style="font-size:9px;">‚ñæ</span><span>Voice Channels</span>`;
    scroll.appendChild(vCat);
    const vc = document.createElement('div'); vc.className = 'ch-item';
    vc.innerHTML = `<span>üîä</span><span style="flex:1;">General</span>`;
    vc.onclick = () => toast('Voice channels coming soon', 'info');
    scroll.appendChild(vc);
  }
}

function getPendingCount() { return (CU.friendRequestsReceived || []).length; }
function makeSItem(icon, label, badge = '') {
  const el = document.createElement('div'); el.className = 's-item';
  el.innerHTML = `<div class="s-icon"><span>${icon}</span></div><span class="s-name">${label}</span>${badge ? `<span class="s-badge">${badge}</span>` : ''}`;
  return el;
}
function makeSLabel(text, extraHTML = '') {
  const el = document.createElement('div'); el.className = 'sec-label';
  el.innerHTML = `<span>${text}</span>${extraHTML}`; return el;
}
function buildDMItems(container) {
  const partners = FortizedSocial.getRecentDMPartners(CU.username);
  if (!partners.length) {
    const e = document.createElement('div');
    e.style.cssText = 'padding:10px 14px;font-size:12.5px;color:var(--muted);';
    e.textContent = 'No DMs yet.'; container.appendChild(e); return;
  }
  partners.forEach(partner => {
    const msgs = FortizedSocial.getDMMessages(CU.username, partner);
    const last = msgs[msgs.length - 1];
    const pUser = FortizedSocial.getUserByName(partner) || { username: partner };
    const el = document.createElement('div');
    el.className = 'friend-item' + (curDM === partner ? ' active' : '');
    const av = buildAvatar(pUser, 30); el.appendChild(av);
    const info = document.createElement('div'); info.className = 'fi-info';
    info.innerHTML = `<div class="fi-name">${escapeHTML(pUser.displayName || partner)}</div><div class="fi-sub">${last ? escapeHTML(last.text.slice(0, 26)) + '‚Ä¶' : 'No messages yet'}</div>`;
    el.appendChild(info); el.onclick = () => openDMChat(partner);
    container.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOME LANDING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHomeLanding() {
  const area = document.getElementById('home-content'); if (!area) return;
  const hasRadiance = CU.radianceUntil && new Date(CU.radianceUntil) > new Date();
  const pending = (CU.friendRequestsReceived || []).length;
  area.innerHTML = `
    <div class="home-banner">
      <img class="banner-img" src="Fortized banner.png" onerror="this.style.display='none'" alt="">
      <div class="banner-overlay">
        <div class="banner-text">
          <h2>Welcome back, ${escapeHTML(CU.displayName || CU.username)}!</h2>
          <p>Ready to storm the fortress?${hasRadiance ? ` <span class="radiance-badge">‚ú® Radiance Active</span>` : ''}</p>
        </div>
      </div>
      <img class="knight-img" src="Fortized Knight.png" onerror="this.style.display='none'" alt="">
    </div>
    <div class="home-main-scroll">
      <div class="section-hdr"><h3>Quick Access</h3></div>
      <div class="quick-nav">
        <div class="qn-tile" onclick="openNewDM()">
          <div class="qn-icon" style="background:rgba(96,165,250,.1);">üí¨</div>
          <div class="qn-text"><h4>Messages</h4><p>${FortizedSocial.getRecentDMPartners(CU.username).length} open DMs</p></div>
        </div>
        <div class="qn-tile" onclick="renderFriends()">
          <div class="qn-icon" style="background:rgba(62,207,110,.1);">üë•</div>
          <div class="qn-text"><h4>Friends</h4><p>${(CU.friends || []).length} friends</p></div>
          ${pending > 0 ? `<div class="qn-badge">${pending}</div>` : ''}
        </div>
        <div class="qn-tile" onclick="navigate('discover')">
          <div class="qn-icon" style="background:rgba(255,249,62,.1);">üß≠</div>
          <div class="qn-text"><h4>Discover</h4><p>Find new Bastions</p></div>
        </div>
        <div class="qn-tile" onclick="navigate('atelier')">
          <div class="qn-icon" style="background:rgba(255,249,62,.08);">üíé</div>
          <div class="qn-text"><h4>Atelier</h4><p>${CU.onyx} Onyx balance</p></div>
        </div>
      </div>
      <div class="section-hdr" style="margin-top:4px;"><h3>Recent Activity</h3></div>
      <div class="activity-feed">
        ${CU.bastions.length === 0 ? `<div class="activity-item"><div class="act-icon">üè∞</div><div class="act-text"><p>You haven't joined any Bastions yet. <strong>Discover communities!</strong></p><div class="act-time">Now</div></div></div>`
        : CU.bastions.slice(0, 3).map(b => `
          <div class="activity-item" onclick="openBastion(${CU.bastions.indexOf(b)})">
            <div class="act-icon">${b.icon}</div>
            <div class="act-text">
              <p><strong>${escapeHTML(b.name)}</strong> ‚Äî #${b.channels?.[0]?.name || 'general'}</p>
              <div class="act-time">${b.channels?.[0]?.messages?.length || 0} messages</div>
            </div>
          </div>`).join('')}
      </div>
      <div class="section-hdr" style="margin-top:4px;">
        <h3>Popular Bastions</h3>
        <a onclick="navigate('discover')">See all ‚Üí</a>
      </div>
      <div class="mini-bastion-row">
        ${PUBLIC_BASTIONS.slice(0, 4).map(b => `
          <div class="mini-bastion">
            <div class="mb-icon">${b.icon}</div>
            <div class="mb-info">
              <div class="mb-name">${b.name}</div>
              <div class="mb-meta">üë• ${b.members.toLocaleString()} ¬∑ <span style="color:var(--green);">‚óè ${b.online} online</span></div>
            </div>
            <div class="mb-join" onclick="promptJoinPublicBastion('${b.id}')">Join</div>
          </div>`).join('')}
      </div>
    </div>
  `;
}

function refreshHomeRight() {
  const panel = document.getElementById('home-right'); if (!panel) return;
  const notifs = FortizedSocial.getNotifications(CU.username).slice(0, 6);
  let html = `<div class="rp-section"><div class="rp-title">Notifications</div>`;
  if (!notifs.length) { html += `<div style="font-size:12.5px;color:var(--muted);padding:4px 0;">All caught up ‚úì</div>`; }
  else {
    notifs.forEach(n => {
      let icon = 'üîî', text = '';
      if (n.type === 'friend_request') { icon = 'üë•'; text = `<strong>${escapeHTML(n.from)}</strong> sent a friend request`; }
      else if (n.type === 'friend_accept') { icon = 'ü§ù'; text = `<strong>${escapeHTML(n.from)}</strong> accepted your request`; }
      else if (n.type === 'dm') { icon = 'üí¨'; text = `<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview || '').slice(0, 40))}`; }
      const actions = n.type === 'friend_request' ? `<div class="rn-actions">
        <button class="rn-accept" onclick="acceptFriend('${n.from}')">Accept</button>
        <button class="rn-decline" onclick="declineFriend('${n.from}')">Decline</button></div>` : '';
      html += `<div class="rp-notif ${n.read ? '' : 'unread'}">
        <div class="rn-icon">${icon}</div>
        <div class="rn-text"><p>${text}</p><div class="rn-time">${formatTimeAgo(n.time)}</div>${actions}</div>
      </div>`;
    });
  }
  html += `</div><div class="rp-section"><div class="rp-title">üì∞ Fortized Blog</div>`;
  BLOG_POSTS.forEach(p => {
    html += `<div class="blog-post" onclick="toast('Blog coming soon','info')">
      <div class="bp-tag">${p.tag}</div>
      <div class="bp-title">${p.title}</div>
      <div class="bp-date">${p.date}</div>
    </div>`;
  });
  html += `</div>`;
  panel.innerHTML = html;
}
function refreshDMLeft() {
  const dl = document.getElementById('dm-list'); if (!dl) return;
  dl.innerHTML = ''; buildDMItems(dl);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRIENDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderFriends() {
  showHomeContent(`
    <div class="home-main-scroll">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Friends ‚Äî ${(CU.friends || []).length}</div>
        <button class="btn-a" onclick="openAddFriend()" style="font-size:13px;padding:9px 18px;">+ Add Friend</button>
      </div>
      ${!(CU.friends || []).length ? `<div class="empty-state"><div class="ei">üë•</div><h3>No friends yet</h3><p>Add friends by their exact username to start chatting.</p><button class="btn-a" style="margin-top:8px;" onclick="openAddFriend()">Add a Friend</button></div>`
      : (CU.friends || []).map(f => {
        const fUser = FortizedSocial.getUserByName(f) || { username: f };
        const status = FortizedSocial.getStatus(f);
        const sColor = { online: 'var(--green)', away: 'var(--yellow)', dnd: 'var(--red)', offline: 'var(--muted)', invisible: 'var(--muted)' }[status] || 'var(--muted)';
        const sLabel = { online: 'Online', away: 'Away', dnd: 'Do Not Disturb', offline: 'Offline', invisible: 'Invisible' }[status] || 'Offline';
        return `<div style="display:flex;align-items:center;gap:13px;padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;">
          <div id="fav-${f}"></div>
          <div style="flex:1;">
            <div style="font-size:14px;font-weight:700;">${escapeHTML(fUser.displayName || f)}</div>
            <div style="font-size:12px;color:${sColor};margin-top:1px;">‚óè ${sLabel}</div>
          </div>
          <div style="display:flex;gap:7px;">
            <button class="btn-g" onclick="openDMChat('${f}')" style="font-size:12.5px;padding:7px 14px;">üí¨ Message</button>
            <button class="btn-d" onclick="removeFriend('${f}')" style="font-size:12.5px;padding:7px 10px;">‚úï</button>
          </div>
        </div>`;
      }).join('')}
    </div>
  `);
  setTimeout(() => {
    (CU.friends || []).forEach(f => {
      const container = document.getElementById('fav-' + f); if (!container) return;
      const fUser = FortizedSocial.getUserByName(f) || { username: f };
      container.appendChild(buildAvatar(fUser, 40));
    });
  }, 0);
}

function renderPending() {
  const incoming = CU.friendRequestsReceived || [];
  const outgoing = CU.friendRequestsSent || [];
  showHomeContent(`
    <div class="home-main-scroll">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:20px;">Pending Requests</div>
      ${!incoming.length && !outgoing.length ? `<div class="empty-state"><div class="ei">üì•</div><h3>All clear!</h3><p>No pending friend requests.</p></div>` : ''}
      ${incoming.length ? `<div style="font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;">Incoming ‚Äî ${incoming.length}</div>
        ${incoming.map(from => `
          <div style="display:flex;align-items:center;gap:13px;padding:14px 16px;background:var(--panel);border:1px solid rgba(255,249,62,.1);border-radius:18px;margin-bottom:8px;">
            <div style="width:40px;height:40px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);font-size:16px;display:flex;align-items:center;justify-content:center;">${from[0].toUpperCase()}</div>
            <div style="flex:1;"><div style="font-size:14px;font-weight:700;">${escapeHTML(from)}</div><div style="font-size:12px;color:var(--muted);">Wants to be friends</div></div>
            <div style="display:flex;gap:7px;">
              <button class="btn-a" onclick="acceptFriend('${from}')" style="font-size:12.5px;padding:8px 16px;">‚úì Accept</button>
              <button class="btn-g" onclick="declineFriend('${from}')" style="font-size:12.5px;padding:8px 10px;color:var(--red);border-color:rgba(248,113,113,.2);">‚úï</button>
            </div>
          </div>`).join('')}` : ''}
      ${outgoing.length ? `<div style="font-size:11px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:16px;margin-bottom:10px;">Sent ‚Äî ${outgoing.length}</div>
        ${outgoing.map(to => `
          <div style="display:flex;align-items:center;gap:13px;padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;opacity:.7;">
            <div style="width:40px;height:40px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);font-size:16px;display:flex;align-items:center;justify-content:center;">${to[0].toUpperCase()}</div>
            <div style="flex:1;"><div style="font-size:14px;font-weight:700;">${escapeHTML(to)}</div><div style="font-size:12px;color:var(--muted);">Request pending‚Ä¶</div></div>
            <button class="btn-g" onclick="cancelFriendReq('${to}')" style="font-size:12.5px;padding:8px 14px;">Cancel</button>
          </div>`).join('')}` : ''}
    </div>
  `);
}

function showHomeContent(html) { const c = document.getElementById('home-content'); if (c) c.innerHTML = html; }

function openAddFriend() {
  document.getElementById('af-input').value = '';
  document.getElementById('af-error').textContent = '';
  document.getElementById('af-success').textContent = '';
  openModal('modal-add-friend');
}
function sendFriendReq() {
  const name = document.getElementById('af-input').value.trim();
  document.getElementById('af-error').textContent = '';
  document.getElementById('af-success').textContent = '';
  if (!name) { document.getElementById('af-error').textContent = 'Enter a username.'; return; }
  const result = FortizedSocial.sendFriendRequest(CU.username, name);
  if (result.ok) {
    document.getElementById('af-success').textContent = result.msg;
    document.getElementById('af-input').value = '';
    refreshCU(); FortizedSocial.playNotificationSound(); updateNotifBadge();
  } else {
    document.getElementById('af-error').textContent = result.msg;
  }
}
function acceptFriend(from) {
  const result = FortizedSocial.acceptFriendRequest(CU.username, from);
  if (result.ok) { refreshCU(); toast(result.msg, 'success'); FortizedSocial.playNotificationSound(); renderPending(); setSidebar('home'); }
  else toast(result.msg, 'error');
}
function declineFriend(from) {
  FortizedSocial.declineFriendRequest(CU.username, from); refreshCU(); toast('Request declined', 'info'); renderPending();
}
function cancelFriendReq(to) {
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  const mi = users.findIndex(u => u.username === CU.username);
  const ti = users.findIndex(u => u.username === to);
  if (mi !== -1) users[mi].friendRequestsSent = (users[mi].friendRequestsSent || []).filter(u => u !== to);
  if (ti !== -1) users[ti].friendRequestsReceived = (users[ti].friendRequestsReceived || []).filter(u => u !== CU.username);
  localStorage.setItem('fortized_users', JSON.stringify(users));
  refreshCU(); toast(`Cancelled request to ${to}`, 'info'); renderPending();
}
function removeFriend(f) {
  if (!confirm(`Remove ${f} as a friend?`)) return;
  FortizedSocial.removeFriend(CU.username, f); refreshCU(); toast('Friend removed', 'info'); renderFriends();
}
function quickAddFriend(username) {
  const result = FortizedSocial.sendFriendRequest(CU.username, username);
  toast(result.msg, result.ok ? 'success' : 'error');
  if (result.ok) { refreshCU(); FortizedSocial.playNotificationSound(); }
  // Refresh user modal
  viewUserProfile(username);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DM
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNewDM() {
  document.getElementById('dm-username-input').value = '';
  document.getElementById('dm-error').textContent = '';
  openModal('modal-new-dm');
}
function startDM() {
  const name = document.getElementById('dm-username-input').value.trim();
  if (!name) { document.getElementById('dm-error').textContent = 'Enter a username.'; return; }
  if (name === CU.username) { document.getElementById('dm-error').textContent = "Can't DM yourself!"; return; }
  const users = JSON.parse(localStorage.getItem('fortized_users')) || [];
  if (!users.find(u => u.username === name)) { document.getElementById('dm-error').textContent = 'User not found.'; return; }
  closeModal('modal-new-dm');
  if (curView !== 'home') { navigate('home'); setTimeout(() => openDMChat(name), 100); }
  else openDMChat(name);
}
function openDMChat(partner) {
  curDM = partner; refreshDMLeft();
  const pUser = FortizedSocial.getUserByName(partner) || { username: partner };
  const status = FortizedSocial.getStatus(partner);
  setTopbar('üí¨', escapeHTML(pUser.displayName || partner), `‚óè ${status}`);
  const msgs = FortizedSocial.getDMMessages(CU.username, partner);
  const area = document.getElementById('home-content'); if (!area) return;
  area.innerHTML = `
    <div class="chat-wrap">
      <div class="chat-msgs" id="chat-msgs">
        <div class="chat-welcome">
          <div class="w-av" id="dm-welcome-av"></div>
          <h3>${escapeHTML(pUser.displayName || partner)}</h3>
          <p>Beginning of your DM history with <strong>${escapeHTML(partner)}</strong>.</p>
        </div>
        ${renderMsgs(msgs, null, null)}
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button onclick="toast('File upload soon','info')">üìé</button>
            <button onclick="toast('Emoji picker soon','info')">üòä</button>
          </div>
          <textarea id="dm-input" placeholder="Message ${escapeHTML(pUser.displayName || partner)}" rows="1"
            onkeydown="dmKey(event,'${partner}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendDM('${partner}')">‚û§</button>
        </div>
      </div>
    </div>
  `;
  setTimeout(() => {
    const wav = document.getElementById('dm-welcome-av');
    if (wav) { const av = buildAvatar(pUser, 60); av.style.borderRadius = '50%'; wav.replaceWith(av); }
  }, 0);
  scrollBottom('chat-msgs');
}
function sendDM(partner) {
  const input = document.getElementById('dm-input');
  const text = input?.value.trim(); if (!text) return;
  FortizedSocial.sendDMMessage(CU.username, partner, text);
  input.value = ''; input.style.height = '';
  openDMChat(partner);
}
function dmKey(e, partner) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendDM(partner); } }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMsgs(msgs, bastionIdx, chId) {
  if (!msgs || !msgs.length) return '';
  let html = ''; let lastDate = '';
  msgs.forEach((m, i) => {
    const isOwn = m.from === CU.username;
    const prev = msgs[i - 1];
    const isCont = prev && prev.from === m.from && !prevDateChanged(prev, m);
    const mDate = m.timestamp ? new Date(m.timestamp).toLocaleDateString() : '';
    if (mDate && mDate !== lastDate) { html += `<div class="date-div">${mDate}</div>`; lastDate = mDate; }
    const reactions = m.reactions || {};
    const rHTML = Object.entries(reactions).map(([emoji, users]) => {
      const mine = users.includes(CU.username);
      return `<div class="r-pill ${mine ? 'mine' : ''}" onclick="handleReaction('${m.id || ''}','${emoji}','${bastionIdx}','${chId || ''}')" title="${users.join(', ')}">${emoji} ${users.length}</div>`;
    }).join('');
    const senderUser = isOwn ? CU : (FortizedSocial.getUserByName(m.from) || { username: m.from });
    const avContent = senderUser.pfp
      ? `<img src="${senderUser.pfp}" onerror="this.outerHTML='${(senderUser.displayName || m.from)[0].toUpperCase()}'">` 
      : (senderUser.displayName || m.from)[0].toUpperCase();
    const actBtns = QUICK_REACT.slice(0, 4).map(e => `<button onclick="handleReaction('${m.id || ''}','${e}','${bastionIdx}','${chId || ''}')">${e}</button>`).join('');
    html += `
      <div class="msg-group ${isOwn ? 'own' : ''} ${isCont ? 'msg-cont' : ''}" data-id="${m.id || ''}">
        <div class="msg-av" onclick="viewUserProfile('${m.from}')">${avContent}</div>
        <div class="msg-body">
          <div class="msg-meta">
            <span class="msg-author" onclick="viewUserProfile('${m.from}')">${escapeHTML(senderUser.displayName || m.from)}</span>
            <span class="msg-time">${m.time || ''}</span>
          </div>
          <div class="msg-bubble">${parseMD(escapeHTML(m.text))}</div>
          ${rHTML ? `<div class="msg-reactions">${rHTML}</div>` : ''}
        </div>
        <div class="msg-acts">${actBtns}</div>
      </div>`;
  });
  return html;
}
function prevDateChanged(a, b) {
  if (!a.timestamp || !b.timestamp) return false;
  return new Date(a.timestamp).toLocaleDateString() !== new Date(b.timestamp).toLocaleDateString();
}
function handleReaction(msgId, emoji, bastionIdx, chId) {
  if (bastionIdx && bastionIdx !== 'null') {
    const key = bastionIdx + '_' + CU.username;
    FortizedSocial.addReaction(key, chId, msgId, emoji, CU.username);
    openChannel(parseInt(bastionIdx), curChannel);
  } else { toast(emoji + ' reaction!', 'info'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// JOIN PUBLIC BASTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function promptJoinPublicBastion(bastionId) {
  const b = PUBLIC_BASTIONS.find(x => x.id === bastionId);
  if (!b) return;
  // Already joined?
  const alreadyJoined = CU.bastions.find(x => x.publicId === bastionId || x.name === b.name);
  if (alreadyJoined) {
    const idx = CU.bastions.indexOf(alreadyJoined);
    toast(`Already in ${b.name}!`, 'info');
    openBastion(idx);
    return;
  }
  const body = document.getElementById('join-bastion-body');
  body.innerHTML = `
    <div style="text-align:center;padding:6px 0 10px;">
      <div style="font-size:48px;margin-bottom:10px;">${b.icon}</div>
      <div class="modal-title">${b.name}</div>
      <div class="modal-sub">${b.desc}</div>
      <div style="display:flex;justify-content:center;gap:16px;margin-bottom:20px;">
        <div style="text-align:center;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--text);">${b.members.toLocaleString()}</div><div style="font-size:11px;color:var(--muted);">Members</div></div>
        <div style="text-align:center;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;color:var(--green);">${b.online}</div><div style="font-size:11px;color:var(--muted);">Online</div></div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:5px;justify-content:center;margin-bottom:20px;">
        ${(b.tags || []).map(t => `<span style="font-size:11px;font-weight:600;padding:3px 10px;border-radius:100px;background:rgba(255,255,255,.05);border:1px solid var(--border);color:var(--muted-light);">${t}</span>`).join('')}
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn-g" onclick="closeModal('modal-join-bastion')">Cancel</button>
      <button class="btn-a" onclick="joinPublicBastion('${bastionId}')">‚öîÔ∏è Join Bastion</button>
    </div>
  `;
  openModal('modal-join-bastion');
}

function joinPublicBastion(bastionId) {
  const b = PUBLIC_BASTIONS.find(x => x.id === bastionId);
  if (!b) return;
  const alreadyJoined = CU.bastions.find(x => x.publicId === bastionId || x.name === b.name);
  if (alreadyJoined) { closeModal('modal-join-bastion'); toast('Already joined!', 'info'); return; }
  CU.bastions.push({
    publicId: bastionId,
    name: b.name, desc: b.desc, icon: b.icon,
    channels: [
      { name: 'general', id: 'general', messages: [] },
      { name: 'announcements', id: 'announcements', messages: [] },
    ],
    members: [CU.username], owner: null, joinedAt: new Date().toISOString()
  });
  saveUser(); closeModal('modal-join-bastion');
  buildRailBastions(); toast(`Joined ${b.name}!`, 'success');
  FortizedSocial.playNotificationSound();
  openBastion(CU.bastions.length - 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBastion(idx) {
  curBastion = idx; curChannel = null;
  const b = CU.bastions[idx];
  if (!b.channels || !b.channels.length) {
    b.channels = [{ name: 'general', id: 'general', messages: [] }, { name: 'announcements', id: 'announcements', messages: [] }];
    saveUser();
  }
  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((el, i) => el.classList.toggle('active', i === idx));
  ['home','discover','atelier','profile'].forEach(v => { const el = document.getElementById('view-' + v); if (el) { el.style.display = 'none'; el.classList.remove('active'); } });
  const bv = document.getElementById('view-bastion'); bv.style.display = 'flex'; bv.classList.add('active');
  setSidebar('bastion'); setTopbar('üè∞', b.name, b.desc || `Welcome to ${b.name}`);
  document.getElementById('member-list-btn').style.display = 'flex';
  openChannel(idx, 0);
}
function openChannel(bIdx, cIdx) {
  curBastion = bIdx; curChannel = cIdx;
  const b = CU.bastions[bIdx]; const ch = b.channels[cIdx];
  const chId = ch.id || ch.name;
  setTopbar('#', ch.name, `${b.name} ‚Ä∫ #${ch.name}`);
  document.querySelectorAll('.ch-item').forEach((el, i) => el.classList.toggle('active', i === cIdx));
  const sharedMsgs = FortizedSocial.getBastionChannelMessages(bIdx + '_' + CU.username, chId);
  const localMsgs = ch.messages || [];
  const allMsgs = sharedMsgs.length > 0 ? sharedMsgs : localMsgs;
  const main = document.getElementById('bastion-main');
  main.innerHTML = `
    <div class="chat-wrap">
      <div class="chat-msgs" id="b-msgs">
        <div class="chat-welcome">
          <div class="w-av" style="border-radius:14px;font-size:18px;">#</div>
          <h3>#${ch.name}</h3>
          <p>Beginning of <strong>#${ch.name}</strong>. Say hello!</p>
        </div>
        ${renderMsgs(allMsgs, bIdx, chId)}
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button onclick="toast('File upload soon','info')">üìé</button>
            <button onclick="toast('Emoji soon','info')">üòä</button>
          </div>
          <textarea id="b-input" placeholder="Message #${ch.name}" rows="1"
            onkeydown="bKey(event,${bIdx},'${chId}')" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendBMsg(${bIdx},'${chId}')">‚û§</button>
        </div>
      </div>
    </div>
  `;
  scrollBottom('b-msgs');
  if (memberListOpen) buildMemberList(bIdx);
}
function sendBMsg(bIdx, chId) {
  const input = document.getElementById('b-input'); const text = input?.value.trim(); if (!text) return;
  const key = bIdx + '_' + CU.username;
  FortizedSocial.sendBastionChannelMessage(key, chId, CU.username, text);
  const b = CU.bastions[bIdx]; const ch = b.channels.find(c => (c.id || c.name) === chId);
  if (ch) {
    if (!ch.messages) ch.messages = [];
    const now = new Date();
    ch.messages.push({ id: Date.now().toString(36), from: CU.username, text, time: now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), timestamp: now.toISOString(), reactions: {} });
    saveUser();
  }
  input.value = ''; input.style.height = ''; openChannel(bIdx, curChannel);
}
function bKey(e, bIdx, chId) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendBMsg(bIdx, chId); } }
function addChannel(bIdx) {
  const name = prompt('Channel name:'); if (!name?.trim()) return;
  const clean = name.trim().toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
  if (!clean) { toast('Invalid name', 'error'); return; }
  if (CU.bastions[bIdx].channels.find(c => c.name === clean)) { toast('Channel already exists', 'error'); return; }
  CU.bastions[bIdx].channels.push({ name: clean, id: clean, messages: [] });
  saveUser(); setSidebar('bastion'); toast('#' + clean + ' created!', 'success');
}
function deleteChannel(bIdx, cIdx) {
  if (CU.bastions[bIdx].channels.length <= 1) { toast("Can't delete the last channel", 'error'); return; }
  CU.bastions[bIdx].channels.splice(cIdx, 1); saveUser(); setSidebar('bastion'); openChannel(bIdx, 0); toast('Channel deleted', 'info');
}
function buildMemberList(bIdx) {
  const el = document.getElementById('member-list'); if (!el) return;
  const b = CU.bastions[bIdx]; const members = b.members || [CU.username];
  let html = `<div class="ml-header">Members ‚Äî ${members.length}</div>`;
  members.forEach(m => {
    const mUser = FortizedSocial.getUserByName(m) || { username: m };
    const status = FortizedSocial.getStatus(m);
    html += `<div class="ml-entry" onclick="viewUserProfile('${m}')">
      <div class="ml-av">
        ${mUser.pfp ? `<img src="${mUser.pfp}" onerror="this.outerHTML='${m[0].toUpperCase()}'">` : m[0].toUpperCase()}
        <div class="ml-status ${status}"></div>
      </div>
      <div class="ml-name">${escapeHTML(mUser.displayName || m)}${m === CU.username ? ' (you)' : ''}</div>
    </div>`;
  });
  el.innerHTML = html;
}
function toggleMemberList() {
  memberListOpen = !memberListOpen;
  const el = document.getElementById('member-list');
  if (el) { el.style.display = memberListOpen ? 'flex' : 'none'; if (memberListOpen && curBastion !== null) buildMemberList(curBastion); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREATE BASTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildEmojiPicker() {
  const p = document.getElementById('bastion-emoji-picker'); if (!p) return;
  p.innerHTML = '';
  EMOJIS.forEach(e => {
    const btn = document.createElement('div'); btn.className = 'emoji-opt'; btn.textContent = e;
    btn.onclick = () => { p.querySelectorAll('.emoji-opt').forEach(d => d.classList.remove('sel')); btn.classList.add('sel'); p.dataset.selected = e; };
    p.appendChild(btn);
  });
  p.dataset.selected = EMOJIS[0]; p.querySelector('.emoji-opt').classList.add('sel');
}
function openCreateBastion() {
  document.getElementById('bastion-name-input').value = '';
  document.getElementById('bastion-desc-input').value = '';
  document.getElementById('create-error').textContent = '';
  buildEmojiPicker(); openModal('modal-create-bastion');
}
function createBastion() {
  const name = document.getElementById('bastion-name-input').value.trim();
  const desc = document.getElementById('bastion-desc-input').value.trim();
  const icon = document.getElementById('bastion-emoji-picker').dataset.selected || 'üè∞';
  if (!name) { document.getElementById('create-error').textContent = 'Name is required.'; return; }
  CU.bastions.push({
    name, desc, icon,
    channels: [
      { name: 'general', id: 'general', messages: [] },
      { name: 'announcements', id: 'announcements', messages: [] },
      { name: 'off-topic', id: 'off-topic', messages: [] }
    ],
    members: [CU.username], owner: CU.username, createdAt: new Date().toISOString()
  });
  saveUser(); closeModal('modal-create-bastion'); buildRailBastions();
  toast(`${icon} ${name} created!`, 'success'); openBastion(CU.bastions.length - 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DISCOVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDiscoverGrid() { renderDiscGrid(PUBLIC_BASTIONS); }
function setDiscTab(tab, el) {
  discTab = tab;
  document.querySelectorAll('.disc-tab').forEach(t => t.classList.remove('active')); el.classList.add('active'); filterBastions();
}
function filterBastions() {
  const q = document.getElementById('disc-input')?.value.toLowerCase() || '';
  let f = PUBLIC_BASTIONS;
  if (discTab !== 'all') f = f.filter(b => b.category === discTab);
  if (q) f = f.filter(b => b.name.toLowerCase().includes(q) || b.desc.toLowerCase().includes(q));
  renderDiscGrid(f);
}
function renderDiscGrid(list) {
  const grid = document.getElementById('bastion-grid'); if (!grid) return;
  if (!list.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No bastions found.</div>'; return; }
  grid.innerHTML = list.map(b => {
    const alreadyJoined = CU.bastions.find(x => x.publicId === b.id || x.name === b.name);
    return `<div class="bc">
      <div class="bc-banner">${b.icon}</div>
      <div class="bc-body">
        <div class="bc-meta"><div class="bc-icon">${b.icon}</div><div class="bc-name">${b.name}</div></div>
        <div class="bc-desc">${b.desc}</div>
        <div class="bc-stats"><span>üë• ${b.members.toLocaleString()}</span><span style="color:var(--green);">‚óè ${b.online} online</span></div>
        <div class="bc-tags">${(b.tags || []).map(t => `<span class="bc-tag">${t}</span>`).join('')}</div>
        <button class="btn-a" style="width:100%;justify-content:center;margin-top:10px;font-size:12.5px;padding:9px;${alreadyJoined ? 'background:var(--panel2);color:var(--muted-light);filter:none;' : ''}" 
          onclick="${alreadyJoined ? `openBastion(${CU.bastions.indexOf(alreadyJoined)})` : `promptJoinPublicBastion('${b.id}')`}">
          ${alreadyJoined ? '‚úì Joined ‚Äî Open' : 'Join Bastion'}
        </button>
      </div>
    </div>`;
  }).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATELIER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDailyBtn() {
  const btn = document.getElementById('daily-btn'); const st = document.getElementById('daily-status');
  if (!btn || !st) return;
  const today = new Date().toDateString();
  if (CU.lastDaily === today) { btn.classList.add('claimed'); st.textContent = 'Claimed ‚úì'; }
  else { btn.classList.remove('claimed'); st.textContent = 'Claim now ‚Üí'; }
}
function claimDaily() {
  const today = new Date().toDateString();
  if (CU.lastDaily === today) { toast('Already claimed today!', 'info'); return; }
  CU.onyx += 5; CU.lastDaily = today; saveUser(); updateOnyxDisplay(); updateDailyBtn();
  toast('+5 Onyx claimed! üíé', 'success'); FortizedSocial.playNotificationSound();
}
function buyRadiance(cost, label) {
  pendingBuy = { cost, label };
  document.getElementById('buy-title').textContent = `Activate Radiance ‚Äî ${label}?`;
  document.getElementById('buy-sub').textContent = `This will deduct ${cost} Onyx. You have ${CU.onyx} Onyx.`;
  openModal('modal-buy');
}
function confirmBuy() {
  if (!pendingBuy) return;
  if (CU.onyx < pendingBuy.cost) { toast('Not enough Onyx!', 'error'); closeModal('modal-buy'); return; }
  CU.onyx -= pendingBuy.cost;
  const days = pendingBuy.label.includes('30') ? 30 : pendingBuy.label.includes('7') ? 7 : 1;
  const exp = new Date(); exp.setDate(exp.getDate() + days);
  CU.radianceUntil = exp.toISOString(); saveUser(); updateOnyxDisplay();
  closeModal('modal-buy'); toast(`‚ú® Radiance activated for ${pendingBuy.label}!`, 'success');
  FortizedSocial.playNotificationSound(); pendingBuy = null; renderHomeLanding();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE ‚Äî SIMPLE & CLEAN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildProfileView(tab) {
  profileTab = tab || profileTab;
  const nav = document.getElementById('profile-nav');
  if (nav) {
    nav.innerHTML = '';
    const tabs = [
      { i: 'üë§', l: 'My Profile', t: 'myprofile' },
      { i: '‚úèÔ∏è', l: 'Edit Profile', t: 'editprofile' },
      { i: 'üîí', l: 'Privacy', t: 'privacy' },
      { i: 'üîî', l: 'Notifications', t: 'notifications' },
      { i: 'üé®', l: 'Appearance', t: 'appearance' },
    ];
    tabs.forEach(({ i, l, t }) => {
      const el = document.createElement('div');
      el.className = 'profile-nav-item' + (profileTab === t ? ' active' : '');
      el.innerHTML = `<span>${i}</span><span>${l}</span>`;
      el.onclick = () => buildProfileView(t);
      nav.appendChild(el);
    });
    const spacer = document.createElement('div'); spacer.style.flex = '1'; nav.appendChild(spacer);
    const lo = document.createElement('div'); lo.className = 'profile-nav-item';
    lo.innerHTML = `<span>üö™</span><span style="color:var(--red);">Log Out</span>`;
    lo.onclick = logout; nav.appendChild(lo);
  }

  const main = document.getElementById('profile-main'); if (!main) return;
  const hasRadiance = CU.radianceUntil && new Date(CU.radianceUntil) > new Date();

  if (profileTab === 'myprofile') {
    main.innerHTML = `
      <div class="profile-banner-area">
        ${CU.banner ? `<img src="${CU.banner}" onerror="this.style.display='none'">` : `<img src="Profile Banner.png" onerror="this.style.display='none'">`}
      </div>
      <div class="profile-av-row">
        <div class="profile-av-big" id="pab" onclick="buildProfileView('editprofile')"></div>
        <div style="flex:1;padding-bottom:5px;">
          <div class="profile-display-name">${escapeHTML(CU.displayName || CU.username)}</div>
          <div class="profile-username">@${CU.username}</div>
          ${hasRadiance ? `<div class="radiance-badge" style="margin-top:6px;">‚ú® Radiance Active</div>` : ''}
        </div>
        <button class="btn-g" onclick="buildProfileView('editprofile')" style="align-self:flex-end;margin-bottom:5px;font-size:12.5px;padding:8px 14px;">‚úèÔ∏è Edit</button>
      </div>
      <div class="profile-content">
        <div class="profile-stats-row">
          <div class="ps-stat"><div class="ps-val">${CU.onyx}</div><div class="ps-key">Onyx</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.friends || []).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.bastions.length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val" style="font-size:18px;">${hasRadiance ? '‚ú®' : '‚Äî'}</div><div class="ps-key">Radiance</div></div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Account Info</div>
          <div class="s-row" style="cursor:default;"><span class="si">üë§</span><div class="st"><div class="sl">Username</div><div class="ss">@${CU.username}</div></div></div>
          <div class="s-row" style="cursor:default;"><span class="si">üìß</span><div class="st"><div class="sl">Email</div><div class="ss">${CU.email || 'Not set'}</div></div></div>
        </div>
      </div>
    `;
    setTimeout(() => {
      const pab = document.getElementById('pab'); if (!pab) return;
      const av = buildAvatar(CU, 80); av.style.cssText = 'border: 4px solid var(--bg); cursor: pointer; flex-shrink: 0;';
      pab.replaceWith(av);
    }, 0);
  } else if (profileTab === 'editprofile') {
    main.innerHTML = `
      <div class="profile-content" style="padding-top:28px;">
        <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Edit Profile</div>
        <div class="settings-section">
          <div class="settings-title">Profile Picture</div>
          <div style="display:flex;align-items:center;gap:16px;padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:16px;margin-bottom:8px;">
            <div id="edit-av-prev" style="width:64px;height:64px;border-radius:50%;background:var(--panel2);border:2px solid var(--border);font-size:24px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;"></div>
            <div>
              <label style="cursor:pointer;" class="btn-g">
                üì∑ Choose Photo
                <input type="file" accept="image/*" onchange="handlePfpUpload(event)" style="display:none;">
              </label>
              ${CU.pfp ? `<button class="btn-d" onclick="removePfp()" style="font-size:12.5px;padding:8px 13px;margin-left:8px;">Remove</button>` : ''}
            </div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Display Name</div>
          <div class="field-group">
            <input class="field-input" id="edit-displayname" value="${escapeHTML(CU.displayName || CU.username)}" placeholder="Your display name" maxlength="32">
            <div class="field-hint">Shown in messages instead of your username.</div>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Email Address</div>
          <input class="field-input" id="edit-email" value="${CU.email || ''}" placeholder="your@email.com" type="email" style="margin-bottom:0;">
        </div>
        <div class="settings-section" style="margin-top:16px;">
          <div class="settings-title">Change Password</div>
          <input class="field-input" id="edit-pass-cur" placeholder="Current password" type="password" style="margin-bottom:8px;">
          <input class="field-input" id="edit-pass-new" placeholder="New password" type="password" style="margin-bottom:8px;">
          <input class="field-input" id="edit-pass-conf" placeholder="Confirm new password" type="password" style="margin-bottom:0;">
        </div>
        ${hasRadiance ? `
        <div class="settings-section" style="margin-top:16px;">
          <div class="settings-title">Profile Banner <span class="radiance-badge" style="margin-left:6px;vertical-align:middle;">‚ú® Radiance</span></div>
          ${CU.banner ? `<img src="${CU.banner}" style="width:100%;height:80px;object-fit:cover;border-radius:12px;margin-bottom:10px;" onerror="this.style.display='none'">` : ''}
          <label style="cursor:pointer;" class="btn-g">
            üñº Upload Banner
            <input type="file" accept="image/*" onchange="handleBannerUpload(event)" style="display:none;">
          </label>
          ${CU.banner ? `<button class="btn-d" onclick="removeBanner()" style="font-size:12.5px;padding:8px 13px;margin-left:8px;">Remove</button>` : ''}
        </div>` : `
        <div class="settings-section" style="margin-top:16px;">
          <div class="s-row" style="cursor:default;background:rgba(255,249,62,.04);border-color:rgba(255,249,62,.1);">
            <span class="si">üñº</span>
            <div class="st"><div class="sl">Custom Profile Banner</div><div class="ss">Unlock with ‚ú® Radiance</div></div>
            <button class="btn-a" onclick="navigate('atelier')" style="font-size:11.5px;padding:6px 12px;">Get Radiance</button>
          </div>
        </div>`}
        <div style="display:flex;gap:9px;margin-top:8px;">
          <button class="btn-a" onclick="saveProfileEdits()">Save Changes</button>
          <button class="btn-g" onclick="buildProfileView('myprofile')">Cancel</button>
        </div>
        <div id="edit-msg" style="margin-top:12px;font-size:13px;min-height:18px;"></div>
      </div>
    `;
    setTimeout(() => {
      const prev = document.getElementById('edit-av-prev'); if (!prev) return;
      const av = buildAvatar(CU, 64); prev.replaceWith(av);
    }, 0);
  } else if (profileTab === 'privacy') {
    main.innerHTML = `<div class="profile-content" style="padding-top:28px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Privacy & Terms</div>
      <div class="settings-section">
        <div style="background:rgba(255,249,62,.04);border:1px solid rgba(255,249,62,.1);border-radius:16px;padding:20px 22px;margin-bottom:10px;">
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:8px;">üõ°Ô∏è Your Data is Protected</div>
          <div style="font-size:13.5px;color:var(--muted-light);line-height:1.7;">Your data is stored locally on your device. Fortized does not transmit personal information to external servers.</div>
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px 22px;margin-bottom:10px;">
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:8px;">üìú Terms of Use</div>
          <div style="font-size:13.5px;color:var(--muted-light);line-height:1.7;">Use Fortized respectfully and lawfully. Harassment, impersonation, or harm to other users is not permitted.</div>
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px 22px;">
          <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:8px;">üè∞ Community Standards</div>
          <div style="font-size:13.5px;color:var(--muted-light);line-height:1.7;">Hate speech, threats, and spam are strictly prohibited. Fortized reserves the right to remove violating content.</div>
        </div>
      </div>
    </div>`;
  } else if (profileTab === 'notifications') {
    main.innerHTML = `<div class="profile-content" style="padding-top:28px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Notifications</div>
      <div class="settings-section">
        <div class="settings-title">Messages</div>
        <div class="s-row"><span class="si">üí¨</span><div class="st"><div class="sl">Direct Messages</div><div class="ss">Notify for new DMs</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">üìå</span><div class="st"><div class="sl">Mentions</div><div class="ss">Notify when mentioned</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Social</div>
        <div class="s-row"><span class="si">üë•</span><div class="st"><div class="sl">Friend Requests</div><div class="ss">Notify for incoming requests</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
        <div class="s-row"><span class="si">ü§ù</span><div class="st"><div class="sl">Friend Accepted</div><div class="ss">When your request is accepted</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Sounds</div>
        <div class="s-row"><span class="si">üîî</span><div class="st"><div class="sl">Notification Sound</div><div class="ss">Play a sound for notifications</div></div><div class="toggle on" onclick="this.classList.toggle('on')"></div></div>
      </div>
    </div>`;
  } else if (profileTab === 'appearance') {
    main.innerHTML = `<div class="profile-content" style="padding-top:28px;">
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:22px;">Appearance</div>
      <div class="settings-section">
        <div class="settings-title">Theme</div>
        <div class="s-row" style="border-color:rgba(255,249,62,.2);"><span class="si">üåë</span><div class="st"><div class="sl">Dark (Default)</div><div class="ss">The Fortized fortress aesthetic</div></div><span style="color:var(--accent);font-size:13px;">‚úì Active</span></div>
        <div class="s-row" style="opacity:.5;cursor:not-allowed;"><span class="si">‚òÄÔ∏è</span><div class="st"><div class="sl">Light</div><div class="ss">Coming soon</div></div></div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Status</div>
        <div class="s-row" onclick="setStatus('online')" style="cursor:pointer;"><span class="si" style="color:var(--green);">‚óè</span><div class="st"><div class="sl">Online</div></div></div>
        <div class="s-row" onclick="setStatus('away')" style="cursor:pointer;"><span class="si" style="color:var(--yellow);">‚óè</span><div class="st"><div class="sl">Away</div></div></div>
        <div class="s-row" onclick="setStatus('dnd')" style="cursor:pointer;"><span class="si" style="color:var(--red);">‚óè</span><div class="st"><div class="sl">Do Not Disturb</div></div></div>
        <div class="s-row" onclick="setStatus('invisible')" style="cursor:pointer;"><span class="si" style="color:var(--muted);">‚óè</span><div class="st"><div class="sl">Invisible</div></div></div>
      </div>
    </div>`;
  }
}

function handlePfpUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('Max 5MB', 'error'); return; }
  const reader = new FileReader();
  reader.onload = ev => {
    CU.pfp = ev.target.result; saveUser();
    updateAvatarEl(document.getElementById('ua'), CU);
    buildProfileView('editprofile'); toast('Profile picture updated!', 'success');
  };
  reader.readAsDataURL(file);
}
function removePfp() { CU.pfp = null; saveUser(); updateAvatarEl(document.getElementById('ua'), CU); buildProfileView('editprofile'); toast('Photo removed', 'info'); }
function handleBannerUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (file.size > 5 * 1024 * 1024) { toast('Max 5MB', 'error'); return; }
  const reader = new FileReader();
  reader.onload = ev => { CU.banner = ev.target.result; saveUser(); buildProfileView('editprofile'); toast('Banner updated!', 'success'); };
  reader.readAsDataURL(file);
}
function removeBanner() { CU.banner = null; saveUser(); buildProfileView('editprofile'); toast('Banner removed', 'info'); }
function saveProfileEdits() {
  const dn = document.getElementById('edit-displayname')?.value.trim();
  const email = document.getElementById('edit-email')?.value.trim();
  const pc = document.getElementById('edit-pass-cur')?.value;
  const pn = document.getElementById('edit-pass-new')?.value;
  const pconf = document.getElementById('edit-pass-conf')?.value;
  const msg = document.getElementById('edit-msg');
  if (dn) CU.displayName = dn;
  if (email) CU.email = email;
  if (pc || pn || pconf) {
    if (!pc || !pn || !pconf) { if (msg) msg.innerHTML = '<span style="color:var(--red);">Fill all password fields.</span>'; return; }
    if (CU.password && pc !== CU.password) { if (msg) msg.innerHTML = '<span style="color:var(--red);">Wrong current password.</span>'; return; }
    if (pn !== pconf) { if (msg) msg.innerHTML = '<span style="color:var(--red);">Passwords don\'t match.</span>'; return; }
    if (pn.length < 6) { if (msg) msg.innerHTML = '<span style="color:var(--red);">Min 6 characters.</span>'; return; }
    CU.password = pn;
  }
  saveUser();
  document.getElementById('ua-name').textContent = CU.displayName || CU.username;
  if (msg) msg.innerHTML = '<span style="color:var(--green);">‚úì Saved!</span>';
  toast('Profile updated!', 'success');
  setTimeout(() => buildProfileView('myprofile'), 1000);
}
function setStatus(status) {
  CU.status = status; saveUser(); FortizedSocial.setStatus(CU.username, status);
  const labels = { online: '‚óè Online', away: '‚óè Away', dnd: '‚óè Do Not Disturb', invisible: '‚óè Invisible' };
  document.getElementById('ua-tag').textContent = labels[status] || '‚óè Online';
  toast(`Status: ${status}`, 'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleNotifPanel() {
  notifPanelOpen = !notifPanelOpen;
  document.getElementById('notif-panel').classList.toggle('open', notifPanelOpen);
  if (notifPanelOpen) buildNotifList();
}
function buildNotifList() {
  refreshCU();
  const list = document.getElementById('np-list'); if (!list) return;
  const notifs = FortizedSocial.getNotifications(CU.username);
  if (!notifs.length) { list.innerHTML = '<div class="np-empty">‚úì All caught up!</div>'; return; }
  list.innerHTML = notifs.map(n => {
    let icon = 'üîî', text = '';
    if (n.type === 'friend_request') { icon = 'üë•'; text = `<strong>${escapeHTML(n.from)}</strong> sent you a friend request`; }
    else if (n.type === 'friend_accept') { icon = 'ü§ù'; text = `<strong>${escapeHTML(n.from)}</strong> accepted your request`; }
    else if (n.type === 'dm') { icon = 'üí¨'; text = `<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview || '').slice(0, 40))}`; }
    const actions = n.type === 'friend_request' ? `<div class="np-actions">
      <button class="np-accept" onclick="acceptFriend('${n.from}');buildNotifList()">Accept</button>
      <button class="np-decline" onclick="declineFriend('${n.from}');buildNotifList()">Decline</button></div>` : '';
    return `<div class="np-item ${n.read ? '' : 'unread'}">
      <div class="np-icon">${icon}</div>
      <div class="np-text"><p>${text}</p><div class="np-time">${formatTimeAgo(n.time)}</div>${actions}</div>
    </div>`;
  }).join('');
}
function markAllRead() {
  FortizedSocial.markNotificationsRead(CU.username); refreshCU(); updateNotifBadge(); buildNotifList(); refreshHomeRight();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW USER PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function viewUserProfile(username) {
  const user = FortizedSocial.getUserByName(username);
  if (!user) { toast('User not found', 'error'); return; }
  const isFriend = (CU.friends || []).includes(username);
  const isOwn = username === CU.username;
  const hasSentReq = (CU.friendRequestsSent || []).includes(username);
  const status = FortizedSocial.getStatus(username);
  const body = document.getElementById('user-modal-body');
  body.innerHTML = `
    <div style="text-align:center;padding:6px 0 16px;">
      <div id="umod-av" style="margin:0 auto 12px;"></div>
      <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">${escapeHTML(user.displayName || user.username)}</div>
      <div style="font-size:13px;color:var(--muted-light);">@${user.username}</div>
      <div style="font-size:13px;margin-top:4px;color:${status === 'online' ? 'var(--green)' : status === 'away' ? 'var(--yellow)' : status === 'dnd' ? 'var(--red)' : 'var(--muted)'};">‚óè ${status}</div>
    </div>
    ${!isOwn ? `<div style="display:flex;gap:8px;justify-content:center;margin-bottom:10px;">
      <button class="btn-g" onclick="openDMChat('${username}');closeModal('modal-user')" style="font-size:13px;padding:8px 14px;">üí¨ Message</button>
      ${isFriend ? `<button class="btn-d" onclick="removeFriend('${username}');closeModal('modal-user')" style="font-size:13px;padding:8px 14px;">Remove Friend</button>`
      : hasSentReq ? `<button class="btn-g" style="font-size:13px;padding:8px 14px;opacity:.6;cursor:not-allowed;">Request Sent</button>`
      : `<button class="btn-a" onclick="quickAddFriend('${username}')" style="font-size:13px;padding:8px 14px;">+ Add Friend</button>`}
    </div>` : ''}
    <button class="btn-g" onclick="closeModal('modal-user')" style="width:100%;justify-content:center;font-size:13px;">Close</button>
  `;
  setTimeout(() => {
    const el = document.getElementById('umod-av'); if (!el) return;
    const av = buildAvatar(user, 64); av.style.borderRadius = '50%'; el.replaceWith(av);
  }, 0);
  openModal('modal-user');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXT MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.addEventListener('contextmenu', e => { e.preventDefault(); buildSmartCtxMenu(e); });

function buildSmartCtxMenu(e) {
  const target = e.target;
  const x = e.clientX, y = e.clientY;
  const selection = window.getSelection()?.toString().trim();
  const isMsgBubble = target.closest('.msg-bubble');
  const isFriendItem = target.closest('.friend-item, .ml-entry');
  const isChannelItem = target.closest('.ch-item');
  const isRailBastion = target.closest('.rail-bastion');
  const isInput = target.matches('input, textarea');
  const items = [];

  if (isMsgBubble) {
    const group = target.closest('.msg-group');
    const isOwn = group?.classList.contains('own');
    const author = group?.querySelector('.msg-author')?.textContent || '';
    const text = isMsgBubble.textContent;
    items.push({ label: 'üí¨ Message', section: true });
    items.push({ icon: 'üìã', label: 'Copy', action: () => navigator.clipboard?.writeText(text).then(() => toast('Copied!', 'info')) });
    if (selection) items.push({ icon: '‚úÇÔ∏è', label: `Copy "${selection.slice(0,20)}‚Ä¶"`, action: () => navigator.clipboard?.writeText(selection).then(() => toast('Copied!', 'info')) });
    items.push({ sep: true });
    if (!isOwn && author) {
      items.push({ icon: 'üë§', label: `View ${author}'s Profile`, action: () => viewUserProfile(author) });
      items.push({ icon: 'üí¨', label: `Message ${author}`, action: () => openDMChat(author) });
      items.push({ sep: true });
    }
    items.push({ icon: 'üòä', label: 'Add Reaction', action: () => toast('Reactions via toolbar', 'info') });
    if (isOwn) { items.push({ sep: true }); items.push({ icon: 'üóëÔ∏è', label: 'Delete', action: () => toast('Delete coming soon', 'info'), danger: true }); }
    showCtxMenu(x, y, items); return;
  }

  if (isFriendItem) {
    const nameEl = isFriendItem.querySelector('.fi-name, .ml-name');
    const username = nameEl?.textContent?.replace(' (you)', '').trim();
    if (username && username !== CU?.username) {
      items.push({ label: username, section: true });
      items.push({ icon: 'üí¨', label: 'Send Message', action: () => openDMChat(username) });
      items.push({ icon: 'üë§', label: 'View Profile', action: () => viewUserProfile(username) });
      items.push({ sep: true });
      items.push({ icon: 'üóëÔ∏è', label: 'Remove Friend', action: () => removeFriend(username), danger: true });
      showCtxMenu(x, y, items); return;
    }
  }

  if (isChannelItem) {
    const chName = isChannelItem.querySelector('span:last-child')?.textContent || 'channel';
    const chIdx = [...(isChannelItem.parentElement?.querySelectorAll('.ch-item') || [])].indexOf(isChannelItem);
    items.push({ label: `# ${chName}`, section: true });
    items.push({ icon: 'üìã', label: 'Copy Name', action: () => navigator.clipboard?.writeText(chName).then(() => toast('Copied!', 'info')) });
    if (curBastion !== null) items.push({ icon: 'üóëÔ∏è', label: 'Delete Channel', action: () => deleteChannel(curBastion, chIdx), danger: true });
    showCtxMenu(x, y, items); return;
  }

  if (isRailBastion) {
    const idx = [...document.querySelectorAll('.rail-bastion')].indexOf(isRailBastion);
    const b = CU?.bastions?.[idx];
    if (b) {
      items.push({ label: b.name, section: true });
      items.push({ icon: 'üè∞', label: 'Open', action: () => openBastion(idx) });
      items.push({ sep: true });
      items.push({ icon: 'üö™', label: 'Leave Bastion', action: () => toast('Leave coming soon', 'info'), danger: true });
      showCtxMenu(x, y, items); return;
    }
  }

  if (isInput) {
    items.push({ label: 'Text', section: true });
    if (selection) items.push({ icon: 'üìã', label: 'Copy', action: () => navigator.clipboard?.writeText(selection).then(() => toast('Copied!', 'info')) });
    items.push({ icon: 'üìÑ', label: 'Paste', action: () => navigator.clipboard?.readText().then(t => document.execCommand('insertText', false, t)).catch(() => toast('Use Ctrl+V', 'info')) });
    showCtxMenu(x, y, items); return;
  }

  // General
  items.push({ label: 'Fortized', section: true });
  items.push({ icon: 'üè†', label: 'Home', action: () => navigate('home') });
  items.push({ icon: 'üß≠', label: 'Discover', action: () => navigate('discover') });
  items.push({ icon: 'üíé', label: 'Atelier', action: () => navigate('atelier') });
  items.push({ sep: true });
  items.push({ icon: 'üîî', label: 'Notifications', action: () => toggleNotifPanel() });
  items.push({ icon: '‚öôÔ∏è', label: 'Settings', action: () => navigate('profile') });
  items.push({ sep: true });
  items.push({ icon: 'üö™', label: 'Log Out', action: () => logout(), danger: true });
  showCtxMenu(x, y, items);
}

function showCtxMenu(x, y, items) {
  const menu = document.getElementById('ctx-menu');
  menu.innerHTML = ''; menu.className = 'ctx-menu';
  menu.style.display = 'block'; menu.style.left = '-9999px'; menu.style.top = '-9999px';
  items.forEach(item => {
    if (item.sep) { const s = document.createElement('div'); s.className = 'ctx-sep'; menu.appendChild(s); return; }
    if (item.section) { const s = document.createElement('div'); s.className = 'ctx-section-label'; s.textContent = item.label; menu.appendChild(s); return; }
    const el = document.createElement('div');
    el.className = 'ctx-item' + (item.danger ? ' danger' : '') + (item.disabled ? ' disabled' : '');
    el.innerHTML = `<span class="ctx-icon">${item.icon || ''}</span><span class="ctx-label">${item.label}</span>${item.shortcut ? `<span class="ctx-shortcut">${item.shortcut}</span>` : ''}`;
    if (!item.disabled) el.onclick = e => { e.stopPropagation(); item.action(); menu.style.display = 'none'; };
    menu.appendChild(el);
  });
  const mw = menu.offsetWidth, mh = menu.offsetHeight;
  const vw = window.innerWidth, vh = window.innerHeight;
  let left = x + 2, top = y + 2;
  if (left + mw > vw - 8) left = x - mw - 2;
  if (top + mh > vh - 8) top = y - mh - 2;
  if (left < 8) left = 8; if (top < 8) top = 8;
  menu.style.left = left + 'px'; menu.style.top = top + 'px';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function scrollBottom(id) { setTimeout(() => { const el = document.getElementById(id); if (el) el.scrollTop = el.scrollHeight; }, 60); }
function autoResize(el) { el.style.height = ''; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
function parseMD(text) {
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code style="background:rgba(255,255,255,.07);padding:1px 6px;border-radius:5px;font-size:12.5px;">$1</code>')
    .replace(/~~(.+?)~~/g, '<s>$1</s>');
}
function formatTimeAgo(iso) {
  if (!iso) return '';
  const diff = Date.now() - new Date(iso).getTime();
  const m = Math.floor(diff / 60000);
  if (m < 1) return 'just now'; if (m < 60) return `${m}m ago`;
  const h = Math.floor(m / 60); if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}
function escapeHTML(str) { return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;'); }
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
let toastTimer;
function toast(msg, type = 'info') {
  const el = document.getElementById('toast'); el.textContent = msg; el.className = 'toast show ' + type;
  clearTimeout(toastTimer); toastTimer = setTimeout(() => el.classList.remove('show'), 3000);
}
function logout() {
  FortizedSocial.setStatus(CU.username, 'offline'); FortizedSocial.stopPolling();
  localStorage.removeItem('fortized_current_user'); window.location.href = 'login.html';
}

document.querySelectorAll('.modal-overlay').forEach(o => { o.addEventListener('click', e => { if (e.target === o) o.classList.remove('open'); }); });
document.addEventListener('click', () => { document.getElementById('ctx-menu').style.display = 'none'; });
document.addEventListener('scroll', () => { document.getElementById('ctx-menu').style.display = 'none'; }, true);
document.addEventListener('keydown', e => { if (e.key === 'Escape') document.getElementById('ctx-menu').style.display = 'none'; });
</script>
</body>
</html>
