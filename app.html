<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link rel="icon" type="image/png" href="Fortized icon.png">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="FortizedSocial-firebase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
:root{--accent:#fff93e;--accent-dim:rgba(255,249,62,.1);--accent-mid:rgba(255,249,62,.22);--bg:#07090e;--rail:#04060a;--sidebar:#0b0e15;--channel:#0d1018;--panel:#101420;--panel2:#131822;--panel3:#161c28;--border:#1c2335;--muted:#4e5a6f;--muted-light:#7d8a9e;--text:#dde3ed;--green:#3ecf6e;--red:#f87171;--yellow:#f59e0b;--blue:#60a5fa;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;}
::selection{background:rgba(255,249,62,.2);}
::-webkit-scrollbar{width:4px;height:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}
.rail{width:68px;min-width:68px;background:var(--rail);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:10;overflow-y:auto;}
.rail-logo{width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-bottom:6px;}
.rail-logo img{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,249,62,.3));}
.rail-sep{width:30px;height:1px;background:var(--border);margin:5px 0;opacity:.4;}
.rail-btn{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;flex-shrink:0;font-size:18px;}
.rail-btn:hover{background:rgba(255,255,255,.07);border-radius:12px;}
.rail-btn.active{background:var(--accent-dim);border-radius:12px;}
.rail-btn.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#0c1020;border:1px solid var(--border);color:var(--text);font-size:12px;font-weight:600;padding:5px 10px;border-radius:9px;white-space:nowrap;z-index:999;pointer-events:none;}
.rail-bastion{width:42px;height:42px;border-radius:14px;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .15s;position:relative;overflow:hidden;flex-shrink:0;}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:12px;background:var(--accent-dim);}
.rail-bastion.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-bastion img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.rail-notif-badge{position:absolute;top:2px;right:2px;min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--rail);padding:0 2px;}
.sidebar{width:240px;min-width:240px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{height:52px;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;gap:7px;background:rgba(0,0,0,.15);}
.sidebar-header .hdr-actions{margin-left:auto;display:flex;gap:2px;}
.sidebar-header .hdr-actions button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.sidebar-header .hdr-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 0;}
.sec-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 5px;display:flex;align-items:center;justify-content:space-between;}
.sec-label button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;}
.ch-item{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:12.5px;color:var(--muted);transition:all .1s;}
.ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.ch-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.cat-row{display:flex;align-items:center;gap:5px;padding:10px 8px 4px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);cursor:pointer;}
.cat-row button{margin-left:auto;background:none;border:none;color:inherit;cursor:pointer;font-size:14px;opacity:0;}
.cat-row:hover button{opacity:1;}
.friend-item{display:flex;align-items:center;gap:9px;padding:6px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;transition:background .1s;}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.fa{position:relative;flex-shrink:0;border-radius:50%;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;overflow:visible;}
.fa .fs{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--sidebar);}
.fs.online{background:var(--green);}.fs.away{background:var(--yellow);}.fs.dnd{background:var(--red);}.fs.offline,.fs.invisible{background:#374151;}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.userbar{height:56px;background:rgba(4,6,10,.8);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 8px;gap:7px;flex-shrink:0;}
.ua{width:34px;height:34px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;cursor:pointer;}
.ua img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ua-info{flex:1;min-width:0;}
.ua-name{font-size:13px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ua-tag{font-size:10.5px;color:var(--muted);}
.ua-btns{display:flex;gap:2px;}
.ua-btns button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.ua-btns button:hover{background:rgba(255,255,255,.07);color:#fff;}
.main{flex:1;min-width:0;display:flex;flex-direction:column;}
.topbar{height:52px;background:rgba(8,11,18,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:10px;flex-shrink:0;}
.topbar-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap;}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 2px;}
.tb-desc{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.tb-actions{margin-left:auto;display:flex;align-items:center;gap:6px;}
.tb-actions button{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.tb-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{display:flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:100px;padding:5px 12px;font-size:12px;font-weight:700;color:var(--accent);cursor:pointer;}
.onyx-pill img{width:14px;height:14px;object-fit:contain;}
.tb-search{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:5px 10px;width:170px;transition:all .2s;}
.tb-search:focus-within{border-color:rgba(255,249,62,.2);width:210px;}
.tb-search input{background:transparent;border:none;outline:none;color:#fff;font-family:'DM Sans',sans-serif;font-size:12.5px;flex:1;}
.tb-search input::placeholder{color:var(--muted);}
.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;}.view.active{display:flex;}
.app-loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;}
.app-loading .lbl{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--muted-light);}
@keyframes spin{to{transform:rotate(360deg);}}
.load-spinner{width:32px;height:32px;border:3px solid rgba(255,249,62,.15);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
.home-wrap{flex:1;display:flex;overflow:hidden;}
.home-feed{flex:1;overflow-y:auto;}
.home-right{width:290px;min-width:290px;border-left:1px solid var(--border);overflow-y:auto;background:var(--channel);}
.home-hero{width:100%;min-height:280px;background:linear-gradient(105deg,rgba(7,9,14,.98) 35%,rgba(7,9,14,.65) 100%),url("Fortized banner.png") center/cover no-repeat;position:relative;overflow:hidden;flex-shrink:0;display:grid;grid-template-columns:1fr auto;align-items:center;padding:0 48px;}
.home-hero::after{content:"";position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to bottom,transparent,var(--bg));pointer-events:none;}
@keyframes revealUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}
.hero-left-content{position:relative;z-index:1;animation:revealUp .5s cubic-bezier(.22,1,.36,1) both;}
.hero-tag-app{display:inline-flex;align-items:center;gap:8px;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:100px;padding:5px 14px;margin-bottom:20px;}
.hero-tag-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 2s ease infinite;}
@keyframes blink{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.3;transform:scale(.6);}}
.home-hero h1{font-family:'Syne',sans-serif;font-size:48px;font-weight:800;letter-spacing:-2px;line-height:.96;margin-bottom:14px;}
.home-hero h1 em{font-style:normal;color:var(--accent);}
.home-hero p.hero-sub-app{font-size:14.5px;color:rgba(255,255,255,.6);line-height:1.65;max-width:360px;margin-bottom:26px;}
.home-hero-actions{display:flex;gap:10px;flex-wrap:wrap;}
.home-hero-knight{position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:center;height:280px;width:200px;}
.home-hero-knight img{height:250px;object-fit:contain;filter:drop-shadow(0 20px 40px rgba(255,249,62,.15));animation:float 5.5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-14px);}}
.home-marquee{background:rgba(11,14,21,.7);border-top:1px solid var(--border);border-bottom:1px solid var(--border);overflow:hidden;position:relative;flex-shrink:0;}
.home-marquee::before{left:0;background:linear-gradient(to right,var(--bg),transparent);}
.home-marquee::after{right:0;background:linear-gradient(to left,var(--bg),transparent);}
.home-marquee::before,.home-marquee::after{content:"";position:absolute;top:0;bottom:0;width:80px;z-index:2;pointer-events:none;}
.marquee-track{display:flex;animation:marquee 20s linear infinite;width:max-content;}
@keyframes marquee{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.marquee-item{display:flex;align-items:center;gap:10px;padding:14px 36px;border-right:1px solid var(--border);white-space:nowrap;}
.mi-label{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;color:var(--muted-light);letter-spacing:.04em;}
.home-main-scroll{padding:28px 32px 48px;max-width:900px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-hdr h3{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.section-hdr h3::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.quick-nav{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px;}
.qn-tile{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 18px;cursor:pointer;transition:all .22s;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;}
.qn-tile:hover{border-color:rgba(255,249,62,.2);transform:translateY(-4px);}
.qn-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;}
.qn-text h4{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:2px;}
.qn-text p{font-size:12px;color:var(--muted);}
.qn-badge{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:100px;}
.activity-item{display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .2s;margin-bottom:8px;}
.activity-item:hover{border-color:rgba(255,249,62,.16);transform:translateY(-2px);}
.act-icon{width:40px;height:40px;border-radius:14px;background:var(--panel2);border:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.act-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.act-text{flex:1;}
.act-text p{font-size:14px;color:var(--text);line-height:1.5;}
.act-time{font-size:11.5px;color:var(--muted);margin-top:2px;}
.rp-section{padding:16px 14px 8px;border-bottom:1px solid var(--border);}
.rp-title{font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.rp-notif{display:flex;gap:9px;padding:8px 10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.rp-notif:hover{background:rgba(255,255,255,.04);}
.rn-icon{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rn-text p{font-size:12.5px;color:var(--text);line-height:1.4;}
.rn-time{font-size:10.5px;color:var(--muted);}
.rn-actions{display:flex;gap:5px;margin-top:5px;}
.rn-accept{background:rgba(62,207,110,.15);border:1px solid rgba(62,207,110,.3);color:var(--green);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.rn-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.blog-post{padding:10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.blog-post:hover{background:rgba(255,255,255,.04);}
.bp-tag{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--accent);margin-bottom:3px;}
.bp-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.4;}
.bp-date{font-size:11px;color:var(--muted);}
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;}
.chat-welcome{padding:20px 20px 18px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.chat-welcome .w-av{width:60px;height:60px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:22px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:hidden;}
.chat-welcome .w-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.chat-welcome p{font-size:13.5px;color:var(--muted-light);}
.date-div{display:flex;align-items:center;gap:10px;padding:8px 20px;font-size:10.5px;font-weight:700;color:var(--muted);letter-spacing:.04em;}
.date-div::before,.date-div::after{content:"";flex:1;height:1px;background:var(--border);}
.msg-row{display:flex;padding:2px 20px;position:relative;}
.msg-row:hover{background:rgba(255,255,255,.018);}
.msg-row.msg-first{padding-top:16px;}
.msg-row.msg-editing{background:rgba(255,249,62,.04);}
.msg-av-wrap{width:40px;min-width:40px;display:flex;justify-content:center;padding-top:2px;flex-shrink:0;}
.msg-av-inner{width:36px;height:36px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0;}
.msg-av-inner img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.msg-time-small{font-size:10px;color:var(--muted);white-space:nowrap;padding-top:4px;min-width:44px;visibility:hidden;}
.msg-row.msg-cont:hover .msg-time-small{visibility:visible;}
.msg-content-col{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
.msg-author{font-size:14px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-timestamp{font-size:11px;color:var(--muted);}
.msg-text{font-size:14px;color:var(--text);line-height:1.55;word-break:break-word;max-width:680px;}
.msg-text code{background:rgba(255,255,255,.07);padding:1px 6px;border-radius:5px;font-size:12.5px;font-family:monospace;}
.msg-edited{font-size:10.5px;color:var(--muted);margin-left:4px;}
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.r-pill{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:100px;padding:2px 9px;font-size:12.5px;cursor:pointer;}
.r-pill:hover{background:rgba(255,255,255,.09);}
.r-pill.mine{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.msg-acts{display:none;gap:2px;position:absolute;right:14px;top:-14px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:3px;z-index:10;}
.msg-row:hover .msg-acts{display:flex;}
.msg-acts button{background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.msg-acts button:hover{background:rgba(255,255,255,.07);color:#fff;}
.msg-row.own .msg-text{color:rgba(255,249,62,.92);}
.msg-reply-ref{display:flex;align-items:center;gap:6px;padding:4px 8px;background:rgba(255,255,255,.04);border-left:2px solid var(--accent-mid);border-radius:4px;margin-bottom:4px;font-size:12px;color:var(--muted);cursor:pointer;}
.msg-reply-ref:hover{background:rgba(255,255,255,.07);}
.msg-forward-tag{font-size:10.5px;color:var(--muted);margin-bottom:2px;}
.reply-bar{display:none;align-items:center;gap:10px;padding:8px 16px;background:rgba(255,255,255,.04);border-top:1px solid var(--border);font-size:12.5px;}
.reply-bar.show{display:flex;}
.reply-bar-text{flex:1;color:var(--muted-light);}
.reply-bar-text strong{color:var(--accent);}
.reply-bar button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;}
.chat-input-wrap{padding:0 16px 14px;flex-shrink:0;}
.chat-input-box{background:var(--panel2);border:1px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;gap:5px;padding:8px 11px;transition:border-color .15s;}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.24);}
.chat-input-box textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13.5px;resize:none;max-height:120px;line-height:1.5;padding:2px 0;}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{width:32px;height:32px;border-radius:10px;background:var(--accent);border:none;color:#060810;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-send:hover{filter:brightness(1.08);}
.chat-input-actions{display:flex;gap:2px;align-items:center;}
.chat-input-actions button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.member-list{width:220px;min-width:220px;background:var(--channel);border-left:1px solid var(--border);overflow-y:auto;padding:12px 0;}
.ml-role-header{padding:4px 12px 2px;font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:8px;}
.ml-entry{display:flex;align-items:center;gap:8px;padding:5px 9px 5px 12px;margin:1px 4px;border-radius:10px;cursor:pointer;transition:background .1s;}
.ml-entry:hover{background:rgba(255,255,255,.05);}
.ml-av{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;position:relative;}
.ml-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ml-status{position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border-radius:50%;border:2px solid var(--channel);}
.ml-name{font-size:12.5px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.discover-scroll{flex:1;overflow-y:auto;padding:28px;}
.disc-hero{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:38px 36px;margin-bottom:28px;}
.disc-hero h2{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px;}
.disc-hero p{font-size:14px;color:var(--muted-light);margin-bottom:20px;}
.disc-search{max-width:400px;position:relative;}
.disc-search input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;padding:10px 14px 10px 38px;outline:none;}
.disc-search input::placeholder{color:var(--muted);}
.disc-search .si{position:absolute;left:12px;top:50%;transform:translateY(-50%);font-size:13px;color:var(--muted);}
.disc-tabs{display:flex;gap:5px;margin-bottom:22px;margin-top:16px;}
.disc-tab{padding:7px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--muted-light);}
.disc-tab:hover{background:rgba(255,255,255,.05);color:#fff;}
.disc-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.bc{background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;transition:all .15s;}
.bc:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);}
.bc-banner{height:76px;background:linear-gradient(135deg,#1a2040,#0d1425);display:flex;align-items:center;justify-content:center;font-size:30px;overflow:hidden;}
.bc-banner img{width:100%;height:100%;object-fit:cover;}
.bc-body{padding:14px;}
.bc-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bc-icon{width:42px;height:42px;border-radius:12px;background:var(--panel2);border:2px solid var(--sidebar);font-size:18px;display:flex;align-items:center;justify-content:center;margin-top:-26px;position:relative;z-index:1;flex-shrink:0;overflow:hidden;}
.bc-icon img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.bc-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.bc-desc{font-size:12px;color:var(--muted-light);line-height:1.55;margin-bottom:8px;}
.atelier-scroll{flex:1;overflow-y:auto;padding:28px;}
.atelier-top{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:26px 30px;margin-bottom:26px;}
.atelier-bal{display:flex;align-items:center;gap:13px;}
.atelier-bal img{width:36px;height:36px;object-fit:contain;}
.atelier-bal h3{font-size:13px;font-weight:600;color:var(--muted-light);margin-bottom:2px;}
.atelier-bal .amt{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:var(--accent);}
.daily-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:16px;padding:14px 24px;cursor:pointer;}
.daily-btn span{font-size:11px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:14px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.atelier-section-title::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:28px;}
.rad-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px 18px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.rad-card:hover{border-color:rgba(255,249,62,.22);transform:translateY(-2px);}
.best-badge{position:absolute;top:10px;right:10px;background:var(--accent);color:#060810;font-size:9px;font-weight:800;padding:2px 7px;border-radius:100px;text-transform:uppercase;}
.rad-icon{font-size:30px;}.rad-dur{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.rad-price{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--accent);}
.rad-price span{font-size:12px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-feats{font-size:12px;color:var(--muted-light);}
.profile-wrap{flex:1;display:flex;overflow:hidden;}
.profile-nav{width:210px;min-width:210px;border-right:1px solid var(--border);background:var(--channel);display:flex;flex-direction:column;padding:12px 0;overflow-y:auto;}
.profile-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13.5px;color:var(--muted-light);transition:all .1s;}
.profile-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.profile-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.profile-main{flex:1;overflow-y:auto;}
.profile-banner-area{width:100%;height:150px;background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);position:relative;overflow:hidden;}
.profile-banner-area img{width:100%;height:100%;object-fit:cover;}
.profile-av-row{display:flex;align-items:flex-end;gap:14px;padding:0 24px;margin-top:-28px;margin-bottom:14px;}
.profile-av-big{width:56px;height:56px;border-radius:50%;background:var(--panel);border:3px solid var(--bg);font-size:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;cursor:pointer;}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-display-name{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:2px;}
.profile-username{font-size:13.5px;color:var(--muted-light);}
.profile-content{padding:0 24px 36px;}
.profile-stats-row{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;margin-bottom:22px;}
.ps-stat{flex:1;padding:16px;text-align:center;border-right:1px solid var(--border);}
.ps-stat:last-child{border-right:none;}
.ps-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.ps-key{font-size:11.5px;color:var(--muted);margin-top:2px;}
.settings-section{margin-bottom:24px;}
.settings-title{font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.s-row{display:flex;align-items:center;gap:12px;padding:13px 15px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;cursor:pointer;}
.s-row .sl{font-size:13.5px;font-weight:600;}
.s-row .ss{font-size:12px;color:var(--muted-light);margin-top:1px;}
.field-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;transition:border-color .12s;}
.field-input:focus{border-color:rgba(255,249,62,.3);}
.field-input::placeholder{color:#252c3d;}
.toggle{width:38px;height:20px;border-radius:10px;background:var(--border);position:relative;cursor:pointer;transition:background .15s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .15s;}
.toggle.on::after{transform:translateX(18px);}
.radiance-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));border:1px solid rgba(255,220,62,.25);border-radius:100px;padding:3px 10px;font-size:11px;font-weight:700;color:#ffd93e;margin-top:5px;}
.bsettings-wrap{flex:1;display:flex;overflow:hidden;}
.bsettings-nav{width:220px;min-width:220px;border-right:1px solid var(--border);background:var(--channel);overflow-y:auto;padding:12px 0;}
.bsettings-main{flex:1;overflow-y:auto;padding:28px;}
.bsettings-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13px;color:var(--muted-light);transition:all .1s;}
.bsettings-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.bsettings-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.bsettings-nav-section{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 4px;}
.role-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;cursor:pointer;}
.role-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.role-name{flex:1;font-size:13.5px;font-weight:600;}
.perm-row{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.perm-info{flex:1;}
.perm-label{font-size:13.5px;font-weight:600;}
.emoji-upload-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(70px,1fr));gap:8px;margin-bottom:16px;}
.emoji-slot{min-height:70px;border-radius:12px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;position:relative;overflow:hidden;font-size:22px;flex-direction:column;gap:3px;padding:6px;}
.emoji-slot:hover{border-color:var(--accent);background:var(--accent-dim);}
.emoji-slot.filled{border-style:solid;border-color:var(--border);}
.emoji-slot img{width:38px;height:38px;object-fit:contain;border-radius:6px;}
.emoji-slot .es-name{font-size:9px;color:var(--muted);text-overflow:ellipsis;overflow:hidden;width:100%;text-align:center;}
.emoji-slot .es-del{position:absolute;top:3px;right:3px;width:16px;height:16px;border-radius:50%;background:var(--red);color:#fff;font-size:9px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:2;}
.emoji-slot:hover .es-del{display:flex;}
.automod-rule{padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;}
.amr-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.amr-title{font-size:14px;font-weight:700;flex:1;}
.amr-desc{font-size:12.5px;color:var(--muted-light);line-height:1.55;margin-bottom:10px;}
.amr-keywords{display:flex;flex-wrap:wrap;gap:5px;}
.amr-kw{display:flex;align-items:center;gap:4px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:11.5px;padding:3px 8px;border-radius:100px;}
.voice-ch-item{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:12.5px;color:var(--muted);transition:all .1s;}
.voice-ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.voice-ch-item.active-vc{background:rgba(62,207,110,.06);color:var(--green);}
.voice-connected-bar{background:rgba(62,207,110,.06);border:1px solid rgba(62,207,110,.15);border-radius:12px;padding:10px 14px;margin:8px 8px 4px;display:none;}
.voice-connected-bar.show{display:block;}
.vcb-top{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.vcb-name{font-size:12px;font-weight:600;color:var(--green);flex:1;}
.vcb-disc{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:11px;font-weight:700;padding:3px 9px;border-radius:7px;cursor:pointer;}
.vcb-part{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted-light);}
.voice-panel{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);gap:20px;padding:40px;}
.voice-panel-title{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;}
.voice-panel-sub{font-size:14px;color:var(--muted);}
.voice-avatars{display:flex;flex-wrap:wrap;gap:20px;justify-content:center;max-width:600px;}
.voice-avatar-card{display:flex;flex-direction:column;align-items:center;gap:8px;}
.voice-avatar-ring{width:72px;height:72px;border-radius:50%;border:3px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:24px;overflow:hidden;background:var(--panel);}
.voice-avatar-ring img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.voice-avatar-ring.speaking{border-color:var(--green);}
.voice-avatar-name{font-size:12px;color:var(--text);}
.voice-controls{display:flex;gap:12px;align-items:center;margin-top:8px;}
.vc-btn{width:52px;height:52px;border-radius:50%;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:20px;}
.vc-btn.muted-btn{background:rgba(255,255,255,.08);color:var(--text);}
.vc-btn.muted-btn.active{background:rgba(248,113,113,.15);border:1px solid rgba(248,113,113,.3);}
.vc-btn.disc-btn{background:var(--red);color:#fff;}
.emoji-picker-panel{position:fixed;width:340px;background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:0;z-index:2000;box-shadow:0 20px 50px rgba(0,0,0,.6);display:none;flex-direction:column;overflow:hidden;}
.emoji-picker-panel.show{display:flex;}
.epp-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.epp-search input{width:100%;background:rgba(255,255,255,.06);border:1px solid var(--border);border-radius:9px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;padding:7px 10px;outline:none;}
.epp-cats{display:flex;gap:2px;padding:6px 8px;border-bottom:1px solid var(--border);overflow-x:auto;}
.epp-cats::-webkit-scrollbar{height:0;}
.epp-cat{width:30px;height:28px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:16px;cursor:pointer;flex-shrink:0;}
.epp-cat:hover,.epp-cat.active{background:rgba(255,255,255,.08);}
.epp-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;padding:8px;max-height:200px;overflow-y:auto;}
.epp-emoji{width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;}
.epp-emoji:hover{background:rgba(255,255,255,.08);}
.epp-custom-section{padding:8px;border-top:1px solid var(--border);}
.epp-custom-title{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.epp-custom-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;}
.epp-custom-emoji{width:34px;height:34px;border-radius:7px;display:flex;align-items:center;justify-content:center;cursor:pointer;overflow:hidden;}
.epp-custom-emoji:hover{background:rgba(255,255,255,.08);}
.epp-custom-emoji img{width:26px;height:26px;object-fit:contain;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:20px;width:100%;max-width:420px;overflow:hidden;animation:mIn .2s cubic-bezier(.22,1,.36,1) both;box-shadow:0 32px 80px rgba(0,0,0,.7);}
.modal.wide{max-width:580px;}
.modal.tall{max-height:80vh;display:flex;flex-direction:column;}
.modal.tall .modal-body{overflow-y:auto;flex:1;}
@keyframes mIn{from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);}
.modal-body{padding:26px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px;}
.modal-sub{font-size:13px;color:var(--muted-light);margin-bottom:22px;}
.modal-error{font-size:12px;color:var(--red);margin-bottom:8px;min-height:16px;}
.modal-success{font-size:12px;color:var(--green);margin-bottom:8px;}
.modal-actions{display:flex;gap:9px;margin-top:6px;}
.modal-actions .btn-a,.modal-actions .btn-g{flex:1;justify-content:center;}
.modal-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;margin-bottom:12px;transition:border-color .12s;}
.modal-input:focus{border-color:rgba(255,249,62,.32);}
.modal-input::placeholder{color:#252c3d;}
.btn-a{display:inline-flex;align-items:center;gap:7px;background:var(--accent);color:#060810;padding:10px 20px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:none;cursor:pointer;transition:all .1s;}
.btn-a:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-a:disabled{opacity:.5;cursor:not-allowed;transform:none;}
.btn-g{display:inline-flex;align-items:center;gap:7px;background:transparent;color:var(--muted-light);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid var(--border);cursor:pointer;transition:all .1s;}
.btn-g:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-d{display:inline-flex;align-items:center;gap:7px;background:rgba(248,113,113,.1);color:var(--red);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid rgba(248,113,113,.2);cursor:pointer;transition:all .1s;}
.btn-d:hover{background:rgba(248,113,113,.18);}
.toast{position:fixed;bottom:22px;right:22px;z-index:9999;background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:11px 18px;font-size:13px;font-weight:500;box-shadow:0 20px 50px rgba(0,0,0,.6);transform:translateY(20px);opacity:0;transition:transform .25s cubic-bezier(.22,1,.36,1),opacity .25s;max-width:280px;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}
.ctx-menu{position:fixed;z-index:9999;background:rgba(11,14,22,.98);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:6px;min-width:200px;box-shadow:0 20px 50px rgba(0,0,0,.7);backdrop-filter:blur(22px);animation:ctxIn .14s cubic-bezier(.22,1,.36,1);}
@keyframes ctxIn{from{opacity:0;transform:scale(.96) translateY(-4px);}to{opacity:1;transform:none;}}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;font-size:13px;color:rgba(220,228,240,.9);cursor:pointer;}
.ctx-item:hover{background:rgba(255,255,255,.07);color:#fff;}
.ctx-item.danger{color:rgba(248,113,113,.85);}
.ctx-item.danger:hover{background:rgba(248,113,113,.12);color:var(--red);}
.ctx-sep{height:1px;background:rgba(255,255,255,.07);margin:5px 0;}
.ctx-section-label{padding:9px 12px 4px;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:rgba(255,255,255,.22);}
.notif-panel{position:fixed;top:52px;right:0;width:330px;max-height:calc(100vh - 60px);background:var(--sidebar);border:1px solid var(--border);border-radius:18px 0 0 18px;box-shadow:-8px 0 40px rgba(0,0,0,.5);z-index:500;transform:translateX(100%);transition:transform .22s cubic-bezier(.22,1,.36,1);display:flex;flex-direction:column;}
.notif-panel.open{transform:translateX(0);}
.np-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.np-header h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;flex:1;}
.np-list{flex:1;overflow-y:auto;padding:8px;}
.np-item{display:flex;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;margin-bottom:3px;position:relative;}
.np-item:hover{background:rgba(255,255,255,.04);}
.np-item.unread{background:rgba(255,249,62,.04);}
.np-item.unread::before{content:"";position:absolute;left:4px;top:50%;transform:translateY(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent);}
.np-icon{width:32px;height:32px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.np-text{flex:1;}
.np-text p{font-size:12.5px;color:var(--text);line-height:1.45;}
.np-time{font-size:10.5px;color:var(--muted);margin-top:2px;}
.np-actions{display:flex;gap:5px;margin-top:6px;}
.np-accept{background:rgba(62,207,110,.12);border:1px solid rgba(62,207,110,.25);color:var(--green);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.np-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--muted);text-align:center;padding:40px;}
.empty-state .ei{font-size:48px;opacity:.3;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13.5px;max-width:290px;line-height:1.6;}
.color-swatches{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;}
.color-swatch:hover,.color-swatch.sel{border-color:#fff;transform:scale(1.15);}
.notif-setting-row{display:flex;align-items:center;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.notif-setting-row:last-child{border-bottom:none;}
.nsr-info{flex:1;}
.nsr-label{font-size:13.5px;font-weight:600;}
.nsr-desc{font-size:12px;color:var(--muted-light);margin-top:1px;}
.input-dialog-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(10px);z-index:3000;display:flex;align-items:center;justify-content:center;}
.input-dialog{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px;max-width:380px;width:90%;}
.input-dialog h3{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;margin-bottom:6px;}
.input-dialog p{font-size:13px;color:var(--muted-light);margin-bottom:16px;}
.input-dialog input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:10px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;margin-bottom:14px;}
.input-dialog input:focus{border-color:rgba(255,249,62,.3);}
.input-dialog-actions{display:flex;gap:8px;}
.verify-overlay{position:fixed;inset:0;background:rgba(4,6,10,.97);backdrop-filter:blur(20px);z-index:5000;display:flex;align-items:center;justify-content:center;}
.verify-card{background:var(--panel);border:1px solid var(--border);border-radius:24px;padding:40px;max-width:480px;width:90%;text-align:center;}
.verify-logo{width:80px;height:80px;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.2);border-radius:22px;overflow:hidden;}
.verify-logo img{width:60px;height:60px;object-fit:contain;}
.verify-card h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:8px;}
.verify-card p.verify-sub{font-size:14px;color:var(--muted-light);margin-bottom:28px;line-height:1.6;}
.quiz-question{background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:20px;margin-bottom:16px;text-align:left;}
.quiz-question p{font-size:15px;font-weight:600;margin-bottom:14px;color:#fff;}
.quiz-options{display:flex;flex-direction:column;gap:8px;}
.quiz-opt{padding:10px 16px;border-radius:10px;border:1.5px solid var(--border);cursor:pointer;font-size:13.5px;color:var(--muted-light);text-align:left;}
.quiz-opt:hover{border-color:rgba(255,249,62,.3);background:rgba(255,249,62,.04);color:#fff;}
.quiz-opt.correct{border-color:var(--green);background:rgba(62,207,110,.08);color:var(--green);}
.quiz-opt.wrong{border-color:var(--red);background:rgba(248,113,113,.08);color:var(--red);}
.quiz-progress{display:flex;gap:6px;justify-content:center;margin-bottom:20px;}
.quiz-dot{width:8px;height:8px;border-radius:50%;background:var(--border);}
.quiz-dot.done{background:var(--green);}.quiz-dot.current{background:var(--accent);}
.boost-bar{background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12.5px;color:var(--muted-light);cursor:pointer;margin:8px 8px 4px;}
.boost-bar .bl{font-weight:700;color:var(--accent);}
</style>
<body>
<!-- APP LOADING -->
<div class="app-loading" id="app-loading">
  <img src="Fortized icon.png" style="width:50px;height:50px;object-fit:contain;filter:drop-shadow(0 0 16px rgba(255,249,62,.4));">
  <div class="load-spinner"></div>
  <div class="lbl">Loading Fortized...</div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- CONTEXT MENU -->
<div class="ctx-menu" id="ctx-menu" style="display:none;"></div>

<!-- EMOJI PICKER -->
<div class="emoji-picker-panel" id="emoji-picker"></div>

<!-- NOTIFICATION PANEL -->
<div class="notif-panel" id="notif-panel">
  <div class="np-header">
    <h3>üîî Notifications</h3>
    <button onclick="markAllRead()" style="font-size:11px;background:none;border:none;color:var(--muted);cursor:pointer;">Mark all read</button>
    <button onclick="toggleNotifPanel()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:18px;">√ó</button>
  </div>
  <div class="np-list" id="np-list"><div style="padding:20px;text-align:center;font-size:13px;color:var(--muted);">Loading‚Ä¶</div></div>
</div>

<!-- RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="showView('home')" data-tip="Home">
    <img src="Fortized icon.png" onerror="this.style.display='none'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn" id="rb-home" data-tip="Home" onclick="showView('home')">üè†</div>
  <div class="rail-btn" id="rb-dms" data-tip="Messages" onclick="showView('dms')">üí¨</div>
  <div class="rail-btn" id="rb-friends" data-tip="Friends" onclick="showView('friends')">üë•</div>
  <div class="rail-btn" id="rb-notifs" data-tip="Notifications" onclick="toggleNotifPanel()" style="position:relative;">
    üîî<span class="rail-notif-badge" id="notif-badge" style="display:none;">0</span>
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn" id="rb-discover" data-tip="Discover" onclick="showView('discover')">üß≠</div>
  <div class="rail-btn" id="rb-atelier" data-tip="Atelier (Shop)" onclick="showView('atelier')">üíé</div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" data-tip="Create Bastion" onclick="openModal('modal-create-bastion')" style="margin-top:4px;">‚ûï</div>
  <div style="flex:1;"></div>
  <div class="rail-btn" id="rb-profile" data-tip="Profile & Settings" onclick="showView('profile')">‚öôÔ∏è</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebar-header">
    <span id="sidebar-title">Home</span>
    <div class="hdr-actions" id="sidebar-hdr-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <div class="voice-connected-bar" id="voice-connected-bar">
    <div class="vcb-top">
      <span class="vcb-name" id="vcb-channel-name">üéô Connected</span>
      <button class="vcb-disc" onclick="disconnectVoice()">Disconnect</button>
    </div>
    <div class="vcb-participants" id="vcb-participants"></div>
  </div>
  <div class="userbar">
    <div class="ua" id="ua" onclick="showView('profile')"></div>
    <div class="ua-info">
      <div class="ua-name" id="ua-name">Loading‚Ä¶</div>
      <div class="ua-tag" id="ua-tag">@user</div>
    </div>
    <div class="ua-btns">
      <button onclick="toggleMic()" id="mic-btn" title="Mute/Unmute">üé§</button>
      <button onclick="showView('profile')" title="Settings">‚öô</button>
    </div>
  </div>
</div>

<!-- MAIN AREA -->
<div class="main">
  <!-- TOPBAR -->
  <div class="topbar" id="topbar">
    <div class="topbar-title" id="topbar-title">üè† Home</div>
    <div class="tb-sep" id="tb-sep" style="display:none;"></div>
    <div class="tb-desc" id="tb-desc"></div>
    <div class="tb-actions" id="tb-actions">
      <div class="tb-search">
        <span>üîç</span>
        <input type="text" placeholder="Search‚Ä¶" id="search-input" oninput="handleSearch(this.value)">
      </div>
      <div class="onyx-pill" onclick="showView('atelier')" id="onyx-display">
        <img src="Onyx.png" onerror="this.style.display='none'">
        <span id="onyx-val">0</span>
      </div>
    </div>
  </div>

  <!-- CONTENT VIEWS -->
  <div class="content">

    <!-- HOME VIEW -->
    <div class="view" id="view-home">
      <div class="home-wrap">
        <div class="home-feed">
          <div class="home-hero">
            <div class="hero-left-content">
              <div class="hero-tag-app"><span class="hero-tag-dot"></span>FORTIZED PLATFORM</div>
              <h1>Your <em>Community</em><br>Awaits</h1>
              <p class="hero-sub-app">Join Bastions, chat with friends, and build your world on Fortized ‚Äî the platform built for real communities.</p>
              <div class="home-hero-actions">
                <button class="btn-a" onclick="showView('discover')">üß≠ Discover Bastions</button>
                <button class="btn-g" onclick="openModal('modal-create-bastion')">‚ûï Create Bastion</button>
              </div>
            </div>
            <div class="home-hero-knight">
              <img src="Fortized Knight.png" onerror="this.style.display='none'" alt="Fortized Knight">
            </div>
          </div>
          <div class="home-marquee">
            <div class="marquee-track" id="marquee-track">
              <!-- items injected by JS -->
            </div>
          </div>
          <div class="home-main-scroll">
            <div class="section-hdr"><h3>Quick Access</h3></div>
            <div class="quick-nav" id="quick-nav"></div>
            <div class="section-hdr"><h3>Recent Activity</h3></div>
            <div id="activity-feed"></div>
          </div>
        </div>
        <div class="home-right">
          <div class="rp-section">
            <div class="rp-title">Your Bastions</div>
            <div id="rp-bastions"></div>
          </div>
          <div class="rp-section">
            <div class="rp-title">Online Friends</div>
            <div id="rp-friends"></div>
          </div>
          <div class="rp-section">
            <div class="rp-title">Latest from Fortized</div>
            <div class="blog-post" onclick="toast('Opening blog post‚Ä¶','info')">
              <div class="bp-tag">Update</div>
              <div class="bp-title">Custom Emoji & Bastion Boosts are live!</div>
              <div class="bp-date">Feb 2026</div>
            </div>
            <div class="blog-post" onclick="toast('Opening blog post‚Ä¶','info')">
              <div class="bp-tag">Feature</div>
              <div class="bp-title">AutoMod now supports custom keywords</div>
              <div class="bp-date">Jan 2026</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- DMs VIEW -->
    <div class="view" id="view-dms">
      <div class="chat-wrap" id="dm-chat-wrap">
        <div class="empty-state">
          <div class="ei">üí¨</div>
          <h3>No conversation selected</h3>
          <p>Choose a friend from the sidebar to start chatting.</p>
          <button class="btn-a" onclick="openModal('modal-new-dm')">‚ûï New Message</button>
        </div>
      </div>
    </div>

    <!-- FRIENDS VIEW -->
    <div class="view" id="view-friends">
      <div style="flex:1;overflow-y:auto;padding:28px;">
        <div style="max-width:700px;">
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:28px;">
            <h2 style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;">Friends</h2>
            <button class="btn-a" onclick="openModal('modal-add-friend')" style="font-size:13px;padding:8px 16px;">+ Add Friend</button>
          </div>
          <div id="friends-tabs" style="display:flex;gap:5px;margin-bottom:20px;">
            <button class="disc-tab active" onclick="filterFriends('all',this)">All</button>
            <button class="disc-tab" onclick="filterFriends('online',this)">Online</button>
            <button class="disc-tab" onclick="filterFriends('pending',this)">Pending</button>
          </div>
          <div id="friends-list"></div>
        </div>
      </div>
    </div>

    <!-- BASTION VIEW -->
    <div class="view" id="view-bastion">
      <div class="chat-wrap" id="bastion-chat-wrap">
        <div class="empty-state">
          <div class="ei">üè∞</div>
          <h3>Select a channel</h3>
          <p>Pick a text channel from the sidebar to start chatting.</p>
        </div>
      </div>
      <div class="member-list" id="member-list"></div>
    </div>

    <!-- DISCOVER VIEW -->
    <div class="view" id="view-discover">
      <div class="discover-scroll">
        <div class="disc-hero">
          <h2>üß≠ Discover Bastions</h2>
          <p>Find communities that match your interests</p>
          <div class="disc-search">
            <span class="si">üîç</span>
            <input type="text" placeholder="Search public bastions‚Ä¶" id="disc-search-input" oninput="filterDiscover(this.value)">
          </div>
          <div class="disc-tabs">
            <button class="disc-tab active" onclick="setDiscoverTab('all',this)">All</button>
            <button class="disc-tab" onclick="setDiscoverTab('gaming',this)">Gaming</button>
            <button class="disc-tab" onclick="setDiscoverTab('art',this)">Art</button>
            <button class="disc-tab" onclick="setDiscoverTab('tech',this)">Tech</button>
            <button class="disc-tab" onclick="setDiscoverTab('social',this)">Social</button>
          </div>
        </div>
        <div class="bastion-grid" id="discover-grid"></div>
      </div>
    </div>

    <!-- ATELIER VIEW -->
    <div class="view" id="view-atelier">
      <div class="atelier-scroll">
        <div class="atelier-top">
          <div class="atelier-bal">
            <img src="Onyx.png" onerror="this.style.display='none'">
            <div>
              <h3>Your Onyx Balance</h3>
              <div class="amt" id="atelier-balance">0</div>
            </div>
          </div>
          <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
            <span>Daily Reward</span>
            <strong>+50 Onyx</strong>
          </div>
        </div>
        <div class="atelier-section-title">‚ú® Radiance ‚Äî Stand Out</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(7,200)">
            <div class="rad-icon">üåü</div>
            <div class="rad-dur">7 Days</div>
            <div class="rad-feats">Profile glow ¬∑ Custom banner</div>
            <div class="rad-price">200 <span>Onyx</span></div>
          </div>
          <div class="rad-card bv" onclick="buyRadiance(30,600)">
            <div class="best-badge">BEST VALUE</div>
            <div class="rad-icon">‚≠ê</div>
            <div class="rad-dur">30 Days</div>
            <div class="rad-feats">All 7-day perks + animated badge</div>
            <div class="rad-price">600 <span>Onyx</span></div>
          </div>
          <div class="rad-card" onclick="buyRadiance(90,1500)">
            <div class="rad-icon">üí´</div>
            <div class="rad-dur">90 Days</div>
            <div class="rad-feats">All perks + exclusive Radiance role</div>
            <div class="rad-price">1500 <span>Onyx</span></div>
          </div>
        </div>
        <div class="atelier-section-title">üõí Onyx Bundles</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:13px;margin-bottom:28px;">
          <div class="rad-card" onclick="toast('Opening purchase flow‚Ä¶','info')">
            <div class="rad-icon">üí∞</div><div class="rad-dur">500 Onyx</div>
            <div class="rad-price">$4.99 <span>USD</span></div>
          </div>
          <div class="rad-card" onclick="toast('Opening purchase flow‚Ä¶','info')">
            <div class="rad-icon">üí∞</div><div class="rad-dur">1200 Onyx</div>
            <div class="rad-price">$9.99 <span>USD</span></div>
          </div>
          <div class="rad-card bv" onclick="toast('Opening purchase flow‚Ä¶','info')">
            <div class="best-badge">BEST VALUE</div>
            <div class="rad-icon">üí∞</div><div class="rad-dur">3000 Onyx</div>
            <div class="rad-price">$19.99 <span>USD</span></div>
          </div>
          <div class="rad-card" onclick="toast('Opening purchase flow‚Ä¶','info')">
            <div class="rad-icon">üí∞</div><div class="rad-dur">7000 Onyx</div>
            <div class="rad-price">$39.99 <span>USD</span></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div class="view" id="view-profile">
      <div class="profile-wrap">
        <div class="profile-nav" id="profile-nav"></div>
        <div class="profile-main" id="profile-main"></div>
      </div>
    </div>

    <!-- BASTION SETTINGS VIEW -->
    <div class="view" id="view-bsettings">
      <div class="bsettings-wrap">
        <div class="bsettings-nav" id="bsettings-nav"></div>
        <div class="bsettings-main" id="bsettings-main"></div>
      </div>
    </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     MODALS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- CREATE BASTION -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">‚ú® Create a Bastion</div>
      <div class="modal-sub">Start your own community</div>
      <div style="display:flex;gap:14px;margin-bottom:14px;">
        <div id="cb-icon-preview" style="width:64px;height:64px;border-radius:16px;background:var(--panel2);border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:28px;cursor:pointer;flex-shrink:0;overflow:hidden;" onclick="document.getElementById('cb-icon-upload').click()">üè∞</div>
        <div style="flex:1;">
          <input id="cb-icon-upload" type="file" accept="image/*" style="display:none;" onchange="previewCBIcon(event)">
          <input class="modal-input" id="cb-name" placeholder="Bastion name" maxlength="40">
          <input class="modal-input" id="cb-desc" placeholder="Short description (optional)" maxlength="120">
        </div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Icon Emoji</div>
      <div class="emoji-picker-wrap" id="cb-emoji-pick" style="margin-bottom:14px;">
        <span style="font-size:12px;color:var(--muted-light);">Or pick an emoji:</span>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;">
          <span id="cb-selected-emoji" style="font-size:22px;padding:4px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:8px;cursor:pointer;">üè∞</span>
          <button class="btn-g" style="font-size:12px;padding:5px 10px;" onclick="pickCBEmoji()">Change Emoji</button>
        </div>
      </div>
      <div style="font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Visibility</div>
      <div class="vis-toggle">
        <div class="vis-opt active" id="vis-public" onclick="setCBVis('public')">
          <div style="font-size:22px;">üåç</div>
          <div style="font-size:13px;font-weight:700;">Public</div>
          <div style="font-size:11px;color:var(--muted-light);">Anyone can join</div>
        </div>
        <div class="vis-opt" id="vis-private" onclick="setCBVis('private')">
          <div style="font-size:22px;">üîí</div>
          <div style="font-size:13px;font-weight:700;">Private</div>
          <div style="font-size:11px;color:var(--muted-light);">Invite only</div>
        </div>
      </div>
      <div class="modal-error" id="cb-error"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-a" onclick="createBastion()">Create Bastion ‚ú®</button>
      </div>
    </div>
  </div>
</div>

<!-- NEW DM -->
<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">üí¨ New Message</div>
      <div class="modal-sub">Find a user to message</div>
      <input class="modal-input" id="dm-target" placeholder="Username‚Ä¶" onkeydown="if(event.key==='Enter')openDMChat(document.getElementById('dm-target').value.trim())">
      <div class="modal-error" id="dm-error"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-a" onclick="openDMChat(document.getElementById('dm-target').value.trim())">Open Chat</button>
      </div>
    </div>
  </div>
</div>

<!-- ADD FRIEND -->
<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">üë• Add Friend</div>
      <div class="modal-sub">Send a friend request by username</div>
      <input class="modal-input" id="friend-target" placeholder="Username‚Ä¶" onkeydown="if(event.key==='Enter')sendFriendRequest()">
      <div class="modal-error" id="friend-error"></div>
      <div class="modal-success" id="friend-success"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-add-friend')">Close</button>
        <button class="btn-a" onclick="sendFriendRequest()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<!-- JOIN BASTION -->
<div class="modal-overlay" id="modal-join-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">üè∞ Join Bastion</div>
      <div class="modal-sub">Enter an invite code or bastion name</div>
      <input class="modal-input" id="join-code" placeholder="Invite code or name‚Ä¶">
      <div class="modal-error" id="join-error"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-join-bastion')">Cancel</button>
        <button class="btn-a" onclick="joinBastionByCode()">Join</button>
      </div>
    </div>
  </div>
</div>

<!-- USER PROFILE -->
<div class="modal-overlay" id="modal-user">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" id="user-modal-body" style="padding-top:0;"></div>
  </div>
</div>

<!-- FORWARD MESSAGE -->
<div class="modal-overlay" id="modal-forward">
  <div class="modal tall">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">‚Ü™ Forward Message</div>
      <div class="modal-sub">Choose a DM or channel to forward to</div>
      <div id="forward-targets" style="display:flex;flex-direction:column;gap:6px;max-height:300px;overflow-y:auto;"></div>
      <div class="modal-actions" style="margin-top:14px;">
        <button class="btn-g" onclick="closeModal('modal-forward')">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- ROLE EDITOR -->
<div class="modal-overlay" id="modal-role-editor">
  <div class="modal wide tall">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="re-title">Edit Role</div>
      <div style="display:flex;gap:12px;margin-bottom:16px;">
        <div style="flex:1;">
          <div class="settings-title">Role Name</div>
          <input class="field-input" id="re-name" placeholder="Role name" style="margin-bottom:10px;">
        </div>
        <div>
          <div class="settings-title">Color</div>
          <div class="color-swatches" id="re-colors"></div>
        </div>
      </div>
      <div class="settings-title">Permissions</div>
      <div id="re-perms" style="max-height:300px;overflow-y:auto;"></div>
      <div class="modal-actions" style="margin-top:16px;">
        <button class="btn-g" onclick="closeModal('modal-role-editor')">Cancel</button>
        <button class="btn-d" id="re-delete-btn" onclick="deleteCurrentRole()">Delete Role</button>
        <button class="btn-a" onclick="saveRole()">Save Role</button>
      </div>
    </div>
  </div>
</div>

<!-- ASSIGN ROLE -->
<div class="modal-overlay" id="modal-assign-role">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="ar-title">Assign Roles</div>
      <div id="ar-roles" style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;max-height:300px;overflow-y:auto;"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-assign-role')">Close</button>
        <button class="btn-a" onclick="saveAssignedRoles()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- LEAVE BASTION CONFIRM -->
<div class="modal-overlay" id="modal-leave-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body" style="text-align:center;">
      <div style="font-size:40px;margin-bottom:12px;">üö™</div>
      <div class="modal-title" id="leave-title">Leave Bastion?</div>
      <div class="modal-sub" id="leave-sub">You'll need an invite to rejoin.</div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('modal-leave-bastion')">Cancel</button>
        <button class="btn-d" id="leave-confirm-btn">Leave</button>
      </div>
    </div>
  </div>
</div>



<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GLOBAL STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let CU = null;
let curBastion = null;
let curChannel = null;
let curDM = null;
let voiceConnected = false;
let voiceChannel = null;
let voiceParticipants = [];
let isMuted = false;
let isDeafened = false;
let notifPanelOpen = false;
let notifSettings = {messages:true,friendRequests:true,bastionActivity:true,mentions:true,sounds:true};
let replyingTo = null;
let forwardMsgText = '';
let activeEmojiTarget = null;
let currentRoleEditing = null;
let assignRoleBastion = null;
let assignRoleMemberName = null;
let cbVisibility = 'public';
let cbSelectedEmoji = 'üè∞';
let cbIconData = null;
let discoverData = [];
let discoverTab = 'all';
let adminAuthed = false;
let adminTab = 'dashboard';
let quizIdx = 0;
let quizCorrect = 0;
let quizAnswers = [];
let activeReportData = null;
const SUPER_ADMIN = 'staw';
const ROLE_COLORS = ['#fbbf24','#f87171','#34d399','#60a5fa','#a78bfa','#f472b6','#fb923c','#22d3ee'];
const PERMISSIONS = [
  ['send_messages','Send Messages'],['read_history','Read History'],
  ['add_reactions','Add Reactions'],['attach_files','Attach Files'],
  ['mention_everyone','Mention Everyone'],['manage_messages','Manage Messages'],
  ['kick_members','Kick Members'],['ban_members','Ban Members'],
  ['manage_channels','Manage Channels'],['manage_roles','Manage Roles'],
  ['administrator','Administrator'],
];
const EMOJI_CATEGORIES = {
  'üòä Smileys':['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','ü§£','üòÇ','üôÇ','üòä','üòá','ü•∞','üòç','ü§©','üòò','üòó','üòö','üòô','ü•≤','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü•¥','üò¥','ü§§','üò™','üòµ','ü§Ø','ü§†','ü•≥','üòé','ü§ì','üßê'],
  'üëç Gestures':['üëç','üëé','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëã','ü§ö','üñêÔ∏è','‚úã','üññ','üí™','ü¶æ','üôå','üëê','ü§≤','ü´∂','üôè','‚úçÔ∏è','üíÖ'],
  '‚ù§Ô∏è Hearts':['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚ú®','üí´','‚≠ê','üåü','üí•','üî•','üéâ','üéä','üéà'],
  'üê∂ Animals':['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üê®','üêØ','ü¶Å','üêÆ','üê∑','üê∏','üêµ','üêî','üêß','üê¶','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','ü¶Ñ','üêù','ü™≤','ü¶ã','üêõ','üêå'],
  'üçï Food':['üçï','üçî','üçü','üå≠','üçø','üßÇ','ü•ì','ü•ö','üç≥','üßá','ü•û','üßà','üçû','ü•ê','ü•ñ','ü´ì','ü•®','üßÄ','ü•ó','ü•ô','üåÆ','üåØ','ü´î','ü•´','üçù','üçú','üç≤','üçõ','üç£','üç±'],
  '‚ö° Symbols':['‚ö°','üî•','‚ùÑÔ∏è','üåä','üå™Ô∏è','üåà','‚≠ê','üí´','‚ú®','üéØ','üèÜ','ü•á','üéÆ','üé≤','üÉè','üé≠','üé®','üéµ','üé∂','üé∏','üéπ','üé§','üéß','üì±','üíª','üñ•Ô∏è','‚å®Ô∏è','üñ±Ô∏è','üì∑','üé¨'],
};
const QUIZ_QUESTIONS = [
  {q:"What does 'NSFW' stand for?",a:"Not Safe For Work",opts:["Not Safe For Work","New Software For Web","No Spam For Winners","None So Far Witnessed"]},
  {q:"Which of these is considered harassment?",a:"Repeatedly messaging someone after they ask you to stop",opts:["Sending a friend request","Sharing a meme","Repeatedly messaging someone after they ask you to stop","Joining a public Bastion"]},
  {q:"What should you do if you see harmful content?",a:"Report it using the report button",opts:["Ignore it","Share it with friends","Report it using the report button","Delete your account"]},
  {q:"Fortized's minimum age requirement is:",a:"13 years old",opts:["10 years old","13 years old","16 years old","18 years old"]},
  {q:"How should you handle disagreements with other users?",a:"Communicate respectfully or use block/report",opts:["Threaten them","Spam their DMs","Communicate respectfully or use block/report","Share their personal info"]},
];
const REPORT_REASONS = ['Harassment','Hate Speech','NSFW / Explicit Content','Spam or Scam','Threats or Violence','Self-Harm or Suicide','Illegal Content','Other'];
const AGE_TIERS = {CHILD:'child',TEEN:'teen',ADULT:'adult'};

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveLocal() {
  if (!CU?.username) return;
  localStorage.setItem('ftz_current', CU.username);
  localStorage.setItem('fortized_current_user', CU.username);
  localStorage.setItem('ftz_user_' + CU.username, JSON.stringify(CU));
}
async function saveUser() {
  saveLocal();
  try { await FortizedSocial.saveUserObject(CU); } catch {}
}
async function refreshCU() {
  if (!CU?.username) return;
  try {
    const fresh = await Promise.race([
      FortizedSocial.getUserByName(CU.username),
      new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),5000))
    ]);
    if (fresh?.username) { CU = fresh; saveLocal(); }
  } catch {}
}
function escapeHTML(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
function parseMD(s) {
  return s
    .replace(/\*\*(.+?)\*\*/g,'<strong>$1</strong>')
    .replace(/\*(.+?)\*/g,'<em>$1</em>')
    .replace(/`(.+?)`/g,'<code style="background:rgba(255,255,255,.08);padding:1px 5px;border-radius:4px;font-family:monospace;">$1</code>')
    .replace(/~~(.+?)~~/g,'<s>$1</s>')
    .replace(/\n/g,'<br>');
}
function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 200) + 'px';
}
function scrollBottom(id) {
  const el = document.getElementById(id);
  if (el) el.scrollTop = el.scrollHeight;
}
function formatTimeAgo(iso) {
  if (!iso) return '';
  const d = new Date(iso), now = new Date();
  const diff = (now - d) / 1000;
  if (diff < 60) return 'just now';
  if (diff < 3600) return Math.floor(diff/60) + 'm ago';
  if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
  return Math.floor(diff/86400) + 'd ago';
}
function handleSearch(q) {}
function attachFile() { toast('üìé File attachments coming soon!','info'); }
function isSuperAdmin() { return CU?.username === SUPER_ADMIN; }
function isAdmin() {
  const admins = JSON.parse(localStorage.getItem('ftz_admins')||'["staw"]');
  return CU?.username && admins.includes(CU.username);
}
function logAudit(action, target, note='') {
  const log = JSON.parse(localStorage.getItem('ftz_audit_log')||'[]');
  log.unshift({action,target,note,by:CU?.username,at:new Date().toISOString()});
  localStorage.setItem('ftz_audit_log', JSON.stringify(log.slice(0,500)));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toast(msg, type='info') {
  const container = document.getElementById('toast-container') || (() => {
    const c = document.createElement('div');
    c.id = 'toast-container';
    c.style.cssText = 'position:fixed;bottom:80px;right:20px;z-index:9999;display:flex;flex-direction:column;gap:8px;';
    document.body.appendChild(c);
    return c;
  })();
  const el = document.createElement('div');
  const colors = {success:'var(--green)',error:'var(--red)',info:'var(--accent-mid)'};
  el.style.cssText = `background:var(--panel2);border:1px solid ${colors[type]||colors.info};border-radius:12px;padding:10px 16px;font-size:13.5px;color:var(--text);max-width:320px;box-shadow:0 4px 24px rgba(0,0,0,.4);animation:slideIn .2s ease;`;
  el.textContent = msg;
  container.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VIEW MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showView(v) {
  document.querySelectorAll('.view').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.rail-btn').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(el=>el.classList.remove('active'));
  const vEl = document.getElementById('view-'+v);
  if (vEl) vEl.classList.add('active');
  const rBtn = document.getElementById('rb-'+v);
  if (rBtn) rBtn.classList.add('active');
  updateTopbar(v);
  updateSidebar(v);
}

function updateTopbar(v) {
  const title = document.getElementById('topbar-title');
  const desc = document.getElementById('tb-desc');
  const sep = document.getElementById('tb-sep');
  if (!title) return;
  if (sep) sep.style.display = 'none';
  if (desc) desc.textContent = '';
  const labels = {home:'üè† Home',dms:'üí¨ Messages',friends:'üë• Friends',discover:'üß≠ Discover',atelier:'üíé Atelier',profile:'‚öôÔ∏è Settings',bsettings:'‚öôÔ∏è Bastion Settings'};
  if (labels[v]) title.textContent = labels[v];
  else if (v==='bastion' && curBastion!==null) {
    const b = CU.bastions?.[curBastion];
    title.innerHTML = `<span>${b?.emblem||'üè∞'}</span> ${escapeHTML(b?.name||'')}`;
    if (sep) sep.style.display = '';
    if (desc) desc.textContent = 'Select a channel';
  }
  updateOnyxDisplay();
}

function updateSidebar(v) {
  const scroll = document.getElementById('sidebar-scroll');
  const hdrTitle = document.getElementById('sidebar-title');
  const hdrActs = document.getElementById('sidebar-hdr-actions');
  if (!scroll) return;
  if (hdrActs) hdrActs.innerHTML = '';
  scroll.innerHTML = '';

  if (v==='home') {
    if (hdrTitle) hdrTitle.textContent = 'üè† Home';
    const bList = (CU?.bastions||[]).map((b,i)=>`<div class="ch-item" onclick="openBastion(${i})"><span style="font-size:16px;">${b.emblem||'üè∞'}</span> ${escapeHTML(b.name)}</div>`).join('');
    scroll.innerHTML = `
      <div class="sec-label">Quick Nav</div>
      <div class="ch-item" onclick="showView('dms')">üí¨ Messages</div>
      <div class="ch-item" onclick="showView('friends')">üë• Friends</div>
      <div class="ch-item" onclick="showView('discover')">üß≠ Discover</div>
      <div class="ch-item" onclick="showView('atelier')">üíé Atelier</div>
      ${bList?`<div class="sec-label">Your Bastions</div>`+bList:''}`;
    renderHomePanel();
  } else if (v==='dms') {
    if (hdrTitle) hdrTitle.textContent = 'üí¨ Messages';
    if (hdrActs) hdrActs.innerHTML = `<button onclick="openModal('modal-new-dm')" style="background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;width:28px;height:28px;border-radius:9px;display:flex;align-items:center;justify-content:center;" title="New DM">‚úèÔ∏è</button>`;
    renderDMSidebar(scroll);
  } else if (v==='friends') {
    if (hdrTitle) hdrTitle.textContent = 'üë• Friends';
    if (hdrActs) hdrActs.innerHTML = `<button onclick="openModal('modal-add-friend')" style="background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;width:28px;height:28px;border-radius:9px;display:flex;align-items:center;justify-content:center;" title="Add Friend">‚ûï</button>`;
    scroll.innerHTML = `<div class="ch-item active">üë• All Friends</div><div class="ch-item" onclick="openModal('modal-add-friend')">‚ûï Add Friend</div>`;
    renderFriendsList();
  } else if (v==='discover') {
    if (hdrTitle) hdrTitle.textContent = 'üß≠ Discover';
    scroll.innerHTML = `<div class="ch-item active">üåç Public Bastions</div><div class="ch-item" onclick="openModal('modal-join-bastion')">üîó Join by Code</div><div class="ch-item" onclick="openModal('modal-create-bastion')">‚ú® Create Bastion</div>`;
    loadDiscover();
  } else if (v==='atelier') {
    if (hdrTitle) hdrTitle.textContent = 'üíé Atelier';
    const ab = document.getElementById('atelier-balance');
    if (ab) ab.textContent = CU?.onyx||0;
    const db = document.getElementById('daily-btn');
    if (db) { const today=new Date().toDateString(); if(CU?.lastDaily===today)db.classList.add('claimed'); else db.classList.remove('claimed'); }
  } else if (v==='profile') {
    if (hdrTitle) hdrTitle.textContent = '‚öôÔ∏è Settings';
    buildProfileNav(scroll);
    buildProfileView('myprofile');
  } else if (v==='bastion') {
    renderBastionSidebar(scroll);
  } else if (v==='bsettings') {
    if (hdrTitle) hdrTitle.textContent = '‚öôÔ∏è Bastion Settings';
    renderBSettingsNav();
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USERBAR & ONYX
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUserbar() {
  if (!CU) return;
  const ua = document.getElementById('ua');
  const uaName = document.getElementById('ua-name');
  const uaTag = document.getElementById('ua-tag');
  if (ua) ua.innerHTML = buildAvatarHTML(CU.pfp, CU.displayName||CU.username, 34);
  if (uaName) uaName.textContent = CU.displayName||CU.username;
  if (uaTag) uaTag.textContent = '@'+CU.username;
  updateOnyxDisplay();
}
function updateOnyxDisplay() {
  ['onyx-val','atelier-balance'].forEach(id=>{const el=document.getElementById(id);if(el)el.textContent=CU?.onyx||0;});
}
function buildAvatarHTML(pfp, name, size) {
  const initial = (name||'?')[0].toUpperCase();
  const s = `width:${size}px;height:${size}px;border-radius:50%;object-fit:cover;`;
  if (pfp) return `<img src="${pfp}" style="${s}" onerror="this.outerHTML='<span style=\\'font-size:${Math.floor(size/2.2)}px;\\'>${initial}</span>'">`;
  return `<span style="font-size:${Math.floor(size/2.2)}px;">${initial}</span>`;
}
function renderRailBastions() {
  const c = document.getElementById('rail-bastions');
  if (!c) return;
  c.innerHTML = (CU?.bastions||[]).map((b,i)=>`
    <div class="rail-bastion ${curBastion===i?'active':''}" id="rl-b-${i}" onclick="openBastion(${i})" data-tip="${escapeHTML(b.name)}" style="margin-bottom:4px;">
      ${b.icon?`<img src="${b.icon}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`:(b.emblem||'üè∞')}
    </div>`).join('');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// HOME PANEL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHomePanel() {
  const qn = document.getElementById('quick-nav');
  if (qn) qn.innerHTML = [
    {icon:'üí¨',label:'Messages',sub:'Chat with friends',act:"showView('dms')",col:'rgba(96,165,250,.12)'},
    {icon:'üß≠',label:'Discover',sub:'Find communities',act:"showView('discover')",col:'rgba(52,211,153,.12)'},
    {icon:'üíé',label:'Atelier',sub:'Onyx & Radiance',act:"showView('atelier')",col:'rgba(255,249,62,.12)'},
    {icon:'‚öôÔ∏è',label:'Settings',sub:'Profile & prefs',act:"showView('profile')",col:'rgba(167,139,250,.12)'},
  ].map(t=>`<div class="qn-tile" onclick="${t.act}"><div class="qn-icon" style="background:${t.col}">${t.icon}</div><div class="qn-text"><h4>${t.label}</h4><p>${t.sub}</p></div></div>`).join('');

  const af = document.getElementById('activity-feed');
  if (af) af.innerHTML = [
    {icon:'üè∞',text:`Welcome back, <strong>${escapeHTML(CU?.displayName||CU?.username||'')}</strong>!`},
    {icon:'üë•',text:`<strong>${(CU?.friends||[]).length}</strong> friend(s) connected`},
    {icon:'üí∞',text:`Onyx balance: <strong>${CU?.onyx||0}</strong>`},
  ].map(i=>`<div class="activity-item"><div class="act-icon">${i.icon}</div><div class="act-text"><p>${i.text}</p></div></div>`).join('');

  const rpB = document.getElementById('rp-bastions');
  if (rpB) rpB.innerHTML = (CU?.bastions||[]).slice(0,6).map((b,i)=>`<div class="rp-notif" style="cursor:pointer;" onclick="openBastion(${i})"><div class="rn-icon">${b.emblem||'üè∞'}</div><div class="rn-text"><p>${escapeHTML(b.name)}</p><div class="rn-time">${(b.channels||[]).length} channels</div></div></div>`).join('')||'<div style="padding:8px;font-size:12.5px;color:var(--muted);">No bastions yet</div>';
  const rpF = document.getElementById('rp-friends');
  if (rpF) rpF.innerHTML = (CU?.friends||[]).slice(0,6).map(f=>`<div class="rp-notif" style="cursor:pointer;" onclick="openDMView('${escapeHTML(f)}')"><div class="rn-icon" style="width:30px;height:30px;font-size:13px;">${buildAvatarHTML(null,f,30)}</div><div class="rn-text"><p style="font-weight:600;">${escapeHTML(f)}</p></div></div>`).join('')||'<div style="padding:8px;font-size:12.5px;color:var(--muted);">No friends yet</div>';

  const mt = document.getElementById('marquee-track');
  if (mt && !mt.children.length) {
    const items=['üè∞ Bastions','üí¨ Real-Time Chat','üéô Voice Channels','üõ°Ô∏è Roles','‚ú® Custom Emojis','üíé Onyx','üåü Radiance','üë• Friends','üîî Notifications','ü§ñ AutoMod'];
    mt.innerHTML=[...items,...items].map(i=>`<div class="marquee-item"><span class="mi-label">${i}</span></div>`).join('');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DM SIDEBAR & CHAT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDMSidebar(scroll) {
  const friends = CU?.friends||[];
  if (!friends.length) { scroll.innerHTML='<div style="padding:18px 14px;font-size:13px;color:var(--muted);">No DMs yet. Add friends to start!</div>'; return; }
  scroll.innerHTML = '<div class="sec-label">Direct Messages</div>' + friends.map(f=>`
    <div class="friend-item" id="dm-fi-${f}" onclick="openDMView('${escapeHTML(f)}')">
      <div class="fa" style="width:32px;height:32px;font-size:13px;overflow:hidden;flex-shrink:0;">${buildAvatarHTML(null,f,32)}</div>
      <div class="fi-info"><div class="fi-name">${escapeHTML(f)}</div></div>
    </div>`).join('');
}

let _dmListener = null;
function openDMView(username) {
  if (!username) return;
  curDM = username;
  closeModal('modal-new-dm');
  showView('dms');
  const topTitle = document.getElementById('topbar-title');
  if (topTitle) topTitle.textContent = 'üí¨ '+username;
  document.querySelectorAll('.friend-item').forEach(fi=>fi.classList.remove('active'));
  const fi = document.getElementById('dm-fi-'+username);
  if (fi) fi.classList.add('active');

  const wrap = document.getElementById('dm-chat-wrap');
  if (!wrap) return;
  wrap.innerHTML = `
    <div class="chat-wrap">
      <div class="chat-msgs" id="dm-msgs">
        <div class="chat-welcome">
          <div class="w-av">${buildAvatarHTML(null,username,60)}</div>
          <h3>${escapeHTML(username)}</h3>
          <p>Beginning of your conversation with <strong>${escapeHTML(username)}</strong>.</p>
        </div>
      </div>
      <div class="reply-bar" id="dm-reply-bar">
        <span class="reply-bar-text">Replying to <strong id="dm-reply-name"></strong></span>
        <button onclick="cancelReply('dm')">‚úï</button>
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button id="emoji-btn-dm" onclick="toggleEmojiPicker('dm-input')" title="Emoji">üòä</button>
          </div>
          <textarea id="dm-input" placeholder="Message ${escapeHTML(username)}‚Ä¶" rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendDM();}"
            oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendDM()">‚û§</button>
        </div>
      </div>
    </div>`;
  loadDMMessages(username);
}
function openDMChat(u) { openDMView(u); }

async function loadDMMessages(username) {
  const msgsEl = document.getElementById('dm-msgs');
  if (!msgsEl) return;
  if (_dmListener) { try{_dmListener();}catch{} _dmListener=null; }
  try {
    const msgs = await FortizedSocial.getDMMessages(CU.username, username);
    renderMessages(msgsEl, msgs||[], 'dm');
    scrollBottom('dm-msgs');
    _dmListener = FortizedSocial.listenDM(CU.username, username, msg => {
      if (curDM!==username) return;
      const el=document.getElementById('dm-msgs');
      if (el) { appendMessage(el,msg,'dm',null); scrollBottom('dm-msgs'); }
    });
  } catch(e){console.warn('DM load',e);}
}

async function sendDM() {
  const inp=document.getElementById('dm-input');
  if (!inp||!curDM) return;
  const text=inp.value.trim();
  if (!text) return;
  inp.value=''; inp.style.height='auto';
  const rep=replyingTo;
  cancelReply('dm');
  try { await FortizedSocial.sendDMMessage(CU.username, curDM, text); }
  catch { toast('Failed to send','error'); }
}

// New DM modal
async function startNewDM() {
  const inp=document.getElementById('new-dm-target');
  const err=document.getElementById('new-dm-error');
  if (!inp) return;
  const username=inp.value.trim();
  if (!username){if(err)err.textContent='Enter a username';return;}
  const u=await FortizedSocial.getUserByName(username).catch(()=>null);
  if (!u){if(err)err.textContent='User not found';return;}
  openDMView(username);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASTION OPEN & SIDEBAR
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBastion(idx) {
  if (idx<0||!CU.bastions?.[idx]) return;
  curBastion=idx; curChannel=null;
  document.querySelectorAll('.rail-bastion').forEach(el=>el.classList.remove('active'));
  const rb=document.getElementById('rl-b-'+idx);
  if (rb) rb.classList.add('active');
  showView('bastion');
  const wrap=document.getElementById('bastion-chat-wrap');
  if (wrap) wrap.innerHTML=`<div class="empty-state"><div class="ei">üè∞</div><h3>Pick a channel</h3><p>Select a text or voice channel from the sidebar.</p></div>`;
  document.getElementById('member-list').innerHTML='';
}

function renderBastionSidebar(scroll) {
  const b=CU.bastions?.[curBastion];
  if (!b||!scroll) return;
  const hdrTitle=document.getElementById('sidebar-title');
  const hdrActs=document.getElementById('sidebar-hdr-actions');
  if (hdrTitle) hdrTitle.textContent=(b.emblem||'üè∞')+' '+b.name;
  if (hdrActs) hdrActs.innerHTML=`
    <button onclick="openBastionSettings()" title="Settings" style="background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;width:28px;height:28px;border-radius:9px;display:flex;align-items:center;justify-content:center;">‚öôÔ∏è</button>
    <button onclick="openModal('modal-leave-bastion')" title="Leave" style="background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;width:28px;height:28px;border-radius:9px;display:flex;align-items:center;justify-content:center;">üö™</button>`;

  const lv=document.getElementById('leave-title');
  const ls=document.getElementById('leave-sub');
  const lb=document.getElementById('leave-confirm-btn');
  if (lv) lv.textContent='Leave '+b.name+'?';
  if (ls) ls.textContent=b.owner===CU.username?'You are the owner. Leaving may delete this bastion.':'You\'ll need an invite to rejoin.';
  if (lb) lb.onclick=()=>leaveBastion(curBastion);

  const boostLv=b.boostLevel||0;
  let html=`<div class="boost-bar" onclick="openBastionSettings('boost')">‚ö° Level <span class="bl">${boostLv}</span> Bastion<button style="background:none;border:none;color:var(--accent);font-size:11px;cursor:pointer;margin-left:auto;">Boost ‚Üí</button></div>`;
  const chs=b.channels||[];
  const isOwner=b.owner===CU.username;

  const textChs=chs.filter(c=>c.type!=='voice');
  const voiceChs=chs.filter(c=>c.type==='voice');

  if (textChs.length||isOwner) {
    html+=`<div class="cat-row">üìù TEXT CHANNELS ${isOwner?`<button onclick="addChannel(${curBastion},'text')">+</button>`:''}  </div>`;
    chs.forEach((ch,i)=>{
      if (ch.type==='voice') return;
      const tier=getAgeTier(CU?.dateOfBirth);
      const blocked=ch.nsfw&&tier==='child';
      const nsfwTag=ch.nsfw?`<span style="font-size:9px;background:rgba(248,113,113,.15);color:var(--red);padding:1px 5px;border-radius:4px;flex-shrink:0;">NSFW</span>`:'';
      html+=`<div class="ch-item ${curChannel===i?'active':''}" id="ch-sb-${i}" ${blocked?'style="opacity:.4;pointer-events:none;"':''}onclick="selectChannel(${i})">
        <span>#</span><span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${escapeHTML(ch.name)}</span>${nsfwTag}${blocked?'<span title="Age blocked">üîí</span>':''}
      </div>`;
    });
  }
  if (voiceChs.length||isOwner) {
    html+=`<div class="cat-row">üéô VOICE ${isOwner?`<button onclick="addChannel(${curBastion},'voice')">+</button>`:''}  </div>`;
    chs.forEach((ch,i)=>{
      if (ch.type!=='voice') return;
      const live=voiceConnected&&voiceChannel===i;
      html+=`<div class="voice-ch-item ${live?'active-vc':''}" onclick="selectChannel(${i})"><span>üéô</span><span>${escapeHTML(ch.name)}</span>${live?'<span style="font-size:9px;color:var(--green);margin-left:auto;">‚óè LIVE</span>':''}</div>`;
    });
  }

  const vcb=document.getElementById('voice-connected-bar');
  if (voiceConnected&&vcb) {
    vcb.classList.add('show');
    const vcn=document.getElementById('vcb-channel-name');
    const vcp=document.getElementById('vcb-participants');
    if (vcn) vcn.textContent='üéô '+(chs[voiceChannel]?.name||'Voice');
    if (vcp) vcp.innerHTML=voiceParticipants.map(p=>`<div class="vcb-part">${buildAvatarHTML(p.pfp,p.name,18)} ${escapeHTML(p.name)}</div>`).join('');
  } else if (vcb) vcb.classList.remove('show');
  scroll.innerHTML=html;
}

async function leaveBastion(idx) {
  const b=CU.bastions?.[idx];
  if (!b) return;
  closeModal('modal-leave-bastion');
  try{await FortizedSocial.removeBastionMember(b.globalId||b.name,CU.username);}catch{}
  CU.bastions.splice(idx,1);
  await saveUser();
  curBastion=null; curChannel=null;
  renderRailBastions();
  showView('home');
  toast('Left '+b.name,'info');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANNEL SELECTION & NSFW GATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function selectChannel(idx) {
  const b=CU.bastions?.[curBastion];
  const ch=b?.channels?.[idx];
  if (!ch) return;
  curChannel=idx;
  document.querySelectorAll('.ch-item').forEach(el=>el.classList.remove('active'));
  const el=document.getElementById('ch-sb-'+idx);
  if (el) el.classList.add('active');

  if (ch.type==='voice') { joinVoice(idx); return; }

  const wrap=document.getElementById('bastion-chat-wrap');
  if (!wrap) return;
  const access=checkNSFWAccess(ch);
  if (access===false) {
    wrap.innerHTML=`<div class="empty-state" style="margin:20px;background:rgba(248,113,113,.04);border:1px solid rgba(248,113,113,.2);border-radius:18px;padding:40px;"><div class="ei" style="font-size:48px;">üîí</div><h3 style="color:var(--red);">Age-Restricted Channel</h3><p>This channel is restricted for your age group.</p></div>`;
    return;
  }
  if (access===null) {
    wrap.innerHTML=`<div style="flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:40px;text-align:center;">
      <div style="font-size:56px;margin-bottom:18px;filter:blur(3px);">üîû</div>
      <h3 style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:10px;">Sensitive Content</h3>
      <p style="font-size:13.5px;color:var(--muted-light);max-width:340px;line-height:1.65;margin-bottom:20px;">
        <strong>#${escapeHTML(ch.name)}</strong> is marked as containing sensitive content. By proceeding, you confirm you understand this.
      </p>
      <div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:14px;padding:14px 18px;max-width:340px;font-size:12.5px;color:var(--red);margin-bottom:20px;">
        ‚ö†Ô∏è This action is logged for platform safety and compliance.
      </div>
      <button class="btn-d" onclick="proceedToNSFWChannel(${idx})" style="padding:12px 28px;font-size:14px;">View Sensitive Content</button>
      <button class="btn-g" onclick="openBastion(curBastion)" style="margin-top:10px;font-size:13px;">‚Üê Go Back</button>
    </div>`;
    return;
  }
  loadChatChannel(idx);
}

function proceedToNSFWChannel(idx) {
  const logEntry={user:CU.username,action:'nsfw_channel_confirmed',channel:CU.bastions?.[curBastion]?.channels?.[idx]?.name,tier:getAgeTier(CU?.dateOfBirth),timestamp:new Date().toISOString()};
  console.log('[SAFETY LOG]',logEntry);
  const sl=JSON.parse(localStorage.getItem('ftz_safety_log')||'[]');
  sl.push(logEntry);
  localStorage.setItem('ftz_safety_log',JSON.stringify(sl.slice(-200)));
  loadChatChannel(idx);
}

function loadChatChannel(idx) {
  const b=CU.bastions?.[curBastion];
  const ch=b?.channels?.[idx];
  if (!ch) return;
  const wrap=document.getElementById('bastion-chat-wrap');
  if (!wrap) return;
  const nsfwBadge=ch.nsfw?`<span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;background:rgba(248,113,113,.15);color:var(--red);margin-left:6px;">NSFW</span>`:'';
  const sep=document.getElementById('tb-sep');
  const desc=document.getElementById('tb-desc');
  if (sep) sep.style.display='';
  if (desc) desc.textContent='#'+ch.name;
  wrap.innerHTML=`
    <div class="chat-wrap">
      <div class="chat-msgs" id="ch-msgs-${idx}">
        <div class="chat-welcome">
          <div class="w-av" style="font-size:26px;background:var(--panel2);">#</div>
          <h3>#${escapeHTML(ch.name)}${nsfwBadge}</h3>
          <p>${escapeHTML(ch.desc||'Welcome to #'+ch.name+'!')}</p>
        </div>
      </div>
      <div class="reply-bar" id="ch-reply-bar">
        <span class="reply-bar-text">Replying to <strong id="ch-reply-name"></strong></span>
        <button onclick="cancelReply('ch')">‚úï</button>
      </div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-actions">
            <button id="emoji-btn-ch" onclick="toggleEmojiPicker('ch-input')" title="Emoji">üòä</button>
          </div>
          <textarea id="ch-input" placeholder="Message #${escapeHTML(ch.name)}‚Ä¶" rows="1"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendChannelMsg(${idx});}"
            oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendChannelMsg(${idx})">‚û§</button>
        </div>
      </div>
    </div>`;
  loadChannelMessages(idx);
  renderMemberList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANNEL MESSAGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _chListener=null;
async function loadChannelMessages(idx) {
  const b=CU.bastions?.[curBastion];
  const ch=b?.channels?.[idx];
  const msgsEl=document.getElementById('ch-msgs-'+idx);
  if (!ch||!msgsEl) return;
  if (_chListener){try{_chListener();}catch{}_chListener=null;}
  try {
    const msgs=await FortizedSocial.getBastionChannelMessages(b.globalId||b.name,ch.name);
    renderMessages(msgsEl,msgs||[],'ch');
    scrollBottom('ch-msgs-'+idx);
    _chListener=FortizedSocial.listenBastionChannel(b.globalId||b.name,ch.name,msg=>{
      if (curChannel!==idx) return;
      const el=document.getElementById('ch-msgs-'+idx);
      if (el){appendMessage(el,msg,'ch',null);scrollBottom('ch-msgs-'+idx);}
    });
  } catch(e){console.warn('Channel load',e);}
}

async function sendChannelMsg(idx) {
  const inp=document.getElementById('ch-input');
  if (!inp) return;
  const text=inp.value.trim();
  if (!text) return;
  const b=CU.bastions?.[curBastion];
  const ch=b?.channels?.[idx];
  if (!ch) return;
  if (autoModCheck(text,b)) return;
  inp.value=''; inp.style.height='auto';
  cancelReply('ch');
  try { await FortizedSocial.sendBastionChannelMessage(b.globalId||b.name,ch.name,CU.username,text); }
  catch { toast('Failed to send','error'); }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGE RENDERING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderMessages(container, msgs, context) {
  container.querySelectorAll('.msg-row,.date-div').forEach(el=>el.remove());
  if (!msgs.length) return;
  let lastDate=null, lastAuthor=null;
  msgs.forEach(msg=>{
    const d=msg.timestamp?new Date(msg.timestamp).toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'}):'Today';
    if (d!==lastDate) {
      const div=document.createElement('div');
      div.className='date-div'; div.textContent=d;
      container.appendChild(div);
      lastDate=d; lastAuthor=null;
    }
    appendMessage(container,msg,context,lastAuthor);
    lastAuthor=msg.from;
  });
}

function appendMessage(container, msg, context, prevAuthor) {
  const id=msg.id||(msg.from+msg.timestamp);
  if (document.querySelector(`[data-msgid="${CSS.escape(id)}"]`)) return;
  const isFirst=msg.from!==prevAuthor;
  const isOwn=msg.from===CU?.username;
  const time=msg.timestamp?new Date(msg.timestamp).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):(msg.time||'');
  const row=document.createElement('div');
  row.className=`msg-row ${isFirst?'msg-first':'msg-cont'}`;
  row.dataset.msgid=id;
  row.dataset.text=msg.text||'';
  row.dataset.from=msg.from||'';

  const replyHTML=msg.replyTo?`<div class="msg-reply-ref">‚Ü© <strong>${escapeHTML(msg.replyTo.from||'')}</strong>: ${escapeHTML((msg.replyTo.text||'').slice(0,60))}</div>`:'';
  const fwdHTML=msg.forwarded?`<div class="msg-forward-tag">‚Ü™ Forwarded</div>`:'';
  const editTag=msg.edited?`<span class="msg-edited">(edited)</span>`:'';
  const reactHTML=msg.reactions?Object.entries(msg.reactions).map(([emoji,users])=>{
    const arr=Array.isArray(users)?users:Object.values(users);
    return `<span class="r-pill${arr.includes(CU?.username)?' mine':''}" onclick="toggleReaction('${escapeHTML(id)}','${emoji}','${context}')">${emoji} ${arr.length}</span>`;
  }).join(''):'';

  const safeId=escapeHTML(id);
  const safeText=escapeHTML((msg.text||'').slice(0,100).replace(/'/g,' '));
  const safeFrom=escapeHTML(msg.from||'');

  if (isFirst) {
    const avId='av-'+id.replace(/[^a-z0-9]/gi,'-');
    row.innerHTML=`
      <div class="msg-av-wrap"><div class="msg-av-inner" id="${avId}" onclick="viewUserProfile('${safeFrom}')" style="cursor:pointer;">${buildAvatarHTML(null,msg.from,36)}</div></div>
      <div class="msg-content-col">
        ${fwdHTML}${replyHTML}
        <div class="msg-header">
          <span class="msg-author" onclick="viewUserProfile('${safeFrom}')" style="cursor:pointer;">${safeFrom}</span>
          <span class="msg-timestamp">${time}</span>
        </div>
        <div class="msg-text" id="mt-${avId}">${parseMD(escapeHTML(msg.text||''))}${editTag}</div>
        ${reactHTML?`<div class="msg-reactions">${reactHTML}</div>`:''}
      </div>
      ${buildMsgActions(msg,context,id)}`;
    FortizedSocial.getUserByName(msg.from).then(u=>{if(u?.pfp){const el=document.getElementById(avId);if(el)el.innerHTML=buildAvatarHTML(u.pfp,msg.from,36);}}).catch(()=>{});
  } else {
    const textId='mt-c-'+id.replace(/[^a-z0-9]/gi,'-');
    row.innerHTML=`
      <div class="msg-av-wrap"><span class="msg-time-small">${time}</span></div>
      <div class="msg-content-col">
        ${fwdHTML}${replyHTML}
        <div class="msg-text" id="${textId}">${parseMD(escapeHTML(msg.text||''))}${editTag}</div>
        ${reactHTML?`<div class="msg-reactions">${reactHTML}</div>`:''}
      </div>
      ${buildMsgActions(msg,context,id)}`;
  }
  container.appendChild(row);
}

function buildMsgActions(msg, context, id) {
  const isOwn=msg.from===CU?.username;
  const safeId=escapeHTML(id);
  const safeFrom=escapeHTML(msg.from||'');
  const safeText=escapeHTML((msg.text||'').replace(/'/g,' ').slice(0,100));
  return `<div class="msg-acts">
    <button onclick="replyToMsg('${safeId}','${safeFrom}','${context}')" title="Reply">‚Ü©</button>
    <button onclick="addReactionUI(event,'${safeId}','${context}')" title="React">üòä</button>
    <button onclick="forwardMsg('${safeText}')" title="Forward">‚Ü™</button>
    ${isOwn?`<button onclick="editMsg('${safeId}')" title="Edit">‚úèÔ∏è</button>`:''}
    ${isOwn?`<button onclick="deleteMsg('${safeId}')" title="Delete" style="color:var(--red);">üóë</button>`:''}
    <button onclick="reportMessage('${safeId}','${safeText}')" title="Report" style="color:var(--muted);">üö©</button>
  </div>`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MESSAGE ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function replyToMsg(msgId, fromName, context) {
  const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  replyingTo={id:msgId,from:fromName,text:row?.dataset.text||''};
  const bar=document.getElementById(context+'-reply-bar');
  const nameEl=document.getElementById(context+'-reply-name');
  if (bar) bar.classList.add('show');
  if (nameEl) nameEl.textContent=fromName;
  const inp=document.getElementById(context+'-input');
  if (inp) inp.focus();
}
function cancelReply(context) {
  replyingTo=null;
  const bar=document.getElementById(context+'-reply-bar');
  if (bar) bar.classList.remove('show');
}
function editMsg(msgId) {
  const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  if (!row) return;
  const original=row.dataset.text||'';
  const textEl=row.querySelector('.msg-text');
  if (!textEl) return;
  textEl.innerHTML=`<textarea style="width:100%;background:rgba(255,255,255,.05);border:1px solid var(--accent-mid);border-radius:8px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;padding:6px 10px;resize:none;outline:none;box-sizing:border-box;" rows="2" id="edit-ta">${escapeHTML(original)}</textarea>
    <div style="display:flex;gap:6px;margin-top:4px;font-size:12px;">
      <button class="btn-a" style="padding:4px 12px;font-size:12px;" onclick="saveEdit('${escapeHTML(msgId)}')">Save</button>
      <button class="btn-g" style="padding:4px 12px;font-size:12px;" onclick="cancelEdit('${escapeHTML(msgId)}','${escapeHTML(original)}')">Cancel</button>
    </div>`;
}
function cancelEdit(msgId, original) {
  const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  const textEl=row?.querySelector('.msg-text');
  if (textEl) textEl.innerHTML=parseMD(escapeHTML(original));
}
function saveEdit(msgId) {
  const ta=document.getElementById('edit-ta');
  if (!ta) return;
  const newText=ta.value.trim();
  if (!newText) return;
  const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  if (row) row.dataset.text=newText;
  const textEl=row?.querySelector('.msg-text');
  if (textEl) textEl.innerHTML=parseMD(escapeHTML(newText))+'<span class="msg-edited">(edited)</span>';
  toast('Message edited','success');
}
function deleteMsg(msgId) {
  showCustomConfirm('Delete this message?',()=>{
    const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
    if (row) row.remove();
    toast('Deleted','success');
  });
}
function forwardMsg(text) {
  forwardMsgText=text;
  const targets=document.getElementById('forward-targets');
  if (targets) targets.innerHTML=(CU?.friends||[]).map(f=>`
    <div class="ch-item" style="background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:10px 14px;margin-bottom:4px;cursor:pointer;" onclick="forwardToDM('${escapeHTML(f)}');closeModal('modal-forward');">
      üí¨ ${escapeHTML(f)}
    </div>`).join('')||'<div style="color:var(--muted);font-size:13px;">No friends to forward to</div>';
  openModal('modal-forward');
}
async function forwardToDM(username) {
  try { await FortizedSocial.sendDMMessage(CU.username,username,forwardMsgText+' [forwarded]'); toast('Forwarded to '+username,'success'); }
  catch { toast('Forward failed','error'); }
}
function addReactionUI(e, msgId, context) {
  const emojis=['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üî•','‚ú®','üëÄ','üéâ','üíØ'];
  showCtxMenu(e.clientX,e.clientY,emojis.map(em=>({icon:em,label:em,action:()=>toggleReaction(msgId,em,context)})));
}
function toggleReaction(msgId,emoji,context) {
  const row=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  if (!row) return;
  toast('Reacted with '+emoji,'success');
}
function scrollToMsg(msgId) {
  const el=document.querySelector(`[data-msgid="${CSS.escape(msgId)}"]`);
  if (el) el.scrollIntoView({behavior:'smooth',block:'center'});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MEMBER LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderMemberList() {
  const ml=document.getElementById('member-list');
  if (!ml) return;
  const b=CU.bastions?.[curBastion];
  if (!b) return;
  ml.innerHTML='<div class="ml-role-header">Members</div>';
  let members=[];
  try{members=await FortizedSocial.getBastionMembers(b.globalId||b.name)||[];}catch{}
  if (!members.length&&b.owner) members=[b.owner];
  const roles=b.roles||[];
  const memberRoles=b.memberRoles||{};
  members.forEach(u=>{
    const rids=memberRoles[u]||[];
    const role=roles.find(r=>rids.includes(r.id));
    ml.innerHTML+=`<div class="ml-entry" onclick="viewUserProfile('${escapeHTML(u)}')">
      <div class="ml-av" style="position:relative;">${buildAvatarHTML(null,u,30)}<div class="ml-status online"></div></div>
      <div class="ml-info"><div class="ml-name" style="color:${role?.color||'var(--muted-light)'};">${escapeHTML(u)}</div></div>
    </div>`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// VOICE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function joinVoice(idx) {
  const b=CU.bastions?.[curBastion];
  const ch=b?.channels?.[idx];
  if (!ch) return;
  voiceConnected=true; voiceChannel=idx;
  voiceParticipants=[{name:CU.username,pfp:CU.pfp}];
  const vcb=document.getElementById('voice-connected-bar');
  if (vcb){vcb.classList.add('show');document.getElementById('vcb-channel-name').textContent='üéô '+ch.name;document.getElementById('vcb-participants').innerHTML=voiceParticipants.map(p=>`<div class="vcb-part">${buildAvatarHTML(p.pfp,p.name,18)} ${escapeHTML(p.name)}</div>`).join('');}
  const wrap=document.getElementById('bastion-chat-wrap');
  if (!wrap) return;
  wrap.innerHTML=`
    <div class="voice-panel">
      <div class="voice-panel-title">üéô ${escapeHTML(ch.name)}</div>
      <div class="voice-panel-sub">Voice Channel ¬∑ ${voiceParticipants.length} connected</div>
      <div class="voice-avatars">${voiceParticipants.map(p=>`<div class="voice-avatar-card"><div class="voice-avatar-ring">${buildAvatarHTML(p.pfp,p.name,72)}</div><div class="voice-avatar-name">${escapeHTML(p.name)}</div></div>`).join('')}</div>
      <div class="voice-controls">
        <button class="vc-btn ${isMuted?'active':''}" onclick="toggleVoiceMute()" title="${isMuted?'Unmute':'Mute'}">${isMuted?'üîá':'üé§'}</button>
        <button class="vc-btn" onclick="disconnectVoice()" style="background:rgba(248,113,113,.2);">üìµ Disconnect</button>
        <button class="vc-btn ${isDeafened?'active':''}" onclick="toggleVoiceDeafen()">${isDeafened?'üîï':'üéß'}</button>
      </div>
    </div>`;
  toast('Joined #'+ch.name,'success');
}
function disconnectVoice(){
  voiceConnected=false;voiceChannel=null;voiceParticipants=[];
  const vcb=document.getElementById('voice-connected-bar');
  if(vcb)vcb.classList.remove('show');
  const wrap=document.getElementById('bastion-chat-wrap');
  if(wrap)wrap.innerHTML=`<div class="empty-state"><div class="ei">üè∞</div><h3>Select a channel</h3></div>`;
  toast('Disconnected','info');
}
function toggleVoiceMute(){isMuted=!isMuted;if(voiceChannel!==null)joinVoice(voiceChannel);}
function toggleVoiceDeafen(){isDeafened=!isDeafened;if(voiceChannel!==null)joinVoice(voiceChannel);}
function toggleMic(){isMuted=!isMuted;const b=document.getElementById('mic-btn');if(b)b.textContent=isMuted?'üîá':'üé§';toast(isMuted?'Muted':'Unmuted','info');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FRIENDS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function renderFriendsList(filter='all') {
  const list=document.getElementById('friends-list');
  if (!list) return;
  const friends=CU?.friends||[];
  const pending=CU?.friendRequestsReceived||[];
  let html='';
  if (filter!=='online'&&pending.length){
    html+=`<div style="font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Pending ‚Äî ${pending.length}</div>`;
    pending.forEach(f=>{html+=`<div class="activity-item"><div class="act-icon">${buildAvatarHTML(null,f,40)}</div><div class="act-text"><p><strong>${escapeHTML(f)}</strong> sent you a friend request</p></div><div style="display:flex;gap:6px;"><button class="rn-accept" onclick="acceptFriend('${escapeHTML(f)}')">‚úì</button><button class="rn-decline" onclick="declineFriend('${escapeHTML(f)}')">‚úï</button></div></div>`;});
  }
  if (friends.length){
    html+=`<div style="font-family:'Syne',sans-serif;font-size:12px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin:12px 0 8px;">Friends ‚Äî ${friends.length}</div>`;
    friends.forEach(f=>{html+=`<div class="activity-item"><div class="act-icon">${buildAvatarHTML(null,f,40)}</div><div class="act-text"><p style="font-weight:600;">${escapeHTML(f)}</p></div><div style="display:flex;gap:6px;"><button class="btn-g" style="padding:6px 12px;font-size:12px;" onclick="openDMView('${escapeHTML(f)}')">üí¨</button><button class="btn-d" style="padding:6px 12px;font-size:12px;" onclick="removeFriend('${escapeHTML(f)}')">Remove</button></div></div>`;});
  }
  list.innerHTML=html||`<div class="empty-state"><div class="ei">üë•</div><h3>No friends yet</h3><p>Add friends by username!</p><button class="btn-a" onclick="openModal('modal-add-friend')">+ Add Friend</button></div>`;
}
function filterFriends(filter,btn){
  document.querySelectorAll('#friends-tabs .disc-tab').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderFriendsList(filter);
}
async function sendFriendRequest(){
  const inp=document.getElementById('friend-target');
  const err=document.getElementById('friend-error');
  const succ=document.getElementById('friend-success');
  if(!inp)return;
  const username=inp.value.trim();
  if(!username){if(err)err.textContent='Enter a username';return;}
  if(username===CU.username){if(err)err.textContent="Can't add yourself";return;}
  if(err)err.textContent='';if(succ)succ.textContent='';
  try{const r=await FortizedSocial.sendFriendRequest(CU.username,username);if(r.ok){if(succ)succ.textContent=r.msg;inp.value='';await refreshCU();}else{if(err)err.textContent=r.msg||'Failed';}}
  catch{if(err)err.textContent='Error';}
}
async function acceptFriend(username){
  try{await FortizedSocial.acceptFriendRequest(CU.username,username);await refreshCU();toast('Now friends with '+username+'!','success');renderFriendsList();renderDMSidebar(document.getElementById('sidebar-scroll'));}
  catch{toast('Error','error');}
}
async function declineFriend(username){
  try{await FortizedSocial.declineFriendRequest(CU.username,username);await refreshCU();renderFriendsList();toast('Declined','info');}catch{}
}
async function removeFriend(username){
  showCustomConfirm('Remove '+username+' from friends?',async()=>{
    try{await FortizedSocial.removeFriend(CU.username,username);await refreshCU();toast('Removed '+username,'info');renderFriendsList();}
    catch{toast('Error','error');}
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DISCOVER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadDiscover(){
  const grid=document.getElementById('discover-grid');
  if(!grid)return;
  grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">Loading‚Ä¶</div>';
  try{discoverData=Object.values(await FortizedSocial.getGlobalBastions()||{});}catch{discoverData=[];}
  renderDiscoverGrid(discoverData);
}
function renderDiscoverGrid(bastions){
  const grid=document.getElementById('discover-grid');
  if(!grid)return;
  const filtered=bastions.filter(b=>b.public!==false&&(discoverTab==='all'||b.category===discoverTab));
  if(!filtered.length){grid.innerHTML=`<div style="grid-column:1/-1;" class="empty-state"><div class="ei">üîç</div><h3>No bastions found</h3></div>`;return;}
  grid.innerHTML=filtered.map(b=>{
    const joined=(CU?.bastions||[]).some(ub=>ub.globalId===b.id||ub.name===b.name);
    return `<div class="bc">
      <div class="bc-banner" style="background:linear-gradient(135deg,rgba(255,249,62,.08),rgba(62,207,110,.06));display:flex;align-items:center;justify-content:center;font-size:40px;">${b.emblem||'üè∞'}</div>
      <div class="bc-body">
        <div class="bc-meta"><div class="bc-icon">${b.emblem||'üè∞'}</div><div style="flex:1"></div>
          ${joined?`<span style="font-size:11px;font-weight:700;color:var(--green);">‚úì Joined</span>`:`<button class="btn-a" style="padding:5px 12px;font-size:12px;" onclick="promptJoinPublicBastion('${escapeHTML(b.id||b.name)}')">Join</button>`}
        </div>
        <div class="bc-name">${escapeHTML(b.name)}</div>
        <div class="bc-desc">${escapeHTML((b.desc||'').slice(0,100))}</div>
        <div style="font-size:11px;color:var(--muted);margin-top:4px;">${b.memberCount||0} members</div>
      </div>
    </div>`;
  }).join('');
}
function filterDiscover(q){renderDiscoverGrid(discoverData.filter(b=>(b.name||'').toLowerCase().includes(q.toLowerCase())));}
function setDiscoverTab(tab,btn){discoverTab=tab;document.querySelectorAll('.disc-tab').forEach(b=>b.classList.remove('active'));if(btn)btn.classList.add('active');renderDiscoverGrid(discoverData);}
async function promptJoinPublicBastion(bastionId){
  try{
    const all=await FortizedSocial.getGlobalBastions()||{};
    const b=Object.values(all).find(x=>x.id===bastionId||x.name===bastionId);
    if(!b){toast('Bastion not found','error');return;}
    const already=(CU.bastions||[]).some(ub=>ub.globalId===b.id||ub.name===b.name);
    if(already){toast('Already joined!','info');openBastion((CU.bastions||[]).findIndex(ub=>ub.globalId===b.id||ub.name===b.name));return;}
    const localB={name:b.name,emblem:b.emblem||'üè∞',desc:b.desc||'',channels:b.channels||[{name:'general',type:'text',desc:'General chat'}],roles:b.roles||[],owner:b.owner,globalId:b.id||b.name,memberRoles:{},automod:{},boostLevel:0,customEmojis:[]};
    CU.bastions=[...(CU.bastions||[]),localB];
    await saveUser();
    await FortizedSocial.addBastionMember(b.id||b.name,CU.username);
    renderRailBastions();
    toast('Joined '+b.name+'!','success');
    openBastion(CU.bastions.length-1);
  }catch(e){toast('Failed to join','error');console.error(e);}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MISC MISSING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pickCBEmoji(){
  const emojis=['üè∞','‚öîÔ∏è','üõ°Ô∏è','üîÆ','üèπ','üåü','üî•','‚ùÑÔ∏è','üåä','‚õ©Ô∏è','üéÆ','üé®','üéµ','üé≠','üéØ','üß©','‚ö°','üå∫','ü¶ã','üêâ','ü¶Ö','üåà','ü¶Å','üê∫','ü¶ä','üé™','üöÄ','üí´','üåô','‚òÄÔ∏è'];
  const x=event&&event.clientX||window.innerWidth/2;
  const y=event&&event.clientY||window.innerHeight/2;
  showCtxMenu(x,y,emojis.map(e=>({icon:e,label:e,action:()=>selectCBEmoji(e)})));
}
function setCBVis(v,btn){
  cbVisibility=v;
  document.querySelectorAll('.vis-btn').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
}
function banUser(username,permanent=true){
  showCustomInput('Ban Reason','Enter reason:',reason=>{
    if(!reason)return;
    const bans=JSON.parse(localStorage.getItem('ftz_bans')||'[]');
    bans.push({username,reason,bannedBy:CU.username,permanent,createdAt:new Date().toISOString()});
    localStorage.setItem('ftz_bans',JSON.stringify(bans));
    logAudit(permanent?'permanent_ban':'temp_ban',username,reason);
    toast(username+' banned','success');
    loadAdminTab('users');
  });
}
function unbanUser(username){
  const bans=JSON.parse(localStorage.getItem('ftz_bans')||'[]');
  localStorage.setItem('ftz_bans',JSON.stringify(bans.filter(b=>b.username!==username)));
  logAudit('unban',username,'Unbanned by admin');
  toast(username+' unbanned','success');
  loadAdminTab('users');
}
function updateDOBField(){
  const input=document.getElementById('dob-input');
  if(!input?.value)return;
  const tier=getAgeTier(input.value);
  const labels={child:'üßí Protected (13‚Äì15)',teen:'üßë Teen (16‚Äì17)',adult:'üßë‚Äçü¶≥ Adult (18+)'};
  const hint=document.getElementById('dob-tier-hint');
  if(hint)hint.textContent=tier?'Age tier: '+labels[tier]:'‚ö†Ô∏è Must be 13+';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
(async function appInit(){
  const _sl=document.getElementById('app-loading');
  const _st=setTimeout(()=>{if(_sl)_sl.style.display='none';},8000);
  try{
  if (document.readyState==='loading') await new Promise(r=>document.addEventListener('DOMContentLoaded',r));

  // Get username ‚Äî FortizedSocial stores plain string
  let username=localStorage.getItem('ftz_current')||localStorage.getItem('fortized_current_user');
  if (!username){window.location.href='login.html';return;}
  // Handle old format that stored full JSON object
  if (username.startsWith('{')){try{username=JSON.parse(username).username;}catch{}}
  username=username.replace(/^["']|["']$/g,'').trim();
  if (!username){window.location.href='login.html';return;}

  // Try cached user object first ‚Äî instant load
  const cached=localStorage.getItem('ftz_user_'+username);
  if (cached){
    try{CU=JSON.parse(cached);}catch{CU=null;}
  }

  if (!CU?.username){
    // First load ‚Äî must fetch from Firebase
    const lbl=document.querySelector('#app-loading .lbl');
    if(lbl)lbl.textContent='Signing in‚Ä¶';
    try{
      CU=await Promise.race([
        FortizedSocial.getUserByName(username),
        new Promise((_,r)=>setTimeout(()=>r(new Error('timeout')),8000))
      ]);
    }catch{CU=null;}
    if (!CU?.username){
      localStorage.removeItem('ftz_current');
      localStorage.removeItem('fortized_current_user');
      window.location.href='login.html';
      return;
    }
    localStorage.setItem('ftz_user_'+username,JSON.stringify(CU));
  }

  // Set defaults
  if (!CU.bastions)CU.bastions=[];
  if (!CU.friends)CU.friends=[];
  if (CU.onyx===undefined)CU.onyx=0;
  notifSettings=CU.notifSettings||notifSettings;

  updateUserbar();
  renderRailBastions();

  // Hide loading screen immediately
  const loader=document.getElementById('app-loading');
  if(loader)loader.style.display='none';

  showView('home');
  updateNotifBadge().catch(()=>{});

  // Admin rail button
  if (isAdmin()){
    const rail=document.getElementById('rail');
    if(rail&&!document.getElementById('admin-rail-btn')){
      const btn=document.createElement('div');
      btn.id='admin-rail-btn';btn.className='rail-btn';btn.innerHTML='üõ°Ô∏è';
      btn.dataset.tip='Admin Panel';
      btn.style.cssText='border:1px solid rgba(248,113,113,.3);color:var(--red);margin-top:4px;';
      btn.onclick=tryOpenAdmin;
      const pb=rail.querySelector('#rb-profile');
      if(pb)rail.insertBefore(btn,pb);else rail.appendChild(btn);
    }
  }

  // Show quiz or DOB if needed
  if(!CU.verified)setTimeout(showVerifyQuiz,400);
  else if(!CU.dateOfBirth)setTimeout(showDOBSetup,600);

  // Check invite link
  try{checkInviteLink();}catch{}

  // Event listeners
  document.addEventListener('contextmenu',e=>{e.preventDefault();handleContextMenu(e);});
  document.addEventListener('click',e=>{
    const menu=document.getElementById('ctx-menu');
    if(menu&&!menu.contains(e.target))menu.style.display='none';
    const np=document.getElementById('notif-panel');
    if(notifPanelOpen&&np&&!np.contains(e.target)&&e.target.id!=='rb-notifs'){notifPanelOpen=false;np.classList.remove('open');}
    const ep=document.getElementById('emoji-picker');
    if(ep&&ep.classList.contains('show')&&!ep.contains(e.target)&&!['emoji-btn-dm','emoji-btn-ch'].includes(e.target.id))ep.classList.remove('show');
  });
  document.querySelectorAll('.modal-overlay').forEach(overlay=>{
    overlay.addEventListener('click',e=>{if(e.target===overlay)overlay.classList.remove('open');});
  });
  document.addEventListener('keydown',e=>{if(e.ctrlKey&&e.shiftKey&&e.key==='A')tryOpenAdmin();});

  // Background refresh
  setTimeout(async()=>{
    try{
      const fresh=await Promise.race([
        FortizedSocial.getUserByName(username),
        new Promise((_,r)=>setTimeout(()=>r(new Error('t')),6000))
      ]);
      if(fresh?.username){CU=fresh;saveLocal();updateUserbar();renderRailBastions();updateOnyxDisplay();}
    }catch{}
  },1000);

  setInterval(async()=>{try{await updateNotifBadge();}catch{}},30000);
  clearTimeout(_st);
  }catch(e){console.error('[Fortized]',e);if(_sl)_sl.style.display='none';clearTimeout(_st);}
})();






// ‚îÄ‚îÄ Admin helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ


function selectCBEmoji(emoji) {
  cbSelectedEmoji = emoji;
  const el = document.getElementById('cb-selected-emoji');
  if (el) el.textContent = emoji;
  const prev = document.getElementById('cb-icon-preview');
  if (prev && !cbIconData) prev.textContent = emoji;
}

async function createBastion() {
  const name = document.getElementById('cb-name')?.value?.trim();
  const desc = document.getElementById('cb-desc')?.value?.trim();
  const err = document.getElementById('cb-error');
  if (!name) { if(err)err.textContent='Bastion name is required'; return; }
  if (err) err.textContent = '';

  const bastion = {
    name, desc: desc||'',
    emblem: cbSelectedEmoji||'üè∞',
    icon: cbIconData||null,
    channels: [
      {name:'general',type:'text',desc:'General chat for everyone'},
      {name:'announcements',type:'text',desc:'Important announcements'},
      {name:'lounge',type:'voice',desc:'Voice chat'},
    ],
    roles: [
      {id:'admin',name:'Admin',color:'#fbbf24',permissions:PERMISSIONS.map(p=>p[0])},
      {id:'member',name:'Member',color:'#60a5fa',permissions:['send_messages','read_history','add_reactions']},
    ],
    owner: CU.username,
    public: cbVisibility === 'public',
    memberRoles: {[CU.username]:['admin']},
    automod: {blockLinks:false,antiSpam:true,mentionLimit:10,keywords:[]},
    boostLevel: 0,
    customEmojis: [],
    invites: [],
    createdAt: new Date().toISOString(),
    memberCount: 1,
  };

  CU.bastions = [...(CU.bastions||[]), bastion];
  await saveUser();

  // Register globally
  try {
    const globalB = {...bastion, owner: CU.username, id: CU.username+'_'+Date.now()};
    await FortizedSocial.saveGlobalBastion(globalB);
    CU.bastions[CU.bastions.length-1].globalId = globalB.id;
    await saveUser();
  } catch {}

  closeModal('modal-create-bastion');
  renderRailBastions();
  cbIconData = null;
  cbSelectedEmoji = 'üè∞';
  toast(`${bastion.emblem} ${name} created!`, 'success');
  openBastion(CU.bastions.length - 1);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANNEL MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addChannel(bastionIdx, type) {
  showCustomInput('Add Channel', `Name for new ${type} channel:`, async (name) => {
    if (!name?.trim()) return;
    const b = CU.bastions[bastionIdx];
    if (!b) return;
    b.channels = [...(b.channels||[]), {name:name.trim().toLowerCase().replace(/\s+/g,'-'), type, desc:''}];
    await saveUser();
    renderBastionSidebar(document.getElementById('sidebar-scroll'));
    toast(`#${name} created`, 'success');
  }, 'new-channel');
}

async function joinBastionByCode() {
  const code = document.getElementById('join-code')?.value?.trim();
  const err = document.getElementById('join-error');
  if (!code) { if(err)err.textContent='Enter a code or name'; return; }
  try { await promptJoinPublicBastion(code); closeModal('modal-join-bastion'); }
  catch { if(err)err.textContent='Could not find that bastion'; }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASTION SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openBastionSettings(tab='overview') {
  if (curBastion === null) return;
  showView('bsettings');
  renderBSettingsNav(tab);
  renderBSettingsMain(tab);
}

function renderBSettingsNav(activeTab) {
  const nav = document.getElementById('bsettings-nav');
  const b = CU.bastions[curBastion];
  if (!nav||!b) return;
  document.getElementById('sidebar-title').textContent = '‚öôÔ∏è '+b.name;
  const sections = [
    {label:'Bastion'},
    {id:'overview',icon:'üè∞',label:'Overview'},
    {id:'channels',icon:'üìù',label:'Channels'},
    {id:'roles',icon:'üõ°Ô∏è',label:'Roles'},
    {id:'emojis',icon:'üòä',label:'Custom Emojis'},
    {label:'Moderation'},
    {id:'automod',icon:'ü§ñ',label:'AutoMod'},
    {id:'invites',icon:'üîó',label:'Invites'},
    {id:'members',icon:'üë•',label:'Members'},
    {id:'bans',icon:'üî®',label:'Bans'},
    {label:'Perks'},
    {id:'boost',icon:'‚ö°',label:'Boost'},
    {label:'Danger'},
    {id:'danger',icon:'‚ö†Ô∏è',label:'Danger Zone'},
  ];
  nav.innerHTML = sections.map(s=>{
    if(!s.id) return `<div class="bsettings-nav-section">${s.label}</div>`;
    return `<div class="bsettings-nav-item ${activeTab===s.id?'active':''}" onclick="renderBSettingsMain('${s.id}')">${s.icon} ${s.label}</div>`;
  }).join('');
  nav.innerHTML += `<div style="height:14px;"></div><div class="bsettings-nav-item" onclick="openBastion(curBastion)" style="color:var(--muted);">‚Üê Back to Bastion</div>`;
}

function renderBSettingsMain(tab) {
  const main = document.getElementById('bsettings-main');
  const b = CU.bastions[curBastion];
  if (!main||!b) return;
  // Update nav active
  document.querySelectorAll('.bsettings-nav-item').forEach(el => el.classList.remove('active'));
  const navItem = [...document.querySelectorAll('.bsettings-nav-item')].find(el=>el.textContent.includes(tab[0].toUpperCase()+tab.slice(1)));
  // Re-render nav with correct active
  renderBSettingsNav(tab);

  if (tab==='overview') {
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üè∞ Overview</div>
      <div style="display:flex;gap:14px;margin-bottom:20px;">
        <div style="width:80px;height:80px;border-radius:18px;background:var(--panel2);border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:32px;cursor:pointer;overflow:hidden;" onclick="document.getElementById('bs-icon-upload').click()" id="bs-icon-prev">
          ${b.icon?`<img src="${b.icon}" style="width:100%;height:100%;object-fit:cover;border-radius:16px;">`:(b.emblem||'üè∞')}
        </div>
        <input id="bs-icon-upload" type="file" accept="image/*" style="display:none;" onchange="updateBastionIcon(event)">
        <div style="flex:1;">
          <div class="settings-title">Bastion Name</div>
          <input class="field-input" id="bs-name" value="${escapeHTML(b.name)}" style="margin-bottom:8px;">
          <div class="settings-title">Description</div>
          <input class="field-input" id="bs-desc" value="${escapeHTML(b.desc||'')}">
        </div>
      </div>
      <div class="settings-title">Visibility</div>
      <div class="vis-toggle" style="margin-bottom:20px;">
        <div class="vis-opt ${b.public!==false?'active':''}" onclick="setBastionVis(true)">
          <div style="font-size:22px;">üåç</div><div style="font-size:13px;font-weight:700;">Public</div>
          <div style="font-size:11px;color:var(--muted-light);">Anyone can discover & join</div>
        </div>
        <div class="vis-opt ${b.public===false?'active':''}" onclick="setBastionVis(false)">
          <div style="font-size:22px;">üîí</div><div style="font-size:13px;font-weight:700;">Private</div>
          <div style="font-size:11px;color:var(--muted-light);">Invite only</div>
        </div>
      </div>
      <button class="btn-a" onclick="saveBastionOverview()">Save Changes</button>`;
  }
  else if (tab==='channels') {
    const chHTML = (b.channels||[]).map((ch,i)=>`
      <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;">
        <span>${ch.type==='voice'?'üéô':'#'}</span>
        <span style="flex:1;font-size:13.5px;font-weight:600;">${escapeHTML(ch.name)}</span>
        ${ch.nsfw?'<span style="font-size:9px;background:rgba(248,113,113,.15);color:var(--red);padding:2px 6px;border-radius:4px;">NSFW</span>':''}
        <button class="btn-g" style="padding:5px 10px;font-size:12px;" onclick="toggleNSFW(${i})">${ch.nsfw?'Un-NSFW':'Mark NSFW'}</button>
        <button class="btn-d" style="padding:5px 10px;font-size:12px;" onclick="deleteChannel(${i})">Delete</button>
      </div>`).join('');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üìù Channels</div>
      <div style="display:flex;gap:8px;margin-bottom:18px;">
        <button class="btn-a" onclick="addChannel(curBastion,'text')" style="font-size:13px;">+ Text Channel</button>
        <button class="btn-g" onclick="addChannel(curBastion,'voice')" style="font-size:13px;">+ Voice Channel</button>
      </div>
      ${chHTML||'<div class="empty-state"><div class="ei">üìù</div><h3>No channels</h3></div>'}`;
  }
  else if (tab==='roles') {
    const rolesHTML = (b.roles||[]).map((r,i)=>`
      <div class="role-item" onclick="editRole(${i})">
        <div class="role-dot" style="background:${r.color};"></div>
        <div class="role-name">${escapeHTML(r.name)}</div>
        <div style="font-size:12px;color:var(--muted);">${(r.permissions||[]).length} perms</div>
        <span style="color:var(--muted);">‚Üí</span>
      </div>`).join('');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üõ°Ô∏è Roles</div>
      <button class="btn-a" style="margin-bottom:16px;font-size:13px;" onclick="createNewRole()">+ Create Role</button>
      ${rolesHTML||'<div style="color:var(--muted);font-size:13.5px;">No roles created yet.</div>'}`;
  }
  else if (tab==='emojis') {
    const limit = [15,25,35][(b.boostLevel||0)] || 15;
    const emojis = b.customEmojis || [];
    const slots = Array.from({length:limit}).map((_,i)=>{
      const e = emojis[i];
      return e ? `<div class="emoji-slot filled"><img src="${e.data}" alt="${escapeHTML(e.name)}"><div class="es-name">:${escapeHTML(e.name)}:</div><div class="es-del" onclick="event.stopPropagation();deleteCustomEmoji(${i})">‚úï</div></div>`
        : `<div class="emoji-slot" onclick="uploadCustomEmoji()">+</div>`;
    }).join('');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üòä Custom Emojis</div>
      <div style="font-size:13px;color:var(--muted-light);margin-bottom:16px;">${emojis.length}/${limit} slots used ¬∑ Boost to unlock more</div>
      <input id="emoji-file-input" type="file" accept="image/*,image/gif" style="display:none;" onchange="processEmojiUpload(event)">
      <div class="emoji-upload-grid">${slots}</div>`;
  }
  else if (tab==='automod') {
    const am = b.automod || {};
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">ü§ñ AutoMod</div>
      <div class="automod-rule">
        <div class="amr-header"><span style="font-size:20px;">üîó</span><div class="amr-title">Block Links</div>
          <div class="amr-enabled"><span>${am.blockLinks?'Enabled':'Disabled'}</span><div class="toggle ${am.blockLinks?'on':''}" onclick="toggleAM('blockLinks',this)"></div></div></div>
        <div class="amr-desc">Prevent members from posting external links in text channels.</div>
      </div>
      <div class="automod-rule">
        <div class="amr-header"><span style="font-size:20px;">‚ö°</span><div class="amr-title">Anti-Spam (Caps)</div>
          <div class="amr-enabled"><span>${am.antiSpam?'Enabled':'Disabled'}</span><div class="toggle ${am.antiSpam?'on':''}" onclick="toggleAM('antiSpam',this)"></div></div></div>
        <div class="amr-desc">Block messages with excessive capitalization (>70% caps).</div>
      </div>
      <div class="automod-rule">
        <div class="amr-header"><span style="font-size:20px;">üì¢</span><div class="amr-title">Mention Limit</div></div>
        <div class="amr-desc">Max mentions per message: <strong>${am.mentionLimit||10}</strong></div>
        <input class="field-input" type="number" id="mention-limit" value="${am.mentionLimit||10}" min="1" max="25" style="width:80px;margin-top:6px;">
      </div>
      <div class="automod-rule">
        <div class="amr-header"><span style="font-size:20px;">üö´</span><div class="amr-title">Blocked Keywords</div></div>
        <div class="amr-desc">Messages containing these words will be blocked.</div>
        <div class="amr-keywords" id="kw-list">
          ${(am.keywords||[]).map((k,i)=>`<div class="amr-kw">${escapeHTML(k)}<button onclick="removeKeyword(${i})">‚úï</button></div>`).join('')}
        </div>
        <div style="display:flex;gap:8px;margin-top:10px;">
          <input class="field-input" id="new-kw" placeholder="Add keyword‚Ä¶" style="width:auto;flex:1;">
          <button class="btn-g" style="padding:8px 14px;font-size:13px;" onclick="addKeyword()">Add</button>
        </div>
      </div>
      <button class="btn-a" style="margin-top:16px;" onclick="saveAutoMod()">Save AutoMod</button>`;
  }
  else if (tab==='invites') {
    const invites = b.invites || [];
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üîó Invite Links</div>
      <button class="btn-a" style="margin-bottom:18px;font-size:13px;" onclick="generateInvite()">Generate Invite Link</button>
      ${invites.length ? invites.map((inv,i)=>`
        <div style="padding:12px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;">
          <div class="invite-link-box"><span>${location.origin}?invite=${inv.code}</span>
            <button class="btn-g" style="padding:4px 10px;font-size:12px;" onclick="copyInvite('${inv.code}')">Copy</button>
          </div>
          <div style="font-size:12px;color:var(--muted);">Uses: ${inv.uses||0} ¬∑ ${inv.expires?'Expires: '+new Date(inv.expires).toLocaleDateString():'No expiry'}</div>
          <button class="btn-d" style="padding:4px 10px;font-size:12px;margin-top:6px;" onclick="revokeInvite(${i})">Revoke</button>
        </div>`).join('')
        : '<div style="color:var(--muted);font-size:13.5px;">No active invite links.</div>'}`;
  }
  else if (tab==='members') {
    main.innerHTML = `<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üë• Members</div><div id="bsettings-members-list"><div style="color:var(--muted);">Loading‚Ä¶</div></div>`;
    loadBastionMembersList();
  }
  else if (tab==='bans') {
    const bans = b.bans || [];
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">üî® Bans</div>
      ${bans.length ? bans.map((ban,i)=>`
        <div style="padding:12px 16px;background:var(--panel);border:1px solid rgba(248,113,113,.2);border-radius:14px;margin-bottom:8px;display:flex;align-items:center;gap:12px;">
          <span style="font-size:18px;">üö´</span>
          <div style="flex:1;"><div style="font-weight:600;">${escapeHTML(ban.username)}</div><div style="font-size:12px;color:var(--muted);">Reason: ${escapeHTML(ban.reason||'N/A')}</div></div>
          <button class="btn-g" style="font-size:12px;padding:5px 10px;" onclick="unbanMember(${i})">Unban</button>
        </div>`).join('')
        : '<div style="color:var(--muted);font-size:13.5px;">No banned members.</div>'}`;
  }
  else if (tab==='boost') {
    const level = b.boostLevel || 0;
    const costs = [500, 1000, 2000];
    const perks = [
      'Level 1: 25 custom emoji slots, animated icon',
      'Level 2: 35 custom emoji slots, HD voice quality',
      'Level 3: 50 custom emoji slots, custom invite splash',
    ];
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">‚ö° Bastion Boost</div>
      <div class="boost-level-bar">
        <div style="font-size:22px;">‚ö°</div>
        <div style="flex:1;"><div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--accent);">Level ${level} Bastion</div>
          <div style="font-size:12px;color:var(--muted-light);">${15+((level)*10)} emoji slots</div></div>
      </div>
      ${level < 3 ? `<div style="margin-top:16px;">
        <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:8px;">Next Boost: Level ${level+1}</div>
        <div style="font-size:13px;color:var(--muted-light);margin-bottom:12px;">${perks[level]}</div>
        <div style="font-size:13px;color:var(--accent);margin-bottom:12px;font-weight:700;">Cost: ${costs[level]} Onyx (You have: ${CU.onyx})</div>
        <button class="btn-a" onclick="boostBastion(${level+1},${costs[level]})">‚ö° Boost to Level ${level+1}</button>
      </div>` : `<div style="color:var(--green);font-size:14px;font-weight:700;margin-top:12px;">‚úì Maximum boost level reached!</div>`}`;
  }
  else if (tab==='danger') {
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">‚ö†Ô∏è Danger Zone</div>
      <div style="padding:16px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.2);border-radius:16px;margin-bottom:14px;">
        <div style="font-weight:700;margin-bottom:6px;">Leave Bastion</div>
        <div style="font-size:13px;color:var(--muted-light);margin-bottom:12px;">You'll need an invite to rejoin.</div>
        <button class="btn-d" onclick="confirmLeaveBastion()">Leave Bastion</button>
      </div>
      ${b.owner===CU.username?`<div style="padding:16px;background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.2);border-radius:16px;">
        <div style="font-weight:700;margin-bottom:6px;">Delete Bastion</div>
        <div style="font-size:13px;color:var(--muted-light);margin-bottom:12px;">Permanently deletes all channels, messages, and settings. Cannot be undone.</div>
        <button class="btn-d" onclick="deleteBastion()">Delete Bastion</button>
      </div>`:''}`;
  }
  else {
    main.innerHTML = `<div class="empty-state"><div class="ei">üöß</div><h3>Coming Soon</h3><p>This section is in development.</p></div>`;
  }
}

// Bastion settings actions
async function saveBastionOverview() {
  const b = CU.bastions[curBastion];
  b.name = document.getElementById('bs-name')?.value?.trim() || b.name;
  b.desc = document.getElementById('bs-desc')?.value?.trim() || '';
  await saveUser();
  renderRailBastions();
  toast('Bastion updated!', 'success');
}
function setBastionVis(isPublic) {
  const b = CU.bastions[curBastion];
  b.public = isPublic;
  document.querySelectorAll('.vis-opt').forEach((el,i) => el.classList.toggle('active', i===(isPublic?0:1)));
}
async function updateBastionIcon(e) {
  const file = e.target.files[0]; if(!file) return;
  if(file.size>2*1024*1024){toast('Max 2MB','error');return;}
  const r=new FileReader(); r.onload=async ev=>{CU.bastions[curBastion].icon=ev.target.result;await saveUser();renderBastionSidebar(document.getElementById('sidebar-scroll'));renderBSettingsMain('overview');toast('Icon updated!','success');};r.readAsDataURL(file);
}
async function toggleNSFW(chIdx) {
  const ch = CU.bastions[curBastion].channels[chIdx];
  ch.nsfw = !ch.nsfw;
  await saveUser();
  renderBSettingsMain('channels');
  toast(`${ch.name} is now ${ch.nsfw?'NSFW':'SFW'}`, 'info');
}
async function deleteChannel(chIdx) {
  showCustomConfirm('Delete this channel? All messages will be lost.', async () => {
    CU.bastions[curBastion].channels.splice(chIdx, 1);
    await saveUser();
    renderBSettingsMain('channels');
    toast('Channel deleted', 'info');
  });
}
function toggleAM(key, el) {
  const b = CU.bastions[curBastion];
  b.automod = b.automod || {};
  b.automod[key] = !b.automod[key];
  el.classList.toggle('on', b.automod[key]);
}
async function addKeyword() {
  const inp = document.getElementById('new-kw'); if(!inp||!inp.value.trim()) return;
  const b = CU.bastions[curBastion]; b.automod=b.automod||{}; b.automod.keywords=b.automod.keywords||[];
  b.automod.keywords.push(inp.value.trim()); inp.value='';
  await saveUser(); renderBSettingsMain('automod');
}
async function removeKeyword(i) {
  CU.bastions[curBastion].automod.keywords.splice(i,1);
  await saveUser(); renderBSettingsMain('automod');
}
async function saveAutoMod() {
  const ml = parseInt(document.getElementById('mention-limit')?.value)||10;
  CU.bastions[curBastion].automod.mentionLimit = ml;
  await saveUser(); toast('AutoMod saved!', 'success');
}
async function generateInvite() {
  const b = CU.bastions[curBastion];
  const code = CU.username.slice(0,4)+(Date.now()).toString(36).toUpperCase();
  b.invites = [...(b.invites||[]), {code, uses:0, created:new Date().toISOString()}];
  await saveUser(); renderBSettingsMain('invites');
  toast('Invite created!', 'success');
}
function copyInvite(code) {
  navigator.clipboard.writeText(location.origin+'?invite='+code).then(()=>toast('Invite link copied!','success')).catch(()=>toast('Copy failed','error'));
}
async function revokeInvite(i) {
  CU.bastions[curBastion].invites.splice(i,1);
  await saveUser(); renderBSettingsMain('invites'); toast('Invite revoked','info');
}
async function loadBastionMembersList() {
  const b = CU.bastions[curBastion];
  const el = document.getElementById('bsettings-members-list'); if(!el) return;
  let members=[];
  try { members = await FortizedSocial.getBastionMembers(b.globalId||b.name)||[]; } catch {}
  if(!members.length) members=[b.owner];
  el.innerHTML = members.map(u=>`
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;">
      <span>${buildAvatarHTML(null,u,36)}</span>
      <div style="flex:1;"><div style="font-weight:600;">${escapeHTML(u)}</div>${u===b.owner?'<div style="font-size:11px;color:var(--accent);">Owner</div>':''}</div>
      ${u!==CU.username&&b.owner===CU.username?`
        <button class="btn-g" style="font-size:12px;padding:5px 10px;" onclick="openAssignRole(curBastion,'${escapeHTML(u)}')">Roles</button>
        <button class="btn-d" style="font-size:12px;padding:5px 10px;" onclick="kickMember('${escapeHTML(u)}')">Kick</button>`:''}
    </div>`).join('');
}
async function kickMember(username) {
  showCustomConfirm(`Kick ${username} from this bastion?`, async ()=>{
    try {
      const b=CU.bastions[curBastion];
      await FortizedSocial.removeBastionMember(b.globalId||b.name,username);
      toast(`${username} kicked`,'info');
      loadBastionMembersList();
    } catch { toast('Error','error'); }
  });
}
async function unbanMember(i) {
  CU.bastions[curBastion].bans=CU.bastions[curBastion].bans||[];
  CU.bastions[curBastion].bans.splice(i,1);
  await saveUser(); renderBSettingsMain('bans'); toast('Member unbanned','success');
}
async function boostBastion(level, cost) {
  if((CU.onyx||0)<cost){toast('Not enough Onyx!','error');return;}
  showCustomConfirm(`Boost to Level ${level} for ${cost} Onyx?`, async ()=>{
    CU.onyx=(CU.onyx||0)-cost;
    CU.bastions[curBastion].boostLevel=level;
    await saveUser(); updateOnyxDisplay(); renderBSettingsMain('boost');
    toast(`‚ö° Boosted to Level ${level}!`,'success');
  });
}
async function confirmLeaveBastion() {
  const b=CU.bastions[curBastion];
  document.getElementById('leave-title').textContent=`Leave ${b.name}?`;
  document.getElementById('leave-confirm-btn').onclick=async()=>{
    try{await FortizedSocial.removeBastionMember(b.globalId||b.name,CU.username);}catch{}
    CU.bastions.splice(curBastion,1);
    await saveUser(); closeModal('modal-leave-bastion'); curBastion=null;
    renderRailBastions(); showView('home'); toast('Left bastion','info');
  };
  openModal('modal-leave-bastion');
}
async function deleteBastion() {
  showCustomConfirm('DELETE this bastion permanently? This cannot be undone.', async ()=>{
    CU.bastions.splice(curBastion,1);
    await saveUser(); curBastion=null; renderRailBastions(); showView('home'); toast('Bastion deleted','info');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ROLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createNewRole() {
  currentRoleEditing = {id:'r'+Date.now(),name:'New Role',color:ROLE_COLORS[0],permissions:['send_messages','read_history','add_reactions']};
  document.getElementById('re-title').textContent='Create Role';
  document.getElementById('re-delete-btn').style.display='none';
  openRoleEditor();
}
function editRole(idx) {
  const b=CU.bastions[curBastion];
  currentRoleEditing={...b.roles[idx], _idx:idx};
  document.getElementById('re-title').textContent='Edit Role';
  document.getElementById('re-delete-btn').style.display='';
  openRoleEditor();
}
function openRoleEditor() {
  const r=currentRoleEditing;
  document.getElementById('re-name').value=r.name;
  document.getElementById('re-colors').innerHTML=ROLE_COLORS.map(c=>`<div class="color-swatch ${r.color===c?'sel':''}" style="background:${c};" onclick="selectRoleColor('${c}')"></div>`).join('');
  document.getElementById('re-perms').innerHTML=PERMISSIONS.map(([key,,desc])=>`
    <div class="perm-row">
      <div class="perm-info"><div class="perm-label">${key.replace(/_/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</div><div style="font-size:12px;color:var(--muted-light);">${desc}</div></div>
      <div class="toggle ${(r.permissions||[]).includes(key)?'on':''}" onclick="toggleRolePerm('${key}',this)"></div>
    </div>`).join('');
  openModal('modal-role-editor');
}
function selectRoleColor(color) {
  currentRoleEditing.color=color;
  document.querySelectorAll('.color-swatch').forEach(el=>el.classList.toggle('sel',el.style.background===color||el.style.backgroundColor===color));
}
function toggleRolePerm(key, el) {
  const perms=currentRoleEditing.permissions||[];
  if(perms.includes(key)) currentRoleEditing.permissions=perms.filter(p=>p!==key);
  else currentRoleEditing.permissions=[...perms,key];
  el.classList.toggle('on',currentRoleEditing.permissions.includes(key));
}
async function saveRole() {
  const b=CU.bastions[curBastion];
  currentRoleEditing.name=document.getElementById('re-name').value.trim()||currentRoleEditing.name;
  if('_idx' in currentRoleEditing) {
    const idx=currentRoleEditing._idx;
    delete currentRoleEditing._idx;
    b.roles[idx]=currentRoleEditing;
  } else { b.roles=[...(b.roles||[]),currentRoleEditing]; }
  await saveUser(); closeModal('modal-role-editor'); renderBSettingsMain('roles'); toast('Role saved!','success');
}
async function deleteCurrentRole() {
  if(!('_idx' in currentRoleEditing)) return;
  showCustomConfirm('Delete this role?', async ()=>{
    CU.bastions[curBastion].roles.splice(currentRoleEditing._idx,1);
    await saveUser(); closeModal('modal-role-editor'); renderBSettingsMain('roles'); toast('Role deleted','info');
  });
}

// Assign roles modal
let assignRoleBastionIdx=null;
function openAssignRole(bastionIdx, username) {
  assignRoleBastionIdx=bastionIdx; assignRoleMember=username;
  const b=CU.bastions[bastionIdx];
  document.getElementById('ar-title').textContent=`Roles for ${username}`;
  const memberRoles=(b.memberRoles||{})[username]||[];
  document.getElementById('ar-roles').innerHTML=(b.roles||[]).map(r=>`
    <div style="display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;">
      <div class="role-dot" style="background:${r.color};"></div>
      <div style="flex:1;font-weight:600;">${escapeHTML(r.name)}</div>
      <div class="toggle ${memberRoles.includes(r.id)?'on':''}" onclick="toggleMemberRole('${r.id}',this)"></div>
    </div>`).join('');
  openModal('modal-assign-role');
}
function toggleMemberRole(roleId, el) {
  const b=CU.bastions[assignRoleBastionIdx];
  if(!b.memberRoles) b.memberRoles={};
  if(!b.memberRoles[assignRoleMember]) b.memberRoles[assignRoleMember]=[];
  const roles=b.memberRoles[assignRoleMember];
  if(roles.includes(roleId)) b.memberRoles[assignRoleMember]=roles.filter(r=>r!==roleId);
  else b.memberRoles[assignRoleMember]=[...roles,roleId];
  el.classList.toggle('on',b.memberRoles[assignRoleMember].includes(roleId));
}
async function saveAssignedRoles() { await saveUser(); closeModal('modal-assign-role'); toast('Roles updated!','success'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM EMOJIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function uploadCustomEmoji() {
  const inp=document.getElementById('emoji-file-input');
  if(inp) inp.click();
}
async function processEmojiUpload(e) {
  const file=e.target.files[0]; if(!file) return;
  if(file.size>512*1024){toast('Max 512KB per emoji','error');return;}
  if(!file.type.startsWith('image/')){toast('Images only','error');return;}
  showCustomInput('Emoji Name','Enter a name for this emoji (no spaces):',async(name)=>{
    if(!name?.trim()){toast('Name required','error');return;}
    const cleanName=name.trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
    const r=new FileReader();
    r.onload=async ev=>{
      const b=CU.bastions[curBastion];
      b.customEmojis=[...(b.customEmojis||[]),{name:cleanName,data:ev.target.result,type:'img',animated:file.type==='image/gif'}];
      await saveUser(); renderBSettingsMain('emojis'); toast(`:${cleanName}: added!`,'success');
    };
    r.readAsDataURL(file);
  });
}
async function deleteCustomEmoji(i) {
  showCustomConfirm('Delete this custom emoji?',async()=>{
    CU.bastions[curBastion].customEmojis.splice(i,1);
    await saveUser(); renderBSettingsMain('emojis'); toast('Emoji removed','info');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// EMOJI PICKER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleEmojiPicker(targetId) {
  activeEmojiTarget=targetId;
  const panel=document.getElementById('emoji-picker');
  if(panel.classList.contains('show')){panel.classList.remove('show');return;}
  buildEmojiPicker();
  panel.classList.add('show');
  // Position above button
  const btn=document.getElementById('emoji-btn-dm')||document.getElementById('emoji-btn-ch');
  if(btn){
    const r=btn.getBoundingClientRect();
    panel.style.bottom=(window.innerHeight-r.top+8)+'px';
    panel.style.left=r.left+'px';
    panel.style.top='auto';
  }
}
function buildEmojiPicker() {
  const panel=document.getElementById('emoji-picker');
  const cat=EMOJI_CATEGORIES[activeEmojiCat]||EMOJI_CATEGORIES[0];
  const customEmojis=curBastion!==null?(CU.bastions[curBastion]?.customEmojis||[]):[];
  panel.innerHTML=`
    <div class="epp-search"><input type="text" placeholder="Search emoji‚Ä¶" oninput="searchEmojis(this.value)"></div>
    <div class="epp-cats">${EMOJI_CATEGORIES.map((c,i)=>`<div class="epp-cat ${i===activeEmojiCat?'active':''}" onclick="setEmojiCat(${i})">${c.icon}</div>`).join('')}</div>
    <div class="epp-grid" id="epp-grid">${cat.emojis.map(e=>`<div class="epp-emoji" onclick="insertEmoji('${e}')">${e}</div>`).join('')}</div>
    ${customEmojis.length?`<div class="epp-custom-section"><div class="epp-custom-title">Custom Emojis</div><div class="epp-custom-grid">${customEmojis.map(ce=>`<div class="epp-custom-emoji" onclick="insertCustomEmoji('${escapeHTML(ce.name)}','${ce.data}')" title=":${escapeHTML(ce.name)}: "><img src="${ce.data}" alt=":${escapeHTML(ce.name)}:"></div>`).join('')}</div></div>`:''}`;
}
function setEmojiCat(idx) { activeEmojiCat=idx; buildEmojiPicker(); }
function searchEmojis(q) {
  const grid=document.getElementById('epp-grid'); if(!grid) return;
  const all=EMOJI_CATEGORIES.flatMap(c=>c.emojis);
  grid.innerHTML=all.filter(()=>true).map(e=>`<div class="epp-emoji" onclick="insertEmoji('${e}')">${e}</div>`).join('');
}
function insertEmoji(emoji) {
  const ta=document.getElementById(activeEmojiTarget);
  if(!ta) return;
  const pos=ta.selectionStart;
  ta.value=ta.value.slice(0,pos)+emoji+ta.value.slice(ta.selectionEnd);
  ta.selectionStart=ta.selectionEnd=pos+emoji.length;
  ta.focus();
  document.getElementById('emoji-picker').classList.remove('show');
}
function insertCustomEmoji(name, data) {
  const ta=document.getElementById(activeEmojiTarget);
  if(!ta) return;
  ta.value+=`:${name}: `;
  ta.focus();
  document.getElementById('emoji-picker').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE & SETTINGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildProfileNav(scroll) {
  const sections=[
    {section:'My Account'},
    {id:'myprofile',icon:'üë§',label:'My Profile'},
    {id:'account',icon:'üîí',label:'Account'},
    {id:'notifs_settings',icon:'üîî',label:'Notifications'},
    {section:'Preferences'},
    {id:'privacy',icon:'üõ°Ô∏è',label:'Privacy'},
    {id:'appearance',icon:'üé®',label:'Appearance'},
  ];
  scroll.innerHTML=sections.map(s=>{
    if(s.section) return `<div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 4px;">${s.section}</div>`;
    return `<div class="profile-nav-item" onclick="buildProfileView('${s.id}')">${s.icon} ${s.label}</div>`;
  }).join('');
  scroll.innerHTML+=`<div style="flex:1;"></div><div class="profile-nav-item" onclick="doLogout()" style="color:var(--red);">üö™ Log Out</div>`;
  buildProfileView('myprofile');
}

function buildProfileView(tab) {
  const main=document.getElementById('profile-main'); if(!main) return;
  document.querySelectorAll('.profile-nav-item').forEach(el=>el.classList.remove('active'));
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();

  if(tab==='myprofile') {
    main.innerHTML=`
      <div class="profile-banner-area"><img src="${CU.banner||'Profile Banner.png'}" onerror="this.style.display='none'">
        ${hasRadiance?`<label style="position:absolute;bottom:8px;right:8px;" class="btn-g" style="cursor:pointer;">üñº Banner<input type="file" accept="image/*" style="display:none;" onchange="updateBanner(event)"></label>`:''}
      </div>
      <div class="profile-av-row">
        <label style="cursor:pointer;"><div class="profile-av-big">${CU.pfp?`<img src="${CU.pfp}">`:(CU.displayName||CU.username)[0].toUpperCase()}</div><input type="file" accept="image/*" style="display:none;" onchange="updatePfp(event)"></label>
        ${hasRadiance?`<div class="radiance-badge">‚ú® Radiance Active</div>`:''}
      </div>
      <div class="profile-content">
        <div class="profile-display-name">${escapeHTML(CU.displayName||CU.username)}</div>
        <div class="profile-username">@${escapeHTML(CU.username)}</div>
        <div class="profile-stats-row" style="margin-top:14px;">
          <div class="ps-stat"><div class="ps-val">${(CU.bastions||[]).length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.friends||[]).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.onyx||0}</div><div class="ps-key">Onyx</div></div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Display Name</div>
          <input class="field-input" id="dn-input" value="${escapeHTML(CU.displayName||CU.username)}" style="margin-bottom:8px;" maxlength="32">
          <button class="btn-a" onclick="saveDisplayName()" style="font-size:13px;padding:8px 16px;">Save Name</button>
        </div>
        <div class="settings-section">
          <div class="settings-title">Status</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${[['online','üü¢','Online'],['away','üü°','Away'],['dnd','üî¥','Do Not Disturb'],['invisible','‚ö´','Invisible']].map(([s,i,l])=>`<button onclick="setMyStatus('${s}')" style="display:flex;align-items:center;gap:5px;background:${CU.status===s?'var(--accent-dim)':'transparent'};border:1px solid ${CU.status===s?'var(--accent-mid)':'var(--border)'};color:${CU.status===s?'var(--accent)':'var(--muted-light)'};padding:7px 14px;border-radius:10px;font-size:12.5px;cursor:pointer;">${i} ${l}</button>`).join('')}
          </div>
        </div>
      </div>`;
  } else if(tab==='account') {
    main.innerHTML=`<div style="padding:24px;">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">Account</div>
      <div class="settings-section">
        <div class="settings-title">Username</div>
        <input class="field-input" value="${escapeHTML(CU.username)}" disabled style="opacity:.6;margin-bottom:4px;">
        <div style="font-size:11.5px;color:var(--muted);">Username cannot be changed.</div>
      </div>
      <div class="settings-section">
        <div class="settings-title">Email</div>
        <input class="field-input" id="email-input" value="${escapeHTML(CU.email||'')}" placeholder="your@email.com" style="margin-bottom:8px;">
        <button class="btn-a" onclick="saveEmail()" style="font-size:13px;padding:8px 16px;">Update Email</button>
      </div>
      <div class="settings-section">
        <div class="settings-title">Change Password</div>
        <input class="field-input" id="pw-old" type="password" placeholder="Current password" style="margin-bottom:8px;">
        <input class="field-input" id="pw-new" type="password" placeholder="New password (min 6 chars)" style="margin-bottom:8px;">
        <button class="btn-a" onclick="changePassword()" style="font-size:13px;padding:8px 16px;">Update Password</button>
        <div id="pw-msg" style="margin-top:8px;font-size:12.5px;"></div>
      </div>
      <div class="settings-section"><div class="settings-title" style="color:var(--red);">Danger Zone</div>
        <button class="btn-d" onclick="showCustomConfirm('Delete your account permanently?',doLogout)">Delete Account</button>
      </div>
    </div>`;
  } else if(tab==='notifs_settings') {
    main.innerHTML=`<div style="padding:24px;">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">Notification Settings</div>
      ${[['messages','üí¨','Direct Messages','Get notified for new DMs'],['friendRequests','üë•','Friend Requests','Notifications for new friend requests'],['bastionActivity','üè∞','Bastion Activity','Messages and events in your Bastions'],['mentions','üîî','Mentions','When someone mentions you'],['sounds','üîä','Sound Effects','Enable notification sounds']].map(([k,icon,label,desc])=>`
        <div class="notif-setting-row">
          <div class="nsr-info"><div class="nsr-label">${icon} ${label}</div><div class="nsr-desc">${desc}</div></div>
          <div class="toggle ${notifSettings[k]?'on':''}" onclick="toggleNotifSetting('${k}',this)"></div>
        </div>`).join('')}
      <button class="btn-a" style="margin-top:20px;" onclick="saveNotifSettings()">Save Settings</button>
    </div>`;
  } else {
    main.innerHTML=`<div class="empty-state"><div class="ei">üöß</div><h3>Coming Soon</h3><p>These settings are on the way!</p></div>`;
  }
}

async function saveDisplayName(){const dn=document.getElementById('dn-input')?.value?.trim();if(!dn){toast('Name required','error');return;}CU.displayName=dn;await saveUser();document.getElementById('ua-name').textContent=dn;buildProfileView('myprofile');toast('Display name updated!','success');}
async function saveEmail(){const e=document.getElementById('email-input')?.value?.trim();CU.email=e;await saveUser();toast('Email updated!','success');}
async function changePassword(){const old=document.getElementById('pw-old')?.value,nw=document.getElementById('pw-new')?.value,msg=document.getElementById('pw-msg');if(!old||!nw){if(msg){msg.style.color='var(--red)';msg.textContent='Fill both fields.';}return;}if(old!==CU.password){if(msg){msg.style.color='var(--red)';msg.textContent='Current password incorrect.';}return;}if(nw.length<6){if(msg){msg.style.color='var(--red)';msg.textContent='Too short.';}return;}CU.password=nw;await saveUser();if(msg){msg.style.color='var(--green)';msg.textContent='Password updated!';}document.getElementById('pw-old').value='';document.getElementById('pw-new').value='';}
async function updatePfp(e){const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}const r=new FileReader();r.onload=async ev=>{CU.pfp=ev.target.result;await saveUser();updateUserbar();buildProfileView('myprofile');toast('Avatar updated!','success');};r.readAsDataURL(file);}
async function updateBanner(e){const file=e.target.files[0];if(!file)return;if(file.size>3*1024*1024){toast('Max 3MB','error');return;}const r=new FileReader();r.onload=async ev=>{CU.banner=ev.target.result;await saveUser();buildProfileView('myprofile');toast('Banner updated!','success');};r.readAsDataURL(file);}
async function setMyStatus(s){CU.status=s;try{await FortizedSocial.setStatus(CU.username,s);}catch{}await saveUser();buildProfileView('myprofile');toast(`Status: ${s}`,'info');}
function toggleNotifSetting(key,el){notifSettings[key]=!notifSettings[key];el.classList.toggle('on',notifSettings[key]);}
async function saveNotifSettings(){CU.notifSettings=notifSettings;await saveUser();toast('Notification settings saved!','success');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ATELIER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function claimDaily() {
  const lastClaim=CU.lastDailyReward;
  const now=new Date(); const today=now.toDateString();
  if(lastClaim===today){toast('Already claimed today! Come back tomorrow.','info');return;}
  CU.onyx=(CU.onyx||0)+50; CU.lastDailyReward=today;
  await saveUser(); updateOnyxDisplay();
  const btn=document.getElementById('daily-btn');
  if(btn){btn.classList.add('claimed');btn.innerHTML='<span>‚úì Claimed!</span><strong>+50 Onyx</strong>';}
  toast('üéâ +50 Onyx claimed!','success');
}

async function buyRadiance(days, cost) {
  if((CU.onyx||0)<cost){toast('Not enough Onyx!','error');return;}
  showCustomConfirm(`Buy ${days}-day Radiance for ${cost} Onyx?`, async ()=>{
    CU.onyx=(CU.onyx||0)-cost;
    const until=new Date(); until.setDate(until.getDate()+days);
    CU.radianceUntil=until.toISOString();
    await saveUser(); updateOnyxDisplay();
    toast(`‚ú® Radiance active for ${days} days!`,'success');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function updateNotifBadge() {
  const badge=document.getElementById('notif-badge'); if(!badge) return;
  let notifs=[];
  try { notifs=await FortizedSocial.getNotifications(CU.username)||[]; } catch {}
  const unread=notifs.filter(n=>!n.read).length;
  badge.textContent=unread;
  badge.style.display=unread>0?'flex':'none';
}

async function toggleNotifPanel() {
  notifPanelOpen=!notifPanelOpen;
  const panel=document.getElementById('notif-panel');
  panel.classList.toggle('open',notifPanelOpen);
  if(notifPanelOpen){await buildNotifList();try{await FortizedSocial.markNotificationsRead(CU.username);await updateNotifBadge();}catch{}}
}

async function buildNotifList() {
  const list=document.getElementById('np-list'); if(!list) return;
  let notifs=[];
  try{notifs=await FortizedSocial.getNotifications(CU.username)||[];}catch{}
  if(!notifs.length){list.innerHTML=`<div style="padding:20px;text-align:center;font-size:13px;color:var(--muted);">‚úì All caught up!</div>`;return;}
  list.innerHTML=notifs.slice(0,20).map(n=>{
    let icon='üîî',text='';
    if(n.type==='friend_request'){icon='üë•';text=`<strong>${escapeHTML(n.from)}</strong> sent you a friend request`;}
    else if(n.type==='friend_accept'){icon='ü§ù';text=`<strong>${escapeHTML(n.from)}</strong> accepted your request`;}
    else if(n.type==='dm'){icon='üí¨';text=`<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview||'').slice(0,50))}`;}
    const actions=n.type==='friend_request'?`<div class="np-actions"><button class="np-accept" onclick="acceptFriend('${n.from}');buildNotifList()">Accept</button><button class="np-decline" onclick="declineFriend('${n.from}');buildNotifList()">Decline</button></div>`:'';
    return`<div class="np-item ${n.read?'':'unread'}"><div class="np-icon">${icon}</div><div class="np-text"><p>${text}</p><div class="np-time">${formatTimeAgo(n.time)}</div>${actions}</div></div>`;
  }).join('');
}

async function markAllRead(){try{await FortizedSocial.markNotificationsRead(CU.username);await updateNotifBadge();await buildNotifList();}catch{}}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// USER PROFILE POPUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function viewUserProfile(username) {
  let u=null; try{u=await FortizedSocial.getUserByName(username);}catch{}
  if(!u){toast('User not found','error');return;}
  let status='offline'; try{status=await FortizedSocial.getStatus(username);}catch{}
  const isFriend=(CU.friends||[]).includes(username);
  const hasPending=(CU.friendRequestsSent||[]).includes(username);
  const isOwn=username===CU.username;
  const statusColor={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)'}[status]||'var(--muted)';
  document.getElementById('user-modal-body').innerHTML=`
    <div style="height:80px;background:linear-gradient(135deg,#0f1830,#1a0f30);margin:-26px -26px 16px;overflow:hidden;"><img src="${u.banner||'Profile Banner.png'}" style="width:100%;height:100%;object-fit:cover;" onerror="this.style.display='none'"></div>
    <div style="display:flex;gap:14px;align-items:flex-start;margin-top:-26px;margin-bottom:12px;">
      <div style="width:58px;height:58px;border-radius:50%;background:var(--panel);border:3px solid var(--panel);font-size:22px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;">${buildAvatarHTML(u.pfp,u.displayName||u.username,58)}</div>
      <div style="padding-top:28px;">
        <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">${escapeHTML(u.displayName||u.username)}</div>
        <div style="font-size:12px;color:var(--muted-light);">@${escapeHTML(u.username)}</div>
        <div style="font-size:12px;color:${statusColor};">‚óè ${status}</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button class="btn-a" onclick="closeModal('modal-user');openDMChat('${escapeHTML(u.username)}')" style="flex:1;justify-content:center;font-size:13px;">üí¨ Message</button>
      ${isOwn?'':(isFriend?`<button class="btn-d" onclick="closeModal('modal-user');removeFriend('${u.username}')" style="flex:1;justify-content:center;font-size:13px;">Remove</button>`:(hasPending?`<button class="btn-g" style="flex:1;justify-content:center;font-size:13px;opacity:.7;" disabled>Sent</button>`:`<button class="btn-g" onclick="quickAddFriend('${escapeHTML(u.username)}')" style="flex:1;justify-content:center;font-size:13px;">+ Add Friend</button>`))}
      ${!isOwn?`<button class="btn-d" onclick="reportUser('${escapeHTML(u.username)}')" style="padding:9px 14px;font-size:13px;" title="Report">üö©</button>`:''}
    </div>
    <button class="btn-g" onclick="closeModal('modal-user')" style="width:100%;justify-content:center;margin-top:8px;font-size:13px;">Close</button>`;
  openModal('modal-user');
}

async function quickAddFriend(username) {
  try{const r=await FortizedSocial.sendFriendRequest(CU.username,username);toast(r.msg,r.ok?'success':'error');if(r.ok){await refreshCU();}}catch{toast('Error','error');}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INVITE / AUTH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkInviteLink() {
  const params=new URLSearchParams(location.search);const code=params.get('invite');if(!code)return;
  history.replaceState({},document.title,location.pathname);
  let inv=null;
  try{const b=await FortizedSocial.getGlobalBastions();inv=b?{bastionId:code}:null;}catch{}
  if(inv) await promptJoinPublicBastion(code);
}

async function doLogout() {
  try{await FortizedSocial.logout(CU.username);}catch{}
  localStorage.removeItem('ftz_current');localStorage.removeItem('fortized_current_user');
  window.location.href='login.html';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SEARCH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONTEXT MENU
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function handleContextMenu(e) {
  const menu=document.getElementById('ctx-menu');
  const target=e.target;
  let items=[];
  const msgRow=target.closest('.msg-row');
  const isInput=target.tagName==='TEXTAREA'||target.tagName==='INPUT';

  if(msgRow) {
    const msgId=msgRow.dataset.msgid;
    const text=msgRow.dataset.text||'';
    const isOwn=msgRow.classList.contains('own');
    items=[
      {section:true,label:'Message'},
      {icon:'‚Ü©',label:'Reply',action:()=>replyToMsg(msgId,msgRow.querySelector('.msg-author')?.textContent||'',curDM?'dm':'ch')},
      {icon:'üòä',label:'Add Reaction',action:()=>addReactionUI(msgId,curDM?'dm':'ch')},
      {icon:'‚Ü™',label:'Forward',action:()=>forwardMsg(text)},
      {icon:'üìã',label:'Copy Text',action:()=>navigator.clipboard.writeText(text)},
      {sep:true},
      {icon:'üö©',label:'Report Message',action:()=>reportMessage(msgId,text)},
      ...(isOwn?[{sep:true},{icon:'‚úèÔ∏è',label:'Edit',action:()=>editMsg(msgId,curDM?'dm':'ch')},{icon:'üóëÔ∏è',label:'Delete',danger:true,action:()=>deleteMsg(msgId,curDM?'dm':'ch')}]:[]),
    ];
  } else if(isInput) {
    items=[
      {icon:'üìã',label:'Paste',action:async()=>{const t=await navigator.clipboard.readText();target.value+=t;}},
      {icon:'üìÑ',label:'Copy',action:()=>navigator.clipboard.writeText(target.value)},
      {icon:'‚òëÔ∏è',label:'Select All',action:()=>{target.select();}},
    ];
  } else {
    items=[
      {icon:'üè†',label:'Go Home',action:()=>showView('home')},
      {icon:'üîÑ',label:'Refresh',action:()=>location.reload()},
    ];
    if(window.getSelection()?.toString()) items.unshift({icon:'üìã',label:'Copy Selection',action:()=>navigator.clipboard.writeText(window.getSelection().toString())});
  }

  showCtxMenu(e.clientX,e.clientY,items);
}

function showCtxMenu(x,y,items) {
  const menu=document.getElementById('ctx-menu');
  menu.style.display='block';menu.innerHTML='';
  items.forEach(item=>{
    if(item.sep){const s=document.createElement('div');s.className='ctx-sep';menu.appendChild(s);}
    else if(item.section){const l=document.createElement('div');l.className='ctx-section-label';l.textContent=item.label;menu.appendChild(l);}
    else{const el=document.createElement('div');el.className='ctx-item'+(item.danger?' danger':'');el.innerHTML=`<span>${item.icon||''}</span><span>${item.label}</span>`;if(item.action)el.onclick=e=>{e.stopPropagation();item.action();menu.style.display='none';};menu.appendChild(el);}
  });
  menu.style.left=x+'px';menu.style.top=y+'px';
  requestAnimationFrame(()=>{
    const r=menu.getBoundingClientRect();
    if(r.right>window.innerWidth)menu.style.left=(x-r.width)+'px';
    if(r.bottom>window.innerHeight)menu.style.top=(y-r.height)+'px';
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CUSTOM DIALOGS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showCustomInput(title,message,callback,defaultValue=''){
  const overlay=document.createElement('div');overlay.className='input-dialog-overlay';
  overlay.innerHTML=`<div class="input-dialog"><h3>${escapeHTML(title)}</h3><p>${escapeHTML(message)}</p><input type="text" id="cid-field" value="${escapeHTML(defaultValue)}" placeholder="Type here‚Ä¶"><div class="input-dialog-actions"><button class="btn-g" style="flex:1;justify-content:center;" id="cid-cancel">Cancel</button><button class="btn-a" style="flex:1;justify-content:center;" id="cid-ok">OK</button></div></div>`;
  document.body.appendChild(overlay);
  const inp=document.getElementById('cid-field');
  const ok=document.getElementById('cid-ok');
  const cancel=document.getElementById('cid-cancel');
  if(inp)inp.focus();
  ok.onclick=()=>{const v=inp.value;overlay.remove();callback(v);};
  cancel.onclick=()=>overlay.remove();
  inp.addEventListener('keydown',e=>{if(e.key==='Enter')ok.click();if(e.key==='Escape')cancel.click();});
}

function showCustomConfirm(message,callback){
  const overlay=document.createElement('div');overlay.className='input-dialog-overlay';
  overlay.innerHTML=`<div class="input-dialog"><h3>Confirm</h3><p>${escapeHTML(message)}</p><div class="input-dialog-actions"><button class="btn-g" style="flex:1;justify-content:center;" id="cc-cancel">Cancel</button><button class="btn-d" style="flex:1;justify-content:center;" id="cc-ok">Confirm</button></div></div>`;
  document.body.appendChild(overlay);
  document.getElementById('cc-ok').onclick=()=>{overlay.remove();callback();};
  document.getElementById('cc-cancel').onclick=()=>overlay.remove();
  overlay.addEventListener('keydown',e=>{if(e.key==='Escape')overlay.remove();});
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// MODALS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(id){const el=document.getElementById(id);if(el)el.classList.add('open');}
function closeModal(id){const el=document.getElementById(id);if(el)el.classList.remove('open');}
document.addEventListener('click',e=>{if(e.target.classList.contains('modal-overlay'))e.target.classList.remove('open');});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let toastTimer=null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function hasPerm(perm){
  if(!CU||curBastion===null)return false;
  const b=CU.bastions[curBastion];if(!b)return false;
  if(b.owner===CU.username)return true;
  const memberRoles=(b.memberRoles||{})[CU.username]||[];
  return memberRoles.some(rid=>(b.roles||[]).find(r=>r.id===rid)?.permissions?.includes(perm));
}




// AGE PROTECTION SYSTEM



function getAgeTier(dateOfBirth) {
  if (!dateOfBirth) return AGE_TIERS.TEEN; // default to safe
  const dob = new Date(dateOfBirth);
  const now = new Date();
  let age = now.getFullYear() - dob.getFullYear();
  const m = now.getMonth() - dob.getMonth();
  if (m < 0 || (m === 0 && now.getDate() < dob.getDate())) age--;
  if (age < 13) return null; // under 13, not allowed
  if (age <= 15) return AGE_TIERS.CHILD;
  if (age <= 17) return AGE_TIERS.TEEN;
  return AGE_TIERS.ADULT;
}

function canViewNSFW() {
  const tier = getAgeTier(CU?.dateOfBirth);
  return tier === AGE_TIERS.ADULT;
}

function canAccessNSFWWithFriction() {
  const tier = getAgeTier(CU?.dateOfBirth);
  return tier === AGE_TIERS.TEEN;
}

function checkNSFWAccess(channelOrBastion) {
  if (!channelOrBastion?.nsfw) return true; // not NSFW, always ok
  const tier = getAgeTier(CU?.dateOfBirth);
  if (tier === AGE_TIERS.CHILD) return false; // absolute block
  if (tier === AGE_TIERS.TEEN) return null; // friction required
  return true; // adult
}

function renderNSFWGate(contentEl, channelName) {
  const tier = getAgeTier(CU?.dateOfBirth);
  if (tier === AGE_TIERS.CHILD) {
    contentEl.innerHTML = `
      <div class="empty-state" style="background:rgba(248,113,113,.04);border:1px solid rgba(248,113,113,.15);border-radius:18px;padding:40px;margin:20px;">
        <div class="ei" style="font-size:40px;">üîí</div>
        <h3 style="color:var(--red);">Age-Restricted Content</h3>
        <p>This channel contains content not suitable for your age group. Access is restricted for your protection.</p>
      </div>`;
    return;
  }
  if (tier === AGE_TIERS.TEEN) {
    contentEl.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:40px;text-align:center;">
        <div style="font-size:48px;margin-bottom:16px;filter:blur(2px);">üîû</div>
        <h3 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:8px;">Sensitive Content</h3>
        <p style="font-size:13.5px;color:var(--muted-light);max-width:320px;line-height:1.6;margin-bottom:20px;">
          This channel has been marked as containing sensitive content. By proceeding, you confirm that you understand the nature of this content.
        </p>
        <div style="background:rgba(248,113,113,.08);border:1px solid rgba(248,113,113,.2);border-radius:14px;padding:16px;max-width:320px;font-size:12.5px;color:var(--red);margin-bottom:20px;">
          ‚ö†Ô∏è This action is logged for platform safety compliance.
        </div>
        <button class="btn-d" onclick="confirmNSFWView()" style="padding:12px 24px;">View Sensitive Content</button>
        <button class="btn-g" onclick="openBastion(curBastion)" style="margin-top:8px;font-size:13px;">Go Back</button>
      </div>`;
    return;
  }
}

function confirmNSFWView() {
  // Log the action internally
  const logEntry = { user: CU.username, action: 'nsfw_view_confirmed', tier: getAgeTier(CU?.dateOfBirth), timestamp: new Date().toISOString() };
  console.log('[SAFETY LOG]', logEntry);
  // Proceed with loading channel
  if (curChannel !== null) loadChannelMessages(curChannel);
}


// REPORT SYSTEM




function reportMessage(msgId, msgText) {
  activeReportData = { type: 'message', msgId, msgText, reportedAt: new Date().toISOString() };
  showReportModal();
}

function reportUser(username) {
  activeReportData = { type: 'user', username, reportedAt: new Date().toISOString() };
  showReportModal();
}

function showReportModal() {
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay open';
  overlay.id = 'modal-report-dynamic';
  overlay.innerHTML = `
    <div class="modal">
      <div class="modal-bar"></div>
      <div class="modal-body">
        <div class="modal-title">üö© Report Content</div>
        <div class="modal-sub">Help us keep Fortized safe. Your report is anonymous.</div>
        ${activeReportData?.msgText ? `<div style="background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-size:13px;color:var(--muted-light);margin-bottom:16px;border-left:3px solid var(--red);">"${escapeHTML(activeReportData.msgText.slice(0,120))}${activeReportData.msgText.length>120?'‚Ä¶':''}"</div>`:''}
        <div class="settings-title">Reason</div>
        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:14px;">
          ${REPORT_REASONS.map((r,i)=>`
            <label style="display:flex;align-items:center;gap:10px;padding:9px 14px;background:var(--panel);border:1.5px solid var(--border);border-radius:11px;cursor:pointer;transition:border-color .1s;" id="rr-label-${i}">
              <input type="radio" name="report-reason" value="${r}" onchange="selectReportReason(${i})">
              <span style="font-size:13.5px;">${r}</span>
            </label>`).join('')}
        </div>
        <div class="settings-title">Additional Context (optional)</div>
        <textarea class="field-input" id="report-context" placeholder="Describe what happened‚Ä¶" rows="3" style="resize:none;margin-bottom:14px;"></textarea>
        <div class="modal-error" id="report-error"></div>
        <div class="modal-actions">
          <button class="btn-g" onclick="this.closest('.modal-overlay').remove()">Cancel</button>
          <button class="btn-d" onclick="submitReport()">Submit Report</button>
        </div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
}

function selectReportReason(idx) {
  document.querySelectorAll('[id^="rr-label-"]').forEach((el,i)=>{
    el.style.borderColor = i===idx ? 'var(--red)' : 'var(--border)';
  });
}

async function submitReport() {
  const selected = document.querySelector('input[name="report-reason"]:checked');
  const err = document.getElementById('report-error');
  if (!selected) { if(err) err.textContent='Please select a reason'; return; }
  const context = document.getElementById('report-context')?.value || '';

  const report = {
    id: 'rpt_' + Date.now(),
    reporter: CU.username,
    reason: selected.value,
    context,
    ...activeReportData,
    status: 'pending',
    createdAt: new Date().toISOString(),
    bastionId: curBastion !== null ? CU.bastions[curBastion]?.name : null,
  };

  // Save to Firebase reports queue
  try {
    await FortizedSocial.submitReport?.(report);
  } catch {
    // Store locally as fallback
    const existing = JSON.parse(localStorage.getItem('ftz_reports')||'[]');
    existing.push(report);
    localStorage.setItem('ftz_reports', JSON.stringify(existing));
  }

  document.getElementById('modal-report-dynamic')?.remove();
  activeReportData = null;
  toast('‚úÖ Report submitted. Thank you for keeping Fortized safe.', 'success');
}


// ADMIN PANEL

// Super admin: "staw" (default admin who can add other admins)
// Access: secret code 1478

function tryOpenAdmin() {
  if (adminAuthed) {
    openAdminPanel();
    return;
  }
  showCustomInput('üõ° Admin Access', 'Enter the admin access code:', (code) => {
    if (code === '1478') {
      // Check if user is admin
      const admins = JSON.parse(localStorage.getItem('ftz_admins') || '["staw"]');
      if (!admins.includes(CU.username)) {
        toast('‚ùå Access denied ‚Äî you are not an administrator.', 'error');
        return;
      }
      adminAuthed = true;
      openAdminPanel();
    } else {
      toast('‚ùå Invalid access code.', 'error');
    }
  });
}


function openAdminPanel() {
  // Create fullscreen admin overlay
  let existing = document.getElementById('admin-panel-overlay');
  if (existing) { existing.style.display = 'flex'; renderAdminPanel(); return; }

  const overlay = document.createElement('div');
  overlay.id = 'admin-panel-overlay';
  overlay.style.cssText = `position:fixed;inset:0;background:var(--bg);z-index:8000;display:flex;flex-direction:column;`;
  overlay.innerHTML = `
    <div style="height:52px;background:rgba(0,0,0,.6);border-bottom:1px solid rgba(248,113,113,.2);display:flex;align-items:center;padding:0 20px;gap:12px;flex-shrink:0;">
      <div style="width:8px;height:8px;border-radius:50%;background:var(--red);"></div>
      <span style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800;color:var(--red);">FORTIZED ADMIN PANEL</span>
      <span style="font-size:12px;color:var(--muted);">Logged in as: ${escapeHTML(CU.username)}${isSuperAdmin()?' üëë':''}</span>
      <div style="flex:1;"></div>
      <button onclick="document.getElementById('admin-panel-overlay').style.display='none'" style="background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:var(--red);padding:6px 14px;border-radius:9px;cursor:pointer;font-size:13px;">‚úï Exit</button>
    </div>
    <div style="display:flex;flex:1;overflow:hidden;">
      <div id="admin-sidebar" style="width:220px;min-width:220px;border-right:1px solid rgba(248,113,113,.1);background:rgba(248,113,113,.02);overflow-y:auto;padding:12px 0;"></div>
      <div id="admin-main" style="flex:1;overflow-y:auto;padding:28px;"></div>
    </div>`;
  document.body.appendChild(overlay);
  renderAdminPanel();
}

function renderAdminPanel() {
  const sidebar = document.getElementById('admin-sidebar');
  const tabs = [
    {id:'dashboard',icon:'üìä',label:'Dashboard'},
    {id:'users',icon:'üë§',label:'User Management'},
    {id:'reports',icon:'üö©',label:'Reports Queue'},
    {id:'nsfw_queue',icon:'üîû',label:'NSFW Review Queue'},
    {id:'bastions',icon:'üè∞',label:'Bastions'},
    {id:'audit',icon:'üìã',label:'Audit Log'},
    ...(isSuperAdmin() ? [{id:'admins',icon:'üëë',label:'Admin Management'}] : []),
    {id:'economy',icon:'üí∞',label:'Onyx Economy'},
  ];
  sidebar.innerHTML = `<div style="font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(248,113,113,.6);padding:8px 14px;">Navigation</div>` +
    tabs.map(t=>`<div class="bsettings-nav-item" onclick="loadAdminTab('${t.id}')" style="color:${adminTab===t.id?'var(--red)':'var(--muted-light)'}; background:${adminTab===t.id?'rgba(248,113,113,.08)':''};">${t.icon} ${t.label}</div>`).join('');
  loadAdminTab(adminTab);
}

async function loadAdminTab(tab) {
  adminTab = tab;
  // Update sidebar highlight
  document.querySelectorAll('#admin-sidebar .bsettings-nav-item').forEach(el => {
    const isActive = el.textContent.trim().includes(tab.split('_').map(w=>w[0].toUpperCase()+w.slice(1)).join(' ')) ||
      (tab==='dashboard'&&el.textContent.includes('Dashboard')) ||
      (tab==='nsfw_queue'&&el.textContent.includes('NSFW'));
    el.style.color = isActive ? 'var(--red)' : 'var(--muted-light)';
    el.style.background = isActive ? 'rgba(248,113,113,.08)' : '';
  });

  const main = document.getElementById('admin-main');
  if (!main) return;

  if (tab === 'dashboard') {
    // Load stats
    let totalUsers = '‚Äî', activeUsers = '‚Äî';
    const reports = JSON.parse(localStorage.getItem('ftz_reports') || '[]');
    const pendingReports = reports.filter(r=>r.status==='pending').length;
    const bannedUsers = JSON.parse(localStorage.getItem('ftz_bans') || '[]');

    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üìä Dashboard Overview</div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:28px;">
        ${[
          ['Total Users','üë§','Loading‚Ä¶',''],
          ['Active (24h)','üü¢','Loading‚Ä¶',''],
          ['Pending Reports','üö©',pendingReports,pendingReports>0?'color:var(--red)':''],
          ['Banned Users','üî®',bannedUsers.length,''],
        ].map(([label,icon,val,style])=>`
          <div style="background:var(--panel);border:1px solid rgba(248,113,113,.12);border-radius:18px;padding:20px 16px;">
            <div style="font-size:28px;margin-bottom:8px;">${icon}</div>
            <div style="font-family:'Syne',sans-serif;font-size:26px;font-weight:800;${style}">${val}</div>
            <div style="font-size:12px;color:var(--muted);">${label}</div>
          </div>`).join('')}
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:14px;color:var(--red);">üö© Recent Reports</div>
          ${reports.slice(0,5).map(r=>`<div style="padding:8px 10px;background:var(--panel2);border-radius:10px;margin-bottom:6px;font-size:12.5px;">
            <div style="font-weight:600;">${escapeHTML(r.reason)}</div>
            <div style="color:var(--muted);font-size:11px;">By: ${escapeHTML(r.reporter)} ¬∑ ${formatTimeAgo(r.createdAt)}</div>
          </div>`).join('') || '<div style="color:var(--muted);font-size:13px;">No reports yet</div>'}
        </div>
        <div style="background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:20px;">
          <div style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:14px;color:var(--red);">üìã Quick Actions</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn-d" style="justify-content:flex-start;" onclick="loadAdminTab('users')">üë§ Search a User</button>
            <button class="btn-d" style="justify-content:flex-start;" onclick="loadAdminTab('reports')">üö© Review Reports</button>
            <button class="btn-d" style="justify-content:flex-start;" onclick="loadAdminTab('nsfw_queue')">üîû NSFW Queue</button>
          </div>
        </div>
      </div>`;
  }

  else if (tab === 'users') {
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üë§ User Management</div>
      <div style="display:flex;gap:10px;margin-bottom:20px;">
        <input id="admin-user-search" class="field-input" placeholder="Search by username‚Ä¶" style="max-width:320px;" onkeydown="if(event.key==='Enter')adminSearchUser()">
        <button class="btn-d" onclick="adminSearchUser()">Search</button>
      </div>
      <div id="admin-user-result"></div>`;
  }

  else if (tab === 'reports') {
    const reports = JSON.parse(localStorage.getItem('ftz_reports') || '[]');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üö© Reports Queue</div>
      ${!reports.length ? '<div class="empty-state"><div class="ei">‚úÖ</div><h3>No pending reports</h3></div>' :
        reports.map((r,i)=>`
          <div style="background:var(--panel);border:1px solid ${r.status==='pending'?'rgba(248,113,113,.3)':'var(--border)'};border-radius:16px;padding:18px;margin-bottom:12px;">
            <div style="display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;">
              <div style="background:rgba(248,113,113,.1);border-radius:10px;padding:10px;font-size:20px;">üö©</div>
              <div style="flex:1;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
                  <span style="font-weight:700;font-size:14px;">${escapeHTML(r.reason)}</span>
                  <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:100px;background:${r.status==='pending'?'rgba(248,113,113,.15)':'rgba(62,207,110,.1)'};color:${r.status==='pending'?'var(--red)':'var(--green)'};">${r.status.toUpperCase()}</span>
                </div>
                <div style="font-size:12px;color:var(--muted);">Reported by: <strong>${escapeHTML(r.reporter)}</strong> ¬∑ ${formatTimeAgo(r.createdAt)}</div>
                ${r.msgText?`<div style="font-size:12.5px;background:rgba(0,0,0,.2);padding:8px 12px;border-radius:8px;margin-top:8px;color:var(--muted-light);border-left:3px solid var(--red);">"${escapeHTML(r.msgText.slice(0,200))}"</div>`:''}
                ${r.username?`<div style="font-size:12.5px;margin-top:6px;">Reported user: <strong>${escapeHTML(r.username)}</strong></div>`:''}
                ${r.context?`<div style="font-size:12px;color:var(--muted);margin-top:6px;">Context: ${escapeHTML(r.context)}</div>`:''}
              </div>
            </div>
            ${r.status==='pending'?`
              <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button class="btn-g" style="font-size:12px;padding:6px 12px;" onclick="resolveReport(${i},'dismissed')">Dismiss</button>
                <button class="btn-d" style="font-size:12px;padding:6px 12px;" onclick="resolveReport(${i},'warned')">Warn User</button>
                <button class="btn-d" style="font-size:12px;padding:6px 12px;" onclick="resolveReport(${i},'suspended')">Suspend</button>
                <button class="btn-d" style="font-size:12px;padding:6px 12px;background:rgba(248,113,113,.2);" onclick="resolveReport(${i},'banned')">Permanent Ban</button>
              </div>`:'<div style="font-size:12px;color:var(--muted);">Resolved: '+r.resolution+'</div>'}
          </div>`).join('')}`;
  }

  else if (tab === 'nsfw_queue') {
    const queue = JSON.parse(localStorage.getItem('ftz_nsfw_queue') || '[]');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üîû NSFW Review Queue</div>
      <div style="background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);border-radius:14px;padding:14px 18px;margin-bottom:20px;font-size:13.5px;color:var(--muted-light);">
        ü§ñ Uploads are scanned by an AI classifier and flagged here for human review. All moderator decisions are logged.
      </div>
      ${!queue.length ? `
        <div class="empty-state"><div class="ei">‚úÖ</div><h3>Queue is clear!</h3><p>All flagged content has been reviewed.</p></div>` :
        queue.map((item,i)=>`
          <div style="background:var(--panel);border:1px solid rgba(248,113,113,.2);border-radius:16px;padding:18px;margin-bottom:12px;">
            <div style="display:flex;gap:12px;align-items:flex-start;">
              <div style="width:80px;height:80px;border-radius:12px;background:var(--panel2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:24px;flex-shrink:0;overflow:hidden;">
                ${item.data?`<img src="${item.data}" style="width:100%;height:100%;object-fit:cover;border-radius:10px;filter:blur(8px);" title="Blurred for review">`:'üñºÔ∏è'}
              </div>
              <div style="flex:1;">
                <div style="font-weight:700;margin-bottom:4px;">Flagged Upload</div>
                <div style="font-size:12px;color:var(--muted);">User: <strong>${escapeHTML(item.uploader)}</strong> ¬∑ Type: ${item.type||'image'}</div>
                <div style="font-size:12px;color:var(--muted);">AI Score: <strong style="color:var(--red);">${item.aiScore||'N/A'}</strong> ¬∑ ${formatTimeAgo(item.createdAt)}</div>
                <div style="font-size:11px;padding:3px 8px;border-radius:100px;display:inline-flex;margin-top:6px;background:rgba(248,113,113,.12);color:var(--red);font-weight:700;">${item.aiLabel||'SUGGESTIVE'}</div>
              </div>
            </div>
            <div style="display:flex;gap:8px;margin-top:14px;flex-wrap:wrap;">
              <button class="btn-g" style="font-size:12px;padding:6px 12px;" onclick="reviewNSFW(${i},'approve')">‚úÖ Approve</button>
              <button class="btn-d" style="font-size:12px;padding:6px 12px;" onclick="reviewNSFW(${i},'restrict')">üîû Restrict to 18+</button>
              <button class="btn-d" style="font-size:12px;padding:6px 12px;background:rgba(248,113,113,.2);" onclick="reviewNSFW(${i},'remove')">üóëÔ∏è Remove</button>
              <button class="btn-d" style="font-size:12px;padding:6px 12px;" onclick="reviewNSFW(${i},'warn')">‚ö†Ô∏è Warn User</button>
            </div>
          </div>`).join('')}`;
  }

  else if (tab === 'admins' && isSuperAdmin()) {
    const admins = JSON.parse(localStorage.getItem('ftz_admins') || '["staw"]');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üëë Admin Management</div>
      <div style="background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);border-radius:14px;padding:14px 18px;margin-bottom:20px;font-size:13.5px;color:var(--muted-light);">
        Only <strong style="color:var(--red);">staw</strong> (Super Admin) can manage the admin roster. All changes are logged.
      </div>
      <div style="display:flex;gap:10px;margin-bottom:20px;">
        <input id="new-admin-input" class="field-input" placeholder="Username to make admin‚Ä¶" style="max-width:280px;">
        <button class="btn-d" onclick="addAdmin()">Add Admin</button>
      </div>
      <div style="font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--muted);margin-bottom:12px;letter-spacing:.05em;text-transform:uppercase;">Current Admins (${admins.length})</div>
      ${admins.map((a,i)=>`
        <div style="display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;">
          <span style="font-size:18px;">${a===SUPER_ADMIN?'üëë':'üõ°Ô∏è'}</span>
          <span style="font-weight:600;flex:1;">${escapeHTML(a)}</span>
          ${a===SUPER_ADMIN?`<span style="font-size:11px;color:var(--accent);font-weight:700;">SUPER ADMIN</span>`:''}
          ${a!==SUPER_ADMIN?`<button class="btn-d" style="font-size:12px;padding:5px 10px;" onclick="removeAdmin(${i})">Remove</button>`:''}
        </div>`).join('')}`;
  }

  else if (tab === 'audit') {
    const log = JSON.parse(localStorage.getItem('ftz_audit_log') || '[]');
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üìã Audit Log</div>
      <div style="font-size:13.5px;color:var(--muted-light);margin-bottom:16px;">All admin actions are permanently logged and cannot be deleted.</div>
      ${!log.length ? '<div style="color:var(--muted);font-size:13.5px;">No actions logged yet.</div>' :
        [...log].reverse().map(entry=>`
          <div style="padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:6px;display:flex;gap:12px;align-items:center;">
            <div style="width:8px;height:8px;border-radius:50%;background:${entry.type==='ban'?'var(--red)':entry.type==='warn'?'var(--yellow)':'var(--muted)'};flex-shrink:0;"></div>
            <div style="flex:1;">
              <span style="font-weight:600;">${escapeHTML(entry.admin)}</span>
              <span style="color:var(--muted);"> ‚Üí </span>
              <span>${entry.action}</span>
              <span style="color:var(--muted);"> on </span>
              <span style="font-weight:600;">${escapeHTML(entry.target||'')}</span>
              ${entry.reason?`<div style="font-size:11.5px;color:var(--muted);margin-top:2px;">Reason: ${escapeHTML(entry.reason)}</div>`:''}
            </div>
            <div style="font-size:11px;color:var(--muted);">${formatTimeAgo(entry.timestamp)}</div>
          </div>`).join('')}`;
  }

  else if (tab === 'economy') {
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üí∞ Onyx Economy</div>
      <div style="background:rgba(248,113,113,.06);border:1px solid rgba(248,113,113,.15);border-radius:14px;padding:14px 18px;margin-bottom:20px;font-size:13.5px;color:var(--muted-light);">
        ‚ö†Ô∏è All Onyx adjustments require a reason. Every transaction is logged in the Audit Log.
      </div>
      <div style="display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
        <input id="eco-username" class="field-input" placeholder="Username" style="max-width:200px;">
        <input id="eco-amount" class="field-input" type="number" placeholder="Amount" style="max-width:120px;">
        <input id="eco-reason" class="field-input" placeholder="Reason (required)" style="max-width:240px;">
        <button class="btn-d" onclick="adjustOnyx(1)">‚ûï Give Onyx</button>
        <button class="btn-d" onclick="adjustOnyx(-1)">‚ûñ Remove Onyx</button>
      </div>
      <div style="font-size:13px;color:var(--muted);">Note: Onyx adjustments apply to the target user's next session (Firebase sync required).</div>`;
  }

  else if (tab === 'bastions') {
    main.innerHTML = `
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:24px;color:var(--red);">üè∞ Bastions</div>
      <div style="display:flex;gap:10px;margin-bottom:20px;">
        <input id="admin-bastion-search" class="field-input" placeholder="Search bastions‚Ä¶" style="max-width:320px;">
        <button class="btn-d" onclick="adminSearchBastion()">Search</button>
      </div>
      <div id="admin-bastion-result"><div style="color:var(--muted);font-size:13.5px;">Search for a bastion to inspect it.</div></div>`;
  }
  else {
    main.innerHTML = `<div class="empty-state"><div class="ei">üöß</div><h3>Coming Soon</h3></div>`;
  }
}

// Admin actions
async function adminSearchUser() {
  const username = document.getElementById('admin-user-search')?.value?.trim();
  if (!username) return;
  const result = document.getElementById('admin-user-result');
  result.innerHTML = '<div style="color:var(--muted);">Searching‚Ä¶</div>';
  let u = null;
  try { u = await FortizedSocial.getUserByName(username); } catch {}
  if (!u) { result.innerHTML = '<div style="color:var(--red);">User not found.</div>'; return; }
  const bans = JSON.parse(localStorage.getItem('ftz_bans')||'[]');
  const isBanned = bans.some(b=>b.username===username);
  const ageTier = getAgeTier(u.dateOfBirth);

  result.innerHTML = `
    <div style="background:var(--panel);border:1px solid rgba(248,113,113,.2);border-radius:18px;padding:22px;max-width:600px;">
      <div style="display:flex;gap:14px;align-items:center;margin-bottom:16px;">
        <div style="width:52px;height:52px;border-radius:50%;background:var(--panel2);border:2px solid var(--border);font-size:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;">${buildAvatarHTML(u.pfp,u.displayName||u.username,52)}</div>
        <div>
          <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">${escapeHTML(u.displayName||u.username)}</div>
          <div style="font-size:12px;color:var(--muted);">@${escapeHTML(u.username)}</div>
          ${isBanned?`<span style="font-size:10px;font-weight:700;background:rgba(248,113,113,.15);color:var(--red);padding:2px 8px;border-radius:100px;">BANNED</span>`:''}
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;font-size:13px;">
        <div><span style="color:var(--muted);">Age Tier:</span> <strong>${ageTier||'Unknown'}</strong></div>
        <div><span style="color:var(--muted);">Onyx:</span> <strong>${u.onyx||0}</strong></div>
        <div><span style="color:var(--muted);">Bastions:</span> <strong>${(u.bastions||[]).length}</strong></div>
        <div><span style="color:var(--muted);">Friends:</span> <strong>${(u.friends||[]).length}</strong></div>
        <div><span style="color:var(--muted);">Radiance:</span> <strong>${u.radianceUntil&&new Date(u.radianceUntil)>new Date()?'Active':'None'}</strong></div>
        <div><span style="color:var(--muted);">Email:</span> <strong>${u.email?u.email.replace(/(.{2}).+(@.+)/,'$1***$2'):'N/A'}</strong></div>
      </div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button class="btn-d" style="font-size:12px;padding:7px 13px;" onclick="adminActionUser('${escapeHTML(username)}','warn')">‚ö†Ô∏è Issue Warning</button>
        <button class="btn-d" style="font-size:12px;padding:7px 13px;" onclick="adminActionUser('${escapeHTML(username)}','suspend')">‚è∏ Suspend</button>
        ${isBanned?
          `<button class="btn-g" style="font-size:12px;padding:7px 13px;" onclick="adminActionUser('${escapeHTML(username)}','unban')">‚úÖ Unban</button>`:
          `<button class="btn-d" style="font-size:12px;padding:7px 13px;background:rgba(248,113,113,.2);" onclick="adminActionUser('${escapeHTML(username)}','ban')">üî® Permanent Ban</button>`}
      </div>
    </div>`;
}

function adminActionUser(username, action) {
  if (action === 'ban') {
    showCustomInput('Reason for Ban', 'Enter reason (required):', (reason) => {
      if (!reason?.trim()) { toast('Reason required', 'error'); return; }
      const bans = JSON.parse(localStorage.getItem('ftz_bans')||'[]');
      bans.push({ username, reason, bannedBy: CU.username, bannedAt: new Date().toISOString() });
      localStorage.setItem('ftz_bans', JSON.stringify(bans));
      logAudit('ban', username, reason);
      toast(`${username} has been banned`, 'success');
      adminSearchUser();
    });
  } else if (action === 'unban') {
    const bans = JSON.parse(localStorage.getItem('ftz_bans')||'[]');
    const updated = bans.filter(b=>b.username!==username);
    localStorage.setItem('ftz_bans', JSON.stringify(updated));
    logAudit('unban', username, 'Lifted by admin');
    toast(`${username} has been unbanned`, 'success');
    adminSearchUser();
  } else if (action === 'warn') {
    showCustomInput('Warning Message', 'Enter warning reason:', (reason) => {
      if (!reason?.trim()) return;
      logAudit('warn', username, reason);
      toast(`Warning issued to ${username}`, 'success');
    });
  } else if (action === 'suspend') {
    showCustomInput('Suspension Duration', 'Hours to suspend (e.g. 24):', (hours) => {
      logAudit('suspend', username, `${hours}h suspension`);
      toast(`${username} suspended for ${hours}h`, 'success');
    });
  }
}

function resolveReport(idx, action) {
  const reports = JSON.parse(localStorage.getItem('ftz_reports')||'[]');
  if (!reports[idx]) return;
  showCustomInput('Resolution Reason', 'Enter reason for this action:', (reason) => {
    reports[idx].status = 'resolved';
    reports[idx].resolution = action;
    reports[idx].resolvedBy = CU.username;
    reports[idx].resolvedAt = new Date().toISOString();
    localStorage.setItem('ftz_reports', JSON.stringify(reports));
    logAudit('report_'+action, reports[idx].reporter, reason||action);
    if (action === 'banned' || action === 'suspended') {
      const target = reports[idx].username || reports[idx].reporter;
      if (target) adminActionUser(target, action === 'banned' ? 'ban' : 'suspend');
    }
    toast(`Report resolved: ${action}`, 'success');
    loadAdminTab('reports');
  });
}

function reviewNSFW(idx, action) {
  const queue = JSON.parse(localStorage.getItem('ftz_nsfw_queue')||'[]');
  if (!queue[idx]) return;
  showCustomInput('Review Note', 'Add a note (optional):', (note) => {
    logAudit('nsfw_'+action, queue[idx].uploader, note||action);
    if (action === 'warn') adminActionUser(queue[idx].uploader, 'warn');
    queue.splice(idx, 1);
    localStorage.setItem('ftz_nsfw_queue', JSON.stringify(queue));
    toast(`Content ${action}d`, 'success');
    loadAdminTab('nsfw_queue');
  });
}

function addAdmin() {
  const username = document.getElementById('new-admin-input')?.value?.trim();
  if (!username) { toast('Enter a username', 'error'); return; }
  const admins = JSON.parse(localStorage.getItem('ftz_admins')||'["staw"]');
  if (admins.includes(username)) { toast('Already an admin', 'error'); return; }
  showCustomConfirm(`Make ${username} a platform admin?`, () => {
    admins.push(username);
    localStorage.setItem('ftz_admins', JSON.stringify(admins));
    logAudit('add_admin', username, 'Added by super admin');
    toast(`${username} is now an admin`, 'success');
    loadAdminTab('admins');
  });
}

function removeAdmin(idx) {
  const admins = JSON.parse(localStorage.getItem('ftz_admins')||'["staw"]');
  const username = admins[idx];
  if (username === SUPER_ADMIN) { toast('Cannot remove super admin', 'error'); return; }
  showCustomConfirm(`Remove ${username} from admins?`, () => {
    admins.splice(idx, 1);
    localStorage.setItem('ftz_admins', JSON.stringify(admins));
    logAudit('remove_admin', username, 'Removed by super admin');
    toast(`${username} removed from admins`, 'success');
    loadAdminTab('admins');
  });
}

function adjustOnyx(direction) {
  const username = document.getElementById('eco-username')?.value?.trim();
  const amount = parseInt(document.getElementById('eco-amount')?.value);
  const reason = document.getElementById('eco-reason')?.value?.trim();
  if (!username || !amount || !reason) { toast('All fields required', 'error'); return; }
  const finalAmount = Math.abs(amount) * direction;
  logAudit('onyx_adjust', username, `${direction>0?'+':''}${finalAmount} Onyx ‚Äî ${reason}`);
  toast(`Logged: ${finalAmount > 0 ? '+' : ''}${finalAmount} Onyx to ${username}`, 'success');
}


async function adminSearchBastion() {
  const q = document.getElementById('admin-bastion-search')?.value?.trim();
  if (!q) return;
  const result = document.getElementById('admin-bastion-result');
  result.innerHTML = 'Searching‚Ä¶';
  try {
    const bastions = await FortizedSocial.getGlobalBastions()||[];
    const found = bastions.filter(b=>(b.name||'').toLowerCase().includes(q.toLowerCase()));
    if (!found.length) { result.innerHTML='<div style="color:var(--red);">No bastions found.</div>'; return; }
    result.innerHTML = found.map(b=>`
      <div style="background:var(--panel);border:1px solid rgba(248,113,113,.2);border-radius:14px;padding:16px;margin-bottom:10px;display:flex;gap:12px;align-items:center;">
        <div style="font-size:28px;">${b.emblem||'üè∞'}</div>
        <div style="flex:1;">
          <div style="font-weight:700;">${escapeHTML(b.name)}</div>
          <div style="font-size:12px;color:var(--muted);">Owner: ${escapeHTML(b.owner)} ¬∑ ${b.public?'Public':'Private'} ¬∑ ${b.memberCount||0} members</div>
        </div>
        <button class="btn-d" style="font-size:12px;padding:6px 12px;" onclick="logAudit('bastion_review','${escapeHTML(b.name)}','Manual inspection')">Flag</button>
      </div>`).join('');
  } catch { result.innerHTML='<div style="color:var(--red);">Error fetching bastions.</div>'; }
}


// HUMAN VERIFICATION QUIZ


function showVerifyQuiz() {
  document.getElementById('verify-overlay')?.remove();
  const overlay = document.createElement('div');
  overlay.id = 'verify-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(4,6,10,.97);backdrop-filter:blur(24px);z-index:9000;display:flex;align-items:center;justify-content:center;padding:20px;';
  overlay.innerHTML = `
    <div style="background:var(--panel);border:1px solid var(--border);border-radius:28px;width:100%;max-width:520px;overflow:hidden;box-shadow:0 40px 120px rgba(0,0,0,.8);">
      <div style="height:3px;background:linear-gradient(90deg,transparent,var(--accent),transparent);"></div>
      <div style="padding:36px 40px 40px;">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:28px;">
          <div style="width:52px;height:52px;background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.15);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:26px;flex-shrink:0;">üõ°Ô∏è</div>
          <div>
            <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:#fff;">Human Verification</div>
            <div style="font-size:13px;color:var(--muted);margin-top:3px;">Answer 3 of 5 correctly to continue</div>
          </div>
        </div>
        <div id="quiz-progress-bar" style="display:flex;gap:5px;margin-bottom:28px;">
          ${QUIZ_QUESTIONS.map((_,i)=>`<div id="qpb-${i}" style="flex:1;height:4px;border-radius:99px;background:var(--border);transition:background .3s;"></div>`).join('')}
        </div>
        <div id="quiz-question-area"></div>
        <div id="quiz-result" style="display:none;text-align:center;padding:10px 0;"></div>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  quizIdx = 0; quizCorrect = 0; quizAnswers = [];
  renderQuizQuestion();
}

function renderQuizQuestion() {
  const qEl = document.getElementById('quiz-question-area');
  if (!qEl) return;
  if (quizIdx >= QUIZ_QUESTIONS.length) { showQuizResult(); return; }
  QUIZ_QUESTIONS.forEach((_,i) => {
    const seg = document.getElementById('qpb-'+i);
    if (!seg) return;
    if (i < quizIdx) seg.style.background = quizAnswers[i] ? 'var(--green)' : 'var(--red)';
    else if (i === quizIdx) seg.style.background = 'var(--accent)';
    else seg.style.background = 'var(--border)';
  });
  const q = QUIZ_QUESTIONS[quizIdx];
  qEl.innerHTML = `
    <div style="font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Question ${quizIdx+1} of ${QUIZ_QUESTIONS.length}</div>
    <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:#fff;line-height:1.45;margin-bottom:20px;">${escapeHTML(q.q)}</div>
    <div style="display:flex;flex-direction:column;gap:9px;">
      ${q.opts.map((opt,i)=>`
        <button id="qopt-${i}" data-correct="${opt===q.a}" onclick="answerQuiz(${i})" style="width:100%;padding:13px 18px;border-radius:13px;border:1.5px solid var(--border);background:rgba(255,255,255,.02);color:var(--muted-light);font-family:'DM Sans',sans-serif;font-size:14px;text-align:left;cursor:pointer;transition:all .15s;display:flex;align-items:center;gap:12px;">
          <span style="width:26px;height:26px;min-width:26px;border-radius:8px;border:1.5px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;font-family:'Syne',sans-serif;">${['A','B','C','D'][i]}</span>
          <span>${escapeHTML(opt)}</span>
        </button>`).join('')}
    </div>`;
}

function answerQuiz(selectedIdx) {
  const opts = document.querySelectorAll('#quiz-question-area button');
  opts.forEach(o => { o.onclick = null; o.style.cursor = 'default'; });
  const sel = document.getElementById('qopt-'+selectedIdx);
  const isCorrect = sel && sel.dataset.correct === 'true';
  if (isCorrect) {
    sel.style.cssText += ';border-color:var(--green);background:rgba(62,207,110,.1);color:var(--green);';
    quizCorrect++;
  } else {
    sel.style.cssText += ';border-color:var(--red);background:rgba(248,113,113,.1);color:var(--red);';
    opts.forEach(o => { if (o.dataset.correct === 'true') o.style.cssText += ';border-color:var(--green);background:rgba(62,207,110,.08);color:var(--green);'; });
  }
  quizAnswers.push(isCorrect);
  const seg = document.getElementById('qpb-'+quizIdx);
  if (seg) seg.style.background = isCorrect ? 'var(--green)' : 'var(--red)';
  quizIdx++;
  setTimeout(renderQuizQuestion, 1000);
}

async function showQuizResult() {
  const passed = quizCorrect >= 3;
  const qEl = document.getElementById('quiz-question-area');
  const res = document.getElementById('quiz-result');
  if (qEl) qEl.style.display = 'none';
  if (!res) return;
  res.style.display = '';
  if (passed) {
    res.innerHTML = `
      <div style="width:72px;height:72px;background:rgba(62,207,110,.1);border:1px solid rgba(62,207,110,.3);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 18px;">‚úÖ</div>
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--green);margin-bottom:8px;">You're Verified!</div>
      <div style="font-size:13.5px;color:var(--muted-light);margin-bottom:6px;">You got <strong style="color:#fff;">${quizCorrect} of ${QUIZ_QUESTIONS.length}</strong> correct.</div>
      <div style="font-size:12.5px;color:var(--muted);margin-bottom:28px;">Welcome to the fortress.</div>
      <button class="btn-a" onclick="completeVerification()" style="padding:13px 32px;font-size:15px;">Enter Fortized ‚Üí</button>`;
  } else {
    res.innerHTML = `
      <div style="width:72px;height:72px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.3);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 18px;">‚ùå</div>
      <div style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--red);margin-bottom:8px;">Verification Failed</div>
      <div style="font-size:13.5px;color:var(--muted-light);margin-bottom:6px;">You got <strong style="color:#fff;">${quizCorrect} of ${QUIZ_QUESTIONS.length}</strong> correct. Need at least 3.</div>
      <div style="font-size:12.5px;color:var(--muted);margin-bottom:28px;">Review the community guidelines and try again.</div>
      <button class="btn-a" onclick="quizIdx=0;quizCorrect=0;quizAnswers=[];document.getElementById('quiz-result').style.display='none';document.getElementById('quiz-question-area').style.display='';renderQuizQuestion();" style="padding:13px 32px;font-size:15px;">Try Again</button>`;
  }
}

async function completeVerification() {
  CU.verified = true;
  await saveUser();
  document.getElementById('verify-overlay')?.remove();
  toast('üéâ Welcome to Fortized!', 'success');
  if (!CU.dateOfBirth) setTimeout(showDOBSetup, 400);
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CHANNEL SELECTION & NSFW GATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DATE OF BIRTH CAPTURE (first-time setup)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showDOBSetup() {
  if (CU.dateOfBirth) return; // already set
  const overlay = document.createElement('div');
  overlay.id = 'dob-setup-overlay';
  overlay.style.cssText = 'position:fixed;inset:0;background:rgba(4,6,10,.97);backdrop-filter:blur(20px);z-index:6000;display:flex;align-items:center;justify-content:center;';
  overlay.innerHTML = `
    <div style="background:var(--panel);border:1px solid var(--border);border-radius:24px;padding:40px;max-width:440px;width:90%;text-align:center;">
      <div style="width:70px;height:70px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:30px;margin:0 auto 20px;">üõ°Ô∏è</div>
      <h2 style="font-family:'Syne',sans-serif;font-size:22px;font-weight:800;margin-bottom:10px;">Age Verification</h2>
      <p style="font-size:13.5px;color:var(--muted-light);line-height:1.65;margin-bottom:28px;">
        Fortized uses your date of birth to protect you and ensure you only access age-appropriate content.<br><br>
        <strong style="color:var(--accent);">Your date of birth cannot be changed without identity verification.</strong>
      </p>
      <div style="text-align:left;margin-bottom:20px;">
        <div class="settings-title">Date of Birth</div>
        <input type="date" id="dob-input" class="field-input"
          max="${new Date(Date.now() - 13*365.25*24*60*60*1000).toISOString().split('T')[0]}"
          min="${new Date(Date.now() - 120*365.25*24*60*60*1000).toISOString().split('T')[0]}"
          style="margin-bottom:8px;">
        <div style="font-size:12px;color:var(--muted);">You must be at least 13 years old to use Fortized.</div>
      </div>
      <div style="background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:20px;text-align:left;">
        <div style="font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">Age Tiers</div>
        <div style="font-size:12.5px;color:var(--muted-light);line-height:1.8;">
          üßí <strong>13‚Äì15:</strong> Full protection ‚Äî NSFW content is fully hidden<br>
          üßë <strong>16‚Äì17:</strong> Friction gate ‚Äî NSFW requires manual confirmation<br>
          üßë‚Äçü¶≥ <strong>18+:</strong> Full access with standard content controls
        </div>
      </div>
      <div id="dob-error" style="font-size:12px;color:var(--red);margin-bottom:10px;min-height:16px;"></div>
      <button class="btn-a" onclick="saveDOB()" style="width:100%;justify-content:center;font-size:14px;">Confirm My Age ‚Üí</button>
    </div>`;
  document.body.appendChild(overlay);
}

async function saveDOB() {
  const input = document.getElementById('dob-input');
  const err = document.getElementById('dob-error');
  if (!input || !input.value) { if(err) err.textContent = 'Please enter your date of birth.'; return; }
  const tier = getAgeTier(input.value);
  if (tier === null) {
    if(err) err.textContent = 'You must be at least 13 years old to use Fortized.';
    return;
  }
  CU.dateOfBirth = input.value;
  await saveUser();
  document.getElementById('dob-setup-overlay')?.remove();
  const tierLabels = { child: 'üßí Protected Mode (13‚Äì15)', teen: 'üßë Teen Mode (16‚Äì17)', adult: 'üßë‚Äçü¶≥ Adult Mode (18+)' };
  toast(`‚úÖ Age verified ‚Äî ${tierLabels[tier]}`, 'success');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NSFW UPLOAD SCANNER (AI Simulation)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function simulateAIScan(fileData, fileName, uploader) {
  // Simulated AI classifier ‚Äî in production this calls a real ML endpoint
  const labels = ['SAFE', 'SAFE', 'SAFE', 'SAFE', 'SUGGESTIVE', 'EXPLICIT', 'EXTREME'];
  const aiLabel = labels[Math.floor(Math.random() * labels.length)];
  const aiScore = (Math.random() * 0.4 + 0.3).toFixed(2);

  if (aiLabel === 'SAFE') return { flagged: false, label: aiLabel, score: aiScore };

  // Flag it ‚Äî add to NSFW review queue
  const queue = JSON.parse(localStorage.getItem('ftz_nsfw_queue') || '[]');
  queue.push({
    id: 'nsfw_' + Date.now(),
    uploader,
    data: fileData,
    fileName,
    aiLabel,
    aiScore,
    type: 'image',
    status: 'pending',
    createdAt: new Date().toISOString(),
    bastionId: curBastion !== null ? (CU.bastions[curBastion]?.globalId || CU.bastions[curBastion]?.name) : null,
  });
  localStorage.setItem('ftz_nsfw_queue', JSON.stringify(queue));
  logAudit('nsfw_flagged', uploader, `AI flagged upload as ${aiLabel} (score: ${aiScore})`);
  return { flagged: true, label: aiLabel, score: aiScore };
}

// Hook into profile picture upload to scan
const _origUpdatePfp = window.updatePfp;


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// BASTION SIDEBAR WITH CHANNEL CLICK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// APP INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

</script>
</body>
</html>
