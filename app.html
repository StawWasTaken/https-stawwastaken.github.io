<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
:root {
  --accent: #fff93e;
  --accent-dim: rgba(255,249,62,.1);
  --accent-mid: rgba(255,249,62,.2);
  --accent-glow: rgba(255,249,62,.35);
  --bg: #060810;
  --rail: #04060a;
  --sidebar: #0a0d14;
  --channel: #0c0f18;
  --panel: #101420;
  --panel2: #131825;
  --panel3: #181d2e;
  --border: #1c2438;
  --border-soft: rgba(255,255,255,.04);
  --radius: 12px;
  --muted: #4e5a70;
  --muted-light: #7a8599;
  --text: #d8dde8;
  --green: #3ecf6e;
  --red: #f87171;
  --amber: #f59e0b;
  --blue: #60a5fa;
}
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
html, body { height:100%; overflow:hidden; }
body { background:var(--bg); color:var(--text); font-family:'DM Sans',sans-serif; display:flex; }
a { color:inherit; text-decoration:none; }
button { font-family:inherit; }

::-webkit-scrollbar { width:4px; height:4px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:#1e2535; border-radius:4px; }
::-webkit-scrollbar-thumb:hover { background:#2a3348; }

/* â”€â”€â”€ RAIL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.rail {
  width:64px; min-width:64px;
  background:var(--rail);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column; align-items:center;
  padding:12px 0; gap:4px; z-index:20; overflow-y:auto; overflow-x:hidden;
}
.rail-logo {
  width:40px; height:40px;
  display:flex; align-items:center; justify-content:center;
  margin-bottom:6px; cursor:pointer; flex-shrink:0;
}
.rail-logo img { width:34px; height:34px; object-fit:contain; }
.rail-sep { width:28px; height:1px; background:var(--border); margin:4px 0; flex-shrink:0; }
.rail-btn {
  width:42px; height:42px; border-radius:14px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:background .15s, border-radius .2s;
  position:relative; flex-shrink:0;
}
.rail-btn span.icon { font-size:18px; line-height:1; }
.rail-btn:hover { background:rgba(255,255,255,.07); border-radius:11px; }
.rail-btn.active { background:var(--accent-dim); border-radius:11px; }
.rail-btn.active::before {
  content:""; position:absolute; left:-13px; top:50%; transform:translateY(-50%);
  width:3px; height:24px; background:var(--accent); border-radius:0 3px 3px 0;
}
.rail-btn[data-tip]:hover::after {
  content:attr(data-tip); position:absolute;
  left:calc(100% + 10px); top:50%; transform:translateY(-50%);
  background:#0a0d14; border:1px solid var(--border);
  color:#fff; font-size:12px; font-weight:600;
  padding:5px 10px; border-radius:8px;
  white-space:nowrap; z-index:999; pointer-events:none;
  box-shadow:0 4px 20px rgba(0,0,0,.5);
}
.rail-bastion {
  width:40px; height:40px; border-radius:14px;
  background:var(--panel); border:1.5px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:16px; flex-shrink:0;
  transition:border-color .15s, background .15s, border-radius .2s;
  position:relative; overflow:hidden;
}
.rail-bastion:hover, .rail-bastion.active { border-color:var(--accent); border-radius:11px; background:var(--accent-dim); }
.rail-bastion.active::before {
  content:""; position:absolute; left:-13px; top:50%; transform:translateY(-50%);
  width:3px; height:24px; background:var(--accent); border-radius:0 3px 3px 0;
}
.rail-add-bastion {
  width:40px; height:40px; border-radius:14px;
  border:1.5px dashed #1e2a3d; background:transparent;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer; font-size:22px; color:var(--muted); flex-shrink:0;
  transition:border-color .15s, color .15s, border-radius .2s;
}
.rail-add-bastion:hover { border-color:var(--accent); color:var(--accent); border-radius:11px; }
.rail-spacer { flex:1; }

/* â”€â”€â”€ SIDEBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.sidebar {
  width:240px; min-width:240px;
  background:var(--sidebar);
  border-right:1px solid var(--border);
  display:flex; flex-direction:column; overflow:hidden;
}
.sidebar-header {
  height:50px;
  display:flex; align-items:center;
  padding:0 16px;
  border-bottom:1px solid var(--border);
  font-family:'Syne',sans-serif;
  font-size:15px; font-weight:700;
  flex-shrink:0; gap:8px;
  background:rgba(4,6,10,.4);
  backdrop-filter:blur(8px);
}
.sidebar-header .hdr-actions { margin-left:auto; display:flex; gap:2px; }
.sidebar-header .hdr-actions button {
  width:28px; height:28px; border-radius:7px;
  background:transparent; border:none; color:var(--muted);
  font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.sidebar-header .hdr-actions button:hover { background:rgba(255,255,255,.07); color:#fff; }
.sidebar-scroll { flex:1; overflow-y:auto; padding:6px 0 4px; }
.sidebar-label {
  font-size:10.5px; font-weight:700; letter-spacing:.1em;
  text-transform:uppercase; color:var(--muted);
  padding:12px 16px 5px;
  display:flex; align-items:center; justify-content:space-between;
}
.sidebar-label button {
  background:none; border:none; color:var(--muted);
  font-size:17px; cursor:pointer; line-height:1;
  width:18px; height:18px; display:flex; align-items:center; justify-content:center;
  border-radius:4px; transition:background .12s, color .12s;
}
.sidebar-label button:hover { background:rgba(255,255,255,.07); color:#fff; }
.sidebar-item {
  display:flex; align-items:center; gap:10px;
  padding:6px 10px; margin:1px 6px;
  border-radius:8px; cursor:pointer;
  font-size:14px; color:var(--muted-light);
  transition:background .12s, color .12s;
  position:relative;
}
.sidebar-item:hover { background:rgba(255,255,255,.05); color:#fff; }
.sidebar-item.active { background:rgba(255,249,62,.07); color:var(--accent); }
.sidebar-item .s-icon {
  width:28px; height:28px; border-radius:50%;
  background:var(--panel); border:1px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:12px; flex-shrink:0; overflow:hidden;
}
.sidebar-item .s-badge {
  background:var(--accent); color:#060810;
  font-size:10px; font-weight:800;
  padding:1px 6px; border-radius:100px;
  min-width:18px; text-align:center; flex-shrink:0;
}
.ch-item {
  display:flex; align-items:center; gap:7px;
  padding:5px 8px; margin:1px 6px;
  border-radius:7px; cursor:pointer;
  font-size:13.5px; color:var(--muted);
  transition:background .12s, color .12s;
}
.ch-item:hover { background:rgba(255,255,255,.05); color:var(--text); }
.ch-item.active { background:rgba(255,249,62,.07); color:var(--accent); }
.ch-item .ch-prefix { font-size:13px; width:16px; text-align:center; flex-shrink:0; opacity:.7; }
.ch-item .ch-unread {
  margin-left:auto; width:7px; height:7px;
  border-radius:50%; background:var(--accent); flex-shrink:0;
}
/* userbar */
.userbar {
  height:54px;
  background:rgba(4,6,10,.7);
  border-top:1px solid var(--border);
  display:flex; align-items:center;
  padding:0 10px; gap:8px; flex-shrink:0;
}
.userbar-avatar {
  width:34px; height:34px; border-radius:50%;
  background:var(--panel); border:1.5px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:13px; overflow:hidden; flex-shrink:0; position:relative; cursor:pointer;
}
.userbar-avatar img { width:100%; height:100%; object-fit:cover; }
.ub-status {
  position:absolute; bottom:-1px; right:-1px;
  width:12px; height:12px; border-radius:50%;
  border:2.5px solid var(--sidebar);
}
.ub-status.online { background:var(--green); }
.ub-status.idle { background:var(--amber); }
.ub-status.dnd { background:var(--red); }
.ub-status.offline { background:#374151; }
.userbar-info { flex:1; min-width:0; }
.userbar-name { font-size:13px; font-weight:600; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.userbar-tag { font-size:11px; color:var(--muted); }
.ub-actions { display:flex; gap:1px; }
.ub-actions button {
  width:30px; height:30px; border-radius:7px;
  background:transparent; border:none; color:var(--muted);
  font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.ub-actions button:hover { background:rgba(255,255,255,.07); color:#fff; }

/* â”€â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.main { flex:1; min-width:0; display:flex; flex-direction:column; background:var(--bg); }

/* topbar */
.topbar {
  height:50px;
  background:rgba(10,13,20,.95);
  border-bottom:1px solid var(--border);
  display:flex; align-items:center;
  padding:0 18px; gap:10px; flex-shrink:0;
  backdrop-filter:blur(10px);
}
.topbar-title {
  font-family:'Syne',sans-serif; font-size:15px; font-weight:700;
  display:flex; align-items:center; gap:7px; white-space:nowrap;
}
.topbar-title .t-prefix { font-size:15px; color:var(--muted); }
.topbar-sep { width:1px; height:18px; background:var(--border); margin:0 2px; }
.topbar-desc { font-size:13px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; }
.topbar-actions { margin-left:auto; display:flex; align-items:center; gap:6px; }
.topbar-actions button {
  background:transparent; border:none; color:var(--muted);
  font-size:17px; cursor:pointer; width:32px; height:32px;
  border-radius:8px; display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.topbar-actions button:hover { background:rgba(255,255,255,.07); color:#fff; }
.onyx-pill {
  display:flex; align-items:center; gap:5px;
  background:var(--accent-dim); border:1px solid var(--accent-mid);
  border-radius:100px; padding:4px 12px;
  font-size:13px; font-weight:600; color:var(--accent);
  cursor:pointer; transition:background .15s; white-space:nowrap;
}
.onyx-pill:hover { background:rgba(255,249,62,.15); }

/* â”€â”€â”€ CONTENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.content { flex:1; overflow:hidden; position:relative; display:flex; }
.view { display:none; width:100%; height:100%; }
.view.active { display:flex; }

/* â”€â”€â”€ HOME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.home-left {
  width:238px; min-width:238px;
  border-right:1px solid var(--border);
  display:flex; flex-direction:column;
  background:var(--channel);
}
.home-main { flex:1; overflow-y:auto; }
.home-landing { padding:28px 24px; }
.home-hero {
  padding:28px 0 24px;
  border-bottom:1px solid var(--border);
  margin-bottom:22px;
}
.home-hero-inner { display:flex; align-items:center; gap:16px; margin-bottom:16px; }
.home-hero-av {
  width:64px; height:64px; border-radius:50%;
  background:var(--panel); border:2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  font-size:24px; overflow:hidden; flex-shrink:0;
}
.home-hero-av img { width:100%; height:100%; object-fit:cover; }
.home-hero-text h2 {
  font-family:'Syne',sans-serif; font-size:20px; font-weight:800;
  letter-spacing:-.3px; margin-bottom:3px; color:#fff;
}
.home-hero-text p { font-size:13px; color:var(--muted-light); }
.rad-badge {
  display:inline-flex; align-items:center; gap:6px;
  background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.1));
  border:1px solid rgba(255,220,62,.2);
  border-radius:100px; padding:3px 10px;
  font-size:11px; font-weight:700; color:#ffd93e;
}
.home-cards { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
.home-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; padding:16px;
  transition:border-color .2s, transform .15s; cursor:pointer;
}
.home-card:hover { border-color:rgba(255,249,62,.18); transform:translateY(-2px); }
.home-card h4 { font-family:'Syne',sans-serif; font-size:13px; font-weight:700; margin-bottom:3px; }
.home-card p { font-size:11.5px; color:var(--muted); line-height:1.4; }
.home-card .card-num { font-family:'Syne',sans-serif; font-size:24px; font-weight:800; color:var(--accent); margin-bottom:3px; }

/* DM list */
.dm-friend-item {
  display:flex; align-items:center; gap:10px;
  padding:7px 10px; margin:1px 5px;
  border-radius:8px; cursor:pointer;
  transition:background .12s;
}
.dm-friend-item:hover { background:rgba(255,255,255,.05); }
.dm-friend-item.active { background:rgba(255,249,62,.07); }
.dm-av {
  width:32px; height:32px; border-radius:50%;
  background:var(--panel); border:1.5px solid var(--border);
  font-size:12px; display:flex; align-items:center; justify-content:center;
  flex-shrink:0; position:relative; overflow:hidden;
}
.dm-av img { width:100%; height:100%; object-fit:cover; }
.dm-av .st-dot {
  position:absolute; bottom:-1px; right:-1px;
  width:10px; height:10px; border-radius:50%;
  border:2px solid var(--channel);
}
.st-dot.online { background:var(--green); }
.st-dot.idle { background:var(--amber); }
.st-dot.dnd { background:var(--red); }
.st-dot.offline { background:#374151; }
.dm-info { flex:1; min-width:0; }
.dm-name { font-size:13px; font-weight:600; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.dm-preview { font-size:11.5px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.dm-close {
  width:22px; height:22px; border-radius:5px; background:transparent; border:none;
  color:var(--muted); font-size:14px; cursor:pointer; display:none; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.dm-friend-item:hover .dm-close { display:flex; }
.dm-close:hover { background:rgba(248,113,113,.15); color:var(--red); }

/* â”€â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.chat-view { flex:1; display:flex; flex-direction:column; min-width:0; }
.chat-msgs {
  flex:1; overflow-y:auto;
  padding:16px 20px;
  display:flex; flex-direction:column; gap:1px;
}
.chat-welcome {
  padding:20px 0 18px;
  border-bottom:1px solid var(--border);
  margin-bottom:16px;
}
.cw-av {
  width:60px; height:60px; border-radius:50%;
  background:var(--panel); border:2px solid var(--border);
  font-size:22px; display:flex; align-items:center; justify-content:center;
  margin-bottom:12px; overflow:hidden;
}
.cw-av img { width:100%; height:100%; object-fit:cover; }
.chat-welcome h3 { font-family:'Syne',sans-serif; font-size:18px; font-weight:800; margin-bottom:4px; }
.chat-welcome p { font-size:13px; color:var(--muted-light); }
.msg-group {
  display:flex; gap:12px;
  padding:3px 6px; border-radius:8px;
  transition:background .1s;
  position:relative;
}
.msg-group:hover { background:rgba(255,255,255,.022); }
.msg-group.own { flex-direction:row-reverse; }
.msg-av {
  width:36px; height:36px; border-radius:50%;
  background:var(--panel); border:1.5px solid var(--border);
  font-size:13px; display:flex; align-items:center; justify-content:center;
  flex-shrink:0; margin-top:2px; overflow:hidden; cursor:pointer;
}
.msg-av:hover { border-color:rgba(255,249,62,.4); }
.msg-av img { width:100%; height:100%; object-fit:cover; }
.msg-body { max-width:70%; }
.msg-meta { display:flex; align-items:baseline; gap:8px; margin-bottom:3px; }
.msg-author { font-size:13.5px; font-weight:600; color:#fff; cursor:pointer; }
.msg-author:hover { color:var(--accent); }
.msg-time { font-size:10.5px; color:var(--muted); }
.msg-edited { font-size:10.5px; color:var(--muted); font-style:italic; }
.msg-bubble {
  background:var(--panel); border:1px solid var(--border);
  border-radius:4px 12px 12px 12px;
  padding:8px 13px; font-size:14px; color:var(--text);
  line-height:1.55; word-break:break-word; display:inline-block; max-width:100%;
}
.msg-group.own .msg-bubble {
  background:rgba(255,249,62,.08); border-color:rgba(255,249,62,.14);
  border-radius:12px 4px 12px 12px;
}
.msg-group.own .msg-meta { flex-direction:row-reverse; }
.msg-cont .msg-av { opacity:0; pointer-events:none; }
.msg-cont .msg-meta { display:none; }
/* msg actions */
.msg-actions {
  display:none; position:absolute;
  right:8px; top:-16px;
  background:var(--panel2); border:1px solid var(--border);
  border-radius:8px; padding:3px 4px;
  gap:1px; flex-direction:row;
  box-shadow:0 4px 20px rgba(0,0,0,.5); z-index:10;
}
.msg-group:hover .msg-actions { display:flex; }
.msg-group.own .msg-actions { right:auto; left:8px; }
.msg-act-btn {
  width:28px; height:26px; border-radius:5px;
  background:none; border:none; font-size:14px;
  cursor:pointer; color:var(--muted);
  display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.msg-act-btn:hover { background:rgba(255,255,255,.07); color:#fff; }

/* chat input */
.chat-input-wrap { padding:10px 16px 14px; flex-shrink:0; }
.chat-input-box {
  background:var(--panel2);
  border:1px solid var(--border);
  border-radius:12px;
  display:flex; align-items:flex-end; gap:8px;
  padding:9px 12px;
  transition:border-color .18s;
}
.chat-input-box:focus-within { border-color:rgba(255,249,62,.25); }
.chat-input-box textarea {
  flex:1; background:transparent; border:none; outline:none;
  color:var(--text); font-family:'DM Sans',sans-serif; font-size:14px;
  resize:none; max-height:120px; line-height:1.5; padding:2px 0;
}
.chat-input-box textarea::placeholder { color:var(--muted); }
.chat-input-btns { display:flex; gap:2px; align-items:center; }
.chat-input-btns button {
  background:none; border:none; color:var(--muted);
  font-size:17px; cursor:pointer; width:30px; height:30px;
  border-radius:7px; display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.chat-input-btns button:hover { background:rgba(255,255,255,.07); color:#fff; }
.chat-send {
  width:32px; height:32px; border-radius:8px;
  background:var(--accent); border:none; color:#060810;
  font-size:15px; cursor:pointer;
  display:flex; align-items:center; justify-content:center;
  flex-shrink:0; transition:filter .15s;
}
.chat-send:hover { filter:brightness(1.1); }
.typing-indicator {
  height:16px; padding:0 22px;
  font-size:11.5px; color:var(--muted); flex-shrink:0;
}

/* â”€â”€â”€ MEMBERS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.members-panel {
  width:220px; min-width:220px;
  border-left:1px solid var(--border);
  background:var(--channel);
  display:flex; flex-direction:column;
  overflow:hidden;
}
.members-panel.hidden { display:none; }
.mp-header {
  height:50px; display:flex; align-items:center;
  padding:0 14px; border-bottom:1px solid var(--border);
  font-size:13px; font-weight:600; color:var(--muted-light); flex-shrink:0;
}
.mp-scroll { flex:1; overflow-y:auto; padding:8px 0; }
.mp-label {
  font-size:10px; font-weight:700; letter-spacing:.1em;
  text-transform:uppercase; color:var(--muted);
  padding:10px 14px 4px;
}
.mp-item {
  display:flex; align-items:center; gap:9px;
  padding:6px 10px; margin:1px 5px;
  border-radius:7px; cursor:pointer;
  transition:background .12s;
}
.mp-item:hover { background:rgba(255,255,255,.05); }
.mp-av {
  width:30px; height:30px; border-radius:50%;
  background:var(--panel); border:1.5px solid var(--border);
  font-size:12px; display:flex; align-items:center; justify-content:center;
  flex-shrink:0; position:relative; overflow:hidden;
}
.mp-av img { width:100%; height:100%; object-fit:cover; }
.mp-info { flex:1; min-width:0; }
.mp-name { font-size:13px; font-weight:500; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.mp-role {
  font-size:10px; color:var(--muted);
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}

/* â”€â”€â”€ BASTION VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bastion-view { flex:1; display:flex; flex-direction:row; }

/* â”€â”€â”€ DISCOVER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.discover-view { flex:1; overflow-y:auto; padding:28px 24px; }
.discover-hero {
  background:linear-gradient(120deg, rgba(8,10,15,.98) 50%, rgba(16,18,30,.9)),
    linear-gradient(220deg, rgba(255,249,62,.04) 0%, transparent 60%);
  border:1px solid var(--border);
  border-radius:18px; padding:40px 36px; margin-bottom:28px; position:relative; overflow:hidden;
}
.discover-hero::before {
  content:""; position:absolute; inset:0; pointer-events:none;
  background-image:linear-gradient(rgba(255,249,62,.012) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,249,62,.012) 1px, transparent 1px);
  background-size:50px 50px;
}
.discover-hero h2 {
  font-family:'Syne',sans-serif; font-size:28px; font-weight:800;
  letter-spacing:-.6px; margin-bottom:7px; position:relative; color:#fff;
}
.discover-hero p { font-size:14px; color:var(--muted-light); margin-bottom:20px; position:relative; }
.discover-search {
  display:flex; align-items:center; gap:10px; max-width:420px; position:relative;
}
.discover-search input {
  flex:1; background:rgba(255,255,255,.05);
  border:1px solid var(--border); border-radius:10px;
  color:#fff; font-family:'DM Sans',sans-serif; font-size:14px;
  padding:10px 15px 10px 38px; outline:none;
  transition:border-color .18s;
}
.discover-search input:focus { border-color:rgba(255,249,62,.3); }
.discover-search input::placeholder { color:var(--muted); }
.discover-search .s-ico {
  position:absolute; left:12px; top:50%; transform:translateY(-50%);
  font-size:15px; color:var(--muted); pointer-events:none;
}
.bastion-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px,1fr)); gap:14px; }
.bastion-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; overflow:hidden; cursor:pointer;
  transition:border-color .2s, transform .15s, box-shadow .2s;
}
.bastion-card:hover { border-color:rgba(255,249,62,.18); transform:translateY(-3px); box-shadow:0 12px 40px rgba(0,0,0,.4); }
.bc-banner {
  height:76px; background:linear-gradient(135deg,#131830,#0d1425);
  display:flex; align-items:center; justify-content:center; font-size:30px;
  position:relative; overflow:hidden;
}
.bc-banner::after { content:""; position:absolute; inset:0; background:linear-gradient(to bottom,transparent 40%,rgba(0,0,0,.5)); }
.bc-body { padding:14px; }
.bc-meta { display:flex; align-items:center; gap:8px; margin-bottom:9px; }
.bc-icon {
  width:40px; height:40px; border-radius:10px;
  background:var(--panel2); border:2px solid var(--sidebar);
  display:flex; align-items:center; justify-content:center;
  font-size:18px; margin-top:-26px; position:relative; z-index:1; flex-shrink:0;
}
.bc-name { font-family:'Syne',sans-serif; font-size:13.5px; font-weight:700; }
.bc-desc { font-size:12px; color:var(--muted-light); line-height:1.5; margin-bottom:9px; }
.bc-stats { display:flex; gap:10px; font-size:11.5px; color:var(--muted); }

/* â”€â”€â”€ ATELIER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.atelier-view { flex:1; overflow-y:auto; padding:28px 24px; }
.atelier-hero {
  display:flex; align-items:center; justify-content:space-between;
  background:var(--panel); border:1px solid var(--border);
  border-radius:18px; padding:24px 28px; margin-bottom:24px;
}
.at-balance { display:flex; align-items:center; gap:12px; }
.at-balance-text h3 { font-size:12px; font-weight:600; color:var(--muted-light); margin-bottom:1px; }
.at-balance-text .amount {
  font-family:'Syne',sans-serif; font-size:28px; font-weight:800;
  color:var(--accent); letter-spacing:-.5px;
}
.daily-btn {
  display:flex; flex-direction:column; align-items:center; gap:3px;
  background:rgba(255,249,62,.07); border:1px solid rgba(255,249,62,.16);
  border-radius:12px; padding:12px 22px; cursor:pointer; transition:background .15s;
}
.daily-btn:hover { background:rgba(255,249,62,.12); }
.daily-btn.claimed { opacity:.5; cursor:not-allowed; }
.daily-btn span { font-size:11px; color:var(--muted-light); }
.daily-btn strong { font-family:'Syne',sans-serif; font-size:13.5px; color:var(--accent); }
.at-title {
  font-family:'Syne',sans-serif; font-size:15px; font-weight:700;
  letter-spacing:-.1px; margin-bottom:14px;
  display:flex; align-items:center; gap:8px;
}
.at-title::before { content:""; width:14px; height:1.5px; background:var(--accent); }
.rad-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-bottom:28px; }
.rad-card {
  background:var(--panel); border:1px solid var(--border);
  border-radius:14px; padding:22px 18px;
  display:flex; flex-direction:column; align-items:center; text-align:center;
  gap:8px; cursor:pointer; position:relative; overflow:hidden;
  transition:border-color .2s, transform .15s, box-shadow .2s;
}
.rad-card::before {
  content:""; position:absolute; top:0; left:0; right:0; height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);
  opacity:0; transition:opacity .25s;
}
.rad-card:hover { border-color:rgba(255,249,62,.2); transform:translateY(-3px); box-shadow:0 12px 40px rgba(0,0,0,.5); }
.rad-card:hover::before { opacity:1; }
.rad-card.best { border-color:rgba(255,249,62,.2); }
.best-badge {
  position:absolute; top:10px; right:10px;
  background:var(--accent); color:#060810;
  font-size:9px; font-weight:800; letter-spacing:.06em;
  padding:2px 7px; border-radius:100px; text-transform:uppercase;
}
.rad-card .rc-icon { font-size:28px; }
.rad-card .rc-dur { font-family:'Syne',sans-serif; font-size:14px; font-weight:700; }
.rad-card .rc-price { font-family:'Syne',sans-serif; font-size:20px; font-weight:800; color:var(--accent); }
.rad-card .rc-price span { font-size:11px; color:var(--muted-light); font-family:'DM Sans',sans-serif; font-weight:400; }
.rad-card .rc-perks { font-size:12px; color:var(--muted-light); line-height:1.5; }

/* â”€â”€â”€ PROFILE VIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-view { flex:1; overflow-y:auto; }
.pb { height:160px; background:linear-gradient(135deg,#0e1830,#1a0f2e,#0e2030); position:relative; overflow:hidden; }
.pb::before {
  content:""; position:absolute; inset:0;
  background-image:linear-gradient(rgba(255,249,62,.013) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,249,62,.013) 1px, transparent 1px);
  background-size:38px 38px;
}
.pc { padding:0 28px 36px; }
.pav-row { display:flex; align-items:flex-end; gap:16px; margin-top:-42px; margin-bottom:18px; }
.pav {
  width:84px; height:84px; border-radius:50%;
  background:var(--panel); border:4px solid var(--bg);
  font-size:28px; display:flex; align-items:center; justify-content:center;
  overflow:hidden; flex-shrink:0; position:relative;
}
.pav img { width:100%; height:100%; object-fit:cover; }
.pav-edit {
  position:absolute; inset:0; background:rgba(0,0,0,.6);
  display:flex; align-items:center; justify-content:center;
  font-size:20px; opacity:0; cursor:pointer;
  transition:opacity .15s; border-radius:50%;
}
.pav:hover .pav-edit { opacity:1; }
.pav-actions { margin-left:auto; display:flex; gap:8px; padding-bottom:4px; }
.pname { font-family:'Syne',sans-serif; font-size:20px; font-weight:800; letter-spacing:-.3px; margin-bottom:2px; }
.phandle { font-size:13.5px; color:var(--muted-light); }
.pbio { font-size:13.5px; color:var(--muted-light); margin-top:6px; max-width:500px; }
.pstatus-badge {
  display:inline-flex; align-items:center; gap:5px;
  margin-top:6px; font-size:12px; color:var(--muted-light);
}
.pstats {
  display:flex; gap:0;
  background:var(--panel); border:1px solid var(--border);
  border-radius:12px; overflow:hidden; margin-bottom:22px;
}
.pstat { flex:1; padding:16px; text-align:center; border-right:1px solid var(--border); }
.pstat:last-child { border-right:none; }
.pstat-v { font-family:'Syne',sans-serif; font-size:20px; font-weight:800; color:var(--accent); }
.pstat-k { font-size:11px; color:var(--muted); margin-top:2px; }
.settings-section { margin-bottom:24px; }
.settings-title { font-family:'Syne',sans-serif; font-size:11px; font-weight:700; letter-spacing:.1em; text-transform:uppercase; color:var(--muted); margin-bottom:10px; }
.s-item {
  display:flex; align-items:center; gap:11px;
  padding:13px 15px; background:var(--panel); border:1px solid var(--border);
  border-radius:10px; margin-bottom:7px; cursor:pointer;
  transition:border-color .15s, background .15s;
}
.s-item:hover { border-color:rgba(255,249,62,.14); background:rgba(255,249,62,.025); }
.s-item .si-ico { font-size:17px; width:30px; text-align:center; }
.s-item .si-txt { flex:1; }
.s-item .si-lbl { font-size:13.5px; font-weight:600; }
.s-item .si-sub { font-size:12px; color:var(--muted-light); }
.s-item .si-arr { color:var(--muted); font-size:14px; }
.s-item .si-val { font-size:12.5px; color:var(--muted-light); margin-right:4px; }

/* â”€â”€â”€ EMPTY STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.empty-state {
  flex:1; display:flex; flex-direction:column;
  align-items:center; justify-content:center;
  gap:14px; color:var(--muted); text-align:center; padding:40px;
}
.empty-state .ei { font-size:48px; opacity:.35; }
.empty-state h3 { font-family:'Syne',sans-serif; font-size:17px; font-weight:700; color:var(--muted-light); }
.empty-state p { font-size:13.5px; max-width:300px; line-height:1.6; }

/* â”€â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.btn-accent {
  display:inline-flex; align-items:center; gap:7px;
  background:var(--accent); color:#060810;
  padding:10px 20px; border-radius:var(--radius);
  font-family:'Syne',sans-serif; font-size:13.5px; font-weight:700;
  border:none; cursor:pointer; transition:filter .15s, transform .1s;
  white-space:nowrap;
}
.btn-accent:hover { filter:brightness(1.07); transform:translateY(-1px); }
.btn-ghost {
  display:inline-flex; align-items:center; gap:7px;
  background:transparent; color:var(--muted-light);
  padding:9px 18px; border-radius:var(--radius);
  font-family:'Syne',sans-serif; font-size:13.5px; font-weight:700;
  border:1px solid var(--border); cursor:pointer;
  transition:border-color .15s, background .15s; white-space:nowrap;
}
.btn-ghost:hover { border-color:#2e3a52; background:rgba(255,255,255,.04); }
.btn-danger {
  display:inline-flex; align-items:center; gap:7px;
  background:rgba(248,113,113,.1); color:var(--red);
  padding:9px 18px; border-radius:var(--radius);
  font-family:'Syne',sans-serif; font-size:13.5px; font-weight:700;
  border:1px solid rgba(248,113,113,.2); cursor:pointer;
  transition:background .15s; white-space:nowrap;
}
.btn-danger:hover { background:rgba(248,113,113,.18); }

/* â”€â”€â”€ MODALS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.modal-overlay {
  display:none; position:fixed; inset:0;
  background:rgba(0,0,0,.75); backdrop-filter:blur(10px);
  z-index:500; align-items:center; justify-content:center;
}
.modal-overlay.open { display:flex; }
.modal {
  background:var(--panel); border:1px solid var(--border);
  border-radius:18px; width:100%; max-width:440px; overflow:hidden;
  animation:mIn .22s cubic-bezier(.22,1,.36,1) both;
  box-shadow:0 30px 80px rgba(0,0,0,.7);
  max-height:90vh; overflow-y:auto;
}
.modal.wide { max-width:560px; }
@keyframes mIn { from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;} }
.modal-bar { height:2px; background:linear-gradient(90deg,transparent,var(--accent),transparent); }
.modal-body { padding:28px; }
.modal-title { font-family:'Syne',sans-serif; font-size:17px; font-weight:800; margin-bottom:5px; }
.modal-sub { font-size:13px; color:var(--muted-light); margin-bottom:22px; }
.modal-input {
  width:100%; padding:10px 13px;
  background:#060810; border:1px solid var(--border);
  border-radius:9px; color:#fff;
  font-family:'DM Sans',sans-serif; font-size:14px;
  outline:none; margin-bottom:12px;
  transition:border-color .18s;
}
.modal-input:focus { border-color:rgba(255,249,62,.35); }
.modal-input::placeholder { color:#252c3d; }
.modal-input.inline { width:auto; }
.modal-label { font-size:12px; font-weight:600; color:var(--muted-light); margin-bottom:5px; letter-spacing:.03em; }
.modal-actions { display:flex; gap:9px; margin-top:6px; }
.modal-actions .btn-accent, .modal-actions .btn-ghost { flex:1; justify-content:center; }
.modal-error { font-size:12px; color:var(--red); min-height:16px; margin-bottom:8px; }
.modal-error:not(:empty)::before { content:"âš  "; }
.modal-info {
  background:rgba(255,249,62,.06); border:1px solid rgba(255,249,62,.14);
  border-radius:9px; padding:12px 14px;
  font-size:13px; color:var(--accent); margin-bottom:14px; word-break:break-all;
}
.modal-info .inv-link { font-family:monospace; font-size:12.5px; opacity:.85; }
.copy-btn {
  background:none; border:none; color:var(--accent); cursor:pointer;
  font-size:16px; padding:2px 4px; border-radius:5px;
  transition:background .12s;
}
.copy-btn:hover { background:rgba(255,249,62,.12); }
.tag-input-row { display:flex; gap:8px; }
.modal-select {
  width:100%; padding:10px 13px;
  background:#060810; border:1px solid var(--border);
  border-radius:9px; color:#fff;
  font-family:'DM Sans',sans-serif; font-size:14px;
  outline:none; margin-bottom:12px; cursor:pointer;
  appearance:none;
}
.modal-select:focus { border-color:rgba(255,249,62,.35); }

/* â”€â”€â”€ PROFILE CARD POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.profile-popup {
  display:none; position:fixed; z-index:600;
  background:var(--panel2); border:1px solid var(--border);
  border-radius:14px; width:280px; overflow:hidden;
  box-shadow:0 20px 60px rgba(0,0,0,.7);
  animation:mIn .18s cubic-bezier(.22,1,.36,1) both;
}
.profile-popup.open { display:block; }
.pp-banner { height:80px; background:linear-gradient(135deg,#0e1830,#1a0f2e); position:relative; }
.pp-av {
  width:60px; height:60px; border-radius:50%;
  background:var(--panel); border:3px solid var(--panel2);
  font-size:22px; display:flex; align-items:center; justify-content:center;
  position:absolute; left:14px; bottom:-14px; overflow:hidden;
}
.pp-av img { width:100%; height:100%; object-fit:cover; }
.pp-body { padding:20px 14px 16px; }
.pp-name { font-family:'Syne',sans-serif; font-size:15px; font-weight:800; margin-bottom:1px; }
.pp-handle { font-size:12px; color:var(--muted); margin-bottom:6px; }
.pp-status { font-size:12px; color:var(--muted-light); margin-bottom:8px; }
.pp-bio { font-size:12.5px; color:var(--muted-light); line-height:1.5; margin-bottom:12px; border-top:1px solid var(--border); padding-top:10px; }
.pp-tags { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:12px; }
.pp-tag {
  font-size:10.5px; font-weight:700; padding:2px 8px; border-radius:100px;
  background:var(--panel); border:1px solid var(--border); color:var(--muted-light);
}
.pp-actions { display:flex; gap:8px; }
.pp-actions button { flex:1; font-size:12px; padding:7px 10px; }
.pp-close {
  position:absolute; top:8px; right:8px;
  background:rgba(0,0,0,.4); border:none; color:#fff;
  width:24px; height:24px; border-radius:6px;
  cursor:pointer; font-size:14px; display:flex; align-items:center; justify-content:center;
  transition:background .12s;
}
.pp-close:hover { background:rgba(0,0,0,.7); }

/* â”€â”€â”€ BASTION HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.bastion-header {
  background:rgba(4,6,10,.5);
  border-bottom:1px solid var(--border);
  padding:0 16px;
  display:flex; align-items:center; justify-content:space-between;
  flex-shrink:0; height:50px;
}
.bh-name { font-family:'Syne',sans-serif; font-size:15px; font-weight:700; display:flex; align-items:center; gap:8px; }
.bh-tag {
  font-size:9.5px; font-weight:700; letter-spacing:.08em;
  text-transform:uppercase; padding:2px 7px; border-radius:100px;
  background:var(--accent-dim); border:1px solid var(--accent-mid);
  color:var(--accent);
}
.bh-actions { display:flex; gap:4px; }
.bh-actions button {
  background:transparent; border:none; color:var(--muted);
  font-size:16px; width:30px; height:30px; border-radius:7px;
  cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:background .12s, color .12s;
}
.bh-actions button:hover { background:rgba(255,255,255,.07); color:#fff; }

/* â”€â”€â”€ STATUS INDICATOR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.status-text { font-size:12px; }
.status-text.online { color:var(--green); }
.status-text.idle { color:var(--amber); }
.status-text.dnd { color:var(--red); }
.status-text.offline { color:var(--muted); }

/* â”€â”€â”€ ROLES/TAGS DISPLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.role-tag {
  display:inline-flex; align-items:center;
  font-size:10px; font-weight:700; padding:2px 7px; border-radius:100px;
  margin-right:3px;
}

/* â”€â”€â”€ TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.toast {
  position:fixed; bottom:22px; right:22px; z-index:9999;
  background:var(--panel); border:1px solid var(--border);
  border-radius:10px; padding:12px 18px;
  font-size:13px; font-weight:500;
  box-shadow:0 16px 50px rgba(0,0,0,.7);
  transform:translateY(18px); opacity:0;
  transition:transform .28s cubic-bezier(.22,1,.36,1), opacity .28s;
  max-width:280px; pointer-events:none;
}
.toast.show { transform:translateY(0); opacity:1; }
.toast.success { border-left:3px solid var(--green); color:#a3e8b8; }
.toast.error { border-left:3px solid var(--red); color:#fca5a5; }
.toast.info { border-left:3px solid var(--accent); color:var(--accent); }

/* â”€â”€â”€ CONTEXT MENU â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ctx-menu {
  display:none; position:fixed; z-index:700;
  background:var(--panel2); border:1px solid var(--border);
  border-radius:10px; min-width:180px;
  box-shadow:0 12px 40px rgba(0,0,0,.7);
  padding:5px;
  animation:mIn .15s cubic-bezier(.22,1,.36,1) both;
}
.ctx-menu.open { display:block; }
.ctx-item {
  display:flex; align-items:center; gap:9px;
  padding:8px 12px; border-radius:7px; cursor:pointer; font-size:13.5px;
  transition:background .1s, color .1s;
}
.ctx-item:hover { background:rgba(255,255,255,.07); }
.ctx-item.danger { color:var(--red); }
.ctx-item.danger:hover { background:rgba(248,113,113,.12); }
.ctx-sep { height:1px; background:var(--border); margin:4px 0; }

/* â”€â”€â”€ EDITING MESSAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.msg-edit-input {
  width:100%; background:var(--panel); border:1.5px solid rgba(255,249,62,.3);
  border-radius:8px; color:#fff; font-family:'DM Sans',sans-serif; font-size:14px;
  padding:7px 11px; outline:none; resize:none; max-height:120px; line-height:1.5;
  margin-top:4px;
}
.edit-actions { display:flex; gap:6px; margin-top:6px; }
.edit-actions button { font-size:12px; padding:5px 12px; }

/* â”€â”€â”€ INVITE LINK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.invite-box {
  display:flex; align-items:center;
  background:rgba(255,249,62,.06); border:1px solid rgba(255,249,62,.14);
  border-radius:9px; padding:10px 14px; gap:10px; margin-bottom:14px;
}
.invite-box input {
  flex:1; background:transparent; border:none; outline:none;
  color:var(--accent); font-family:monospace; font-size:13px;
}
</style>
</head>
<body>

<!-- ICON RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Home">
    <img src="Fortized icon.png" alt="F" onerror="this.outerHTML='<span style=font-size:22px;font-family:Syne,sans-serif;font-weight:800;color:var(--accent)>F</span>'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn active" id="rail-home" onclick="navigate('home')" data-tip="Home"><span class="icon">ğŸ </span></div>
  <div class="rail-btn" id="rail-discover" onclick="navigate('discover')" data-tip="Discover"><span class="icon">ğŸ§­</span></div>
  <div class="rail-btn" id="rail-atelier" onclick="navigate('atelier')" data-tip="Atelier"><span class="icon">ğŸ’</span></div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-add-bastion" onclick="openCreateBastion()" data-tip="Create Bastion" title="Create Bastion">+</div>
  <div class="rail-spacer"></div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Profile & Settings"><span class="icon">âš™ï¸</span></div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sb-header">
    <span id="sb-title">Fortized</span>
    <div class="hdr-actions" id="sb-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sb-scroll"></div>
  <div class="userbar" id="userbar">
    <div class="userbar-avatar" id="ub-av" onclick="showMyProfile()">
      <div class="ub-status online" id="ub-status-dot"></div>
    </div>
    <div class="userbar-info">
      <div class="userbar-name" id="ub-name">â€”</div>
      <div class="userbar-tag" id="ub-tag">@â€”</div>
    </div>
    <div class="ub-actions">
      <button title="Set Status" onclick="openStatusModal()">ğŸ˜¶</button>
      <button title="Log Out" onclick="logout()">ğŸšª</button>
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="top-title"><span class="t-prefix">ğŸ </span><span>Home</span></div>
    <div class="topbar-sep"></div>
    <div class="topbar-desc" id="top-desc">Welcome to Fortized</div>
    <div class="topbar-actions">
      <div class="onyx-pill" onclick="navigate('atelier')">ğŸ’ <span id="top-onyx">0</span></div>
      <button title="Toggle Members" id="toggle-members-btn" onclick="toggleMembersPanel()" style="display:none;">ğŸ‘¥</button>
      <button title="Notifications" onclick="showToast('No new notifications','info')">ğŸ””</button>
    </div>
  </div>

  <div class="content" id="content">
    <!-- HOME -->
    <div id="view-home" class="view active" style="flex-direction:row;">
      <div class="home-left" id="home-left">
        <div class="sidebar-header">
          <span>Direct Messages</span>
          <div class="hdr-actions"><button onclick="openNewDM()" title="New DM">+</button></div>
        </div>
        <div class="sidebar-scroll" id="dm-list"></div>
      </div>
      <div id="home-area" style="flex:1;display:flex;flex-direction:column;"></div>
    </div>

    <!-- BASTION -->
    <div id="view-bastion" class="view" style="flex-direction:column;">
      <div id="bastion-inner" style="flex:1;display:flex;flex-direction:row;min-height:0;"></div>
    </div>

    <!-- DISCOVER -->
    <div id="view-discover" class="view discover-view" style="flex-direction:column;">
      <div class="discover-hero">
        <h2>Discover Bastions</h2>
        <p>Find communities, join the battle, and make your mark.</p>
        <div class="discover-search">
          <span class="s-ico">ğŸ”</span>
          <input type="text" placeholder="Search bastionsâ€¦" id="disc-search" oninput="filterBastions()">
        </div>
      </div>
      <div class="bastion-grid" id="bastion-grid"></div>
    </div>

    <!-- ATELIER -->
    <div id="view-atelier" class="view atelier-view" style="flex-direction:column;">
      <div class="atelier-hero">
        <div class="at-balance">
          <span style="font-size:32px;">ğŸ’</span>
          <div class="at-balance-text">
            <h3>Onyx Balance</h3>
            <div class="amount" id="at-balance">0</div>
          </div>
        </div>
        <div class="daily-btn" id="daily-btn" onclick="claimDaily()">
          <span>Daily Reward</span>
          <strong>+5 Onyx</strong>
          <span id="daily-status">Claim</span>
        </div>
      </div>
      <div class="at-title">Radiance â€” Premium Status</div>
      <div class="rad-grid">
        <div class="rad-card" onclick="buyRadiance(110,'1 Day',1)">
          <div class="rc-icon">âœ¨</div>
          <div class="rc-dur">1 Day</div>
          <div class="rc-price">110 <span>Onyx</span></div>
          <div class="rc-perks">All Radiance perks<br>for 24 hours</div>
          <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
        </div>
        <div class="rad-card best" onclick="buyRadiance(770,'7 Days',7)">
          <div class="best-badge">Best Value</div>
          <div class="rc-icon">âš¡</div>
          <div class="rc-dur">7 Days</div>
          <div class="rc-price">770 <span>Onyx</span></div>
          <div class="rc-perks">All Radiance perks<br>for one week</div>
          <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
        </div>
        <div class="rad-card" onclick="buyRadiance(3300,'30 Days',30)">
          <div class="rc-icon">ğŸ‘‘</div>
          <div class="rc-dur">30 Days</div>
          <div class="rc-price">3,300 <span>Onyx</span></div>
          <div class="rc-perks">All Radiance perks<br>for a full month</div>
          <button class="btn-accent" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button>
        </div>
      </div>
      <div class="at-title">Radiance Perks</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:28px;">
        <div class="s-item" style="cursor:default;"><span class="si-ico">ğŸ¨</span><div class="si-txt"><div class="si-lbl">Custom Profile Badge</div><div class="si-sub">Exclusive Radiance crown on your profile</div></div></div>
        <div class="s-item" style="cursor:default;"><span class="si-ico">ğŸŒŸ</span><div class="si-txt"><div class="si-lbl">Animated Avatar Border</div><div class="si-sub">Glowing frame around your avatar</div></div></div>
        <div class="s-item" style="cursor:default;"><span class="si-ico">ğŸ’¬</span><div class="si-txt"><div class="si-lbl">Extended Messages</div><div class="si-sub">Up to 4000 chars per message</div></div></div>
        <div class="s-item" style="cursor:default;"><span class="si-ico">ğŸ“</span><div class="si-txt"><div class="si-lbl">100MB File Uploads</div><div class="si-sub">Standard limit is 8MB</div></div></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="view-profile" class="view profile-view" style="flex-direction:column;">
      <div class="pb"></div>
      <div class="pc">
        <div class="pav-row">
          <div class="pav" id="pav-big">
            <div class="pav-edit" onclick="changeAvatar()">âœï¸</div>
          </div>
          <div style="flex:1;">
            <div class="pname" id="pname-big">â€”</div>
            <div class="phandle" id="phandle">@â€”</div>
            <div class="pbio" id="pbio-display"></div>
            <div class="pstatus-badge" id="pstatus-display"></div>
          </div>
          <div class="pav-actions">
            <button class="btn-ghost" onclick="openEditProfile()" style="font-size:12.5px;padding:7px 14px;">Edit Profile</button>
          </div>
        </div>
        <div class="pstats" id="pstats"></div>
        <div style="height:20px;"></div>
        <div class="settings-section">
          <div class="settings-title">Account</div>
          <div class="s-item" onclick="showToast('Email settings coming soon','info')"><span class="si-ico">ğŸ“§</span><div class="si-txt"><div class="si-lbl">Email</div><div class="si-sub" id="pemail">â€”</div></div><span class="si-arr">â€º</span></div>
          <div class="s-item" onclick="openChangeUsername()"><span class="si-ico">ğŸ·ï¸</span><div class="si-txt"><div class="si-lbl">Change Username</div><div class="si-sub">Your @username is unique</div></div><span class="si-arr">â€º</span></div>
          <div class="s-item" onclick="openStatusModal()"><span class="si-ico">ğŸŸ¢</span><div class="si-txt"><div class="si-lbl">Status</div><div class="si-sub" id="pstatus-setting">Online</div></div><span class="si-arr">â€º</span></div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Preferences</div>
          <div class="s-item" onclick="showToast('Notifications coming soon','info')"><span class="si-ico">ğŸ””</span><div class="si-txt"><div class="si-lbl">Notifications</div><div class="si-sub">Manage alerts</div></div><span class="si-arr">â€º</span></div>
          <div class="s-item" onclick="showToast('Appearance coming soon','info')"><span class="si-ico">ğŸ¨</span><div class="si-txt"><div class="si-lbl">Appearance</div><div class="si-sub">Theme and display</div></div><span class="si-arr">â€º</span></div>
        </div>
        <div class="settings-section">
          <div class="settings-title">Danger Zone</div>
          <div class="s-item" onclick="logout()" style="border-color:rgba(248,113,113,.2);"><span class="si-ico">ğŸšª</span><div class="si-txt"><div class="si-lbl" style="color:var(--red);">Log Out</div><div class="si-sub">Sign out of your account</div></div></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE CARD POPUP -->
<div id="profile-popup" class="profile-popup">
  <div class="pp-banner" id="pp-banner">
    <button class="pp-close" onclick="closeProfilePopup()">Ã—</button>
    <div class="pp-av" id="pp-av"></div>
  </div>
  <div class="pp-body">
    <div class="pp-name" id="pp-name"></div>
    <div class="pp-handle" id="pp-handle"></div>
    <div class="pp-status" id="pp-status"></div>
    <div class="pp-tags" id="pp-tags"></div>
    <div class="pp-bio" id="pp-bio"></div>
    <div class="pp-actions" id="pp-actions"></div>
  </div>
</div>

<!-- CONTEXT MENU -->
<div id="ctx-menu" class="ctx-menu"></div>

<!-- MODALS -->

<!-- Create Bastion -->
<div class="modal-overlay" id="modal-create-bastion">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create a Bastion</div>
      <div class="modal-sub">Build your community fortress.</div>
      <div class="modal-error" id="create-err"></div>
      <div class="modal-label">Bastion Name</div>
      <input class="modal-input" id="b-name" placeholder="My Awesome Bastion" maxlength="32">
      <div class="modal-label">Description</div>
      <input class="modal-input" id="b-desc" placeholder="What's this Bastion about?" maxlength="80">
      <div class="modal-label">Tag (3-5 chars, e.g. FORT)</div>
      <input class="modal-input" id="b-tag" placeholder="FORT" maxlength="5" style="text-transform:uppercase;">
      <div class="modal-label">Pick an Icon</div>
      <div id="b-emoji-picker" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-create-bastion')">Cancel</button>
        <button class="btn-accent" onclick="createBastion()">Create</button>
      </div>
    </div>
  </div>
</div>

<!-- New DM -->
<div class="modal-overlay" id="modal-new-dm">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">New Direct Message</div>
      <div class="modal-sub">Enter a username to start a conversation.</div>
      <div class="modal-error" id="dm-err"></div>
      <div class="modal-label">Username (with or without @)</div>
      <input class="modal-input" id="dm-username" placeholder="@username">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-new-dm')">Cancel</button>
        <button class="btn-accent" onclick="startDM()">Open DM</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Friend -->
<div class="modal-overlay" id="modal-add-friend">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Add Friend</div>
      <div class="modal-sub">Enter their exact @username.</div>
      <div class="modal-error" id="af-err"></div>
      <input class="modal-input" id="af-username" placeholder="@username">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-add-friend')">Cancel</button>
        <button class="btn-accent" onclick="addFriend()">Send Request</button>
      </div>
    </div>
  </div>
</div>

<!-- Buy Confirm -->
<div class="modal-overlay" id="modal-buy">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="buy-title">Activate Radiance?</div>
      <div class="modal-sub" id="buy-sub">This will deduct Onyx.</div>
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-buy')">Cancel</button>
        <button class="btn-accent" onclick="confirmBuy()">Confirm</button>
      </div>
    </div>
  </div>
</div>

<!-- Status Modal -->
<div class="modal-overlay" id="modal-status">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Set Your Status</div>
      <div class="modal-sub">Let others know what you're up to.</div>
      <div class="modal-label">Online Status</div>
      <select class="modal-select" id="status-select">
        <option value="online">ğŸŸ¢ Online</option>
        <option value="idle">ğŸŸ¡ Idle</option>
        <option value="dnd">ğŸ”´ Do Not Disturb</option>
        <option value="offline">âš« Invisible</option>
      </select>
      <div class="modal-label">Custom Status Message</div>
      <input class="modal-input" id="status-msg" placeholder="What are you up to?" maxlength="60">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-status')">Cancel</button>
        <button class="btn-accent" onclick="saveStatus()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Profile -->
<div class="modal-overlay" id="modal-edit-profile">
  <div class="modal wide">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Edit Profile</div>
      <div class="modal-sub">Customize how others see you.</div>
      <div class="modal-label">Display Name</div>
      <input class="modal-input" id="ep-displayname" placeholder="Your display name" maxlength="32">
      <div class="modal-label">Bio</div>
      <input class="modal-input" id="ep-bio" placeholder="Tell people about yourselfâ€¦" maxlength="120">
      <div class="modal-label">Avatar Emoji (or leave blank)</div>
      <input class="modal-input" id="ep-avatar-emoji" placeholder="ğŸ®" maxlength="2">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-edit-profile')">Cancel</button>
        <button class="btn-accent" onclick="saveProfile()">Save Changes</button>
      </div>
    </div>
  </div>
</div>

<!-- Change Username -->
<div class="modal-overlay" id="modal-change-username">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Change Username</div>
      <div class="modal-sub">Your @username must be unique across Fortized.</div>
      <div class="modal-error" id="cu-err"></div>
      <div class="modal-label">New Username (no spaces, 3-20 chars)</div>
      <input class="modal-input" id="cu-username" placeholder="newusername" maxlength="20">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-change-username')">Cancel</button>
        <button class="btn-accent" onclick="changeUsername()">Change</button>
      </div>
    </div>
  </div>
</div>

<!-- Bastion Settings -->
<div class="modal-overlay" id="modal-bastion-settings">
  <div class="modal wide">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Bastion Settings</div>
      <div class="modal-sub" id="bsettings-sub"></div>
      <div class="modal-label">Bastion Name</div>
      <input class="modal-input" id="bsettings-name" maxlength="32">
      <div class="modal-label">Description</div>
      <input class="modal-input" id="bsettings-desc" maxlength="80">
      <div class="modal-label">Tag (e.g. FORT)</div>
      <input class="modal-input" id="bsettings-tag" maxlength="5" style="text-transform:uppercase;">
      <div class="modal-label">Icon</div>
      <div id="bsettings-emoji" style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px;"></div>
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:4px;">
        <div class="modal-label">Roles / Tags</div>
        <div id="bsettings-roles"></div>
        <div class="tag-input-row" style="margin-top:10px;">
          <input class="modal-input" id="new-role-name" placeholder="Role name" maxlength="20" style="margin-bottom:0;">
          <input class="modal-input" id="new-role-color" type="color" value="#fff93e" style="width:48px;padding:6px;margin-bottom:0;cursor:pointer;">
          <button class="btn-ghost" onclick="addRole()" style="padding:9px 14px;font-size:12.5px;">+ Add</button>
        </div>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:16px;">
        <div class="at-title" style="margin-bottom:12px;">Invite Link</div>
        <div class="invite-box" id="invite-box">
          <input id="invite-link-val" readonly>
          <button class="copy-btn" onclick="copyInvite()" title="Copy">ğŸ“‹</button>
        </div>
        <button class="btn-ghost" onclick="regenerateInvite()" style="font-size:12.5px;padding:7px 14px;margin-bottom:16px;">ğŸ”„ Regenerate Link</button>
      </div>
      <div style="border-top:1px solid var(--border);padding-top:16px;margin-top:4px;">
        <button class="btn-danger" onclick="deleteBastion()" style="width:100%;justify-content:center;">ğŸ—‘ Delete Bastion</button>
      </div>
      <div class="modal-actions" style="margin-top:16px;">
        <button class="btn-ghost" onclick="closeModal('modal-bastion-settings')">Cancel</button>
        <button class="btn-accent" onclick="saveBastionSettings()">Save</button>
      </div>
    </div>
  </div>
</div>

<!-- Join by Invite -->
<div class="modal-overlay" id="modal-join-invite">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Join a Bastion</div>
      <div class="modal-sub">Enter an invite code to join a Bastion.</div>
      <div class="modal-error" id="ji-err"></div>
      <input class="modal-input" id="ji-code" placeholder="Invite code (e.g. abc123)">
      <div class="modal-actions">
        <button class="btn-ghost" onclick="closeModal('modal-join-invite')">Cancel</button>
        <button class="btn-accent" onclick="joinByInvite()">Join</button>
      </div>
    </div>
  </div>
</div>

<!-- Assign Role Modal -->
<div class="modal-overlay" id="modal-assign-role">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Manage Roles</div>
      <div class="modal-sub" id="ar-sub"></div>
      <div id="ar-roles"></div>
      <div class="modal-actions" style="margin-top:12px;">
        <button class="btn-accent" onclick="closeModal('modal-assign-role')" style="flex:1;justify-content:center;">Done</button>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentUser = null;
let currentView = 'home';
let currentDM = null;
let currentBastion = null;
let currentChannel = null;
let membersPanelOpen = true;
let pendingBuy = null;
let editingMsgId = null;
let profilePopupUser = null;
let ctxTarget = null;

const EMOJIS = ['ğŸ°','âš”ï¸','ğŸ›¡ï¸','ğŸ¹','ğŸ”¥','âš¡','ğŸŒŒ','ğŸ®','ğŸ¯','ğŸ’€','ğŸ‰','ğŸŒ™','ğŸŒŸ','ğŸ’','ğŸ—¡ï¸','ğŸª','ğŸ´','ğŸŒŠ','ğŸ¦','ğŸ”®'];
const STATUS_LABELS = { online:'Online', idle:'Idle', dnd:'Do Not Disturb', offline:'Invisible' };
const STATUS_COLORS = { online:'var(--green)', idle:'var(--amber)', dnd:'var(--red)', offline:'#374151' };

const PUBLIC_BASTIONS = [
  {icon:'âš”ï¸',name:'Warfront Elite',tag:'WAR',desc:'Competitive FPS and strategy enthusiasts.',members:1842,online:234},
  {icon:'ğŸ‰',name:'Dragon Realm',tag:'DRG',desc:'Fantasy RPG and tabletop gaming community.',members:932,online:87},
  {icon:'ğŸ®',name:'Casual Crew',tag:'CREW',desc:'Laid-back gamers who just want to have fun.',members:3201,online:418},
  {icon:'ğŸŒŒ',name:'Void Runners',tag:'VOID',desc:'Sci-fi games, space sims, and futurism.',members:671,online:55},
  {icon:'ğŸ¯',name:'Sniper Guild',tag:'SNPR',desc:'Precision shooters and competitive ranked.',members:2156,online:310},
  {icon:'ğŸ”¥',name:'Blaze Bastions',tag:'BLZ',desc:'The hottest new community on Fortized.',members:489,online:102},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('DOMContentLoaded', () => {
  const username = localStorage.getItem('fortized_current_user');
  if(!username){ location.href='login.html'; return; }
  const users = getUsers();
  currentUser = users.find(u => u.username === username);
  if(!currentUser){ location.href='login.html'; return; }
  migrateUser();
  saveUser();
  buildUI();
  navigate('home');
});

function migrateUser(){
  if(!Array.isArray(currentUser.bastions)) currentUser.bastions = [];
  if(!Array.isArray(currentUser.friends)) currentUser.friends = [];
  if(!Array.isArray(currentUser.dms)) currentUser.dms = [];
  if(typeof currentUser.onyx !== 'number') currentUser.onyx = 5;
  if(!currentUser.lastDaily) currentUser.lastDaily = null;
  if(!currentUser.status) currentUser.status = 'online';
  if(!currentUser.statusMsg) currentUser.statusMsg = '';
  if(!currentUser.displayName) currentUser.displayName = currentUser.username;
  if(!currentUser.bio) currentUser.bio = '';
  if(!currentUser.avatarEmoji) currentUser.avatarEmoji = '';
  // Migrate bastions
  currentUser.bastions.forEach(b => {
    if(!b.tag) b.tag = b.name.slice(0,4).toUpperCase();
    if(!Array.isArray(b.roles)) b.roles = [{name:'Member',color:'#7a8599',id:'member'}];
    if(!b.inviteCode) b.inviteCode = genCode();
    if(!b.memberRoles) b.memberRoles = {};
    b.channels = b.channels || [{name:'general',messages:[]},{name:'announcements',messages:[]}];
    b.members = b.members || [currentUser.username];
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STORAGE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getUsers(){ return JSON.parse(localStorage.getItem('fortized_users')) || []; }
function saveUser(){
  const users = getUsers();
  const idx = users.findIndex(u => u.username === currentUser.username);
  if(idx>-1){ users[idx]=currentUser; localStorage.setItem('fortized_users',JSON.stringify(users)); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BUILD UI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildUI(){
  updateUserbar();
  updateOnyxDisplay();
  buildRailBastions();
  renderDMList();
  buildDiscoverGrid();
  buildEmojiPicker('b-emoji-picker');
  buildProfileView();
  updateDailyBtn();
}

function updateUserbar(){
  const ua = document.getElementById('ub-av');
  const dn = currentUser.displayName || currentUser.username;
  const emoji = currentUser.avatarEmoji;
  ua.innerHTML = emoji
    ? `<span style="font-size:16px;">${emoji}</span><div class="ub-status ${currentUser.status||'online'}" id="ub-status-dot"></div>`
    : `<span style="font-size:14px;">${dn[0].toUpperCase()}</span><div class="ub-status ${currentUser.status||'online'}" id="ub-status-dot"></div>`;
  document.getElementById('ub-name').textContent = dn;
  document.getElementById('ub-tag').textContent = '@' + currentUser.username;
}

function updateOnyxDisplay(){
  document.getElementById('top-onyx').textContent = currentUser.onyx;
  document.getElementById('at-balance').textContent = currentUser.onyx;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function navigate(view){
  document.querySelectorAll('.view').forEach(v => { v.style.display='none'; v.classList.remove('active'); });
  document.querySelectorAll('.rail-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b => b.classList.remove('active'));
  const btn = document.getElementById('rail-'+view);
  if(btn) btn.classList.add('active');
  currentView = view;
  document.getElementById('toggle-members-btn').style.display = 'none';

  if(view==='home'){
    showView('view-home');
    setSidebar('home');
    setTopbar('ğŸ ','Home','Your direct messages and friends');
    renderDMList();
    if(!currentDM) renderHomeLanding();
  } else if(view==='discover'){
    showView('view-discover');
    setSidebar('discover');
    setTopbar('ğŸ§­','Discover','Find and join public Bastions');
  } else if(view==='atelier'){
    showView('view-atelier');
    setSidebar('atelier');
    setTopbar('ğŸ’','Atelier','Spend your Onyx on Radiance and more');
    updateOnyxDisplay(); updateDailyBtn();
  } else if(view==='profile'){
    showView('view-profile');
    setSidebar('profile');
    setTopbar('âš™ï¸','Profile & Settings','');
    buildProfileView();
  }
}

function showView(id){
  const el=document.getElementById(id);
  if(el){ el.style.display='flex'; el.classList.add('active'); }
}
function setTopbar(ico,title,desc){
  document.getElementById('top-title').innerHTML=`<span class="t-prefix">${ico}</span><span>${title}</span>`;
  document.getElementById('top-desc').textContent=desc;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SIDEBAR CONTEXT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setSidebar(ctx){
  const scroll=document.getElementById('sb-scroll');
  const title=document.getElementById('sb-title');
  const actions=document.getElementById('sb-actions');
  scroll.innerHTML=''; actions.innerHTML='';

  if(ctx==='home'){
    title.textContent='Fortized';
    actions.innerHTML=`<button onclick="openModal('modal-join-invite')" title="Join Bastion">ğŸ”—</button>`;
    addSbItem(scroll,'ğŸ ','Home',()=>{ currentDM=null; renderHomeLanding(); });
    addSbItem(scroll,'ğŸ‘¥','Friends',()=>renderFriends());
    const lbl=mkSbLabel('Direct Messages');
    lbl.querySelector('button').onclick=openNewDM;
    scroll.appendChild(lbl);
    renderDMSidebar(scroll);
  } else if(ctx==='discover'){
    title.textContent='Discover';
  } else if(ctx==='atelier'){
    title.textContent='Atelier';
    scroll.appendChild(mkSbLabel('Store'));
    [{icon:'âœ¨',label:'Radiance'},{icon:'ğŸ’',label:'Onyx'},{icon:'ğŸ¨',label:'Cosmetics'}].forEach(i=>addSbItem(scroll,i.icon,i.label));
  } else if(ctx==='profile'){
    title.textContent='Settings';
    [{i:'ğŸ‘¤',l:'My Profile'},{i:'ğŸ”’',l:'Privacy'},{i:'ğŸ””',l:'Notifications'},{i:'ğŸ¨',l:'Appearance'}].forEach(x=>addSbItem(scroll,x.i,x.l));
  } else if(ctx==='bastion' && currentBastion!==null){
    const b=currentUser.bastions[currentBastion];
    title.innerHTML=`${b.icon||'ğŸ°'} <span style="font-size:12px;">${b.name}</span>`;
    actions.innerHTML=`<button onclick="openBastionSettings(${currentBastion})" title="Settings">âš™ï¸</button><button onclick="openModal('modal-join-invite')" title="Join Bastion">ğŸ”—</button>`;
    const lbl=mkSbLabel('Text Channels');
    lbl.querySelector('button').onclick=()=>addChannel(currentBastion);
    scroll.appendChild(lbl);
    (b.channels||[]).forEach((ch,ci)=>{
      const el=document.createElement('div');
      el.className='ch-item'+(currentChannel===ci?' active':'');
      el.innerHTML=`<span class="ch-prefix">#</span><span style="flex:1;">${ch.name}</span>`;
      el.onclick=()=>openChannel(currentBastion,ci);
      el.oncontextmenu=(e)=>showChannelCtx(e,currentBastion,ci);
      scroll.appendChild(el);
    });
    scroll.appendChild(mkSbLabel('Voice Channels'));
    const vc=document.createElement('div');
    vc.className='ch-item';
    vc.innerHTML=`<span class="ch-prefix">ğŸ”Š</span><span>General Voice</span>`;
    vc.onclick=()=>showToast('Voice channels coming soon','info');
    scroll.appendChild(vc);
  }
}

function addSbItem(container,icon,label,action){
  const el=document.createElement('div');
  el.className='sidebar-item';
  el.innerHTML=`<div class="s-icon"><span>${icon}</span></div><span style="flex:1;">${label}</span>`;
  if(action) el.onclick=action;
  container.appendChild(el);
  return el;
}
function mkSbLabel(text){
  const el=document.createElement('div');
  el.className='sidebar-label';
  el.innerHTML=`<span>${text}</span><button>+</button>`;
  return el;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HOME LANDING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderHomeLanding(){
  const area=document.getElementById('home-area');
  const hasRad=currentUser.radianceUntil&&new Date(currentUser.radianceUntil)>new Date();
  const dn=currentUser.displayName||currentUser.username;
  const av=currentUser.avatarEmoji||dn[0].toUpperCase();
  area.innerHTML=`
    <div class="home-main">
      <div class="home-landing">
        <div class="home-hero">
          <div class="home-hero-inner">
            <div class="home-hero-av">${currentUser.avatarEmoji?`<span style="font-size:24px;">${currentUser.avatarEmoji}</span>`:av}</div>
            <div class="home-hero-text">
              <h2>Hey, ${dn}!</h2>
              <p>@${currentUser.username} Â· Welcome back to the Fortress</p>
              ${hasRad?`<div class="rad-badge" style="margin-top:8px;">âœ¨ Radiance â€” expires ${new Date(currentUser.radianceUntil).toLocaleDateString()}</div>`:''}
              ${currentUser.statusMsg?`<div style="font-size:12px;color:var(--muted);margin-top:6px;">Status: ${currentUser.statusMsg}</div>`:''}
            </div>
          </div>
        </div>
        <div class="home-cards">
          <div class="home-card" onclick="renderFriends()">
            <div class="card-num">${currentUser.friends.length}</div>
            <h4>Friends</h4><p>View your friends list</p>
          </div>
          <div class="home-card" onclick="openNewDM()">
            <div class="card-num">${currentUser.dms.length}</div>
            <h4>Messages</h4><p>Open a direct message</p>
          </div>
          <div class="home-card" onclick="navigate('atelier')">
            <div class="card-num">${currentUser.onyx}</div>
            <h4>Onyx</h4><p>Your current balance</p>
          </div>
          <div class="home-card" onclick="navigate('discover')">
            <div class="card-num">${currentUser.bastions.length}</div>
            <h4>Bastions</h4><p>Your communities</p>
          </div>
        </div>
      </div>
    </div>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FRIENDS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderFriends(){
  const area=document.getElementById('home-area');
  const users=getUsers();
  area.innerHTML=`
    <div class="home-main">
      <div class="home-landing">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;">
          <div style="font-family:'Syne',sans-serif;font-size:17px;font-weight:800;">Friends</div>
          <button class="btn-accent" onclick="openModal('modal-add-friend')" style="font-size:12.5px;padding:8px 16px;">+ Add Friend</button>
        </div>
        ${currentUser.friends.length===0?`
          <div class="empty-state" style="padding:60px 0;">
            <div class="ei">ğŸ‘¥</div><h3>No friends yet</h3>
            <p>Add friends by their @username to start chatting.</p>
            <button class="btn-accent" onclick="openModal('modal-add-friend')">Add a Friend</button>
          </div>`
          :currentUser.friends.map(f=>{
            const fu=users.find(u=>u.username===f);
            const dn=fu?fu.displayName||fu.username:f;
            const st=fu?fu.status||'offline':'offline';
            const emoji=fu?fu.avatarEmoji:'';
            return `<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--border);border-radius:10px;margin-bottom:8px;">
              <div class="dm-av" style="width:38px;height:38px;font-size:14px;" onclick="showProfileCard(event,'${f}')">
                ${emoji?`<span style="font-size:18px;">${emoji}</span>`:`<span>${dn[0].toUpperCase()}</span>`}
                <div class="st-dot ${st}"></div>
              </div>
              <div style="flex:1;">
                <div style="font-size:13.5px;font-weight:600;color:#fff;">${dn}</div>
                <div style="font-size:11.5px;color:var(--muted);">@${f} Â· <span class="status-text ${st}">${STATUS_LABELS[st]||'Offline'}</span></div>
              </div>
              <button class="btn-ghost" onclick="startDMWith('${f}')" style="font-size:12px;padding:6px 14px;">Message</button>
              <button class="btn-danger" onclick="removeFriend('${f}')" style="font-size:12px;padding:6px 14px;">Remove</button>
            </div>`;
          }).join('')}
      </div>
    </div>
  `;
}

function removeFriend(username){
  currentUser.friends=currentUser.friends.filter(f=>f!==username);
  saveUser();
  showToast(`${username} removed`,'info');
  renderFriends();
}

function openAddFriend(){ openModal('modal-add-friend'); document.getElementById('af-err').textContent=''; document.getElementById('af-username').value=''; }

function addFriend(){
  let name=document.getElementById('af-username').value.trim().replace(/^@/,'');
  if(!name){ document.getElementById('af-err').textContent='Enter a username.'; return; }
  if(name===currentUser.username){ document.getElementById('af-err').textContent="You can't add yourself!"; return; }
  if(currentUser.friends.includes(name)){ document.getElementById('af-err').textContent='Already friends!'; return; }
  const users=getUsers();
  if(!users.find(u=>u.username===name)){ document.getElementById('af-err').textContent='User not found.'; return; }
  currentUser.friends.push(name);
  saveUser();
  closeModal('modal-add-friend');
  showToast(`${name} added as friend!`,'success');
  if(document.querySelector('#home-area .home-landing')) renderFriends();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DM CHAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDMList(){
  const c=document.getElementById('dm-list');
  if(!c) return;
  c.innerHTML='';
  if(!currentUser.dms.length){
    c.innerHTML='<div style="padding:12px 14px;font-size:12.5px;color:var(--muted);">No DMs yet.</div>';
    return;
  }
  const users=getUsers();
  currentUser.dms.forEach((dm,i)=>{
    const fu=users.find(u=>u.username===dm.with);
    const dn=fu?fu.displayName||fu.username:dm.with;
    const st=fu?fu.status||'offline':'offline';
    const emoji=fu?fu.avatarEmoji:'';
    const el=document.createElement('div');
    el.className='dm-friend-item'+(currentDM===i?' active':'');
    el.innerHTML=`
      <div class="dm-av">
        ${emoji?`<span style="font-size:14px;">${emoji}</span>`:`<span>${dn[0].toUpperCase()}</span>`}
        <div class="st-dot ${st}"></div>
      </div>
      <div class="dm-info">
        <div class="dm-name">${dn}</div>
        <div class="dm-preview">${dm.messages&&dm.messages.length?(escHtml(dm.messages[dm.messages.length-1].text).slice(0,28)+'â€¦'):'No messages yet'}</div>
      </div>
      <button class="dm-close" onclick="closeDMTab(event,${i})">Ã—</button>
    `;
    el.onclick=(e)=>{ if(!e.target.classList.contains('dm-close')) openDMChat(i); };
    c.appendChild(el);
  });
}

function renderDMSidebar(container){
  if(!currentUser.dms.length){
    const el=document.createElement('div');
    el.style.cssText='padding:10px 14px;font-size:12px;color:var(--muted);';
    el.textContent='No DMs yet.';
    container.appendChild(el); return;
  }
  const users=getUsers();
  currentUser.dms.forEach((dm,i)=>{
    const fu=users.find(u=>u.username===dm.with);
    const dn=fu?fu.displayName||fu.username:dm.with;
    const el=document.createElement('div');
    el.className='sidebar-item'+(currentDM===i?' active':'');
    el.innerHTML=`<div class="s-icon" style="font-size:13px;">${(dn[0]||'?').toUpperCase()}</div><span style="flex:1;">${dn}</span>`;
    el.onclick=()=>openDMChat(i);
    container.appendChild(el);
  });
}

function openNewDM(){
  document.getElementById('dm-username').value='';
  document.getElementById('dm-err').textContent='';
  openModal('modal-new-dm');
}

function startDM(){
  let name=document.getElementById('dm-username').value.trim().replace(/^@/,'');
  if(!name){ document.getElementById('dm-err').textContent='Enter a username.'; return; }
  if(name===currentUser.username){ document.getElementById('dm-err').textContent="You can't DM yourself!"; return; }
  const users=getUsers();
  if(!users.find(u=>u.username===name)){ document.getElementById('dm-err').textContent='User not found.'; return; }
  closeModal('modal-new-dm');
  startDMWith(name);
}

function startDMWith(name){
  if(currentView!=='home') navigate('home');
  let idx=currentUser.dms.findIndex(d=>d.with===name);
  if(idx===-1){ currentUser.dms.push({with:name,messages:[]}); saveUser(); idx=currentUser.dms.length-1; }
  renderDMList();
  openDMChat(idx);
}

function closeDMTab(e,i){
  e.stopPropagation();
  currentUser.dms.splice(i,1);
  saveUser();
  if(currentDM===i){ currentDM=null; renderHomeLanding(); }
  else if(currentDM>i) currentDM--;
  renderDMList();
}

function openDMChat(idx){
  currentDM=idx;
  const dm=currentUser.dms[idx];
  const users=getUsers();
  const fu=users.find(u=>u.username===dm.with);
  const dn=fu?fu.displayName||fu.username:dm.with;
  const st=fu?fu.status||'offline':'offline';
  const emoji=fu?fu.avatarEmoji:'';
  const area=document.getElementById('home-area');
  setTopbar('ğŸ’¬',dn,`@${dm.with} Â· ${STATUS_LABELS[st]||'Offline'}`);
  area.innerHTML=`
    <div class="chat-view" id="dm-chat">
      <div class="chat-msgs" id="chat-msgs-${idx}">
        <div class="chat-welcome">
          <div class="cw-av">${emoji?`<span style="font-size:22px;">${emoji}</span>`:`<span style="font-size:22px;">${dn[0].toUpperCase()}</span>`}</div>
          <h3>${dn}</h3>
          <p>Beginning of your DM history with <strong>@${dm.with}</strong>. <span class="status-text ${st}">${STATUS_LABELS[st]||'Offline'}</span></p>
        </div>
        ${renderMsgs(dm.messages||[], 'dm', idx)}
      </div>
      <div class="typing-indicator" id="typing-${idx}"></div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-btns">
            <button onclick="showToast('File upload coming soon','info')">ğŸ“</button>
            <button onclick="showToast('Emoji picker coming soon','info')">ğŸ˜Š</button>
          </div>
          <textarea id="dm-input-${idx}" placeholder="Message @${dm.with}" rows="1"
            onkeydown="dmKeydown(event,${idx})" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendDM(${idx})">â¤</button>
        </div>
      </div>
    </div>
  `;
  scrollBottom('chat-msgs-'+idx);
  renderDMList();
}

function renderMsgs(msgs, type, idx){
  if(!msgs.length) return '';
  return msgs.map((m,i)=>{
    const isOwn=m.from===currentUser.username;
    const prev=msgs[i-1];
    const isCont=prev&&prev.from===m.from;
    const users=getUsers();
    const fu=users.find(u=>u.username===m.from);
    const dn=fu?fu.displayName||fu.username:m.from;
    const emoji=fu?fu.avatarEmoji:'';
    const avContent=emoji?`<span style="font-size:14px;">${emoji}</span>`:`<span>${dn[0].toUpperCase()}</span>`;
    const editedTag=m.edited?`<span class="msg-edited">(edited)</span>`:'';
    return `
      <div class="msg-group ${isOwn?'own':''} ${isCont?'msg-cont':''}" id="msg-${type}-${idx}-${i}">
        <div class="msg-actions">
          <button class="msg-act-btn" title="React" onclick="showToast('Reactions coming soon','info')">ğŸ˜Š</button>
          ${isOwn?`<button class="msg-act-btn" title="Edit" onclick="startEditMsg('${type}',${idx},${i})">âœï¸</button>`:''}
          ${isOwn?`<button class="msg-act-btn" title="Delete" onclick="deleteMsg('${type}',${idx},${i})" style="color:var(--red);">ğŸ—‘</button>`:''}
          <button class="msg-act-btn" title="Copy" onclick="copyMsg(${i},'${type}',${idx})">ğŸ“‹</button>
        </div>
        <div class="msg-av" onclick="showProfileCard(event,'${m.from}')">${avContent}</div>
        <div class="msg-body">
          <div class="msg-meta">
            <span class="msg-author" onclick="showProfileCard(event,'${m.from}')">${dn}</span>
            <span class="msg-time">${m.time||''}</span>
            ${editedTag}
          </div>
          <div class="msg-bubble" id="bubble-${type}-${idx}-${i}">${escHtml(m.text)}</div>
        </div>
      </div>
    `;
  }).join('');
}

function sendDM(idx){
  const input=document.getElementById('dm-input-'+idx);
  if(!input) return;
  const text=input.value.trim();
  if(!text) return;
  const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  currentUser.dms[idx].messages.push({from:currentUser.username,text,time});
  saveUser();
  input.value=''; input.style.height='';
  openDMChat(idx);
}

function dmKeydown(e,idx){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendDM(idx);} }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EDIT / DELETE MESSAGES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startEditMsg(type,idx,msgIdx){
  const msgs=type==='dm'?currentUser.dms[idx].messages:currentUser.bastions[idx].channels[currentChannel].messages;
  const msg=msgs[msgIdx];
  const bubble=document.getElementById(`bubble-${type}-${idx}-${msgIdx}`);
  if(!bubble) return;
  bubble.innerHTML=`
    <textarea class="msg-edit-input" id="edit-input" rows="1" oninput="autoResize(this)">${escHtml(msg.text)}</textarea>
    <div class="edit-actions">
      <button class="btn-ghost" onclick="cancelEdit('${type}',${idx},${msgIdx})" style="font-size:12px;padding:5px 12px;">Cancel</button>
      <button class="btn-accent" onclick="saveEdit('${type}',${idx},${msgIdx})" style="font-size:12px;padding:5px 12px;">Save</button>
    </div>
  `;
  const ta=document.getElementById('edit-input');
  ta.focus(); autoResize(ta);
}

function saveEdit(type,idx,msgIdx){
  const ta=document.getElementById('edit-input');
  if(!ta) return;
  const text=ta.value.trim();
  if(!text){ showToast("Message can't be empty",'error'); return; }
  if(type==='dm'){
    currentUser.dms[idx].messages[msgIdx].text=text;
    currentUser.dms[idx].messages[msgIdx].edited=true;
    saveUser(); openDMChat(idx);
  } else {
    currentUser.bastions[idx].channels[currentChannel].messages[msgIdx].text=text;
    currentUser.bastions[idx].channels[currentChannel].messages[msgIdx].edited=true;
    saveUser(); openChannel(idx,currentChannel);
  }
}

function cancelEdit(type,idx,msgIdx){
  if(type==='dm') openDMChat(idx);
  else openChannel(idx,currentChannel);
}

function deleteMsg(type,idx,msgIdx){
  if(!confirm('Delete this message?')) return;
  if(type==='dm'){
    currentUser.dms[idx].messages.splice(msgIdx,1);
    saveUser(); openDMChat(idx);
  } else {
    currentUser.bastions[idx].channels[currentChannel].messages.splice(msgIdx,1);
    saveUser(); openChannel(idx,currentChannel);
  }
}

function copyMsg(msgIdx,type,idx){
  const msgs=type==='dm'?currentUser.dms[idx].messages:currentUser.bastions[idx].channels[currentChannel].messages;
  navigator.clipboard.writeText(msgs[msgIdx].text).then(()=>showToast('Copied!','success'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BASTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRailBastions(){
  const c=document.getElementById('rail-bastions');
  c.innerHTML='';
  currentUser.bastions.forEach((b,i)=>{
    const el=document.createElement('div');
    el.className='rail-bastion'+(currentBastion===i?' active':'');
    el.setAttribute('data-tip',b.name);
    el.textContent=b.icon||'ğŸ°';
    el.onclick=()=>openBastion(i);
    c.appendChild(el);
  });
}

function openBastion(idx){
  currentBastion=idx;
  const b=currentUser.bastions[idx];
  if(!b.channels||!b.channels.length) b.channels=[{name:'general',messages:[]},{name:'announcements',messages:[]}];
  migrateUser(); saveUser();
  document.querySelectorAll('.rail-btn').forEach(x=>x.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((x,i)=>x.classList.toggle('active',i===idx));
  setSidebar('bastion');
  document.querySelectorAll('.view').forEach(v=>{v.style.display='none';v.classList.remove('active');});
  showView('view-bastion');
  document.getElementById('toggle-members-btn').style.display='flex';
  openChannel(idx,0);
}

function openChannel(bastionIdx,chIdx){
  currentBastion=bastionIdx;
  currentChannel=chIdx;
  const b=currentUser.bastions[bastionIdx];
  const ch=b.channels[chIdx];
  setTopbar('#',ch.name,`${b.icon||'ğŸ°'} ${b.name} â€” #${ch.name}`);
  // update sidebar highlight
  document.querySelectorAll('#sb-scroll .ch-item').forEach((el,i)=>el.classList.toggle('active',i===chIdx));
  const inner=document.getElementById('bastion-inner');
  inner.innerHTML=`
    <div class="chat-view" style="flex:1;min-width:0;">
      <div class="bastion-header">
        <div class="bh-name"># ${ch.name} <span class="bh-tag">${b.tag||b.name.slice(0,4).toUpperCase()}</span></div>
        <div class="bh-actions">
          <button onclick="toggleMembersPanel()" title="Toggle Members">ğŸ‘¥</button>
          <button onclick="openBastionSettings(${bastionIdx})" title="Settings">âš™ï¸</button>
        </div>
      </div>
      <div class="chat-msgs" id="bastion-msgs-${bastionIdx}-${chIdx}">
        <div class="chat-welcome">
          <div class="cw-av" style="border-radius:10px;">#</div>
          <h3>#${ch.name}</h3>
          <p>Beginning of <strong>#${ch.name}</strong>. Say hello!</p>
        </div>
        ${renderMsgs(ch.messages||[], 'bastion-ch', bastionIdx)}
      </div>
      <div class="typing-indicator"></div>
      <div class="chat-input-wrap">
        <div class="chat-input-box">
          <div class="chat-input-btns">
            <button onclick="showToast('File upload coming soon','info')">ğŸ“</button>
            <button onclick="showToast('Emoji coming soon','info')">ğŸ˜Š</button>
          </div>
          <textarea id="bastion-input" placeholder="Message #${ch.name}" rows="1"
            onkeydown="bastionKeydown(event,${bastionIdx},${chIdx})" oninput="autoResize(this)"></textarea>
          <button class="chat-send" onclick="sendBastionMsg(${bastionIdx},${chIdx})">â¤</button>
        </div>
      </div>
    </div>
    <div id="members-panel" class="members-panel ${membersPanelOpen?'':'hidden'}">
      ${buildMembersPanel(bastionIdx)}
    </div>
  `;
  scrollBottom(`bastion-msgs-${bastionIdx}-${chIdx}`);
}

function buildMembersPanel(bastionIdx){
  const b=currentUser.bastions[bastionIdx];
  const users=getUsers();
  const members=b.members||[currentUser.username];
  const online=members.filter(m=>{ const u=users.find(x=>x.username===m); return u&&u.status&&u.status!=='offline'; });
  const offline=members.filter(m=>!online.includes(m));
  let html=`<div class="mp-header">Members â€” ${members.length}</div><div class="mp-scroll">`;
  if(online.length){
    html+=`<div class="mp-label">Online â€” ${online.length}</div>`;
    online.forEach(m=>{ html+=buildMpItem(m,b,users,bastionIdx); });
  }
  if(offline.length){
    html+=`<div class="mp-label">Offline â€” ${offline.length}</div>`;
    offline.forEach(m=>{ html+=buildMpItem(m,b,users,bastionIdx); });
  }
  html+='</div>';
  return html;
}

function buildMpItem(username,b,users,bastionIdx){
  const fu=users.find(u=>u.username===username);
  const dn=fu?fu.displayName||fu.username:username;
  const st=fu?fu.status||'offline':'offline';
  const emoji=fu?fu.avatarEmoji:'';
  const roles=b.memberRoles&&b.memberRoles[username]?b.memberRoles[username]:[];
  const roleObj=b.roles?b.roles.find(r=>roles.includes(r.id)):null;
  return `<div class="mp-item" onclick="showProfileCard(event,'${username}')">
    <div class="mp-av">
      ${emoji?`<span style="font-size:14px;">${emoji}</span>`:`<span>${dn[0].toUpperCase()}</span>`}
      <div class="st-dot ${st}" style="position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border-radius:50%;border:2px solid var(--channel);"></div>
    </div>
    <div class="mp-info">
      <div class="mp-name">${dn}</div>
      <div class="mp-role" style="${roleObj?'color:'+roleObj.color:''}">${roleObj?roleObj.name:(username===currentUser.username?'You':'Member')}</div>
    </div>
  </div>`;
}

function toggleMembersPanel(){
  membersPanelOpen=!membersPanelOpen;
  const p=document.getElementById('members-panel');
  if(p) p.classList.toggle('hidden',!membersPanelOpen);
}

function sendBastionMsg(bIdx,cIdx){
  const input=document.getElementById('bastion-input');
  if(!input) return;
  const text=input.value.trim();
  if(!text) return;
  const time=new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  currentUser.bastions[bIdx].channels[cIdx].messages.push({from:currentUser.username,text,time});
  saveUser();
  input.value=''; input.style.height='';
  openChannel(bIdx,cIdx);
}

function bastionKeydown(e,bIdx,cIdx){ if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBastionMsg(bIdx,cIdx);} }

function addChannel(bIdx){
  const name=prompt('New channel name:');
  if(!name||!name.trim()) return;
  const clean=name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  if(!clean){ showToast('Invalid name','error'); return; }
  if(currentUser.bastions[bIdx].channels.find(c=>c.name===clean)){ showToast('Already exists','error'); return; }
  currentUser.bastions[bIdx].channels.push({name:clean,messages:[]});
  saveUser();
  setSidebar('bastion');
  showToast('#'+clean+' created!','success');
}

function showChannelCtx(e,bIdx,cIdx){
  e.preventDefault();
  showCtxMenu(e,[
    {label:'Delete Channel', icon:'ğŸ—‘', cls:'danger', action:()=>deleteChannel(bIdx,cIdx)},
    {label:'Rename Channel', icon:'âœï¸', action:()=>renameChannel(bIdx,cIdx)},
  ]);
}

function deleteChannel(bIdx,cIdx){
  if(currentUser.bastions[bIdx].channels.length<=1){ showToast("Can't delete last channel",'error'); return; }
  if(!confirm('Delete this channel and all its messages?')) return;
  currentUser.bastions[bIdx].channels.splice(cIdx,1);
  saveUser(); setSidebar('bastion');
  openChannel(bIdx,0);
  showToast('Channel deleted','info');
}

function renameChannel(bIdx,cIdx){
  const name=prompt('New name:', currentUser.bastions[bIdx].channels[cIdx].name);
  if(!name||!name.trim()) return;
  const clean=name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  currentUser.bastions[bIdx].channels[cIdx].name=clean;
  saveUser(); setSidebar('bastion'); openChannel(bIdx,cIdx);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CREATE BASTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildEmojiPicker(containerId,selectedEmoji){
  const c=document.getElementById(containerId);
  if(!c) return;
  c.innerHTML='';
  EMOJIS.forEach(e=>{
    const btn=document.createElement('div');
    btn.textContent=e;
    btn.style.cssText='cursor:pointer;font-size:20px;padding:4px 5px;border-radius:7px;transition:background .12s;';
    if(e===(selectedEmoji||EMOJIS[0])) btn.style.background='rgba(255,249,62,.16)';
    btn.onclick=()=>{
      c.querySelectorAll('div').forEach(d=>d.style.background='');
      btn.style.background='rgba(255,249,62,.16)';
      c.dataset.selected=e;
    };
    c.appendChild(btn);
  });
  c.dataset.selected=selectedEmoji||EMOJIS[0];
}

function openCreateBastion(){
  document.getElementById('b-name').value='';
  document.getElementById('b-desc').value='';
  document.getElementById('b-tag').value='';
  document.getElementById('create-err').textContent='';
  buildEmojiPicker('b-emoji-picker');
  openModal('modal-create-bastion');
}

function createBastion(){
  const name=document.getElementById('b-name').value.trim();
  const desc=document.getElementById('b-desc').value.trim();
  const tag=document.getElementById('b-tag').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5)||name.slice(0,4).toUpperCase();
  const icon=document.getElementById('b-emoji-picker').dataset.selected||'ğŸ°';
  if(!name){ document.getElementById('create-err').textContent='Name required.'; return; }
  const bastion={
    name,desc,icon,tag,
    channels:[{name:'general',messages:[]},{name:'announcements',messages:[]}],
    members:[currentUser.username],
    roles:[{name:'Admin',color:'#fff93e',id:'admin'},{name:'Member',color:'#7a8599',id:'member'}],
    memberRoles:{[currentUser.username]:['admin']},
    inviteCode:genCode(),
    createdAt:Date.now()
  };
  currentUser.bastions.push(bastion);
  saveUser();
  closeModal('modal-create-bastion');
  buildRailBastions();
  showToast(name+' created!','success');
  openBastion(currentUser.bastions.length-1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BASTION SETTINGS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openBastionSettings(idx){
  currentBastion=idx;
  const b=currentUser.bastions[idx];
  document.getElementById('bsettings-sub').textContent=b.name;
  document.getElementById('bsettings-name').value=b.name;
  document.getElementById('bsettings-desc').value=b.desc||'';
  document.getElementById('bsettings-tag').value=b.tag||'';
  buildEmojiPicker('bsettings-emoji',b.icon);
  buildRolesEditor(idx);
  const link=`fortized.app/invite/${b.inviteCode}`;
  document.getElementById('invite-link-val').value=link;
  openModal('modal-bastion-settings');
}

function buildRolesEditor(idx){
  const b=currentUser.bastions[idx];
  const c=document.getElementById('bsettings-roles');
  c.innerHTML='';
  (b.roles||[]).forEach((r,ri)=>{
    if(r.id==='member') return; // can't delete default
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:8px;margin-bottom:8px;';
    row.innerHTML=`
      <div style="width:12px;height:12px;border-radius:50%;background:${r.color};flex-shrink:0;"></div>
      <span style="flex:1;font-size:13px;font-weight:600;">${r.name}</span>
      <span style="font-size:11px;color:var(--muted);">${r.id}</span>
      <button onclick="deleteRole(${idx},${ri})" style="background:none;border:none;color:var(--red);cursor:pointer;font-size:15px;">Ã—</button>
    `;
    c.appendChild(row);
  });
}

function addRole(){
  if(currentBastion===null) return;
  const name=document.getElementById('new-role-name').value.trim();
  const color=document.getElementById('new-role-color').value;
  if(!name){ showToast('Role name required','error'); return; }
  const id='role_'+Date.now();
  currentUser.bastions[currentBastion].roles.push({name,color,id});
  saveUser();
  document.getElementById('new-role-name').value='';
  buildRolesEditor(currentBastion);
}

function deleteRole(bIdx,rIdx){
  currentUser.bastions[bIdx].roles.splice(rIdx,1);
  saveUser(); buildRolesEditor(bIdx);
}

function saveBastionSettings(){
  if(currentBastion===null) return;
  const b=currentUser.bastions[currentBastion];
  b.name=document.getElementById('bsettings-name').value.trim()||b.name;
  b.desc=document.getElementById('bsettings-desc').value.trim();
  b.tag=document.getElementById('bsettings-tag').value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5)||b.tag;
  b.icon=document.getElementById('bsettings-emoji').dataset.selected||b.icon;
  saveUser();
  closeModal('modal-bastion-settings');
  buildRailBastions();
  setSidebar('bastion');
  showToast('Bastion updated!','success');
  if(currentChannel!==null) openChannel(currentBastion,currentChannel);
}

function deleteBastion(){
  if(!confirm('Delete this Bastion? This cannot be undone.')) return;
  closeModal('modal-bastion-settings');
  currentUser.bastions.splice(currentBastion,1);
  saveUser();
  currentBastion=null; currentChannel=null;
  buildRailBastions();
  navigate('home');
  showToast('Bastion deleted','info');
}

function regenerateInvite(){
  if(currentBastion===null) return;
  currentUser.bastions[currentBastion].inviteCode=genCode();
  saveUser();
  const link=`fortized.app/invite/${currentUser.bastions[currentBastion].inviteCode}`;
  document.getElementById('invite-link-val').value=link;
  showToast('New invite link generated!','success');
}

function copyInvite(){
  const val=document.getElementById('invite-link-val').value;
  navigator.clipboard.writeText(val).then(()=>showToast('Copied!','success'));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JOIN BY INVITE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function joinByInvite(){
  const code=document.getElementById('ji-code').value.trim();
  if(!code){ document.getElementById('ji-err').textContent='Enter an invite code.'; return; }
  const users=getUsers();
  let found=null, foundUser=null;
  for(const u of users){
    if(!u.bastions) continue;
    const b=u.bastions.find(x=>x.inviteCode===code);
    if(b){ found=b; foundUser=u; break; }
  }
  if(!found){ document.getElementById('ji-err').textContent='Invalid or expired invite code.'; return; }
  // Check already joined
  const existing=currentUser.bastions.find(b=>b.inviteCode===code&&b.name===found.name);
  if(existing){ showToast('Already in this Bastion!','info'); closeModal('modal-join-invite'); return; }
  // Add a copy
  const copy=JSON.parse(JSON.stringify(found));
  copy.members=[...new Set([...(copy.members||[]), currentUser.username])];
  if(!copy.memberRoles) copy.memberRoles={};
  copy.memberRoles[currentUser.username]=['member'];
  currentUser.bastions.push(copy);
  saveUser();
  closeModal('modal-join-invite');
  buildRailBastions();
  showToast(`Joined ${found.name}!`,'success');
  openBastion(currentUser.bastions.length-1);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ASSIGN ROLES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openAssignRoles(username,bastionIdx){
  const b=currentUser.bastions[bastionIdx];
  document.getElementById('ar-sub').textContent=`Manage roles for @${username} in ${b.name}`;
  const c=document.getElementById('ar-roles');
  c.innerHTML='';
  const memberRoles=b.memberRoles&&b.memberRoles[username]?b.memberRoles[username]:[];
  (b.roles||[]).forEach(r=>{
    const checked=memberRoles.includes(r.id);
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);';
    row.innerHTML=`
      <div style="width:12px;height:12px;border-radius:50%;background:${r.color};"></div>
      <span style="flex:1;font-size:13.5px;font-weight:600;">${r.name}</span>
      <input type="checkbox" ${checked?'checked':''} onchange="toggleRole('${username}',${bastionIdx},'${r.id}',this.checked)"
        style="width:16px;height:16px;cursor:pointer;accent-color:var(--accent);">
    `;
    c.appendChild(row);
  });
  openModal('modal-assign-role');
}

function toggleRole(username,bIdx,roleId,checked){
  const b=currentUser.bastions[bIdx];
  if(!b.memberRoles) b.memberRoles={};
  if(!b.memberRoles[username]) b.memberRoles[username]=[];
  if(checked){ if(!b.memberRoles[username].includes(roleId)) b.memberRoles[username].push(roleId); }
  else { b.memberRoles[username]=b.memberRoles[username].filter(r=>r!==roleId); }
  saveUser();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE CARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showProfileCard(e, username){
  e.stopPropagation();
  const users=getUsers();
  const u=users.find(x=>x.username===username);
  if(!u) return;
  const dn=u.displayName||u.username;
  const st=u.status||'offline';
  const emoji=u.avatarEmoji;
  // Build roles across shared bastions
  let roles=[];
  if(currentBastion!==null){
    const b=currentUser.bastions[currentBastion];
    const mRoles=b.memberRoles&&b.memberRoles[username]?b.memberRoles[username]:[];
    roles=(b.roles||[]).filter(r=>mRoles.includes(r.id));
  }
  document.getElementById('pp-av').innerHTML=emoji?`<span style="font-size:22px;">${emoji}</span>`:`<span style="font-size:22px;">${dn[0].toUpperCase()}</span>`;
  document.getElementById('pp-name').textContent=dn;
  document.getElementById('pp-handle').textContent='@'+username;
  document.getElementById('pp-status').innerHTML=`<span class="status-text ${st}">${STATUS_LABELS[st]||'Offline'}</span>${u.statusMsg?` â€” ${u.statusMsg}`:''}`;
  document.getElementById('pp-tags').innerHTML=roles.map(r=>`<span class="pp-tag" style="color:${r.color};border-color:${r.color}30;">${r.name}</span>`).join('');
  document.getElementById('pp-bio').textContent=u.bio||'';
  const actionsEl=document.getElementById('pp-actions');
  actionsEl.innerHTML='';
  if(username!==currentUser.username){
    actionsEl.innerHTML=`
      <button class="btn-ghost" onclick="startDMWith('${username}');closeProfilePopup();" style="font-size:12px;padding:6px 10px;flex:1;">Message</button>
      ${!currentUser.friends.includes(username)?`<button class="btn-accent" onclick="quickAddFriend('${username}')" style="font-size:12px;padding:6px 10px;flex:1;">Add Friend</button>`:''}
      ${currentBastion!==null?`<button class="btn-ghost" onclick="openAssignRoles('${username}',${currentBastion})" style="font-size:12px;padding:6px 10px;">Roles</button>`:''}
    `;
  } else {
    actionsEl.innerHTML=`<button class="btn-ghost" onclick="navigate('profile');closeProfilePopup();" style="font-size:12px;padding:6px 10px;flex:1;">View Profile</button>`;
  }
  const popup=document.getElementById('profile-popup');
  popup.classList.add('open');
  // Position near click
  const rect={x:e.clientX,y:e.clientY};
  const pw=280,ph=300;
  let x=rect.x+12, y=rect.y-50;
  if(x+pw>window.innerWidth) x=rect.x-pw-12;
  if(y+ph>window.innerHeight) y=window.innerHeight-ph-16;
  if(y<8) y=8;
  popup.style.left=x+'px'; popup.style.top=y+'px';
}

function closeProfilePopup(){
  document.getElementById('profile-popup').classList.remove('open');
}

function quickAddFriend(username){
  if(currentUser.friends.includes(username)){ showToast('Already friends!','info'); return; }
  currentUser.friends.push(username);
  saveUser();
  showToast(username+' added!','success');
  closeProfilePopup();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DISCOVER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildDiscoverGrid(){ renderDiscoverGrid(PUBLIC_BASTIONS); }
function filterBastions(){
  const q=document.getElementById('disc-search').value.toLowerCase();
  renderDiscoverGrid(q?PUBLIC_BASTIONS.filter(b=>b.name.toLowerCase().includes(q)||b.desc.toLowerCase().includes(q)):PUBLIC_BASTIONS);
}
function renderDiscoverGrid(list){
  const g=document.getElementById('bastion-grid');
  if(!g) return;
  if(!list.length){ g.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No bastions found.</div>'; return; }
  g.innerHTML=list.map(b=>`
    <div class="bastion-card" onclick="showToast('Join feature coming soon','info')">
      <div class="bc-banner">${b.icon}</div>
      <div class="bc-body">
        <div class="bc-meta">
          <div class="bc-icon">${b.icon}</div>
          <div>
            <div class="bc-name">${b.name}</div>
            <span style="font-size:10px;font-weight:700;color:var(--muted);background:var(--panel2);border:1px solid var(--border);padding:1px 6px;border-radius:100px;">${b.tag}</span>
          </div>
        </div>
        <div class="bc-desc">${b.desc}</div>
        <div class="bc-stats"><span>ğŸ‘¥ ${b.members.toLocaleString()}</span><span style="color:var(--green);">â— ${b.online} online</span></div>
      </div>
    </div>
  `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATELIER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateDailyBtn(){
  const btn=document.getElementById('daily-btn');
  const st=document.getElementById('daily-status');
  if(!btn||!st) return;
  const today=new Date().toDateString();
  const claimed=currentUser.lastDaily===today;
  btn.classList.toggle('claimed',claimed);
  st.textContent=claimed?'Claimed today':'Claim now';
}

function claimDaily(){
  const today=new Date().toDateString();
  if(currentUser.lastDaily===today){ showToast('Already claimed today!','info'); return; }
  currentUser.onyx+=5; currentUser.lastDaily=today;
  saveUser(); updateOnyxDisplay(); updateDailyBtn();
  showToast('+5 Onyx claimed!','success');
}

function buyRadiance(cost,label,days){
  pendingBuy={cost,label,days};
  document.getElementById('buy-title').textContent=`Activate Radiance â€” ${label}?`;
  document.getElementById('buy-sub').textContent=`This will deduct ${cost} Onyx. You have ${currentUser.onyx} Onyx.`;
  openModal('modal-buy');
}

function confirmBuy(){
  if(!pendingBuy) return;
  if(currentUser.onyx<pendingBuy.cost){ showToast('Not enough Onyx!','error'); closeModal('modal-buy'); return; }
  currentUser.onyx-=pendingBuy.cost;
  const exp=new Date(); exp.setDate(exp.getDate()+pendingBuy.days);
  currentUser.radianceUntil=exp.toISOString();
  saveUser(); updateOnyxDisplay(); closeModal('modal-buy');
  showToast(`âœ¨ Radiance activated for ${pendingBuy.label}!`,'success');
  pendingBuy=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROFILE VIEW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildProfileView(){
  const dn=currentUser.displayName||currentUser.username;
  const emoji=currentUser.avatarEmoji;
  const pav=document.getElementById('pav-big');
  if(pav) pav.innerHTML=(emoji?`<span style="font-size:28px;">${emoji}</span>`:`<span style="font-size:28px;">${dn[0].toUpperCase()}</span>`)+`<div class="pav-edit" onclick="changeAvatar()">âœï¸</div>`;
  const el=id=>document.getElementById(id);
  if(el('pname-big')) el('pname-big').textContent=dn;
  if(el('phandle')) el('phandle').textContent='@'+currentUser.username;
  if(el('pbio-display')) el('pbio-display').textContent=currentUser.bio||'';
  if(el('pemail')) el('pemail').textContent=currentUser.email||'â€”';
  const st=currentUser.status||'online';
  if(el('pstatus-display')) el('pstatus-display').innerHTML=`<span class="st-dot ${st}" style="position:static;width:9px;height:9px;border:none;flex-shrink:0;"></span> <span class="status-text ${st}">${STATUS_LABELS[st]}</span>${currentUser.statusMsg?` â€” ${currentUser.statusMsg}`:''}`;
  if(el('pstatus-setting')) el('pstatus-setting').textContent=STATUS_LABELS[st]+(currentUser.statusMsg?' â€” '+currentUser.statusMsg:'');
  const hasRad=currentUser.radianceUntil&&new Date(currentUser.radianceUntil)>new Date();
  if(el('pstats')) el('pstats').innerHTML=`
    <div class="pstat"><div class="pstat-v">${currentUser.onyx}</div><div class="pstat-k">Onyx</div></div>
    <div class="pstat"><div class="pstat-v">${currentUser.friends.length}</div><div class="pstat-k">Friends</div></div>
    <div class="pstat"><div class="pstat-v">${currentUser.bastions.length}</div><div class="pstat-k">Bastions</div></div>
    <div class="pstat"><div class="pstat-v" style="font-size:14px;">${hasRad?'âœ¨ Active':'â€”'}</div><div class="pstat-k">Radiance</div></div>
  `;
}

function showMyProfile(){ navigate('profile'); }

function openEditProfile(){
  const dn=currentUser.displayName||currentUser.username;
  document.getElementById('ep-displayname').value=dn;
  document.getElementById('ep-bio').value=currentUser.bio||'';
  document.getElementById('ep-avatar-emoji').value=currentUser.avatarEmoji||'';
  openModal('modal-edit-profile');
}

function saveProfile(){
  const dn=document.getElementById('ep-displayname').value.trim();
  const bio=document.getElementById('ep-bio').value.trim();
  const emoji=document.getElementById('ep-avatar-emoji').value.trim();
  if(dn) currentUser.displayName=dn;
  currentUser.bio=bio;
  currentUser.avatarEmoji=emoji;
  saveUser(); closeModal('modal-edit-profile');
  buildUI(); buildProfileView();
  showToast('Profile updated!','success');
}

function changeAvatar(){ openEditProfile(); }

function openStatusModal(){
  const sel=document.getElementById('status-select');
  sel.value=currentUser.status||'online';
  document.getElementById('status-msg').value=currentUser.statusMsg||'';
  openModal('modal-status');
}

function saveStatus(){
  currentUser.status=document.getElementById('status-select').value;
  currentUser.statusMsg=document.getElementById('status-msg').value.trim();
  saveUser(); closeModal('modal-status');
  updateUserbar(); buildProfileView();
  showToast('Status updated!','success');
}

function openChangeUsername(){
  document.getElementById('cu-username').value='';
  document.getElementById('cu-err').textContent='';
  openModal('modal-change-username');
}

function changeUsername(){
  const newU=document.getElementById('cu-username').value.trim().toLowerCase().replace(/\s+/g,'');
  if(!newU||newU.length<3){ document.getElementById('cu-err').textContent='3â€“20 characters required.'; return; }
  if(newU===currentUser.username){ document.getElementById('cu-err').textContent='That is already your username.'; return; }
  const users=getUsers();
  if(users.find(u=>u.username===newU)){ document.getElementById('cu-err').textContent='Username already taken.'; return; }
  // Update username
  const oldU=currentUser.username;
  currentUser.username=newU;
  if(!currentUser.displayName||currentUser.displayName===oldU) currentUser.displayName=newU;
  saveUser();
  localStorage.setItem('fortized_current_user',newU);
  closeModal('modal-change-username');
  updateUserbar(); buildProfileView();
  showToast('Username changed to @'+newU,'success');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONTEXT MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showCtxMenu(e, items){
  e.preventDefault();
  const menu=document.getElementById('ctx-menu');
  menu.innerHTML='';
  items.forEach(item=>{
    if(item.sep){ const s=document.createElement('div'); s.className='ctx-sep'; menu.appendChild(s); return; }
    const el=document.createElement('div');
    el.className='ctx-item'+(item.cls?' '+item.cls:'');
    el.innerHTML=`<span>${item.icon||''}</span> ${item.label}`;
    el.onclick=()=>{ closeCtxMenu(); item.action(); };
    menu.appendChild(el);
  });
  menu.classList.add('open');
  let x=e.clientX, y=e.clientY;
  const mw=190, mh=menu.children.length*38;
  if(x+mw>window.innerWidth) x=window.innerWidth-mw-8;
  if(y+mh>window.innerHeight) y=window.innerHeight-mh-8;
  menu.style.left=x+'px'; menu.style.top=y+'px';
}

function closeCtxMenu(){ document.getElementById('ctx-menu').classList.remove('open'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function autoResize(el){ el.style.height=''; el.style.height=Math.min(el.scrollHeight,120)+'px'; }
function scrollBottom(id){ setTimeout(()=>{ const el=document.getElementById(id); if(el) el.scrollTop=el.scrollHeight; },40); }
function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
function genCode(){ return Math.random().toString(36).slice(2,8); }
function logout(){ localStorage.removeItem('fortized_current_user'); location.href='login.html'; }

let _toastTimer;
function showToast(msg,type='info'){
  const el=document.getElementById('toast');
  el.textContent=msg; el.className='toast show '+type;
  clearTimeout(_toastTimer);
  _toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}
// Keep backward compat
function toast(msg,type){ showToast(msg,type); }

// Close popups on outside click
document.addEventListener('click',e=>{
  const popup=document.getElementById('profile-popup');
  if(popup.classList.contains('open')&&!popup.contains(e.target)) closeProfilePopup();
  if(document.getElementById('ctx-menu').classList.contains('open')) closeCtxMenu();
});
document.querySelectorAll('.modal-overlay').forEach(o=>{
  o.addEventListener('click',e=>{ if(e.target===o) o.classList.remove('open'); });
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    closeProfilePopup(); closeCtxMenu();
    document.querySelectorAll('.modal-overlay.open').forEach(o=>o.classList.remove('open'));
  }
});
</script>
</body>
</html>
