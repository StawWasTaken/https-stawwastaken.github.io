<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="FortizedSocial-firebase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
:root{--accent:#fff93e;--accent-dim:rgba(255,249,62,.1);--accent-mid:rgba(255,249,62,.22);--bg:#07090e;--rail:#04060a;--sidebar:#0b0e15;--channel:#0d1018;--panel:#101420;--panel2:#131822;--panel3:#161c28;--border:#1c2335;--radius:16px;--muted:#4e5a6f;--muted-light:#7d8a9e;--text:#dde3ed;--green:#3ecf6e;--red:#f87171;--yellow:#f59e0b;--blue:#60a5fa;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;}
::selection{background:rgba(255,249,62,.2);}
::-webkit-scrollbar{width:4px;height:4px;}::-webkit-scrollbar-track{background:transparent;}::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}
.rail{width:68px;min-width:68px;background:var(--rail);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:10;box-shadow:2px 0 24px rgba(0,0,0,.5);}
.rail-logo{width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-bottom:6px;}
.rail-logo img{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,249,62,.3));}
.rail-sep{width:30px;height:1px;background:var(--border);margin:5px 0;opacity:.4;}
.rail-btn{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;flex-shrink:0;font-size:18px;}
.rail-btn:hover{background:rgba(255,255,255,.07);border-radius:12px;}
.rail-btn.active{background:var(--accent-dim);border-radius:12px;}
.rail-btn.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#0c1020;border:1px solid var(--border);color:var(--text);font-size:12px;font-weight:600;padding:5px 10px;border-radius:9px;white-space:nowrap;z-index:999;pointer-events:none;box-shadow:0 4px 20px rgba(0,0,0,.5);}
.rail-bastion{width:42px;height:42px;border-radius:14px;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .15s;position:relative;overflow:hidden;flex-shrink:0;}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:12px;background:var(--accent-dim);}
.rail-bastion.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-bastion img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.rail-notif-badge{position:absolute;top:2px;right:2px;min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--rail);padding:0 2px;}
.sidebar{width:240px;min-width:240px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{height:52px;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;gap:7px;background:rgba(0,0,0,.15);}
.sidebar-header .hdr-actions{margin-left:auto;display:flex;gap:2px;}
.sidebar-header .hdr-actions button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.sidebar-header .hdr-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 0;}
.sec-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 5px;display:flex;align-items:center;justify-content:space-between;}
.sec-label button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:18px;height:18px;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.sec-label button:hover{background:rgba(255,255,255,.07);color:#fff;}
.s-item{display:flex;align-items:center;gap:9px;padding:7px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:13px;color:var(--muted-light);transition:all .1s;}
.s-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.s-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.s-item .s-icon{width:26px;height:26px;border-radius:50%;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.s-item .s-name{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ch-item{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:12.5px;color:var(--muted);transition:all .1s;}
.ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.ch-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.cat-row{display:flex;align-items:center;gap:5px;padding:10px 8px 4px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);cursor:pointer;}
.cat-row button{margin-left:auto;background:none;border:none;color:inherit;cursor:pointer;font-size:14px;opacity:0;width:16px;height:16px;display:flex;align-items:center;justify-content:center;}
.cat-row:hover button{opacity:1;}
.friend-item{display:flex;align-items:center;gap:9px;padding:6px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;transition:background .1s;}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.fa{position:relative;flex-shrink:0;border-radius:50%;overflow:hidden;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;}
.fa img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.fa .fs{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--sidebar);}
.fs.online{background:var(--green);}.fs.away{background:var(--yellow);}.fs.dnd{background:var(--red);}.fs.offline,.fs.invisible{background:#374151;}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bastion-tag{display:inline-flex;align-items:center;font-size:9px;font-weight:800;letter-spacing:.04em;padding:1px 5px;border-radius:4px;border:1px solid;margin-left:3px;vertical-align:middle;text-transform:uppercase;}
.userbar{height:56px;background:rgba(4,6,10,.8);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 8px;gap:7px;flex-shrink:0;}
.ua{width:34px;height:34px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;}
.ua img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ua .ua-ring{position:absolute;bottom:-1px;right:-1px;width:11px;height:11px;border-radius:50%;background:var(--green);border:2px solid var(--sidebar);}
.ua-info{flex:1;min-width:0;}
.ua-name{font-size:13px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ua-tag{font-size:10.5px;color:var(--muted);}
.ua-btns{display:flex;gap:2px;}
.ua-btns button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.ua-btns button:hover{background:rgba(255,255,255,.07);color:#fff;}
.main{flex:1;min-width:0;display:flex;flex-direction:column;}
.topbar{height:52px;background:rgba(8,11,18,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:10px;flex-shrink:0;box-shadow:0 2px 20px rgba(0,0,0,.3);}
.topbar-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap;}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 2px;}
.tb-desc{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.tb-actions{margin-left:auto;display:flex;align-items:center;gap:6px;}
.tb-actions button{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.tb-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{display:flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:100px;padding:5px 12px;font-size:12px;font-weight:700;color:var(--accent);cursor:pointer;transition:background .12s;}
.onyx-pill:hover{background:rgba(255,249,62,.16);}
.onyx-pill img{width:14px;height:14px;object-fit:contain;}
.tb-search{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:5px 10px;width:170px;transition:all .2s;}
.tb-search:focus-within{border-color:rgba(255,249,62,.2);width:210px;}
.tb-search input{background:transparent;border:none;outline:none;color:#fff;font-family:'DM Sans',sans-serif;font-size:12.5px;flex:1;}
.tb-search input::placeholder{color:var(--muted);}
.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;}
.view.active{display:flex;}
.app-loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;}
.app-loading .lbl{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--muted-light);}
@keyframes spin{to{transform:rotate(360deg);}}
.load-spinner{width:32px;height:32px;border:3px solid rgba(255,249,62,.15);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
.home-wrap{flex:1;display:flex;overflow:hidden;}
.home-feed{flex:1;overflow-y:auto;background:var(--bg);}
.home-right{width:290px;min-width:290px;border-left:1px solid var(--border);overflow-y:auto;background:var(--channel);}
.home-hero{width:100%;min-height:280px;background:linear-gradient(105deg,rgba(7,9,14,.98) 35%,rgba(7,9,14,.65) 100%),url("Fortized banner.png") center/cover no-repeat;position:relative;overflow:hidden;flex-shrink:0;display:grid;grid-template-columns:1fr auto;align-items:center;padding:0 48px;}
.home-hero::before{content:"";position:absolute;inset:0;background-image:linear-gradient(rgba(255,249,62,.012) 1px,transparent 1px),linear-gradient(90deg,rgba(255,249,62,.012) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;}
.home-hero::after{content:"";position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to bottom,transparent,var(--bg));pointer-events:none;}
@keyframes revealUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}
.hero-left-content{position:relative;z-index:1;animation:revealUp .5s cubic-bezier(.22,1,.36,1) both;}
.hero-tag-app{display:inline-flex;align-items:center;gap:8px;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:100px;padding:5px 14px;margin-bottom:20px;}
.hero-tag-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);animation:blink 2s ease infinite;}
@keyframes blink{0%,100%{opacity:1;transform:scale(1);}50%{opacity:.3;transform:scale(.6);}}
.home-hero h1{font-family:'Syne',sans-serif;font-size:48px;font-weight:800;letter-spacing:-2px;line-height:.96;margin-bottom:14px;}
.home-hero h1 em{font-style:normal;color:var(--accent);}
.home-hero p.hero-sub-app{font-size:14.5px;color:rgba(255,255,255,.6);line-height:1.65;max-width:360px;margin-bottom:26px;}
.home-hero-actions{display:flex;gap:10px;flex-wrap:wrap;}
.home-hero-knight{position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:center;height:280px;width:200px;}
.home-hero-knight img{height:250px;object-fit:contain;filter:drop-shadow(0 20px 40px rgba(255,249,62,.15));animation:float 5.5s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-14px);}}
.home-marquee{background:rgba(11,14,21,.7);border-top:1px solid var(--border);border-bottom:1px solid var(--border);overflow:hidden;position:relative;flex-shrink:0;}
.home-marquee::before,.home-marquee::after{content:"";position:absolute;top:0;bottom:0;width:80px;z-index:2;pointer-events:none;}
.home-marquee::before{left:0;background:linear-gradient(to right,var(--bg),transparent);}
.home-marquee::after{right:0;background:linear-gradient(to left,var(--bg),transparent);}
.marquee-track{display:flex;animation:marquee 20s linear infinite;width:max-content;}
@keyframes marquee{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.marquee-item{display:flex;align-items:center;gap:10px;padding:14px 36px;border-right:1px solid var(--border);white-space:nowrap;}
.mi-icon{font-size:15px;opacity:.7;}.mi-label{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;color:var(--muted-light);letter-spacing:.04em;}.mi-accent{color:var(--accent);}
.home-main-scroll{padding:28px 32px 48px;max-width:900px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-hdr h3{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.section-hdr h3::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.quick-nav{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px;}
.qn-tile{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 18px;cursor:pointer;transition:all .22s;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;}
.qn-tile:hover{border-color:rgba(255,249,62,.2);transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,.4);}
.qn-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.qn-text h4{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:2px;}
.qn-text p{font-size:12px;color:var(--muted);}
.qn-badge{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:100px;}
.activity-item{display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .2s;margin-bottom:8px;}
.activity-item:hover{border-color:rgba(255,249,62,.16);transform:translateY(-2px);}
.act-icon{width:40px;height:40px;border-radius:14px;background:var(--panel2);border:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.act-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.act-text{flex:1;}
.act-text p{font-size:14px;color:var(--text);line-height:1.5;}
.act-text p strong{font-weight:700;}
.act-time{font-size:11.5px;color:var(--muted);margin-top:2px;}
.rp-section{padding:16px 14px 8px;border-bottom:1px solid var(--border);}
.rp-title{font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.rp-notif{display:flex;gap:9px;padding:8px 10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.rp-notif:hover{background:rgba(255,255,255,.04);}
.rp-notif.unread{background:rgba(255,249,62,.04);}
.rp-notif .rn-icon{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rp-notif .rn-text{flex:1;}
.rp-notif .rn-text p{font-size:12.5px;color:var(--text);line-height:1.4;}
.rp-notif .rn-time{font-size:10.5px;color:var(--muted);}
.rp-notif .rn-actions{display:flex;gap:5px;margin-top:5px;}
.rn-accept{background:rgba(62,207,110,.15);border:1px solid rgba(62,207,110,.3);color:var(--green);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.rn-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.blog-post{padding:10px;border-radius:12px;cursor:pointer;transition:background .1s;margin-bottom:4px;}
.blog-post:hover{background:rgba(255,255,255,.04);}
.blog-post .bp-tag{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--accent);margin-bottom:3px;}
.blog-post .bp-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.4;}
.blog-post .bp-date{font-size:11px;color:var(--muted);}
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;}
.chat-welcome{padding:20px 20px 18px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.chat-welcome .w-av{width:60px;height:60px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:22px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:hidden;}
.chat-welcome .w-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.chat-welcome p{font-size:13.5px;color:var(--muted-light);}
.date-div{display:flex;align-items:center;gap:10px;padding:8px 20px;font-size:10.5px;font-weight:700;color:var(--muted);letter-spacing:.04em;}
.date-div::before,.date-div::after{content:"";flex:1;height:1px;background:var(--border);}
.msg-row{display:flex;padding:2px 20px;position:relative;}
.msg-row:hover{background:rgba(255,255,255,.018);}
.msg-row.msg-first{padding-top:16px;}
.msg-av-wrap{width:40px;min-width:40px;display:flex;justify-content:center;padding-top:2px;flex-shrink:0;}
.msg-av-inner{width:36px;height:36px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0;}
.msg-av-inner img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.msg-time-small{font-size:10px;color:var(--muted);white-space:nowrap;padding-top:4px;min-width:44px;text-align:left;visibility:hidden;}
.msg-row.msg-cont:hover .msg-time-small{visibility:visible;}
.msg-content-col{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
.msg-author{font-size:14px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-timestamp{font-size:11px;color:var(--muted);}
.msg-text{font-size:14px;color:var(--text);line-height:1.55;word-break:break-word;max-width:680px;}
.msg-text code{background:rgba(255,255,255,.07);padding:1px 6px;border-radius:5px;font-size:12.5px;font-family:monospace;}
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.r-pill{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:100px;padding:2px 9px;font-size:12.5px;cursor:pointer;transition:background .1s;}
.r-pill:hover{background:rgba(255,255,255,.09);}
.r-pill.mine{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.msg-acts{display:none;gap:2px;position:absolute;right:14px;top:-14px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:3px;z-index:10;}
.msg-row:hover .msg-acts{display:flex;}
.msg-acts button{background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.msg-acts button:hover{background:rgba(255,255,255,.07);color:#fff;}
.msg-row.own .msg-text{color:rgba(255,249,62,.92);}
.chat-input-wrap{padding:0 16px 14px;flex-shrink:0;}
.chat-input-box{background:var(--panel2);border:1px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;gap:5px;padding:8px 11px;transition:border-color .15s;}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.24);box-shadow:0 0 0 2px rgba(255,249,62,.05);}
.chat-input-box textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13.5px;resize:none;max-height:120px;line-height:1.5;padding:2px 0;}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{width:32px;height:32px;border-radius:10px;background:var(--accent);border:none;color:#060810;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:filter .1s;}
.chat-send:hover{filter:brightness(1.08);}
.chat-input-actions button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.chat-input-actions{display:flex;gap:2px;align-items:center;}
.member-list{width:220px;min-width:220px;background:var(--channel);border-left:1px solid var(--border);overflow-y:auto;padding:12px 0;}
.ml-role-header{padding:4px 12px 2px;font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:8px;}
.ml-entry{display:flex;align-items:center;gap:8px;padding:5px 9px 5px 12px;margin:1px 4px;border-radius:10px;cursor:pointer;transition:background .1s;}
.ml-entry:hover{background:rgba(255,255,255,.05);}
.ml-av{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;position:relative;}
.ml-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ml-status{position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border-radius:50%;border:2px solid var(--channel);}
.ml-info{flex:1;min-width:0;}
.ml-name{font-size:12.5px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.discover-scroll{flex:1;overflow-y:auto;padding:28px;}
.disc-hero{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:38px 36px;margin-bottom:28px;position:relative;overflow:hidden;}
.disc-hero h2{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px;}
.disc-hero p{font-size:14px;color:var(--muted-light);margin-bottom:20px;}
.disc-search{display:flex;align-items:center;gap:10px;max-width:400px;position:relative;}
.disc-search input{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;padding:10px 14px 10px 38px;outline:none;transition:border-color .12s;}
.disc-search input:focus{border-color:rgba(255,249,62,.25);}
.disc-search input::placeholder{color:var(--muted);}
.disc-search .si{position:absolute;left:12px;font-size:13px;color:var(--muted);pointer-events:none;}
.disc-tabs{display:flex;gap:5px;margin-bottom:22px;}
.disc-tab{padding:7px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--muted-light);transition:all .12s;}
.disc-tab:hover{background:rgba(255,255,255,.05);color:#fff;}
.disc-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.bc{background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;transition:all .15s;}
.bc:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.bc-banner{height:76px;background:linear-gradient(135deg,#1a2040,#0d1425);display:flex;align-items:center;justify-content:center;font-size:30px;overflow:hidden;}
.bc-banner img{width:100%;height:100%;object-fit:cover;}
.bc-body{padding:14px;}
.bc-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bc-icon{width:42px;height:42px;border-radius:12px;background:var(--panel2);border:2px solid var(--sidebar);font-size:18px;display:flex;align-items:center;justify-content:center;margin-top:-26px;position:relative;z-index:1;flex-shrink:0;overflow:hidden;}
.bc-icon img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.bc-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.bc-desc{font-size:12px;color:var(--muted-light);line-height:1.55;margin-bottom:8px;}
.bc-stats{display:flex;gap:10px;font-size:11.5px;color:var(--muted);}
.atelier-scroll{flex:1;overflow-y:auto;padding:28px;}
.atelier-top{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:26px 30px;margin-bottom:26px;position:relative;overflow:hidden;}
.atelier-bal{display:flex;align-items:center;gap:13px;}
.atelier-bal img{width:36px;height:36px;object-fit:contain;}
.atelier-bal h3{font-size:13px;font-weight:600;color:var(--muted-light);margin-bottom:2px;}
.atelier-bal .amt{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:var(--accent);letter-spacing:-.3px;}
.daily-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:16px;padding:14px 24px;cursor:pointer;transition:background .12s;}
.daily-btn:hover{background:rgba(255,249,62,.13);}
.daily-btn span{font-size:11px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:14px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.atelier-section-title::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:28px;}
.rad-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px 18px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden;}
.rad-card:hover{border-color:rgba(255,249,62,.22);transform:translateY(-2px);box-shadow:0 12px 40px rgba(0,0,0,.4);}
.rad-card.bv{border-color:rgba(255,249,62,.18);}
.best-badge{position:absolute;top:10px;right:10px;background:var(--accent);color:#060810;font-size:9px;font-weight:800;letter-spacing:.05em;padding:2px 7px;border-radius:100px;text-transform:uppercase;}
.rad-icon{font-size:30px;}.rad-dur{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.rad-price{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--accent);}
.rad-price span{font-size:12px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-feats{font-size:12px;color:var(--muted-light);}
.profile-wrap{flex:1;display:flex;overflow:hidden;}
.profile-nav{width:210px;min-width:210px;border-right:1px solid var(--border);background:var(--channel);display:flex;flex-direction:column;padding:12px 0;overflow-y:auto;}
.profile-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13.5px;color:var(--muted-light);transition:all .1s;}
.profile-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.profile-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.profile-main{flex:1;overflow-y:auto;}
.profile-banner-area{width:100%;height:150px;background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);position:relative;overflow:hidden;}
.profile-banner-area img{width:100%;height:100%;object-fit:cover;}
.profile-av-row{display:flex;align-items:flex-end;gap:14px;padding:0 24px;margin-top:-28px;margin-bottom:14px;}
.profile-av-big{width:56px;height:56px;border-radius:50%;background:var(--panel);border:3px solid var(--bg);font-size:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-display-name{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:2px;}
.profile-username{font-size:13.5px;color:var(--muted-light);}
.profile-content{padding:0 24px 36px;}
.profile-stats-row{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;margin-bottom:22px;}
.ps-stat{flex:1;padding:16px;text-align:center;border-right:1px solid var(--border);}
.ps-stat:last-child{border-right:none;}
.ps-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.ps-key{font-size:11.5px;color:var(--muted);margin-top:2px;}
.settings-section{margin-bottom:24px;}
.settings-title{font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.s-row{display:flex;align-items:center;gap:12px;padding:13px 15px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;cursor:pointer;transition:all .12s;}
.s-row:hover{border-color:rgba(255,249,62,.12);background:rgba(255,249,62,.02);}
.s-row .si{font-size:17px;width:30px;text-align:center;}
.s-row .st{flex:1;}
.s-row .sl{font-size:13.5px;font-weight:600;}
.s-row .ss{font-size:12px;color:var(--muted-light);margin-top:1px;}
.field-group{margin-bottom:15px;}
.field-label{font-size:11px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.field-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;transition:border-color .12s;}
.field-input:focus{border-color:rgba(255,249,62,.3);}
.field-input::placeholder{color:#252c3d;}
.toggle{width:38px;height:20px;border-radius:10px;background:var(--border);position:relative;cursor:pointer;transition:background .15s;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .15s;}
.toggle.on::after{transform:translateX(18px);}
.radiance-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));border:1px solid rgba(255,220,62,.25);border-radius:100px;padding:3px 10px;font-size:11px;font-weight:700;color:#ffd93e;margin-top:5px;}
.boost-bar{background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12.5px;color:var(--muted-light);cursor:pointer;margin:8px 8px 4px;transition:background .12s;}
.boost-bar:hover{background:rgba(255,249,62,.1);}
.boost-bar .bl{font-weight:700;color:var(--accent);}
.boost-level-bar{display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(90deg,rgba(255,249,62,.07),rgba(255,249,62,.03));border:1px solid rgba(255,249,62,.15);border-radius:14px;margin-bottom:18px;}
.bl-icon{font-size:22px;}.bl-info{flex:1;}
.bl-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--accent);}
.bl-sub{font-size:12px;color:var(--muted-light);}
.bl-prog{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.bl-fill{height:100%;background:var(--accent);border-radius:3px;transition:width .4s;}
.bsettings-wrap{flex:1;display:flex;overflow:hidden;}
.bsettings-nav{width:220px;min-width:220px;border-right:1px solid var(--border);background:var(--channel);overflow-y:auto;padding:12px 0;}
.bsettings-main{flex:1;overflow-y:auto;padding:28px;}
.bsettings-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13px;color:var(--muted-light);transition:all .1s;}
.bsettings-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.bsettings-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.bsettings-nav-section{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 4px;}
.role-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;cursor:pointer;transition:all .12s;}
.role-item:hover{border-color:rgba(255,249,62,.15);}
.role-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.role-name{flex:1;font-size:13.5px;font-weight:600;}
.perm-row{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.perm-row:last-child{border-bottom:none;}
.perm-info{flex:1;}
.perm-label{font-size:13.5px;font-weight:600;}
.perm-desc{font-size:12px;color:var(--muted-light);margin-top:2px;line-height:1.4;}
.emoji-upload-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px;}
.emoji-slot{width:52px;height:52px;border-radius:10px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .12s;position:relative;overflow:hidden;font-size:22px;}
.emoji-slot:hover{border-color:var(--accent);background:var(--accent-dim);}
.emoji-slot.filled{border-style:solid;border-color:var(--border);}
.emoji-slot img{width:40px;height:40px;object-fit:contain;border-radius:6px;}
.emoji-slot .es-del{position:absolute;top:2px;right:2px;width:14px;height:14px;border-radius:50%;background:var(--red);color:#fff;font-size:8px;display:none;align-items:center;justify-content:center;cursor:pointer;}
.emoji-slot:hover .es-del{display:flex;}
.automod-rule{padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;}
.amr-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.amr-icon{font-size:20px;}.amr-title{font-size:14px;font-weight:700;flex:1;}
.amr-enabled{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted-light);}
.amr-desc{font-size:12.5px;color:var(--muted-light);line-height:1.55;margin-bottom:10px;}
.amr-keywords{display:flex;flex-wrap:wrap;gap:5px;}
.amr-kw{display:flex;align-items:center;gap:4px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:11.5px;padding:3px 8px;border-radius:100px;}
.amr-kw button{background:none;border:none;color:inherit;cursor:pointer;font-size:11px;padding:0;}
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:20px;width:100%;max-width:420px;overflow:hidden;animation:mIn .2s cubic-bezier(.22,1,.36,1) both;box-shadow:0 32px 80px rgba(0,0,0,.7);}
.modal.wide{max-width:580px;}
.modal.tall{max-height:80vh;display:flex;flex-direction:column;}
.modal.tall .modal-body{overflow-y:auto;flex:1;}
@keyframes mIn{from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);flex-shrink:0;}
.modal-body{padding:26px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px;}
.modal-sub{font-size:13px;color:var(--muted-light);margin-bottom:22px;}
.modal-error{font-size:12px;color:var(--red);margin-bottom:8px;min-height:16px;display:flex;align-items:center;gap:5px;}
.modal-error:not(:empty)::before{content:"‚ö†";}
.modal-success{font-size:12px;color:var(--green);margin-bottom:8px;}
.modal-actions{display:flex;gap:9px;margin-top:6px;}
.modal-actions .btn-a,.modal-actions .btn-g{flex:1;justify-content:center;}
.modal-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;margin-bottom:12px;transition:border-color .12s;}
.modal-input:focus{border-color:rgba(255,249,62,.32);}
.modal-input::placeholder{color:#252c3d;}
.btn-a{display:inline-flex;align-items:center;gap:7px;background:var(--accent);color:#060810;padding:10px 20px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:none;cursor:pointer;transition:all .1s;}
.btn-a:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-g{display:inline-flex;align-items:center;gap:7px;background:transparent;color:var(--muted-light);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid var(--border);cursor:pointer;transition:all .1s;}
.btn-g:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-d{display:inline-flex;align-items:center;gap:7px;background:rgba(248,113,113,.1);color:var(--red);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid rgba(248,113,113,.2);cursor:pointer;transition:all .1s;}
.btn-d:hover{background:rgba(248,113,113,.18);}
.toast{position:fixed;bottom:22px;right:22px;z-index:2000;background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:11px 18px;font-size:13px;font-weight:500;box-shadow:0 20px 50px rgba(0,0,0,.6);transform:translateY(20px);opacity:0;transition:transform .25s cubic-bezier(.22,1,.36,1),opacity .25s;max-width:280px;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}
.ctx-menu{position:fixed;z-index:9999;background:rgba(13,16,24,.98);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:6px;min-width:200px;box-shadow:0 20px 50px rgba(0,0,0,.7);backdrop-filter:blur(22px);animation:ctxIn .14s cubic-bezier(.22,1,.36,1);}
@keyframes ctxIn{from{opacity:0;transform:scale(.96) translateY(-4px);}to{opacity:1;transform:none;}}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;font-size:13px;color:rgba(220,228,240,.9);cursor:pointer;transition:all .07s;}
.ctx-item:hover{background:rgba(255,255,255,.07);color:#fff;}
.ctx-item.danger{color:rgba(248,113,113,.85);}
.ctx-item.danger:hover{background:rgba(248,113,113,.12);color:var(--red);}
.ctx-sep{height:1px;background:rgba(255,255,255,.07);margin:5px 0;}
.ctx-section-label{padding:9px 12px 4px;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:rgba(255,255,255,.22);}
.notif-panel{position:fixed;top:52px;right:0;width:330px;max-height:calc(100vh - 60px);background:var(--sidebar);border:1px solid var(--border);border-radius:18px 0 0 18px;box-shadow:-8px 0 40px rgba(0,0,0,.5);z-index:100;transform:translateX(100%);transition:transform .22s cubic-bezier(.22,1,.36,1);display:flex;flex-direction:column;}
.notif-panel.open{transform:translateX(0);}
.np-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.np-header h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.np-header button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;}
.np-header button:hover{background:rgba(255,255,255,.07);color:#fff;}
.np-list{flex:1;overflow-y:auto;padding:8px;}
.np-item{display:flex;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;transition:background .08s;margin-bottom:3px;position:relative;}
.np-item:hover{background:rgba(255,255,255,.04);}
.np-item.unread{background:rgba(255,249,62,.04);}
.np-item.unread::before{content:"";position:absolute;left:4px;top:50%;transform:translateY(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent);}
.np-icon{width:32px;height:32px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.np-text{flex:1;}
.np-text p{font-size:12.5px;color:var(--text);line-height:1.45;}
.np-text p strong{font-weight:700;}
.np-time{font-size:10.5px;color:var(--muted);margin-top:2px;}
.np-actions{display:flex;gap:5px;margin-top:6px;}
.np-accept{background:rgba(62,207,110,.12);border:1px solid rgba(62,207,110,.25);color:var(--green);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.np-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--muted);text-align:center;padding:40px;}
.empty-state .ei{font-size:48px;opacity:.3;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13.5px;max-width:290px;line-height:1.6;}
.color-swatches{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;transition:all .1s;}
.color-swatch:hover,.color-swatch.sel{border-color:#fff;transform:scale(1.15);}
.emoji-opt{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:19px;cursor:pointer;border:1.5px solid transparent;transition:all .1s;}
.emoji-opt:hover{background:rgba(255,255,255,.06);}
.emoji-opt.sel{border-color:var(--accent);background:var(--accent-dim);}
.emoji-picker-wrap{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.invite-link-box{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:monospace;font-size:13px;color:var(--accent);display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.invite-link-box span{flex:1;word-break:break-all;}
.vis-toggle{display:flex;gap:8px;margin-bottom:14px;}
.vis-opt{flex:1;padding:12px;border-radius:12px;border:1.5px solid var(--border);cursor:pointer;text-align:center;transition:all .12s;}
.vis-opt:hover{border-color:rgba(255,249,62,.2);}
.vis-opt.active{border-color:var(--accent);background:var(--accent-dim);}
.vis-opt .vo-icon{font-size:22px;margin-bottom:4px;}
.vis-opt .vo-label{font-size:13px;font-weight:700;}
.vis-opt .vo-desc{font-size:11px;color:var(--muted-light);margin-top:2px;}
</style>
</head>
<body>
<div class="app-loading" id="app-loading">
  <div class="load-spinner"></div>
  <div class="lbl">Loading Fortized‚Ä¶</div>
</div>
<div class="rail" id="rail" style="display:none;">
  <div class="rail-logo" onclick="navigate('home')" data-tip="Home">
    <img src="Fortized icon.png" alt="" onerror="this.outerHTML='<span style=font-size:24px>üè∞</span>'">
  </div>
  <div class="rail-sep"></div>
  <div id="rail-bastions"></div>
  <div class="rail-btn" id="rail-add" onclick="openCreateBastion()" data-tip="Create Bastion" style="border:1.5px dashed #1c2335;border-radius:14px;font-size:20px;color:var(--muted);">+</div>
  <div style="margin-top:auto;"></div>
  <div class="rail-btn" id="rail-notif" onclick="toggleNotifPanel()" data-tip="Notifications" style="position:relative;">üîî<div class="rail-notif-badge" id="notif-badge" style="display:none;">0</div></div>
  <div class="rail-btn" id="rail-profile" onclick="navigate('profile')" data-tip="Settings">‚öôÔ∏è</div>
</div>
<div class="sidebar" id="sidebar" style="display:none;">
  <div class="sidebar-header" id="sidebar-header">
    <div style="display:flex;align-items:center;gap:8px;cursor:pointer;" onclick="navigate('home')">
      <img src="Fortized icon.png" style="width:20px;height:20px;object-fit:contain;" onerror="this.style.display='none'">
      <span id="sidebar-title" style="font-family:'Syne',sans-serif;font-size:14px;font-weight:700;">Fortized</span>
    </div>
    <div class="hdr-actions" id="sidebar-actions"></div>
  </div>
  <div class="sidebar-scroll" id="sidebar-scroll"></div>
  <div id="boost-bar-wrap" style="display:none;">
    <div class="boost-bar" onclick="openBastionBoost()">
      <span>‚ö°</span>
      <div><div class="bl" id="boost-label">Boost Bastion</div><div style="font-size:11px;" id="boost-sublabel">Level 0</div></div>
    </div>
  </div>
  <div class="userbar">
    <div class="ua" id="ua" onclick="navigate('profile')"><div class="ua-ring"></div></div>
    <div class="ua-info"><div class="ua-name" id="ua-name">‚Äî</div><div class="ua-tag" id="ua-tag">‚óè Online</div></div>
    <div class="ua-btns">
      <button title="Mute" onclick="toast('Muted','info')">üé§</button>
      <button title="Deafen" onclick="toast('Deafened','info')">üéß</button>
      <button title="Log Out" onclick="doLogout()">üö™</button>
    </div>
  </div>
</div>
<div class="main" id="main-content" style="display:none;">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title"><span>üè†</span><span>Home</span></div>
    <div class="tb-sep"></div>
    <div class="tb-desc" id="topbar-desc">Welcome to Fortized</div>
    <div class="tb-actions">
      <div class="onyx-pill" onclick="navigate('atelier')">
        <img src="Onyx.png" onerror="this.outerHTML='üíé'"><span id="topbar-onyx">0</span>
      </div>
      <div class="tb-search"><span style="font-size:12px;color:var(--muted);">üîç</span><input type="text" placeholder="Search‚Ä¶"></div>
      <button id="member-list-btn" style="display:none;" onclick="toggleMemberList()" title="Members">üë•</button>
      <button id="bastion-settings-btn" style="display:none;" onclick="openBastionSettings()" title="Bastion Settings">‚öôÔ∏è</button>
    </div>
  </div>
  <div class="content">
    <div id="view-home" class="view active"><div class="home-wrap"><div class="home-feed"><div id="home-content"></div></div><div class="home-right" id="home-right"></div></div></div>
    <div id="view-bastion" class="view" style="flex-direction:row;"><div id="bastion-main" style="flex:1;display:flex;flex-direction:column;min-width:0;"></div><div class="member-list" id="member-list" style="display:none;"></div></div>
    <div id="view-discover" class="view"><div class="discover-scroll"><div class="disc-hero"><h2>Discover Bastions</h2><p>Find public communities, join the fight, and make your mark.</p><div class="disc-search"><span class="si">üîç</span><input type="text" placeholder="Search bastions‚Ä¶" id="disc-input" oninput="filterBastions()"></div></div><div class="disc-tabs"><div class="disc-tab active" onclick="setDiscTab('all',this)">All</div><div class="disc-tab" onclick="setDiscTab('gaming',this)">üéÆ Gaming</div><div class="disc-tab" onclick="setDiscTab('competitive',this)">‚öîÔ∏è Competitive</div><div class="disc-tab" onclick="setDiscTab('casual',this)">üé™ Casual</div></div><div class="bastion-grid" id="bastion-grid"></div></div></div>
    <div id="view-atelier" class="view"><div class="atelier-scroll"><div class="atelier-top"><div class="atelier-bal"><img src="Onyx.png" onerror="this.outerHTML='üíé'"><div><h3>Onyx Balance</h3><div class="amt" id="atelier-balance">0</div></div></div><div class="daily-btn" id="daily-btn" onclick="claimDaily()"><span>Daily Reward</span><strong>+5 Onyx</strong><span id="daily-status">Claim now ‚Üí</span></div></div><div class="atelier-section-title">Radiance ‚Äî Premium Status</div><div class="radiance-grid"><div class="rad-card" onclick="buyRadiance(110,'1 Day')"><div class="rad-icon">‚ú®</div><div class="rad-dur">1 Day</div><div class="rad-price">110 <span>Onyx</span></div><div class="rad-feats">Full perks for 24 hours</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div><div class="rad-card bv" onclick="buyRadiance(770,'7 Days')"><div class="best-badge">Best Value</div><div class="rad-icon">‚ö°</div><div class="rad-dur">7 Days</div><div class="rad-price">770 <span>Onyx</span></div><div class="rad-feats">Full perks for one week</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div><div class="rad-card" onclick="buyRadiance(3300,'30 Days')"><div class="rad-icon">üëë</div><div class="rad-dur">30 Days</div><div class="rad-price">3,300 <span>Onyx</span></div><div class="rad-feats">Full perks for a month</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12.5px;padding:8px;">Activate</button></div></div><div class="atelier-section-title">Radiance Perks</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"><div class="s-row" style="cursor:default;"><span class="si">üé®</span><div class="st"><div class="sl">Custom Profile Badge</div><div class="ss">Exclusive Radiance crown</div></div></div><div class="s-row" style="cursor:default;"><span class="si">üåü</span><div class="st"><div class="sl">Animated Border</div><div class="ss">Glowing avatar frame</div></div></div><div class="s-row" style="cursor:default;"><span class="si">üí¨</span><div class="st"><div class="sl">Extended Messages</div><div class="ss">Up to 4000 chars</div></div></div><div class="s-row" style="cursor:default;"><span class="si">üñº</span><div class="st"><div class="sl">Custom Banner</div><div class="ss">Profile banner</div></div></div></div></div></div>
    <div id="view-profile" class="view"><div class="profile-wrap"><div class="profile-nav" id="profile-nav"></div><div class="profile-main" id="profile-main"></div></div></div>
    <div id="view-bsettings" class="view"><div class="bsettings-wrap"><div class="bsettings-nav" id="bsettings-nav"></div><div class="bsettings-main" id="bsettings-main"></div></div></div>
  </div>
</div>
<!-- MODALS -->
<div class="modal-overlay" id="modal-create-bastion"><div class="modal"><div class="modal-bar"></div><div class="modal-body"><div class="modal-title">Create a Bastion</div><div class="modal-sub">Build your own community fortress.</div><div class="modal-error" id="create-error"></div><input class="modal-input" id="bastion-name-input" placeholder="Bastion name" maxlength="32"><input class="modal-input" id="bastion-desc-input" placeholder="Short description (optional)" maxlength="80"><div style="margin-bottom:12px;"><div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Bastion Tag (optional)</div><input class="modal-input" id="bastion-tag-input" placeholder="e.g. WAR (max 5 chars)" maxlength="5" style="text-transform:uppercase;"></div><div style="margin-bottom:12px;"><div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Tag Color</div><div class="color-swatches" id="bastion-color-picker"></div></div><div style="margin-bottom:14px;"><div style="font-size:11px;color:var(--muted);margin-bottom:8px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Icon Emoji</div><div class="emoji-picker-wrap" id="bastion-emoji-picker"></div></div><div style="margin-bottom:14px;"><div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;">Custom Emblem (optional)</div><label style="cursor:pointer;display:flex;align-items:center;gap:10px;"><div id="create-emblem-prev" style="width:48px;height:48px;border-radius:12px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:22px;overflow:hidden;">üì∑</div><span class="btn-g" style="font-size:12px;padding:7px 12px;">Upload Image</span><input type="file" accept="image/*" id="bastion-emblem-input" style="display:none;" onchange="handleEmblemUpload(event,'create-emblem-prev')"></label></div></div><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-create-bastion')">Cancel</button><button class="btn-a" onclick="createBastion()">‚öîÔ∏è Create</button></div></div></div></div>
<div class="modal-overlay" id="modal-new-dm"><div class="modal"><div class="modal-bar"></div><div class="modal-body"><div class="modal-title">New Direct Message</div><div class="modal-sub">Message any Fortized user by username.</div><div class="modal-error" id="dm-error"></div><input class="modal-input" id="dm-username-input" placeholder="Enter username‚Ä¶" onkeydown="if(event.key==='Enter')startDM()"><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-new-dm')">Cancel</button><button class="btn-a" onclick="startDM()">Open DM</button></div></div></div></div>
<div class="modal-overlay" id="modal-add-friend"><div class="modal"><div class="modal-bar"></div><div class="modal-body"><div class="modal-title">Add a Friend</div><div class="modal-sub">Send a friend request by exact username.</div><div class="modal-error" id="af-error"></div><div class="modal-success" id="af-success"></div><input class="modal-input" id="af-input" placeholder="Exact username‚Ä¶" onkeydown="if(event.key==='Enter')sendFriendReq()"><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-add-friend')">Close</button><button class="btn-a" onclick="sendFriendReq()">Send Request</button></div></div></div></div>
<div class="modal-overlay" id="modal-join-bastion"><div class="modal"><div class="modal-bar"></div><div class="modal-body" id="join-bastion-body"></div></div></div>
<div class="modal-overlay" id="modal-buy"><div class="modal"><div class="modal-bar"></div><div class="modal-body"><div class="modal-title" id="buy-title">Activate Radiance?</div><div class="modal-sub" id="buy-sub">This will deduct Onyx.</div><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-buy')">Cancel</button><button class="btn-a" onclick="confirmBuy()">‚ú® Confirm</button></div></div></div></div>
<div class="modal-overlay" id="modal-user"><div class="modal"><div class="modal-bar"></div><div class="modal-body" id="user-modal-body"></div></div></div>
<div class="modal-overlay" id="modal-leave-bastion"><div class="modal"><div class="modal-bar"></div><div class="modal-body" id="leave-bastion-body"></div></div></div>
<div class="modal-overlay" id="modal-role-editor"><div class="modal wide tall"><div class="modal-bar"></div><div class="modal-body" id="role-editor-body"></div></div></div>
<div class="modal-overlay" id="modal-member-manage"><div class="modal"><div class="modal-bar"></div><div class="modal-body" id="member-manage-body"></div></div></div>
<div class="toast" id="toast"></div>
<div id="ctx-menu" style="display:none;" class="ctx-menu"></div>
<script>
// ‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê
let CU=null,curView='home',curDM=null,curBastion=null,curChannel=null;
let memberListOpen=false,notifPanelOpen=false,pendingBuy=null,discTab='all';
let curBSettingsTab='overview',_pendingEmblemData=null;
let _channelUnlisten=null,_dmUnlisten=null;
const EMOJIS=['üè∞','‚öîÔ∏è','üõ°Ô∏è','üèπ','üî•','‚ö°','üåå','üéÆ','üéØ','üíÄ','üêâ','üåô','üåü','üé™','üîÆ','üåä','ü¶Ö','üó°Ô∏è'];
const TAG_COLORS=['#f59e0b','#3ecf6e','#60a5fa','#f87171','#a78bfa','#fb923c','#34d399','#f472b6','#fff93e','#94a3b8'];
const QUICK_REACT=['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üî•','‚úÖ'];
const ROLE_COLORS=['#f87171','#fb923c','#f59e0b','#a3e635','#3ecf6e','#22d3ee','#60a5fa','#a78bfa','#f472b6','#fff93e','#94a3b8','#e2e8f0'];
const BLOG_POSTS=[{tag:'Update',title:'Bastions 2.0 ‚Äî Channels, Roles & More',date:'Feb 14, 2025'},{tag:'Feature',title:'Atelier Store is Now Live',date:'Jan 28, 2025'},{tag:'Community',title:'February Onyx Giveaway Results',date:'Jan 20, 2025'}];
const PERM_LABELS={create_channels:'Create Channels',delete_channels:'Delete Channels',manage_roles:'Manage Roles',assign_roles:'Assign Roles',delete_roles:'Delete Roles',transfer_ownership:'Transfer Ownership',delete_bastion:'Delete Bastion',change_bastion_name:'Change Bastion Name',ban_members:'Ban Members',kick_members:'Kick Members',timeout_members:'Timeout Members',mute_members:'Mute Members',create_invites:'Create Invites',manage_invites:'Manage Invites',configure_automod:'Configure AutoMod',view_audit_logs:'View Audit Logs',view_channels:'View Channels',send_messages:'Send Messages',embed_links:'Embed Links',attach_files:'Attach Files',add_reactions:'Add Reactions',use_external_emojis:'Use External Emojis',mention_everyone:'Mention @everyone',read_history:'Read Message History',use_slash_commands:'Use Slash Commands',change_nickname:'Change Nickname',create_invites_member:'Create Invites'};
const ALL_PERMS=Object.keys(PERM_LABELS);

// ‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê
window.addEventListener('DOMContentLoaded', async()=>{
  const u=localStorage.getItem('ftz_current')||localStorage.getItem('fortized_current_user');
  if(!u){window.location.href='login.html';return;}
  try{CU=await FortizedSocial.getUserByName(u);if(!CU){window.location.href='login.html';return;}}
  catch(e){console.error(e);window.location.href='login.html';return;}
  ['bastions','friends','friendRequestsSent','friendRequestsReceived'].forEach(k=>{if(!Array.isArray(CU[k]))CU[k]=[];});
  if(typeof CU.onyx!=='number')CU.onyx=25;
  if(!CU.status)CU.status='online';
  if(!CU.displayName)CU.displayName=CU.username;
  await FortizedSocial.setStatus(CU.username,'online');
  document.getElementById('app-loading').style.display='none';
  document.getElementById('rail').style.display='';
  document.getElementById('sidebar').style.display='';
  document.getElementById('main-content').style.display='';
  buildUI();
  await navigate('home');
  await checkInviteLink();
  FortizedSocial.startPolling(CU.username,{
    onNewNotification:async(n)=>{
      await refreshCU();await updateNotifBadge();
      if(n.type==='friend_request')toast(`üë• Friend request from ${n.from}!`,'info');
      else if(n.type==='friend_accept'){toast(`ü§ù ${n.from} accepted your request!`,'success');await refreshCU();}
      else if(n.type==='dm')toast(`üí¨ ${n.from}: ${(n.data?.preview||'').slice(0,30)}`,'info');
      if(notifPanelOpen)await buildNotifList();
      if(curView==='home')await refreshHomeRight();
      FortizedSocial.playNotificationSound();
    }
  });
  setInterval(async()=>{await refreshCU();await updateNotifBadge();if(curView==='home')await refreshHomeRight();},5000);
  document.addEventListener('click',()=>document.getElementById('ctx-menu').style.display='none');
});

async function saveUser(){await FortizedSocial.saveUserObject(CU);}
async function refreshCU(){const f=await FortizedSocial.getUserByName(CU.username).catch(()=>null);if(f){Object.assign(CU,f);updateOnyxDisplay();}}
async function updateNotifBadge(){try{const c=await FortizedSocial.getUnreadCount(CU.username);const b=document.getElementById('notif-badge');b.style.display=c>0?'flex':'none';b.textContent=c>9?'9+':c;}catch(e){}}
window.updateNotifBadge=updateNotifBadge;

function buildUI(){
  updateAvatarEl(document.getElementById('ua'),CU);
  document.getElementById('ua-name').textContent=CU.displayName||CU.username;
  updateOnyxDisplay();buildRailBastions();buildEmojiPicker();buildColorPicker();updateDailyBtn();updateNotifBadge();
}

function buildAvatar(user,size=30){
  const d=document.createElement('div');d.className='fa';d.style.width=size+'px';d.style.height=size+'px';d.style.fontSize=Math.floor(size*.4)+'px';
  if(user.pfp){const i=document.createElement('img');i.src=user.pfp;i.onerror=()=>{i.remove();d.textContent=(user.displayName||user.username||'?')[0].toUpperCase();};d.appendChild(i);}
  else d.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  const dot=document.createElement('div');dot.className='fs offline';d.appendChild(dot);
  FortizedSocial.getStatus(user.username).then(s=>{dot.className='fs '+(s||'offline');}).catch(()=>{});
  return d;
}

function updateAvatarEl(el,user){
  if(!el)return;const ring=el.querySelector('.ua-ring');el.innerHTML='';
  if(user.pfp){const i=document.createElement('img');i.src=user.pfp;i.onerror=()=>{i.remove();el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();if(ring)el.appendChild(ring);};el.appendChild(i);}
  else el.textContent=(user.displayName||user.username||'?')[0].toUpperCase();
  if(ring)el.appendChild(ring);
}

function updateOnyxDisplay(){document.getElementById('topbar-onyx').textContent=CU.onyx;const ab=document.getElementById('atelier-balance');if(ab)ab.textContent=CU.onyx;}

function buildRailBastions(){
  const c=document.getElementById('rail-bastions');c.innerHTML='';
  (CU.bastions||[]).forEach((b,i)=>{
    const el=document.createElement('div');el.className='rail-bastion'+(curBastion===i?' active':'');el.setAttribute('data-tip',b.name);
    if(b.emblem){const img=document.createElement('img');img.src=b.emblem;img.onerror=()=>{img.remove();el.textContent=b.icon||'üè∞';};el.appendChild(img);}
    else el.textContent=b.icon||'üè∞';
    el.onclick=()=>openBastion(i);c.appendChild(el);
  });
}

// ‚ïê‚ïê‚ïê NAVIGATE ‚ïê‚ïê‚ïê
async function navigate(view){
  ['home','bastion','discover','atelier','profile','bsettings'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  document.querySelectorAll('.rail-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach(b=>b.classList.remove('active'));
  document.getElementById('member-list-btn').style.display='none';
  document.getElementById('bastion-settings-btn').style.display='none';
  document.getElementById('boost-bar-wrap').style.display='none';
  curView=view;
  const el=document.getElementById('view-'+view);if(el){el.style.display='flex';el.classList.add('active');}
  const rb=document.getElementById('rail-'+view);if(rb)rb.classList.add('active');
  if(view==='home'){setTopbar('üè∞','Home','Your fortress hub');setSidebar('home');renderHomeLanding();await refreshHomeRight();}
  else if(view==='discover'){setTopbar('üß≠','Discover','Find public Bastions');setSidebar('discover');await buildDiscoverGrid();}
  else if(view==='atelier'){setTopbar('üíé','Atelier','Spend Onyx');setSidebar('atelier');updateOnyxDisplay();updateDailyBtn();}
  else if(view==='profile'){setTopbar('‚öôÔ∏è','Settings','Manage your account');setSidebar('profile');buildProfileView('myprofile');}
}

function setTopbar(icon,title,desc){
  document.getElementById('topbar-title').innerHTML=`<span>${icon}</span><span>${title}</span>`;
  document.getElementById('topbar-desc').textContent=desc;
}

// ‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê
function setSidebar(ctx){
  const scroll=document.getElementById('sidebar-scroll');const title=document.getElementById('sidebar-title');const actions=document.getElementById('sidebar-actions');
  scroll.innerHTML='';actions.innerHTML='';
  if(ctx==='home'){title.textContent='Fortized';scroll.appendChild(makeSLabel('Direct Messages',`<button onclick="openNewDM()" title="New DM">+</button>`));buildDMItems(scroll);}
  else if(ctx==='discover')title.textContent='Discover';
  else if(ctx==='atelier')title.textContent='Atelier';
  else if(ctx==='profile')title.textContent='Settings';
  else if(ctx==='bastion'&&curBastion!==null){
    const b=CU.bastions[curBastion];title.textContent=b.name;
    if(b.owner===CU.username)actions.innerHTML=`<button onclick="openBastionSettings()" title="Settings">‚öôÔ∏è</button>`;
    document.getElementById('boost-bar-wrap').style.display='block';
    document.getElementById('boost-label').textContent='Boost Bastion';
    document.getElementById('boost-sublabel').textContent=`Level ${b.boostLevel||0}`;
    buildChannelList(scroll,b,curBastion);
  }
}

function buildChannelList(container,b,bIdx){
  const isOwner=b.owner===CU.username;
  const catEl=document.createElement('div');catEl.className='cat-row';
  catEl.innerHTML=`<span style="font-size:9px;">‚ñæ</span><span>Text Channels</span>${isOwner?`<button onclick="event.stopPropagation();addChannel(${bIdx})">+</button>`:''}`;
  container.appendChild(catEl);
  (b.channels||[]).forEach((ch,ci)=>{
    const el=document.createElement('div');el.className='ch-item'+(curChannel===ci?' active':'');
    el.innerHTML=`<span style="font-size:12px;color:var(--muted);">#</span><span style="flex:1;">${escapeHTML(ch.name)}</span>`;
    el.onclick=()=>openChannel(bIdx,ci);
    if(isOwner)el.oncontextmenu=e=>{e.preventDefault();showCtxMenu(e.clientX,e.clientY,[{label:`# ${ch.name}`,section:true},{sep:true},{icon:'üóëÔ∏è',label:'Delete Channel',action:()=>deleteChannel(bIdx,ci),danger:true}]);};
    container.appendChild(el);
  });
  const vcEl=document.createElement('div');vcEl.className='ch-item';vcEl.innerHTML=`<span>üîä</span><span style="flex:1;">General Voice</span>`;vcEl.onclick=()=>toast('Voice channels coming soon','info');container.appendChild(vcEl);
}

function makeSLabel(text,extraHTML=''){const el=document.createElement('div');el.className='sec-label';el.innerHTML=`<span>${text}</span>${extraHTML}`;return el;}

function buildDMItems(container){
  FortizedSocial.getRecentDMPartners(CU.username).then(partners=>{
    if(!partners.length){const e=document.createElement('div');e.style.cssText='padding:10px 14px;font-size:12.5px;color:var(--muted);';e.textContent='No DMs yet.';container.appendChild(e);return;}
    partners.forEach(async partner=>{
      const msgs=await FortizedSocial.getDMMessages(CU.username,partner).catch(()=>[]);
      const last=msgs[msgs.length-1];
      const pUser=await FortizedSocial.getUserByName(partner).catch(()=>null)||{username:partner};
      const el=document.createElement('div');el.className='friend-item'+(curDM===partner?' active':'');
      const av=buildAvatar(pUser,30);el.appendChild(av);
      const info=document.createElement('div');info.className='fi-info';
      info.innerHTML=`<div class="fi-name">${escapeHTML(pUser.displayName||partner)}</div><div class="fi-sub">${last?escapeHTML(last.text.slice(0,26))+'‚Ä¶':'Start chatting!'}</div>`;
      el.appendChild(info);el.onclick=()=>openDMChat(partner);container.appendChild(el);
    });
  }).catch(()=>{});
}

// ‚ïê‚ïê‚ïê HOME ‚ïê‚ïê‚ïê
function renderHomeLanding(){
  const area=document.getElementById('home-content');if(!area)return;
  const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
  const pending=(CU.friendRequestsReceived||[]).length;
  const dn=escapeHTML(CU.displayName||CU.username);
  area.innerHTML=`
    <div class="home-hero">
      <div class="hero-left-content">
        <div class="hero-tag-app"><span class="hero-tag-dot"></span>Welcome Back${hasRadiance?' ¬∑ ‚ú® Radiance':''}</div>
        <h1>Welcome,<br><em>${dn}.</em></h1>
        <p class="hero-sub-app">Ready to storm the fortress? Rally your allies and conquer together.</p>
        <div class="home-hero-actions">
          ${CU.bastions&&CU.bastions.length?`<button class="btn-a" onclick="openBastion(0)">‚öîÔ∏è Open Bastion</button>`:`<button class="btn-a" onclick="openCreateBastion()">üè∞ Create Bastion</button>`}
          <button class="btn-g" onclick="navigate('discover')">üß≠ Discover</button>
          <button class="btn-g" onclick="renderFriends()">üë• Friends${pending>0?` <span style="background:var(--red);color:#fff;font-size:9px;padding:1px 5px;border-radius:100px;margin-left:2px;">${pending}</span>`:''}</button>
        </div>
      </div>
      <div class="home-hero-knight"><img src="Fortized Knight.png" onerror="this.style.display='none'" alt=""></div>
    </div>
    <div class="home-marquee"><div class="marquee-track">${[['üéÆ','PLAY','Amplify your sessions'],['üè∞','HANGOUT','Enter the Fortress'],['‚öíÔ∏è','CREATE','Forge your Bastions'],['üì°','SHARE','Broadcast your moment'],['‚öîÔ∏è','CONQUER','Rally your allies'],['üó∫Ô∏è','EXPLORE','Discover Bastions']].map(([icon,word,desc])=>`<div class="marquee-item"><span class="mi-icon">${icon}</span><span class="mi-label"><span class="mi-accent">${word}</span> ‚Äî ${desc}</span></div>`).join('')}${[['üéÆ','PLAY','Amplify your sessions'],['üè∞','HANGOUT','Enter the Fortress'],['‚öíÔ∏è','CREATE','Forge your Bastions'],['üì°','SHARE','Broadcast your moment'],['‚öîÔ∏è','CONQUER','Rally your allies'],['üó∫Ô∏è','EXPLORE','Discover Bastions']].map(([icon,word,desc])=>`<div class="marquee-item"><span class="mi-icon">${icon}</span><span class="mi-label"><span class="mi-accent">${word}</span> ‚Äî ${desc}</span></div>`).join('')}</div></div>
    <div class="home-main-scroll">
      <div class="section-hdr"><h3>Quick Access</h3></div>
      <div class="quick-nav">
        <div class="qn-tile" onclick="navigate('discover')"><div class="qn-icon" style="background:rgba(255,249,62,.08);border:1px solid rgba(255,249,62,.14);">üß≠</div><div class="qn-text"><h4>Discover</h4><p>Find new Bastions</p></div></div>
        <div class="qn-tile" onclick="renderFriends()"><div class="qn-icon" style="background:rgba(62,207,110,.1);border:1px solid rgba(62,207,110,.18);">üë•</div><div class="qn-text"><h4>Friends</h4><p>${(CU.friends||[]).length} connected</p></div>${pending>0?`<div class="qn-badge">${pending}</div>`:''}</div>
        <div class="qn-tile" onclick="navigate('atelier')"><div class="qn-icon" style="background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);">üíé</div><div class="qn-text"><h4>Atelier</h4><p>${CU.onyx} Onyx</p></div></div>
        <div class="qn-tile" onclick="openNewDM()"><div class="qn-icon" style="background:rgba(96,165,250,.1);border:1px solid rgba(96,165,250,.18);">üí¨</div><div class="qn-text"><h4>New DM</h4><p>Message someone</p></div></div>
      </div>
      <div class="section-hdr"><h3>Your Bastions</h3></div>
      <div id="bastions-list-home">
        ${(!CU.bastions||!CU.bastions.length)
          ?`<div class="activity-item"><div class="act-icon">üè∞</div><div class="act-text"><p>No Bastions yet. <strong onclick="navigate('discover')" style="color:var(--accent);cursor:pointer;">Discover</strong> or create one.</p></div></div>`
          :(CU.bastions||[]).slice(0,5).map((b,i)=>`<div class="activity-item" onclick="openBastion(${i})"><div class="act-icon">${b.emblem?`<img src="${b.emblem}">`:(b.icon||'üè∞')}</div><div class="act-text"><p><strong>${escapeHTML(b.name)}</strong>${b.bastionTag?` <span class="bastion-tag" style="color:${b.tagColor||'var(--accent)'};border-color:${b.tagColor||'var(--accent)'}44;">${escapeHTML(b.bastionTag)}</span>`:''}</p><div class="act-time">#${b.channels?.[0]?.name||'general'}</div></div><span style="font-size:12px;color:var(--muted);">‚Üí</span></div>`).join('')}
      </div>
    </div>`;
}

async function refreshHomeRight(){
  const panel=document.getElementById('home-right');if(!panel)return;
  let notifs=[];try{notifs=(await FortizedSocial.getNotifications(CU.username)).slice(0,6);}catch(e){}
  let html=`<div class="rp-section"><div class="rp-title">Notifications</div>`;
  if(!notifs.length)html+=`<div style="font-size:12.5px;color:var(--muted);padding:4px 0;">All caught up ‚úì</div>`;
  else notifs.forEach(n=>{
    let icon='üîî',text='';
    if(n.type==='friend_request'){icon='üë•';text=`<strong>${escapeHTML(n.from)}</strong> sent a friend request`;}
    else if(n.type==='friend_accept'){icon='ü§ù';text=`<strong>${escapeHTML(n.from)}</strong> accepted your request`;}
    else if(n.type==='dm'){icon='üí¨';text=`<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview||'').slice(0,40))}`;}
    const actions=n.type==='friend_request'?`<div class="rn-actions"><button class="rn-accept" onclick="acceptFriend('${n.from}')">Accept</button><button class="rn-decline" onclick="declineFriend('${n.from}')">Decline</button></div>`:'';
    html+=`<div class="rp-notif ${n.read?'':'unread'}"><div class="rn-icon">${icon}</div><div class="rn-text"><p>${text}</p><div class="rn-time">${formatTimeAgo(n.time)}</div>${actions}</div></div>`;
  });
  html+=`</div><div class="rp-section"><div class="rp-title">üì∞ Fortized Blog</div>`;
  BLOG_POSTS.forEach(p=>{html+=`<div class="blog-post" onclick="toast('Blog coming soon','info')"><div class="bp-tag">${p.tag}</div><div class="bp-title">${p.title}</div><div class="bp-date">${p.date}</div></div>`;});
  html+=`</div>`;panel.innerHTML=html;
}

// ‚ïê‚ïê‚ïê FRIENDS ‚ïê‚ïê‚ïê
async function renderFriends(){
  const pending=(CU.friendRequestsReceived||[]).length;
  const friendsHTML=(CU.friends||[]).length?
    (CU.friends||[]).map(f=>`<div style="display:flex;align-items:center;gap:13px;padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:18px;margin-bottom:8px;"><div id="fav-${f}" style="flex-shrink:0;"></div><div style="flex:1;"><div style="font-size:14px;font-weight:700;" id="fname-${f}">${escapeHTML(f)}</div><div style="font-size:12px;color:var(--muted);" id="fstatus-${f}">‚óè loading‚Ä¶</div></div><div style="display:flex;gap:7px;"><button class="btn-g" onclick="openDMChat('${f}')" style="font-size:12.5px;padding:7px 14px;">üí¨ Message</button><button class="btn-d" onclick="removeFriend('${f}')" style="font-size:12.5px;padding:7px 10px;">‚úï</button></div></div>`).join('')
    :`<div class="empty-state"><div class="ei">üë•</div><h3>No friends yet</h3><p>Add friends by username.</p><button class="btn-a" style="margin-top:8px;" onclick="openAddFriend()">Add a Friend</button></div>`;
  showHomeContent(`<div class="home-main-scroll"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;"><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Friends ‚Äî ${(CU.friends||[]).length}</div><button class="btn-a" onclick="openAddFriend()" style="font-size:13px;padding:9px 18px;">+ Add Friend</button></div>
  ${pending>0?`<div style="background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.15);border-radius:16px;padding:14px 18px;margin-bottom:16px;"><div style="font-size:13px;font-weight:700;margin-bottom:10px;">üì¨ Pending Requests (${pending})</div>${(CU.friendRequestsReceived||[]).map(f=>`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;"><div style="font-size:14px;font-weight:600;flex:1;">${escapeHTML(f)}</div><button class="rn-accept" onclick="acceptFriend('${f}')">Accept</button><button class="rn-decline" onclick="declineFriend('${f}')">Decline</button></div>`).join('')}</div>`:''}
  ${friendsHTML}</div>`);
  for(const f of(CU.friends||[])){
    FortizedSocial.getUserByName(f).then(u=>{if(!u)return;const c=document.getElementById('fav-'+f);if(c){const av=buildAvatar(u,40);c.appendChild(av);}const n=document.getElementById('fname-'+f);if(n)n.textContent=u.displayName||f;}).catch(()=>{});
    FortizedSocial.getStatus(f).then(s=>{const el=document.getElementById('fstatus-'+f);if(!el)return;const colors={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)',offline:'var(--muted)',invisible:'var(--muted)'};el.innerHTML=`<span style="color:${colors[s]||'var(--muted)'};">‚óè ${s||'offline'}</span>`;}).catch(()=>{});
  }
}

function showHomeContent(html){const c=document.getElementById('home-content');if(c)c.innerHTML=html;}
function openAddFriend(){document.getElementById('af-input').value='';document.getElementById('af-error').textContent='';document.getElementById('af-success').textContent='';openModal('modal-add-friend');}

async function sendFriendReq(){
  const name=document.getElementById('af-input').value.trim();
  document.getElementById('af-error').textContent='';document.getElementById('af-success').textContent='';
  if(!name){document.getElementById('af-error').textContent='Enter a username.';return;}
  try{const r=await FortizedSocial.sendFriendRequest(CU.username,name);
    if(r.ok){document.getElementById('af-success').textContent=r.msg;document.getElementById('af-input').value='';await refreshCU();FortizedSocial.playNotificationSound();}
    else document.getElementById('af-error').textContent=r.msg;
  }catch(e){document.getElementById('af-error').textContent='Error sending request.';}
}

async function acceptFriend(from){try{const r=await FortizedSocial.acceptFriendRequest(CU.username,from);if(r.ok){await refreshCU();toast(r.msg,'success');FortizedSocial.playNotificationSound();if(curView==='home')await refreshHomeRight();}else toast(r.msg,'error');}catch(e){toast('Error','error');}}
async function declineFriend(from){try{await FortizedSocial.declineFriendRequest(CU.username,from);await refreshCU();toast('Request declined','info');if(curView==='home')await refreshHomeRight();}catch(e){}}
async function removeFriend(f){if(!confirm(`Remove ${f}?`))return;await FortizedSocial.removeFriend(CU.username,f);await refreshCU();toast('Friend removed','info');renderFriends();}

// ‚ïê‚ïê‚ïê DM ‚ïê‚ïê‚ïê
function openNewDM(){document.getElementById('dm-username-input').value='';document.getElementById('dm-error').textContent='';openModal('modal-new-dm');}

async function startDM(){
  const name=document.getElementById('dm-username-input').value.trim();
  if(!name){document.getElementById('dm-error').textContent='Enter a username.';return;}
  if(name===CU.username){document.getElementById('dm-error').textContent="Can't DM yourself!";return;}
  try{const u=await FortizedSocial.getUserByName(name);if(!u){document.getElementById('dm-error').textContent='User not found.';return;}
    closeModal('modal-new-dm');
    if(curView!=='home'){await navigate('home');setTimeout(()=>openDMChat(name),100);}else openDMChat(name);
  }catch(e){document.getElementById('dm-error').textContent='Error finding user.';}
}

async function openDMChat(partner){
  if(_dmUnlisten){_dmUnlisten();_dmUnlisten=null;}
  curDM=partner;
  const pUser=await FortizedSocial.getUserByName(partner).catch(()=>null)||{username:partner};
  const status=await FortizedSocial.getStatus(partner).catch(()=>'offline');
  setTopbar('üí¨',escapeHTML(pUser.displayName||partner),`‚óè ${status}`);
  if(curView==='home'){const scroll=document.getElementById('sidebar-scroll');if(scroll){scroll.innerHTML='';scroll.appendChild(makeSLabel('Direct Messages',`<button onclick="openNewDM()">+</button>`));buildDMItems(scroll);}}
  let msgs=await FortizedSocial.getDMMessages(CU.username,partner).catch(()=>[]);
  const area=document.getElementById('home-content');if(!area)return;
  area.innerHTML=`<div class="chat-wrap"><div class="chat-msgs" id="chat-msgs">
    <div class="chat-welcome"><div class="w-av" id="dm-wav" style="background:var(--panel);border:2px solid var(--border);width:60px;height:60px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:24px;margin-bottom:12px;">${(pUser.displayName||partner)[0].toUpperCase()}</div><h3>${escapeHTML(pUser.displayName||partner)}</h3><p>Start of your DM with <strong>${escapeHTML(partner)}</strong>.</p></div>
    ${renderMsgs(msgs)}
  </div><div class="chat-input-wrap"><div class="chat-input-box"><div class="chat-input-actions"><button onclick="toast('Soon','info')">üìé</button><button onclick="toast('Soon','info')">üòä</button></div><textarea id="dm-input" placeholder="Message ${escapeHTML(pUser.displayName||partner)}" rows="1" onkeydown="dmKey(event,'${partner}')" oninput="autoResize(this)"></textarea><button class="chat-send" onclick="sendDM('${partner}')">‚û§</button></div></div></div>`;
  if(pUser.pfp){const wav=document.getElementById('dm-wav');if(wav){const img=document.createElement('img');img.src=pUser.pfp;img.style.cssText='width:100%;height:100%;object-fit:cover;border-radius:50%;';wav.innerHTML='';wav.appendChild(img);}}
  scrollBottom('chat-msgs');
  _dmUnlisten=FortizedSocial.listenDM(CU.username,partner,(newMsg)=>{
    if(newMsg.from===CU.username)return;
    FortizedSocial.getDMMessages(CU.username,partner).then(updated=>{const el=document.getElementById('chat-msgs');if(!el)return;el.querySelectorAll('.msg-row,.date-div').forEach(e=>e.remove());el.insertAdjacentHTML('beforeend',renderMsgs(updated));scrollBottom('chat-msgs');}).catch(()=>{});
  });
}

async function sendDM(partner){
  const input=document.getElementById('dm-input');const text=input?.value.trim();if(!text)return;
  input.value='';input.style.height='';
  try{await FortizedSocial.sendDMMessage(CU.username,partner,text);
    const msgs=await FortizedSocial.getDMMessages(CU.username,partner);
    const el=document.getElementById('chat-msgs');if(el){el.querySelectorAll('.msg-row,.date-div').forEach(e=>e.remove());el.insertAdjacentHTML('beforeend',renderMsgs(msgs));scrollBottom('chat-msgs');}
  }catch(e){toast('Failed to send','error');if(input)input.value=text;}
}
function dmKey(e,p){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendDM(p);}}

// ‚ïê‚ïê‚ïê MSG RENDER ‚ïê‚ïê‚ïê
function renderMsgs(msgs){
  if(!msgs||!msgs.length)return'';
  let html='';let lastDate='';let lastAuthor='';let lastTime=0;
  msgs.forEach(m=>{
    const mDate=m.timestamp?new Date(m.timestamp).toLocaleDateString():'';
    const mTs=m.timestamp?new Date(m.timestamp).getTime():0;
    if(mDate&&mDate!==lastDate){html+=`<div class="date-div">${mDate}</div>`;lastDate=mDate;}
    const isFirst=m.from!==lastAuthor||(mTs-lastTime)>300000;
    lastAuthor=m.from;lastTime=mTs;
    const isOwn=m.from===CU.username;
    const reactions=m.reactions||{};
    const rHTML=Object.entries(reactions).map(([emoji,users])=>{const ua=Array.isArray(users)?users:Object.values(users);const mine=ua.includes(CU.username);return`<div class="r-pill ${mine?'mine':''}">${emoji} ${ua.length}</div>`;}).join('');
    const actBtns=QUICK_REACT.slice(0,4).map(e=>`<button title="${e}" onclick="event.stopPropagation();">${e}</button>`).join('');
    html+=`<div class="msg-row ${isFirst?'msg-first':'msg-cont'} ${isOwn?'own':''}" data-id="${m.id||''}">
      <div class="msg-av-wrap">${isFirst?`<div class="msg-av-inner" onclick="viewUserProfile('${escapeHTML(m.from)}')">${(m.from||'?')[0].toUpperCase()}</div>`:`<span class="msg-time-small">${m.time||''}</span>`}</div>
      <div class="msg-content-col">
        ${isFirst?`<div class="msg-header"><span class="msg-author" onclick="viewUserProfile('${escapeHTML(m.from)}')">${escapeHTML(m.from)}</span><span class="msg-timestamp">${m.time||''}</span></div>`:''}
        <div class="msg-text">${parseMD(escapeHTML(m.text||''))}</div>
        ${rHTML?`<div class="msg-reactions">${rHTML}</div>`:''}
      </div>
      <div class="msg-acts">${actBtns}</div>
    </div>`;
  });
  return html;
}

// ‚ïê‚ïê‚ïê BASTIONS ‚ïê‚ïê‚ïê
function getBastionId(bIdx){const b=CU.bastions[bIdx];if(b.globalId)return b.globalId;return`loc_${CU.username}_${b.name}`.replace(/[^a-z0-9_]/gi,'_');}

async function openBastion(idx){
  if(_channelUnlisten){_channelUnlisten();_channelUnlisten=null;}
  curBastion=idx;curChannel=null;memberListOpen=false;
  const b=CU.bastions[idx];
  if(!b.channels||!b.channels.length){b.channels=[{name:'general',id:'general'},{name:'announcements',id:'announcements'}];await saveUser();}
  document.querySelectorAll('.rail-btn').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.rail-bastion').forEach((el,i)=>el.classList.toggle('active',i===idx));
  ['home','discover','atelier','profile','bsettings'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  const bv=document.getElementById('view-bastion');bv.style.display='flex';bv.classList.add('active');
  curView='bastion';setSidebar('bastion');
  setTopbar('üè∞',b.name,b.desc||`Welcome to ${b.name}`);
  document.getElementById('member-list-btn').style.display='flex';
  document.getElementById('bastion-settings-btn').style.display=b.owner===CU.username?'flex':'none';
  document.getElementById('member-list').style.display='none';
  const bastionId=getBastionId(idx);
  await FortizedSocial.addBastionMember(bastionId,CU.username).catch(()=>{});
  await openChannel(idx,0);
}

async function openChannel(bIdx,cIdx){
  if(_channelUnlisten){_channelUnlisten();_channelUnlisten=null;}
  curBastion=bIdx;curChannel=cIdx;
  const b=CU.bastions[bIdx];const ch=b.channels[cIdx];const chId=ch.id||ch.name;
  setTopbar('#',ch.name,`${b.name} ‚Ä∫ #${ch.name}`);
  document.querySelectorAll('.ch-item').forEach((el,i)=>el.classList.toggle('active',i===cIdx));
  const main=document.getElementById('bastion-main');
  const bastionId=getBastionId(bIdx);
  let msgs=await FortizedSocial.getBastionChannelMessages(bastionId,chId).catch(()=>[]);
  main.innerHTML=`<div class="chat-wrap"><div class="chat-msgs" id="b-msgs">
    <div class="chat-welcome"><div class="w-av" style="border-radius:14px;font-size:18px;">#</div><h3>#${escapeHTML(ch.name)}</h3><p>Beginning of <strong>#${escapeHTML(ch.name)}</strong>. Say hello!</p></div>
    ${renderMsgs(msgs)}
  </div><div class="chat-input-wrap"><div class="chat-input-box"><div class="chat-input-actions"><button onclick="toast('Soon','info')">üìé</button><button onclick="toast('Soon','info')">üòä</button></div><textarea id="b-input" placeholder="Message #${escapeHTML(ch.name)}" rows="1" onkeydown="bKey(event,${bIdx},'${chId}')" oninput="autoResize(this)"></textarea><button class="chat-send" onclick="sendBMsg(${bIdx},'${chId}')">‚û§</button></div></div></div>`;
  scrollBottom('b-msgs');
  if(memberListOpen)buildMemberList(bIdx);
  _channelUnlisten=FortizedSocial.listenBastionChannel(bastionId,chId,()=>{
    if(curBastion!==bIdx||curChannel!==cIdx)return;
    FortizedSocial.getBastionChannelMessages(bastionId,chId).then(u=>{const el=document.getElementById('b-msgs');if(!el)return;el.querySelectorAll('.msg-row,.date-div').forEach(e=>e.remove());el.insertAdjacentHTML('beforeend',renderMsgs(u));scrollBottom('b-msgs');}).catch(()=>{});
  });
}

async function sendBMsg(bIdx,chId){
  const input=document.getElementById('b-input');const text=input?.value.trim();if(!text)return;
  const am=checkAutomod(text,bIdx);if(!am.ok){toast('ü§ñ '+am.reason,'error');return;}
  input.value='';input.style.height='';
  const bastionId=getBastionId(bIdx);
  try{await FortizedSocial.sendBastionChannelMessage(bastionId,chId,CU.username,text);
    const msgs=await FortizedSocial.getBastionChannelMessages(bastionId,chId);
    const el=document.getElementById('b-msgs');if(el){el.querySelectorAll('.msg-row,.date-div').forEach(e=>e.remove());el.insertAdjacentHTML('beforeend',renderMsgs(msgs));scrollBottom('b-msgs');}
  }catch(e){toast('Failed to send','error');if(input)input.value=text;}
}
function bKey(e,bIdx,chId){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendBMsg(bIdx,chId);}}

function checkAutomod(text,bIdx){
  if(bIdx===null||bIdx===undefined)return{ok:true};
  const b=CU.bastions[bIdx];const am=b?.automod||{};
  if(am.blockLinks&&/https?:\/\/|www\./i.test(text))return{ok:false,reason:'Links are not allowed in this Bastion.'};
  if(am.blockSpam&&text.length>0&&(text.split('').filter(c=>c===c.toUpperCase()&&c!==c.toLowerCase()).length/text.length>0.7&&text.length>10))return{ok:false,reason:'Please avoid excessive caps.'};
  if(am.customKeywords?.length){const low=text.toLowerCase();for(const kw of am.customKeywords){if(low.includes(kw))return{ok:false,reason:`Message contains a blocked word.`};}}
  return{ok:true};
}

async function addChannel(bIdx){
  const name=prompt('Channel name:');if(!name?.trim())return;
  const clean=name.trim().toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9-]/g,'');
  if(!clean){toast('Invalid name','error');return;}
  if(CU.bastions[bIdx].channels.find(c=>c.name===clean)){toast('Channel exists','error');return;}
  CU.bastions[bIdx].channels.push({name:clean,id:clean});await saveUser();setSidebar('bastion');toast('#'+clean+' created!','success');
}

async function deleteChannel(bIdx,cIdx){
  if(CU.bastions[bIdx].channels.length<=1){toast("Can't delete last channel",'error');return;}
  CU.bastions[bIdx].channels.splice(cIdx,1);await saveUser();setSidebar('bastion');await openChannel(bIdx,0);toast('Channel deleted','info');
}

async function buildMemberList(bIdx){
  const el=document.getElementById('member-list');if(!el)return;
  const b=CU.bastions[bIdx];const bastionId=getBastionId(bIdx);
  let members=await FortizedSocial.getBastionMembers(bastionId).catch(()=>[]);
  if(!members.includes(CU.username))members.push(CU.username);
  el.innerHTML=`<div style="padding:8px 0;"><div class="ml-role-header" style="color:var(--accent);">MEMBERS ‚Äî ${members.length}</div>${members.map(m=>`<div class="ml-entry" onclick="viewUserProfile('${escapeHTML(m)}')"><div class="ml-av"><span style="font-size:11px;">${m[0].toUpperCase()}</span><div class="ml-status" id="mls-${m}" style="background:#374151;"></div></div><div class="ml-info"><div class="ml-name">${escapeHTML(m)}${m===b.owner?' üëë':''}${m===CU.username?' <span style="font-size:10px;color:var(--muted);">(you)</span>':''}</div></div></div>`).join('')}</div>`;
  members.forEach(async m=>{
    const status=await FortizedSocial.getStatus(m).catch(()=>'offline');
    const dot=document.getElementById('mls-'+m);if(dot){const c={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)'}[status]||'#374151';dot.style.background=c;}
  });
}

function toggleMemberList(){memberListOpen=!memberListOpen;const el=document.getElementById('member-list');if(el){el.style.display=memberListOpen?'flex':'none';if(memberListOpen&&curBastion!==null)buildMemberList(curBastion);}}

function promptLeaveBastion(bIdx){
  const b=CU.bastions[bIdx];const isOwner=b.owner===CU.username;
  document.getElementById('leave-bastion-body').innerHTML=`<div class="modal-title">${isOwner?'Delete':'Leave'} Bastion</div><div class="modal-sub">${isOwner?`Delete <strong>${escapeHTML(b.name)}</strong> permanently?`:`Leave <strong>${escapeHTML(b.name)}</strong>?`}</div><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-leave-bastion')">Cancel</button><button class="btn-d" onclick="${isOwner?`deleteBastion(${bIdx})`:`leaveBastion(${bIdx})`}">${isOwner?'üóëÔ∏è Delete':'üö™ Leave'}</button></div>`;
  openModal('modal-leave-bastion');
}

async function leaveBastion(bIdx){const b=CU.bastions[bIdx];const bastionId=getBastionId(bIdx);await FortizedSocial.removeBastionMember(bastionId,CU.username).catch(()=>{});CU.bastions.splice(bIdx,1);await saveUser();closeModal('modal-leave-bastion');buildRailBastions();await navigate('home');toast(`Left ${b.name}`,'info');}
async function deleteBastion(bIdx){const b=CU.bastions[bIdx];CU.bastions.splice(bIdx,1);await saveUser();closeModal('modal-leave-bastion');buildRailBastions();await navigate('home');toast(`Deleted ${b.name}`,'info');}

// ‚ïê‚ïê‚ïê BASTION SETTINGS ‚ïê‚ïê‚ïê
async function openBastionSettings(){
  if(curBastion===null)return;const b=CU.bastions[curBastion];
  if(b.owner!==CU.username){toast('Only the owner can access settings','error');return;}
  ['home','bastion','discover','atelier','profile'].forEach(v=>{const el=document.getElementById('view-'+v);if(el){el.style.display='none';el.classList.remove('active');}});
  const bsv=document.getElementById('view-bsettings');bsv.style.display='flex';bsv.classList.add('active');
  curView='bsettings';setTopbar('‚öôÔ∏è',b.name+' Settings','Manage your Bastion');
  buildBSettingsNav();loadBSettingsTab('overview');
}

function buildBSettingsNav(){
  const nav=document.getElementById('bsettings-nav');nav.innerHTML='';
  const sections=[{label:'Bastion',items:[['overview','üè∞','Overview'],['roles','üé≠','Roles'],['emojis','üòÑ','Custom Emojis'],['channels_manage','#','Channels'],['members','üë•','Members']]},{label:'Moderation',items:[['bans','üö´','Bans'],['automod','ü§ñ','AutoMod']]},{label:'Community',items:[['invites','üîó','Invites'],['visibility','üëÅÔ∏è','Visibility']]}];
  sections.forEach(sec=>{const lbl=document.createElement('div');lbl.className='bsettings-nav-section';lbl.textContent=sec.label;nav.appendChild(lbl);sec.items.forEach(([t,i,l])=>{const el=document.createElement('div');el.className='bsettings-nav-item'+(curBSettingsTab===t?' active':'');el.innerHTML=`<span>${i}</span><span>${l}</span>`;el.onclick=()=>loadBSettingsTab(t);nav.appendChild(el);});});
  const spacer=document.createElement('div');spacer.style.flex='1';nav.appendChild(spacer);
  const back=document.createElement('div');back.className='bsettings-nav-item';back.innerHTML=`<span>‚Üê</span><span>Back to Bastion</span>`;back.onclick=()=>openBastion(curBastion);nav.appendChild(back);
  const del=document.createElement('div');del.className='bsettings-nav-item';del.style.color='var(--red)';del.innerHTML=`<span>üóëÔ∏è</span><span>Delete Bastion</span>`;del.onclick=()=>promptLeaveBastion(curBastion);nav.appendChild(del);
}

function loadBSettingsTab(tab){
  curBSettingsTab=tab;buildBSettingsNav();
  const main=document.getElementById('bsettings-main');const b=CU.bastions[curBastion];
  if(tab==='overview'){
    const tc=b.tagColor||TAG_COLORS[0];
    main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Overview</div>
      <div class="boost-level-bar"><span class="bl-icon">‚ö°</span><div class="bl-info"><div class="bl-name">Boost Level ${b.boostLevel||0}</div><div class="bl-sub">${(b.boostLevel||0)>=3?'Max level!':'Boost to unlock more features'}</div></div><div style="width:120px;"><div class="bl-prog"><div class="bl-fill" style="width:${Math.min(100,(b.boostLevel||0)*33.33)}%;"></div></div></div></div>
      <div class="settings-section"><div class="settings-title">Bastion Name</div><input class="field-input" id="bs-name" value="${escapeHTML(b.name)}" maxlength="32" style="margin-bottom:8px;"></div>
      <div class="settings-section"><div class="settings-title">Description</div><input class="field-input" id="bs-desc" value="${escapeHTML(b.desc||'')}" maxlength="100" style="margin-bottom:8px;" placeholder="Describe your Bastion‚Ä¶"></div>
      <div class="settings-section"><div class="settings-title">Bastion Tag</div><input class="field-input" id="bs-tag" value="${escapeHTML(b.bastionTag||'')}" maxlength="5" style="text-transform:uppercase;margin-bottom:8px;" placeholder="e.g. WAR"><div style="font-size:11px;color:var(--muted);margin-bottom:12px;">Preview: <span id="tag-preview" class="bastion-tag" style="color:${tc};border-color:${tc}44;">${escapeHTML(b.bastionTag||'TAG')}</span></div>
      <div class="settings-title">Tag Color</div><div class="color-swatches">${TAG_COLORS.map(c=>`<div class="color-swatch${c===tc?' sel':''}" style="background:${c};" onclick="selectTagColor('${c}')"></div>`).join('')}</div></div>
      <div class="settings-section"><div class="settings-title">Bastion Emblem</div><div style="display:flex;align-items:center;gap:14px;margin-bottom:8px;"><div id="bs-emblem-prev" style="width:64px;height:64px;border-radius:14px;background:var(--panel2);border:1.5px solid var(--border);font-size:28px;display:flex;align-items:center;justify-content:center;overflow:hidden;">${b.emblem?`<img src="${b.emblem}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`:(b.icon||'üè∞')}</div><label style="cursor:pointer;" class="btn-g">üì∑ Upload<input type="file" accept="image/*" style="display:none;" onchange="handleBastionEmblem(event)"></label>${b.emblem?`<button class="btn-d" onclick="removeBastionEmblem()" style="font-size:12px;padding:7px 12px;">Remove</button>`:''}</div></div>
      <div class="settings-section"><div class="settings-title">Icon Emoji</div><div class="emoji-picker-wrap" id="bs-emoji-picker"></div></div>
      <div style="display:flex;gap:9px;"><button class="btn-a" onclick="saveBastionOverview()">Save Changes</button><button class="btn-g" onclick="openBastion(curBastion)">Cancel</button></div>
      <div id="bs-msg" style="margin-top:10px;font-size:13px;min-height:18px;"></div>`;
    buildEmojiPickerIn('bs-emoji-picker',b.icon||'üè∞');
    document.getElementById('bs-tag').addEventListener('input',e=>{const p=document.getElementById('tag-preview');if(p)p.textContent=e.target.value.toUpperCase()||'TAG';});
  }else if(tab==='roles'){buildRolesTab(main,b);}
  else if(tab==='emojis'){buildEmojisTab(main,b);}
  else if(tab==='channels_manage'){main.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;"><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">Channels</div><button class="btn-a" onclick="addChannel(curBastion)" style="font-size:13px;padding:8px 16px;">+ Add</button></div>${(b.channels||[]).map((ch,ci)=>`<div class="role-item"><span style="color:var(--muted);">#</span><div class="role-name">${escapeHTML(ch.name)}</div><button class="btn-d" style="padding:5px 8px;font-size:12px;" onclick="deleteChannel(curBastion,${ci})">üóëÔ∏è</button></div>`).join('')}`;}
  else if(tab==='members'){buildMembersManageTab(main,b);}
  else if(tab==='bans'){main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">Bans</div><div class="empty-state"><div class="ei">üö´</div><h3>No bans</h3></div>`;}
  else if(tab==='automod'){buildAutoModTab(main,b);}
  else if(tab==='invites'){buildInvitesTab(main,b);}
  else if(tab==='visibility'){buildVisibilityTab(main,b);}
  else{main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:24px;">${tab}</div><div class="empty-state"><div class="ei">üöß</div><h3>Coming Soon</h3></div>`;}
}

function selectTagColor(color){document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('sel'));event.target.classList.add('sel');const p=document.getElementById('tag-preview');if(p){p.style.color=color;p.style.borderColor=color+'44';}CU.bastions[curBastion].tagColor=color;}
async function saveBastionOverview(){const b=CU.bastions[curBastion];b.name=document.getElementById('bs-name').value.trim()||b.name;b.desc=document.getElementById('bs-desc').value.trim();b.bastionTag=document.getElementById('bs-tag').value.trim().toUpperCase().slice(0,5)||'';const sel=document.querySelector('#bs-emoji-picker .emoji-opt.sel');if(sel)b.icon=sel.textContent;await saveUser();buildRailBastions();setSidebar('bastion');const bastionId=getBastionId(curBastion);const gd=await FortizedSocial.getGlobalBastion(bastionId).catch(()=>{})||{};await FortizedSocial.saveGlobalBastion(bastionId,{...gd,...b,id:bastionId,owner:CU.username}).catch(()=>{});const msg=document.getElementById('bs-msg');if(msg)msg.innerHTML='<span style="color:var(--green);">‚úì Saved!</span>';toast('Bastion updated!','success');}
function handleBastionEmblem(e){const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}const r=new FileReader();r.onload=async ev=>{CU.bastions[curBastion].emblem=ev.target.result;await saveUser();buildRailBastions();const p=document.getElementById('bs-emblem-prev');if(p)p.innerHTML=`<img src="${CU.bastions[curBastion].emblem}" style="width:100%;height:100%;object-fit:cover;border-radius:12px;">`;toast('Emblem updated!','success');};r.readAsDataURL(file);}
async function removeBastionEmblem(){CU.bastions[curBastion].emblem=null;await saveUser();buildRailBastions();loadBSettingsTab('overview');}

function buildRolesTab(main,b){
  if(!b.roles)b.roles=[];
  main.innerHTML=`<div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;"><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">Roles</div><button class="btn-a" onclick="createRole()" style="font-size:13px;padding:8px 16px;">+ Create Role</button></div><div id="roles-list"></div>`;
  renderRolesList();
}
function renderRolesList(){const b=CU.bastions[curBastion];const list=document.getElementById('roles-list');if(!list)return;if(!b.roles||!b.roles.length){list.innerHTML=`<div class="empty-state"><div class="ei">üé≠</div><h3>No roles yet</h3></div>`;return;}list.innerHTML=b.roles.map((r,ri)=>`<div class="role-item"><div class="role-dot" style="background:${r.color||'#fff'};"></div><div class="role-name">${escapeHTML(r.name)}</div><button class="btn-g" style="padding:5px 10px;font-size:12px;" onclick="editRole(${ri})">Edit</button><button class="btn-d" style="padding:5px 8px;font-size:12px;" onclick="deleteRole(${ri})">‚úï</button></div>`).join('');}
async function createRole(){const b=CU.bastions[curBastion];if(!b.roles)b.roles=[];const name=prompt('Role name:');if(!name?.trim())return;b.roles.push({id:'r'+Date.now().toString(36),name:name.trim(),color:ROLE_COLORS[b.roles.length%ROLE_COLORS.length],permissions:[...Object.keys(PERM_LABELS).slice(10)]});await saveUser();renderRolesList();toast(`Role "${name}" created!`,'success');}
async function deleteRole(ri){if(!confirm('Delete this role?'))return;CU.bastions[curBastion].roles.splice(ri,1);await saveUser();renderRolesList();toast('Role deleted','info');}
function editRole(ri){
  const b=CU.bastions[curBastion];const role=b.roles[ri];
  document.getElementById('role-editor-body').innerHTML=`<div style="display:flex;align-items:center;gap:12px;margin-bottom:20px;"><div class="role-dot" id="re-dot" style="width:20px;height:20px;background:${role.color};border-radius:50%;"></div><div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Edit: ${escapeHTML(role.name)}</div></div>
    <div class="settings-section"><div class="settings-title">Role Name</div><input class="field-input" id="re-name" value="${escapeHTML(role.name)}" maxlength="32" style="margin-bottom:8px;"></div>
    <div class="settings-section"><div class="settings-title">Color</div><div class="color-swatches">${ROLE_COLORS.map(c=>`<div class="color-swatch${c===role.color?' sel':''}" style="background:${c};" onclick="selectRoleColor('${c}',${ri})"></div>`).join('')}</div></div>
    <div class="settings-section"><div class="settings-title">Permissions</div><div style="max-height:300px;overflow-y:auto;">${ALL_PERMS.map(p=>`<div class="perm-row"><div class="perm-info"><div class="perm-label">${PERM_LABELS[p]||p}</div></div><div class="toggle ${(role.permissions||[]).includes(p)?'on':''}" onclick="togglePerm(this,'${p}',${ri})"></div></div>`).join('')}</div></div>
    <div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-role-editor')">Cancel</button><button class="btn-a" onclick="saveRole(${ri})">Save Role</button></div>`;
  openModal('modal-role-editor');
}
function togglePerm(el,perm,ri){el.classList.toggle('on');const r=CU.bastions[curBastion].roles[ri];if(!r.permissions)r.permissions=[];const i=r.permissions.indexOf(perm);if(i!==-1)r.permissions.splice(i,1);else r.permissions.push(perm);}
function selectRoleColor(color,ri){document.querySelectorAll('#role-editor-body .color-swatch').forEach(s=>s.classList.remove('sel'));event.target.classList.add('sel');CU.bastions[curBastion].roles[ri].color=color;const dot=document.getElementById('re-dot');if(dot)dot.style.background=color;}
async function saveRole(ri){const b=CU.bastions[curBastion];const name=document.getElementById('re-name').value.trim();if(name)b.roles[ri].name=name;await saveUser();closeModal('modal-role-editor');renderRolesList();toast('Role saved!','success');}

function buildEmojisTab(main,b){
  const maxEmojis=(b.boostLevel||0)>=3?35:(b.boostLevel||0)>=1?25:15;
  if(!b.customEmojis)b.customEmojis=[];
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:8px;">Custom Emojis</div><div style="font-size:13px;color:var(--muted-light);margin-bottom:20px;">${b.customEmojis.length}/${maxEmojis} slots ¬∑ Boost Level ${b.boostLevel||0}</div><div style="margin-bottom:14px;"><button class="btn-a" onclick="uploadCustomEmoji()" ${b.customEmojis.length>=maxEmojis?'disabled':''} style="font-size:13px;padding:8px 16px;">+ Upload Emoji</button></div><div class="emoji-upload-grid" id="emoji-grid"></div>`;
  renderEmojiGrid();
}
function renderEmojiGrid(){const b=CU.bastions[curBastion];const grid=document.getElementById('emoji-grid');if(!grid)return;const maxEmojis=(b.boostLevel||0)>=3?35:(b.boostLevel||0)>=1?25:15;let html=(b.customEmojis||[]).map((em,i)=>`<div class="emoji-slot filled" title=":${em.name}:">${em.type==='img'?`<img src="${em.data}" alt="${em.name}">`:`<span style="font-size:22px;">${em.char}</span>`}<div class="es-del" onclick="deleteCustomEmoji(${i})">‚úï</div></div>`).join('');for(let i=(b.customEmojis||[]).length;i<maxEmojis;i++){html+=`<div class="emoji-slot" onclick="uploadCustomEmoji()">+</div>`;}grid.innerHTML=html;}
function uploadCustomEmoji(){const b=CU.bastions[curBastion];const max=(b.boostLevel||0)>=3?35:(b.boostLevel||0)>=1?25:15;if((b.customEmojis||[]).length>=max){toast(`Max ${max} emojis`,'error');return;}const name=prompt('Emoji name:');if(!name?.trim())return;const clean=name.trim().toLowerCase().replace(/[^a-z0-9_]/g,'');if(!clean){toast('Invalid name','error');return;}const inp=document.createElement('input');inp.type='file';inp.accept='image/*';inp.onchange=e=>{const file=e.target.files[0];if(!file)return;if(file.size>256*1024){toast('Max 256KB','error');return;}const r=new FileReader();r.onload=async ev=>{if(!b.customEmojis)b.customEmojis=[];b.customEmojis.push({name:clean,type:'img',data:ev.target.result});await saveUser();renderEmojiGrid();toast(`:${clean}: added!`,'success');};r.readAsDataURL(file);};inp.click();}
async function deleteCustomEmoji(i){if(!confirm('Delete this emoji?'))return;CU.bastions[curBastion].customEmojis.splice(i,1);await saveUser();renderEmojiGrid();toast('Emoji removed','info');}

async function buildMembersManageTab(main,b){
  const bastionId=getBastionId(curBastion);main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:18px;">Members</div><div id="mm-list"><div style="padding:20px;text-align:center;color:var(--muted);">Loading‚Ä¶</div></div>`;
  let members=await FortizedSocial.getBastionMembers(bastionId).catch(()=>[]);
  if(!members.includes(CU.username))members.push(CU.username);
  const list=document.getElementById('mm-list');if(!list)return;
  list.innerHTML=members.map(m=>`<div style="display:flex;align-items:center;gap:12px;padding:12px 14px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;"><div style="width:38px;height:38px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;">${m[0].toUpperCase()}</div><div style="flex:1;"><div style="font-size:13.5px;font-weight:700;">${escapeHTML(m)}${m===b.owner?' üëë':''}${m===CU.username?' <span style="font-size:10px;color:var(--muted);">(you)</span>':''}</div></div>${m!==b.owner&&m!==CU.username?`<button class="btn-d" style="font-size:11.5px;padding:5px 8px;" onclick="kickMember('${m}')">Kick</button>`:''}</div>`).join('');
}
async function kickMember(username){if(!confirm(`Kick ${username}?`))return;const bastionId=getBastionId(curBastion);await FortizedSocial.removeBastionMember(bastionId,username).catch(()=>{});await buildMembersManageTab(document.getElementById('bsettings-main'),CU.bastions[curBastion]);toast(`${username} kicked`,'info');}

function buildAutoModTab(main,b){
  if(!b.automod)b.automod={blockLinks:false,blockSpam:true,blockSlurs:false,maxMentions:10,customKeywords:[]};const am=b.automod;
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">AutoMod</div>
    <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üîó</span><div class="amr-title">Block Links</div><div class="amr-enabled"><span>Enabled</span><div class="toggle ${am.blockLinks?'on':''}" onclick="toggleAutomod('blockLinks')"></div></div></div><div class="amr-desc">Prevent members from posting URLs.</div></div>
    <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üì¢</span><div class="amr-title">Anti-Spam</div><div class="amr-enabled"><span>Enabled</span><div class="toggle ${am.blockSpam?'on':''}" onclick="toggleAutomod('blockSpam')"></div></div></div><div class="amr-desc">Delete repeated/caps messages.</div></div>
    <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üì£</span><div class="amr-title">Mention Limit: <strong>${am.maxMentions}</strong></div></div><input type="range" min="1" max="25" value="${am.maxMentions}" style="width:100%;margin-top:8px;accent-color:var(--accent);" oninput="setAutomodMentions(this.value)"></div>
    <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üö´</span><div class="amr-title">Blocked Words</div></div>
      <div class="amr-keywords" id="amr-kws">${(am.customKeywords||[]).map((kw,i)=>`<div class="amr-kw">${escapeHTML(kw)}<button onclick="removeAutomodKw(${i})">‚úï</button></div>`).join('')}</div>
      <div style="display:flex;gap:8px;margin-top:10px;"><input class="field-input" id="amr-kw-input" placeholder="Add word‚Ä¶" style="flex:1;" onkeydown="if(event.key==='Enter')addAutomodKw()"><button class="btn-a" style="padding:8px 14px;font-size:12.5px;" onclick="addAutomodKw()">Add</button></div>
    </div>
    <button class="btn-a" onclick="saveAutomod()" style="margin-top:8px;">Save AutoMod Settings</button>`;
}
async function toggleAutomod(key){const b=CU.bastions[curBastion];if(!b.automod)b.automod={};b.automod[key]=!b.automod[key];await saveUser();buildAutoModTab(document.getElementById('bsettings-main'),b);}
function setAutomodMentions(v){if(CU.bastions[curBastion].automod)CU.bastions[curBastion].automod.maxMentions=parseInt(v);}
async function addAutomodKw(){const b=CU.bastions[curBastion];if(!b.automod)b.automod={customKeywords:[]};if(!b.automod.customKeywords)b.automod.customKeywords=[];const inp=document.getElementById('amr-kw-input');const kw=inp?.value.trim().toLowerCase();if(!kw)return;b.automod.customKeywords.push(kw);await saveUser();if(inp)inp.value='';buildAutoModTab(document.getElementById('bsettings-main'),b);}
async function removeAutomodKw(i){CU.bastions[curBastion].automod.customKeywords.splice(i,1);await saveUser();buildAutoModTab(document.getElementById('bsettings-main'),CU.bastions[curBastion]);}
async function saveAutomod(){await saveUser();toast('AutoMod saved!','success');}

function buildInvitesTab(main,b){
  if(!b.invites)b.invites=[];
  const active=b.invites.filter(inv=>!inv.expires||new Date(inv.expires)>new Date());
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:6px;">Invites</div><div style="font-size:13px;color:var(--muted-light);margin-bottom:22px;">Share your Bastion via invite links.</div><button class="btn-a" onclick="createInviteLink()" style="margin-bottom:20px;">+ Create Invite Link</button>
    ${active.length?active.map((inv,i)=>`<div style="padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;"><div class="invite-link-box"><span>${getInviteLink(inv.code)}</span><button class="btn-g" style="padding:5px 10px;font-size:12px;" onclick="copyInvite('${inv.code}')">üìã Copy</button></div><div style="display:flex;gap:12px;font-size:12px;color:var(--muted);"><span>Uses: <strong>${inv.uses||0}</strong></span><span>${inv.expires?'Expires: '+new Date(inv.expires).toLocaleDateString():'Never expires'}</span></div><button class="btn-d" onclick="deleteInvite(${i})" style="font-size:11.5px;padding:5px 10px;margin-top:8px;">Revoke</button></div>`).join('')
    :`<div class="empty-state" style="padding:30px;"><div class="ei">üîó</div><h3>No active invites</h3></div>`}`;
}
function getInviteLink(code){return`${location.origin}${location.pathname}?invite=${code}`;}
async function createInviteLink(){const b=CU.bastions[curBastion];if(!b.invites)b.invites=[];const code=Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);const expiresIn=prompt('Expire in days (leave empty for never):');let expires=null;if(expiresIn&&!isNaN(parseInt(expiresIn))){const d=new Date();d.setDate(d.getDate()+parseInt(expiresIn));expires=d.toISOString();}b.invites.push({code,uses:0,expires,createdAt:new Date().toISOString()});await saveUser();const bastionId=getBastionId(curBastion);await FortizedSocial.saveInvite(code,{bastionId,expires,uses:0}).catch(()=>{});buildInvitesTab(document.getElementById('bsettings-main'),b);copyInvite(code);toast('Invite created & copied! üîó','success');}
function copyInvite(code){navigator.clipboard?.writeText(getInviteLink(code)).then(()=>toast('Link copied! üîó','success'));}
async function deleteInvite(i){CU.bastions[curBastion].invites.splice(i,1);await saveUser();buildInvitesTab(document.getElementById('bsettings-main'),CU.bastions[curBastion]);toast('Invite revoked','info');}

function buildVisibilityTab(main,b){
  const isPublic=b.isPublic||false;
  main.innerHTML=`<div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">Visibility</div>
    <div class="vis-toggle"><div class="vis-opt ${isPublic?'active':''}" onclick="setVisOpt(true,this.parentElement)"><div class="vo-icon">üåç</div><div class="vo-label">Public</div><div class="vo-desc">Anyone can discover & join</div></div><div class="vis-opt ${!isPublic?'active':''}" onclick="setVisOpt(false,this.parentElement)"><div class="vo-icon">üîí</div><div class="vo-label">Private</div><div class="vo-desc">Invite link required</div></div></div>
    <button class="btn-a" onclick="saveVisibility()" style="margin-top:12px;">Save</button>`;
}
function setVisOpt(isPublic,container){container.querySelectorAll('.vis-opt').forEach((el,i)=>el.classList.toggle('active',isPublic?i===0:i===1));}
async function saveVisibility(){const b=CU.bastions[curBastion];const isPublic=document.querySelector('.vis-toggle .vis-opt:first-child')?.classList.contains('active')||false;b.isPublic=isPublic;await saveUser();const bastionId=getBastionId(curBastion);const gd=await FortizedSocial.getGlobalBastion(bastionId).catch(()=>{})||{};await FortizedSocial.saveGlobalBastion(bastionId,{...gd,...b,id:bastionId,isPublic,owner:CU.username}).catch(()=>{});toast(isPublic?'Bastion is now Public!':'Bastion is now Private.','success');}

async function openBastionBoost(){const b=CU.bastions[curBastion];const level=b.boostLevel||0;if(level>=3){toast('Max level!','info');return;}const cost=[500,1000,2000][level];if(!confirm(`Boost to Level ${level+1}? Costs ${cost} Onyx.\nYou have ${CU.onyx} Onyx.`))return;if(CU.onyx<cost){toast('Not enough Onyx!','error');return;}CU.onyx-=cost;b.boostLevel=(b.boostLevel||0)+1;await saveUser();updateOnyxDisplay();buildRailBastions();toast(`‚ö° ${b.name} is now Level ${b.boostLevel}!`,'success');FortizedSocial.playNotificationSound();setSidebar('bastion');}

// ‚ïê‚ïê‚ïê CREATE BASTION ‚ïê‚ïê‚ïê
function buildEmojiPicker(){const p=document.getElementById('bastion-emoji-picker');if(!p)return;p.innerHTML='';EMOJIS.forEach(e=>{const btn=document.createElement('div');btn.className='emoji-opt';btn.textContent=e;btn.onclick=()=>{p.querySelectorAll('.emoji-opt').forEach(d=>d.classList.remove('sel'));btn.classList.add('sel');p.dataset.selected=e;};p.appendChild(btn);});p.dataset.selected=EMOJIS[0];if(p.firstChild)p.firstChild.classList.add('sel');}
function buildEmojiPickerIn(cId,sel){const p=document.getElementById(cId);if(!p)return;p.innerHTML='';EMOJIS.forEach(e=>{const btn=document.createElement('div');btn.className='emoji-opt'+(e===sel?' sel':'');btn.textContent=e;btn.onclick=()=>{p.querySelectorAll('.emoji-opt').forEach(d=>d.classList.remove('sel'));btn.classList.add('sel');};p.appendChild(btn);});}
function buildColorPicker(){const p=document.getElementById('bastion-color-picker');if(!p)return;p.innerHTML='';TAG_COLORS.forEach((c,i)=>{const s=document.createElement('div');s.className='color-swatch'+(i===0?' sel':'');s.style.background=c;s.onclick=()=>{p.querySelectorAll('.color-swatch').forEach(d=>d.classList.remove('sel'));s.classList.add('sel');p.dataset.selected=c;};p.appendChild(s);});p.dataset.selected=TAG_COLORS[0];}
function handleEmblemUpload(e,previewId){const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}const r=new FileReader();r.onload=ev=>{_pendingEmblemData=ev.target.result;const prev=document.getElementById(previewId);if(prev)prev.innerHTML=`<img src="${ev.target.result}" style="width:48px;height:48px;object-fit:cover;border-radius:10px;">`;};r.readAsDataURL(file);}

function openCreateBastion(){document.getElementById('bastion-name-input').value='';document.getElementById('bastion-desc-input').value='';document.getElementById('bastion-tag-input').value='';document.getElementById('create-error').textContent='';_pendingEmblemData=null;buildEmojiPicker();buildColorPicker();openModal('modal-create-bastion');}

async function createBastion(){
  const name=document.getElementById('bastion-name-input').value.trim();const desc=document.getElementById('bastion-desc-input').value.trim();const rawTag=document.getElementById('bastion-tag-input').value.trim().toUpperCase().slice(0,5);const icon=document.getElementById('bastion-emoji-picker').dataset.selected||'üè∞';const tagColor=document.getElementById('bastion-color-picker').dataset.selected||TAG_COLORS[0];
  if(!name){document.getElementById('create-error').textContent='Name is required.';return;}
  const nb={name,desc,icon,bastionTag:rawTag,tagColor,emblem:_pendingEmblemData||null,channels:[{name:'general',id:'general'},{name:'announcements',id:'announcements'},{name:'off-topic',id:'off-topic'}],members:[CU.username],owner:CU.username,createdAt:new Date().toISOString(),roles:[],memberRoles:{},customEmojis:[],boostLevel:0};
  CU.bastions.push(nb);await saveUser();closeModal('modal-create-bastion');buildRailBastions();
  const ni=CU.bastions.length-1;const bastionId=getBastionId(ni);
  await FortizedSocial.saveGlobalBastion(bastionId,{...nb,id:bastionId,owner:CU.username,isPublic:false}).catch(()=>{});
  await FortizedSocial.addBastionMember(bastionId,CU.username).catch(()=>{});
  _pendingEmblemData=null;toast(`${icon} ${name} created!`,'success');await openBastion(ni);
}

// ‚ïê‚ïê‚ïê DISCOVER ‚ïê‚ïê‚ïê
async function buildDiscoverGrid(){
  const grid=document.getElementById('bastion-grid');if(!grid)return;
  grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">Loading bastions‚Ä¶</div>`;
  try{const global=await FortizedSocial.getGlobalBastions();const list=Object.entries(global).filter(([,b])=>b.isPublic).map(([id,b])=>({...b,id}));window._discoverList=list;renderDiscGrid(list);}
  catch(e){grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">Failed to load. Check your connection.</div>`;}
}
function setDiscTab(tab,el){discTab=tab;document.querySelectorAll('.disc-tab').forEach(t=>t.classList.remove('active'));el.classList.add('active');filterBastions();}
function filterBastions(){const q=document.getElementById('disc-input')?.value.toLowerCase()||'';let list=window._discoverList||[];if(discTab!=='all')list=list.filter(b=>b.category===discTab);if(q)list=list.filter(b=>b.name.toLowerCase().includes(q)||(b.desc||'').toLowerCase().includes(q));renderDiscGrid(list);}
function renderDiscGrid(list){
  const grid=document.getElementById('bastion-grid');if(!grid)return;
  if(!list.length){grid.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:60px 40px;color:var(--muted);"><div style="font-size:48px;margin-bottom:12px;opacity:.3;">üè∞</div><div style="font-size:16px;font-weight:700;color:var(--muted-light);">No Public Bastions Yet</div><div style="font-size:13px;margin-top:4px;">Create a Bastion and set it to <strong style="color:var(--accent);">Public</strong> in Bastion Settings to appear here!</div></div>`;return;}
  grid.innerHTML=list.map(b=>{const aj=CU.bastions&&CU.bastions.find(x=>x.globalId===b.id||x.name===b.name);const ajIdx=aj?CU.bastions.indexOf(aj):-1;return`<div class="bc"><div class="bc-banner">${b.emblem?`<img src="${b.emblem}">`:(b.icon||'üè∞')}</div><div class="bc-body"><div class="bc-meta"><div class="bc-icon">${b.emblem?`<img src="${b.emblem}">`:(b.icon||'üè∞')}</div><div><div class="bc-name">${escapeHTML(b.name)}</div></div></div><div class="bc-desc">${escapeHTML(b.desc||'')}</div><button class="btn-a" style="width:100%;justify-content:center;margin-top:10px;font-size:12.5px;padding:9px;${aj?'background:var(--panel2);color:var(--muted-light);':''}" onclick="${aj?`openBastion(${ajIdx})`:`promptJoinPublicBastion('${b.id}')`}">${aj?'‚úì Open':'‚öîÔ∏è Join'}</button></div></div>`;}).join('');
}

async function promptJoinPublicBastion(bastionId){
  let b=null;try{b=await FortizedSocial.getGlobalBastion(bastionId);}catch(e){}if(!b){toast('Bastion not found','error');return;}
  const aj=CU.bastions&&CU.bastions.find(x=>x.globalId===bastionId||x.name===b.name);if(aj){toast('Already joined!','info');openBastion(CU.bastions.indexOf(aj));return;}
  let mc=1;try{mc=(await FortizedSocial.getBastionMembers(bastionId)).length||1;}catch(e){}
  document.getElementById('join-bastion-body').innerHTML=`<div style="text-align:center;padding:6px 0 10px;"><div style="font-size:48px;margin-bottom:10px;">${b.icon||'üè∞'}</div><div class="modal-title">${escapeHTML(b.name)}</div><div class="modal-sub">${escapeHTML(b.desc||'A Fortized community')}</div><div style="font-family:'Syne',sans-serif;font-size:24px;font-weight:800;color:var(--accent);">${mc}</div><div style="font-size:12px;color:var(--muted);margin-bottom:20px;">Members</div></div><div class="modal-actions"><button class="btn-g" onclick="closeModal('modal-join-bastion')">Cancel</button><button class="btn-a" onclick="joinPublicBastion('${bastionId}')">‚öîÔ∏è Join Bastion</button></div>`;
  openModal('modal-join-bastion');
}

async function joinPublicBastion(bastionId){
  let b=null;try{b=await FortizedSocial.getGlobalBastion(bastionId);}catch(e){}if(!b)return;
  const aj=CU.bastions&&CU.bastions.find(x=>x.globalId===bastionId||x.name===b.name);if(aj){closeModal('modal-join-bastion');toast('Already joined!','info');return;}
  const nb={globalId:bastionId,name:b.name,desc:b.desc,icon:b.icon||'üè∞',emblem:b.emblem||null,bastionTag:b.bastionTag||'',tagColor:b.tagColor||TAG_COLORS[0],channels:b.channels||[{name:'general',id:'general'},{name:'announcements',id:'announcements'}],members:[CU.username],owner:b.owner||null,joinedAt:new Date().toISOString(),roles:b.roles||[],memberRoles:b.memberRoles||{},customEmojis:b.customEmojis||[],boostLevel:b.boostLevel||0};
  CU.bastions.push(nb);await saveUser();await FortizedSocial.addBastionMember(bastionId,CU.username).catch(()=>{});closeModal('modal-join-bastion');buildRailBastions();toast(`Joined ${b.name}!`,'success');FortizedSocial.playNotificationSound();await openBastion(CU.bastions.length-1);
}

// ‚ïê‚ïê‚ïê ATELIER ‚ïê‚ïê‚ïê
function updateDailyBtn(){const btn=document.getElementById('daily-btn');const st=document.getElementById('daily-status');if(!btn||!st)return;const today=new Date().toDateString();if(CU.lastDaily===today){btn.classList.add('claimed');st.textContent='Claimed ‚úì';}else{btn.classList.remove('claimed');st.textContent='Claim now ‚Üí';}}
async function claimDaily(){const today=new Date().toDateString();if(CU.lastDaily===today){toast('Already claimed!','info');return;}CU.onyx+=5;CU.lastDaily=today;await saveUser();updateOnyxDisplay();updateDailyBtn();toast('+5 Onyx claimed! üíé','success');FortizedSocial.playNotificationSound();}
function buyRadiance(cost,label){pendingBuy={cost,label};document.getElementById('buy-title').textContent=`Activate Radiance ‚Äî ${label}?`;document.getElementById('buy-sub').textContent=`Cost: ${cost} Onyx. You have ${CU.onyx}.`;openModal('modal-buy');}
async function confirmBuy(){
  if(!pendingBuy)return;const{cost,label}=pendingBuy;
  if(CU.onyx<cost){closeModal('modal-buy');toast(`Not enough Onyx! Need ${cost}, have ${CU.onyx}.`,'error');return;}
  CU.onyx-=cost;const days={'1 Day':1,'7 Days':7,'30 Days':30}[label]||1;const until=new Date(Date.now()+days*86400000).toISOString();CU.radianceUntil=until;
  await saveUser();closeModal('modal-buy');updateOnyxDisplay();toast(`‚ú® Radiance activated for ${label}!`,'success');FortizedSocial.playNotificationSound();pendingBuy=null;
}

// ‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê
function buildProfileView(tab){
  const nav=document.getElementById('profile-nav');const main=document.getElementById('profile-main');nav.innerHTML='';
  const items=[['myprofile','üë§','My Profile'],['account','üîê','Account'],['appearance','üé®','Appearance'],['privacy','üõ°Ô∏è','Privacy'],['notifs_settings','üîî','Notifications']];
  items.forEach(([t,i,l])=>{const el=document.createElement('div');el.className='profile-nav-item'+(tab===t?' active':'');el.innerHTML=`<span>${i}</span><span>${l}</span>`;el.onclick=()=>buildProfileView(t);nav.appendChild(el);});
  const spacer=document.createElement('div');spacer.style.flex='1';nav.appendChild(spacer);
  const out=document.createElement('div');out.className='profile-nav-item';out.style.color='var(--red)';out.innerHTML=`<span>üö™</span><span>Log Out</span>`;out.onclick=doLogout;nav.appendChild(out);

  if(tab==='myprofile'){
    const hasRadiance=CU.radianceUntil&&new Date(CU.radianceUntil)>new Date();
    main.innerHTML=`<div class="profile-banner-area" id="banner-area">${CU.banner?`<img src="${CU.banner}">`:''}${hasRadiance?`<label style="position:absolute;bottom:8px;right:8px;cursor:pointer;" class="btn-g">üñº Change Banner<input type="file" accept="image/*" style="display:none;" onchange="updateBanner(event)"></label>`:''}</div>
      <div class="profile-av-row">
        <label style="cursor:pointer;"><div class="profile-av-big" id="pav-big">${CU.pfp?`<img src="${CU.pfp}">`:(CU.displayName||CU.username)[0].toUpperCase()}</div><input type="file" accept="image/*" style="display:none;" onchange="updatePfp(event)"></label>
        <div>${hasRadiance?`<div class="radiance-badge">‚ú® Radiance Active</div>`:''}</div>
      </div>
      <div class="profile-content">
        <div class="profile-display-name">${escapeHTML(CU.displayName||CU.username)}</div>
        <div class="profile-username">@${escapeHTML(CU.username)}</div>
        <div class="profile-stats-row" style="margin-top:14px;">
          <div class="ps-stat"><div class="ps-val">${(CU.bastions||[]).length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.friends||[]).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.onyx}</div><div class="ps-key">Onyx</div></div>
        </div>
        <div class="settings-section"><div class="settings-title">Display Name</div>
          <input class="field-input" id="dn-input" value="${escapeHTML(CU.displayName||CU.username)}" style="margin-bottom:8px;" maxlength="32">
          <button class="btn-a" onclick="saveDisplayName()" style="font-size:13px;padding:8px 16px;">Save Name</button>
        </div>
        <div class="settings-section"><div class="settings-title">Status</div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            ${[['online','üü¢','Online'],['away','üü°','Away'],['dnd','üî¥','Do Not Disturb'],['invisible','‚ö´','Invisible']].map(([s,i,l])=>`<button onclick="setMyStatus('${s}')" style="display:flex;align-items:center;gap:5px;background:${CU.status===s?'var(--accent-dim)':'transparent'};border:1px solid ${CU.status===s?'var(--accent-mid)':'var(--border)'};color:${CU.status===s?'var(--accent)':'var(--muted-light)'};padding:7px 14px;border-radius:10px;font-size:12.5px;cursor:pointer;">${i} ${l}</button>`).join('')}
          </div>
        </div>
      </div>`;
  }else if(tab==='account'){
    main.innerHTML=`<div style="padding:24px;"><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">Account</div>
      <div class="settings-section"><div class="settings-title">Username</div><input class="field-input" value="${escapeHTML(CU.username)}" disabled style="opacity:.6;margin-bottom:4px;"><div style="font-size:11.5px;color:var(--muted);">Username cannot be changed.</div></div>
      <div class="settings-section"><div class="settings-title">Email</div><input class="field-input" id="email-input" value="${escapeHTML(CU.email||'')}" placeholder="your@email.com" style="margin-bottom:8px;"><button class="btn-a" onclick="saveEmail()" style="font-size:13px;padding:8px 16px;">Update Email</button></div>
      <div class="settings-section"><div class="settings-title">Change Password</div><input class="field-input" id="pw-old" type="password" placeholder="Current password" style="margin-bottom:8px;"><input class="field-input" id="pw-new" type="password" placeholder="New password (min 6 chars)" style="margin-bottom:8px;"><button class="btn-a" onclick="changePassword()" style="font-size:13px;padding:8px 16px;">Update Password</button><div id="pw-msg" style="margin-top:8px;font-size:12.5px;min-height:16px;"></div></div>
      <div class="settings-section"><div class="settings-title" style="color:var(--red);">Danger Zone</div><button class="btn-d" onclick="if(confirm('Delete account? This cannot be undone!'))doLogout()">Delete Account</button></div>
    </div>`;
  }else{
    main.innerHTML=`<div style="padding:24px;"><div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:22px;">${tab.charAt(0).toUpperCase()+tab.slice(1)}</div><div class="empty-state"><div class="ei">üöß</div><h3>Coming Soon</h3><p>These settings are on the way!</p></div></div>`;
  }
}

async function saveDisplayName(){const dn=document.getElementById('dn-input').value.trim();if(!dn){toast('Name required','error');return;}CU.displayName=dn;await saveUser();document.getElementById('ua-name').textContent=dn;updateAvatarEl(document.getElementById('ua'),CU);buildProfileView('myprofile');toast('Display name updated!','success');}
async function saveEmail(){const e=document.getElementById('email-input').value.trim();CU.email=e;await saveUser();toast('Email updated!','success');}
async function changePassword(){const old=document.getElementById('pw-old').value;const nw=document.getElementById('pw-new').value;const msg=document.getElementById('pw-msg');if(!old||!nw){if(msg)msg.style.color='var(--red)';if(msg)msg.textContent='Fill in both fields.';return;}if(old!==CU.password){if(msg)msg.style.color='var(--red)';if(msg)msg.textContent='Current password incorrect.';return;}if(nw.length<6){if(msg)msg.style.color='var(--red)';if(msg)msg.textContent='New password too short.';return;}CU.password=nw;await saveUser();if(msg)msg.style.color='var(--green)';if(msg)msg.textContent='Password updated!';document.getElementById('pw-old').value='';document.getElementById('pw-new').value='';}
async function updatePfp(e){const file=e.target.files[0];if(!file)return;if(file.size>2*1024*1024){toast('Max 2MB','error');return;}const r=new FileReader();r.onload=async ev=>{CU.pfp=ev.target.result;await saveUser();updateAvatarEl(document.getElementById('ua'),CU);buildProfileView('myprofile');toast('Avatar updated!','success');};r.readAsDataURL(file);}
async function updateBanner(e){const file=e.target.files[0];if(!file)return;if(file.size>3*1024*1024){toast('Max 3MB','error');return;}const r=new FileReader();r.onload=async ev=>{CU.banner=ev.target.result;await saveUser();buildProfileView('myprofile');toast('Banner updated!','success');};r.readAsDataURL(file);}
async function setMyStatus(s){CU.status=s;await FortizedSocial.setStatus(CU.username,s);await saveUser();buildProfileView('myprofile');toast(`Status: ${s}`,'info');}

// ‚ïê‚ïê‚ïê USER PROFILE POPUP ‚ïê‚ïê‚ïê
async function viewUserProfile(username){
  let u=null;try{u=await FortizedSocial.getUserByName(username);}catch(e){}
  if(!u){toast('User not found','error');return;}
  let status='offline';try{status=await FortizedSocial.getStatus(username);}catch(e){}
  const isFriend=(CU.friends||[]).includes(username);const hasPendingReq=(CU.friendRequestsSent||[]).includes(username);const isOwn=username===CU.username;
  const statusColor={online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)',offline:'var(--muted)',invisible:'var(--muted)'}[status]||'var(--muted)';
  document.getElementById('user-modal-body').innerHTML=`
    <div style="text-align:center;padding:8px 0 16px;">
      <div style="width:72px;height:72px;border-radius:50%;background:var(--panel2);border:2px solid var(--border);font-size:28px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;overflow:hidden;">${u.pfp?`<img src="${u.pfp}" style="width:100%;height:100%;object-fit:cover;border-radius:50%;">`:(u.displayName||u.username||'?')[0].toUpperCase()}</div>
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">${escapeHTML(u.displayName||u.username)}</div>
      <div style="font-size:13px;color:var(--muted-light);">@${escapeHTML(u.username)}</div>
      <div style="font-size:12px;color:${statusColor};margin-top:4px;">‚óè ${status}</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button class="btn-a" onclick="closeModal('modal-user');openDMChat('${escapeHTML(u.username)}')" style="flex:1;justify-content:center;font-size:13px;">üí¨ Message</button>
      ${isOwn?'':(isFriend?`<button class="btn-d" onclick="closeModal('modal-user');removeFriend('${u.username}')" style="flex:1;justify-content:center;font-size:13px;">Remove Friend</button>`:(hasPendingReq?`<button class="btn-g" style="flex:1;justify-content:center;font-size:13px;opacity:.7;" disabled>Request Sent</button>`:`<button class="btn-g" onclick="closeModal('modal-user');quickAddFriend('${escapeHTML(u.username)}')" style="flex:1;justify-content:center;font-size:13px;">+ Add Friend</button>`))}
    </div>
    <button class="btn-g" onclick="closeModal('modal-user')" style="width:100%;justify-content:center;margin-top:8px;font-size:13px;">Close</button>`;
  openModal('modal-user');
}

async function quickAddFriend(username){try{const r=await FortizedSocial.sendFriendRequest(CU.username,username);toast(r.msg,r.ok?'success':'error');if(r.ok){await refreshCU();FortizedSocial.playNotificationSound();}}catch(e){toast('Error','error');}viewUserProfile(username);}

// ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
async function toggleNotifPanel(){
  notifPanelOpen=!notifPanelOpen;
  const panel=document.getElementById('notif-panel');panel.classList.toggle('open',notifPanelOpen);
  if(notifPanelOpen){await buildNotifList();try{await FortizedSocial.markNotificationsRead(CU.username);await updateNotifBadge();}catch(e){}}
}

async function buildNotifList(){
  const list=document.getElementById('np-list');if(!list)return;
  let notifs=[];try{notifs=await FortizedSocial.getNotifications(CU.username);}catch(e){}
  if(!notifs.length){list.innerHTML=`<div class="np-empty">‚úì All caught up!</div>`;return;}
  list.innerHTML=notifs.slice(0,20).map(n=>{
    let icon='üîî',text='';
    if(n.type==='friend_request'){icon='üë•';text=`<strong>${escapeHTML(n.from)}</strong> sent you a friend request`;}
    else if(n.type==='friend_accept'){icon='ü§ù';text=`<strong>${escapeHTML(n.from)}</strong> accepted your request`;}
    else if(n.type==='dm'){icon='üí¨';text=`<strong>${escapeHTML(n.from)}</strong>: ${escapeHTML((n.data?.preview||'').slice(0,50))}`;}
    const actions=n.type==='friend_request'?`<div class="np-actions"><button class="np-accept" onclick="acceptFriend('${n.from}');buildNotifList()">Accept</button><button class="np-decline" onclick="declineFriend('${n.from}');buildNotifList()">Decline</button></div>`:'';
    return`<div class="np-item ${n.read?'':'unread'}"><div class="np-icon">${icon}</div><div class="np-text"><p>${text}</p><div class="np-time">${formatTimeAgo(n.time)}</div>${actions}</div></div>`;
  }).join('');
}

async function markAllRead(){try{await FortizedSocial.markNotificationsRead(CU.username);await updateNotifBadge();await buildNotifList();}catch(e){}}

// ‚ïê‚ïê‚ïê INVITE LINK ‚ïê‚ïê‚ïê
async function checkInviteLink(){
  const params=new URLSearchParams(location.search);const code=params.get('invite');if(!code)return;
  history.replaceState({},document.title,location.pathname);
  let inv=null;try{inv=await FortizedSocial.getInvite(code);}catch(e){}
  if(!inv){toast('Invalid or expired invite link','error');return;}
  let b=null;try{b=await FortizedSocial.getGlobalBastion(inv.bastionId);}catch(e){}
  if(!b){toast('Bastion not found','error');return;}
  const aj=CU.bastions&&CU.bastions.find(x=>x.globalId===inv.bastionId||x.name===b.name);
  if(aj){toast(`Already in ${b.name}!`,'info');setTimeout(()=>openBastion(CU.bastions.indexOf(aj)),500);return;}
  await promptJoinPublicBastion(inv.bastionId);
  try{await FortizedSocial.incrementInviteUses(code);}catch(e){}
}

// ‚ïê‚ïê‚ïê LOGOUT ‚ïê‚ïê‚ïê
async function doLogout(){
  try{await FortizedSocial.logout(CU.username);}catch(e){}
  localStorage.removeItem('ftz_current');localStorage.removeItem('fortized_current_user');
  window.location.href='login.html';
}

// ‚ïê‚ïê‚ïê CONTEXT MENU ‚ïê‚ïê‚ïê
function showCtxMenu(x,y,items){
  const menu=document.getElementById('ctx-menu');menu.style.display='block';menu.style.left=x+'px';menu.style.top=y+'px';menu.innerHTML='';
  items.forEach(item=>{
    if(item.sep){const sep=document.createElement('div');sep.className='ctx-sep';menu.appendChild(sep);}
    else if(item.section){const lbl=document.createElement('div');lbl.className='ctx-section-label';lbl.textContent=item.label;menu.appendChild(lbl);}
    else{const el=document.createElement('div');el.className='ctx-item'+(item.danger?' danger':'');el.innerHTML=`<span>${item.icon||''}</span><span>${item.label}</span>`;if(item.action)el.onclick=()=>{item.action();menu.style.display='none';};menu.appendChild(el);}
  });
  setTimeout(()=>{const r=menu.getBoundingClientRect();if(r.right>window.innerWidth)menu.style.left=(x-r.width)+'px';if(r.bottom>window.innerHeight)menu.style.top=(y-r.height)+'px';},0);
}

// ‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê
function openModal(id){const el=document.getElementById(id);if(el){el.classList.add('open');}}
function closeModal(id){const el=document.getElementById(id);if(el){el.classList.remove('open');}}

// ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê
let toastTimer=null;
function toast(msg,type='info'){
  const t=document.getElementById('toast');t.textContent=msg;t.className='toast '+type;t.classList.add('show');
  if(toastTimer)clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),3200);
}

// ‚ïê‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê
function escapeHTML(str){if(!str)return'';return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function parseMD(text){return text.replace(/`([^`]+)`/g,'<code>$1</code>').replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>').replace(/\*([^*]+)\*/g,'<em>$1</em>');}
function scrollBottom(id){const el=document.getElementById(id);if(el)setTimeout(()=>{el.scrollTop=el.scrollHeight;},10);}
function autoResize(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function formatTimeAgo(ts){if(!ts)return'';const diff=Date.now()-new Date(ts).getTime();const m=Math.floor(diff/60000);if(m<1)return'just now';if(m<60)return m+'m ago';const h=Math.floor(m/60);if(h<24)return h+'h ago';return Math.floor(h/24)+'d ago';}
</script>
</body>
</html>
