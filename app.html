<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fortized</title>
<link rel="icon" type="image/png" href="Fortized icon.png">
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="FortizedSocial-firebase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@600;700;800&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
<style>
/* === BASE === */
:root{--accent:#fff93e;--accent-dim:rgba(255,249,62,.1);--accent-mid:rgba(255,249,62,.22);--bg:#07090e;--rail:#04060a;--sidebar:#0b0e15;--channel:#0d1018;--panel:#101420;--panel2:#131822;--panel3:#161c28;--border:#1c2335;--muted:#4e5a6f;--muted-light:#7d8a9e;--text:#dde3ed;--green:#3ecf6e;--red:#f87171;--yellow:#f59e0b;--blue:#60a5fa;}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;display:flex;user-select:none;}
::selection{background:rgba(255,249,62,.2);}
::-webkit-scrollbar{width:4px;}::-webkit-scrollbar-thumb{background:#1e2840;border-radius:4px;}
/* RAIL */
.rail{width:68px;min-width:68px;background:var(--rail);border-right:1px solid var(--border);display:flex;flex-direction:column;align-items:center;padding:12px 0;gap:4px;z-index:10;}
.rail-logo{width:40px;height:40px;cursor:pointer;display:flex;align-items:center;justify-content:center;margin-bottom:6px;}
.rail-logo img{width:34px;height:34px;object-fit:contain;filter:drop-shadow(0 0 8px rgba(255,249,62,.3));}
.rail-sep{width:30px;height:1px;background:var(--border);margin:5px 0;opacity:.4;}
.rail-btn{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .15s;position:relative;flex-shrink:0;font-size:18px;}
.rail-btn:hover{background:rgba(255,255,255,.07);}
.rail-btn.active{background:var(--accent-dim);}
.rail-btn.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-btn[data-tip]:hover::after{content:attr(data-tip);position:absolute;left:calc(100% + 10px);top:50%;transform:translateY(-50%);background:#0c1020;border:1px solid var(--border);color:var(--text);font-size:12px;font-weight:600;padding:5px 10px;border-radius:9px;white-space:nowrap;z-index:999;pointer-events:none;}
.rail-bastion{width:42px;height:42px;border-radius:14px;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:17px;transition:all .15s;position:relative;overflow:hidden;flex-shrink:0;}
.rail-bastion:hover,.rail-bastion.active{border-color:var(--accent);border-radius:12px;background:var(--accent-dim);}
.rail-bastion.active::before{content:"";position:absolute;left:-12px;top:50%;transform:translateY(-50%);width:3px;height:22px;background:var(--accent);border-radius:0 4px 4px 0;}
.rail-bastion img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.rail-notif-badge{position:absolute;top:2px;right:2px;min-width:16px;height:16px;border-radius:8px;background:var(--red);color:#fff;font-size:9px;font-weight:800;display:flex;align-items:center;justify-content:center;border:2px solid var(--rail);padding:0 2px;}
/* SIDEBAR */
.sidebar{width:240px;min-width:240px;background:var(--sidebar);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;}
.sidebar-header{height:52px;display:flex;align-items:center;padding:0 14px;border-bottom:1px solid var(--border);font-family:'Syne',sans-serif;font-size:14px;font-weight:700;flex-shrink:0;gap:7px;background:rgba(0,0,0,.15);}
.hdr-actions{margin-left:auto;display:flex;gap:2px;}
.hdr-actions button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.hdr-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.sidebar-scroll{flex:1;overflow-y:auto;padding:6px 0;}
.sec-label{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 5px;display:flex;align-items:center;justify-content:space-between;}
.sec-label button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;}
.ch-item{display:flex;align-items:center;gap:8px;padding:6px 8px;margin:1px 6px;border-radius:10px;cursor:pointer;font-size:12.5px;color:var(--muted);transition:all .1s;}
.ch-item:hover{background:rgba(255,255,255,.05);color:var(--text);}
.ch-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.cat-row{display:flex;align-items:center;gap:5px;padding:10px 8px 4px 10px;font-size:10px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);cursor:pointer;}
.cat-row button{margin-left:auto;background:none;border:none;color:inherit;cursor:pointer;font-size:14px;}
.friend-item{display:flex;align-items:center;gap:9px;padding:6px 10px;margin:1px 6px;border-radius:10px;cursor:pointer;transition:background .1s;}
.friend-item:hover{background:rgba(255,255,255,.05);}
.friend-item.active{background:rgba(255,249,62,.07);}
.fa{position:relative;flex-shrink:0;border-radius:50%;overflow:hidden;background:var(--panel);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;}
.fa img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.fa .fs{position:absolute;bottom:-1px;right:-1px;width:10px;height:10px;border-radius:50%;border:2px solid var(--sidebar);}
.fs.online{background:var(--green);}.fs.away{background:var(--yellow);}.fs.dnd{background:var(--red);}.fs.offline,.fs.invisible{background:#374151;}
.fi-info{flex:1;min-width:0;}
.fi-name{font-size:13px;font-weight:600;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.fi-sub{font-size:11px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bastion-tag{display:inline-flex;align-items:center;font-size:9px;font-weight:800;letter-spacing:.04em;padding:1px 5px;border-radius:4px;border:1px solid;margin-left:3px;vertical-align:middle;text-transform:uppercase;}
.userbar{height:56px;background:rgba(4,6,10,.8);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 8px;gap:7px;flex-shrink:0;}
.ua{width:34px;height:34px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;position:relative;cursor:pointer;}
.ua img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ua .ua-ring{position:absolute;bottom:-1px;right:-1px;width:11px;height:11px;border-radius:50%;background:var(--green);border:2px solid var(--sidebar);}
.ua-info{flex:1;min-width:0;}
.ua-name{font-size:13px;font-weight:600;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ua-tag{font-size:10.5px;color:var(--muted);}
.ua-btns{display:flex;gap:2px;}
.ua-btns button{width:28px;height:28px;border-radius:9px;background:transparent;border:none;color:var(--muted);font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.ua-btns button:hover{background:rgba(255,255,255,.07);color:#fff;}
/* MAIN */
.main{flex:1;min-width:0;display:flex;flex-direction:column;}
.topbar{height:52px;background:rgba(8,11,18,.96);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 18px;gap:10px;flex-shrink:0;}
.topbar-title{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;display:flex;align-items:center;gap:7px;white-space:nowrap;}
.tb-sep{width:1px;height:18px;background:var(--border);margin:0 2px;}
.tb-desc{font-size:12.5px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;}
.tb-actions{margin-left:auto;display:flex;align-items:center;gap:6px;}
.tb-actions button{background:transparent;border:none;color:var(--muted);font-size:16px;cursor:pointer;width:32px;height:32px;border-radius:10px;display:flex;align-items:center;justify-content:center;transition:all .1s;}
.tb-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
.onyx-pill{display:flex;align-items:center;gap:5px;background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:100px;padding:5px 12px;font-size:12px;font-weight:700;color:var(--accent);cursor:pointer;}
.onyx-pill img{width:14px;height:14px;object-fit:contain;}
.tb-search{display:flex;align-items:center;gap:6px;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:5px 10px;width:170px;}
.tb-search input{background:transparent;border:none;outline:none;color:#fff;font-family:'DM Sans',sans-serif;font-size:12.5px;flex:1;}
.tb-search input::placeholder{color:var(--muted);}
.content{flex:1;overflow:hidden;position:relative;display:flex;}
.view{display:none;flex:1;}
.view.active{display:flex;}
/* LOADING */
.app-loading{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999;flex-direction:column;gap:16px;}
.app-loading .lbl{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--muted-light);}
@keyframes spin{to{transform:rotate(360deg);}}
.load-spinner{width:32px;height:32px;border:3px solid rgba(255,249,62,.15);border-top-color:var(--accent);border-radius:50%;animation:spin .7s linear infinite;}
/* HOME */
.home-wrap{flex:1;display:flex;overflow:hidden;}
.home-feed{flex:1;overflow-y:auto;background:var(--bg);}
.home-right{width:290px;min-width:290px;border-left:1px solid var(--border);overflow-y:auto;background:var(--channel);}
.home-hero{width:100%;min-height:280px;background:linear-gradient(105deg,rgba(7,9,14,.98) 35%,rgba(7,9,14,.65) 100%),url("Fortized banner.png") center/cover no-repeat;position:relative;overflow:hidden;flex-shrink:0;display:grid;grid-template-columns:1fr auto;align-items:center;padding:0 48px;}
.home-hero::after{content:"";position:absolute;bottom:0;left:0;right:0;height:80px;background:linear-gradient(to bottom,transparent,var(--bg));pointer-events:none;}
@keyframes revealUp{from{opacity:0;transform:translateY(24px);}to{opacity:1;transform:none;}}
.hero-left-content{position:relative;z-index:1;animation:revealUp .5s cubic-bezier(.22,1,.36,1) both;}
.hero-tag-app{display:inline-flex;align-items:center;gap:8px;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--accent);background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:100px;padding:5px 14px;margin-bottom:20px;}
.hero-tag-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);}
.home-hero h1{font-family:'Syne',sans-serif;font-size:48px;font-weight:800;letter-spacing:-2px;line-height:.96;margin-bottom:14px;}
.home-hero h1 em{font-style:normal;color:var(--accent);}
.home-hero p.hero-sub-app{font-size:14.5px;color:rgba(255,255,255,.6);line-height:1.65;max-width:360px;margin-bottom:26px;}
.home-hero-actions{display:flex;gap:10px;flex-wrap:wrap;}
.home-hero-knight{position:relative;z-index:1;display:flex;align-items:flex-end;justify-content:center;height:280px;width:200px;}
.home-hero-knight img{height:250px;object-fit:contain;filter:drop-shadow(0 20px 40px rgba(255,249,62,.15));}
.home-marquee{background:rgba(11,14,21,.7);border-top:1px solid var(--border);border-bottom:1px solid var(--border);overflow:hidden;position:relative;flex-shrink:0;}
.marquee-track{display:flex;animation:marquee 20s linear infinite;width:max-content;}
@keyframes marquee{from{transform:translateX(0);}to{transform:translateX(-50%);}}
.marquee-item{display:flex;align-items:center;gap:10px;padding:14px 36px;border-right:1px solid var(--border);white-space:nowrap;}
.mi-icon{font-size:15px;opacity:.7;}.mi-label{font-family:'Syne',sans-serif;font-size:11.5px;font-weight:700;color:var(--muted-light);letter-spacing:.04em;}.mi-accent{color:var(--accent);}
.home-main-scroll{padding:28px 32px 48px;max-width:900px;}
.section-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.section-hdr h3{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;display:flex;align-items:center;gap:8px;}
.section-hdr h3::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.quick-nav{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:32px;}
.qn-tile{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:24px 18px;cursor:pointer;transition:all .22s;display:flex;flex-direction:column;gap:12px;position:relative;overflow:hidden;}
.qn-tile:hover{border-color:rgba(255,249,62,.2);transform:translateY(-4px);box-shadow:0 16px 48px rgba(0,0,0,.4);}
.qn-icon{width:44px;height:44px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.qn-text h4{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;margin-bottom:2px;}
.qn-text p{font-size:12px;color:var(--muted);}
.qn-badge{position:absolute;top:10px;right:10px;background:var(--red);color:#fff;font-size:9px;font-weight:800;padding:2px 6px;border-radius:100px;}
.activity-item{display:flex;align-items:center;gap:12px;padding:14px 18px;background:var(--panel);border:1px solid var(--border);border-radius:16px;cursor:pointer;transition:all .2s;margin-bottom:8px;}
.activity-item:hover{border-color:rgba(255,249,62,.16);transform:translateY(-2px);}
.act-icon{width:40px;height:40px;border-radius:14px;background:var(--panel2);border:1px solid var(--border);font-size:18px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;}
.act-icon img{width:100%;height:100%;object-fit:cover;border-radius:12px;}
.act-text{flex:1;}
.act-text p{font-size:14px;color:var(--text);line-height:1.5;}
.act-time{font-size:11.5px;color:var(--muted);margin-top:2px;}
.rp-section{padding:16px 14px 8px;border-bottom:1px solid var(--border);}
.rp-title{font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.rp-notif{display:flex;gap:9px;padding:8px 10px;border-radius:12px;cursor:pointer;margin-bottom:4px;}
.rp-notif:hover{background:rgba(255,255,255,.04);}
.rp-notif.unread{background:rgba(255,249,62,.04);}
.rp-notif .rn-icon{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.rp-notif .rn-text{flex:1;}
.rp-notif .rn-text p{font-size:12.5px;color:var(--text);line-height:1.4;}
.rp-notif .rn-time{font-size:10.5px;color:var(--muted);}
.rp-notif .rn-actions{display:flex;gap:5px;margin-top:5px;}
.rn-accept{background:rgba(62,207,110,.15);border:1px solid rgba(62,207,110,.3);color:var(--green);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.rn-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:3px 11px;border-radius:7px;cursor:pointer;}
.blog-post{padding:10px;border-radius:12px;cursor:pointer;margin-bottom:4px;}
.blog-post:hover{background:rgba(255,255,255,.04);}
.blog-post .bp-tag{font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;color:var(--accent);margin-bottom:3px;}
.blog-post .bp-title{font-size:13px;font-weight:700;color:var(--text);margin-bottom:3px;line-height:1.4;}
.blog-post .bp-date{font-size:11px;color:var(--muted);}
/* CHAT */
.chat-wrap{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.chat-msgs{flex:1;overflow-y:auto;padding:16px 0;display:flex;flex-direction:column;}
.chat-welcome{padding:20px 20px 18px;border-bottom:1px solid var(--border);margin-bottom:8px;}
.chat-welcome .w-av{width:60px;height:60px;border-radius:50%;background:var(--panel);border:2px solid var(--border);font-size:22px;display:flex;align-items:center;justify-content:center;margin-bottom:12px;overflow:hidden;}
.chat-welcome .w-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.chat-welcome h3{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.chat-welcome p{font-size:13.5px;color:var(--muted-light);}
.date-div{display:flex;align-items:center;gap:10px;padding:8px 20px;font-size:10.5px;font-weight:700;color:var(--muted);letter-spacing:.04em;}
.date-div::before,.date-div::after{content:"";flex:1;height:1px;background:var(--border);}
/* MESSAGES */
.msg-row{display:flex;padding:2px 20px;position:relative;}
.msg-row:hover{background:rgba(255,255,255,.018);}
.msg-row.msg-first{padding-top:16px;}
.msg-av-wrap{width:40px;min-width:40px;display:flex;justify-content:center;padding-top:2px;flex-shrink:0;}
.msg-av-inner{width:36px;height:36px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:13px;display:flex;align-items:center;justify-content:center;overflow:hidden;cursor:pointer;flex-shrink:0;}
.msg-av-inner img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.msg-time-small{font-size:10px;color:var(--muted);white-space:nowrap;padding-top:4px;min-width:44px;text-align:left;visibility:hidden;}
.msg-row.msg-cont:hover .msg-time-small{visibility:visible;}
.msg-content-col{flex:1;min-width:0;}
.msg-header{display:flex;align-items:baseline;gap:8px;margin-bottom:2px;}
.msg-author{font-size:14px;font-weight:700;color:#fff;cursor:pointer;}
.msg-author:hover{text-decoration:underline;}
.msg-timestamp{font-size:11px;color:var(--muted);}
.msg-edited-tag{font-size:10px;color:var(--muted);font-style:italic;margin-left:4px;}
.msg-text{font-size:14px;color:var(--text);line-height:1.55;word-break:break-word;max-width:680px;user-select:text;}
.msg-text code{background:rgba(255,255,255,.07);padding:1px 6px;border-radius:5px;font-size:12.5px;font-family:monospace;}
.msg-edit-box{display:none;margin-top:4px;}
.msg-edit-box.active{display:block;}
.msg-edit-input{width:100%;background:var(--panel2);border:1px solid rgba(255,249,62,.3);border-radius:10px;padding:8px 12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;resize:none;max-height:200px;}
.msg-edit-actions{display:flex;gap:6px;margin-top:5px;font-size:12px;}
.reply-bar-wrap{padding:0 20px 4px;display:none;}
.reply-preview{display:flex;align-items:center;gap:8px;padding:6px 12px;background:rgba(255,255,255,.04);border-left:3px solid var(--accent);border-radius:0 8px 8px 0;font-size:12.5px;color:var(--muted-light);}
.reply-preview .rp-author{color:var(--accent);font-weight:700;margin-right:4px;}
.reply-preview .rp-close{margin-left:auto;cursor:pointer;color:var(--muted);font-size:14px;}
.msg-reply-ref{background:rgba(255,255,255,.04);border-left:3px solid var(--muted);border-radius:0 8px 8px 0;padding:4px 8px;margin-bottom:4px;font-size:12px;color:var(--muted-light);cursor:pointer;}
.msg-reply-ref .rr-author{font-weight:700;margin-right:4px;}
.msg-reactions{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px;}
.r-pill{display:flex;align-items:center;gap:4px;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:100px;padding:2px 9px;font-size:12.5px;cursor:pointer;}
.r-pill:hover{background:rgba(255,255,255,.09);}
.r-pill.mine{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
/* MSG ACTIONS */
.msg-acts{display:none;gap:2px;position:absolute;right:14px;top:-14px;background:var(--panel2);border:1px solid var(--border);border-radius:10px;padding:3px;z-index:10;}
.msg-row:hover .msg-acts{display:flex;}
.msg-acts button{background:none;border:none;color:var(--muted);font-size:14px;cursor:pointer;width:26px;height:26px;border-radius:7px;display:flex;align-items:center;justify-content:center;transition:all .1s;position:relative;}
.msg-acts button:hover{background:rgba(255,255,255,.07);color:#fff;}
.msg-acts button[title]:hover::after{content:attr(title);position:absolute;bottom:calc(100%+5px);left:50%;transform:translateX(-50%);background:#0c1020;border:1px solid var(--border);color:var(--text);font-size:10px;font-weight:600;padding:3px 7px;border-radius:6px;white-space:nowrap;z-index:999;pointer-events:none;}
.msg-row.own .msg-text{color:rgba(255,249,62,.92);}
/* INPUT */
.chat-input-wrap{padding:0 16px 14px;flex-shrink:0;}
.chat-input-box{background:var(--panel2);border:1px solid var(--border);border-radius:14px;display:flex;align-items:flex-end;gap:5px;padding:8px 11px;}
.chat-input-box:focus-within{border-color:rgba(255,249,62,.24);}
.chat-input-box textarea{flex:1;background:transparent;border:none;outline:none;color:var(--text);font-family:'DM Sans',sans-serif;font-size:13.5px;resize:none;max-height:120px;line-height:1.5;padding:2px 0;user-select:text;}
.chat-input-box textarea::placeholder{color:var(--muted);}
.chat-send{width:32px;height:32px;border-radius:10px;background:var(--accent);border:none;color:#060810;font-size:14px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.chat-send:hover{filter:brightness(1.08);}
.chat-input-actions{display:flex;gap:2px;align-items:center;}
.chat-input-actions button{background:none;border:none;color:var(--muted);font-size:17px;cursor:pointer;width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;}
.chat-input-actions button:hover{background:rgba(255,255,255,.07);color:#fff;}
/* EMOJI PICKER */
.emoji-picker-popup{position:fixed;z-index:5000;background:var(--panel);border:1px solid var(--border);border-radius:16px;width:360px;box-shadow:0 20px 60px rgba(0,0,0,.7);overflow:hidden;display:none;}
.ep-search{padding:10px 12px;border-bottom:1px solid var(--border);}
.ep-search input{width:100%;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:8px;padding:7px 11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;}
.ep-tabs{display:flex;border-bottom:1px solid var(--border);padding:0 8px;overflow-x:auto;}
.ep-tab{padding:8px 10px;font-size:16px;cursor:pointer;border-bottom:2px solid transparent;flex-shrink:0;}
.ep-tab.active{border-bottom-color:var(--accent);}
.ep-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;padding:8px;max-height:220px;overflow-y:auto;}
.ep-emoji{width:36px;height:36px;display:flex;align-items:center;justify-content:center;border-radius:8px;cursor:pointer;font-size:20px;}
.ep-emoji:hover{background:rgba(255,255,255,.08);}
.ep-emoji img{width:28px;height:28px;object-fit:contain;border-radius:4px;}
.ep-section-label{grid-column:1/-1;font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);padding:6px 4px 3px;}
/* MEMBER LIST */
.member-list{width:220px;min-width:220px;background:var(--channel);border-left:1px solid var(--border);overflow-y:auto;padding:12px 0;}
.ml-role-header{padding:4px 12px 2px;font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-top:8px;}
.ml-entry{display:flex;align-items:center;gap:8px;padding:5px 9px 5px 12px;margin:1px 4px;border-radius:10px;cursor:pointer;}
.ml-entry:hover{background:rgba(255,255,255,.05);}
.ml-av{width:30px;height:30px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden;position:relative;}
.ml-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.ml-status{position:absolute;bottom:-1px;right:-1px;width:9px;height:9px;border-radius:50%;border:2px solid var(--channel);}
.ml-info{flex:1;min-width:0;}
.ml-name{font-size:12.5px;font-weight:600;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
/* DISCOVER */
.discover-scroll{flex:1;overflow-y:auto;padding:28px;}
.disc-hero{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:38px 36px;margin-bottom:28px;}
.disc-hero h2{font-family:'Syne',sans-serif;font-size:28px;font-weight:800;letter-spacing:-.5px;margin-bottom:6px;}
.disc-hero p{font-size:14px;color:var(--muted-light);margin-bottom:20px;}
.disc-search{display:flex;align-items:center;gap:10px;max-width:400px;position:relative;}
.disc-search input{flex:1;background:rgba(255,255,255,.05);border:1px solid var(--border);border-radius:12px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;padding:10px 14px 10px 38px;outline:none;}
.disc-search .si{position:absolute;left:12px;font-size:13px;color:var(--muted);pointer-events:none;}
.disc-tabs{display:flex;gap:5px;margin-bottom:22px;}
.disc-tab{padding:7px 16px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid transparent;color:var(--muted-light);}
.disc-tab.active{background:var(--accent-dim);border-color:var(--accent-mid);color:var(--accent);}
.bastion-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
.bc{background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;cursor:pointer;transition:all .15s;}
.bc:hover{border-color:rgba(255,249,62,.2);transform:translateY(-2px);}
.bc-banner{height:76px;background:linear-gradient(135deg,#1a2040,#0d1425);display:flex;align-items:center;justify-content:center;font-size:30px;overflow:hidden;}
.bc-banner img{width:100%;height:100%;object-fit:cover;}
.bc-body{padding:14px;}
.bc-meta{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.bc-icon{width:42px;height:42px;border-radius:12px;background:var(--panel2);border:2px solid var(--sidebar);font-size:18px;display:flex;align-items:center;justify-content:center;margin-top:-26px;position:relative;z-index:1;flex-shrink:0;overflow:hidden;}
.bc-icon img{width:100%;height:100%;object-fit:cover;border-radius:10px;}
.bc-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.bc-desc{font-size:12px;color:var(--muted-light);line-height:1.55;margin-bottom:8px;}
/* ATELIER */
.atelier-scroll{flex:1;overflow-y:auto;padding:28px;}
.atelier-top{display:flex;align-items:center;justify-content:space-between;background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:26px 30px;margin-bottom:26px;}
.atelier-bal{display:flex;align-items:center;gap:13px;}
.atelier-bal img{width:36px;height:36px;object-fit:contain;}
.atelier-bal h3{font-size:13px;font-weight:600;color:var(--muted-light);margin-bottom:2px;}
.atelier-bal .amt{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:var(--accent);letter-spacing:-.3px;}
.daily-btn{display:flex;flex-direction:column;align-items:center;gap:3px;background:rgba(255,249,62,.07);border:1px solid rgba(255,249,62,.18);border-radius:16px;padding:14px 24px;cursor:pointer;}
.daily-btn span{font-size:11px;color:var(--muted-light);}
.daily-btn strong{font-family:'Syne',sans-serif;font-size:14px;color:var(--accent);}
.daily-btn.claimed{opacity:.5;cursor:not-allowed;}
.atelier-section-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.atelier-section-title::before{content:"";width:14px;height:3px;background:var(--accent);border-radius:2px;}
.radiance-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:13px;margin-bottom:28px;}
.rad-card{background:var(--panel);border:1px solid var(--border);border-radius:18px;padding:22px 18px;display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px;cursor:pointer;transition:all .15s;position:relative;}
.rad-card:hover{border-color:rgba(255,249,62,.22);transform:translateY(-2px);}
.rad-card.bv{border-color:rgba(255,249,62,.18);}
.best-badge{position:absolute;top:10px;right:10px;background:var(--accent);color:#060810;font-size:9px;font-weight:800;padding:2px 7px;border-radius:100px;text-transform:uppercase;}
.rad-icon{font-size:30px;}.rad-dur{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.rad-price{font-family:'Syne',sans-serif;font-size:21px;font-weight:800;color:var(--accent);}
.rad-price span{font-size:12px;color:var(--muted-light);font-family:'DM Sans',sans-serif;font-weight:400;}
.rad-feats{font-size:12px;color:var(--muted-light);}
/* PROFILE */
.profile-wrap{flex:1;display:flex;overflow:hidden;}
.profile-nav{width:210px;min-width:210px;border-right:1px solid var(--border);background:var(--channel);display:flex;flex-direction:column;padding:12px 0;overflow-y:auto;}
.profile-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13.5px;color:var(--muted-light);}
.profile-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.profile-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.profile-main{flex:1;overflow-y:auto;}
.profile-banner-area{width:100%;height:150px;background:linear-gradient(135deg,#0f1830,#1a0f30,#0f2030);position:relative;overflow:hidden;}
.profile-banner-area img{width:100%;height:100%;object-fit:cover;}
.profile-av-row{display:flex;align-items:flex-end;gap:14px;padding:0 24px;margin-top:-28px;margin-bottom:14px;}
.profile-av-big{width:56px;height:56px;border-radius:50%;background:var(--panel);border:3px solid var(--bg);font-size:20px;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;cursor:pointer;}
.profile-av-big img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.profile-display-name{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:2px;}
.profile-username{font-size:13.5px;color:var(--muted-light);}
.profile-content{padding:0 24px 36px;}
.profile-stats-row{display:flex;background:var(--panel);border:1px solid var(--border);border-radius:18px;overflow:hidden;margin-bottom:22px;}
.ps-stat{flex:1;padding:16px;text-align:center;border-right:1px solid var(--border);}
.ps-stat:last-child{border-right:none;}
.ps-val{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;color:var(--accent);}
.ps-key{font-size:11.5px;color:var(--muted);margin-top:2px;}
/* SETTINGS */
.settings-section{margin-bottom:24px;}
.settings-title{font-family:'Syne',sans-serif;font-size:10.5px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:10px;}
.s-row{display:flex;align-items:center;gap:12px;padding:13px 15px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:7px;cursor:pointer;}
.s-row .si{font-size:17px;width:30px;text-align:center;}
.s-row .st{flex:1;}
.s-row .sl{font-size:13.5px;font-weight:600;}
.s-row .ss{font-size:12px;color:var(--muted-light);margin-top:1px;}
.field-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;transition:border-color .12s;}
.field-input:focus{border-color:rgba(255,249,62,.3);}
.field-input::placeholder{color:#252c3d;}
.toggle{width:38px;height:20px;border-radius:10px;background:var(--border);position:relative;cursor:pointer;flex-shrink:0;}
.toggle.on{background:var(--accent);}
.toggle::after{content:"";position:absolute;top:2px;left:2px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .15s;}
.toggle.on::after{transform:translateX(18px);}
.radiance-badge{display:inline-flex;align-items:center;gap:5px;background:linear-gradient(90deg,rgba(255,200,62,.12),rgba(255,249,62,.12));border:1px solid rgba(255,220,62,.25);border-radius:100px;padding:3px 10px;font-size:11px;font-weight:700;color:#ffd93e;margin-top:5px;}
.boost-bar{background:rgba(255,249,62,.06);border:1px solid rgba(255,249,62,.12);border-radius:12px;padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:12.5px;color:var(--muted-light);cursor:pointer;margin:8px 8px 4px;}
.boost-bar .bl{font-weight:700;color:var(--accent);}
.boost-level-bar{display:flex;align-items:center;gap:10px;padding:14px 16px;background:linear-gradient(90deg,rgba(255,249,62,.07),rgba(255,249,62,.03));border:1px solid rgba(255,249,62,.15);border-radius:14px;margin-bottom:18px;}
.bl-icon{font-size:22px;}.bl-info{flex:1;}
.bl-name{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;color:var(--accent);}
.bl-sub{font-size:12px;color:var(--muted-light);}
.bl-prog{flex:1;height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.bl-fill{height:100%;background:var(--accent);border-radius:3px;}
/* BASTION SETTINGS */
.bsettings-wrap{flex:1;display:flex;overflow:hidden;}
.bsettings-nav{width:220px;min-width:220px;border-right:1px solid var(--border);background:var(--channel);overflow-y:auto;padding:12px 0;}
.bsettings-main{flex:1;overflow-y:auto;padding:28px;}
.bsettings-nav-item{display:flex;align-items:center;gap:9px;padding:9px 14px;margin:1px 6px;border-radius:12px;cursor:pointer;font-size:13px;color:var(--muted-light);}
.bsettings-nav-item:hover{background:rgba(255,255,255,.05);color:#fff;}
.bsettings-nav-item.active{background:rgba(255,249,62,.08);color:var(--accent);}
.bsettings-nav-section{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);padding:12px 14px 4px;}
.role-item{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:7px;}
.role-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.role-name{flex:1;font-size:13.5px;font-weight:600;}
.perm-row{display:flex;align-items:flex-start;gap:12px;padding:12px 0;border-bottom:1px solid var(--border);}
.perm-info{flex:1;}
.perm-label{font-size:13.5px;font-weight:600;}
/* EMOJI GRID */
.emoji-upload-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:16px;}
.emoji-slot{width:52px;height:52px;border-radius:10px;border:1.5px dashed var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;position:relative;overflow:hidden;font-size:22px;}
.emoji-slot:hover{border-color:var(--accent);background:var(--accent-dim);}
.emoji-slot.filled{border-style:solid;border-color:var(--border);}
.emoji-slot img{width:40px;height:40px;object-fit:contain;border-radius:6px;}
.emoji-slot .es-del{position:absolute;top:2px;right:2px;width:14px;height:14px;border-radius:50%;background:var(--red);color:#fff;font-size:8px;display:none;align-items:center;justify-content:center;cursor:pointer;}
.emoji-slot:hover .es-del{display:flex;}
/* AUTOMOD */
.automod-rule{padding:14px 16px;background:var(--panel);border:1px solid var(--border);border-radius:14px;margin-bottom:8px;}
.amr-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.amr-icon{font-size:20px;}.amr-title{font-size:14px;font-weight:700;flex:1;}
.amr-enabled{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--muted-light);}
.amr-desc{font-size:12.5px;color:var(--muted-light);line-height:1.55;margin-bottom:10px;}
.amr-keywords{display:flex;flex-wrap:wrap;gap:5px;}
.amr-kw{display:flex;align-items:center;gap:4px;background:rgba(248,113,113,.1);border:1px solid rgba(248,113,113,.2);color:var(--red);font-size:11.5px;padding:3px 8px;border-radius:100px;}
.amr-kw button{background:none;border:none;color:inherit;cursor:pointer;font-size:11px;padding:0;}
/* VOICE */
.voice-area{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;gap:20px;padding:40px;}
.voice-active-panel{background:var(--panel);border:1px solid var(--border);border-radius:22px;padding:30px;width:100%;max-width:700px;}
.voice-participants{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:14px;margin-bottom:24px;}
.voice-participant{background:var(--panel2);border:1px solid var(--border);border-radius:16px;padding:20px 14px;display:flex;flex-direction:column;align-items:center;gap:10px;position:relative;}
.voice-participant.speaking{border-color:var(--green);box-shadow:0 0 20px rgba(62,207,110,.15);}
.vp-av{width:64px;height:64px;border-radius:50%;background:var(--panel3);border:3px solid var(--border);font-size:24px;display:flex;align-items:center;justify-content:center;overflow:hidden;}
.vp-av img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.vp-name{font-size:13px;font-weight:700;text-align:center;}
.vp-status{font-size:11px;color:var(--muted);}
.voice-controls{display:flex;gap:12px;justify-content:center;align-items:center;}
.vc-btn{width:52px;height:52px;border-radius:50%;background:var(--panel2);border:1px solid var(--border);color:var(--text);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.vc-btn:hover{background:rgba(255,255,255,.1);}
.vc-btn.active{background:var(--red);border-color:var(--red);color:#fff;}
.vc-btn.end{background:var(--red);border-color:var(--red);color:#fff;width:60px;height:60px;font-size:22px;}
/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(12px);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:20px;width:100%;max-width:420px;overflow:hidden;animation:mIn .2s cubic-bezier(.22,1,.36,1) both;box-shadow:0 32px 80px rgba(0,0,0,.7);}
.modal.wide{max-width:580px;}
.modal.tall{max-height:80vh;display:flex;flex-direction:column;}
.modal.tall .modal-body{overflow-y:auto;flex:1;}
@keyframes mIn{from{opacity:0;transform:scale(.93) translateY(14px);}to{opacity:1;transform:none;}}
.modal-bar{height:2px;background:linear-gradient(90deg,transparent,var(--accent),transparent);flex-shrink:0;}
.modal-body{padding:26px;}
.modal-title{font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:5px;}
.modal-sub{font-size:13px;color:var(--muted-light);margin-bottom:22px;}
.modal-error{font-size:12px;color:var(--red);margin-bottom:8px;min-height:16px;}
.modal-error:not(:empty)::before{content:"‚ö† ";}
.modal-success{font-size:12px;color:var(--green);margin-bottom:8px;}
.modal-actions{display:flex;gap:9px;margin-top:6px;}
.modal-actions .btn-a,.modal-actions .btn-g{flex:1;justify-content:center;}
.modal-input{width:100%;padding:10px 14px;background:#05070d;border:1px solid var(--border);border-radius:11px;color:#fff;font-family:'DM Sans',sans-serif;font-size:13.5px;outline:none;margin-bottom:12px;}
.modal-input:focus{border-color:rgba(255,249,62,.32);}
.modal-input::placeholder{color:#252c3d;}
/* SECURITY */
.security-modal{background:var(--panel);border:1px solid var(--border);border-radius:24px;width:100%;max-width:480px;overflow:hidden;animation:mIn .3s cubic-bezier(.22,1,.36,1) both;box-shadow:0 40px 100px rgba(0,0,0,.8);}
.sec-header{padding:28px 28px 0;text-align:center;}
.sec-header img{width:64px;height:64px;object-fit:contain;margin-bottom:14px;}
.sec-quiz{padding:20px 28px 28px;}
.sec-question{font-size:15px;color:var(--text);margin-bottom:16px;font-weight:600;line-height:1.55;}
.sec-options{display:flex;flex-direction:column;gap:8px;}
.sec-option{padding:12px 16px;background:var(--panel2);border:1px solid var(--border);border-radius:12px;cursor:pointer;font-size:13.5px;}
.sec-option:hover{border-color:rgba(255,249,62,.3);background:var(--accent-dim);}
.sec-option.correct{border-color:var(--green);background:rgba(62,207,110,.1);color:var(--green);}
.sec-option.wrong{border-color:var(--red);background:rgba(248,113,113,.1);color:var(--red);}
.sec-progress{display:flex;gap:4px;margin-bottom:20px;}
.sec-dot{flex:1;height:3px;border-radius:2px;background:var(--border);}
.sec-dot.done{background:var(--accent);}
.sec-dot.current{background:var(--accent);opacity:.5;}
/* NOTIF PANEL */
.notif-panel{position:fixed;top:52px;right:0;width:330px;max-height:calc(100vh - 60px);background:var(--sidebar);border:1px solid var(--border);border-radius:18px 0 0 18px;box-shadow:-8px 0 40px rgba(0,0,0,.5);z-index:100;transform:translateX(100%);transition:transform .22s cubic-bezier(.22,1,.36,1);display:flex;flex-direction:column;}
.notif-panel.open{transform:translateX(0);}
.np-header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;}
.np-header h3{font-family:'Syne',sans-serif;font-size:14px;font-weight:700;}
.np-header button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:15px;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;}
.np-list{flex:1;overflow-y:auto;padding:8px;}
.np-item{display:flex;gap:10px;padding:10px 12px;border-radius:12px;cursor:pointer;margin-bottom:3px;position:relative;}
.np-item:hover{background:rgba(255,255,255,.04);}
.np-item.unread{background:rgba(255,249,62,.04);}
.np-item.unread::before{content:"";position:absolute;left:4px;top:50%;transform:translateY(-50%);width:4px;height:4px;border-radius:50%;background:var(--accent);}
.np-icon{width:32px;height:32px;border-radius:50%;background:var(--panel);border:1px solid var(--border);font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.np-text{flex:1;}
.np-text p{font-size:12.5px;color:var(--text);line-height:1.45;}
.np-time{font-size:10.5px;color:var(--muted);margin-top:2px;}
.np-actions{display:flex;gap:5px;margin-top:6px;}
.np-accept{background:rgba(62,207,110,.12);border:1px solid rgba(62,207,110,.25);color:var(--green);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
.np-decline{background:transparent;border:1px solid var(--border);color:var(--muted-light);font-size:11px;font-weight:700;padding:4px 10px;border-radius:7px;cursor:pointer;}
/* MISC */
.empty-state{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:14px;color:var(--muted);text-align:center;padding:40px;}
.empty-state .ei{font-size:48px;opacity:.3;}
.empty-state h3{font-family:'Syne',sans-serif;font-size:17px;font-weight:700;color:var(--muted-light);}
.empty-state p{font-size:13.5px;max-width:290px;line-height:1.6;}
.color-swatches{display:flex;gap:7px;flex-wrap:wrap;margin-bottom:12px;}
.color-swatch{width:26px;height:26px;border-radius:50%;cursor:pointer;border:2px solid transparent;}
.color-swatch:hover,.color-swatch.sel{border-color:#fff;transform:scale(1.15);}
.emoji-opt{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:19px;cursor:pointer;border:1.5px solid transparent;}
.emoji-opt:hover{background:rgba(255,255,255,.06);}
.emoji-opt.sel{border-color:var(--accent);background:var(--accent-dim);}
.emoji-picker-wrap{display:flex;gap:5px;flex-wrap:wrap;margin-bottom:13px;}
.invite-link-box{background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:10px;padding:10px 14px;font-family:monospace;font-size:13px;color:var(--accent);display:flex;align-items:center;gap:10px;margin-bottom:12px;}
.invite-link-box span{flex:1;word-break:break-all;}
.vis-toggle{display:flex;gap:8px;margin-bottom:14px;}
.vis-opt{flex:1;padding:12px;border-radius:12px;border:1.5px solid var(--border);cursor:pointer;text-align:center;}
.vis-opt.active{border-color:var(--accent);background:var(--accent-dim);}
.vis-opt .vo-icon{font-size:22px;margin-bottom:4px;}
.vis-opt .vo-label{font-size:13px;font-weight:700;}
.vis-opt .vo-desc{font-size:11px;color:var(--muted-light);margin-top:2px;}
/* CTX MENU */
.ctx-menu{position:fixed;z-index:9999;background:rgba(13,16,24,.98);border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:6px;min-width:200px;box-shadow:0 20px 50px rgba(0,0,0,.7);backdrop-filter:blur(22px);}
@keyframes ctxIn{from{opacity:0;transform:scale(.96) translateY(-4px);}to{opacity:1;transform:none;}}
.ctx-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-radius:9px;font-size:13px;color:rgba(220,228,240,.9);cursor:pointer;}
.ctx-item:hover{background:rgba(255,255,255,.07);color:#fff;}
.ctx-item.danger{color:rgba(248,113,113,.85);}
.ctx-item.danger:hover{background:rgba(248,113,113,.12);color:var(--red);}
.ctx-sep{height:1px;background:rgba(255,255,255,.07);margin:5px 0;}
.ctx-section-label{padding:9px 12px 4px;font-size:10px;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:rgba(255,255,255,.22);}
/* TOAST */
.toast{position:fixed;bottom:22px;right:22px;z-index:2000;background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:11px 18px;font-size:13px;font-weight:500;box-shadow:0 20px 50px rgba(0,0,0,.6);transform:translateY(20px);opacity:0;transition:transform .25s cubic-bezier(.22,1,.36,1),opacity .25s;max-width:280px;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.success{border-left:3px solid var(--green);color:#a3e8b8;}
.toast.error{border-left:3px solid var(--red);color:#fca5a5;}
.toast.info{border-left:3px solid var(--accent);color:var(--accent);}
/* BTNS */
.btn-a{display:inline-flex;align-items:center;gap:7px;background:var(--accent);color:#060810;padding:10px 20px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:none;cursor:pointer;}
.btn-a:hover{filter:brightness(1.06);transform:translateY(-1px);}
.btn-g{display:inline-flex;align-items:center;gap:7px;background:transparent;color:var(--muted-light);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid var(--border);cursor:pointer;}
.btn-g:hover{border-color:#2e3a52;background:rgba(255,255,255,.04);}
.btn-d{display:inline-flex;align-items:center;gap:7px;background:rgba(248,113,113,.1);color:var(--red);padding:9px 18px;border-radius:12px;font-family:'Syne',sans-serif;font-size:13.5px;font-weight:700;border:1px solid rgba(248,113,113,.2);cursor:pointer;}
.btn-d:hover{background:rgba(248,113,113,.18);}
.notif-setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:var(--panel);border:1px solid var(--border);border-radius:12px;margin-bottom:8px;}
.nsr-label{font-size:13.5px;font-weight:600;}
.nsr-sub{font-size:12px;color:var(--muted-light);margin-top:2px;}
.forward-list{max-height:300px;overflow-y:auto;}
.forward-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;cursor:pointer;}
.forward-item:hover{background:rgba(255,255,255,.05);}
</style>
</head>
<body>
<!-- LOADING -->
<div class="app-loading" id="appLoading">
  <img src="Fortized icon.png" style="width:52px;height:52px;object-fit:contain;filter:drop-shadow(0 0 16px rgba(255,249,62,.4));" onerror="this.style.display='none'">
  <div class="load-spinner"></div>
  <span class="lbl">Loading Fortized...</span>
</div>

<!-- SECURITY QUIZ OVERLAY -->
<div class="modal-overlay" id="securityOverlay" style="z-index:8000;">
  <div class="security-modal">
    <div class="sec-header">
      <img src="FortizedSecurity logo.png" onerror="this.outerHTML='<div style=font-size:48px>üõ°Ô∏è</div>'">
      <div style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:4px;">Security Verification</div>
      <div style="font-size:13px;color:var(--muted-light);margin-bottom:0;">Prove you're human to continue</div>
    </div>
    <div class="sec-quiz" id="secQuizContent"></div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- EMOJI PICKER -->
<div class="emoji-picker-popup" id="emojiPickerPopup"></div>

<!-- CUSTOM CONTEXT MENU -->
<div class="ctx-menu" id="ctxMenu" style="display:none;animation:ctxIn .12s ease both;"></div>

<!-- CUSTOM DIALOGS -->
<div class="modal-overlay" id="ftDialogOverlay">
  <div class="modal" style="max-width:380px;">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title" id="ftDialogTitle"></div>
      <div class="modal-sub" id="ftDialogSub" style="margin-bottom:14px;"></div>
      <input class="modal-input" id="ftDialogInput" style="display:none;" placeholder="">
      <div class="modal-actions" id="ftDialogActions"></div>
    </div>
  </div>
</div>

<!-- FORWARD MODAL -->
<div class="modal-overlay" id="forwardOverlay">
  <div class="modal wide tall">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Forward Message</div>
      <div class="modal-sub">Select where to send this message</div>
      <div class="forward-list" id="forwardList"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeForward()">Cancel</button>
        <button class="btn-a" onclick="confirmForward()">Forward</button>
      </div>
    </div>
  </div>
</div>

<!-- PROFILE CARD POPUP -->
<div class="ctx-menu" id="profileCard" style="display:none;min-width:260px;padding:0;overflow:hidden;border-radius:18px;"></div>

<!-- GENERIC MODAL -->
<div class="modal-overlay" id="genericModal">
  <div class="modal wide tall" id="genericModalInner">
    <div class="modal-bar"></div>
    <div class="modal-body" id="genericModalBody"></div>
  </div>
</div>

<!-- ADD CHANNEL MODAL -->
<div class="modal-overlay" id="addChannelModal">
  <div class="modal">
    <div class="modal-bar"></div>
    <div class="modal-body">
      <div class="modal-title">Create Channel</div>
      <div class="modal-sub">Add a new channel to this bastion</div>
      <div style="margin-bottom:12px;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px;font-weight:600;">CHANNEL TYPE</div>
        <div style="display:flex;gap:8px;">
          <div class="vis-opt active" id="chTypeText" onclick="selectChType('text')" style="cursor:pointer;">
            <div class="vo-icon">#</div>
            <div class="vo-label">Text</div>
          </div>
          <div class="vis-opt" id="chTypeVoice" onclick="selectChType('voice')" style="cursor:pointer;">
            <div class="vo-icon">üîä</div>
            <div class="vo-label">Voice</div>
          </div>
        </div>
      </div>
      <input class="modal-input" id="newChannelName" placeholder="channel-name">
      <div class="modal-error" id="addChannelErr"></div>
      <div class="modal-actions">
        <button class="btn-g" onclick="closeModal('addChannelModal')">Cancel</button>
        <button class="btn-a" onclick="confirmAddChannel()">Create Channel</button>
      </div>
    </div>
  </div>
</div>

<!-- MAIN APP -->
<div id="appShell" style="display:none;flex:1;overflow:hidden;display:none;">

<!-- RAIL -->
<div class="rail" id="rail">
  <div class="rail-logo" onclick="goHome()">
    <img src="Fortized icon.png" onerror="this.outerHTML='<span style=font-size:22px>‚öîÔ∏è</span>'">
  </div>
  <div class="rail-sep"></div>
  <div class="rail-btn" id="railHome" data-tip="Home" onclick="goHome()">üè†</div>
  <div class="rail-btn" id="railDiscover" data-tip="Discover" onclick="goDiscover()">üî≠</div>
  <div class="rail-btn" id="railAtelier" data-tip="Atelier" onclick="goAtelier()">üíé</div>
  <div class="rail-btn" id="railFriends" data-tip="Friends" onclick="goFriends()">üë•</div>
  <div class="rail-sep"></div>
  <div id="bastionRailList"></div>
  <div class="rail-btn" data-tip="Create Bastion" onclick="openCreateBastion()" style="margin-top:4px;border:1.5px dashed rgba(255,255,255,.15);">‚ûï</div>
  <div style="flex:1;"></div>
  <div class="rail-btn" data-tip="Notifications" onclick="toggleNotifPanel()" id="railNotifBtn">üîî</div>
</div>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-header" id="sidebarHeader">
    <span style="font-size:17px;">üí¨</span> <span id="sidebarTitle">Direct Messages</span>
    <div class="hdr-actions" id="sidebarHeaderActions">
      <button onclick="openNewDM()" title="New DM">‚úèÔ∏è</button>
    </div>
  </div>
  <div class="sidebar-scroll" id="sidebarContent"></div>
  <div class="userbar" id="userbar">
    <div class="ua" onclick="goProfile()" id="userbarAv">
      <div class="ua-ring" id="userbarStatusRing"></div>
    </div>
    <div class="ua-info">
      <div class="ua-name" id="userbarName">‚Äî</div>
      <div class="ua-tag" id="userbarTag">@‚Äî</div>
    </div>
    <div class="ua-btns">
      <button onclick="toggleMute()" id="muteBtn" title="Mute">üéôÔ∏è</button>
      <button onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
    </div>
  </div>
</div>

<!-- MAIN CONTENT -->
<div class="main">
  <div class="topbar" id="topbar">
    <div class="topbar-title" id="topbarTitle">üè† Home</div>
    <div class="tb-sep"></div>
    <div class="tb-desc" id="topbarDesc">Welcome to Fortized</div>
    <div class="tb-actions" id="topbarActions">
      <div class="onyx-pill" onclick="goAtelier()">
        <img src="Onyx.png" onerror="this.outerHTML='üíé'" style="width:14px;height:14px;">
        <span id="onyxCount">0</span>
      </div>
      <div class="tb-search">
        <span class="si">üîç</span>
        <input placeholder="Search..." id="topSearch" oninput="handleSearch(this.value)">
      </div>
      <button onclick="toggleNotifPanel()" title="Notifications">üîî</button>
    </div>
  </div>

  <div class="content">
    <!-- HOME VIEW -->
    <div class="view active" id="viewHome">
      <div class="home-wrap">
        <div class="home-feed" id="homeFeed">
          <div class="home-hero">
            <div class="hero-left-content">
              <div class="hero-tag-app"><div class="hero-tag-dot"></div>FORTIZED PLATFORM</div>
              <h1>Your Community,<br><em>Fortified.</em></h1>
              <p class="hero-sub-app">Join bastions, connect with allies, and build your legacy on the most powerful social platform.</p>
              <div class="home-hero-actions">
                <button class="btn-a" onclick="goDiscover()">üî≠ Discover Bastions</button>
                <button class="btn-g" onclick="openCreateBastion()">‚öîÔ∏è Create Bastion</button>
              </div>
            </div>
            <div class="home-hero-knight">
              <img src="Fortized Knight.png" onerror="this.style.display='none'">
            </div>
          </div>
          <div class="home-marquee">
            <div class="marquee-track" id="marqueeTrack">
              <div class="marquee-item"><span class="mi-icon">‚öîÔ∏è</span><span class="mi-label">Bastions ‚Äî <span class="mi-accent">Your communities</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üí¨</span><span class="mi-label">Messages ‚Äî <span class="mi-accent">Real-time chat</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üîä</span><span class="mi-label">Voice ‚Äî <span class="mi-accent">Talk with friends</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üíé</span><span class="mi-label">Onyx ‚Äî <span class="mi-accent">Premium currency</span></span></div>
              <div class="marquee-item"><span class="mi-icon">‚ú®</span><span class="mi-label">Radiance ‚Äî <span class="mi-accent">Exclusive perks</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üõ°Ô∏è</span><span class="mi-label">Security ‚Äî <span class="mi-accent">Always protected</span></span></div>
              <div class="marquee-item"><span class="mi-icon">‚öîÔ∏è</span><span class="mi-label">Bastions ‚Äî <span class="mi-accent">Your communities</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üí¨</span><span class="mi-label">Messages ‚Äî <span class="mi-accent">Real-time chat</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üîä</span><span class="mi-label">Voice ‚Äî <span class="mi-accent">Talk with friends</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üíé</span><span class="mi-label">Onyx ‚Äî <span class="mi-accent">Premium currency</span></span></div>
              <div class="marquee-item"><span class="mi-icon">‚ú®</span><span class="mi-label">Radiance ‚Äî <span class="mi-accent">Exclusive perks</span></span></div>
              <div class="marquee-item"><span class="mi-icon">üõ°Ô∏è</span><span class="mi-label">Security ‚Äî <span class="mi-accent">Always protected</span></span></div>
            </div>
          </div>
          <div class="home-main-scroll" id="homeMainScroll">
            <div class="section-hdr"><h3>Quick Navigation</h3></div>
            <div class="quick-nav">
              <div class="qn-tile" onclick="goFriends()"><div class="qn-icon" style="background:rgba(96,165,250,.1);">üë•</div><div class="qn-text"><h4>Friends</h4><p>See who's online</p></div></div>
              <div class="qn-tile" onclick="goDiscover()"><div class="qn-icon" style="background:rgba(255,249,62,.08);">üî≠</div><div class="qn-text"><h4>Discover</h4><p>Find new bastions</p></div></div>
              <div class="qn-tile" onclick="goAtelier()"><div class="qn-icon" style="background:rgba(62,207,110,.1);">üíé</div><div class="qn-text"><h4>Atelier</h4><p>Shop & earn Onyx</p></div></div>
              <div class="qn-tile" onclick="openCreateBastion()"><div class="qn-icon" style="background:rgba(248,113,113,.1);">‚öîÔ∏è</div><div class="qn-text"><h4>New Bastion</h4><p>Create community</p></div></div>
            </div>
            <div class="section-hdr"><h3>Recent Activity</h3></div>
            <div id="recentActivity"></div>
          </div>
        </div>
        <div class="home-right">
          <div class="rp-section">
            <div class="rp-title">Notifications</div>
            <div id="homeNotifs"></div>
          </div>
          <div class="rp-section">
            <div class="rp-title">Fortized Updates</div>
            <div class="blog-post"><div class="bp-tag">New</div><div class="bp-title">Voice Channels Now Available</div><div class="bp-date">Feb 2026</div></div>
            <div class="blog-post"><div class="bp-tag">Feature</div><div class="bp-title">Custom Emoji Upload for Bastions</div><div class="bp-date">Jan 2026</div></div>
            <div class="blog-post"><div class="bp-tag">Security</div><div class="bp-title">Enhanced Human Verification</div><div class="bp-date">Jan 2026</div></div>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT VIEW -->
    <div class="view" id="viewChat">
      <div class="chat-wrap">
        <div class="chat-msgs" id="chatMsgs"></div>
        <div class="reply-bar-wrap" id="replyBarWrap">
          <div class="reply-preview">
            <span>‚Ü© Replying to </span><span class="rp-author" id="replyAuthorLabel"></span><span id="replyTextLabel" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:280px;"></span>
            <span class="rp-close" onclick="cancelReply()">‚úï</span>
          </div>
        </div>
        <div class="chat-input-wrap">
          <div class="chat-input-box">
            <div class="chat-input-actions">
              <button onclick="openEmojiPicker(event,'chat')" title="Emoji">üòä</button>
              <button onclick="triggerFileUpload()" title="Attach">üìé</button>
            </div>
            <textarea id="chatInput" placeholder="Message..." rows="1" onkeydown="handleChatKey(event)" oninput="autoResize(this)"></textarea>
            <button class="chat-send" onclick="sendMessage()">‚û§</button>
          </div>
        </div>
      </div>
      <div class="member-list" id="memberList" style="display:none;"></div>
    </div>

    <!-- VOICE VIEW -->
    <div class="view" id="viewVoice">
      <div class="voice-area" id="voiceArea"></div>
    </div>

    <!-- DISCOVER VIEW -->
    <div class="view" id="viewDiscover">
      <div class="discover-scroll">
        <div class="disc-hero">
          <h2>Discover Bastions</h2>
          <p>Find communities that match your interests</p>
          <div class="disc-search"><span class="si">üîç</span><input placeholder="Search bastions..." id="discSearch" oninput="filterBastions(this.value)"></div>
        </div>
        <div class="disc-tabs">
          <div class="disc-tab active" onclick="discTab(this,'all')">All</div>
          <div class="disc-tab" onclick="discTab(this,'gaming')">Gaming</div>
          <div class="disc-tab" onclick="discTab(this,'art')">Art</div>
          <div class="disc-tab" onclick="discTab(this,'tech')">Tech</div>
          <div class="disc-tab" onclick="discTab(this,'music')">Music</div>
        </div>
        <div class="bastion-grid" id="bastionGrid"></div>
      </div>
    </div>

    <!-- ATELIER VIEW -->
    <div class="view" id="viewAtelier">
      <div class="atelier-scroll">
        <div class="atelier-top">
          <div class="atelier-bal">
            <img src="Onyx.png" onerror="this.outerHTML='üíé'">
            <div><h3>Your Onyx Balance</h3><div class="amt" id="atelierOnyx">0</div></div>
          </div>
          <div class="daily-btn" id="dailyBtn" onclick="claimDaily()">
            <span>Daily Reward</span><strong>+50 Onyx</strong>
          </div>
        </div>
        <div class="atelier-section-title">Radiance Subscriptions</div>
        <div class="radiance-grid">
          <div class="rad-card" onclick="buyRadiance(30)"><div class="rad-icon">‚ú®</div><div class="rad-dur">1 Month</div><div class="rad-price">400 <span>Onyx</span></div><div class="rad-feats">Custom banner, animated avatar</div></div>
          <div class="rad-card bv" onclick="buyRadiance(90)"><div class="best-badge">Best Value</div><div class="rad-icon">‚≠ê</div><div class="rad-dur">3 Months</div><div class="rad-price">1000 <span>Onyx</span></div><div class="rad-feats">+Profile effects, exclusive tag</div></div>
          <div class="rad-card" onclick="buyRadiance(365)"><div class="rad-icon">üëë</div><div class="rad-dur">1 Year</div><div class="rad-price">3600 <span>Onyx</span></div><div class="rad-feats">All perks + special title</div></div>
        </div>
        <div class="atelier-section-title">Onyx Packs</div>
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:28px;">
          <div class="rad-card" onclick="buyOnyx(100)"><div class="rad-icon">üíé</div><div class="rad-dur">100 Onyx</div><div class="rad-price" style="font-size:16px;">Free</div></div>
          <div class="rad-card" onclick="buyOnyx(500)"><div class="rad-icon">üíéüíé</div><div class="rad-dur">500 Onyx</div><div class="rad-price" style="font-size:16px;">$4.99</div></div>
          <div class="rad-card" onclick="buyOnyx(1200)"><div class="rad-icon">üíéüíéüíé</div><div class="rad-dur">1200 Onyx</div><div class="rad-price" style="font-size:16px;">$9.99</div></div>
          <div class="rad-card bv" onclick="buyOnyx(3000)"><div class="best-badge">Best</div><div class="rad-icon">üëë</div><div class="rad-dur">3000 Onyx</div><div class="rad-price" style="font-size:16px;">$19.99</div></div>
        </div>
      </div>
    </div>

    <!-- FRIENDS VIEW -->
    <div class="view" id="viewFriends">
      <div style="flex:1;overflow-y:auto;padding:28px;">
        <div style="display:flex;align-items:center;gap:14px;margin-bottom:22px;">
          <h2 style="font-family:'Syne',sans-serif;font-size:20px;font-weight:800;">Friends</h2>
          <button class="btn-a" onclick="openAddFriend()" style="padding:8px 16px;font-size:12.5px;">‚ûï Add Friend</button>
        </div>
        <div class="disc-tabs" style="margin-bottom:18px;">
          <div class="disc-tab active" onclick="friendTab(this,'online')">Online</div>
          <div class="disc-tab" onclick="friendTab(this,'all')">All</div>
          <div class="disc-tab" onclick="friendTab(this,'pending')">Pending <span id="pendingBadge" style="background:var(--red);color:#fff;font-size:9px;padding:1px 5px;border-radius:100px;margin-left:3px;display:none;"></span></div>
          <div class="disc-tab" onclick="friendTab(this,'blocked')">Blocked</div>
        </div>
        <div id="friendsList"></div>
      </div>
    </div>

    <!-- PROFILE VIEW -->
    <div class="view" id="viewProfile">
      <div class="profile-wrap">
        <div class="profile-nav" id="profileNav">
          <div class="profile-nav-item active" onclick="profileTab(this,'myprofile')">üë§ My Profile</div>
          <div class="profile-nav-item" onclick="profileTab(this,'account')">üîí Account</div>
          <div class="profile-nav-item" onclick="profileTab(this,'appearance')">üé® Appearance</div>
          <div class="profile-nav-item" onclick="profileTab(this,'notifications')">üîî Notifications</div>
          <div class="profile-nav-item" onclick="profileTab(this,'privacy')">üõ°Ô∏è Privacy</div>
          <div class="profile-nav-item" style="color:var(--red);" onclick="logOut()">üö™ Log Out</div>
        </div>
        <div class="profile-main" id="profileMain"></div>
      </div>
    </div>

    <!-- BASTION SETTINGS VIEW -->
    <div class="view" id="viewBSettings">
      <div class="bsettings-wrap">
        <div class="bsettings-nav" id="bSettingsNav"></div>
        <div class="bsettings-main" id="bSettingsMain"></div>
      </div>
    </div>
  </div>
</div>
</div><!-- /appShell -->

<!-- NOTIF PANEL -->
<div class="notif-panel" id="notifPanel">
  <div class="np-header">
    <h3>üîî Notifications</h3>
    <button onclick="toggleNotifPanel()">‚úï</button>
  </div>
  <div class="np-list" id="npList"></div>
</div>

<!-- hidden file input for emoji upload -->
<input type="file" id="emojiFileInput" accept="image/*,image/gif" style="display:none;" onchange="handleEmojiFileSelected(event)">
<input type="file" id="pfpFileInput" accept="image/*" style="display:none;" onchange="handlePfpUpload(event)">
<input type="file" id="bannerFileInput" accept="image/*" style="display:none;" onchange="handleBannerUpload(event)">
<input type="file" id="bastionIconInput" accept="image/*" style="display:none;" onchange="handleBastionIconUpload(event)">

<script>
// ===== GLOBALS =====
let CU = null, DB = null;
let curView = 'home', curBastion = null, curChannel = null, curDM = null;
let curVoiceChannel = null, selfMuted = false, selfDeafened = false;
let replyingTo = null, forwardMsg = null, pendingNewChannelType = 'text', pendingAddChannelBIdx = null;
let emojiPickerCallback = null, emojiPickerTab = 'smileys';
let pendingEmojiData = null, pendingEmojiForBastion = null;
let ftDialogResolve = null;
let forwardSelectedTarget = null;

const QUIZ_QUESTIONS = [
  {q:"What color is the sky on a clear day?",opts:["Green","Blue","Red","Yellow"],a:1},
  {q:"How many legs does a cat have?",opts:["2","4","6","8"],a:1},
  {q:"Which planet is closest to the Sun?",opts:["Earth","Mars","Mercury","Venus"],a:2},
  {q:"What shape has 4 equal sides?",opts:["Triangle","Circle","Rectangle","Square"],a:3},
  {q:"What do bees make?",opts:["Milk","Honey","Butter","Jam"],a:1},
  {q:"What is 2 + 2?",opts:["3","4","5","6"],a:1},
  {q:"What do you use to write on paper?",opts:["Fork","Pen","Spoon","Brush"],a:1},
  {q:"What season comes after Winter?",opts:["Summer","Fall","Spring","Autumn"],a:2},
  {q:"How many days are in a week?",opts:["5","6","7","8"],a:2},
  {q:"What sound does a dog make?",opts:["Meow","Moo","Bark","Cluck"],a:2}
];
let secQuestions = [], secIdx = 0, secCorrect = 0, secAnswered = false;

const EMOJI_DATA = {
  'Smileys': ['üòÄ','üòÉ','üòÑ','üòÅ','üòÜ','üòÖ','üòÇ','ü§£','üòä','üòá','üôÇ','üôÉ','üòâ','üòå','üòç','ü•∞','üòò','üòó','üòô','üòö','üòã','üòõ','üòú','ü§™','üòù','ü§ë','ü§ó','ü§≠','ü§´','ü§î','ü§ê','ü§®','üòê','üòë','üò∂','üòè','üòí','üôÑ','üò¨','ü§•','üòî','üò™','ü§§','üò¥','üò∑','ü§í','ü§ï','ü§¢','ü§Æ','ü•µ','ü•∂','üòµ','ü§Ø','üòé','ü•∏','üò≤','üò¶','üòß','üò®','üò∞','üò¢','üò≠','üò§','üò†','üò°','ü§¨','üòà','üëø'],
  'People': ['üëã','ü§ö','üñê','‚úã','üññ','üëå','ü§å','ü§è','‚úåÔ∏è','ü§û','ü§ü','ü§ò','ü§ô','üëà','üëâ','üëÜ','üñï','üëá','‚òùÔ∏è','üëç','üëé','‚úä','üëä','ü§õ','ü§ú','üëè','üôå','üëê','ü§≤','ü§ù','üôè','‚úçÔ∏è','üíÖ','ü§≥','üí™','ü¶æ','ü¶ø','ü¶µ','ü¶∂','üëÇ','ü¶ª','üëÉ','ü´Ä','ü´Å','üß†','ü¶∑','ü¶¥','üëÅ','üëÖ','üëÑ','ü´¶'],
  'Animals': ['üê∂','üê±','üê≠','üêπ','üê∞','ü¶ä','üêª','üêº','üêª‚Äç‚ùÑÔ∏è','üê®','üêØ','ü¶Å','üêÆ','üê∑','üêΩ','üê∏','üêµ','üôà','üôâ','üôä','üêî','üêß','üê¶','üê§','ü¶Ü','ü¶Ö','ü¶â','ü¶á','üê∫','üêó','üê¥','ü¶Ñ','üêù','üêõ','ü¶ã','üêå','üêû','üêú','ü¶ü','ü¶ó','ü¶Ç','üê¢','üêç','ü¶é','ü¶ñ','ü¶ï','üêô','ü¶ë','ü¶ê','ü¶û','ü¶Ä'],
  'Nature': ['üå∏','üíÆ','üèµ','üåπ','ü•Ä','üå∫','üåª','üåº','üå∑','üå±','üå≤','üå≥','üå¥','üåµ','üåæ','üçÄ','üçÅ','üçÇ','üçÉ','üçÑ','üå∞','ü¶î','üåç','üåé','üåè','üåë','üåí','üåì','üåî','üåï','üåñ','üåó','üåò','üåô','üåö','üåõ','üåú','‚òÄÔ∏è','üåù','üåû','‚≠ê','üåü','üí´','‚ú®','‚òÑÔ∏è','‚òÅÔ∏è','‚õÖ','üå§','üå•','üå¶','üåß','‚õà','üå©','üå®','‚ùÑÔ∏è','‚òÉÔ∏è','‚õÑ','üå¨','üí®','üåä','üå´'],
  'Food': ['üçé','üçä','üçã','üçá','üçì','ü´ê','üçà','üçí','üçë','ü•≠','üçç','ü••','ü•ù','üçÖ','ü´í','ü•ë','üçÜ','ü•î','ü•ï','üåΩ','üå∂','ü•í','ü•¨','üßÖ','üßÑ','ü•ú','üå∞','üçû','ü•ê','ü•ñ','ü´ì','üßÄ','ü•ö','üç≥','ü•û','üßá','ü•ì','üçî','üçü','üå≠','üçï','üåÆ','üåØ','ü´î','ü•ô','ü•ó','üçú','üçù','üç≤','ü•ò','üçõ','üç£','üç±'],
  'Sports': ['‚öΩ','üèÄ','üèà','‚öæ','ü•é','üéæ','üèê','üèâ','üé±','üèì','üè∏','ü•Ö','‚õ≥','ü™É','üèπ','üé£','ü§ø','ü•ä','ü•ã','üéΩ','üõπ','üõº','üõ∑','‚õ∏','ü•å','üéø','‚õ∑','üèÇ','üèãÔ∏è','ü§∏','‚õπÔ∏è','ü§∫','üèá','üèä','üö£','üßò','üèÑ','üßó','üöµ'],
  'Gaming': ['üéÆ','üïπ','üëæ','üé≤','‚ôü','üéØ','üé≥','üé∞','üÉè','üÄÑ','üé¥','üß©','üé≠','üé®','üñº','üéß','üé§','üéµ','üé∂','üé∏','üéπ','üé∫','üéª','ü•Å','üé∑','üé¨','üé•','üìΩ','üéû','üìπ'],
  'Objects': ['üíª','üñ•','üñ®','‚å®Ô∏è','üñ±','üñ≤','üíæ','üíø','üì±','üì≤','‚òéÔ∏è','üìû','üìü','üì†','üì∫','üìª','üß≠','‚è±','‚è≤','‚è∞','üï∞','‚åö','üì°','üîã','üîå','üí°','üî¶','üïØ','üßØ','üóë','üõ¢','üí∞','üí¥','üíµ','üí∏','üí≥','ü™ô','üìà','üìâ','üìä','üìã','üìå','üìç','‚úÇÔ∏è','üóÉ','üóÑ','üóë','üîí','üîì','üîè','üîê','üîë','üóù'],
  'Symbols': ['‚ù§Ô∏è','üß°','üíõ','üíö','üíô','üíú','üñ§','ü§ç','ü§é','üíî','‚ù£Ô∏è','üíï','üíû','üíì','üíó','üíñ','üíò','üíù','üíü','‚òÆÔ∏è','‚úùÔ∏è','‚ò™Ô∏è','üïâ','‚ò∏Ô∏è','‚ú°Ô∏è','üîØ','üïé','‚òØÔ∏è','‚ò¶Ô∏è','‚õé','‚ôà','‚ôâ','‚ôä','‚ôã','‚ôå','‚ôç','‚ôé','‚ôè','‚ôê','‚ôë','‚ôí','‚ôì','üÜî','‚öõÔ∏è','üâë','‚ò¢Ô∏è','‚ò£Ô∏è','üì¥','üì≥','üà∂','üàö','üà∏','üà∫','üà∑Ô∏è','‚ú¥Ô∏è','üÜö','üíπ','‚ùáÔ∏è','üõê']
};

const ROLE_COLORS = ['#f87171','#fb923c','#fbbf24','#a3e635','#4ade80','#34d399','#22d3ee','#60a5fa','#818cf8','#c084fc','#f472b6','#94a3b8'];
const PERMISSIONS = ['send_messages','manage_messages','manage_channels','create_channels','delete_channels','manage_roles','assign_roles','kick_members','ban_members','mute_members','read_message_history','mention_everyone','use_external_emojis','manage_emojis','view_audit_log','administrator'];

// ===== INIT =====
window.addEventListener('load', () => {
  try {
    if (typeof firebase === 'undefined') { showLoadError('Firebase not loaded'); return; }
    DB = firebase.database();
    checkAuth();
  } catch(e) { showLoadError(e.message); }
});

function showLoadError(msg) {
  document.getElementById('appLoading').innerHTML = `<div style="color:var(--red);font-size:14px;">‚ùå Load error: ${msg}</div>`;
}

function checkAuth() {
  const savedUser = localStorage.getItem('ftz_user');
  if (savedUser) {
    const udata = JSON.parse(savedUser);
    DB.ref('users/'+udata.username).once('value').then(snap => {
      if (snap.exists()) {
        CU = snap.val();
        CU.username = udata.username;
        const verKey = 'ftz_verified_'+CU.username;
        if (!localStorage.getItem(verKey)) {
          hideLoading();
          startSecurityQuiz(false);
        } else {
          initApp();
        }
      } else {
        showAuthModal();
      }
    }).catch(() => { showAuthModal(); });
  } else {
    showAuthModal();
  }
}

function hideLoading() {
  const l = document.getElementById('appLoading');
  if (l) { l.style.opacity = '0'; l.style.transition = 'opacity .3s'; setTimeout(() => l.remove(), 300); }
}

function initApp() {
  hideLoading();
  document.getElementById('appShell').style.display = 'flex';
  renderUserbar();
  renderRail();
  goHome();
  setupContextMenu();
  checkPendingVerifNotif();
}

// ===== SECURITY QUIZ =====
function startSecurityQuiz(isNotif) {
  const overlay = document.getElementById('securityOverlay');
  overlay.classList.add('open');
  const pool = [...QUIZ_QUESTIONS].sort(() => Math.random() - .5).slice(0, 3);
  secQuestions = pool; secIdx = 0; secCorrect = 0; secAnswered = false;
  renderQuizQuestion();
}

function renderQuizQuestion() {
  const el = document.getElementById('secQuizContent');
  const q = secQuestions[secIdx];
  const dots = secQuestions.map((_, i) => `<div class="sec-dot ${i < secIdx ? 'done' : i === secIdx ? 'current' : ''}"></div>`).join('');
  el.innerHTML = `
    <div class="sec-progress">${dots}</div>
    <div class="sec-question">Q${secIdx+1}. ${q.q}</div>
    <div class="sec-options" id="secOpts">
      ${q.opts.map((o, i) => `<div class="sec-option" onclick="answerQuiz(${i})">${o}</div>`).join('')}
    </div>
    <div style="font-size:12px;color:var(--muted);text-align:center;margin-top:14px;">Question ${secIdx+1} of ${secQuestions.length}</div>
  `;
}

function answerQuiz(idx) {
  if (secAnswered) return;
  secAnswered = true;
  const q = secQuestions[secIdx];
  const opts = document.querySelectorAll('.sec-option');
  opts[idx].classList.add(idx === q.a ? 'correct' : 'wrong');
  if (idx === q.a) opts[q.a].classList.add('correct');
  if (idx === q.a) secCorrect++;
  setTimeout(() => {
    secIdx++;
    secAnswered = false;
    if (secIdx >= secQuestions.length) { finishQuiz(); } else { renderQuizQuestion(); }
  }, 700);
}

function finishQuiz() {
  const el = document.getElementById('secQuizContent');
  const pass = secCorrect >= 2;
  el.innerHTML = `
    <div style="text-align:center;padding:20px 0;">
      <div style="font-size:52px;margin-bottom:12px;">${pass ? '‚úÖ' : '‚ùå'}</div>
      <div style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:6px;">${pass ? 'Verified!' : 'Failed'}</div>
      <div style="font-size:13px;color:var(--muted-light);margin-bottom:18px;">${pass ? 'You passed! Welcome to Fortized.' : `Only ${secCorrect}/3 correct. Try again.`}</div>
      <button class="btn-a" onclick="${pass ? 'completeVerification()' : 'restartQuiz()'}" style="margin:auto;">${pass ? 'üöÄ Enter Fortized' : 'üîÑ Try Again'}</button>
    </div>
  `;
}

function restartQuiz() {
  secIdx = 0; secCorrect = 0; secAnswered = false;
  const pool = [...QUIZ_QUESTIONS].sort(() => Math.random() - .5).slice(0, 3);
  secQuestions = pool;
  renderQuizQuestion();
}

function completeVerification() {
  localStorage.setItem('ftz_verified_'+CU.username, '1');
  document.getElementById('securityOverlay').classList.remove('open');
  document.getElementById('appShell').style.display = 'flex';
  renderUserbar(); renderRail(); goHome();
  setupContextMenu();
  toast('‚úÖ Verification complete!', 'success');
}

function checkPendingVerifNotif() {
  // For existing users: already handled in checkAuth
}

// ===== AUTH MODAL =====
function showAuthModal() {
  hideLoading();
  const overlay = document.createElement('div');
  overlay.className = 'modal-overlay open';
  overlay.style.zIndex = '7000';
  overlay.innerHTML = `
    <div class="modal" style="max-width:400px;">
      <div class="modal-bar"></div>
      <div class="modal-body">
        <div style="text-align:center;margin-bottom:18px;">
          <img src="Fortized icon.png" style="width:48px;height:48px;object-fit:contain;" onerror="this.style.display='none'">
          <div class="modal-title" style="margin-top:8px;">Welcome to Fortized</div>
        </div>
        <div id="authTabs" style="display:flex;gap:6px;margin-bottom:16px;">
          <div class="disc-tab active" id="tabLogin" onclick="switchAuthTab('login')" style="flex:1;text-align:center;cursor:pointer;">Login</div>
          <div class="disc-tab" id="tabRegister" onclick="switchAuthTab('register')" style="flex:1;text-align:center;cursor:pointer;">Register</div>
        </div>
        <div id="authContent"></div>
      </div>
    </div>
  `;
  document.body.appendChild(overlay);
  window._authOverlay = overlay;
  renderLoginForm();
}

function switchAuthTab(tab) {
  document.getElementById('tabLogin').classList.toggle('active', tab==='login');
  document.getElementById('tabRegister').classList.toggle('active', tab==='register');
  if (tab === 'login') renderLoginForm(); else renderRegisterForm();
}

function renderLoginForm() {
  document.getElementById('authContent').innerHTML = `
    <input class="modal-input" id="loginUser" placeholder="Username">
    <input class="modal-input" id="loginPass" placeholder="Password" type="password" onkeydown="if(event.key==='Enter')doLogin()">
    <div class="modal-error" id="loginErr"></div>
    <button class="btn-a" style="width:100%;justify-content:center;" onclick="doLogin()">üöÄ Log In</button>
  `;
}

function renderRegisterForm() {
  document.getElementById('authContent').innerHTML = `
    <input class="modal-input" id="regUser" placeholder="Username (lowercase, no spaces)">
    <input class="modal-input" id="regDisp" placeholder="Display Name">
    <input class="modal-input" id="regPass" placeholder="Password" type="password">
    <input class="modal-input" id="regPass2" placeholder="Confirm Password" type="password" onkeydown="if(event.key==='Enter')doRegister()">
    <div class="modal-error" id="regErr"></div>
    <button class="btn-a" style="width:100%;justify-content:center;" onclick="doRegister()">‚ú® Create Account</button>
  `;
}

function doLogin() {
  const u = document.getElementById('loginUser').value.trim().toLowerCase();
  const p = document.getElementById('loginPass').value;
  if (!u || !p) { document.getElementById('loginErr').textContent = 'Fill all fields'; return; }
  DB.ref('users/'+u).once('value').then(snap => {
    if (!snap.exists()) { document.getElementById('loginErr').textContent = 'User not found'; return; }
    const ud = snap.val();
    if (ud.password !== btoa(p)) { document.getElementById('loginErr').textContent = 'Wrong password'; return; }
    CU = ud; CU.username = u;
    localStorage.setItem('ftz_user', JSON.stringify({username:u}));
    if (window._authOverlay) window._authOverlay.remove();
    const verKey = 'ftz_verified_'+u;
    if (!localStorage.getItem(verKey)) { startSecurityQuiz(true); }
    else { initApp(); }
  });
}

function doRegister() {
  const u = document.getElementById('regUser').value.trim().toLowerCase();
  const d = document.getElementById('regDisp').value.trim();
  const p = document.getElementById('regPass').value;
  const p2 = document.getElementById('regPass2').value;
  const err = document.getElementById('regErr');
  if (!u || !d || !p) { err.textContent = 'Fill all fields'; return; }
  if (!/^[a-z0-9_]+$/.test(u)) { err.textContent = 'Username: lowercase letters, numbers, underscore only'; return; }
  if (p !== p2) { err.textContent = 'Passwords do not match'; return; }
  DB.ref('users/'+u).once('value').then(snap => {
    if (snap.exists()) { err.textContent = 'Username taken'; return; }
    const newUser = { displayName:d, password:btoa(p), status:'online', onyx:100, friends:[], bastions:[], notificationSettings:{dms:true,friendReqs:true,mentions:true,allMessages:false}, created:Date.now() };
    DB.ref('users/'+u).set(newUser).then(() => {
      CU = newUser; CU.username = u;
      localStorage.setItem('ftz_user', JSON.stringify({username:u}));
      if (window._authOverlay) window._authOverlay.remove();
      startSecurityQuiz(false);
    });
  });
}

// ===== CONTEXT MENU =====
function setupContextMenu() {
  document.addEventListener('contextmenu', e => {
    e.preventDefault();
    const msgRow = e.target.closest('.msg-row');
    showGlobalCtxMenu(e.clientX, e.clientY, msgRow ? msgRow.dataset.msgid : null, msgRow);
  });
  document.addEventListener('click', e => {
    if (!e.target.closest('.ctx-menu') && !e.target.closest('#profileCard')) {
      hideCtxMenu(); hideProfileCard();
    }
    if (!e.target.closest('#emojiPickerPopup') && !e.target.closest('.chat-input-actions')) {
      document.getElementById('emojiPickerPopup').style.display = 'none';
    }
  });
}

function hideCtxMenu() { document.getElementById('ctxMenu').style.display = 'none'; }
function hideProfileCard() { document.getElementById('profileCard').style.display = 'none'; }

function showGlobalCtxMenu(x, y, msgId, msgRow) {
  const menu = document.getElementById('ctxMenu');
  let items = '';
  if (msgId && msgRow) {
    const isOwn = msgRow.dataset.author === CU.username;
    items += ctxItem('‚Ü© Reply','replyMsg("'+msgId+'")',false);
    items += ctxItem('‚û° Forward','openForwardModal("'+msgId+'")',false);
    items += ctxItem('üìã Copy Text','copyMsgText("'+msgId+'")',false);
    items += ctxItem('üòä Add Reaction','openReactPicker("'+msgId+'")',false);
    if (curBastion) { items += ctxItem('üìå Pin Message','pinMessage("'+msgId+'")',false); }
    if (isOwn) { items += `<div class="ctx-sep"></div>`; items += ctxItem('‚úèÔ∏è Edit','startEditMsg("'+msgId+'")',false); items += ctxItem('üóë Delete','deleteMsg("'+msgId+'")',true); }
    else { items += ctxItem('üö© Report','toast("Reported","info")',true); }
    items += `<div class="ctx-sep"></div>`;
  }
  items += `<div class="ctx-section-label">Navigation</div>`;
  items += ctxItem('üè† Home','goHome()',false);
  items += ctxItem('üî≠ Discover','goDiscover()',false);
  items += ctxItem('üíé Atelier','goAtelier()',false);
  items += `<div class="ctx-sep"></div>`;
  items += ctxItem('‚ûï Add Friend','openAddFriend()',false);
  items += ctxItem('‚úèÔ∏è New DM','openNewDM()',false);
  items += `<div class="ctx-sep"></div>`;
  items += ctxItem('üîÑ Reload App','location.reload()',false);
  menu.innerHTML = items;
  menu.style.display = 'block';
  menu.style.animation = 'ctxIn .12s ease both';
  positionPopup(menu, x, y);
}

function ctxItem(label, action, danger) {
  return `<div class="ctx-item ${danger?'danger':''}" onclick="${action};hideCtxMenu();">${label}</div>`;
}

function positionPopup(el, x, y) {
  el.style.left = x+'px'; el.style.top = y+'px';
  requestAnimationFrame(() => {
    const r = el.getBoundingClientRect();
    if (r.right > window.innerWidth) el.style.left = (x - r.width)+'px';
    if (r.bottom > window.innerHeight) el.style.top = (y - r.height)+'px';
  });
}

// ===== CUSTOM DIALOGS =====
function ftPrompt(title, placeholder='', sub='') {
  return new Promise(resolve => {
    ftDialogResolve = resolve;
    const o = document.getElementById('ftDialogOverlay');
    document.getElementById('ftDialogTitle').textContent = title;
    document.getElementById('ftDialogSub').textContent = sub;
    const inp = document.getElementById('ftDialogInput');
    inp.style.display = 'block'; inp.value = ''; inp.placeholder = placeholder;
    document.getElementById('ftDialogActions').innerHTML = `
      <button class="btn-g" onclick="ftDialogResolve(null);document.getElementById('ftDialogOverlay').classList.remove('open');">Cancel</button>
      <button class="btn-a" onclick="ftDialogResolve(document.getElementById('ftDialogInput').value||null);document.getElementById('ftDialogOverlay').classList.remove('open');">OK</button>
    `;
    o.classList.add('open');
    setTimeout(() => inp.focus(), 100);
    inp.onkeydown = e => { if (e.key==='Enter') { ftDialogResolve(inp.value||null); o.classList.remove('open'); } if (e.key==='Escape') { ftDialogResolve(null); o.classList.remove('open'); } };
  });
}

function ftConfirm(title, sub='') {
  return new Promise(resolve => {
    ftDialogResolve = resolve;
    const o = document.getElementById('ftDialogOverlay');
    document.getElementById('ftDialogTitle').textContent = title;
    document.getElementById('ftDialogSub').textContent = sub;
    document.getElementById('ftDialogInput').style.display = 'none';
    document.getElementById('ftDialogActions').innerHTML = `
      <button class="btn-g" onclick="ftDialogResolve(false);document.getElementById('ftDialogOverlay').classList.remove('open');">Cancel</button>
      <button class="btn-d" onclick="ftDialogResolve(true);document.getElementById('ftDialogOverlay').classList.remove('open');">Confirm</button>
    `;
    o.classList.add('open');
  });
}

function ftAlert(title, sub='') {
  return new Promise(resolve => {
    ftDialogResolve = resolve;
    const o = document.getElementById('ftDialogOverlay');
    document.getElementById('ftDialogTitle').textContent = title;
    document.getElementById('ftDialogSub').textContent = sub;
    document.getElementById('ftDialogInput').style.display = 'none';
    document.getElementById('ftDialogActions').innerHTML = `
      <button class="btn-a" style="width:100%;justify-content:center;" onclick="ftDialogResolve(true);document.getElementById('ftDialogOverlay').classList.remove('open');">OK</button>
    `;
    o.classList.add('open');
  });
}

// ===== TOAST =====
let toastT = null;
function toast(msg, type='info') {
  const t = document.getElementById('toast');
  t.textContent = msg; t.className = `toast ${type} show`;
  if (toastT) clearTimeout(toastT);
  toastT = setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== USERBAR =====
function renderUserbar() {
  if (!CU) return;
  const av = document.getElementById('userbarAv');
  av.innerHTML = CU.pfp ? `<img src="${CU.pfp}"><div class="ua-ring" id="userbarStatusRing"></div>` : `<span>${(CU.displayName||CU.username)[0].toUpperCase()}</span><div class="ua-ring" id="userbarStatusRing"></div>`;
  const ring = document.getElementById('userbarStatusRing');
  if (ring) { const sc = {online:'var(--green)',away:'var(--yellow)',dnd:'var(--red)',invisible:'#374151'}; ring.style.background = sc[CU.status||'online']||'var(--green)'; }
  document.getElementById('userbarName').textContent = CU.displayName || CU.username;
  document.getElementById('userbarTag').textContent = '@'+CU.username;
  document.getElementById('onyxCount').textContent = CU.onyx || 0;
  document.getElementById('atelierOnyx').textContent = CU.onyx || 0;
}

// ===== RAIL =====
function renderRail() {
  const list = document.getElementById('bastionRailList');
  list.innerHTML = '';
  const bastions = CU.bastions || [];
  bastions.forEach(bid => {
    DB.ref('bastions/'+bid).once('value').then(snap => {
      if (!snap.exists()) return;
      const b = snap.val(); b.id = bid;
      const el = document.createElement('div');
      el.className = 'rail-bastion'+(curBastion && curBastion.id===bid?' active':'');
      el.dataset.tip = b.name;
      el.setAttribute('data-tip', b.name);
      el.onclick = () => openBastion(bid);
      if (b.icon) { el.innerHTML = `<img src="${b.icon}" onerror="this.outerHTML='${(b.name||'B')[0]}'">` ; }
      else { el.textContent = (b.name||'B')[0]; }
      list.appendChild(el);
    });
  });
}

// ===== NAVIGATION =====
function setView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const v = document.getElementById('view'+name.charAt(0).toUpperCase()+name.slice(1));
  if (v) v.classList.add('active');
  curView = name;
  ['railHome','railDiscover','railAtelier','railFriends'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.classList.remove('active');
  });
}

function goHome() {
  setView('Home'); updateTopbar('üè† Home','Your feed & notifications');
  document.getElementById('railHome').classList.add('active');
  document.getElementById('sidebarTitle').textContent = 'Direct Messages';
  document.getElementById('sidebarHeaderActions').innerHTML = '<button onclick="openNewDM()" title="New DM">‚úèÔ∏è</button>';
  renderDMList();
  renderHomeNotifs(); renderRecentActivity();
}

function goDiscover() {
  setView('Discover'); updateTopbar('üî≠ Discover','Find your next community');
  document.getElementById('railDiscover').classList.add('active');
  document.getElementById('sidebarTitle').textContent = 'Discover';
  document.getElementById('sidebarHeaderActions').innerHTML = '';
  document.getElementById('sidebarContent').innerHTML = `<div class="empty-state" style="padding:20px;"><span class="ei" style="font-size:32px;">üî≠</span><p style="font-size:12px;">Search for bastions to the right</p></div>`;
  loadPublicBastions();
}

function goAtelier() {
  setView('Atelier'); updateTopbar('üíé Atelier','Shop & earn Onyx');
  document.getElementById('railAtelier').classList.add('active');
  document.getElementById('sidebarTitle').textContent = 'Atelier';
  document.getElementById('sidebarHeaderActions').innerHTML = '';
  document.getElementById('sidebarContent').innerHTML = `<div class="empty-state" style="padding:20px;"><span class="ei" style="font-size:32px;">üíé</span></div>`;
  document.getElementById('atelierOnyx').textContent = CU.onyx || 0;
  const db = document.getElementById('dailyBtn');
  const lastClaim = parseInt(localStorage.getItem('ftz_daily_'+CU.username)||'0');
  const now = Date.now();
  if (now - lastClaim < 86400000) { db.classList.add('claimed'); db.querySelector('strong').textContent = 'Claimed'; }
  else { db.classList.remove('claimed'); db.querySelector('strong').textContent = '+50 Onyx'; }
}

function goFriends() {
  setView('Friends'); updateTopbar('üë• Friends','Your connections');
  document.getElementById('railFriends').classList.add('active');
  document.getElementById('sidebarTitle').textContent = 'Friends';
  document.getElementById('sidebarHeaderActions').innerHTML = '';
  document.getElementById('sidebarContent').innerHTML = `<div class="empty-state" style="padding:20px;"><span class="ei" style="font-size:32px;">üë•</span></div>`;
  friendTab(document.querySelector('#viewFriends .disc-tab.active') || document.querySelector('#viewFriends .disc-tab'), 'online');
}

function goProfile() {
  setView('Profile'); updateTopbar('üë§ Profile','Your account settings');
  document.getElementById('sidebarTitle').textContent = 'Settings';
  document.getElementById('sidebarHeaderActions').innerHTML = '';
  document.getElementById('sidebarContent').innerHTML = `<div class="empty-state" style="padding:20px;"><span class="ei" style="font-size:32px;">‚öôÔ∏è</span></div>`;
  renderProfileTab('myprofile');
}

function openSettings() { goProfile(); }

function updateTopbar(title, desc) {
  document.getElementById('topbarTitle').textContent = title;
  document.getElementById('topbarDesc').textContent = desc;
  document.getElementById('topbarActions').innerHTML = `
    <div class="onyx-pill" onclick="goAtelier()"><img src="Onyx.png" onerror="this.outerHTML='üíé'" style="width:14px;height:14px;"><span id="onyxCount">${CU.onyx||0}</span></div>
    <div class="tb-search"><span class="si">üîç</span><input placeholder="Search..." id="topSearch" oninput="handleSearch(this.value)"></div>
    <button onclick="toggleNotifPanel()" title="Notifications">üîî</button>
  `;
}

function handleSearch(v) {}

function logOut() {
  localStorage.removeItem('ftz_user');
  location.reload();
}

function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ===== BASTION OPEN =====
function openBastion(bid) {
  DB.ref('bastions/'+bid).once('value').then(snap => {
    if (!snap.exists()) { toast('Bastion not found','error'); return; }
    curBastion = snap.val(); curBastion.id = bid;
    // Join if not member
    if (!CU.bastions) CU.bastions = [];
    if (!CU.bastions.includes(bid)) {
      CU.bastions.push(bid);
      DB.ref('users/'+CU.username+'/bastions').set(CU.bastions);
      if (!curBastion.members) curBastion.members = {};
      curBastion.members[CU.username] = {joinedAt:Date.now(),status:'online'};
      DB.ref('bastions/'+bid+'/members/'+CU.username).set({joinedAt:Date.now(),status:'online'});
    }
    renderBastionSidebar();
    // Open first text channel
    const channels = curBastion.channels || [];
    const firstText = channels.find(c => !c.type || c.type === 'text');
    if (firstText) { openChannel(bid, firstText.id); }
    else { setView('Chat'); document.getElementById('chatMsgs').innerHTML = '<div class="empty-state"><span class="ei">üí¨</span><h3>No channels yet</h3></div>'; }
    renderRail();
    updateTopbar('‚öîÔ∏è '+curBastion.name, curBastion.desc||'');
    document.querySelectorAll('.rail-bastion').forEach(el => el.classList.remove('active'));
  });
}

function renderBastionSidebar() {
  const b = curBastion;
  document.getElementById('sidebarTitle').textContent = b.name || 'Bastion';
  const isOwner = b.owner === CU.username;
  document.getElementById('sidebarHeaderActions').innerHTML = `
    ${isOwner ? '<button onclick="openBastionSettings()" title="Settings">‚öôÔ∏è</button>' : ''}
    <button onclick="openBastionInvite()" title="Invite">üîó</button>
  `;
  const sc = document.getElementById('sidebarContent');
  const channels = b.channels || [];
  const textChs = channels.filter(c => !c.type || c.type === 'text');
  const voiceChs = channels.filter(c => c.type === 'voice');
  let html = '';
  html += `<div class="sec-label">TEXT CHANNELS <button onclick="openAddChannelModal(0)" title="Add channel">+</button></div>`;
  textChs.forEach(ch => {
    const active = curChannel && curChannel.id === ch.id;
    html += `<div class="ch-item ${active?'active':''}" onclick="openChannel('${b.id}','${ch.id}')"># ${ch.name}${isOwner&&channels.length>1?`<button style="margin-left:auto;background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;" onclick="event.stopPropagation();deleteChannel('${ch.id}')">‚úï</button>`:''}
    </div>`;
  });
  html += `<div class="sec-label" style="margin-top:8px;">VOICE CHANNELS <button onclick="openAddChannelModal(0,'voice')" title="Add voice">+</button></div>`;
  voiceChs.forEach(ch => {
    const active = curVoiceChannel && curVoiceChannel.id === ch.id;
    html += `<div class="ch-item ${active?'active':''}" onclick="openVoiceChannel('${ch.id}')">üîä ${ch.name}</div>`;
  });
  if (!textChs.length && !voiceChs.length) html += `<div class="empty-state" style="padding:20px;font-size:12px;"><p>No channels yet</p></div>`;
  // Boost bar
  html += `<div class="boost-bar" onclick="openBastionBoost()"><span>‚ö°</span><span class="bl">Level ${b.boostLevel||0}</span><span style="flex:1;"></span><span style="font-size:11px;color:var(--muted);">Boost</span></div>`;
  sc.innerHTML = html;
}

// ===== CHANNEL =====
function openChannel(bid, chId) {
  if (!curBastion || curBastion.id !== bid) return;
  const ch = (curBastion.channels||[]).find(c => c.id === chId);
  if (!ch) return;
  curChannel = ch; curDM = null;
  setView('Chat');
  document.getElementById('memberList').style.display = 'flex';
  updateTopbar('#'+ch.name, curBastion.name);
  renderBastionSidebar();
  loadMessages('bastions/'+bid+'/channels/'+chId+'/messages');
  renderMemberList();
  setTimeout(renderPinnedBanner, 400);
}

function openDM(user2) {
  curChannel = null; curBastion = null; curDM = user2;
  const key = [CU.username, user2].sort().join('_');
  setView('Chat');
  document.getElementById('memberList').style.display = 'none';
  updateTopbar('üí¨ @'+user2, 'Direct Message');
  loadMessages('dms/'+key+'/messages');
  renderDMList();
}

// ===== MESSAGES =====
let msgListener = null;
function loadMessages(path) {
  if (msgListener) msgListener();
  const el = document.getElementById('chatMsgs');
  el.innerHTML = '<div class="empty-state"><div class="load-spinner"></div></div>';
  const ref = DB.ref(path).limitToLast(60);
  ref.once('value').then(snap => {
    el.innerHTML = '';
    const msgs = [];
    snap.forEach(c => { const m = c.val(); m.id = c.key; msgs.push(m); });
    if (!msgs.length) { el.innerHTML = '<div class="empty-state"><span class="ei">üí¨</span><h3>No messages yet</h3><p>Be the first to say something!</p></div>'; }
    else { renderMessages(msgs, el); }
    el.scrollTop = el.scrollHeight;
  });
  msgListener = ref.on('child_added', snap => {
    const m = snap.val(); m.id = snap.key;
    // Only append if not already in DOM
    if (document.querySelector(`[data-msgid="${m.id}"]`)) return;
    if (el.querySelector('.empty-state')) el.innerHTML = '';
    appendMessage(m, el);
    el.scrollTop = el.scrollHeight;
  });
}

function renderMessages(msgs, el) {
  let prevFrom = null, prevDate = null;
  msgs.forEach((m, i) => {
    const d = new Date(m.timestamp||0).toDateString();
    if (d !== prevDate) {
      const dd = document.createElement('div');
      dd.className = 'date-div'; dd.textContent = d; el.appendChild(dd);
      prevDate = d;
    }
    appendMessage(m, el, prevFrom === m.from);
    prevFrom = m.from;
  });
}

function appendMessage(m, el, isCont) {
  const isOwn = m.from === CU.username;
  const row = document.createElement('div');
  row.className = `msg-row ${isCont?'msg-cont':'msg-first'} ${isOwn?'own':''}`;
  row.dataset.msgid = m.id; row.dataset.author = m.from;
  const t = m.time || formatTime(m.timestamp);
  let replyHtml = '';
  if (m.replyTo) {
    replyHtml = `<div class="msg-reply-ref" onclick="scrollToMsg('${m.replyTo.id}')"><span class="rr-author">${m.replyTo.from}</span>${escapeHtml(m.replyTo.text||'').substring(0,80)}</div>`;
  }
  const reacts = m.reactions ? Object.entries(m.reactions).map(([em, users]) => {
    const mine = users && users[CU.username];
    const count = users ? Object.keys(users).length : 0;
    return `<div class="r-pill ${mine?'mine':''}" onclick="toggleReaction('${m.id}','${em}')">${em} ${count}</div>`;
  }).join('') : '';
  if (isCont) {
    row.innerHTML = `
      <div class="msg-av-wrap"><div class="msg-time-small">${t}</div></div>
      <div class="msg-content-col">
        ${replyHtml}
        ${m.deleted ? '<div class="msg-text" style="opacity:.4;font-style:italic;">Message deleted</div>' : `<div class="msg-text" id="mt_${m.id}">${renderText(m.text||'')}${m.imageData ? `<div style="margin-top:6px;"><img src="${m.imageData}" alt="${escapeHtml(m.imageName||'img')}" style="max-width:320px;max-height:260px;border-radius:8px;cursor:pointer;display:block;" onclick="this.style.maxWidth=this.style.maxWidth==='100%'?'320px':'100%'"></div>` : ''}${m.fileData ? `<div style="margin-top:6px;background:var(--bg2);border-radius:8px;padding:10px 14px;display:inline-flex;align-items:center;gap:10px;max-width:300px;"><span style="font-size:22px;">üìé</span><div><div style="font-size:13px;font-weight:600;word-break:break-all;">${escapeHtml(m.fileName||'file')}</div><div style="font-size:11px;color:var(--muted);">${m.fileSize||''}</div></div><a href="${m.fileData}" download="${escapeHtml(m.fileName||'file')}" style="margin-left:auto;color:var(--accent);font-size:20px;text-decoration:none;padding-left:10px;">‚¨á</a></div>` : ''}</div>`}
        ${m.edited && !m.deleted ? '<span class="msg-edited-tag">(edited)</span>' : ''}
        <div class="msg-reactions">${reacts}</div>
        <div class="msg-edit-box" id="editBox_${m.id}"><textarea class="msg-edit-input" id="editInput_${m.id}"></textarea><div class="msg-edit-actions"><button class="btn-a" style="padding:4px 12px;font-size:12px;" onclick="saveEditMsg('${m.id}')">Save</button><button class="btn-g" style="padding:4px 12px;font-size:12px;" onclick="cancelEditMsg('${m.id}')">Cancel</button></div></div>
      </div>
      ${!m.deleted ? msgActsHtml(m.id, isOwn) : ''}
    `;
  } else {
    row.innerHTML = `
      <div class="msg-av-wrap">${avatarHtml(m.from, 36)}</div>
      <div class="msg-content-col">
        <div class="msg-header"><span class="msg-author" onclick="showProfileCard(event,'${m.from}')">${m.fromDisplay||m.from}</span><span class="msg-timestamp">${t}</span></div>
        ${replyHtml}
        ${m.deleted ? '<div class="msg-text" style="opacity:.4;font-style:italic;">Message deleted</div>' : `<div class="msg-text" id="mt_${m.id}">${renderText(m.text||'')}${m.imageData ? `<div style="margin-top:6px;"><img src="${m.imageData}" alt="${escapeHtml(m.imageName||'img')}" style="max-width:320px;max-height:260px;border-radius:8px;cursor:pointer;display:block;" onclick="this.style.maxWidth=this.style.maxWidth==='100%'?'320px':'100%'"></div>` : ''}${m.fileData ? `<div style="margin-top:6px;background:var(--bg2);border-radius:8px;padding:10px 14px;display:inline-flex;align-items:center;gap:10px;max-width:300px;"><span style="font-size:22px;">üìé</span><div><div style="font-size:13px;font-weight:600;word-break:break-all;">${escapeHtml(m.fileName||'file')}</div><div style="font-size:11px;color:var(--muted);">${m.fileSize||''}</div></div><a href="${m.fileData}" download="${escapeHtml(m.fileName||'file')}" style="margin-left:auto;color:var(--accent);font-size:20px;text-decoration:none;padding-left:10px;">‚¨á</a></div>` : ''}</div>`}
        ${m.edited && !m.deleted ? '<span class="msg-edited-tag">(edited)</span>' : ''}
        <div class="msg-reactions">${reacts}</div>
        <div class="msg-edit-box" id="editBox_${m.id}"><textarea class="msg-edit-input" id="editInput_${m.id}"></textarea><div class="msg-edit-actions"><button class="btn-a" style="padding:4px 12px;font-size:12px;" onclick="saveEditMsg('${m.id}')">Save</button><button class="btn-g" style="padding:4px 12px;font-size:12px;" onclick="cancelEditMsg('${m.id}')">Cancel</button></div></div>
      </div>
      ${!m.deleted ? msgActsHtml(m.id, isOwn) : ''}
    `;
  }
  el.appendChild(row);
}

function msgActsHtml(id, isOwn) {
  return `<div class="msg-acts">
    <button title="Reply" onclick="replyMsg('${id}')">‚Ü©</button>
    <button title="React" onclick="openReactPicker('${id}')">üòä</button>
    <button title="Forward" onclick="openForwardModal('${id}')">‚û°</button>
    ${curBastion ? `<button title="Pin" onclick="pinMessage('${id}')">üìå</button>` : ''}
    ${isOwn ? `<button title="Edit" onclick="startEditMsg('${id}')">‚úèÔ∏è</button><button title="Delete" onclick="deleteMsg('${id}')">üóë</button>` : '<button title="Report" onclick="toast(\'Reported\',\'info\')">üö©</button>'}
  </div>`;
}

function avatarHtml(username, size) {
  const users_cache = window._usersCache || {};
  if (users_cache[username] && users_cache[username].pfp) {
    return `<div class="msg-av-inner" style="width:${size}px;height:${size}px;" onclick="showProfileCard(event,'${username}')"><img src="${users_cache[username].pfp}"></div>`;
  }
  // async load
  if (!window._usersCache) window._usersCache = {};
  if (!window._usersCache[username]) {
    window._usersCache[username] = {loading:true};
    DB.ref('users/'+username+'/pfp').once('value').then(s => {
      window._usersCache[username] = {pfp: s.val()||null};
      document.querySelectorAll(`[data-author="${username}"] .msg-av-inner img`).forEach(img => { if (s.val()) img.src = s.val(); });
    });
  }
  const letter = username ? username[0].toUpperCase() : '?';
  return `<div class="msg-av-inner" style="width:${size}px;height:${size}px;" onclick="showProfileCard(event,'${username}')">${letter}</div>`;
}

function renderText(txt) {
  let t = escapeHtml(txt);
  t = t.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.*?)\*/g, '<em>$1</em>');
  t = t.replace(/`(.*?)`/g, '<code>$1</code>');
  return t;
}

function escapeHtml(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

function formatTime(ts) {
  if (!ts) return '';
  const d = new Date(ts);
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}

function getMsgPath() {
  if (curChannel && curBastion) return 'bastions/'+curBastion.id+'/channels/'+curChannel.id+'/messages';
  if (curDM) return 'dms/'+[CU.username,curDM].sort().join('_')+'/messages';
  return null;
}

function sendMessage() {
  const inp = document.getElementById('chatInput');
  const text = inp.value.trim();
  if (!text) return;
  const path = getMsgPath(); if (!path) return;
  const msgData = {
    from: CU.username, fromDisplay: CU.displayName||CU.username,
    text, timestamp: Date.now(), time: formatTime(Date.now())
  };
  if (replyingTo) { msgData.replyTo = {id:replyingTo.id, from:replyingTo.from, text:replyingTo.text}; cancelReply(); }
  DB.ref(path).push(msgData);
  inp.value = ''; inp.style.height = 'auto';
}

function handleChatKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120)+'px'; }

// ===== MESSAGE ACTIONS =====
function replyMsg(id) {
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const textEl = row.querySelector('.msg-text');
  replyingTo = {id, from: row.dataset.author, text: textEl ? textEl.textContent : ''};
  document.getElementById('replyBarWrap').style.display = 'block';
  document.getElementById('replyAuthorLabel').textContent = replyingTo.from;
  document.getElementById('replyTextLabel').textContent = ' '+replyingTo.text.substring(0,60);
  document.getElementById('chatInput').focus();
}

function cancelReply() {
  replyingTo = null;
  document.getElementById('replyBarWrap').style.display = 'none';
}

function startEditMsg(id) {
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const textEl = row.querySelector(`#mt_${id}`);
  const box = document.getElementById('editBox_'+id);
  const inp = document.getElementById('editInput_'+id);
  if (!textEl || !box || !inp) return;
  inp.value = textEl.textContent;
  box.classList.add('active');
  textEl.style.display = 'none';
  inp.focus();
  inp.onkeydown = e => { if (e.key==='Enter'&&!e.shiftKey){e.preventDefault();saveEditMsg(id);} if(e.key==='Escape') cancelEditMsg(id); };
}

function saveEditMsg(id) {
  const inp = document.getElementById('editInput_'+id);
  if (!inp) return;
  const newText = inp.value.trim();
  if (!newText) return;
  const path = getMsgPath(); if (!path) return;
  DB.ref(path+'/'+id).update({text:newText, edited:true});
  const textEl = document.getElementById('mt_'+id);
  if (textEl) { textEl.innerHTML = renderText(newText); textEl.style.display = ''; }
  const box = document.getElementById('editBox_'+id);
  if (box) box.classList.remove('active');
  toast('Message edited', 'success');
}

function cancelEditMsg(id) {
  const box = document.getElementById('editBox_'+id);
  if (box) box.classList.remove('active');
  const textEl = document.getElementById('mt_'+id);
  if (textEl) textEl.style.display = '';
}

function deleteMsg(id) {
  ftConfirm('Delete Message?', 'This cannot be undone.').then(ok => {
    if (!ok) return;
    const path = getMsgPath(); if (!path) return;
    DB.ref(path+'/'+id).update({deleted:true, text:'', reactions:null});
    const row = document.querySelector(`[data-msgid="${id}"]`);
    if (row) {
      const t = row.querySelector('.msg-text');
      if (t) { t.style.opacity='.4'; t.style.fontStyle='italic'; t.textContent='Message deleted'; }
      const acts = row.querySelector('.msg-acts');
      if (acts) acts.remove();
    }
    toast('Message deleted', 'success');
  });
}

function copyMsgText(id) {
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const t = row.querySelector('.msg-text');
  if (t) { navigator.clipboard.writeText(t.textContent).then(() => toast('Copied!','success')); }
}

function openReactPicker(id) {
  const quickEmojis = ['üëç','‚ù§Ô∏è','üòÇ','üòÆ','üò¢','üò°','üéâ','üî•','üíØ','‚úÖ'];
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const acts = row.querySelector('.msg-acts');
  if (!acts) return;
  let menu = document.createElement('div');
  menu.style.cssText = 'position:absolute;right:0;top:calc(100%+5px);background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:6px 8px;display:flex;gap:4px;z-index:100;';
  quickEmojis.forEach(e => {
    const b = document.createElement('span');
    b.textContent = e; b.style.cssText = 'cursor:pointer;font-size:18px;padding:3px;border-radius:6px;';
    b.onmouseover = () => b.style.background = 'rgba(255,255,255,.1)';
    b.onmouseout = () => b.style.background = '';
    b.onclick = () => { toggleReaction(id, e); menu.remove(); };
    menu.appendChild(b);
  });
  acts.style.position = 'relative';
  acts.appendChild(menu);
  setTimeout(() => { document.addEventListener('click', () => menu.remove(), {once:true}); }, 50);
}

function toggleReaction(id, emoji) {
  const path = getMsgPath(); if (!path) return;
  const rPath = path+'/'+id+'/reactions/'+emoji+'/'+CU.username;
  DB.ref(rPath).once('value').then(snap => {
    if (snap.exists()) { DB.ref(rPath).remove(); }
    else { DB.ref(rPath).set(true); }
    // Update UI optimistically
    const row = document.querySelector(`[data-msgid="${id}"]`);
    if (row) {
      const reactsEl = row.querySelector('.msg-reactions');
      DB.ref(path+'/'+id+'/reactions').once('value').then(s => {
        const reacts = s.val() || {};
        reactsEl.innerHTML = Object.entries(reacts).map(([em, users]) => {
          const mine = users && users[CU.username];
          const count = Object.keys(users).length;
          return `<div class="r-pill ${mine?'mine':''}" onclick="toggleReaction('${id}','${em}')">${em} ${count}</div>`;
        }).join('');
      });
    }
  });
}

function scrollToMsg(id) {
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (row) { row.scrollIntoView({behavior:'smooth',block:'center'}); row.style.background='rgba(255,249,62,.05)'; setTimeout(()=>row.style.background='',1500); }
}

// ===== FORWARD =====
function openForwardModal(id) {
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const t = row.querySelector('.msg-text');
  forwardMsg = {id, text: t ? t.textContent : ''};
  forwardSelectedTarget = null;
  const list = document.getElementById('forwardList');
  list.innerHTML = '<div style="font-size:12px;color:var(--muted);margin-bottom:8px;">DM or Bastion Channel</div>';
  // Friends
  const friends = CU.friends || [];
  friends.forEach(f => {
    const el = document.createElement('div');
    el.className = 'forward-item';
    el.innerHTML = `<input type="radio" name="fwd" value="dm:${f}"><div style="flex:1;font-size:13.5px;">üí¨ @${f}</div>`;
    el.onclick = () => { forwardSelectedTarget = 'dm:'+f; el.querySelector('input').checked = true; };
    list.appendChild(el);
  });
  // Bastion channels
  (CU.bastions||[]).forEach(bid => {
    DB.ref('bastions/'+bid).once('value').then(snap => {
      if (!snap.exists()) return;
      const b = snap.val();
      (b.channels||[]).filter(c=>!c.type||c.type==='text').forEach(ch => {
        const el = document.createElement('div');
        el.className = 'forward-item';
        el.innerHTML = `<input type="radio" name="fwd" value="ch:${bid}:${ch.id}"><div style="flex:1;font-size:13.5px;">#${ch.name} <span style="color:var(--muted);font-size:11px;">${b.name}</span></div>`;
        el.onclick = () => { forwardSelectedTarget = 'ch:'+bid+':'+ch.id; el.querySelector('input').checked = true; };
        list.appendChild(el);
      });
    });
  });
  document.getElementById('forwardOverlay').classList.add('open');
}

function closeForward() { document.getElementById('forwardOverlay').classList.remove('open'); }

function confirmForward() {
  if (!forwardSelectedTarget || !forwardMsg) { toast('Select a destination','error'); return; }
  const parts = forwardSelectedTarget.split(':');
  let path;
  if (parts[0]==='dm') { path = 'dms/'+[CU.username,parts[1]].sort().join('_')+'/messages'; }
  else { path = 'bastions/'+parts[1]+'/channels/'+parts[2]+'/messages'; }
  DB.ref(path).push({
    from: CU.username, fromDisplay: CU.displayName||CU.username,
    text: '‚Ü© Forwarded: '+forwardMsg.text,
    timestamp: Date.now(), time: formatTime(Date.now())
  });
  closeForward(); toast('Message forwarded!','success');
}

// ===== EMOJI PICKER =====
function openEmojiPicker(event, target) {
  event.stopPropagation();
  emojiPickerCallback = target;
  const popup = document.getElementById('emojiPickerPopup');
  buildEmojiPickerTabs();
  popup.style.display = 'block';
  const btn = event.currentTarget || event.target;
  const r = btn.getBoundingClientRect();
  popup.style.left = r.left+'px';
  popup.style.top = (r.top - 420)+'px';
  requestAnimationFrame(() => {
    const pr = popup.getBoundingClientRect();
    if (pr.right > window.innerWidth) popup.style.left = (window.innerWidth - pr.width - 10)+'px';
    if (pr.top < 0) popup.style.top = (r.bottom+5)+'px';
  });
}

function buildEmojiPickerTabs() {
  const popup = document.getElementById('emojiPickerPopup');
  const categoryIcons = {'Smileys':'üòÄ','People':'üëã','Animals':'üê∂','Nature':'üå∏','Food':'üçé','Sports':'‚öΩ','Gaming':'üéÆ','Objects':'üíª','Symbols':'‚ù§Ô∏è'};
  const tabIcons = Object.entries(categoryIcons).map(([cat,ic]) => `<div class="ep-tab ${emojiPickerTab===cat?'active':''}" onclick="switchEmojiTab('${cat}')" title="${cat}">${ic}</div>`).join('');
  const customEmojis = curBastion && curBastion.customEmojis ? curBastion.customEmojis : [];
  const customTab = customEmojis.length ? `<div class="ep-tab ${emojiPickerTab==='custom'?'active':''}" onclick="switchEmojiTab('custom')" title="Custom">‚≠ê</div>` : '';
  popup.innerHTML = `
    <div class="ep-search"><input placeholder="Search emoji..." oninput="searchEmoji(this.value)" id="emojiSearchInput"></div>
    <div class="ep-tabs">${tabIcons}${customTab}</div>
    <div class="ep-grid" id="emojiGrid"></div>
  `;
  renderEmojiPickerGrid(emojiPickerTab);
}

function switchEmojiTab(tab) {
  emojiPickerTab = tab;
  buildEmojiPickerTabs();
}

function renderEmojiPickerGrid(tab) {
  const grid = document.getElementById('emojiGrid');
  if (!grid) return;
  if (tab === 'custom') {
    const emojis = curBastion && curBastion.customEmojis ? curBastion.customEmojis : [];
    if (!emojis.length) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:20px;font-size:12px;color:var(--muted);">No custom emojis yet</div>'; return; }
    grid.innerHTML = emojis.map(e => `<div class="ep-emoji" title=":${e.name}:" onclick="selectEmoji(':${e.name}:')"><img src="${e.data}" style="width:28px;height:28px;object-fit:contain;border-radius:4px;"></div>`).join('');
    return;
  }
  const ems = EMOJI_DATA[tab] || [];
  grid.innerHTML = `<div class="ep-section-label">${tab}</div>` + ems.map(e => `<div class="ep-emoji" onclick="selectEmoji('${e}')">${e}</div>`).join('');
}

function searchEmoji(q) {
  if (!q) { renderEmojiPickerGrid(emojiPickerTab); return; }
  const grid = document.getElementById('emojiGrid');
  const all = Object.values(EMOJI_DATA).flat();
  const matches = all.filter(() => true).slice(0, 40);
  grid.innerHTML = matches.map(e => `<div class="ep-emoji" onclick="selectEmoji('${e}')">${e}</div>`).join('');
}

function selectEmoji(emoji) {
  document.getElementById('emojiPickerPopup').style.display = 'none';
  const inp = document.getElementById('chatInput');
  if (inp) {
    const start = inp.selectionStart;
    const end = inp.selectionEnd;
    inp.value = inp.value.slice(0,start) + emoji + inp.value.slice(end);
    inp.selectionStart = inp.selectionEnd = start + emoji.length;
    inp.focus();
  }
}

// ===== VOICE CHANNELS =====
function openVoiceChannel(chId) {
  if (!curBastion) return;
  const ch = (curBastion.channels||[]).find(c => c.id === chId);
  if (!ch) return;
  curVoiceChannel = ch; selfMuted = false; selfDeafened = false;
  setView('Voice');
  updateTopbar('üîä '+ch.name, curBastion.name + ' ‚Ä¢ Voice');
  renderVoiceChannel();
  renderBastionSidebar();
}

function renderVoiceChannel() {
  const area = document.getElementById('voiceArea');
  const participants = [
    {username: CU.username, displayName: CU.displayName||CU.username, pfp: CU.pfp, muted: selfMuted, speaking: !selfMuted}
  ];
  area.innerHTML = `
    <div class="voice-active-panel">
      <div style="font-family:'Syne',sans-serif;font-size:16px;font-weight:700;margin-bottom:18px;text-align:center;">üîä ${curVoiceChannel.name}</div>
      <div class="voice-participants" id="voiceParticipants">
        ${participants.map(p => `
          <div class="voice-participant ${p.speaking&&!p.muted?'speaking':''}">
            <div class="vp-av">${p.pfp?`<img src="${p.pfp}">`:`<span style="font-size:24px;">${(p.displayName||p.username)[0].toUpperCase()}</span>`}</div>
            <div class="vp-name">${p.displayName||p.username}${p.username===CU.username?' (You)':''}</div>
            <div class="vp-status">${p.muted?'üîá Muted':p.speaking?'üéôÔ∏è Speaking':'üéôÔ∏è Connected'}</div>
          </div>
        `).join('')}
      </div>
      <div class="voice-controls">
        <button class="vc-btn ${selfMuted?'active':''}" onclick="toggleSelfMute()" title="${selfMuted?'Unmute':'Mute'}">${selfMuted?'üîá':'üéôÔ∏è'}</button>
        <button class="vc-btn ${selfDeafened?'active':''}" onclick="toggleSelfDeafen()" title="${selfDeafened?'Undeafen':'Deafen'}">${selfDeafened?'üîï':'üéß'}</button>
        <button class="vc-btn" onclick="toggleScreenShare()" title="Screen Share">üñ•Ô∏è</button>
        <button class="vc-btn end" onclick="leaveVoice()" title="Leave">üìû</button>
      </div>
    </div>
  `;
}

function toggleSelfMute() {
  selfMuted = !selfMuted;
  renderVoiceChannel();
  toast(selfMuted?'Muted':'Unmuted', 'info');
}

function toggleSelfDeafen() {
  selfDeafened = !selfDeafened;
  renderVoiceChannel();
  toast(selfDeafened?'Deafened':'Undeafened', 'info');
}

function toggleScreenShare() { toast('Screen share not available in browser','info'); }

function leaveVoice() {
  curVoiceChannel = null;
  const firstText = (curBastion.channels||[]).find(c=>!c.type||c.type==='text');
  if (firstText) { openChannel(curBastion.id, firstText.id); }
  else { goHome(); }
  toast('Left voice channel', 'info');
}

// ===== MEMBER LIST =====
function renderMemberList() {
  const ml = document.getElementById('memberList');
  if (!curBastion) { ml.style.display = 'none'; return; }
  ml.innerHTML = '<div class="ml-role-header">ONLINE ‚Äî 0</div>';
  const members = curBastion.members || {};
  const roles = curBastion.roles || [];
  const memberRoles = curBastion.memberRoles || {};
  // Group by role
  const online = Object.keys(members);
  if (!online.length) { ml.innerHTML += '<div style="padding:10px 14px;font-size:12px;color:var(--muted);">No members online</div>'; return; }
  ml.innerHTML = `<div class="ml-role-header">MEMBERS ‚Äî ${online.length}</div>`;
  online.forEach(uname => {
    const role = roles.find(r => (memberRoles[uname]||[]).includes(r.id));
    const roleColor = role ? role.color : 'var(--muted-light)';
    const letter = uname[0].toUpperCase();
    const cachedUser = window._usersCache && window._usersCache[uname];
    const pfpHtml = (cachedUser && cachedUser.pfp) ? `<img src="${cachedUser.pfp}">` : letter;
    const roleBadge = role ? `<span class="bastion-tag" style="color:${role.color};border-color:${role.color};">${role.name}</span>` : '';
    ml.innerHTML += `
      <div class="ml-entry" onclick="showProfileCard(event,'${uname}')">
        <div class="ml-av"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">${pfpHtml}</div><div class="ml-status online"></div></div>
        <div class="ml-info"><div class="ml-name" style="color:${roleColor};">${uname}${roleBadge}</div></div>
      </div>`;
  });
  // Load pfps async
  online.forEach(uname => { if (!window._usersCache || !window._usersCache[uname]) avatarHtml(uname, 30); });
}

// ===== PROFILE CARD =====
function showProfileCard(e, username) {
  e.stopPropagation();
  const card = document.getElementById('profileCard');
  card.style.display = 'block';
  card.innerHTML = '<div style="padding:14px;text-align:center;"><div class="load-spinner" style="margin:auto;"></div></div>';
  positionPopup(card, e.clientX, e.clientY);
  DB.ref('users/'+username).once('value').then(snap => {
    if (!snap.exists()) return;
    const u = snap.val(); u.username = username;
    const isMe = username === CU.username;
    const isFriend = (CU.friends||[]).includes(username);
    const isOwner = curBastion && curBastion.owner === CU.username;
    let roleHtml = '';
    if (isOwner && !isMe && curBastion) {
      const roles = curBastion.roles || [];
      const memberRoles = curBastion.memberRoles || {};
      const userRoles = memberRoles[username] || [];
      roleHtml = `<div style="padding:8px 14px;border-top:1px solid var(--border);">
        <div style="font-size:10.5px;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;">ROLES</div>
        ${roles.map(r => `<label style="display:flex;align-items:center;gap:7px;padding:5px 0;cursor:pointer;">
          <input type="checkbox" ${userRoles.includes(r.id)?'checked':''} onchange="toggleUserRole('${username}','${r.id}',this.checked)" style="accent-color:var(--accent);">
          <span class="role-dot" style="background:${r.color};"></span>
          <span style="font-size:13px;">${r.name}</span>
        </label>`).join('')}
      </div>`;
    }
    card.innerHTML = `
      <div style="background:linear-gradient(135deg,#1a2040,#0d1425);height:70px;position:relative;border-radius:18px 18px 0 0;overflow:hidden;">
        ${u.banner?`<img src="${u.banner}" style="width:100%;height:100%;object-fit:cover;">`:'' }
      </div>
      <div style="padding:0 14px 0;margin-top:-24px;position:relative;">
        <div style="width:48px;height:48px;border-radius:50%;background:var(--panel);border:3px solid var(--panel);font-size:18px;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-bottom:8px;">
          ${u.pfp?`<img src="${u.pfp}" style="width:100%;height:100%;object-fit:cover;">`:(u.displayName||username)[0].toUpperCase()}
        </div>
        <div style="font-family:'Syne',sans-serif;font-size:15px;font-weight:800;">${u.displayName||username}</div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:10px;">@${username}</div>
        ${!isMe ? `<div style="display:flex;gap:7px;margin-bottom:10px;">
          <button class="btn-a" style="padding:6px 14px;font-size:12px;" onclick="openDM('${username}');hideProfileCard();">üí¨ Message</button>
          ${!isFriend?`<button class="btn-g" style="padding:6px 14px;font-size:12px;" onclick="sendFriendReq('${username}');hideProfileCard();">‚ûï Add Friend</button>`:``}
        </div>` : ''}
      </div>
      ${roleHtml}
    `;
  });
}

function toggleUserRole(username, roleId, add) {
  if (!curBastion) return;
  const path = 'bastions/'+curBastion.id+'/memberRoles/'+username;
  DB.ref(path).once('value').then(snap => {
    let roles = snap.val() || [];
    if (add) { if (!roles.includes(roleId)) roles.push(roleId); }
    else { roles = roles.filter(r => r !== roleId); }
    DB.ref(path).set(roles);
    if (!curBastion.memberRoles) curBastion.memberRoles = {};
    curBastion.memberRoles[username] = roles;
    toast(add?'Role assigned':'Role removed', 'success');
    renderMemberList();
  });
}

// ===== DM LIST =====
function renderDMList() {
  const sc = document.getElementById('sidebarContent');
  const friends = CU.friends || [];
  if (!friends.length) { sc.innerHTML = `<div class="empty-state" style="padding:18px;"><span class="ei" style="font-size:28px;">üí¨</span><p style="font-size:12px;">No DMs yet. Add friends to chat!</p></div>`; return; }
  sc.innerHTML = '';
  friends.forEach(f => {
    const el = document.createElement('div');
    el.className = 'friend-item'+(curDM===f?' active':'');
    el.innerHTML = `<div class="fa" style="width:32px;height:32px;">${avatarHtml(f,32)}<span class="fs online"></span></div><div class="fi-info"><div class="fi-name">${f}</div><div class="fi-sub">Click to message</div></div>`;
    el.onclick = () => openDM(f);
    sc.appendChild(el);
  });
}

// ===== FRIENDS =====
function friendTab(el, tab) {
  document.querySelectorAll('#viewFriends .disc-tab').forEach(t => t.classList.remove('active'));
  if (el) el.classList.add('active');
  const list = document.getElementById('friendsList');
  const friends = CU.friends || [];
  const pending = CU.pendingFriendRequests || {};
  if (tab === 'online' || tab === 'all') {
    if (!friends.length) { list.innerHTML = '<div class="empty-state"><span class="ei">üë•</span><h3>No friends yet</h3><p>Search for users to add them</p></div>'; return; }
    list.innerHTML = '';
    friends.forEach(f => {
      const el = document.createElement('div');
      el.className = 'activity-item';
      el.innerHTML = `${avatarHtml(f,40)}<div class="act-text"><p style="font-weight:700;">${f}</p><p style="font-size:12px;color:var(--muted);">Friend</p></div><button class="btn-a" style="padding:7px 14px;font-size:12px;" onclick="openDM('${f}');goHome();">üí¨ Message</button><button class="btn-d" style="padding:7px 14px;font-size:12px;" onclick="removeFriend('${f}')">Remove</button>`;
      list.appendChild(el);
    });
  } else if (tab === 'pending') {
    const reqs = Object.entries(pending).filter(([,v]) => v === 'received');
    if (!reqs.length) { list.innerHTML = '<div class="empty-state"><span class="ei">üì¨</span><h3>No pending requests</h3></div>'; return; }
    list.innerHTML = '';
    reqs.forEach(([f]) => {
      const el = document.createElement('div');
      el.className = 'activity-item';
      el.innerHTML = `${avatarHtml(f,40)}<div class="act-text"><p style="font-weight:700;">${f}</p><p style="font-size:12px;color:var(--muted);">Incoming request</p></div><button class="btn-a" style="padding:7px 14px;font-size:12px;" onclick="acceptFriend('${f}')">Accept</button><button class="btn-g" style="padding:7px 14px;font-size:12px;" onclick="declineFriend('${f}')">Decline</button>`;
      list.appendChild(el);
    });
  } else {
    list.innerHTML = '<div class="empty-state"><span class="ei">üö´</span><h3>No blocked users</h3></div>';
  }
}

function openAddFriend() {
  ftPrompt('Add Friend', 'Enter username', 'Send a friend request').then(username => {
    if (!username) return;
    username = username.trim().toLowerCase();
    if (username === CU.username) { toast('That is you!','error'); return; }
    DB.ref('users/'+username).once('value').then(snap => {
      if (!snap.exists()) { toast('User not found','error'); return; }
      // Send request
      DB.ref('users/'+username+'/pendingFriendRequests/'+CU.username).set('received');
      if (!CU.pendingFriendRequests) CU.pendingFriendRequests = {};
      CU.pendingFriendRequests[username] = 'sent';
      DB.ref('users/'+CU.username+'/pendingFriendRequests/'+username).set('sent');
      toast('Friend request sent to @'+username,'success');
    });
  });
}

function sendFriendReq(username) {
  DB.ref('users/'+username).once('value').then(snap => {
    if (!snap.exists()) { toast('User not found','error'); return; }
    DB.ref('users/'+username+'/pendingFriendRequests/'+CU.username).set('received');
    DB.ref('users/'+CU.username+'/pendingFriendRequests/'+username).set('sent');
    toast('Friend request sent!','success');
  });
}

function acceptFriend(username) {
  if (!CU.friends) CU.friends = [];
  CU.friends.push(username);
  DB.ref('users/'+CU.username+'/friends').set(CU.friends);
  DB.ref('users/'+username+'/friends').once('value').then(s => {
    const f = s.val() || [];
    if (!f.includes(CU.username)) f.push(CU.username);
    DB.ref('users/'+username+'/friends').set(f);
  });
  DB.ref('users/'+CU.username+'/pendingFriendRequests/'+username).remove();
  DB.ref('users/'+username+'/pendingFriendRequests/'+CU.username).remove();
  if (CU.pendingFriendRequests) delete CU.pendingFriendRequests[username];
  toast('@'+username+' is now your friend!','success');
  renderDMList();
}

function declineFriend(username) {
  DB.ref('users/'+CU.username+'/pendingFriendRequests/'+username).remove();
  DB.ref('users/'+username+'/pendingFriendRequests/'+CU.username).remove();
  if (CU.pendingFriendRequests) delete CU.pendingFriendRequests[username];
  toast('Request declined','info');
}

function removeFriend(username) {
  ftConfirm('Remove Friend?','This will remove @'+username+' from your friends.').then(ok => {
    if (!ok) return;
    CU.friends = (CU.friends||[]).filter(f=>f!==username);
    DB.ref('users/'+CU.username+'/friends').set(CU.friends);
    DB.ref('users/'+username+'/friends').once('value').then(s => {
      const f = (s.val()||[]).filter(u=>u!==CU.username);
      DB.ref('users/'+username+'/friends').set(f);
    });
    toast('Friend removed','info');
    goFriends();
  });
}

// ===== NOTIFICATIONS =====
function toggleNotifPanel() {
  const p = document.getElementById('notifPanel');
  p.classList.toggle('open');
  if (p.classList.contains('open')) loadNotifications();
}

function loadNotifications() {
  const list = document.getElementById('npList');
  list.innerHTML = '';
  const pending = CU.pendingFriendRequests || {};
  const reqs = Object.entries(pending).filter(([,v]) => v === 'received');
  reqs.forEach(([f]) => {
    list.innerHTML += `
      <div class="np-item unread">
        <div class="np-icon">üë§</div>
        <div class="np-text"><p><strong>${f}</strong> sent you a friend request</p>
          <div class="np-actions"><button class="np-accept" onclick="acceptFriend('${f}');loadNotifications();">Accept</button><button class="np-decline" onclick="declineFriend('${f}');loadNotifications();">Decline</button></div>
        </div>
      </div>`;
  });
  if (!reqs.length) list.innerHTML = '<div style="text-align:center;padding:30px;font-size:13px;color:var(--muted);">No notifications</div>';
}

function renderHomeNotifs() {
  const el = document.getElementById('homeNotifs');
  if (!el) return;
  const pending = CU.pendingFriendRequests || {};
  const reqs = Object.entries(pending).filter(([,v]) => v === 'received');
  if (!reqs.length) { el.innerHTML = '<div style="font-size:12.5px;color:var(--muted);padding:8px;">No new notifications</div>'; return; }
  el.innerHTML = reqs.map(([f]) => `
    <div class="rp-notif unread">
      <div class="rn-icon">üë§</div>
      <div class="rn-text"><p><strong>${f}</strong> sent you a friend request</p>
        <div class="rn-actions"><button class="rn-accept" onclick="acceptFriend('${f}');renderHomeNotifs();">Accept</button><button class="rn-decline" onclick="declineFriend('${f}');renderHomeNotifs();">Decline</button></div>
      </div>
    </div>`).join('');
}

function renderRecentActivity() {
  const el = document.getElementById('recentActivity');
  if (!el) return;
  const bastions = CU.bastions || [];
  if (!bastions.length) { el.innerHTML = '<div class="activity-item"><div class="act-icon">‚öîÔ∏è</div><div class="act-text"><p>No recent activity. Join a bastion!</p></div></div>'; return; }
  el.innerHTML = '';
  bastions.slice(0,4).forEach(bid => {
    DB.ref('bastions/'+bid).once('value').then(snap => {
      if (!snap.exists()) return;
      const b = snap.val();
      const div = document.createElement('div');
      div.className = 'activity-item';
      div.innerHTML = `<div class="act-icon">${b.icon?`<img src="${b.icon}">`:(b.name||'B')[0]}</div><div class="act-text"><p style="font-weight:600;">${b.name}</p><p style="font-size:12px;color:var(--muted);">Community ¬∑ ${Object.keys(b.members||{}).length} members</p></div><button class="btn-a" style="padding:7px 14px;font-size:12px;" onclick="openBastion('${bid}')">Open</button>`;
      el.appendChild(div);
    });
  });
}

// ===== DISCOVER =====
function loadPublicBastions() {
  const grid = document.getElementById('bastionGrid');
  grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">Loading...</div>';
  DB.ref('bastions').orderByChild('isPublic').equalTo(true).limitToFirst(12).once('value').then(snap => {
    grid.innerHTML = '';
    if (!snap.exists()) { grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--muted);">No public bastions yet. Create one!</div>'; return; }
    snap.forEach(c => {
      const b = c.val(); const bid = c.key;
      const div = document.createElement('div');
      div.className = 'bc';
      div.innerHTML = `<div class="bc-banner">${b.icon?`<img src="${b.icon}">`:(b.name||'B')[0]}</div><div class="bc-body"><div class="bc-meta"><div class="bc-icon">${b.icon?`<img src="${b.icon}">`:(b.name||'B')[0]}</div><div style="flex:1;"><div class="bc-name">${b.name}</div>${b.memberCount?`<div style="font-size:11px;color:var(--muted);">üë• ${b.memberCount} members</div>`:''}</div></div><div class="bc-desc">${b.desc||'No description'}</div><button class="btn-a" style="width:100%;justify-content:center;font-size:12px;padding:8px;" onclick="openBastion('${bid}');closeGenericModal();">${(CU.bastions||[]).includes(bid)?'Open':'Join Bastion'}</button></div>`;
      grid.appendChild(div);
    });
  });
}

function filterBastions(q) { loadPublicBastions(); }
function discTab(el, tab) { document.querySelectorAll('.disc-tabs .disc-tab').forEach(t=>t.classList.remove('active')); el.classList.add('active'); loadPublicBastions(); }

// ===== CREATE BASTION =====
function openCreateBastion() {
  const body = `
    <div class="modal-title">Create a Bastion</div>
    <div class="modal-sub">Build your community</div>
    <input class="modal-input" id="cbName" placeholder="Bastion Name">
    <input class="modal-input" id="cbDesc" placeholder="Description (optional)">
    <div class="vis-toggle">
      <div class="vis-opt active" id="visPublic" onclick="document.getElementById('visPublic').classList.add('active');document.getElementById('visPrivate').classList.remove('active');">
        <div class="vo-icon">üåç</div><div class="vo-label">Public</div><div class="vo-desc">Anyone can join</div>
      </div>
      <div class="vis-opt" id="visPrivate" onclick="document.getElementById('visPrivate').classList.add('active');document.getElementById('visPublic').classList.remove('active');">
        <div class="vo-icon">üîí</div><div class="vo-label">Private</div><div class="vo-desc">Invite only</div>
      </div>
    </div>
    <div class="modal-error" id="cbErr"></div>
    <div class="modal-actions">
      <button class="btn-g" onclick="closeGenericModal()">Cancel</button>
      <button class="btn-a" onclick="doCreateBastion()">‚öîÔ∏è Create</button>
    </div>
  `;
  openGenericModal(body);
}

function doCreateBastion() {
  const name = document.getElementById('cbName')?.value.trim();
  const desc = document.getElementById('cbDesc')?.value.trim();
  const isPublic = document.getElementById('visPublic')?.classList.contains('active');
  if (!name) { document.getElementById('cbErr').textContent = 'Name is required'; return; }
  const bid = 'bastion_'+Date.now()+'_'+Math.random().toString(36).substr(2,5);
  const defaultChannels = [
    {id:'ch_general',name:'general',type:'text'},
    {id:'ch_announce',name:'announcements',type:'text'},
    {id:'ch_offtopic',name:'off-topic',type:'text'},
    {id:'ch_voice1',name:'General Voice',type:'voice'}
  ];
  const newBastion = {
    name, desc:desc||'', isPublic, owner:CU.username,
    channels: defaultChannels, roles:[], memberRoles:{},
    customEmojis:[], boostLevel:0,
    members:{[CU.username]:{joinedAt:Date.now(),status:'online'}},
    createdAt:Date.now()
  };
  DB.ref('bastions/'+bid).set(newBastion).then(() => {
    if (!CU.bastions) CU.bastions = [];
    CU.bastions.push(bid);
    DB.ref('users/'+CU.username+'/bastions').set(CU.bastions);
    closeGenericModal();
    toast('Bastion created!','success');
    renderRail();
    openBastion(bid);
  });
}

// ===== BASTION INVITE =====
function openBastionInvite() {
  if (!curBastion) return;
  const link = location.origin + location.pathname + '?join=' + curBastion.id;
  const body = `
    <div class="modal-title">Invite to ${curBastion.name}</div>
    <div class="modal-sub">Share this link</div>
    <div class="invite-link-box"><span>${link}</span><button class="btn-a" style="padding:6px 12px;font-size:12px;" onclick="navigator.clipboard.writeText('${link}').then(()=>toast('Copied!','success'))">Copy</button></div>
    <button class="btn-g" style="width:100%;justify-content:center;" onclick="closeGenericModal()">Close</button>
  `;
  openGenericModal(body);
}

// ===== CHANNELS MODAL =====
function openAddChannelModal(bIdx, preType) {
  pendingNewChannelType = preType || 'text';
  pendingAddChannelBIdx = bIdx;
  document.getElementById('newChannelName').value = '';
  document.getElementById('addChannelErr').textContent = '';
  if (preType==='voice') { selectChType('voice'); } else { selectChType('text'); }
  document.getElementById('addChannelModal').classList.add('open');
}

function selectChType(type) {
  pendingNewChannelType = type;
  document.getElementById('chTypeText').classList.toggle('active', type==='text');
  document.getElementById('chTypeVoice').classList.toggle('active', type==='voice');
}

function confirmAddChannel() {
  const name = document.getElementById('newChannelName').value.trim().toLowerCase().replace(/[^a-z0-9-]/g,'-');
  if (!name) { document.getElementById('addChannelErr').textContent = 'Channel name required'; return; }
  if (!curBastion) return;
  const ch = {id:'ch_'+Date.now(), name, type:pendingNewChannelType};
  if (!curBastion.channels) curBastion.channels = [];
  curBastion.channels.push(ch);
  DB.ref('bastions/'+curBastion.id+'/channels').set(curBastion.channels).then(() => {
    closeModal('addChannelModal');
    renderBastionSidebar();
    toast('Channel created!','success');
  });
}

function deleteChannel(chId) {
  ftConfirm('Delete Channel?', 'All messages will be lost.').then(ok => {
    if (!ok) return;
    curBastion.channels = (curBastion.channels||[]).filter(c => c.id !== chId);
    if (curBastion.channels.length === 0) { toast('Cannot delete last channel','error'); return; }
    DB.ref('bastions/'+curBastion.id+'/channels').set(curBastion.channels).then(() => {
      renderBastionSidebar();
      toast('Channel deleted','success');
      const firstText = curBastion.channels.find(c=>!c.type||c.type==='text');
      if (firstText) openChannel(curBastion.id, firstText.id);
    });
  });
}

// ===== NEW DM =====
function openNewDM() {
  ftPrompt('New Direct Message','Enter username').then(u => {
    if (!u) return;
    u = u.trim().toLowerCase();
    DB.ref('users/'+u).once('value').then(snap => {
      if (!snap.exists()) { toast('User not found','error'); return; }
      openDM(u);
      if (!(CU.friends||[]).includes(u)) toast('Tip: Add @'+u+' as a friend to keep in touch!','info');
    });
  });
}

// ===== ATELIER =====
function claimDaily() {
  const db = document.getElementById('dailyBtn');
  const lastClaim = parseInt(localStorage.getItem('ftz_daily_'+CU.username)||'0');
  if (Date.now() - lastClaim < 86400000) { toast('Already claimed today!','error'); return; }
  CU.onyx = (CU.onyx||0) + 50;
  DB.ref('users/'+CU.username+'/onyx').set(CU.onyx);
  localStorage.setItem('ftz_daily_'+CU.username, Date.now());
  db.classList.add('claimed'); db.querySelector('strong').textContent = 'Claimed';
  document.getElementById('atelierOnyx').textContent = CU.onyx;
  renderUserbar();
  toast('+50 Onyx claimed!','success');
}

function buyRadiance(days) {
  const cost = days===30?400:days===90?1000:3600;
  ftConfirm(`Buy Radiance (${days} days)?`,`Cost: ${cost} Onyx. You have ${CU.onyx||0}.`).then(ok => {
    if (!ok) return;
    if ((CU.onyx||0) < cost) { toast('Not enough Onyx','error'); return; }
    CU.onyx -= cost;
    const until = Date.now() + days * 86400000;
    CU.radianceUntil = Math.max(CU.radianceUntil||0, until);
    DB.ref('users/'+CU.username).update({onyx:CU.onyx, radianceUntil:CU.radianceUntil});
    renderUserbar();
    toast('‚ú® Radiance activated!','success');
  });
}

function buyOnyx(amount) {
  if (amount === 100) {
    CU.onyx = (CU.onyx||0) + 100;
    DB.ref('users/'+CU.username+'/onyx').set(CU.onyx);
    renderUserbar();
    document.getElementById('atelierOnyx').textContent = CU.onyx;
    toast('+100 Onyx added!','success');
    return;
  }
  const prices = {500:'$4.99', 1200:'$9.99', 3000:'$19.99'};
  const price = prices[amount] || '$?';
  openGenericModal(`
    <div style="text-align:center;padding:8px 0 16px;">
      <div style="font-size:48px;margin-bottom:8px;">${amount>=3000?'üëë':'üíé'}</div>
      <h2 style="margin:0 0 4px;">${amount} Onyx</h2>
      <p style="color:var(--muted);margin:0 0 20px;">One-time purchase ¬∑ ${price}</p>
      <div style="background:var(--bg2);border-radius:12px;padding:16px;margin-bottom:20px;text-align:left;">
        <div style="font-size:13px;color:var(--muted);margin-bottom:10px;">Payment details</div>
        <input id="ccNum" placeholder="Card number" maxlength="19" style="width:100%;box-sizing:border-box;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:14px;margin-bottom:8px;"
          oninput="let v=this.value.replace(/\D/g,'').slice(0,16);this.value=v.replace(/(.{4})/g,'$1 ').trim();">
        <div style="display:flex;gap:8px;">
          <input id="ccExp" placeholder="MM/YY" maxlength="5" style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:14px;"
            oninput="let v=this.value.replace(/\D/g,'');if(v.length>2)v=v.slice(0,2)+'/'+v.slice(2,4);this.value=v;">
          <input id="ccCvc" placeholder="CVC" maxlength="3" style="flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text);border-radius:8px;padding:10px 12px;font-size:14px;"
            oninput="this.value=this.value.replace(/\D/g,'').slice(0,3);">
        </div>
      </div>
      <button onclick="confirmBuyOnyx(${amount})" style="width:100%;background:var(--accent);color:#fff;border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:700;cursor:pointer;">Pay ${price}</button>
      <button onclick="closeGenericModal()" style="width:100%;background:transparent;color:var(--muted);border:none;padding:10px;font-size:14px;cursor:pointer;margin-top:4px;">Cancel</button>
    </div>
  `, false);
}

function confirmBuyOnyx(amount) {
  const num = document.getElementById('ccNum')?.value.replace(/\s/g,'');
  const exp = document.getElementById('ccExp')?.value;
  const cvc = document.getElementById('ccCvc')?.value;
  if (!num || num.length < 16) { toast('Enter a valid card number','error'); return; }
  if (!exp || exp.length < 5) { toast('Enter expiry (MM/YY)','error'); return; }
  if (!cvc || cvc.length < 3) { toast('Enter CVC','error'); return; }
  closeGenericModal();
  // Simulate processing
  const t = toast('Processing payment‚Ä¶','info');
  setTimeout(() => {
    CU.onyx = (CU.onyx||0) + amount;
    DB.ref('users/'+CU.username+'/onyx').set(CU.onyx);
    renderUserbar();
    const el = document.getElementById('atelierOnyx');
    if (el) el.textContent = CU.onyx;
    toast('+'+amount+' Onyx added to your account!','success');
  }, 1800);
}

// ===== MUTE =====
function toggleMute() {
  const btn = document.getElementById('muteBtn');
  const muted = btn.textContent === 'üîá';
  btn.textContent = muted ? 'üéôÔ∏è' : 'üîá';
  toast(muted?'Unmuted':'Muted','info');
}

// ===== PROFILE =====
function profileTab(el, tab) {
  document.querySelectorAll('.profile-nav-item').forEach(e=>e.classList.remove('active'));
  if (el) el.classList.add('active');
  renderProfileTab(tab);
}

function renderProfileTab(tab) {
  const main = document.getElementById('profileMain');
  if (tab === 'myprofile') {
    const isRadiance = CU.radianceUntil && CU.radianceUntil > Date.now();
    main.innerHTML = `
      <div class="profile-banner-area" id="bannerArea">
        ${CU.banner?`<img src="${CU.banner}">`:''}
        ${isRadiance?`<button class="btn-g" style="position:absolute;bottom:8px;right:8px;padding:5px 12px;font-size:11px;" onclick="document.getElementById('bannerFileInput').click()">Change Banner</button>`:''}
      </div>
      <div class="profile-av-row">
        <div class="profile-av-big" onclick="document.getElementById('pfpFileInput').click()">
          ${CU.pfp?`<img src="${CU.pfp}">`:(CU.displayName||CU.username)[0].toUpperCase()}
        </div>
        <div>
          ${isRadiance?'<div class="radiance-badge">‚ú® Radiance Active</div>':''}
        </div>
      </div>
      <div class="profile-content">
        <div class="profile-display-name">${CU.displayName||CU.username}</div>
        <div class="profile-username">@${CU.username}</div>
        <div class="profile-stats-row" style="margin-top:14px;">
          <div class="ps-stat"><div class="ps-val">${(CU.friends||[]).length}</div><div class="ps-key">Friends</div></div>
          <div class="ps-stat"><div class="ps-val">${(CU.bastions||[]).length}</div><div class="ps-key">Bastions</div></div>
          <div class="ps-stat"><div class="ps-val">${CU.onyx||0}</div><div class="ps-key">Onyx</div></div>
        </div>
        <div class="settings-section" style="margin-top:18px;">
          <div class="settings-title">Edit Profile</div>
          <div style="margin-bottom:10px;"><label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Display Name</label><input class="field-input" id="editDisplayName" value="${CU.displayName||''}"></div>
          <div style="margin-bottom:14px;"><label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Status</label>
            <select class="field-input" id="editStatus">
              <option value="online" ${CU.status==='online'?'selected':''}>üü¢ Online</option>
              <option value="away" ${CU.status==='away'?'selected':''}>üü° Away</option>
              <option value="dnd" ${CU.status==='dnd'?'selected':''}>üî¥ Do Not Disturb</option>
              <option value="invisible" ${CU.status==='invisible'?'selected':''}>‚ö´ Invisible</option>
            </select>
          </div>
          <button class="btn-a" onclick="saveProfileChanges()">Save Changes</button>
        </div>
      </div>
    `;
  } else if (tab === 'notifications') {
    const ns = CU.notificationSettings || {};
    main.innerHTML = `
      <div style="padding:28px;">
        <div class="profile-display-name" style="margin-bottom:18px;">Notification Settings</div>
        ${[
          ['dms','Direct Messages','Get notified when someone messages you'],
          ['friendReqs','Friend Requests','Get notified for new friend requests'],
          ['mentions','Bastion Mentions','Get notified when you are @mentioned'],
          ['allMessages','All Messages','Get notified for every message (not recommended)']
        ].map(([key,label,sub]) => `
          <div class="notif-setting-row">
            <div><div class="nsr-label">${label}</div><div class="nsr-sub">${sub}</div></div>
            <div class="toggle ${ns[key]?'on':''}" onclick="toggleNotifSetting('${key}',this)"></div>
          </div>`).join('')}
      </div>
    `;
  } else if (tab === 'account') {
    main.innerHTML = `
      <div style="padding:28px;">
        <div class="profile-display-name" style="margin-bottom:18px;">Account Settings</div>
        <div class="s-row"><span class="si">üë§</span><div class="st"><div class="sl">Username</div><div class="ss">@${CU.username}</div></div></div>
        <div class="s-row" onclick="changePassword()"><span class="si">üîí</span><div class="st"><div class="sl">Change Password</div></div><span style="color:var(--muted);">‚Üí</span></div>
        <div class="s-row" style="border-color:rgba(248,113,113,.3);" onclick="logOut()"><span class="si">üö™</span><div class="st"><div class="sl" style="color:var(--red);">Log Out</div></div></div>
      </div>
    `;
  } else if (tab === 'appearance') {
    main.innerHTML = `<div style="padding:28px;"><div class="profile-display-name" style="margin-bottom:18px;">Appearance</div><div class="s-row"><span class="si">üé®</span><div class="st"><div class="sl">Theme</div><div class="ss">Dark (default)</div></div></div></div>`;
  } else if (tab === 'privacy') {
    main.innerHTML = `<div style="padding:28px;"><div class="profile-display-name" style="margin-bottom:18px;">Privacy</div><div class="s-row"><span class="si">üõ°Ô∏è</span><div class="st"><div class="sl">Who can send you DMs?</div><div class="ss">Friends only</div></div></div></div>`;
  }
}

function saveProfileChanges() {
  const name = document.getElementById('editDisplayName')?.value.trim();
  const status = document.getElementById('editStatus')?.value;
  if (!name) { toast('Display name cannot be empty','error'); return; }
  CU.displayName = name; CU.status = status;
  DB.ref('users/'+CU.username).update({displayName:name, status});
  renderUserbar();
  toast('Profile updated!','success');
}

function toggleNotifSetting(key, el) {
  if (!CU.notificationSettings) CU.notificationSettings = {};
  CU.notificationSettings[key] = !CU.notificationSettings[key];
  el.classList.toggle('on', CU.notificationSettings[key]);
  DB.ref('users/'+CU.username+'/notificationSettings').set(CU.notificationSettings);
}

function changePassword() {
  ftPrompt('New Password','Enter new password').then(p => {
    if (!p) return;
    DB.ref('users/'+CU.username+'/password').set(btoa(p));
    toast('Password changed!','success');
  });
}

// ===== PFP & BANNER UPLOAD =====
function handlePfpUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (file.size > 2*1024*1024) { toast('Max 2MB','error'); return; }
  const reader = new FileReader();
  reader.onload = r => {
    CU.pfp = r.target.result;
    DB.ref('users/'+CU.username+'/pfp').set(CU.pfp);
    renderUserbar();
    renderProfileTab('myprofile');
    if (!window._usersCache) window._usersCache = {};
    window._usersCache[CU.username] = {pfp:CU.pfp};
    toast('Profile picture updated!','success');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function handleBannerUpload(e) {
  const file = e.target.files[0]; if (!file) return;
  if (!CU.radianceUntil || CU.radianceUntil < Date.now()) { toast('Radiance required to set banner','error'); return; }
  const reader = new FileReader();
  reader.onload = r => {
    CU.banner = r.target.result;
    DB.ref('users/'+CU.username+'/banner').set(CU.banner);
    renderProfileTab('myprofile');
    toast('Banner updated!','success');
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

// ===== BASTION SETTINGS =====
function openBastionSettings() {
  if (!curBastion) return;
  setView('BSettings');
  updateTopbar('‚öôÔ∏è '+curBastion.name+' Settings','');
  renderBSettingsNav();
  renderBSettingsTab('overview');
}

function renderBSettingsNav() {
  const nav = document.getElementById('bSettingsNav');
  const tabs = [
    {id:'overview',label:'Overview',icon:'üè†'},
    {id:'channels',label:'Channels',icon:'#'},
    {id:'roles',label:'Roles',icon:'üé≠'},
    {id:'members',label:'Members',icon:'üë•'},
    {id:'emojis',label:'Emojis',icon:'üòä'},
    {id:'automod',label:'AutoMod',icon:'üõ°Ô∏è'},
    {id:'invites',label:'Invites',icon:'üîó'},
    {id:'danger',label:'Danger Zone',icon:'‚ö†Ô∏è'},
  ];
  nav.innerHTML = `
    <div class="bsettings-nav-section">${curBastion.name}</div>
    ${tabs.map(t=>`<div class="bsettings-nav-item" onclick="renderBSettingsTab('${t.id}')">${t.icon} ${t.label}</div>`).join('')}
    <div style="margin:10px 14px;"><button class="btn-g" style="width:100%;justify-content:center;font-size:12px;" onclick="openBastion('${curBastion.id}')">‚Üê Back to Bastion</button></div>
  `;
}

function renderBSettingsTab(tab) {
  document.querySelectorAll('.bsettings-nav-item').forEach(el=>el.classList.remove('active'));
  const navItems = document.querySelectorAll('.bsettings-nav-item');
  navItems.forEach(el => { if (el.textContent.toLowerCase().includes(tab)) el.classList.add('active'); });
  const main = document.getElementById('bSettingsMain');
  if (tab === 'overview') {
    main.innerHTML = `
      <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:20px;">Overview</h2>
      <div style="margin-bottom:14px;"><label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Bastion Name</label><input class="field-input" id="bsName" value="${curBastion.name||''}"></div>
      <div style="margin-bottom:14px;"><label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Description</label><input class="field-input" id="bsDesc" value="${curBastion.desc||''}"></div>
      <div style="margin-bottom:14px;"><label style="font-size:12px;color:var(--muted);display:block;margin-bottom:5px;">Bastion Tag</label><input class="field-input" id="bsTag" value="${curBastion.bastionTag||''}" maxlength="8" placeholder="e.g. FTZ" style="text-transform:uppercase;"></div>
      <div style="margin-bottom:18px;">
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:7px;">Visibility</label>
        <div class="vis-toggle">
          <div class="vis-opt ${curBastion.isPublic?'active':''}" id="bsVisPublic" onclick="document.getElementById('bsVisPublic').classList.add('active');document.getElementById('bsVisPrivate').classList.remove('active');">
            <div class="vo-icon">üåç</div><div class="vo-label">Public</div>
          </div>
          <div class="vis-opt ${!curBastion.isPublic?'active':''}" id="bsVisPrivate" onclick="document.getElementById('bsVisPrivate').classList.add('active');document.getElementById('bsVisPublic').classList.remove('active');">
            <div class="vo-icon">üîí</div><div class="vo-label">Private</div>
          </div>
        </div>
      </div>
      <button class="btn-a" onclick="saveBastionOverview()">Save Changes</button>
    `;
  } else if (tab === 'roles') {
    const roles = curBastion.roles || [];
    main.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Roles</h2>
        <button class="btn-a" onclick="openCreateRoleModal()" style="font-size:12.5px;padding:8px 16px;">+ Create Role</button>
      </div>
      <div id="rolesList">
        ${roles.length?roles.map(r=>`
          <div class="role-item">
            <div class="role-dot" style="background:${r.color};"></div>
            <div class="role-name">${r.name}</div>
            <button class="btn-g" style="padding:5px 12px;font-size:11px;" onclick="openEditRoleModal('${r.id}')">Edit</button>
            <button class="btn-d" style="padding:5px 12px;font-size:11px;" onclick="deleteRole('${r.id}')">Delete</button>
          </div>`).join(''):'<div style="color:var(--muted);font-size:13px;">No roles yet</div>'}
      </div>
    `;
  } else if (tab === 'members') {
    const members = curBastion.members || {};
    const roles = curBastion.roles || [];
    const memberRoles = curBastion.memberRoles || {};
    main.innerHTML = `
      <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:20px;">Members (${Object.keys(members).length})</h2>
      ${Object.keys(members).map(uname=>{
        const userRoles = (memberRoles[uname]||[]).map(rid=>roles.find(r=>r.id===rid)).filter(Boolean);
        return `<div class="activity-item" style="margin-bottom:8px;">
          ${avatarHtml(uname,40)}
          <div class="act-text"><p style="font-weight:700;">${uname}${uname===curBastion.owner?' üëë':''}</p>
            <p style="font-size:12px;color:var(--muted);">${userRoles.length?userRoles.map(r=>`<span style="color:${r.color};">${r.name}</span>`).join(', '):'No roles'}</p>
          </div>
          ${uname!==curBastion.owner?`<button class="btn-d" style="padding:5px 12px;font-size:11px;" onclick="kickMember('${uname}')">Kick</button>`:''}
        </div>`;
      }).join('')}
    `;
  } else if (tab === 'emojis') {
    const emojis = curBastion.customEmojis || [];
    const maxSlots = [15,25,35][curBastion.boostLevel||0];
    main.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
        <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Custom Emojis</h2>
        <button class="btn-a" onclick="triggerEmojiUpload('${curBastion.id}')" style="font-size:12px;padding:8px 16px;" ${emojis.length>=maxSlots?'disabled':''}>+ Upload Emoji</button>
      </div>
      <div style="font-size:12.5px;color:var(--muted);margin-bottom:16px;">${emojis.length}/${maxSlots} slots used</div>
      <div class="emoji-upload-grid" id="customEmojiGrid">
        ${emojis.map(e=>`
          <div class="emoji-slot filled" title=":${e.name}:">
            <img src="${e.data}">
            <div class="es-del" onclick="deleteCustomEmoji('${e.name}')">‚úï</div>
            <div style="position:absolute;bottom:1px;left:0;right:0;text-align:center;font-size:8px;color:var(--muted);">${e.name}</div>
          </div>`).join('')}
      </div>
    `;
  } else if (tab === 'channels') {
    const channels = curBastion.channels || [];
    main.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;">Channels</h2>
        <button class="btn-a" onclick="openAddChannelModal(0)" style="font-size:12.5px;padding:8px 16px;">+ Add Channel</button>
      </div>
      ${channels.map(ch=>`<div class="role-item"><div style="font-size:16px;">${ch.type==='voice'?'üîä':'#'}</div><div class="role-name">${ch.name}</div><div style="font-size:11px;color:var(--muted);">${ch.type||'text'}</div>${channels.length>1?`<button class="btn-d" style="padding:5px 12px;font-size:11px;" onclick="deleteChannel('${ch.id}')">Delete</button>`:''}</div>`).join('')}
    `;
  } else if (tab === 'invites') {
    openBastionInvite();
  } else if (tab === 'automod') {
    main.innerHTML = `
      <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:20px;">AutoMod</h2>
      <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üö´</span><span class="amr-title">Block Spam</span><div class="amr-enabled"><div class="toggle on"></div></div></div><div class="amr-desc">Automatically removes repeated messages and excessive caps.</div></div>
      <div class="automod-rule"><div class="amr-header"><span class="amr-icon">üîû</span><span class="amr-title">NSFW Filter</span><div class="amr-enabled"><div class="toggle"></div></div></div><div class="amr-desc">Block adult content and explicit language.</div></div>
    `;
  } else if (tab === 'danger') {
    main.innerHTML = `
      <h2 style="font-family:'Syne',sans-serif;font-size:18px;font-weight:800;margin-bottom:20px;color:var(--red);">‚ö†Ô∏è Danger Zone</h2>
      <div style="background:rgba(248,113,113,.05);border:1px solid rgba(248,113,113,.2);border-radius:14px;padding:20px;">
        <p style="font-size:13.5px;margin-bottom:14px;">Deleting this bastion is <strong>permanent and irreversible</strong>. All channels and messages will be lost.</p>
        <button class="btn-d" onclick="deleteBastion()">üóë Delete Bastion</button>
      </div>
    `;
  }
}

function saveBastionOverview() {
  const name = document.getElementById('bsName')?.value.trim();
  const desc = document.getElementById('bsDesc')?.value.trim();
  const tag = document.getElementById('bsTag')?.value.trim().toUpperCase().slice(0,8);
  const isPublic = document.getElementById('bsVisPublic')?.classList.contains('active');
  if (!name) { toast('Name required','error'); return; }
  curBastion.name = name; curBastion.desc = desc; curBastion.bastionTag = tag; curBastion.isPublic = isPublic;
  DB.ref('bastions/'+curBastion.id).update({name,desc,bastionTag:tag,isPublic});
  renderRail();
  toast('Bastion updated!','success');
}

function openBastionBoost() {
  if (!curBastion) return;
  const level = curBastion.boostLevel || 0;
  const costs = [0, 500, 1500, 4000];
  const perks = [
    ['15 custom emojis', '50 member limit', 'Standard quality'],
    ['25 custom emojis', '100 member limit', 'HD voice quality', 'Custom invite banner'],
    ['35 custom emojis', '250 member limit', 'HD+ voice quality', 'Custom invite banner', 'Animated icon'],
    ['50 custom emojis', '500 member limit', 'Ultra voice quality', 'Animated icon', 'Custom splash screen', 'Vanity URL']
  ];
  const nextLevel = Math.min(level + 1, 3);
  const cost = costs[nextLevel];
  const canAfford = (CU.onyx||0) >= cost;
  const atMax = level >= 3;

  openGenericModal(`
    <div style="padding:4px 0 8px;">
      <h2 style="margin:0 0 4px;">‚ö° Boost ${curBastion.name}</h2>
      <p style="color:var(--muted);margin:0 0 20px;font-size:13px;">Unlock premium features for your bastion</p>
      <div style="display:flex;gap:10px;margin-bottom:20px;">
        ${[0,1,2,3].map(l=>`
          <div style="flex:1;background:${l<=level?'var(--accent)':'var(--bg2)'};border-radius:10px;padding:10px 6px;text-align:center;opacity:${l<=level?1:0.5};">
            <div style="font-weight:700;font-size:13px;">L${l}</div>
            <div style="font-size:11px;color:${l<=level?'rgba(255,255,255,0.8)':'var(--muted)'};">${l===0?'Free':costs[l]+' ‚ú¶'}</div>
          </div>
        `).join('')}
      </div>
      ${atMax ? `<div style="text-align:center;padding:16px;color:var(--green);">‚úÖ Maximum level reached!</div>` : `
        <div style="background:var(--bg2);border-radius:12px;padding:14px;margin-bottom:16px;">
          <div style="font-weight:600;margin-bottom:8px;">Level ${nextLevel} unlocks:</div>
          ${perks[nextLevel].map(p=>`<div style="font-size:13px;color:var(--muted);padding:3px 0;">‚ú¶ ${p}</div>`).join('')}
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
          <span style="color:var(--muted);font-size:13px;">Your balance: <b style="color:var(--text);">${CU.onyx||0} Onyx</b></span>
          <span style="font-weight:700;">Cost: ${cost} Onyx</span>
        </div>
        <button onclick="confirmBoost(${nextLevel},${cost})" ${canAfford?'':'disabled'} style="width:100%;background:${canAfford?'var(--accent)':'var(--bg3)'};color:${canAfford?'#fff':'var(--muted)'};border:none;border-radius:10px;padding:13px;font-size:15px;font-weight:700;cursor:${canAfford?'pointer':'not-allowed'};">
          ${canAfford?`Boost to Level ${nextLevel}`:`Not enough Onyx`}
        </button>
        ${!canAfford?`<p style="text-align:center;font-size:12px;color:var(--muted);margin:8px 0 0;">Get more Onyx in the <a onclick="closeGenericModal();goAtelier();" style="color:var(--accent);cursor:pointer;">Atelier</a></p>`:''}
      `}
      <button onclick="closeGenericModal()" style="width:100%;background:transparent;color:var(--muted);border:none;padding:10px;font-size:14px;cursor:pointer;margin-top:4px;">Close</button>
    </div>
  `, true);
}

function confirmBoost(level, cost) {
  if ((CU.onyx||0) < cost) { toast('Not enough Onyx','error'); return; }
  closeGenericModal();
  CU.onyx = (CU.onyx||0) - cost;
  curBastion.boostLevel = level;
  DB.ref('users/'+CU.username+'/onyx').set(CU.onyx);
  DB.ref('bastions/'+curBastion.id+'/boostLevel').set(level);
  renderUserbar();
  renderBastionSidebar();
  toast('‚ö° Bastion boosted to Level '+level+'!','success');
}

function deleteBastion() {
  if (curBastion.owner !== CU.username) { toast('Only the owner can delete','error'); return; }
  ftPrompt('Type CONFIRM to delete','CONFIRM','This is irreversible!').then(val => {
    if (val !== 'CONFIRM') { toast('Cancelled','info'); return; }
    const bid = curBastion.id;
    DB.ref('bastions/'+bid).remove();
    CU.bastions = (CU.bastions||[]).filter(b=>b!==bid);
    DB.ref('users/'+CU.username+'/bastions').set(CU.bastions);
    curBastion = null; curChannel = null;
    renderRail(); goHome();
    toast('Bastion deleted','success');
  });
}

function kickMember(username) {
  ftConfirm('Kick @'+username+'?','They can rejoin with an invite.').then(ok => {
    if (!ok) return;
    delete curBastion.members[username];
    DB.ref('bastions/'+curBastion.id+'/members/'+username).remove();
    // Remove from their bastions list
    DB.ref('users/'+username+'/bastions').once('value').then(s => {
      const bl = (s.val()||[]).filter(b=>b!==curBastion.id);
      DB.ref('users/'+username+'/bastions').set(bl);
    });
    renderBSettingsTab('members');
    toast('@'+username+' kicked','success');
  });
}

// ===== ROLES =====
function openCreateRoleModal() {
  let selColor = ROLE_COLORS[0];
  const body = `
    <div class="modal-title">Create Role</div>
    <input class="modal-input" id="newRoleName" placeholder="Role Name">
    <div style="font-size:12px;color:var(--muted);margin-bottom:7px;">Color</div>
    <div class="color-swatches" id="roleColorSwatches">
      ${ROLE_COLORS.map(c=>`<div class="color-swatch ${c===selColor?'sel':''}" style="background:${c};" onclick="selectRoleColor('${c}')"></div>`).join('')}
    </div>
    <input type="hidden" id="newRoleColor" value="${selColor}">
    <div class="modal-error" id="newRoleErr"></div>
    <div class="modal-actions">
      <button class="btn-g" onclick="closeGenericModal()">Cancel</button>
      <button class="btn-a" onclick="doCreateRole()">Create Role</button>
    </div>
  `;
  openGenericModal(body);
}

function selectRoleColor(color) {
  document.querySelectorAll('.color-swatch').forEach(s=>s.classList.remove('sel'));
  document.querySelectorAll('.color-swatch').forEach(s=>{ if(s.style.background===color||s.style.backgroundColor===color) s.classList.add('sel'); });
  const inp = document.getElementById('newRoleColor');
  if (inp) inp.value = color;
}

function doCreateRole() {
  const name = document.getElementById('newRoleName')?.value.trim();
  const color = document.getElementById('newRoleColor')?.value || ROLE_COLORS[0];
  if (!name) { document.getElementById('newRoleErr').textContent = 'Name required'; return; }
  if (!curBastion.roles) curBastion.roles = [];
  const role = {id:'role_'+Date.now(), name, color, permissions:[]};
  curBastion.roles.push(role);
  DB.ref('bastions/'+curBastion.id+'/roles').set(curBastion.roles);
  closeGenericModal();
  renderBSettingsTab('roles');
  toast('Role created!','success');
}

function openEditRoleModal(roleId) {
  const role = (curBastion.roles||[]).find(r=>r.id===roleId);
  if (!role) return;
  const body = `
    <div class="modal-title">Edit Role: ${role.name}</div>
    <input class="modal-input" id="editRoleName" value="${role.name}">
    <div style="font-size:12px;color:var(--muted);margin-bottom:7px;">Color</div>
    <div class="color-swatches">
      ${ROLE_COLORS.map(c=>`<div class="color-swatch ${c===role.color?'sel':''}" style="background:${c};" onclick="selectRoleColor('${c}')"></div>`).join('')}
    </div>
    <input type="hidden" id="newRoleColor" value="${role.color}">
    <div style="font-size:12px;color:var(--muted);margin:12px 0 7px;">Permissions</div>
    <div>${PERMISSIONS.map(p=>`<div class="perm-row"><div class="perm-info"><div class="perm-label">${p.replace(/_/g,' ')}</div></div><div class="toggle ${(role.permissions||[]).includes(p)?'on':''}" id="perm_${p}" onclick="togglePermEdit('${p}')"></div></div>`).join('')}</div>
    <div class="modal-actions" style="margin-top:14px;">
      <button class="btn-g" onclick="closeGenericModal()">Cancel</button>
      <button class="btn-a" onclick="doEditRole('${roleId}')">Save</button>
    </div>
  `;
  openGenericModal(body, true);
  window._editingRole = role;
}

function togglePermEdit(perm) {
  const el = document.getElementById('perm_'+perm);
  if (el) el.classList.toggle('on');
}

function doEditRole(roleId) {
  const name = document.getElementById('editRoleName')?.value.trim();
  const color = document.getElementById('newRoleColor')?.value || ROLE_COLORS[0];
  const perms = PERMISSIONS.filter(p => document.getElementById('perm_'+p)?.classList.contains('on'));
  const idx = (curBastion.roles||[]).findIndex(r=>r.id===roleId);
  if (idx<0) return;
  curBastion.roles[idx] = {...curBastion.roles[idx], name, color, permissions:perms};
  DB.ref('bastions/'+curBastion.id+'/roles').set(curBastion.roles);
  closeGenericModal();
  renderBSettingsTab('roles');
  toast('Role updated!','success');
}

function deleteRole(roleId) {
  ftConfirm('Delete this role?','Members will lose this role.').then(ok => {
    if (!ok) return;
    curBastion.roles = (curBastion.roles||[]).filter(r=>r.id!==roleId);
    DB.ref('bastions/'+curBastion.id+'/roles').set(curBastion.roles);
    renderBSettingsTab('roles');
    toast('Role deleted','success');
  });
}

// ===== CUSTOM EMOJI UPLOAD =====
function triggerEmojiUpload(bid) {
  pendingEmojiForBastion = bid || (curBastion ? curBastion.id : null);
  document.getElementById('emojiFileInput').click();
}

function handleEmojiFileSelected(e) {
  const file = e.target.files[0]; if (!file) return;
  if (file.size > 512*1024) { toast('Max 512KB per emoji','error'); e.target.value=''; return; }
  if (!file.type.startsWith('image/')) { toast('Images only','error'); e.target.value=''; return; }
  const reader = new FileReader();
  reader.onload = r => {
    pendingEmojiData = {data:r.target.result, type:file.type};
    ftPrompt('Emoji Name','my_emoji','Lowercase, letters/numbers/underscore, max 20 chars').then(name => {
      if (!name) { pendingEmojiData = null; return; }
      name = name.trim().toLowerCase().replace(/[^a-z0-9_]/g,'_').slice(0,20);
      if (!name) { toast('Invalid name','error'); pendingEmojiData = null; return; }
      confirmEmojiName(name);
    });
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

function confirmEmojiName(name) {
  if (!pendingEmojiData || !pendingEmojiForBastion) return;
  DB.ref('bastions/'+pendingEmojiForBastion).once('value').then(snap => {
    if (!snap.exists()) return;
    const b = snap.val();
    const emojis = b.customEmojis || [];
    const maxSlots = [15,25,35][b.boostLevel||0];
    if (emojis.length >= maxSlots) { toast('Emoji slots full!','error'); return; }
    if (emojis.find(e=>e.name===name)) { toast('Name already taken','error'); return; }
    emojis.push({name, data:pendingEmojiData.data, type:'img'});
    DB.ref('bastions/'+pendingEmojiForBastion+'/customEmojis').set(emojis).then(() => {
      if (curBastion && curBastion.id === pendingEmojiForBastion) {
        curBastion.customEmojis = emojis;
        renderBSettingsTab('emojis');
      }
      pendingEmojiData = null; pendingEmojiForBastion = null;
      toast(':'+name+': emoji added!','success');
    });
  });
}

function deleteCustomEmoji(name) {
  ftConfirm('Delete :'+name+':?','').then(ok => {
    if (!ok || !curBastion) return;
    curBastion.customEmojis = (curBastion.customEmojis||[]).filter(e=>e.name!==name);
    DB.ref('bastions/'+curBastion.id+'/customEmojis').set(curBastion.customEmojis);
    renderBSettingsTab('emojis');
    toast('Emoji deleted','success');
  });
}

function handleBastionIconUpload(e) { /* handled inline */ }

// ===== GENERIC MODAL =====
function openGenericModal(html, tall=false) {
  const inner = document.getElementById('genericModalInner');
  inner.className = 'modal wide'+(tall?' tall':'');
  document.getElementById('genericModalBody').innerHTML = html;
  document.getElementById('genericModal').classList.add('open');
}

function closeGenericModal() { document.getElementById('genericModal').classList.remove('open'); }

// ===== FILE UPLOAD =====
function triggerFileUpload() {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'image/*,.pdf,.txt,.zip,.mp3,.mp4,.mov';
  inp.onchange = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const maxMB = 8;
    if (file.size > maxMB * 1024 * 1024) { toast(`Max file size is ${maxMB}MB`, 'error'); return; }
    const isImage = file.type.startsWith('image/');
    toast('Uploading‚Ä¶', 'info');
    if (isImage) {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const path = getMsgPath();
        if (!path) return;
        const ts = Date.now();
        const msg = {
          from: CU.username,
          text: '',
          imageData: dataUrl,
          imageName: file.name,
          timestamp: ts,
          time: formatTime(ts)
        };
        DB.ref(path).push(msg);
      };
      reader.readAsDataURL(file);
    } else {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        const path = getMsgPath();
        if (!path) return;
        const ts = Date.now();
        const msg = {
          from: CU.username,
          text: '',
          fileData: dataUrl,
          fileName: file.name,
          fileType: file.type,
          fileSize: (file.size/1024).toFixed(1)+'KB',
          timestamp: ts,
          time: formatTime(ts)
        };
        DB.ref(path).push(msg);
      };
      reader.readAsDataURL(file);
    }
  };
  inp.click();
}


// ===== PIN MESSAGES =====
function pinMessage(id) {
  if (!curBastion) { toast('Not in a bastion','error'); return; }
  const row = document.querySelector(`[data-msgid="${id}"]`);
  if (!row) return;
  const textEl = row.querySelector('.msg-text');
  const text = textEl ? textEl.textContent : '';
  const author = row.dataset.author || 'Unknown';
  const pinPath = 'bastions/'+curBastion.id+'/pinnedMessages';
  DB.ref(pinPath).once('value').then(snap => {
    const pins = snap.val() || {};
    if (Object.keys(pins).length >= 50) { toast('Max 50 pinned messages','error'); return; }
    DB.ref(pinPath+'/'+id).set({id, text:text.slice(0,200), author, pinnedAt:Date.now(), pinnedBy:CU.username});
    toast('üìå Message pinned!','success');
    renderPinnedBanner();
  });
}

function renderPinnedBanner() {
  if (!curBastion || !curChannel) return;
  const pinPath = 'bastions/'+curBastion.id+'/pinnedMessages';
  DB.ref(pinPath).limitToLast(1).once('value').then(snap => {
    let bar = document.getElementById('pinBar');
    if (!snap.exists()) { if (bar) bar.remove(); return; }
    const pin = Object.values(snap.val())[0];
    if (!bar) {
      bar = document.createElement('div');
      bar.id = 'pinBar';
      bar.style.cssText = 'display:flex;align-items:center;gap:10px;padding:8px 16px;background:linear-gradient(90deg,rgba(255,249,62,.06),transparent);border-bottom:1px solid rgba(255,249,62,.12);font-size:12.5px;cursor:pointer;flex-shrink:0;';
      const chat = document.getElementById('chatArea') || document.getElementById('chatMsgs')?.parentElement;
      if (chat) chat.insertBefore(bar, chat.firstChild);
    }
    bar.innerHTML = `<span style="color:var(--accent);font-size:14px;">üìå</span><span style="flex:1;color:var(--muted-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${escapeHtml(pin.text||'Pinned message')}</span><button onclick="viewPinnedMessages()" style="background:none;border:1px solid var(--border);color:var(--muted);padding:3px 10px;border-radius:8px;font-size:11.5px;cursor:pointer;">View All</button>`;
  });
}

function viewPinnedMessages() {
  if (!curBastion) return;
  const pinPath = 'bastions/'+curBastion.id+'/pinnedMessages';
  DB.ref(pinPath).once('value').then(snap => {
    const pins = snap.exists() ? Object.values(snap.val()) : [];
    if (!pins.length) { toast('No pinned messages','info'); return; }
    pins.sort((a,b) => (b.pinnedAt||0)-(a.pinnedAt||0));
    const html = `
      <div class="modal-title">üìå Pinned Messages</div>
      <div class="modal-sub">${pins.length} pinned message${pins.length!==1?'s':''}</div>
      <div style="max-height:360px;overflow-y:auto;margin-top:16px;">
        ${pins.map(p => `<div style="padding:12px;border:1px solid var(--border);border-radius:12px;margin-bottom:10px;">
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
            <div style="font-size:11.5px;font-weight:700;color:var(--accent-light);">@${escapeHtml(p.author||'?')}</div>
            <div style="font-size:10.5px;color:var(--muted);flex:1;">${p.pinnedAt?new Date(p.pinnedAt).toLocaleDateString():''}</div>
            ${curBastion.owner===CU.username?`<button onclick="unpinMessage('${p.id}')" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;padding:2px 6px;border-radius:6px;" onmouseover="this.style.color='var(--red)'" onmouseout="this.style.color='var(--muted)'">‚úï</button>`:''}
          </div>
          <div style="font-size:13px;color:var(--fg);line-height:1.5;">${escapeHtml(p.text||'')}</div>
        </div>`).join('')}
      </div>
      <button class="btn-g" onclick="closeGenericModal()" style="width:100%;justify-content:center;margin-top:8px;">Close</button>`;
    openGenericModal(html, true);
  });
}

function unpinMessage(id) {
  if (!curBastion) return;
  DB.ref('bastions/'+curBastion.id+'/pinnedMessages/'+id).remove().then(() => {
    toast('Message unpinned','info');
    closeGenericModal();
    renderPinnedBanner();
  });
}

// ===== MISC =====
function handleSearch(v) {}
window.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    hideCtxMenu(); hideProfileCard();
    document.getElementById('emojiPickerPopup').style.display = 'none';
    document.getElementById('notifPanel').classList.remove('open');
  }
});
</script>
</body>
</html>
